[
  {
    "sha": "3fcec0d4a0ea9c3cb50a68685a64b2c60946438f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozZmNlYzBkNGEwZWE5YzNjYjUwYTY4Njg1YTY0YjJjNjA5NDY0Mzhm",
    "commit": {
      "author": {
        "name": "Gavin Andresen",
        "email": "gavinandresen@gmail.com",
        "date": "2012-08-20T14:36:43Z"
      },
      "committer": {
        "name": "Gavin Andresen",
        "email": "gavinandresen@gmail.com",
        "date": "2012-08-20T14:46:07Z"
      },
      "message": "Set block.nVersion to fix miner unit test",
      "tree": {
        "sha": "49d80347f8a8ab62209644fcd66c78eea5499466",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/49d80347f8a8ab62209644fcd66c78eea5499466"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3fcec0d4a0ea9c3cb50a68685a64b2c60946438f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3fcec0d4a0ea9c3cb50a68685a64b2c60946438f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/3fcec0d4a0ea9c3cb50a68685a64b2c60946438f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3fcec0d4a0ea9c3cb50a68685a64b2c60946438f/comments",
    "author": {
      "login": "gavinandresen",
      "id": 331997,
      "node_id": "MDQ6VXNlcjMzMTk5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/331997?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gavinandresen",
      "html_url": "https://github.com/gavinandresen",
      "followers_url": "https://api.github.com/users/gavinandresen/followers",
      "following_url": "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url": "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gavinandresen/subscriptions",
      "organizations_url": "https://api.github.com/users/gavinandresen/orgs",
      "repos_url": "https://api.github.com/users/gavinandresen/repos",
      "events_url": "https://api.github.com/users/gavinandresen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gavinandresen/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "gavinandresen",
      "id": 331997,
      "node_id": "MDQ6VXNlcjMzMTk5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/331997?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gavinandresen",
      "html_url": "https://github.com/gavinandresen",
      "followers_url": "https://api.github.com/users/gavinandresen/followers",
      "following_url": "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url": "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gavinandresen/subscriptions",
      "organizations_url": "https://api.github.com/users/gavinandresen/orgs",
      "repos_url": "https://api.github.com/users/gavinandresen/repos",
      "events_url": "https://api.github.com/users/gavinandresen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gavinandresen/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b3a570d158224e6ae6ee72fadd2bf947d7656f23",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b3a570d158224e6ae6ee72fadd2bf947d7656f23",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b3a570d158224e6ae6ee72fadd2bf947d7656f23"
      }
    ],
    "stats": {
      "total": 1,
      "additions": 1,
      "deletions": 0
    },
    "files": [
      {
        "sha": "4558a76a2868f1046b47cd4ef35e8b306751a8bf",
        "filename": "src/test/miner_tests.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/3fcec0d4a0ea9c3cb50a68685a64b2c60946438f/src/test/miner_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/3fcec0d4a0ea9c3cb50a68685a64b2c60946438f/src/test/miner_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/miner_tests.cpp?ref=3fcec0d4a0ea9c3cb50a68685a64b2c60946438f",
        "patch": "@@ -62,6 +62,7 @@ BOOST_AUTO_TEST_CASE(CreateNewBlock_validity)\n     std::vector<CTransaction*>txFirst;\n     for (unsigned int i = 0; i < sizeof(blockinfo)/sizeof(*blockinfo); ++i)\n     {\n+        pblock->nVersion = 1;\n         pblock->nTime = pindexBest->GetMedianTimePast()+1;\n         pblock->vtx[0].vin[0].scriptSig = CScript();\n         pblock->vtx[0].vin[0].scriptSig.push_back(blockinfo[i].extranonce);"
      }
    ]
  },
  {
    "sha": "de237cbfa4c1aa7d4f9888e650f870a50b77de73",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkZTIzN2NiZmE0YzFhYTdkNGY5ODg4ZTY1MGY4NzBhNTBiNzdkZTcz",
    "commit": {
      "author": {
        "name": "Gavin Andresen",
        "email": "gavinandresen@gmail.com",
        "date": "2012-06-27T23:30:39Z"
      },
      "committer": {
        "name": "Gavin Andresen",
        "email": "gavinandresen@gmail.com",
        "date": "2012-08-20T14:46:07Z"
      },
      "message": "Block height in coinbase as a new block rule\n\n\"Version 2\" blocks are blocks that have nVersion=2 and\nhave the block height as the first item in their coinbase.\nBlock-height-in-the-coinbase is strictly enforced when\nversion=2 blocks are a supermajority in the block chain\n(750 of the last 1,000 blocks on main net, 51 of 100 for\ntestnet). This does not affect old clients/miners at all,\nwhich will continue producing nVersion=1 blocks, and\nwhich will continue to be valid.",
      "tree": {
        "sha": "2b495c7174c0dc696a5ebc18af4485ae2bf8aeed",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2b495c7174c0dc696a5ebc18af4485ae2bf8aeed"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/de237cbfa4c1aa7d4f9888e650f870a50b77de73",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/de237cbfa4c1aa7d4f9888e650f870a50b77de73",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/de237cbfa4c1aa7d4f9888e650f870a50b77de73",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/de237cbfa4c1aa7d4f9888e650f870a50b77de73/comments",
    "author": {
      "login": "gavinandresen",
      "id": 331997,
      "node_id": "MDQ6VXNlcjMzMTk5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/331997?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gavinandresen",
      "html_url": "https://github.com/gavinandresen",
      "followers_url": "https://api.github.com/users/gavinandresen/followers",
      "following_url": "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url": "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gavinandresen/subscriptions",
      "organizations_url": "https://api.github.com/users/gavinandresen/orgs",
      "repos_url": "https://api.github.com/users/gavinandresen/repos",
      "events_url": "https://api.github.com/users/gavinandresen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gavinandresen/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "gavinandresen",
      "id": 331997,
      "node_id": "MDQ6VXNlcjMzMTk5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/331997?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gavinandresen",
      "html_url": "https://github.com/gavinandresen",
      "followers_url": "https://api.github.com/users/gavinandresen/followers",
      "following_url": "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url": "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gavinandresen/subscriptions",
      "organizations_url": "https://api.github.com/users/gavinandresen/orgs",
      "repos_url": "https://api.github.com/users/gavinandresen/repos",
      "events_url": "https://api.github.com/users/gavinandresen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gavinandresen/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "3fcec0d4a0ea9c3cb50a68685a64b2c60946438f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3fcec0d4a0ea9c3cb50a68685a64b2c60946438f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/3fcec0d4a0ea9c3cb50a68685a64b2c60946438f"
      }
    ],
    "stats": {
      "total": 36,
      "additions": 34,
      "deletions": 2
    },
    "files": [
      {
        "sha": "7a003c0ac528493659743af94b58e86c2cd354b4",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 27,
        "deletions": 1,
        "changes": 28,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/de237cbfa4c1aa7d4f9888e650f870a50b77de73/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/de237cbfa4c1aa7d4f9888e650f870a50b77de73/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=de237cbfa4c1aa7d4f9888e650f870a50b77de73",
        "patch": "@@ -1826,6 +1826,19 @@ bool CBlock::AcceptBlock()\n     if (!Checkpoints::CheckBlock(nHeight, hash))\n         return DoS(100, error(\"AcceptBlock() : rejected by checkpoint lock-in at %d\", nHeight));\n \n+    // Enforce block.nVersion=2 rule that the coinbase starts with serialized block height\n+    if (nVersion > 1)\n+    {\n+        // if 750 of the last 1,000 blocks are version 2 or greater (51/100 if testnet):\n+        if ((!fTestNet && CBlockIndex::IsSuperMajority(2, pindexPrev, 750, 1000)) ||\n+            (fTestNet && CBlockIndex::IsSuperMajority(2, pindexPrev, 51, 100)))\n+        {\n+            CScript expect = CScript() << nHeight;\n+            if (!std::equal(expect.begin(), expect.end(), vtx[0].vin[0].scriptSig.begin()))\n+                return DoS(100, error(\"AcceptBlock() : block height mismatch in coinbase\"));\n+        }\n+    }\n+\n     // Write block to history file\n     if (!CheckDiskSpace(::GetSerializeSize(*this, SER_DISK, CLIENT_VERSION)))\n         return error(\"AcceptBlock() : out of disk space\");\n@@ -1849,6 +1862,18 @@ bool CBlock::AcceptBlock()\n     return true;\n }\n \n+bool CBlockIndex::IsSuperMajority(int minVersion, const CBlockIndex* pstart, unsigned int nRequired, unsigned int nToCheck)\n+{\n+    unsigned int nFound = 0;\n+    for (unsigned int i = 0; i < nToCheck && nFound < nRequired && pstart != NULL; i++)\n+    {\n+        if (pstart->nVersion >= minVersion)\n+            ++nFound;\n+        pstart = pstart->pprev;\n+    }\n+    return (nFound >= nRequired);\n+}\n+\n bool ProcessBlock(CNode* pfrom, CBlock* pblock)\n {\n     // Check for duplicate\n@@ -3663,7 +3688,8 @@ void IncrementExtraNonce(CBlock* pblock, CBlockIndex* pindexPrev, unsigned int&\n         hashPrevBlock = pblock->hashPrevBlock;\n     }\n     ++nExtraNonce;\n-    pblock->vtx[0].vin[0].scriptSig = (CScript() << pblock->nTime << CBigNum(nExtraNonce)) + COINBASE_FLAGS;\n+    unsigned int nHeight = pindexPrev->nHeight+1; // Height first in coinbase required for block.version=2\n+    pblock->vtx[0].vin[0].scriptSig = (CScript() << nHeight << CBigNum(nExtraNonce)) + COINBASE_FLAGS;\n     assert(pblock->vtx[0].vin[0].scriptSig.size() <= 100);\n \n     pblock->hashMerkleRoot = pblock->BuildMerkleTree();"
      },
      {
        "sha": "cbc48e05c05425687e5bcdc52155e78a28b698d4",
        "filename": "src/main.h",
        "status": "modified",
        "additions": 7,
        "deletions": 1,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/de237cbfa4c1aa7d4f9888e650f870a50b77de73/src/main.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/de237cbfa4c1aa7d4f9888e650f870a50b77de73/src/main.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.h?ref=de237cbfa4c1aa7d4f9888e650f870a50b77de73",
        "patch": "@@ -820,7 +820,7 @@ class CBlock\n {\n public:\n     // header\n-    static const int CURRENT_VERSION=1;\n+    static const int CURRENT_VERSION=2;\n     int nVersion;\n     uint256 hashPrevBlock;\n     uint256 hashMerkleRoot;\n@@ -1164,6 +1164,12 @@ class CBlockIndex\n         return pindex->GetMedianTimePast();\n     }\n \n+    /**\n+     * Returns true if there are nRequired or more blocks of minVersion or above\n+     * in the last nToCheck blocks, starting at pstart and going backwards.\n+     */\n+    static bool IsSuperMajority(int minVersion, const CBlockIndex* pstart,\n+                                unsigned int nRequired, unsigned int nToCheck);\n \n \n     std::string ToString() const"
      }
    ]
  },
  {
    "sha": "d18f2fd9d6927b1a132c5e0094479cf44fc54aeb",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkMThmMmZkOWQ2OTI3YjFhMTMyYzVlMDA5NDQ3OWNmNDRmYzU0YWVi",
    "commit": {
      "author": {
        "name": "Gavin Andresen",
        "email": "gavinandresen@gmail.com",
        "date": "2012-07-06T01:22:16Z"
      },
      "committer": {
        "name": "Gavin Andresen",
        "email": "gavinandresen@gmail.com",
        "date": "2012-08-20T14:46:07Z"
      },
      "message": "Reject block.nVersion<=1 blocks if network has upgraded to version=2\n\nIf 950 of the last 1,000 blocks are nVersion=2, reject nVersion=1\n(or zero, but no bitcoin release has created block.nVersion=0) blocks\n-- 75 of last 100 on testnet3.\n\nThis rule is being put in place now so that we don't have to go\nthrough another \"express support\" process to get what we really\nwant, which is for every single new block to include the block height\nin the coinbase.",
      "tree": {
        "sha": "a982774d41cfaca9b0b74fb95272525fb51153f9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a982774d41cfaca9b0b74fb95272525fb51153f9"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d18f2fd9d6927b1a132c5e0094479cf44fc54aeb",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d18f2fd9d6927b1a132c5e0094479cf44fc54aeb",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/d18f2fd9d6927b1a132c5e0094479cf44fc54aeb",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d18f2fd9d6927b1a132c5e0094479cf44fc54aeb/comments",
    "author": {
      "login": "gavinandresen",
      "id": 331997,
      "node_id": "MDQ6VXNlcjMzMTk5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/331997?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gavinandresen",
      "html_url": "https://github.com/gavinandresen",
      "followers_url": "https://api.github.com/users/gavinandresen/followers",
      "following_url": "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url": "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gavinandresen/subscriptions",
      "organizations_url": "https://api.github.com/users/gavinandresen/orgs",
      "repos_url": "https://api.github.com/users/gavinandresen/repos",
      "events_url": "https://api.github.com/users/gavinandresen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gavinandresen/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "gavinandresen",
      "id": 331997,
      "node_id": "MDQ6VXNlcjMzMTk5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/331997?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gavinandresen",
      "html_url": "https://github.com/gavinandresen",
      "followers_url": "https://api.github.com/users/gavinandresen/followers",
      "following_url": "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url": "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gavinandresen/subscriptions",
      "organizations_url": "https://api.github.com/users/gavinandresen/orgs",
      "repos_url": "https://api.github.com/users/gavinandresen/repos",
      "events_url": "https://api.github.com/users/gavinandresen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gavinandresen/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "de237cbfa4c1aa7d4f9888e650f870a50b77de73",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/de237cbfa4c1aa7d4f9888e650f870a50b77de73",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/de237cbfa4c1aa7d4f9888e650f870a50b77de73"
      }
    ],
    "stats": {
      "total": 11,
      "additions": 10,
      "deletions": 1
    },
    "files": [
      {
        "sha": "7dd59fdeaa9f2a6143f7c139ff9bc24e7f5ea0d0",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 1,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d18f2fd9d6927b1a132c5e0094479cf44fc54aeb/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d18f2fd9d6927b1a132c5e0094479cf44fc54aeb/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=d18f2fd9d6927b1a132c5e0094479cf44fc54aeb",
        "patch": "@@ -1826,8 +1826,17 @@ bool CBlock::AcceptBlock()\n     if (!Checkpoints::CheckBlock(nHeight, hash))\n         return DoS(100, error(\"AcceptBlock() : rejected by checkpoint lock-in at %d\", nHeight));\n \n+    // Reject block.nVersion=1 blocks when 95% (75% on testnet) of the network has upgraded:\n+    if (nVersion < 2)\n+    {\n+        if ((!fTestNet && CBlockIndex::IsSuperMajority(2, pindexPrev, 950, 1000)) ||\n+            (fTestNet && CBlockIndex::IsSuperMajority(2, pindexPrev, 75, 100)))\n+        {\n+            return error(\"AcceptBlock() : rejected nVersion=1 block\");\n+        }\n+    }\n     // Enforce block.nVersion=2 rule that the coinbase starts with serialized block height\n-    if (nVersion > 1)\n+    if (nVersion >= 2)\n     {\n         // if 750 of the last 1,000 blocks are version 2 or greater (51/100 if testnet):\n         if ((!fTestNet && CBlockIndex::IsSuperMajority(2, pindexPrev, 750, 1000)) ||"
      }
    ]
  }
]