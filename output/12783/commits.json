[
  {
    "sha": "1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxZTBmM2M0NDk5MmZiODJlNmJmMzZjMmVmOTI3N2IwNzU5YzE3YzRj",
    "commit": {
      "author": {
        "name": "Alexey Ivanov",
        "email": "alexey.ivanes@gmail.com",
        "date": "2018-11-01T15:22:06Z"
      },
      "committer": {
        "name": "Alexey Ivanov",
        "email": "alexey.ivanes@gmail.com",
        "date": "2018-11-01T15:22:06Z"
      },
      "message": "macOS: disable AppNap during sync\n\nSigned-off-by: Alexey Ivanov <alexey.ivanes@gmail.com>",
      "tree": {
        "sha": "32b5f7fa397c16ee79b6ac1fe9f5c56b06d95902",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/32b5f7fa397c16ee79b6ac1fe9f5c56b06d95902"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEIEbN+nuR1dSGXY2FibE29QrGCXoFAlvbGh8ACgkQibE29QrG\nCXoiQhAAoynz4l1TJc8KUdmGX3PY9qph4w4IjRqB4n6d+vG6A65ft/vEs+FWv5pQ\nSWDsKvZwlE/zhLr1jMTq/PN7UCBut+5i618WlQWWCLYRnXSWkP0B0ErQ5n3LdBM6\nJ325Rbqkcv3kpku4FZlNsMhLadm35eLqx/nsES01jLzX8ORQBuCBaCcwQKUxf5my\nxxCQOoa5Z6JJylOFFlFOmiQUcWoFxjXcujXWi0p+rE0jcYdhQTtz9AWjHXfXmW5J\nQB4jMebRZbXSytVoKjWULdnfEebZEghrOrA0BtZqNiFQ5VOn3WnHqSsRR9eJ64PM\ngC2Sk9E3WYW21cOG/6rMHaLvrugKOGkXl5Nl3wwOw9S46iCJGLvf1TUOGuIqhW7x\n0F1AoHWUhzigdSxuwX6R7rmv1mTuMkmVStZdJSWCZvTEpnlX4orRA9ZCoLSv4r8u\nGQpNbFYuVUJbqtnQlku7sqjz8LyeNnNLgoKnC+rsdogXq/3y2ceBp389UMy8ZSlQ\nLrQFXsR+FDjilYsCa8SeuivPhZEol6VLM4MF4sKyafhcvc+/PGxXqM1qJjfFf9rV\nsow68ZFJrmNJkfbt3gVaQPHd4CrKd/NqRB3Ymyh6LgEd34K0+lMj7ibf6ZOsWyoF\nmMI9XDEXcnvnbzERETE5QFccSZ1vDkJHhiomUEbiFHBIVfkx4WM=\n=tru2\n-----END PGP SIGNATURE-----",
        "payload": "tree 32b5f7fa397c16ee79b6ac1fe9f5c56b06d95902\nparent f6df989842a1dee7e8ad779531c328456c7148a0\nauthor Alexey Ivanov <alexey.ivanes@gmail.com> 1541085726 +0300\ncommitter Alexey Ivanov <alexey.ivanes@gmail.com> 1541085726 +0300\n\nmacOS: disable AppNap during sync\n\nSigned-off-by: Alexey Ivanov <alexey.ivanes@gmail.com>\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c/comments",
    "author": {
      "login": "krab",
      "id": 834046,
      "node_id": "MDQ6VXNlcjgzNDA0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/834046?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/krab",
      "html_url": "https://github.com/krab",
      "followers_url": "https://api.github.com/users/krab/followers",
      "following_url": "https://api.github.com/users/krab/following{/other_user}",
      "gists_url": "https://api.github.com/users/krab/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/krab/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/krab/subscriptions",
      "organizations_url": "https://api.github.com/users/krab/orgs",
      "repos_url": "https://api.github.com/users/krab/repos",
      "events_url": "https://api.github.com/users/krab/events{/privacy}",
      "received_events_url": "https://api.github.com/users/krab/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "krab",
      "id": 834046,
      "node_id": "MDQ6VXNlcjgzNDA0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/834046?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/krab",
      "html_url": "https://github.com/krab",
      "followers_url": "https://api.github.com/users/krab/followers",
      "following_url": "https://api.github.com/users/krab/following{/other_user}",
      "gists_url": "https://api.github.com/users/krab/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/krab/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/krab/subscriptions",
      "organizations_url": "https://api.github.com/users/krab/orgs",
      "repos_url": "https://api.github.com/users/krab/repos",
      "events_url": "https://api.github.com/users/krab/events{/privacy}",
      "received_events_url": "https://api.github.com/users/krab/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f6df989842a1dee7e8ad779531c328456c7148a0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f6df989842a1dee7e8ad779531c328456c7148a0",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f6df989842a1dee7e8ad779531c328456c7148a0"
      }
    ],
    "stats": {
      "total": 120,
      "additions": 116,
      "deletions": 4
    },
    "files": [
      {
        "sha": "abe605efd0a3278efd6da2017bc13b85ff3722df",
        "filename": "share/qt/Info.plist.in",
        "status": "modified",
        "additions": 0,
        "deletions": 3,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c/share/qt/Info.plist.in",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c/share/qt/Info.plist.in",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/share/qt/Info.plist.in?ref=1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c",
        "patch": "@@ -97,9 +97,6 @@\n   <key>NSHighResolutionCapable</key>\n     <string>True</string>\n \n-  <key>LSAppNapIsDisabled</key>\n-    <string>True</string>\n-\n   <key>NSRequiresAquaSystemAppearance</key>\n     <string>True</string>\n   "
      },
      {
        "sha": "73538e8bc93665b222a851fb932b6f7a09ee4459",
        "filename": "src/Makefile.qt.include",
        "status": "modified",
        "additions": 3,
        "deletions": 1,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c/src/Makefile.qt.include",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c/src/Makefile.qt.include",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/Makefile.qt.include?ref=1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c",
        "patch": "@@ -162,7 +162,8 @@ QT_MOC_CPP = \\\n \n BITCOIN_MM = \\\n   qt/macdockiconhandler.mm \\\n-  qt/macnotificationhandler.mm\n+  qt/macnotificationhandler.mm \\\n+  qt/macos_appnap.mm\n \n QT_MOC = \\\n   qt/bitcoin.moc \\\n@@ -205,6 +206,7 @@ BITCOIN_QT_H = \\\n   qt/intro.h \\\n   qt/macdockiconhandler.h \\\n   qt/macnotificationhandler.h \\\n+  qt/macos_appnap.h \\\n   qt/modaloverlay.h \\\n   qt/networkstyle.h \\\n   qt/notificator.h \\"
      },
      {
        "sha": "1e80777c15baca73d66f1fae6e682fefbf9cfbcf",
        "filename": "src/qt/bitcoingui.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 0,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c/src/qt/bitcoingui.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c/src/qt/bitcoingui.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/bitcoingui.cpp?ref=1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c",
        "patch": "@@ -211,6 +211,10 @@ BitcoinGUI::BitcoinGUI(interfaces::Node& node, const PlatformStyle *_platformSty\n         connect(progressBar, &GUIUtil::ClickableProgressBar::clicked, this, &BitcoinGUI::showModalOverlay);\n     }\n #endif\n+\n+#ifdef Q_OS_MAC\n+    m_app_nap_inhibitor = new CAppNapInhibitor;\n+#endif\n }\n \n BitcoinGUI::~BitcoinGUI()\n@@ -223,6 +227,7 @@ BitcoinGUI::~BitcoinGUI()\n     if(trayIcon) // Hide tray icon, as deleting will let it linger until quit (on Ubuntu)\n         trayIcon->hide();\n #ifdef Q_OS_MAC\n+    delete m_app_nap_inhibitor;\n     delete appMenuBar;\n     MacDockIconHandler::cleanup();\n #endif\n@@ -786,6 +791,11 @@ void BitcoinGUI::openOptionsDialogWithTab(OptionsDialog::Tab tab)\n \n void BitcoinGUI::setNumBlocks(int count, const QDateTime& blockDate, double nVerificationProgress, bool header)\n {\n+// Disabling macOS App Nap on initial sync, disk and reindex operations.\n+#ifdef Q_OS_MAC\n+    (m_node.isInitialBlockDownload() || m_node.getReindex() || m_node.getImporting()) ? m_app_nap_inhibitor->disableAppNap() : m_app_nap_inhibitor->enableAppNap();\n+#endif\n+\n     if (modalOverlay)\n     {\n         if (header)"
      },
      {
        "sha": "57b70803aeda2ab0888c0fc1dedd8b6e58e4eed2",
        "filename": "src/qt/bitcoingui.h",
        "status": "modified",
        "additions": 8,
        "deletions": 0,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c/src/qt/bitcoingui.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c/src/qt/bitcoingui.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/bitcoingui.h?ref=1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c",
        "patch": "@@ -20,6 +20,10 @@\n #include <QPoint>\n #include <QSystemTrayIcon>\n \n+#ifdef Q_OS_MAC\n+#include <qt/macos_appnap.h>\n+#endif\n+\n #include <memory>\n \n class ClientModel;\n@@ -143,6 +147,10 @@ class BitcoinGUI : public QMainWindow\n     HelpMessageDialog* helpMessageDialog = nullptr;\n     ModalOverlay* modalOverlay = nullptr;\n \n+#ifdef Q_OS_MAC\n+    CAppNapInhibitor* m_app_nap_inhibitor = nullptr;\n+#endif\n+\n     /** Keep track of previous number of blocks, to detect progress */\n     int prevBlocks = 0;\n     int spinnerFrame = 0;"
      },
      {
        "sha": "8c2cd840b01c8738e94a58188aff008adc3d2be3",
        "filename": "src/qt/macos_appnap.h",
        "status": "added",
        "additions": 24,
        "deletions": 0,
        "changes": 24,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c/src/qt/macos_appnap.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c/src/qt/macos_appnap.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/macos_appnap.h?ref=1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c",
        "patch": "@@ -0,0 +1,24 @@\n+// Copyright (c) 2011-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_QT_MACOS_APPNAP_H\n+#define BITCOIN_QT_MACOS_APPNAP_H\n+\n+#include <memory>\n+\n+class CAppNapInhibitor final\n+{\n+public:\n+    explicit CAppNapInhibitor();\n+    ~CAppNapInhibitor();\n+\n+    void disableAppNap();\n+    void enableAppNap();\n+\n+private:\n+    class CAppNapImpl;\n+    std::unique_ptr<CAppNapImpl> impl;\n+};\n+\n+#endif // BITCOIN_QT_MACOS_APPNAP_H"
      },
      {
        "sha": "22a88782abe39d978ee6f4207c81f5df3b54e338",
        "filename": "src/qt/macos_appnap.mm",
        "status": "added",
        "additions": 71,
        "deletions": 0,
        "changes": 71,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c/src/qt/macos_appnap.mm",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c/src/qt/macos_appnap.mm",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/macos_appnap.mm?ref=1e0f3c44992fb82e6bf36c2ef9277b0759c17c4c",
        "patch": "@@ -0,0 +1,71 @@\n+// Copyright (c) 2011-2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include \"macos_appnap.h\"\n+\n+#include <AvailabilityMacros.h>\n+#include <Foundation/NSProcessInfo.h>\n+#include <Foundation/Foundation.h>\n+\n+class CAppNapInhibitor::CAppNapImpl\n+{\n+public:\n+    ~CAppNapImpl()\n+    {\n+        if(activityId)\n+            enableAppNap();\n+    }\n+\n+    void disableAppNap()\n+    {\n+        if (!activityId)\n+        {\n+            @autoreleasepool {\n+                const NSActivityOptions activityOptions =\n+                NSActivityUserInitiatedAllowingIdleSystemSleep &\n+                ~(NSActivitySuddenTerminationDisabled |\n+                NSActivityAutomaticTerminationDisabled);\n+\n+                id processInfo = [NSProcessInfo processInfo];\n+                if ([processInfo respondsToSelector:@selector(beginActivityWithOptions:reason:)])\n+                {\n+                    activityId = [processInfo beginActivityWithOptions: activityOptions reason:@\"Temporarily disable App Nap for bitcoin-qt.\"];\n+                    [activityId retain];\n+                }\n+            }\n+        }\n+    }\n+\n+    void enableAppNap()\n+    {\n+        if(activityId)\n+        {\n+            @autoreleasepool {\n+                id processInfo = [NSProcessInfo processInfo];\n+                if ([processInfo respondsToSelector:@selector(endActivity:)])\n+                    [processInfo endActivity:activityId];\n+\n+                [activityId release];\n+                activityId = nil;\n+            }\n+        }\n+    }\n+\n+private:\n+    NSObject* activityId;\n+};\n+\n+CAppNapInhibitor::CAppNapInhibitor() : impl(new CAppNapImpl()) {}\n+\n+CAppNapInhibitor::~CAppNapInhibitor() = default;\n+\n+void CAppNapInhibitor::disableAppNap()\n+{\n+    impl->disableAppNap();\n+}\n+\n+void CAppNapInhibitor::enableAppNap()\n+{\n+    impl->enableAppNap();\n+}"
      }
    ]
  }
]