[
  {
    "sha": "99a40c1042a2776e948e086a6c98d856050a14a4",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5OWE0MGMxMDQyYTI3NzZlOTQ4ZTA4NmE2Yzk4ZDg1NjA1MGExNGE0",
    "commit": {
      "author": {
        "name": "Jonas Schnelli",
        "email": "dev@jonasschnelli.ch",
        "date": "2016-12-16T16:38:44Z"
      },
      "committer": {
        "name": "Jonas Schnelli",
        "email": "dev@jonasschnelli.ch",
        "date": "2016-12-16T16:45:20Z"
      },
      "message": "[MOVEONLY] move CAffectedKeysVisitor",
      "tree": {
        "sha": "c6fb2117c520380f8814bcec31785e77ca4faa00",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c6fb2117c520380f8814bcec31785e77ca4faa00"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/99a40c1042a2776e948e086a6c98d856050a14a4",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "expired_key",
        "signature": "-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v2\n\niQIcBAABCAAGBQJYVBogAAoJECnUvLZBb1Ps/I0P/22t7gwPOKRP1nDw7lTMHKRh\nCmMYPk4/vpzZ1KmjQuvSMcQmjtGOeWXYMDTxUJAihxV6ngjSYqknpq5jlImLGGsR\nhy9WewxzMHcXHhY69csYdSbFRXrvWG7lw3Nre1Ypx5FH2EEI0tNSI+MN/aprZYUp\n7LjifOeKq6poVwlgZk+EgrhKZSMT/Em8VHtJ+VG62tkzkllUJBpmMuOn3gExkDBn\nqKYoDiyUWHd6va3hIUiikcC2R3PK9P4CtNOd5k1KqXc3ZTRcx/MKsoOidDA46zkg\nOfijO0L/88g56ibbvrMMVq+D2/LgMvXhcOv+X7pTlQOv+cScBFDZTLqCeoLLPp95\nlZOIDBIt0JVuCk8i9026DbiXkpXTGM4J+tJGT2Bg5fxuoqlkmN5ecg4mYnCVkUTV\ntsQozP/r26HBaye5qVeWnXWxM86vWxNXF30I8rjoDBUdfjJJtmT+tpqoHgR4s1tM\nrE2gjypwNsUshbCLsr6fjtWWLo3JmuRr1r1VYBjUNOsyWAgCPuLnMJkK5cJckTtU\nn2VwLvmmMrpcbhMqCCmU6GhKCvlsYYyCejm7nqfpyDlArJYbHi/p2gOW87Fr1hk7\nabGCKszXIjG9T3/+6NRTwS2AdQabuX3fvrmBjSPOmiSAyOt+9+Q+qnZSvKKaWt5H\na2L+THIuWJ+UTJpqcqVD\n=hYQ9\n-----END PGP SIGNATURE-----",
        "payload": "tree c6fb2117c520380f8814bcec31785e77ca4faa00\nparent 8c7947e09ff854cacd9461f268b90edf3f6e6e55\nauthor Jonas Schnelli <dev@jonasschnelli.ch> 1481906324 +0100\ncommitter Jonas Schnelli <dev@jonasschnelli.ch> 1481906720 +0100\n\n[MOVEONLY] move CAffectedKeysVisitor\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/99a40c1042a2776e948e086a6c98d856050a14a4",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/99a40c1042a2776e948e086a6c98d856050a14a4",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/99a40c1042a2776e948e086a6c98d856050a14a4/comments",
    "author": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "8c7947e09ff854cacd9461f268b90edf3f6e6e55",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8c7947e09ff854cacd9461f268b90edf3f6e6e55",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/8c7947e09ff854cacd9461f268b90edf3f6e6e55"
      }
    ],
    "stats": {
      "total": 64,
      "additions": 32,
      "deletions": 32
    },
    "files": [
      {
        "sha": "486ddaefa5e713d39ac2636c7ed4239bbda3e371",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 32,
        "deletions": 32,
        "changes": 64,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/99a40c1042a2776e948e086a6c98d856050a14a4/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/99a40c1042a2776e948e086a6c98d856050a14a4/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=99a40c1042a2776e948e086a6c98d856050a14a4",
        "patch": "@@ -78,6 +78,38 @@ std::string COutput::ToString() const\n     return strprintf(\"COutput(%s, %d, %d) [%s]\", tx->GetHash().ToString(), i, nDepth, FormatMoney(tx->tx->vout[i].nValue));\n }\n \n+class CAffectedKeysVisitor : public boost::static_visitor<void> {\n+private:\n+    const CKeyStore &keystore;\n+    std::vector<CKeyID> &vKeys;\n+\n+public:\n+    CAffectedKeysVisitor(const CKeyStore &keystoreIn, std::vector<CKeyID> &vKeysIn) : keystore(keystoreIn), vKeys(vKeysIn) {}\n+\n+    void Process(const CScript &script) {\n+        txnouttype type;\n+        std::vector<CTxDestination> vDest;\n+        int nRequired;\n+        if (ExtractDestinations(script, type, vDest, nRequired)) {\n+            BOOST_FOREACH(const CTxDestination &dest, vDest)\n+                boost::apply_visitor(*this, dest);\n+        }\n+    }\n+\n+    void operator()(const CKeyID &keyId) {\n+        if (keystore.HaveKey(keyId))\n+            vKeys.push_back(keyId);\n+    }\n+\n+    void operator()(const CScriptID &scriptId) {\n+        CScript script;\n+        if (keystore.GetCScript(scriptId, script))\n+            Process(script);\n+    }\n+\n+    void operator()(const CNoDestination &none) {}\n+};\n+\n const CWalletTx* CWallet::GetWalletTx(const uint256& hash) const\n {\n     LOCK(cs_wallet);\n@@ -3216,38 +3248,6 @@ void CWallet::ListLockedCoins(std::vector<COutPoint>& vOutpts)\n \n /** @} */ // end of Actions\n \n-class CAffectedKeysVisitor : public boost::static_visitor<void> {\n-private:\n-    const CKeyStore &keystore;\n-    std::vector<CKeyID> &vKeys;\n-\n-public:\n-    CAffectedKeysVisitor(const CKeyStore &keystoreIn, std::vector<CKeyID> &vKeysIn) : keystore(keystoreIn), vKeys(vKeysIn) {}\n-\n-    void Process(const CScript &script) {\n-        txnouttype type;\n-        std::vector<CTxDestination> vDest;\n-        int nRequired;\n-        if (ExtractDestinations(script, type, vDest, nRequired)) {\n-            BOOST_FOREACH(const CTxDestination &dest, vDest)\n-                boost::apply_visitor(*this, dest);\n-        }\n-    }\n-\n-    void operator()(const CKeyID &keyId) {\n-        if (keystore.HaveKey(keyId))\n-            vKeys.push_back(keyId);\n-    }\n-\n-    void operator()(const CScriptID &scriptId) {\n-        CScript script;\n-        if (keystore.GetCScript(scriptId, script))\n-            Process(script);\n-    }\n-\n-    void operator()(const CNoDestination &none) {}\n-};\n-\n void CWallet::GetKeyBirthTimes(std::map<CKeyID, int64_t> &mapKeyBirth) const {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n     mapKeyBirth.clear();"
      }
    ]
  },
  {
    "sha": "4d0a4ff5ce774c1ba301d14ee18318c759ca3145",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0ZDBhNGZmNWNlNzc0YzFiYTMwMWQxNGVlMTgzMThjNzU5Y2EzMTQ1",
    "commit": {
      "author": {
        "name": "Jonas Schnelli",
        "email": "dev@jonasschnelli.ch",
        "date": "2016-12-16T16:42:49Z"
      },
      "committer": {
        "name": "Jonas Schnelli",
        "email": "dev@jonasschnelli.ch",
        "date": "2016-12-16T16:45:26Z"
      },
      "message": "[Wallet] Try to remove keypool keys if they are used as output",
      "tree": {
        "sha": "50e139f5050d2f1f7be914ed80537c6c0ce02f6c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/50e139f5050d2f1f7be914ed80537c6c0ce02f6c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4d0a4ff5ce774c1ba301d14ee18318c759ca3145",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "expired_key",
        "signature": "-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v2\n\niQIcBAABCAAGBQJYVBomAAoJECnUvLZBb1Psm4IP/icBROYhsvIw+qLqoHPHH7QW\n+IcT5y12GV7WZvf5rSg3W02QWY9WA7rjOgKwSZutFFHqmmElMnVLEQc4XCGys6mP\nUfCIL57AhFuTIMwwWmNGlVaxf9nlXIwzgv8EXD7wXlp9p8H8nErAVJInolVcgERs\niXuUUOjSow56j22+KmDT3TmJtai2sA2/mT/YwRnuOPwn4KzVLdF6uZlJLwAMIPrp\nzjdB9znbk6yaSY/s6ZQb8hic3wfPgcpSuQYneLL+LepyvAJS4MMxgpy6b2Aaau9s\nG7GryadNPNS//jH3pYRurxDRYtuKP5RJ9OfqP716tOV+cHpSxG0nGN0p/n+xZpkK\nJFk7I6bo0gQV0FChv2uUt/PkicLfu07Q13DrJPxTYyhN6uPRYOhBJ6Yrun0aY1Ot\nNZIG3TXZNvsGC+QSj9DqN5Qb+KflYnxwLgBngP0V6FdXmn7t2UX+ujtg5RBcCUoI\n/p6y8//wKjnHjtWQ2UDKRogmMnZ6czThI5mvb+o2ERHDdL6eRuko4gT+i/hpYNeh\nqVm7Di3NAvEO6vYyCcp8COZmps750kcsf1S3Gp/p502Ex0zFck6mRJyvZWOeFORR\n9MgOfLcysH20HS5lU/GNa3+WfCF4SIWf0rMeSJr4aMHKv5QdAnZMx3G7Anlox1h1\n936Com1vOloEzi0bRj/W\n=Qh7e\n-----END PGP SIGNATURE-----",
        "payload": "tree 50e139f5050d2f1f7be914ed80537c6c0ce02f6c\nparent 99a40c1042a2776e948e086a6c98d856050a14a4\nauthor Jonas Schnelli <dev@jonasschnelli.ch> 1481906569 +0100\ncommitter Jonas Schnelli <dev@jonasschnelli.ch> 1481906726 +0100\n\n[Wallet] Try to remove keypool keys if they are used as output\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4d0a4ff5ce774c1ba301d14ee18318c759ca3145",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/4d0a4ff5ce774c1ba301d14ee18318c759ca3145",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4d0a4ff5ce774c1ba301d14ee18318c759ca3145/comments",
    "author": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "99a40c1042a2776e948e086a6c98d856050a14a4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/99a40c1042a2776e948e086a6c98d856050a14a4",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/99a40c1042a2776e948e086a6c98d856050a14a4"
      }
    ],
    "stats": {
      "total": 33,
      "additions": 33,
      "deletions": 0
    },
    "files": [
      {
        "sha": "967710f9bfd767781c9f21e8f75f5392f24c6cad",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 32,
        "deletions": 0,
        "changes": 32,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4d0a4ff5ce774c1ba301d14ee18318c759ca3145/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4d0a4ff5ce774c1ba301d14ee18318c759ca3145/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=4d0a4ff5ce774c1ba301d14ee18318c759ca3145",
        "patch": "@@ -1025,6 +1025,20 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransaction& tx, const CBlockIndex\n         if (fExisted && !fUpdate) return false;\n         if (fExisted || IsMine(tx) || IsFromMe(tx))\n         {\n+            // check if we need to flag used keypool keys (fundrawtransaction does not \"keep\" keypool keys)\n+            std::set<CKeyID> setKeyPool;\n+            GetAllReserveKeys(setKeyPool);\n+            // loop though all outputs\n+            BOOST_FOREACH(const CTxOut& txout, tx.vout) {\n+                // extract addresses and check if they match with an unused keypool key\n+                std::vector<CKeyID> vAffected;\n+                CAffectedKeysVisitor(*this, vAffected).Process(txout.scriptPubKey);\n+                BOOST_FOREACH(const CKeyID &keyid, vAffected)\n+                    if (setKeyPool.count(keyid))\n+                        KeepReserveKeyWithAddress(keyid);\n+            }\n+\n+\n             CWalletTx wtx(this, MakeTransactionRef(tx));\n \n             // Get merkle branch if transaction was found in a block\n@@ -3168,6 +3182,24 @@ void CReserveKey::ReturnKey()\n     vchPubKey = CPubKey();\n }\n \n+void CWallet::KeepReserveKeyWithAddress(const CKeyID& keyId)\n+{\n+    LOCK(cs_wallet);\n+    CWalletDB walletdb(strWalletFile);\n+    for(const int64_t& id : setKeyPool)\n+    {\n+        CKeyPool keypool;\n+        if (!walletdb.ReadPool(id, keypool))\n+            throw runtime_error(std::string(__func__) + \": read failed\");\n+        if (keypool.vchPubKey.GetID() == keyId)\n+        {\n+            KeepKey(id);\n+            setKeyPool.erase(id);\n+            break;\n+        }\n+    }\n+}\n+\n void CWallet::GetAllReserveKeys(set<CKeyID>& setAddress) const\n {\n     setAddress.clear();"
      },
      {
        "sha": "42ec11f883be02b1a3abfe0b4008c5bed8af6bcd",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4d0a4ff5ce774c1ba301d14ee18318c759ca3145/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4d0a4ff5ce774c1ba301d14ee18318c759ca3145/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=4d0a4ff5ce774c1ba301d14ee18318c759ca3145",
        "patch": "@@ -807,6 +807,7 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n     void ReturnKey(int64_t nIndex);\n     bool GetKeyFromPool(CPubKey &key);\n     int64_t GetOldestKeyPoolTime();\n+    void KeepReserveKeyWithAddress(const CKeyID& keyId);\n     void GetAllReserveKeys(std::set<CKeyID>& setAddress) const;\n \n     std::set< std::set<CTxDestination> > GetAddressGroupings();"
      }
    ]
  },
  {
    "sha": "4a011a64221f3810d04565a3f6d560a77251704e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0YTAxMWE2NDIyMWYzODEwZDA0NTY1YTNmNmQ1NjBhNzcyNTE3MDRl",
    "commit": {
      "author": {
        "name": "Jonas Schnelli",
        "email": "dev@jonasschnelli.ch",
        "date": "2016-12-16T16:58:05Z"
      },
      "committer": {
        "name": "Jonas Schnelli",
        "email": "dev@jonasschnelli.ch",
        "date": "2016-12-16T16:58:05Z"
      },
      "message": "[QA] Add test to ensure fundrawtx in conjunction with sendrawtx does not enforce address reuse",
      "tree": {
        "sha": "eb903ee743497001d07730f05bb0407dc4019bd4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/eb903ee743497001d07730f05bb0407dc4019bd4"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4a011a64221f3810d04565a3f6d560a77251704e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "expired_key",
        "signature": "-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v2\n\niQIcBAABCAAGBQJYVB1HAAoJECnUvLZBb1Ps/OAP/Aye8NFXK5LRaYJ3Yn8UBKyC\nlyu2Jg5f8OpUM2HyJzv89nC9FFovl60OzS2cpds/stw3wWUi7HmZmesxXXagTHv2\n9P5pVamgGqC9eqDvLyMFu30IRWwshQ6G1ng7kdGJrs7a+GzZumwtSkGYdHfvmvR7\nSryyoz0Y7dWCnIcBL3MvTralYzUtDbadnyKllxCDtFqDmrMDa5rAMwCd25HDXooU\ngFDQvakcu88FFnu/9+vxxsYvRZaaH/saKURSf0EJWYa8ZY+eWiQPxKzk3spX8x6t\nCpp9mqNGoNQ10IZU453XCUSRepN+seSxS8yKP+PqIX7jk1ZYrXV18tMy7byR/xf2\n4J7o70xAzBTHzhdvoWAMu4XA2SB00YIq/9eiGxivjt0/EehaPFtcl+X4x9byu+wZ\nR03DGqu9FilyqqFy3VK9nprTlz8OfUxieNdbP68LWVTlpd6moL5CaV934qlrSSf9\nCBnK40xXO2sHVDIVwLag8uyPVa681FZF08XTlrg75GB7MtY4qlyVIrZBCl/RYXPx\ni8+v1oefuE8jcrHZ3+GiM2JhS/aA5L7UVSu/grC+yt3ExIlkejaEn/FQiJ1gBT6O\nk5bjbZTryTFqkUHFVrO/mjSkMC407L540AN8csMxW9KofRs3KCE9KSZLSBTpkyFG\nSd9gyYzU4FmrEGp/h2nN\n=171X\n-----END PGP SIGNATURE-----",
        "payload": "tree eb903ee743497001d07730f05bb0407dc4019bd4\nparent 4d0a4ff5ce774c1ba301d14ee18318c759ca3145\nauthor Jonas Schnelli <dev@jonasschnelli.ch> 1481907485 +0100\ncommitter Jonas Schnelli <dev@jonasschnelli.ch> 1481907485 +0100\n\n[QA] Add test to ensure fundrawtx in conjunction with sendrawtx does not enforce address reuse\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4a011a64221f3810d04565a3f6d560a77251704e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/4a011a64221f3810d04565a3f6d560a77251704e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4a011a64221f3810d04565a3f6d560a77251704e/comments",
    "author": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "4d0a4ff5ce774c1ba301d14ee18318c759ca3145",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4d0a4ff5ce774c1ba301d14ee18318c759ca3145",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/4d0a4ff5ce774c1ba301d14ee18318c759ca3145"
      }
    ],
    "stats": {
      "total": 15,
      "additions": 14,
      "deletions": 1
    },
    "files": [
      {
        "sha": "5f34a95ae23b54ba7ac3dd33b5e43b3119670f40",
        "filename": "qa/rpc-tests/fundrawtransaction.py",
        "status": "modified",
        "additions": 14,
        "deletions": 1,
        "changes": 15,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4a011a64221f3810d04565a3f6d560a77251704e/qa/rpc-tests/fundrawtransaction.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4a011a64221f3810d04565a3f6d560a77251704e/qa/rpc-tests/fundrawtransaction.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/fundrawtransaction.py?ref=4a011a64221f3810d04565a3f6d560a77251704e",
        "patch": "@@ -651,7 +651,7 @@ def run_test(self):\n         assert_equal(len(self.nodes[3].listunspent(1)), 1)\n \n         inputs = []\n-        outputs = {self.nodes[2].getnewaddress() : 1}\n+        outputs = {self.nodes[3].getnewaddress() : 1}\n         rawtx = self.nodes[3].createrawtransaction(inputs, outputs)\n         result = self.nodes[3].fundrawtransaction(rawtx) # uses min_relay_tx_fee (set by settxfee)\n         result2 = self.nodes[3].fundrawtransaction(rawtx, {\"feeRate\": 2*min_relay_tx_fee})\n@@ -660,5 +660,18 @@ def run_test(self):\n         assert_fee_amount(result2['fee'], count_bytes(result2['hex']), 2 * result_fee_rate)\n         assert_fee_amount(result3['fee'], count_bytes(result3['hex']), 10 * result_fee_rate)\n \n+        res_dec = self.nodes[0].decoderawtransaction(result3[\"hex\"])\n+        rawtxsigned = self.nodes[3].signrawtransaction(result3['hex'])\n+        self.nodes[3].sendrawtransaction(rawtxsigned['hex'])\n+        changeaddress = \"\"\n+        for out in res_dec['vout']:\n+            if out['value'] > 1.0:\n+                changeaddress += out['scriptPubKey']['addresses'][0]\n+        assert(changeaddress != \"\")\n+        nextaddr = self.nodes[3].getnewaddress()\n+        # make sure fundrawtransaction does not enforce address reusing\n+        assert(changeaddress != nextaddr)\n+\n+\n if __name__ == '__main__':\n     RawTransactionsTest().main()"
      }
    ]
  }
]