jnewbery,2018-08-08T21:58:41Z,"Concept ACK. The feerate is a measure on weight unit, not discrete transaction, so the median feerate should me the middle weight unit of the block.\n\nConceptually, this gives a better representation of the fees paid in the block, since the measure is not skewed by small or large txs.\n\nWill review tomorrow.",https://github.com/bitcoin/bitcoin/pull/13918#issuecomment-411566011,411566011,
MarcoFalke,2018-08-08T22:04:34Z,utACK 2d4bf95973bb5224238762ce94e3ecb835b77280,https://github.com/bitcoin/bitcoin/pull/13918#issuecomment-411567907,411567907,
MarcoFalke,2018-08-08T22:08:41Z,"Imo this is a bugfix for 0.17, but not a blocker for rc1.",https://github.com/bitcoin/bitcoin/pull/13918#issuecomment-411568977,411568977,
marcinja,2018-08-09T16:19:39Z,"Thanks for the reviews. I fixed all the nits and added some unit tests for `CalculatePercentilesByWeight`\n\nI'm not sure that I put the tests in the best location, and also this now fails on Travis because of linting\n\n```\nâœ— bitcoin (change-feerates-rpc) ./test/lint/lint-includes.sh \nThe following files #include .cpp files:\nsrc/test/rpc_tests.cpp:#include <rpc/blockchain.cpp>\n```\n",https://github.com/bitcoin/bitcoin/pull/13918#issuecomment-411815071,411815071,
DrahtBot,2018-08-09T18:29:12Z,"<!--e57a25ab6845829454e8d69fc972939a-->Note to reviewers: This pull request conflicts with the following ones:\n\n* #11342 (Sanity assert GetAncestor() != nullptr where appropriate by danra)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",https://github.com/bitcoin/bitcoin/pull/13918#issuecomment-411853237,411853237,
achow101,2018-08-10T23:50:50Z,utACK 64101856b4e9a110770e389d2a1cad6a5802321c,https://github.com/bitcoin/bitcoin/pull/13918#issuecomment-412233707,412233707,
sipa,2018-08-10T23:59:17Z,"This breaks the RPC interface. Do we need to go through the rpc deprecation process, or should we should maintain a legacy `medianfeerate` field?",https://github.com/bitcoin/bitcoin/pull/13918#issuecomment-412234645,412234645,
achow101,2018-08-11T00:25:12Z,"@sipa getblockstats is not in any release, so I think this is actually fine to have a breaking API change.",https://github.com/bitcoin/bitcoin/pull/13918#issuecomment-412237142,412237142,
sipa,2018-08-11T00:39:48Z,"Ah, I didn't notice this was considered to be a bugfix.",https://github.com/bitcoin/bitcoin/pull/13918#issuecomment-412238255,412238255,
MarcoFalke,2018-08-12T21:37:13Z,re-utACK 4b7091a842c2c3a76f4136cb0fdcf1c5904fd237,https://github.com/bitcoin/bitcoin/pull/13918#issuecomment-412373450,412373450,
laanwj,2018-08-13T11:29:41Z,"Cannot really test this without txindex enabled,\nutACK 4b7091a842c2c3a76f4136cb0fdcf1c5904fd237",https://github.com/bitcoin/bitcoin/pull/13918#issuecomment-412488166,412488166,
jtimon,2018-08-16T19:20:49Z,"concept ACK, I wish somebody had pinged me for review.\n\nI think I would have liked more to keep them as separated fields (ie percentile_feerate10, percentile_feerate25, percentile_feerate50, percentile_feerate75, percentile_feerate90) instead of giving them as an array, but no big deal, I can just do that on the caller.",https://github.com/bitcoin/bitcoin/pull/13918#issuecomment-413656245,413656245,
ajtowns,2018-08-09T01:34:35Z,"This should be `while (next_percentile_index < NUM_GETBLOCKSTATS_PERCENTILS && cumulative_weight >= weights[next_percentile_index]) {`, no?",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208784227,208784227,src/rpc/blockchain.cpp
marcinja,2018-08-09T03:58:46Z,"Yes, thanks for catching that.",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208800247,208800247,src/rpc/blockchain.cpp
kallewoof,2018-08-09T04:24:15Z,Nit: indentation is off for `(array of numeric) [...]` -- see above line.,https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208802802,208802802,src/rpc/blockchain.cpp
domob1812,2018-08-09T09:53:09Z,"You don't use `size` anywhere else below - so you could just do:\n\n    if (scores.empty()) {\n        return;\n    }",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208870701,208870701,src/rpc/blockchain.cpp
domob1812,2018-08-09T09:53:43Z,Nit: I believe there should be spaces on both sides of `:`.,https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208870908,208870908,src/rpc/blockchain.cpp
conscott,2018-08-09T11:59:16Z,"This logic seems correct, but would be nice to have some test cases to ensure expected behavior for cases like:\n1. Few number of txs (expect same feerate for multiple percentiles)\n2. Tx whose weight spans more than one weight percentile group \n",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208902023,208902023,src/rpc/blockchain.cpp
jnewbery,2018-08-09T14:03:24Z,nit: I think it's better to place `constexpr`s at the top of the file (especially since this is used in multiple functions in this file),https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208941123,208941123,src/rpc/blockchain.cpp
jnewbery,2018-08-09T14:04:37Z,"nit: using a template here is over-engineering this. Even if you plan to re-use this a measure other than fee-rate, it would make more sense to define this just for fee-rate now and then change to a template in the next PR.",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208941610,208941610,src/rpc/blockchain.cpp
jnewbery,2018-08-09T14:09:27Z,nit: perhaps a comment here to say that you're filling in the remaining percentile results to the same as the last filled percentile result.,https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208943531,208943531,src/rpc/blockchain.cpp
jnewbery,2018-08-09T14:10:36Z,nit: the other result keys are dictionary sorted in the help text. I suggest you follow the same convention here.,https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208943951,208943951,src/rpc/blockchain.cpp
jnewbery,2018-08-09T14:14:03Z,nit: I'd push this code up to immediately below the `CalculatePercentilesByWeight()` call so all the `ret_all.pushKV()` calls are on contiguous (alphabetized) lines.,https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208945368,208945368,src/rpc/blockchain.cpp
jnewbery,2018-08-09T14:14:46Z,nit: replace tab with spaces please :),https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208945619,208945619,test/functional/data/rpc_getblockstats.json
jnewbery,2018-08-09T14:17:26Z,:+1: ,https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208946616,208946616,src/rpc/blockchain.cpp
jnewbery,2018-08-09T14:19:44Z,"Agree that `getblockstats` could do with some more thorough testing, but this PR doesn't make things worse, so I'd be inclined to say leave it for a future PR.",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208947499,208947499,src/rpc/blockchain.cpp
MarcoFalke,2018-08-09T16:22:27Z,Can't you just include the .h file?,https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208994109,208994109,src/test/rpc_tests.cpp
MarcoFalke,2018-08-09T16:22:58Z,"If there are static methods that you need, remove the static in the cpp file and add the declaration here",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r208994244,208994244,src/test/rpc_tests.cpp
domob1812,2018-08-09T17:01:50Z,"With `emplace_back`, I think you should be able to get rid of `make_pair` - `std::pair` has a constructor with `first` and `second`, so that should be called then.",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r209006336,209006336,src/rpc/blockchain.cpp
marcinja,2018-08-09T17:25:57Z,"Yup, that works thanks. I had to move some of the other includes but I think that should be okay.",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r209013636,209013636,src/test/rpc_tests.cpp
marcinja,2018-08-09T18:41:31Z,"So use `std::pair<CAmount, int64_t>(feerate, weight)` instead? Is there a reason the constructor is preferred?",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r209038065,209038065,src/rpc/blockchain.cpp
MarcoFalke,2018-08-09T18:57:54Z,"Unless there is compelling reason to change the code, you should keep the it as is for now.",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r209043050,209043050,src/rpc/blockchain.cpp
domob1812,2018-08-10T06:09:50Z,"No, I meant to just use `freerate_array.emplace_back(feerate, weight)`.  I haven't tested it, but according to my understanding it should work - and just be simpler in the code.  Whether that is a compelling reason or not, I don't know.",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r209152953,209152953,src/rpc/blockchain.cpp
Empact,2018-08-11T00:48:02Z,"nit: you should leave these includes\n> Every .cpp and .h file should #include every header file it directly uses classes, functions or other definitions from, even if those headers are already included indirectly through other headers.\nhttps://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#source-code-organization",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r209411222,209411222,src/rpc/blockchain.cpp
marcinja,2018-08-11T19:01:14Z,Fixed.,https://github.com/bitcoin/bitcoin/pull/13918#discussion_r209434933,209434933,src/rpc/blockchain.cpp
kallewoof,2018-08-13T06:32:41Z,"Agree with @domob1812 that\n```C++\nfeerate_array.emplace_back(feerate, weight);\n```\nlooks cleaner (and yes, it works).",https://github.com/bitcoin/bitcoin/pull/13918#discussion_r209501966,209501966,src/rpc/blockchain.cpp
