[
  {
    "sha": "30abce7a998181e28e2f93256c159f259513e1a7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozMGFiY2U3YTk5ODE4MWUyOGUyZjkzMjU2YzE1OWYyNTk1MTNlMWE3",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2017-02-22T18:07:23Z"
      },
      "committer": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2017-03-01T10:16:24Z"
      },
      "message": "Improve ScanForWalletTransactions return value\n\nChange ScanForWalletTransactions return value so it is possible to distinguish\nscans that skip reading every block (due to the nTimeFirstKey optimization)\nfrom scans that fail while reading the chainActive.Tip() block. Return value is\nnow non-null in the non-failing case.\n\nThis change doesn't affect any user-visible behavior, it is only an internal\nAPI improvement. The only code currently using the ScanForWalletTransactions\nreturn value is in importmulti, and importmulti always calls\nScanForWalletTransactions with a pindex pointing to the first block in\nchainActive whose block time is >= (nLowestTimestamp - 7200), while\nScanForWalletTransactions would only return null without reading blocks when\npindex and every block after it had a block time < (nTimeFirstKey - 7200).\nThese conditions could never happen at the same time because nTimeFirstKey <=\nnLowestTimestamp.\n\nI'm planning to make a more substantial API improvement in the future (making\nScanForWalletTransactions private and exposing a higher level rescan method to\nRPC code), but Matt Corallo <git@bluematt.me> pointed out this odd behavior\nintroduced by e2e2f4c \"Return errors from importmulti if complete rescans are\nnot successful\" yesterday, so I'm following up now to get rid of badness\nintroduced by that merge.",
      "tree": {
        "sha": "78c86549354c7c2cea0f23618062a9f879766c0c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/78c86549354c7c2cea0f23618062a9f879766c0c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/30abce7a998181e28e2f93256c159f259513e1a7",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/30abce7a998181e28e2f93256c159f259513e1a7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/30abce7a998181e28e2f93256c159f259513e1a7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/30abce7a998181e28e2f93256c159f259513e1a7/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "3fabae742567ecc060618c23d5fc01518fe96e60",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3fabae742567ecc060618c23d5fc01518fe96e60",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/3fabae742567ecc060618c23d5fc01518fe96e60"
      }
    ],
    "stats": {
      "total": 18,
      "additions": 15,
      "deletions": 3
    },
    "files": [
      {
        "sha": "c521be8b35c7666dcf5310dea55ab02610ab8d36",
        "filename": "src/wallet/test/wallet_tests.cpp",
        "status": "modified",
        "additions": 11,
        "deletions": 0,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/30abce7a998181e28e2f93256c159f259513e1a7/src/wallet/test/wallet_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/30abce7a998181e28e2f93256c159f259513e1a7/src/wallet/test/wallet_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/test/wallet_tests.cpp?ref=30abce7a998181e28e2f93256c159f259513e1a7",
        "patch": "@@ -426,6 +426,17 @@ BOOST_FIXTURE_TEST_CASE(rescan, TestChain100Setup)\n         BOOST_CHECK_EQUAL(response.write(), strprintf(\"[{\\\"success\\\":false,\\\"error\\\":{\\\"code\\\":-1,\\\"message\\\":\\\"Failed to rescan before time %d, transactions may be missing.\\\"}},{\\\"success\\\":true}]\", newTip->GetBlockTimeMax()));\n         ::pwalletMain = backup;\n     }\n+\n+    // Verify ScanForWalletTransactions does not return null when the scan is\n+    // elided due to the nTimeFirstKey optimization.\n+    {\n+        CWallet wallet;\n+        {\n+            LOCK(wallet.cs_wallet);\n+            wallet.UpdateTimeFirstKey(newTip->GetBlockTime() + 7200 + 1);\n+        }\n+        BOOST_CHECK_EQUAL(newTip, wallet.ScanForWalletTransactions(newTip));\n+    }\n }\n \n BOOST_AUTO_TEST_SUITE_END()"
      },
      {
        "sha": "13de9ca8e17debdcd9bdacb6f818ce8c2e032188",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 3,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/30abce7a998181e28e2f93256c159f259513e1a7/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/30abce7a998181e28e2f93256c159f259513e1a7/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=30abce7a998181e28e2f93256c159f259513e1a7",
        "patch": "@@ -1547,16 +1547,17 @@ void CWalletTx::GetAccountAmounts(const string& strAccount, CAmount& nReceived,\n  * exist in the wallet will be updated.\n  *\n  * Returns pointer to the first block in the last contiguous range that was\n- * successfully scanned.\n- *\n+ * successfully scanned or elided (elided if pIndexStart points at a block\n+ * before CWallet::nTimeFirstKey). Returns null if there is no such range, or\n+ * the range doesn't include chainActive.Tip().\n  */\n CBlockIndex* CWallet::ScanForWalletTransactions(CBlockIndex* pindexStart, bool fUpdate)\n {\n-    CBlockIndex* ret = nullptr;\n     int64_t nNow = GetTime();\n     const CChainParams& chainParams = Params();\n \n     CBlockIndex* pindex = pindexStart;\n+    CBlockIndex* ret = pindexStart;\n     {\n         LOCK2(cs_main, cs_wallet);\n "
      }
    ]
  }
]