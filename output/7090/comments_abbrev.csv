laanwj,2015-11-24T14:54:46Z,"Concept ACK, but I'm not sure setting onion proxy to 127.0.0.1:9051 by default is a good idea. \nEven if no tor is present it will try and try and keep trying to connect to onions.\n\nMaybe a better approach would be to have torcontrol set -onion proxy automatically, when it manages to negotiate with tor?\n(possibly it could even ask tor what its port it)\n",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159292023,159292023,
petertodd,2015-11-24T14:59:20Z,"So, the disadvantage with that idea is support for the HS control thing is actually pretty recent, while connecting to 127.0.0.1:9050 works with any Tor version. OTOH, come to think of it there's a valid argument that we want the # of nodes connecting to HS's to grow in line with the number of nodes making them available.\n",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159293195,159293195,
laanwj,2015-11-24T15:09:56Z,In principle the tor control port authentication/communication works with older versions. It's just the HS creation itself that is recent. If the control connection is also used for other things it could tolerate that failing.\n,https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159296547,159296547,
petertodd,2015-11-24T15:30:24Z,"@laanwj How about this?\n\nI looked into getting the proxy info automatically; doesn't look to be trivial as you have to use the GETCONF command on the control port to read the config file values yourself, and what they actually mean for you is non-trivial. I'm inclined to just use the hardcoded default - pretty rare for that to be setup differently.\n",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159304963,159304963,
petertodd,2015-11-24T15:33:14Z,"(and yeah, the duplication of code is kinda ugly; open to suggestions)\n",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159305729,159305729,
laanwj,2015-11-24T16:27:28Z,"Agree that this may be the best thing to do for now. This sets `-onion` when tor is there, unless an explicit `-onion` proxy was given, or it was explicitly disabled using `-onion=0`.\n\n(and you are right, actually getting a proxy port from Tor given just the control port seems to be non-trivial! I thought it was just me)\n\nMaybe also disable the NET_TOR proxy in `disconnected_cb`, _if_ it was e",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159323044,159323044,
gmaxwell,2015-11-24T22:24:41Z,Concept ACK.  We should do something like this; otherwise we could get a strange result where listening gets commonly setup but we can't connect out to it!\n,https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159425603,159425603,
TheBlueMatt,2015-11-24T22:36:31Z,"Concept ACK\n\nOn November 24, 2015 2:24:50 PM PST, Gregory Maxwell notifications@github.com wrote:\n\n> Concept ACK.  We should do something like this; otherwise we could get\n> a strange result where listening gets commonly setup but we can't\n> connect out to it!\n> \n> ---\n> \n> Reply to this email directly or view it on GitHub:\n> https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159428176,159428176,
laanwj,2015-11-25T08:49:24Z,"~~@petertodd Not saying it has to be done in this pull, but requesting the proxy port(s) seems easy enough, after experimenting a bit:~~\n\n```\n$ nc 127.0.0.1 9051\nAUTHENTICATE <hexify(control_auth_cookie)>\n250 OK\nGETCONF SocksPort\n250 SocksPort=9050\n```\n\n(see posts below for better option)\n",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159536994,159536994,
petertodd,2015-11-25T17:52:50Z,"@laanwj The problem is SocksPort can be in many different formats depending on the local configuration, not to mention multiple lines of SocksPort's. \n\nRe: disconnected_cb, I'm inclined to just leave the behavior the same as what -onion would do anyway for simplicity.\n\nRemoved the first two reverted commits; ready for merging.\n",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159686928,159686928,
gmaxwell,2015-11-26T00:47:40Z,utACK.\n,https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159768264,159768264,
laanwj,2015-11-26T08:04:26Z,"@petertodd OK, yeah, the option itself is reasonable complicated\n\n```\nSOCKSPort [address:]port|unix:path|auto [flags] [isolation flags]\n```\n\nIt even has **Set it to ""auto"" to have Tor pick a port for you**. This makes querying this option a no-go. I wonder what the way is to find out what the port is in that case.\nHm https://trac.torproject.org/projects/tor/ticket/3076\nApparently the offic",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159841772,159841772,
laanwj,2015-11-26T10:11:45Z,"Tested ACK. `getnetworkinfo` when starting bitcoind with Tor running:\n\n```\n    {\n      ""name"": ""onion"",\n      ""limited"": false,\n      ""reachable"": true,\n      ""proxy"": ""127.0.0.1:9050"",\n      ""proxy_randomize_credentials"": true\n    }\n```\n\nStarting it without Tor running:\n\n```\n    {\n      ""name"": ""onion"",\n      ""limited"": false,\n      ""reachable"": false,\n      ""proxy"": """",\n     ",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159867258,159867258,
petertodd,2015-11-26T10:16:09Z,@isislovecruft See above - can you confirm that this GETINFO thing what we're supposed to be doing?\n,https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159868080,159868080,
sipa,2015-11-26T20:51:22Z,Concept ACK\n,https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-159992839,159992839,
leif,2015-11-28T11:34:08Z,"Two thoughts:\n1. Many (most?) desktop users will have tor installed via Tor Browser Bundle, which has its SOCKS listener on port 9150 rather than 9050 (which the ""system tor"", eg tor installed via apt-get, does). Some applications that want to use Tor will automatically try both ports, for instance: https://github.com/agl/pond/blob/master/client/client.go#L686\n2. Using Tor opportunistically by d",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-160280388,160280388,
sipa,2015-11-28T11:37:28Z,"To be clear: this will not by default route all Bitcoin traffic over Tor.\nIt will only enable connecting to hidden services (nodes listening on a\nport ""on"" the tor network, so to speak).\n",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-160281585,160281585,
paveljanik,2015-11-28T11:49:43Z,"BTW, how do we know that the app listening on the port is tor?\n",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-160284403,160284403,
leif,2015-11-28T14:21:43Z,"Thanks @sipa, i missed that.\n\nI suppose there are actually four possible tor configurations:\n1. No Tor\n2. Tor for Hidden Service connections, but make regular connections without Tor\n3. Make all connections via Tor\n4. Only connect to Hidden Services\n\nHopefully (4) can be the default in a future release after there are enough onion nodes running!\n\nFor nodes advertising both a hidden servi",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-160302792,160302792,
paveljanik,2015-11-28T15:25:26Z,"Well, it could be some other application run by other user of the same system. Of course the user is not supposed to be doing anything important on such system, but anyway...\n",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-160310290,160310290,
MarcoFalke,2015-11-28T15:39:07Z,@petertodd I assume this does not work when the user defines no password nor cookie?\n,https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-160312206,160312206,
tailsjoin,2015-11-29T03:10:01Z,"To avoid the behaviour of this merge one must set something for `onion`, correct? \n\nCurrently I have nothing set for `onion`, but I am running a hidden service for listening. Will this effect my setup? I have `127.0.0.1:905x` ports setup for tor, **but they're not the ports I use for bitcoin. I have special, isolated ports set up (not locally) for bitcoin and my hidden service.** Is this going t",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-160362737,160362737,
laanwj,2015-11-30T12:35:43Z,"> To avoid the behaviour of this merge one must set something for onion, correct?\n\n`listenonion=0` to disable any automatic tor behavior\n",https://github.com/bitcoin/bitcoin/pull/7090#issuecomment-160617549,160617549,
laanwj,2015-11-26T10:07:33Z,"Nit: Probably, proxyRandomize should be always true if we know this is Tor. The option exists because people may want to disable it for non-tor SOCKS5 proxies, there's not really a reason to disable it for Tor.\n",https://github.com/bitcoin/bitcoin/pull/7090#discussion_r45961689,45961689,src/torcontrol.cpp
petertodd,2015-11-26T10:15:04Z,Fixed.\n,https://github.com/bitcoin/bitcoin/pull/7090#discussion_r45962367,45962367,src/torcontrol.cpp
