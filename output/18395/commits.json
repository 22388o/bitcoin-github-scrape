[
  {
    "sha": "1a0993ae354c36d6f219e67f82ca8236530d6201",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxYTA5OTNhZTM1NGMzNmQ2ZjIxOWU2N2Y4MmNhODIzNjUzMGQ2MjAx",
    "commit": {
      "author": {
        "name": "fanquake",
        "email": "fanquake@gmail.com",
        "date": "2020-03-21T06:23:02Z"
      },
      "committer": {
        "name": "fanquake",
        "email": "fanquake@gmail.com",
        "date": "2020-03-22T02:47:38Z"
      },
      "message": "scripts: add PE dylib checking to symbol-check.py",
      "tree": {
        "sha": "c3463a77051878457fcb7e7f3c38532683c070ef",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c3463a77051878457fcb7e7f3c38532683c070ef"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1a0993ae354c36d6f219e67f82ca8236530d6201",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEz7FuIclQ9n+pXlWPLuufXMCVJsEFAl520coACgkQLuufXMCV\nJsF23w/+L1TXS+VjP2hM6ye+UCfIAnhZgg2z16NmG41W9GeavrSZJY5HgluupT21\nszlhqJbY3JD5OxDE4AMKbOx3A5Rdv2Qc3owwVbo5rF+O6lEuTzJoyjiVrt4p0BPY\n7mJKnaWqS8dVD1YKo5GOtrGzEB/vW39lVsL0EkskJZDKV2ccKNlDF+6MlpafwgLF\nJyzfKZSChV7I+JIVphGJrwr3YTO2cBZ29cMKydcWMv2stna47AB1AAQj+9WuacWZ\n1AO1ORgNVIWv4abUt92rS3U+8w0QzpqOQkzM6IuqUV+8aCp613lRD0rXONdVM/co\nhcq/O027rOXtyrL7/dxoQH7aPSRHnRNCXgmFt1MCKaCq7vMveIU50+Qrl8H+iFwu\nfb5ekhSUZHQg7NMuH1VjZ5UFYU1BMeRzLV+8iLMHiroRqtZYi4dCV/p38WCO1yqL\neM/v3n9cBp+IIcvMNK0MYncNF2biI166nIvoFbpKpZH/zohSEmbFI74e2bGFOSkY\nJqa5kJHIgS5T9El4SBGgliLOTv/z9yj0wjzDmt12jX9yNDpDhmm8zd0ogQCTKO1T\nv6bwa8KUjnyITq3v1TTBNccGgDGmwR6nqNBy0tP8F6KdzmU2aFJR6VP2k/9C6QAd\n28QP9jv5qBc4oxnA8dr1LZ449WxVopNaPTnUZtacXaoAoj3Tzn0=\n=jwcS\n-----END PGP SIGNATURE-----",
        "payload": "tree c3463a77051878457fcb7e7f3c38532683c070ef\nparent 5504703a9f8388dff66d33bd077bcc4c82dff6c8\nauthor fanquake <fanquake@gmail.com> 1584771782 +0800\ncommitter fanquake <fanquake@gmail.com> 1584845258 +0800\n\nscripts: add PE dylib checking to symbol-check.py\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1a0993ae354c36d6f219e67f82ca8236530d6201",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1a0993ae354c36d6f219e67f82ca8236530d6201",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1a0993ae354c36d6f219e67f82ca8236530d6201/comments",
    "author": {
      "login": "fanquake",
      "id": 863730,
      "node_id": "MDQ6VXNlcjg2MzczMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fanquake",
      "html_url": "https://github.com/fanquake",
      "followers_url": "https://api.github.com/users/fanquake/followers",
      "following_url": "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url": "https://api.github.com/users/fanquake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
      "organizations_url": "https://api.github.com/users/fanquake/orgs",
      "repos_url": "https://api.github.com/users/fanquake/repos",
      "events_url": "https://api.github.com/users/fanquake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fanquake/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "fanquake",
      "id": 863730,
      "node_id": "MDQ6VXNlcjg2MzczMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fanquake",
      "html_url": "https://github.com/fanquake",
      "followers_url": "https://api.github.com/users/fanquake/followers",
      "following_url": "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url": "https://api.github.com/users/fanquake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
      "organizations_url": "https://api.github.com/users/fanquake/orgs",
      "repos_url": "https://api.github.com/users/fanquake/repos",
      "events_url": "https://api.github.com/users/fanquake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fanquake/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "5504703a9f8388dff66d33bd077bcc4c82dff6c8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5504703a9f8388dff66d33bd077bcc4c82dff6c8",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/5504703a9f8388dff66d33bd077bcc4c82dff6c8"
      }
    ],
    "stats": {
      "total": 57,
      "additions": 53,
      "deletions": 4
    },
    "files": [
      {
        "sha": "f5533719c0041cd264e0198fc07c48267f8f315a",
        "filename": "contrib/devtools/README.md",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1a0993ae354c36d6f219e67f82ca8236530d6201/contrib/devtools/README.md",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1a0993ae354c36d6f219e67f82ca8236530d6201/contrib/devtools/README.md",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/contrib/devtools/README.md?ref=1a0993ae354c36d6f219e67f82ca8236530d6201",
        "patch": "@@ -109,7 +109,7 @@ certain symbols and are only linked against allowed libraries.\n For Linux this means checking for allowed gcc, glibc and libstdc++ version symbols.\n This makes sure they are still compatible with the minimum supported distribution versions.\n \n-For macOS we check that the executables are only linked against libraries we allow.\n+For macOS and Windows we check that the executables are only linked against libraries we allow.\n \n Example usage after a gitian build:\n "
      },
      {
        "sha": "6949cb7ced89eda0be2b24dc4de9123ae7403fb1",
        "filename": "contrib/devtools/symbol-check.py",
        "status": "modified",
        "additions": 46,
        "deletions": 3,
        "changes": 49,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1a0993ae354c36d6f219e67f82ca8236530d6201/contrib/devtools/symbol-check.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1a0993ae354c36d6f219e67f82ca8236530d6201/contrib/devtools/symbol-check.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/contrib/devtools/symbol-check.py?ref=1a0993ae354c36d6f219e67f82ca8236530d6201",
        "patch": "@@ -3,9 +3,8 @@\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n '''\n-A script to check that the (Linux) executables produced by gitian only contain\n-allowed gcc and glibc version symbols. This makes sure they are still compatible\n-with the minimum supported Linux distribution versions.\n+A script to check that the executables produced by gitian only contain\n+certain symbols and are only linked against allowed libraries.\n \n Example usage:\n \n@@ -53,6 +52,7 @@\n }\n READELF_CMD = os.getenv('READELF', '/usr/bin/readelf')\n CPPFILT_CMD = os.getenv('CPPFILT', '/usr/bin/c++filt')\n+OBJDUMP_CMD = os.getenv('OBJDUMP', '/usr/bin/objdump')\n OTOOL_CMD = os.getenv('OTOOL', '/usr/bin/otool')\n \n # Allowed NEEDED libraries\n@@ -101,6 +101,26 @@\n 'libobjc.A.dylib', # Objective-C runtime library\n }\n \n+PE_ALLOWED_LIBRARIES = {\n+'ADVAPI32.dll', # security & registry\n+'IPHLPAPI.DLL', # IP helper API\n+'KERNEL32.dll', # win32 base APIs\n+'msvcrt.dll', # C standard library for MSVC\n+'SHELL32.dll', # shell API\n+'USER32.dll', # user interface\n+'WS2_32.dll', # sockets\n+# bitcoin-qt only\n+'dwmapi.dll', # desktop window manager\n+'GDI32.dll', # graphics device interface\n+'IMM32.dll', # input method editor\n+'ole32.dll', # component object model\n+'OLEAUT32.dll', # OLE Automation API\n+'SHLWAPI.dll', # light weight shell API\n+'UxTheme.dll',\n+'VERSION.dll', # version checking\n+'WINMM.dll', # WinMM audio API\n+}\n+\n class CPPFilt(object):\n     '''\n     Demangle C++ symbol names.\n@@ -218,6 +238,26 @@ def check_MACHO_libraries(filename) -> bool:\n             ok = False\n     return ok\n \n+def pe_read_libraries(filename) -> List[str]:\n+    p = subprocess.Popen([OBJDUMP_CMD, '-x', filename], stdout=subprocess.PIPE, stderr=subprocess.PIPE, stdin=subprocess.PIPE, universal_newlines=True)\n+    (stdout, stderr) = p.communicate()\n+    if p.returncode:\n+        raise IOError('Error opening file')\n+    libraries = []\n+    for line in stdout.splitlines():\n+        if 'DLL Name:' in line:\n+            tokens = line.split(': ')\n+            libraries.append(tokens[1])\n+    return libraries\n+\n+def check_PE_libraries(filename) -> bool:\n+    ok = True\n+    for dylib in pe_read_libraries(filename):\n+        if dylib not in PE_ALLOWED_LIBRARIES:\n+            print('{} is not in ALLOWED_LIBRARIES!'.format(dylib))\n+            ok = False\n+    return ok\n+\n CHECKS = {\n 'ELF': [\n     ('IMPORTED_SYMBOLS', check_imported_symbols),\n@@ -226,6 +266,9 @@ def check_MACHO_libraries(filename) -> bool:\n ],\n 'MACHO': [\n     ('DYNAMIC_LIBRARIES', check_MACHO_libraries)\n+],\n+'PE' : [\n+    ('DYNAMIC_LIBRARIES', check_PE_libraries)\n ]\n }\n "
      },
      {
        "sha": "952e5ba596df52ce0cec52f583f95ee9fe92993b",
        "filename": "contrib/gitian-descriptors/gitian-win.yml",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1a0993ae354c36d6f219e67f82ca8236530d6201/contrib/gitian-descriptors/gitian-win.yml",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1a0993ae354c36d6f219e67f82ca8236530d6201/contrib/gitian-descriptors/gitian-win.yml",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/contrib/gitian-descriptors/gitian-win.yml?ref=1a0993ae354c36d6f219e67f82ca8236530d6201",
        "patch": "@@ -145,6 +145,7 @@ script: |\n     CONFIG_SITE=${BASEPREFIX}/${i}/share/config.site ./configure --prefix=/ --disable-ccache --disable-maintainer-mode --disable-dependency-tracking ${CONFIGFLAGS} CFLAGS=\"${HOST_CFLAGS}\" CXXFLAGS=\"${HOST_CXXFLAGS}\"\n     make ${MAKEOPTS}\n     make ${MAKEOPTS} -C src check-security\n+    make ${MAKEOPTS} -C src check-symbols\n     make deploy\n     make install DESTDIR=${INSTALLPATH}\n     cp -f --target-directory=\"${OUTDIR}\" ./bitcoin-*-setup-unsigned.exe"
      },
      {
        "sha": "8c927f330b8496b858431d5ef094700bbe821e0f",
        "filename": "src/Makefile.am",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1a0993ae354c36d6f219e67f82ca8236530d6201/src/Makefile.am",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1a0993ae354c36d6f219e67f82ca8236530d6201/src/Makefile.am",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/Makefile.am?ref=1a0993ae354c36d6f219e67f82ca8236530d6201",
        "patch": "@@ -703,6 +703,11 @@ if TARGET_DARWIN\n \t$(AM_V_at) OTOOL=$(OTOOL) $(PYTHON) $(top_srcdir)/contrib/devtools/symbol-check.py $(bin_PROGRAMS)\n endif\n \n+if TARGET_WINDOWS\n+\t@echo \"Checking Windows dynamic libraries...\"\n+\t$(AM_V_at) OBJDUMP=$(OBJDUMP) $(PYTHON) $(top_srcdir)/contrib/devtools/symbol-check.py $(bin_PROGRAMS)\n+endif\n+\n if GLIBC_BACK_COMPAT\n \t@echo \"Checking glibc back compat...\"\n \t$(AM_V_at) READELF=$(READELF) CPPFILT=$(CPPFILT) $(PYTHON) $(top_srcdir)/contrib/devtools/symbol-check.py $(bin_PROGRAMS)"
      }
    ]
  }
]