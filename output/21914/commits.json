[
  {
    "sha": "105941b726c078642e785ecb7b6834ba814381b0",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxMDU5NDFiNzI2YzA3ODY0MmU3ODVlY2I3YjY4MzRiYTgxNDM4MWIw",
    "commit": {
      "author": {
        "name": "Vasil Dimov",
        "email": "vd@FreeBSD.org",
        "date": "2021-05-11T10:44:46Z"
      },
      "committer": {
        "name": "Vasil Dimov",
        "email": "vd@FreeBSD.org",
        "date": "2021-05-11T10:46:45Z"
      },
      "message": "net: use stronger AddLocal() for our I2P address\n\nThere are two issues:\n\n1. Our I2P address not added to local addresses.\n\n* `externalip=` is used with an IPv4 address (this sets automatically\n  `discover=0`)\n* No `discover=1` is used\n* `i2psam=` is used\n* No `externalip=` is used for our I2P address\n* `listenonion=1 torcontrol=` are used\n\nIn this case `AddLocal(LOCAL_MANUAL)` is used for our `.onion` address\nand `AddLocal(LOCAL_BIND)` for our `.b32.i2p` address, the latter being\nignored due to `discover=0`.\n\n2. Our I2P address removed from local addresses even if specified\nwith `externalip=` on I2P proxy restart.\n\n* `externalip=` is used with our I2P address (this sets automatically\n  `discover=0`)\n* No `discover=1` is used\n* `i2psam=` is used\n\nIn this case, initially `externalip=` causes our I2P address to be added\nwith `AddLocal(LOCAL_MANUAL)` which overrides `discover=0` and works as\nexpected. However, if later the I2P proxy is shut down we do\n`RemoveLocal()` in order to stop advertising our I2P address (since we\nhave lost I2P connectivity). When the I2P proxy is started and we\nreconnect to it, restoring the I2P connectivity, we do\n`AddLocal(LOCAL_BIND)` which does nothing due to `discover=0`.\n\nTo resolve those two issues, use `AddLocal(LOCAL_MANUAL)` for I2P which\nis also what we do with Tor.",
      "tree": {
        "sha": "0e45858787e2eb33d419aee4381bf3cfe4d3c8f6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0e45858787e2eb33d419aee4381bf3cfe4d3c8f6"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/105941b726c078642e785ecb7b6834ba814381b0",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQQzBAABCAAdFiEE5k2NRWFNsHVF2czBVN8G9ktVy78FAmCaYKQACgkQVN8G9ktV\ny7/LMR//d6Z12c5ypGhXv/VxybNoiJOzEI6w/EcClS5jy+FFrcqQwiCSgqBHKXhP\nzh0xuq9l0roj2gDY7F0NrP4C06582QCOD+lfVvsCRHLah2wpPZlsdlLuAoZRPk7d\nDWnPKT0k0UrcTJt0OAFLsBDvdiIDiEX2+cKJ/RX8Uanq0GjoRSfRSicWgLie8mJw\n3WcW0kXh82SLjrn7CFSnNPs+JTXv19VJvWRumcaWkm/Y+Tw17yz+AnfjOkMhfxC6\nj2tuv0UaTCQXc2CunG1uUsf+iC4Jy/t01zE/vkDVHpE9NDIsn45xLgPIg2jZtvkV\nlXwkaBPEYTVP6BmiUheUTCA+rJGD4inqf4lE6NJSiwtRlqUcqQBMEBietfYuUxJ3\n5DD/9YaLmQvLzj9TBB5pbHco1uACKo8WNPXML/wGptLeN4gEfCPKPMkEOrC1myRC\n+AS4BfAgvAT/L6N1G2eo5nLLj3kqdz/RjlPovc0SoIuEq2aIjEnb/+Q8jzDnIiaL\nI5+QbnSeDfew/mg7SRW+lhAcw4Esn106eL9pTqzTRSojqoK3UiqC5dmOB4tJjS+u\n1Vp9zWTwHYerT9F9Czxf/mo/+qkxfO5uvpXMWyksI7kJZXcDYlfY3jEEzmyXAXrM\nUuxVaSVHUMr8/UXUNZNuiPgq7G11/JvJ6dDzTDwLNPTNWNXe0m0hyUu2p5jUzLHM\nDwYelNIvsCajklsqURAfJnfE9HEilDrl1wwSPeQVRBUdsGM4WVp/K4xZd9WXQNRz\nrP89jGCU/RIKeljc2tBbZ3lp9hZKnNTMcPm/uYt6lbAtna4NbDJfgIYaYnTjn2S4\nRI+jws7qpxcNUihWV4Vw64XvpmhxVHZUoq0lHj9npyWhLO5hOKzmUsBVmvnuQu7x\nLCjqtyOl/2RbVWxghFySkAdK+Tl8N5IKXi1XrtSpyu1rpCKn4DD9qBin+WLsX2iE\nrxlI4Bw+HpzJAInCddU46tWvwwvJV/kZrJnIkqIjBnXgLZsr8ZdkgHYLdrJpKERp\nYCMjfYh8JMviYKGYsCk/gbBg2ikjFLEbEYX/6iKQnBwgohMRl6cMX8nbSMjo3eYd\nj4C1L9y7y5majLh4Kw/jYh48jHNwdmDVK6sVll2EVkchkNnCBDIu9zLl0oBiy6+B\ndGD6i8a/J0BMtplghhTuFKOQ5hDBwbUxsqR7YWaKen3nn3BBTXaN3fpd0Yu+CCzd\nsakEAjB2lpwjwqpUGO4b/N+jwER1EYAcPWfhg0I9UU4HmUfoKFd2lBIGuHXXKnhQ\nTDUuEbXx14au4EkLkekSKIlvcl6PUpVBTe85dU3g9CLS4LZU7qaWbiLayLTXlc5D\nTPWeYQwDeSiYwPfd5qSNzoVBqdK/6g==\n=BMDP\n-----END PGP SIGNATURE-----",
        "payload": "tree 0e45858787e2eb33d419aee4381bf3cfe4d3c8f6\nparent 39e306009b7444a86eaa963326972f9d0896525e\nauthor Vasil Dimov <vd@FreeBSD.org> 1620729886 +0200\ncommitter Vasil Dimov <vd@FreeBSD.org> 1620730005 +0200\n\nnet: use stronger AddLocal() for our I2P address\n\nThere are two issues:\n\n1. Our I2P address not added to local addresses.\n\n* `externalip=` is used with an IPv4 address (this sets automatically\n  `discover=0`)\n* No `discover=1` is used\n* `i2psam=` is used\n* No `externalip=` is used for our I2P address\n* `listenonion=1 torcontrol=` are used\n\nIn this case `AddLocal(LOCAL_MANUAL)` is used for our `.onion` address\nand `AddLocal(LOCAL_BIND)` for our `.b32.i2p` address, the latter being\nignored due to `discover=0`.\n\n2. Our I2P address removed from local addresses even if specified\nwith `externalip=` on I2P proxy restart.\n\n* `externalip=` is used with our I2P address (this sets automatically\n  `discover=0`)\n* No `discover=1` is used\n* `i2psam=` is used\n\nIn this case, initially `externalip=` causes our I2P address to be added\nwith `AddLocal(LOCAL_MANUAL)` which overrides `discover=0` and works as\nexpected. However, if later the I2P proxy is shut down we do\n`RemoveLocal()` in order to stop advertising our I2P address (since we\nhave lost I2P connectivity). When the I2P proxy is started and we\nreconnect to it, restoring the I2P connectivity, we do\n`AddLocal(LOCAL_BIND)` which does nothing due to `discover=0`.\n\nTo resolve those two issues, use `AddLocal(LOCAL_MANUAL)` for I2P which\nis also what we do with Tor.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/105941b726c078642e785ecb7b6834ba814381b0",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/105941b726c078642e785ecb7b6834ba814381b0",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/105941b726c078642e785ecb7b6834ba814381b0/comments",
    "author": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "39e306009b7444a86eaa963326972f9d0896525e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/39e306009b7444a86eaa963326972f9d0896525e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/39e306009b7444a86eaa963326972f9d0896525e"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 1,
      "deletions": 1
    },
    "files": [
      {
        "sha": "56936e2c719cc13a0f035c119ac0d97b5bf2dac9",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/105941b726c078642e785ecb7b6834ba814381b0/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/105941b726c078642e785ecb7b6834ba814381b0/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=105941b726c078642e785ecb7b6834ba814381b0",
        "patch": "@@ -2244,7 +2244,7 @@ void CConnman::ThreadI2PAcceptIncoming()\n         }\n \n         if (!advertising_listen_addr) {\n-            AddLocal(conn.me, LOCAL_BIND);\n+            AddLocal(conn.me, LOCAL_MANUAL);\n             advertising_listen_addr = true;\n         }\n "
      }
    ]
  }
]