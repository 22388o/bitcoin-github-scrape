laanwj,2012-09-02T06:51:53Z,"Maybe we should not call select at all when there is no work to do? (ie, hSocketMax == 0). Or am I overlooking something?\n\nEdit: I think I am. Select without fds should effectively be a sleep() of the specified duration. So why is it returning errors at all?\n",https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8219507,8219507,
Diapolo,2012-09-02T09:50:08Z,"select returns 10022, when the 3 fds parameters are 0, which is the case when we have no net or a faulty proxy was supplied.\n",https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8220433,8220433,
laanwj,2012-09-02T10:24:46Z,"But does it still pause for the ""timeout"" duration in that case? Or is it a busy loop, erroring out immediately and causing 100% CPU usage?\n",https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8220639,8220639,
Diapolo,2012-09-02T11:04:34Z,"`int nSelect = select(hSocketMax + 1, &fdsetRecv, &fdsetSend, &fdsetError, &timeout);`\n\nThe timeout parameter defines the maximum time for `select()` to wait, but when we have a failed net all fdsetX variables have their .fd_count set to 0 and so I assume select fails imediately.\n\nBut we have a timeout some lines below `Sleep(timeout.tv_usec/1000);`, which prevents a 100% CPU usage IMO.\n\nEdi",https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8220879,8220879,
Diapolo,2012-09-02T11:19:46Z,Perhaps @sipa can comment here and ACK or suggest a better solution?\n,https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8220967,8220967,
laanwj,2012-09-02T11:30:08Z,"Ok, the timeout is already OK. Hadn't seen that.\n",https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8221027,8221027,
Diapolo,2012-09-04T16:06:11Z,@gmaxwell @sipa and others...\nCan another core dev please take a look and ACK this one? As a fix I would like to see it in the next RC.\n,https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8268668,8268668,
jgarzik,2012-09-05T03:04:15Z,"hSocketMax+1 is not valid, when zero FDs are in the fd set.\nhSocketMax+1 is valid when fds are set.\n\nWe should not be passing ""nfds == 1"" to select, when that is clearly not the case.  That is the bug that must be fixed here.\n\nWe always pass a timeout, therefore select always has ""work"" even if zero fds are indicated.\n",https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8286351,8286351,
jgarzik,2012-09-05T03:30:51Z,Can you test and verify that #1786 addresses your problem (or at least changes the behavior a bit)?\n,https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8286681,8286681,
BitcoinPullTester,2012-09-05T12:01:38Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/8207857f401bc1a48f863be646c5a508a7cdfe9c for binaries and test log.\n",https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8295696,8295696,
Diapolo,2012-09-05T20:14:17Z,Closing in favor of #1786!\n,https://github.com/bitcoin/bitcoin/pull/1772#issuecomment-8312313,8312313,
laanwj,2012-09-04T17:26:59Z,"BTW this <= here is interesting.\n\nhSocketMax is the _maximum_ socket number. Which means that, if it is 0 (which it is initialized with), we still pass 1 into select (which  has a parameter ""maximum fd+1"", not ""maximum fd""). \n\nSo what happens if there is nothing to do? hSocketMax will be 0, however 1 will be passed into select, even though no fds have been set with FD_SET.\n\nHmm the code is f",https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1525240,1525240,src/net.cpp
Diapolo,2012-09-04T19:44:10Z,"At least on Windows, the first parameter of select is ignored `nfds [in] Ignored. The nfds parameter is included only for compatibility with Berkeley sockets.`, which should be no cause for an error then.\n\nSo hSocketMax is 0, when hListenSocket is 0 or all pnode->hSocket are 0. This results in all fdset vars to contain .fd_count == 0, which results in the select() 10022 error code (`The time-out",https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1526844,1526844,src/net.cpp
laanwj,2012-09-04T19:51:53Z,"The point is that we currently cannot distinguish between _no fds_ and _a single fd, 0_. Which is wrong. If you make hSocketMax to be max(hSocket+1) this is easy to detect, as the value will be 0 for no fds and 1 for the single fd 0 case. And as a plus, we then pass the correct nfds on UNIX in both cases.\n\n(also, if you do that, you could decide to skip the select when hSocketMax==0. You cannot ",https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1526899,1526899,src/net.cpp
Diapolo,2012-09-04T20:14:15Z,"I'm thinking for minutes now, but have no clue, where you would like to place max(hSocket + 1) or do you mean max(hSocketMax, hSocket + 1)? And even then it makes no sense yet...\n",https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527124,1527124,src/net.cpp
laanwj,2012-09-04T20:21:28Z,"Yes,\n\n```\nhSocketMax = max(hSocketMax, hListenSocket + 1);\n...\nhSocketMax = max(hSocketMax, pnode->hSocket + 1);\n```\n\nThen change the select line to (ie, remove the + 1)\n\n```\n    int nSelect = select(hSocketMax, &fdsetRecv, &fdsetSend, &fdsetError, &timeout);\n```\n\nAnd change this loop to < i.s.o <=:\n\n```\n            for (unsigned int i = 0; i < hSocketMax; i++)\n                FD",https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527218,1527218,src/net.cpp
Diapolo,2012-09-04T20:50:37Z,"I found out that setting an invalid -proxy leads to not even entering the BOOST_FOREACH loops, as vhListenSocket and vNodes are empty. That means hSocketMax simply keeps the init value of 0, which leads to 10022 spam.\n\nI also did some research for the first select()-parameter and found this:\n\n<pre>The first parameter to select() is the maximum file descriptor that is set in the structs PLUS ON",https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527632,1527632,src/net.cpp
laanwj,2012-09-04T20:55:59Z,"Yes, that's what I am trying to say all the time. The +1 is valid, however\nit is better to do it at different places, so you can distinguish between\nthe two conditions that I mentioned. Currently you _can not_ reliably\ndetect the condition that causes the error.\n",https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527717,1527717,src/net.cpp
Diapolo,2012-09-04T21:23:01Z,"When I now read the first comment all that makes sense ^^ you are such a patient person :-P.\n\nWith your new code we would pass hSocketMax == 0 to select(), when -proxy is invalid (no BOOST_FOREACH pass), I'm not sure if this is valid. But you are right, when hSocketMax stays 0, we have no fds set, but I'm not sure if it can ever become 1. It would be 1, if vhListenSocket or vNodes is not empty a",https://github.com/bitcoin/bitcoin/pull/1772#discussion_r1527978,1527978,src/net.cpp
