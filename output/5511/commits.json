[
  {
    "sha": "e9c3215b776b07faeb5184249fc0e43876f26723",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplOWMzMjE1Yjc3NmIwN2ZhZWI1MTg0MjQ5ZmMwZTQzODc2ZjI2NzIz",
    "commit": {
      "author": {
        "name": "dexX7",
        "email": "ugithub@bitwatch.co",
        "date": "2014-12-19T05:59:16Z"
      },
      "committer": {
        "name": "dexX7",
        "email": "dexx@bitwatch.co",
        "date": "2015-03-21T12:03:23Z"
      },
      "message": "[Wallet] sort pending wallet transactions before reaccepting\n\nDuring startup, when adding pending wallet transactions, which spend outputs of\nother pending wallet transactions, back to the memory pool, and when they are\nadded out of order, it appears as if they are orphans with missing inputs.\n\nThose transactions are then rejected and flagged as \"conflicting\" (= not in the\nmemory pool, not in the block chain).\n\nTo prevent this, transactions are explicitly sorted.",
      "tree": {
        "sha": "65d5b22750d3eef2d405134e6a7d5ce1c797e04f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/65d5b22750d3eef2d405134e6a7d5ce1c797e04f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e9c3215b776b07faeb5184249fc0e43876f26723",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v1\n\niQIcBAABAgAGBQJVDV4MAAoJEHZ14xz1cZgy7SIP/0wxl1rjmq9n07YK0tJSaT4P\n7m+tAgVjbiHIromVfKICJhZ3gHlcq0vwnX/nmkdIbmfVRuYAbByL09nlZJTJXEBn\nqY4ZwWIk1SSy5bfCsIUM0D0rRwFcusBkg1OujdnTl6EqtrslLbxvp1N0mRL96v5h\nxcEmgF08Fb+noUknEP/jTrsGd210FBfgXx+rejhE9lEBAviuRUa9l2c4wnEVffU6\nL5+cEy0RfycQwY5B0lvoF04psA/ktaXMJ/8aXp4o2a0Otj5QQypWpCUTRC5d70b4\nw2/utFSa/0lsjCUkEIQD+/pl8F+G2fGPC0DIpWZmSz3vTPZHOVUK+MW1Ds10xFOh\nwt0v1S2+npBGN64tmTRwVtAHkUXy4kvPWWF9voD+X0CFlmPg/giU3xr72mcVza5p\nvOoTeFE9RXVgpxY2LdEd0SYEVK2B5tXYOZ9xK0BW+2cILjP9eXMj9u3TOhLHvqbb\nZz+fmOfaSAZJ9Cg77UzzBz47s3btW44UWkFE4JIJtfc72D9w2WruvNpR4iVmMY0v\nfvd7kdKzY+6KKKc2MZqaMAbo5+syhvW+354DX2IrC9o6iv7hKrRhR7DGlOSd34Kt\n7bfzm4EneFYGC8uGFqvten39S0puL31OqXDqIvVqPT+IJdXCXOmV67NvpH3P2XYI\nHBQ94Iv3ZD+2Ip6qS4xj\n=Xd/1\n-----END PGP SIGNATURE-----",
        "payload": "tree 65d5b22750d3eef2d405134e6a7d5ce1c797e04f\nparent f3948a30cd27928fdf9dffbbf90ea6430c869edf\nauthor dexX7 <ugithub@bitwatch.co> 1418968756 +0100\ncommitter dexX7 <dexx@bitwatch.co> 1426939403 +0100\n\n[Wallet] sort pending wallet transactions before reaccepting\n\nDuring startup, when adding pending wallet transactions, which spend outputs of\nother pending wallet transactions, back to the memory pool, and when they are\nadded out of order, it appears as if they are orphans with missing inputs.\n\nThose transactions are then rejected and flagged as \"conflicting\" (= not in the\nmemory pool, not in the block chain).\n\nTo prevent this, transactions are explicitly sorted.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e9c3215b776b07faeb5184249fc0e43876f26723",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e9c3215b776b07faeb5184249fc0e43876f26723",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e9c3215b776b07faeb5184249fc0e43876f26723/comments",
    "author": {
      "login": "dexX7",
      "id": 5836089,
      "node_id": "MDQ6VXNlcjU4MzYwODk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5836089?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dexX7",
      "html_url": "https://github.com/dexX7",
      "followers_url": "https://api.github.com/users/dexX7/followers",
      "following_url": "https://api.github.com/users/dexX7/following{/other_user}",
      "gists_url": "https://api.github.com/users/dexX7/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dexX7/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dexX7/subscriptions",
      "organizations_url": "https://api.github.com/users/dexX7/orgs",
      "repos_url": "https://api.github.com/users/dexX7/repos",
      "events_url": "https://api.github.com/users/dexX7/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dexX7/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dexX7",
      "id": 5836089,
      "node_id": "MDQ6VXNlcjU4MzYwODk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5836089?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dexX7",
      "html_url": "https://github.com/dexX7",
      "followers_url": "https://api.github.com/users/dexX7/followers",
      "following_url": "https://api.github.com/users/dexX7/following{/other_user}",
      "gists_url": "https://api.github.com/users/dexX7/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dexX7/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dexX7/subscriptions",
      "organizations_url": "https://api.github.com/users/dexX7/orgs",
      "repos_url": "https://api.github.com/users/dexX7/repos",
      "events_url": "https://api.github.com/users/dexX7/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dexX7/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f3948a30cd27928fdf9dffbbf90ea6430c869edf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f3948a30cd27928fdf9dffbbf90ea6430c869edf",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f3948a30cd27928fdf9dffbbf90ea6430c869edf"
      }
    ],
    "stats": {
      "total": 19,
      "additions": 14,
      "deletions": 5
    },
    "files": [
      {
        "sha": "207bb8c97abf5b599cefbd54e1d3be8277790074",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 14,
        "deletions": 5,
        "changes": 19,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e9c3215b776b07faeb5184249fc0e43876f26723/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e9c3215b776b07faeb5184249fc0e43876f26723/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=e9c3215b776b07faeb5184249fc0e43876f26723",
        "patch": "@@ -1028,6 +1028,9 @@ int CWallet::ScanForWalletTransactions(CBlockIndex* pindexStart, bool fUpdate)\n void CWallet::ReacceptWalletTransactions()\n {\n     LOCK2(cs_main, cs_wallet);\n+    std::map<int64_t, CWalletTx*> mapSorted;\n+\n+    // Sort pending wallet transactions based on their initial wallet insertion order\n     BOOST_FOREACH(PAIRTYPE(const uint256, CWalletTx)& item, mapWallet)\n     {\n         const uint256& wtxid = item.first;\n@@ -1036,13 +1039,19 @@ void CWallet::ReacceptWalletTransactions()\n \n         int nDepth = wtx.GetDepthInMainChain();\n \n-        if (!wtx.IsCoinBase() && nDepth < 0)\n-        {\n-            // Try to add to memory pool\n-            LOCK(mempool.cs);\n-            wtx.AcceptToMemoryPool(false);\n+        if (!wtx.IsCoinBase() && nDepth < 0) {\n+            mapSorted.insert(std::make_pair(wtx.nOrderPos, &wtx));\n         }\n     }\n+\n+    // Try to add wallet transactions to memory pool\n+    BOOST_FOREACH(PAIRTYPE(const int64_t, CWalletTx*)& item, mapSorted)\n+    {\n+        CWalletTx& wtx = *(item.second);\n+\n+        LOCK(mempool.cs);\n+        wtx.AcceptToMemoryPool(false);\n+    }\n }\n \n void CWalletTx::RelayWalletTransaction()"
      }
    ]
  }
]