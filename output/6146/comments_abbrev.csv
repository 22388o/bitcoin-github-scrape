laanwj,2015-05-15T17:30:30Z,"I thought about this solution, to queue a task after the other tasks that signals the main thread to continue. However, as the handling is multi-threaded it is not guaranteed that the other tasks will have finished execution by the time the closing task runs. I think this will need additional synchronization to be sure.\n",https://github.com/bitcoin/bitcoin/pull/6146#issuecomment-102464391,102464391,
gavinandresen,2015-05-15T18:06:01Z,"@laanwj : mmm... I think CScheduler needs a way to do a clean shutdown when there are multiple threads servicing the queue.  I'll take a whack at that after lunch.\n\nAlternatively, the unit test could be changed to just use a single thread so task ordering is deterministic; we aren't using multiple threads to service it, anyway.\n",https://github.com/bitcoin/bitcoin/pull/6146#issuecomment-102473977,102473977,
gavinandresen,2015-05-15T19:23:33Z,"Added CScheduler::stop(bool drain) method, which is the semantics we really want (""let the threads exit when there is nothing left to do"").\n",https://github.com/bitcoin/bitcoin/pull/6146#issuecomment-102499940,102499940,
laanwj,2015-05-16T06:22:07Z,"Looks good to me.\n\nHowever, it does not yet address @theuni' comment on #6145 \n\n> If there's a future bug that would otherwise cause this to fail because the tasks never successfully finish, this would now hang forever rather than failing, no? Maybe give it an absurd timeout, or verify that the numTasksInQueue are decreasing?\n\nIf the queue never drains (for example if every task keeps adding",https://github.com/bitcoin/bitcoin/pull/6146#issuecomment-102576620,102576620,
gavinandresen,2015-05-16T22:04:09Z,"Nit picked, merged to master (quick merge because Travis errors are so disruptive).\n",https://github.com/bitcoin/bitcoin/pull/6146#issuecomment-102703566,102703566,
laanwj,2015-05-16T06:22:59Z,"Could move this if (stopRequested) to above the `#if BOOST_VERSION < 105000`, then the while () conditions don't have to be extended.\n",https://github.com/bitcoin/bitcoin/pull/6146#discussion_r30458947,30458947,src/scheduler.cpp
