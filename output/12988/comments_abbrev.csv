skeees,2018-04-15T15:37:33Z,@ryanofsky / other qt experts - the gui signals still get called out of cs_main - do you see any potential issues there?,https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381415528,381415528,
ryanofsky,2018-04-15T16:31:34Z,"> @ryanofsky / other qt experts - the gui signals still get called out of cs_main - do you see any potential issues there?\n\nWould have to look into it more, but if the problem is NotifyBlockTip events being sent to the GUI in the wrong order, we should determine whether one of @TheBlueMatt's PRs fixes this. Assuming one does, it's probably sufficient for this PR to just update the `NotifyBlock",https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381419449,381419449,
skeees,2018-04-15T16:39:06Z,#11856 is the one that I think you are referring to which eliminates that particular call to NotifyBlockTip and replaces it with the ValidationInterface signals,https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381419950,381419950,
TheBlueMatt,2018-04-15T16:40:58Z,"I think this PR is fine as-is, the GUI I'd be surprised if it were broken, though the mining stuff may be (but #11856 pulls it all out to using validationinterface, which should be a less-likely-to-break-things fix as it doesn't introduce new lockorders). It'd also be nice to see the no-change-callbacks go away ala a9db3dada0119c183d16627805e90c4dbca05c6a since we're touching this code anyway.",https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381420079,381420079,
ryanofsky,2018-04-15T16:50:15Z,"> I think this PR is fine as-is\n\nI think it would be good for this PR to update `NotifyBlockTip` documentation if notifications can come out of order, regardless of whether there are currently any gui bugs.",https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381420700,381420700,
skeees,2018-04-15T17:25:02Z,"@ryanofsky - i'll update docs\n@TheBlueMatt - will evaluate whether feasible to cherry-pick that commit into this pr",https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381423061,381423061,
laanwj,2018-04-16T13:34:10Z,"> @ryanofsky / other qt experts - the gui signals still get called out of cs_main - do you see any potential issues there?\n\nI expect the GUI doesn't care - it transfers the signals to a different thread anyway.",https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381600952,381600952,
jnewbery,2018-04-16T14:25:43Z,"Looks good to me. I don't think https://github.com/bitcoin/bitcoin/commit/a9db3dada0119c183d16627805e90c4dbca05c6a needs to be pulled in - it's an orthogonal change for whether to fire notifications at all. It's useful, but no need to widen the scope of this PR.",https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381617714,381617714,
TheBlueMatt,2018-04-16T14:29:40Z,"Heh, @jnewbery pointed out that a9db3dada0119c183d16627805e90c4dbca05c6a doesn't actually fix it, I was looking at the wrong callback, sorry for the noise.",https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381618983,381618983,
TheBlueMatt,2018-04-16T14:44:58Z,"As for the uiInterface callback, I think its best to move it into the cs_main as well - as @laanwj points out in the GUI its immediately pushed to a queue for main thread execution so that should be fine, and the RPCNotifyBlockChange call should be cs_main-safe as it only notify_all()s and the cs_blockchange mutex is never taken with cs_main in another thread. Obviously this really sucks and risks",https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381624346,381624346,
skeees,2018-04-16T15:53:47Z,Consensus seems to be to update the gui callbacks in cs_main as well (until #11856 which moves these gui callbacks to the ValidationInterface) - latest commit does that and addresses @promag's other review comment,https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381654491,381654491,
jnewbery,2018-04-16T17:06:28Z,ACK b6f486c85c85e024f03941cbbeadb348ddceaaf8. Commits can be squashed.,https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381678301,381678301,
skeees,2018-04-16T18:03:07Z,Squashed,https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381695802,381695802,
jnewbery,2018-04-16T18:19:25Z,"ACK 713c066\n\n```\nâ†’ git diff b6f486c 713c066\n\n```",https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381700901,381700901,
promag,2018-04-17T13:08:14Z,utACK d86edd3.,https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381985836,381985836,
sdaftuar,2018-04-17T13:34:44Z,utACK d86edd3,https://github.com/bitcoin/bitcoin/pull/12988#issuecomment-381994246,381994246,
promag,2018-04-16T14:54:15Z,"Should add\n```cpp\nAssertLockHeld(cs_main);\n````\nto `CMainSignals::UpdatedBlockTip`? And a comment.",https://github.com/bitcoin/bitcoin/pull/12988#discussion_r181765749,181765749,src/validation.cpp
promag,2018-04-16T14:56:14Z,This means that the UI can present a tip that is not the tip?,https://github.com/bitcoin/bitcoin/pull/12988#discussion_r181767852,181767852,src/validation.cpp
TheBlueMatt,2018-04-16T19:32:49Z,"Bleh, if you're gonna assert this here you should probably assert it in pretty much every signal, as they all have ordering requirements. It also just seems kinda strange to do so cause its not really a requirement of the validationinterface, its a requirement that they be ordered, not done in one specific cs (eg the mempool ones could probably be ordered by mempool.cs instead).",https://github.com/bitcoin/bitcoin/pull/12988#discussion_r181859299,181859299,src/validationinterface.cpp
sdaftuar,2018-04-16T20:50:16Z,I was also not loving this AssertLockHeld() for the same reason.  I'd prefer we drop it and just leave a comment explaining the ordering requirement (maybe with a comment mentioning the cs_main lock as one way to achieve it).,https://github.com/bitcoin/bitcoin/pull/12988#discussion_r181880710,181880710,src/validationinterface.cpp
skeees,2018-04-16T22:04:36Z,Agreed - updated,https://github.com/bitcoin/bitcoin/pull/12988#discussion_r181899659,181899659,src/validationinterface.cpp
promag,2018-04-16T22:26:45Z,"I'm not a fan of spreading `AssertLockHeld` either but in this case the current fix is to lock and having the assert here makes that explicitly required. With just the comment a future refactor can break that requirement and reintroduce the bug.\n\nBut it was just a suggestion.",https://github.com/bitcoin/bitcoin/pull/12988#discussion_r181903921,181903921,src/validationinterface.cpp
sdaftuar,2018-04-17T12:54:16Z,"Note that the `AssertLockHeld` wouldn't have prevented the caller from releasing cs_main after updating the tip, and reacquiring cs_main before the validation interface callbacks -- which would still result in violating the ordering requirements.",https://github.com/bitcoin/bitcoin/pull/12988#discussion_r182060600,182060600,src/validationinterface.cpp
promag,2018-04-17T13:07:58Z,@sdaftuar that's true and the same could be said to every `AssertLockHeld` ðŸ˜›,https://github.com/bitcoin/bitcoin/pull/12988#discussion_r182064954,182064954,src/validationinterface.cpp
