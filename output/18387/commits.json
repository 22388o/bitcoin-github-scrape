[
  {
    "sha": "81d4a7b7e3d096ef6f7586eb34dfd2653432c504",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4MWQ0YTdiN2UzZDA5NmVmNmY3NTg2ZWIzNGRmZDI2NTM0MzJjNTA0",
    "commit": {
      "author": {
        "name": "Hennadii Stepanov",
        "email": "32963518+hebasto@users.noreply.github.com",
        "date": "2020-03-19T21:25:31Z"
      },
      "committer": {
        "name": "Hennadii Stepanov",
        "email": "32963518+hebasto@users.noreply.github.com",
        "date": "2020-03-19T22:02:28Z"
      },
      "message": "gui: Fix segfault for loading and immediately unloading wallet",
      "tree": {
        "sha": "7c4eebe63e7dd6a9c28ace205084380b3a491d3b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7c4eebe63e7dd6a9c28ace205084380b3a491d3b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/81d4a7b7e3d096ef6f7586eb34dfd2653432c504",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE0dvyxLlvLev0wWZUQQEIES5+qB8FAl5z7AYACgkQQQEIES5+\nqB+OJhAArEaiNQUFQataRpjkh8O4EwvNR8bw609WMzjKP0VciNb5XRvhmEXhJXzg\nztgQcBBEZdeE3aHkjA0z+gqK1qnAfc1ZQ9Tpc5nDFNIqsptOYIvz0+yPvNIr1Ajn\nYVBNRV49PCTTZCq/HS+qsYvl11+FSoFxjLUj7Fg6fLXWTwgXgmSuWK4ADRVfya0B\n+02+A1rUW+y026qrFtoabBFn23OVU8BGarcT5oFR8/ZJVPm+eURY1ZT9taY3NbVA\nKDnlhKRYEXXOfS46WqrrNhR3jmBiYLsU7YEpHfKr4k+o69fFu5RPPTMv2VlRqWQ2\nhPj/gODeFNDAFNOtrDW2BiToeaPUQ1gi52R51xpVjrv58bB1ewXwD4NxCrCuFwEU\nAko4aNxjF7MWF2SctjiWR8t4Tw9VS2Jimnq2fE0mpEOrdz2Yyrb7UIXHNCyWWz4b\n4y5KqTaVIUm/Mj+H70TJinTZDWTWc7e47dcFTZNruZ7AgyWwHzCxR5y9xQAVjFD3\njwPP8wxNuK4b14KNyOMLz4OzwEgBME0FcsnsYNLlX83KSDmWRntfDfV8K557JwIU\nQJI0NXmyfhyc7BFY+huTgXzRfbY32dQHYXGO5RZpCvEkPZnnIey+ArrZX1p6xRNb\nPeUsrmJMP+p7m1Cyi7J22ihq5rRegp1Kz9kRVzlwL0+yiFgb64o=\n=IvQi\n-----END PGP SIGNATURE-----",
        "payload": "tree 7c4eebe63e7dd6a9c28ace205084380b3a491d3b\nparent ce87d5613a5537b68cf23e7bc25c1e3770704ff9\nauthor Hennadii Stepanov <32963518+hebasto@users.noreply.github.com> 1584653131 +0200\ncommitter Hennadii Stepanov <32963518+hebasto@users.noreply.github.com> 1584655348 +0200\n\ngui: Fix segfault for loading and immediately unloading wallet\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/81d4a7b7e3d096ef6f7586eb34dfd2653432c504",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/81d4a7b7e3d096ef6f7586eb34dfd2653432c504",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/81d4a7b7e3d096ef6f7586eb34dfd2653432c504/comments",
    "author": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ce87d5613a5537b68cf23e7bc25c1e3770704ff9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ce87d5613a5537b68cf23e7bc25c1e3770704ff9",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ce87d5613a5537b68cf23e7bc25c1e3770704ff9"
      }
    ],
    "stats": {
      "total": 25,
      "additions": 25,
      "deletions": 0
    },
    "files": [
      {
        "sha": "3275523fbbaad0a9c981e1fc1153772e6281fffe",
        "filename": "src/qt/bitcoingui.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/81d4a7b7e3d096ef6f7586eb34dfd2653432c504/src/qt/bitcoingui.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/81d4a7b7e3d096ef6f7586eb34dfd2653432c504/src/qt/bitcoingui.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/bitcoingui.cpp?ref=81d4a7b7e3d096ef6f7586eb34dfd2653432c504",
        "patch": "@@ -24,6 +24,7 @@\n #include <qt/walletframe.h>\n #include <qt/walletmodel.h>\n #include <qt/walletview.h>\n+#include <wallet/wallet.h>\n #endif // ENABLE_WALLET\n \n #ifdef Q_OS_MAC\n@@ -643,6 +644,11 @@ void BitcoinGUI::addWallet(WalletModel* walletModel)\n         m_wallet_selector_label_action->setVisible(true);\n         m_wallet_selector_action->setVisible(true);\n     }\n+\n+    const std::lock_guard<std::mutex> lock(g_loading_wallet_models_mutex);\n+    g_loading_wallet_models_set.erase(walletModel);\n+    assert(g_loading_wallet_models_set.count(walletModel) == 0);\n+    g_loading_wallet_models_cv.notify_all();\n }\n \n void BitcoinGUI::removeWallet(WalletModel* walletModel)"
      },
      {
        "sha": "6b7aab476bf855db9befeee0475bb238b4e67447",
        "filename": "src/qt/walletmodel.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/81d4a7b7e3d096ef6f7586eb34dfd2653432c504/src/qt/walletmodel.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/81d4a7b7e3d096ef6f7586eb34dfd2653432c504/src/qt/walletmodel.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/walletmodel.cpp?ref=81d4a7b7e3d096ef6f7586eb34dfd2653432c504",
        "patch": "@@ -40,6 +40,11 @@ WalletModel::WalletModel(std::unique_ptr<interfaces::Wallet> wallet, interfaces:\n     cachedEncryptionStatus(Unencrypted),\n     cachedNumBlocks(0)\n {\n+    {\n+        const std::lock_guard<std::mutex> lock(g_loading_wallet_models_mutex);\n+        g_loading_wallet_models_set.insert(this);\n+    }\n+\n     fHaveWatchOnly = m_wallet->haveWatchOnly();\n     addressTableModel = new AddressTableModel(this);\n     transactionTableModel = new TransactionTableModel(platformStyle, this);"
      },
      {
        "sha": "ed92e0048742931e289fe53c2da3c4570ecb6e19",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 0,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/81d4a7b7e3d096ef6f7586eb34dfd2653432c504/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/81d4a7b7e3d096ef6f7586eb34dfd2653432c504/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=81d4a7b7e3d096ef6f7586eb34dfd2653432c504",
        "patch": "@@ -35,6 +35,10 @@\n \n #include <boost/algorithm/string/replace.hpp>\n \n+std::set<WalletModel*> g_loading_wallet_models_set;\n+std::condition_variable g_loading_wallet_models_cv;\n+std::mutex g_loading_wallet_models_mutex;\n+\n const std::map<uint64_t,std::string> WALLET_FLAG_CAVEATS{\n     {WALLET_FLAG_AVOID_REUSE,\n         \"You need to rescan the blockchain in order to correctly mark used \"\n@@ -126,6 +130,11 @@ static void ReleaseWallet(CWallet* wallet)\n \n void UnloadWallet(std::shared_ptr<CWallet>&& wallet)\n {\n+    {\n+        std::unique_lock<std::mutex> lock(g_loading_wallet_models_mutex);\n+        g_loading_wallet_models_cv.wait(lock, []()->bool { return g_loading_wallet_models_set.empty(); });\n+    }\n+\n     // Mark wallet for unloading.\n     const std::string name = wallet->GetName();\n     {"
      },
      {
        "sha": "c81032177b035ba6be13fd7c1cd90534adeb5451",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/81d4a7b7e3d096ef6f7586eb34dfd2653432c504/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/81d4a7b7e3d096ef6f7586eb34dfd2653432c504/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=81d4a7b7e3d096ef6f7586eb34dfd2653432c504",
        "patch": "@@ -37,6 +37,11 @@\n \n #include <boost/signals2/signal.hpp>\n \n+class WalletModel;\n+extern std::set<WalletModel*> g_loading_wallet_models_set;\n+extern std::condition_variable g_loading_wallet_models_cv;\n+extern std::mutex g_loading_wallet_models_mutex;\n+\n using LoadWalletFn = std::function<void(std::unique_ptr<interfaces::Wallet> wallet)>;\n \n //! Explicitly unload and delete the wallet."
      }
    ]
  }
]