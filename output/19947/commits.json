[
  {
    "sha": "64bc5efd39bad3212a1d57fd6234b544a14bb974",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2NGJjNWVmZDM5YmFkMzIxMmExZDU3ZmQ2MjM0YjU0NGExNGJiOTc0",
    "commit": {
      "author": {
        "name": "Oliver Gugger",
        "email": "gugger@gmail.com",
        "date": "2020-09-12T15:07:59Z"
      },
      "committer": {
        "name": "Oliver Gugger",
        "email": "gugger@gmail.com",
        "date": "2020-10-02T13:48:45Z"
      },
      "message": "test: Assert PSBT change type\n\nMake sure the wallet's default change type is respected by default when\nfunding a PSBT but can be overwritten by the \"change_type\" option.",
      "tree": {
        "sha": "87b28867f03ab01159d9486ee75a067f01a637fd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/87b28867f03ab01159d9486ee75a067f01a637fd"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/64bc5efd39bad3212a1d57fd6234b544a14bb974",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE9Pxw8HMQAoQk78IKjkJWWT8XdyAFAl93L70ACgkQjkJWWT8X\ndyDNdg/+LHz0uv5ULq76LPp08XAiSJ4MvaV/OHNMRrxlBm5BRxR0FRNppsJickhI\n7FmC1fzjhA7HpNWM0ddy/x3bPygDe61ZK5D3WLDoEmIFq93jjStGiQ9viS6Pjs6a\nCyldq6labitvwsq1xXPgaJXejBhp4HJnq6JaTK1LkXFtuIsgXHXWa2u84tcs0gqS\nhTHSTWiAHHjvTd015R41qrhsscvD2LpReRrDDPvOjBeTNfqNyeDznacQmJLVsavl\nMagr3OTChoUkTEbnhPN6d3IsOS3v2X3IoJQVY0BoHSoVogfBz61kTOCOZcUTmJ6s\nBPp+6cK24WmYSazcjqT8lwF781au/BKCM4rs9DnDT1a14lOiGy9WqOYNWmbRB0mA\nyUR4s/yFAyvRNJFBkZJz993ZyIcRFr2ST65BHxPE4LgMK/WONsMlIT1riVimmUh9\nPlFwl7m77BK4aqq8LW2ytw2BP7uD7kkztbap218qHQGkDTADmtd3mkoc6ovHaeDa\n0Mt8BF/YkF2wi6PC7qUBwAcG78grjfHPALQDXHacxyUgYJffbLKe9AfTgX3lUFFs\nlpjP0Xb2ZnDFFWXB06cq4YTd956xZftKuf4gxTwmVf1CH3qC0cagBEI84QDDSYDf\nu6Gc/mlnVRq7lJm7/qNI5yzx4QatbTK12AO5aGA0BGeYnNQEX6o=\n=ntk7\n-----END PGP SIGNATURE-----",
        "payload": "tree 87b28867f03ab01159d9486ee75a067f01a637fd\nparent df2129a2349b1877049f250551f49a4592e73765\nauthor Oliver Gugger <gugger@gmail.com> 1599923279 +0200\ncommitter Oliver Gugger <gugger@gmail.com> 1601646525 +0200\n\ntest: Assert PSBT change type\n\nMake sure the wallet's default change type is respected by default when\nfunding a PSBT but can be overwritten by the \"change_type\" option.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/64bc5efd39bad3212a1d57fd6234b544a14bb974",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/64bc5efd39bad3212a1d57fd6234b544a14bb974",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/64bc5efd39bad3212a1d57fd6234b544a14bb974/comments",
    "author": {
      "login": "guggero",
      "id": 1008879,
      "node_id": "MDQ6VXNlcjEwMDg4Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1008879?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/guggero",
      "html_url": "https://github.com/guggero",
      "followers_url": "https://api.github.com/users/guggero/followers",
      "following_url": "https://api.github.com/users/guggero/following{/other_user}",
      "gists_url": "https://api.github.com/users/guggero/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/guggero/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/guggero/subscriptions",
      "organizations_url": "https://api.github.com/users/guggero/orgs",
      "repos_url": "https://api.github.com/users/guggero/repos",
      "events_url": "https://api.github.com/users/guggero/events{/privacy}",
      "received_events_url": "https://api.github.com/users/guggero/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "guggero",
      "id": 1008879,
      "node_id": "MDQ6VXNlcjEwMDg4Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1008879?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/guggero",
      "html_url": "https://github.com/guggero",
      "followers_url": "https://api.github.com/users/guggero/followers",
      "following_url": "https://api.github.com/users/guggero/following{/other_user}",
      "gists_url": "https://api.github.com/users/guggero/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/guggero/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/guggero/subscriptions",
      "organizations_url": "https://api.github.com/users/guggero/orgs",
      "repos_url": "https://api.github.com/users/guggero/repos",
      "events_url": "https://api.github.com/users/guggero/events{/privacy}",
      "received_events_url": "https://api.github.com/users/guggero/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "df2129a2349b1877049f250551f49a4592e73765",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/df2129a2349b1877049f250551f49a4592e73765",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/df2129a2349b1877049f250551f49a4592e73765"
      }
    ],
    "stats": {
      "total": 21,
      "additions": 20,
      "deletions": 1
    },
    "files": [
      {
        "sha": "c2e7fac7b735c18a7eef2c19d5720591ed5269e0",
        "filename": "test/functional/rpc_psbt.py",
        "status": "modified",
        "additions": 20,
        "deletions": 1,
        "changes": 21,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/64bc5efd39bad3212a1d57fd6234b544a14bb974/test/functional/rpc_psbt.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/64bc5efd39bad3212a1d57fd6234b544a14bb974/test/functional/rpc_psbt.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_psbt.py?ref=64bc5efd39bad3212a1d57fd6234b544a14bb974",
        "patch": "@@ -30,7 +30,7 @@ def set_test_params(self):\n         self.num_nodes = 3\n         self.extra_args = [\n             [\"-walletrbf=1\"],\n-            [\"-walletrbf=0\"],\n+            [\"-walletrbf=0\", \"-changetype=legacy\"],\n             []\n         ]\n         self.supports_cli = False\n@@ -83,6 +83,14 @@ def test_utxo_conversion(self):\n         connect_nodes(self.nodes[0], 1)\n         connect_nodes(self.nodes[0], 2)\n \n+    def assert_change_type(self, psbtx, expected_type):\n+        \"\"\"Assert that the given PSBT has a change output with the given type.\"\"\"\n+\n+        # The decodepsbt RPC is stateless and independent of any settings, we can always just call it on the first node\n+        decoded_psbt = self.nodes[0].decodepsbt(psbtx[\"psbt\"])\n+        changepos = psbtx[\"changepos\"]\n+        assert_equal(decoded_psbt[\"tx\"][\"vout\"][changepos][\"scriptPubKey\"][\"type\"], expected_type)\n+\n     def run_test(self):\n         # Create and fund a raw tx for sending 10 BTC\n         psbtx1 = self.nodes[0].walletcreatefundedpsbt([], {self.nodes[2].getnewaddress():10})['psbt']\n@@ -301,6 +309,17 @@ def run_test(self):\n         # when attempting BnB coin selection\n         self.nodes[0].walletcreatefundedpsbt([], [{self.nodes[2].getnewaddress():unspent[\"amount\"]+1}], block_height+2, {\"changeAddress\":self.nodes[1].getnewaddress()}, False)\n \n+        # Make sure the wallet's change type is respected by default\n+        small_output = {self.nodes[0].getnewaddress():0.1}\n+        psbtx_native = self.nodes[0].walletcreatefundedpsbt([], [small_output])\n+        self.assert_change_type(psbtx_native, \"witness_v0_keyhash\")\n+        psbtx_legacy = self.nodes[1].walletcreatefundedpsbt([], [small_output])\n+        self.assert_change_type(psbtx_legacy, \"pubkeyhash\")\n+\n+        # Make sure the change type of the wallet can also be overwritten\n+        psbtx_np2wkh = self.nodes[1].walletcreatefundedpsbt([], [small_output], 0, {\"change_type\":\"p2sh-segwit\"})\n+        self.assert_change_type(psbtx_np2wkh, \"scripthash\")\n+\n         # Regression test for 14473 (mishandling of already-signed witness transaction):\n         psbtx_info = self.nodes[0].walletcreatefundedpsbt([{\"txid\":unspent[\"txid\"], \"vout\":unspent[\"vout\"]}], [{self.nodes[2].getnewaddress():unspent[\"amount\"]+1}], 0, {\"add_inputs\": True})\n         complete_psbt = self.nodes[0].walletprocesspsbt(psbtx_info[\"psbt\"])"
      }
    ]
  },
  {
    "sha": "a56e9f5670136b29e48aabfc7f38569222fe4635",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphNTZlOWY1NjcwMTM2YjI5ZTQ4YWFiZmM3ZjM4NTY5MjIyZmU0NjM1",
    "commit": {
      "author": {
        "name": "Oliver Gugger",
        "email": "gugger@gmail.com",
        "date": "2020-09-12T15:16:23Z"
      },
      "committer": {
        "name": "Oliver Gugger",
        "email": "gugger@gmail.com",
        "date": "2020-10-02T15:15:52Z"
      },
      "message": "test: Assert exclusive PSBT funding options\n\nMake sure the options \"change_type\" and \"changeAddress\" of the\nwalletcreatefundedpsbt RPC cannot both be specified a the same time.",
      "tree": {
        "sha": "1e78a3f9e0effd12327aa9a16913f6019d5363c1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1e78a3f9e0effd12327aa9a16913f6019d5363c1"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a56e9f5670136b29e48aabfc7f38569222fe4635",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE9Pxw8HMQAoQk78IKjkJWWT8XdyAFAl93RDIACgkQjkJWWT8X\ndyCSdxAAzj/j+3u4rNdYtBb/aBvCO4UIaTI15Lt6+2/HASvHmHJPMb8szhxTm03L\neHF1T9ROvPI/+DEXb6CqY+RzxmYOyMwrntkct6KvAwoGLHK1shNNSQYF3SgiC4OQ\nYdJQb6nO5uj3K3w+EPA1fNyl5Apo7f+mJ4npHi+Xj1d91nFwpbotvOOu7icQFixg\nKnlznAQqlxdRw2ANmUNw9opBseWcBkR/RkcVa05iaBcvOUBBbrChHD71rD5Y0jAT\n1W9BKUcLcK4D+Y23xj5+IeCJ5xENh/+PerwKonCat06GJUn7OZpamG0NPzN4CTTr\nwKy8iRu28Q5Ez/WLUf3FhyJ6AJdauHyOnoz/iy9er59nun2HY8O0as0CiAEYhs9T\nrh+Bd5Z5JVS7clN7UTPWaYTt24JI9Q32X5RXlPdui9CaxCBGoe4UyYbIpZEr5INj\nBoeCddiltAmQidjK9t3ne38uYaphqeUg0bFHbsoys/xKHAPl5blxqO+t4oMZR+X8\nKy5KYTy9d3YTRPaA+j5H6h//txtJrrXXYyS8Se7y/NwpTKGFgZh70wj0JUbgjuPl\nmL1+ttlZ6KbtX6LbmiUxKexJbgt0iwoLOOpj7Z+S3mQrws+6UGayiNElwzRB+M49\n5Bzzixqxq0kaNeJ0C5e2hPXGe4waS6cvZPYt3n8p2kzWMwZT/gU=\n=5K0m\n-----END PGP SIGNATURE-----",
        "payload": "tree 1e78a3f9e0effd12327aa9a16913f6019d5363c1\nparent 64bc5efd39bad3212a1d57fd6234b544a14bb974\nauthor Oliver Gugger <gugger@gmail.com> 1599923783 +0200\ncommitter Oliver Gugger <gugger@gmail.com> 1601651752 +0200\n\ntest: Assert exclusive PSBT funding options\n\nMake sure the options \"change_type\" and \"changeAddress\" of the\nwalletcreatefundedpsbt RPC cannot both be specified a the same time.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a56e9f5670136b29e48aabfc7f38569222fe4635",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a56e9f5670136b29e48aabfc7f38569222fe4635",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a56e9f5670136b29e48aabfc7f38569222fe4635/comments",
    "author": {
      "login": "guggero",
      "id": 1008879,
      "node_id": "MDQ6VXNlcjEwMDg4Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1008879?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/guggero",
      "html_url": "https://github.com/guggero",
      "followers_url": "https://api.github.com/users/guggero/followers",
      "following_url": "https://api.github.com/users/guggero/following{/other_user}",
      "gists_url": "https://api.github.com/users/guggero/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/guggero/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/guggero/subscriptions",
      "organizations_url": "https://api.github.com/users/guggero/orgs",
      "repos_url": "https://api.github.com/users/guggero/repos",
      "events_url": "https://api.github.com/users/guggero/events{/privacy}",
      "received_events_url": "https://api.github.com/users/guggero/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "guggero",
      "id": 1008879,
      "node_id": "MDQ6VXNlcjEwMDg4Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1008879?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/guggero",
      "html_url": "https://github.com/guggero",
      "followers_url": "https://api.github.com/users/guggero/followers",
      "following_url": "https://api.github.com/users/guggero/following{/other_user}",
      "gists_url": "https://api.github.com/users/guggero/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/guggero/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/guggero/subscriptions",
      "organizations_url": "https://api.github.com/users/guggero/orgs",
      "repos_url": "https://api.github.com/users/guggero/repos",
      "events_url": "https://api.github.com/users/guggero/events{/privacy}",
      "received_events_url": "https://api.github.com/users/guggero/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "64bc5efd39bad3212a1d57fd6234b544a14bb974",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/64bc5efd39bad3212a1d57fd6234b544a14bb974",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/64bc5efd39bad3212a1d57fd6234b544a14bb974"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 4,
      "deletions": 0
    },
    "files": [
      {
        "sha": "2453a947cb4ef6b3c3c8a812b2ba2c954c5022e3",
        "filename": "test/functional/rpc_psbt.py",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a56e9f5670136b29e48aabfc7f38569222fe4635/test/functional/rpc_psbt.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a56e9f5670136b29e48aabfc7f38569222fe4635/test/functional/rpc_psbt.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_psbt.py?ref=a56e9f5670136b29e48aabfc7f38569222fe4635",
        "patch": "@@ -320,6 +320,10 @@ def run_test(self):\n         psbtx_np2wkh = self.nodes[1].walletcreatefundedpsbt([], [small_output], 0, {\"change_type\":\"p2sh-segwit\"})\n         self.assert_change_type(psbtx_np2wkh, \"scripthash\")\n \n+        # Make sure the change type cannot be specified if a change address is given\n+        invalid_options = {\"change_type\":\"legacy\",\"changeAddress\":self.nodes[0].getnewaddress()}\n+        assert_raises_rpc_error(-8, \"both change address and address type options\", self.nodes[0].walletcreatefundedpsbt, [], [small_output], 0, invalid_options)\n+\n         # Regression test for 14473 (mishandling of already-signed witness transaction):\n         psbtx_info = self.nodes[0].walletcreatefundedpsbt([{\"txid\":unspent[\"txid\"], \"vout\":unspent[\"vout\"]}], [{self.nodes[2].getnewaddress():unspent[\"amount\"]+1}], 0, {\"add_inputs\": True})\n         complete_psbt = self.nodes[0].walletprocesspsbt(psbtx_info[\"psbt\"])"
      }
    ]
  }
]