DrahtBot,2020-02-22 09:26:15,<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.,https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-589936663,589936663,
JeremyRubin,2020-03-03 04:46:53,Fixed and updated comment.,https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-593765658,593765658,
JeremyRubin,2020-03-03 05:55:29,"Sorry for all the line noise; I realized I forgot to add a continue, and then decided that I could DRY up the code a bit. I'm pretty happy with the final version, I think it's a bit easier to view because we don't treat update_it special from other iterators we walk (other than it not going into the cache line).\n\nI can squash this all down into one commit and replace #18120.",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-593781580,593781580,
hebasto,2020-03-29 17:43:19,Concept ACK.,https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-605673033,605673033,
hebasto,2020-03-30 08:41:31,"IIUC, the first pass of the `do ... while (true);` loop just emplaces all of the direct descendants of `update_it` tx, i.e., its children, to the `new_cache_line`, and taints their `m_epoch`. All of the following loop passes process grand children, grand-grand children and so on. And two thing are confusing to me:\n\n1) the following comment: https://github.com/bitcoin/bitcoin/blob/32985d34a0a0c",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-605863701,605863701,
jonatack,2020-05-25 07:58:02,"It seems that performance is the motivation for this PR. Could benchmarks, or a link to them, be added to the PR description?",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-633436164,633436164,
hebasto,2020-05-25 08:04:16,"@jonatack \n> It seems that performance is the motivation for this PR. Could benchmarks, or a link to them, be added to the PR description?\n\nSome benchmarks are [done](https://github.com/bitcoin/bitcoin/pull/18191#pullrequestreview-387559737) :)",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-633438899,633438899,
hebasto,2020-05-25 09:27:11,"Benchmarking:\n- on master (24f70290642c9c5108d3dc62dbe055f5d1bcff9d)\n```\n$ for i in {1..10}; do ./test/functional/mempool_updatefromblock.py | grep -o 'in [0-9]\.[0-9]*'; done\nin 0.2627599239349365\nin 0.26287293434143066\nin 0.26229262351989746\nin 0.2730386257171631\nin 0.29637765884399414\nin 0.29340052604675293\nin 0.32193946838378906\nin 0.26309871673583984\nin 0.2626173496246",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-633476244,633476244,
jonatack,2020-05-25 17:21:18,"Thanks @hebasto, I've been running your benchmarks all day long on a 2012 MacBookPro that seems to run them 6x slower than you :). Results here when it's done.\n\nInitial results for 12 runs on a more recent Debian laptop were showing 1-3% improvement on average but with quite a bit more variance than you, for this PR rebased on master versus master. Not statistically significant given the wide ",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-633659268,633659268,
JeremyRubin,2020-05-25 20:07:32,"Thanks all for running and developing these benches!\n\n@jonatack \n\nI think the thing to look at is that this is being done for a bunch of reasons that encapsulate performance more than just run time on a bench mark. If the run time is similar on a given bench that's a very favorable outcome for this patch. If it's better, that's great.\n\nBut this is ultimately more about DoS surface than",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-633702539,633702539,
hebasto,2020-05-26 03:55:26,"@jonatack @JeremyRubin \nPlease note that `mempool_updatefromblock.py` from #18485 is not a specially designed for benchmarking. It's a functional test that was adapted for benchmarking while we have no a special one.",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-633794306,633794306,
jonatack,2020-05-27 07:35:42,"For what it's worth, 30 test runs on master versus this branch rebased on master seem to show no significant difference in run time (~0.5%). They do appear to show a significant reduction in run time variance with this PR. I ran four alternating cycles of 15: master, PR, master, PR; it took most of a day to for the 60 runs.\n\n<details><summary>results with a 2012 MacBookPro running Mojave</summ",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-634484859,634484859,
jonatack,2020-05-27 07:43:50,"The build warnings I encountered building in Debian with Clang 6 were also present when building on MacOS with the default Apple clang version 11.\n\nIn both cases, these are the only compiler warnings I'm seeing while building Bitcoin Core. They can be removed by either making the txiters const reference or non-const.\n```bash\ntxmempool.cpp:89:35: warning: loop variable 'grand_child_it' of t",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-634488578,634488578,
jonatack,2020-05-27 07:48:12,"> Thanks all for running and developing these benches!\n> \n> With this patch we allocate way less memory.\n\nI think it would help the PR to feature relevant benchmarkings, with instructions to reproduce them, in the PR description.",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-634490659,634490659,
MarcoFalke,2020-05-27 11:38:00,"I don't think we have documentation on how to track memory usage. I remember I used massif at one point, but I forgot to write down notes. https://github.com/bitcoin/bitcoin/pull/17164#issuecomment-542862195",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-634603007,634603007,
JeremyRubin,2020-05-28 04:21:26,"> I think it would help the PR to feature relevant benchmarkings, with instructions to reproduce them, in the PR description.\n\nGood point. Generally this one is supposed to be an obviously better version that doesn't really require much benching. You can easily see from the code that std::sets go to vectors and a std::set of all conflicts is removed. But it's a good standard to hold to I suppo",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-635089930,635089930,
JeremyRubin,2020-05-28 04:29:57,@jonatack I'll fix the iterator reference thing. Is there a way to make this warning trigger on all platforms that you know about?,https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-635092526,635092526,
adamjonas,2020-06-15 19:19:27,I encountered identical [build warnings](https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-634488578) with MacOS clang 10.,https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-644328268,644328268,
fjahr,2020-06-17 15:50:09,"Concept ACK, also encountered the build warnings though.",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-645458400,645458400,
JeremyRubin,2020-06-17 17:05:55,Will fix the build warnings soon; thanks all for the review (will tag some people when I try to fix as I can't trigger locally).,https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-645501104,645501104,
JeremyRubin,2020-06-17 20:35:26,@jonatack can you confirm this fixes the build warning you encountered?,https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-645610159,645610159,
adamjonas,2020-06-18 00:31:04,Confirming that 32985d34a0a0cfd4ff8c4d96ff461778eaf72a8a produced the warnings but 8e5aa08df4d0f55eae8842d01b1ab3d9a3b74fc5 does not.,https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-645697964,645697964,
DrahtBot,2020-09-07 11:21:37,"<!--cf906140f33d8803c4a75a2196329ecb-->\nüêô This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a ""draft"".</sub>",https://github.com/bitcoin/bitcoin/pull/18191#issuecomment-688260499,688260499,
sdaftuar,2020-02-25 20:28:03,"Github won't let me leave a comment up at line 106, so I'm leaving it here.  I think the change in this commit of trying to not include things in `exclude` is broken, because it's possible you'll have a cache entry hit for something that is excluded, and then because things that are in the cache get swapped at line 106 to an entry in the vector that `already_traversed` is advanced past, you'll nev",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r384107992,384107992,src/txmempool.cpp
sdaftuar,2020-02-25 20:28:59,I overlooked this issue in #18120 -- is this the regression you're referring to in the commit message?,https://github.com/bitcoin/bitcoin/pull/18191#discussion_r384108456,384108456,src/txmempool.cpp
JeremyRubin,2020-02-26 20:04:19,"Nope this is *as a result* of the fix, we sometimes now have a cache that is too big because we remove things from the cache if they are in exclude. We could not do this -- and then it would still be possible for the cache entries to have an excess of O(direct children in exlcude), rather than O(exclude) without this patch, and an excess of 100 or not more than 2*size with this patch. It also only",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r384734328,384734328,src/txmempool.cpp
JeremyRubin,2020-02-26 20:05:45,We hold the invariant that everything in the cache is not excluded? So how would this have a bug?,https://github.com/bitcoin/bitcoin/pull/18191#discussion_r384735187,384735187,src/txmempool.cpp
JeremyRubin,2020-02-26 20:15:44,"Ah I see what you're saying. See comment above, will fix.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r384740067,384740067,src/txmempool.cpp
hebasto,2020-03-29 20:10:36,"I'm confused with ""... have already been checked against _excluded list_"". Which list?",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r399846953,399846953,src/txmempool.cpp
JeremyRubin,2020-03-30 02:02:59,"mapMemPoolDescebdabtsToUpdate grows to contain the set of things to exclude while processing.\n\nPreviously this list was explicitly constructed, now it's implicit",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r399892304,399892304,src/txmempool.cpp
hebasto,2020-03-30 09:14:53,"> Previously this list was explicitly constructed, now it's implicit\n\nYes. And the new logic does not apply any rule or list ""to exclude"" an element. It seems, the comments should avoid any ""excluding"" notions, and describe the logic in terms of ""including"" or ""conditional including"".",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r400041234,400041234,src/txmempool.cpp
hebasto,2020-03-30 09:40:20,"The internal loop seems redundant. Could this work:\n```\n    do {\n        for (const txiter child_it : GetMemPoolChildren(next_it)) {\n            if (visited(child_it)) continue;\n            new_cache_line.emplace_back(child_it);\n        }\n\n        // finish loop here!\n        if (next_idx_to_walk >= new_cache_line.size()) break;\n\n        // Prepare for next iteration:\n     ",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r400057301,400057301,src/txmempool.cpp
hebasto,2020-03-30 10:27:46,"Why a new variable is needed? `child_it->GetTxSize()` and `child_it->GetModifiedFee()` seems to work well, no?",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r400085843,400085843,src/txmempool.cpp
JeremyRubin,2020-03-30 20:34:29,"No because then we aren't using the cached traversal at all.\n\nIt could be correct, but has some algorithmic complexity blowups.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r400476700,400476700,src/txmempool.cpp
JeremyRubin,2020-03-30 20:38:37,"It would work but I have a preference to access through a const ref where possible to avoid using non const APIs where not explicitly offered.\n\nNo performance overhead of this, it shouldn't even allocate a variable in the code.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r400478978,400478978,src/txmempool.cpp
JeremyRubin,2020-03-30 20:41:41,You update is still not using the cache lines....,https://github.com/bitcoin/bitcoin/pull/18191#discussion_r400480589,400480589,src/txmempool.cpp
hebasto,2020-03-30 21:08:15,"> It could be correct, but has some algorithmic complexity blowups.\n\nHow it could be, if every element is visited once only?",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r400494926,400494926,src/txmempool.cpp
JeremyRubin,2020-03-30 22:22:18,"I'm saying ""could be"" because I haven't bothered to actually check your code above for correctness, given the glaring issue that it doesn't use the caches which leads to unacceptable algorithmic complexity.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r400529948,400529948,src/txmempool.cpp
JeremyRubin,2020-03-30 22:27:36,"Well the list does exist -- it's vHashesToUpdate. We just don't need to actually check or construct it because it's an implicit invariant held by the code.\n\nI can't comment on the semantic difference between excluding or conditional including, but it does seem that what we're doing is excluding.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r400532152,400532152,src/txmempool.cpp
JeremyRubin,2020-03-30 22:29:31,"In any case this comment & the function comment serve to document what the expected invariant is for the caller, so I prefer to leave this comment.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r400532974,400532974,src/txmempool.cpp
JeremyRubin,2020-03-31 01:46:11,"I guess to pull up -- I do agree that the loop is a bit atypical in structure, but I do think that it's the most straightforward to reason about because it's pretty critical when certain checks or variable updates happen.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r400594651,400594651,src/txmempool.cpp
hebasto,2020-03-31 09:47:19,"> ""... it doesn't use the caches...""\n\nCorrected:\n```\n    txiter next_it = update_it;\n    for (size_t next_idx_to_walk = 0; next_idx_to_walk < new_cache_line.size(); ++next_idx_to_walk) {\n        for (const txiter child_it : GetMemPoolChildren(next_it)) {\n            if (visited(child_it)) continue;\n            if (cache.find(child_it) != cache.end()) continue;\n            new_cac",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r400781249,400781249,src/txmempool.cpp
JeremyRubin,2020-03-31 20:05:10,"So now the code checks if there is a cache, and then continues... but you're now both not using the cache, and incorrect. If you find a cache line for a child then you must include all of it's cache entries into the new_cache_line otherwise a future call will skip updating descendants properly.\n\nThe code that is in the PR is (I believe) correct & does not have superfluous lines. If there was a",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r401181019,401181019,src/txmempool.cpp
hebasto,2020-04-03 09:30:45,"Code in the PR passes the test from #18485. \nAll my suggestions fail the test.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r402878779,402878779,src/txmempool.cpp
jonatack,2020-05-24 15:44:52,"```suggestion\n        for (const txiter& child_it : GetMemPoolChildren(next_it)) {\n```\n\nto avoid these compile warnings:\n```\ntxmempool.cpp:78:27: warning: loop variable 'child_it' of type 'const CTxMemPool::txiter' (aka 'const hashed_index_iterator<hashed_index_node<ordered_index_node<boost::multi_index::detail::null_augment_policy, ordered_index_node<boost::multi_index::detail::null_a",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r429649340,429649340,src/txmempool.cpp
jonatack,2020-05-24 15:44:56,"```suggestion\n                for (const txiter& grand_child_it : cached_grand_children->second) {\n```\n\nto avoid these compile warnings:\n```\ntxmempool.cpp:89:35: warning: loop variable 'grand_child_it' of type 'const CTxMemPool::txiter' (aka 'const hashed_index_iterator<hashed_index_node<ordered_index_node<boost::multi_index::detail::null_augment_policy, ordered_index_node<boost::multi",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r429649352,429649352,src/txmempool.cpp
hebasto,2020-05-24 15:57:10,Suppose you compiled with clang?,https://github.com/bitcoin/bitcoin/pull/18191#discussion_r429650512,429650512,src/txmempool.cpp
jonatack,2020-05-24 16:23:56,"Yes, this was a clang warning (I often compile with both gcc and clang for anything non-trivial as they seem to have complementary results).",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r429652758,429652758,src/txmempool.cpp
JeremyRubin,2020-05-24 20:48:37,"Hmm I think specifically we *do* want copying here because it's an iter, which in boost::multiindex should be just a pointer, so a reference to an iter implies extra unnecessary indirection?\n\n@sipa is probably most familiar with multiindex innards to know if this is correct.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r429673764,429673764,src/txmempool.cpp
sipa,2020-05-24 21:13:08,"Yeah, `CTxMemPool::txiter` is just a single pointer, a copy would be desirable here.\n\nHowever, I suspect that the compiler will figure this out, and produce pretty much equal code for both.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r429675967,429675967,src/txmempool.cpp
JeremyRubin,2020-05-24 21:52:42,"Thanks sipa.\n\nMy preference is to leave the code as is if the behavior is correct & desirable (even if the compiler is likely to optimize out the indirection), as the warning seems to be just an aggressive warning from clang, unless a warning is excessively bad. The right solution seems to be to annotate somehow that txiter is a copyable type. How can this be done?",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r429678707,429678707,src/txmempool.cpp
sipa,2020-05-24 22:11:22,"It seems there are two solutions: not mark the loop variable const (if you want something mutable, a copy is needed anyway), or upgrade to clang 10.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r429680012,429680012,src/txmempool.cpp
sipa,2020-05-24 22:17:38,"FWIW, at -O2, clang 9 compiles both to the same code.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r429680491,429680491,src/txmempool.cpp
MarcoFalke,2020-05-24 22:27:20,txiter is already const (it would be illegal to modify a mempool entry by the iterator). I don't think we write 'const txiter' anywhere,https://github.com/bitcoin/bitcoin/pull/18191#discussion_r429681119,429681119,src/txmempool.cpp
sipa,2020-05-24 22:35:06,"It's a const_iterator. The `const` here just prevents modifying the txiter object, not what it points to. It's a vaguely sensible thing to do when you know a variable isn't going to be modified.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r429681657,429681657,src/txmempool.cpp
JeremyRubin,2020-05-24 22:54:59,"@MarcoFalke this is not quite true, it's perfectly legal to modify through the iterator via at least two means:\n\n1) Const cast -- the txiter is known to be non const *somewhere* so updating is fine\n2) Mutable fields -- the txiter epochs are mutable, same with the vtxhashesidx\n\nIn this case we are modifying the epochs via the mutable fields even though it's const.\n",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r429683092,429683092,src/txmempool.cpp
jonatack,2020-05-25 08:54:28,"Yes, on Clang 6 (Debian), making the txiters non-const also removes the warning.\n\nIf the resulting code is the same, my suggestion would be to appease the warnings to not add needlessly to the noise and friction for reviewers, here and down the road. Could be added as a follow-up if this is merged.",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r429816429,429816429,src/txmempool.cpp
ariard,2020-07-09 17:30:34,"I think you should layout high-level algorithm behavior here, like ""cacheMap maintain a key-elements mapping where each key represents a back-to-the-mempool transactions, elements represents its children sorted XXX. We merge cache line based on key intersecting with children of a latter cache entry evaluation""\n\nYou can keep per-line comments but it would be better to normalize style, IMO you b",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r452378883,452378883,src/txmempool.cpp
ariard,2020-07-09 17:44:36,"I wonder if previous accounting logic was correct to exclude already-processed `vHashesToUpdate` member from descendant state update. E.g if back-to-mempool transaction Y is processed first, as `reverse_iterate` enforces, its parents X, also to process as second, won't account it as part of `modify_fee` and others. \n\nAFAICT, new code maintains behavior by not including Y as part of X's childre",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r452386503,452386503,src/txmempool.cpp
JeremyRubin,2020-07-09 18:36:11,"Ok so suppose vhashestoupdate is {X, Y}.\n\nFirst we submit X to mempool and Y to mempool.\n\nThen we reverse iterate and update Y, then X.\n\nPreviously, we scanned across all of the direct children in the mempool of Y then of X and updated the parent/child relationships. So Y would do only things already in the mempool, and X would see Y in this list, but exclude it in setExcluded as it wa",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r452414471,452414471,src/txmempool.cpp
ariard,2020-07-09 19:34:27,"Gotcha, thanks for the laid-out explanation, I forgot that ancestor state X is well-modified at Y new mempool insertion. I was just confused by the sybillic comment ""because any descendants in cache were added to the mempool after the transaction being updated and hence their state is already reflected in the parent state"". In fact that's should point to `AcceptToMemoryPool` in validation's `Updat",https://github.com/bitcoin/bitcoin/pull/18191#discussion_r452444596,452444596,src/txmempool.cpp
