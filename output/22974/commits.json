[
  {
    "sha": "eb2e113df13c7b1ede279878f5cbad877af49f8e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplYjJlMTEzZGYxM2M3YjFlZGUyNzk4NzhmNWNiYWQ4NzdhZjQ5Zjhl",
    "commit": {
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-09-09T19:41:51Z"
      },
      "committer": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-09-15T22:50:48Z"
      },
      "message": "addrman: Improve performance of Good\n\nThis is done by removing an unnecessary loop in Good_() and looping\nthrough the new tables in MakeTried() more efficiently, choosing a\nstarting value that allow us to stop early in typical cases.\n\nCo-authored-by: John Newbery <john@johnnewbery.com>",
      "tree": {
        "sha": "3b6f2084707bd2be43905ad68df7b30456564273",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3b6f2084707bd2be43905ad68df7b30456564273"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/eb2e113df13c7b1ede279878f5cbad877af49f8e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/eb2e113df13c7b1ede279878f5cbad877af49f8e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/eb2e113df13c7b1ede279878f5cbad877af49f8e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/eb2e113df13c7b1ede279878f5cbad877af49f8e/comments",
    "author": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "2161a058552ac938f2079b311a2d12f5d1772d01",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2161a058552ac938f2079b311a2d12f5d1772d01",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/2161a058552ac938f2079b311a2d12f5d1772d01"
      }
    ],
    "stats": {
      "total": 26,
      "additions": 9,
      "deletions": 17
    },
    "files": [
      {
        "sha": "a1e8cb1bf1641a37914d5390d97a1f329ac1aee2",
        "filename": "src/addrman.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 17,
        "changes": 26,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/eb2e113df13c7b1ede279878f5cbad877af49f8e/src/addrman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/eb2e113df13c7b1ede279878f5cbad877af49f8e/src/addrman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/addrman.cpp?ref=eb2e113df13c7b1ede279878f5cbad877af49f8e",
        "patch": "@@ -11,6 +11,7 @@\n #include <netaddress.h>\n #include <serialize.h>\n #include <streams.h>\n+#include <util/check.h>\n \n #include <cmath>\n #include <optional>\n@@ -488,11 +489,14 @@ void CAddrMan::MakeTried(CAddrInfo& info, int nId)\n     AssertLockHeld(cs);\n \n     // remove the entry from all new buckets\n-    for (int bucket = 0; bucket < ADDRMAN_NEW_BUCKET_COUNT; bucket++) {\n-        int pos = info.GetBucketPosition(nKey, true, bucket);\n+    const int start_bucket{info.GetNewBucket(nKey, m_asmap)};\n+    for (int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; ++n) {\n+        const int bucket{(start_bucket + n) % ADDRMAN_NEW_BUCKET_COUNT};\n+        const int pos{info.GetBucketPosition(nKey, true, bucket)};\n         if (vvNew[bucket][pos] == nId) {\n             vvNew[bucket][pos] = -1;\n             info.nRefCount--;\n+            if (info.nRefCount == 0) break;\n         }\n     }\n     nNew--;\n@@ -564,22 +568,10 @@ void CAddrMan::Good_(const CService& addr, bool test_before_evict, int64_t nTime\n     if (info.fInTried)\n         return;\n \n-    // find a bucket it is in now\n-    int nRnd = insecure_rand.randrange(ADDRMAN_NEW_BUCKET_COUNT);\n-    int nUBucket = -1;\n-    for (unsigned int n = 0; n < ADDRMAN_NEW_BUCKET_COUNT; n++) {\n-        int nB = (n + nRnd) % ADDRMAN_NEW_BUCKET_COUNT;\n-        int nBpos = info.GetBucketPosition(nKey, true, nB);\n-        if (vvNew[nB][nBpos] == nId) {\n-            nUBucket = nB;\n-            break;\n-        }\n-    }\n-\n-    // if no bucket is found, something bad happened;\n-    // TODO: maybe re-add the node, but for now, just bail out\n-    if (nUBucket == -1)\n+    // if it is not in new, something bad happened\n+    if (!Assume(info.nRefCount > 0)) {\n         return;\n+    }\n \n     // which tried bucket to move the entry to\n     int tried_bucket = info.GetTriedBucket(nKey, m_asmap);"
      }
    ]
  },
  {
    "sha": "acf656d540a82e6fc30421590305cfe295eabbb5",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphY2Y2NTZkNTQwYTgyZTZmYzMwNDIxNTkwMzA1Y2ZlMjk1ZWFiYmI1",
    "commit": {
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-09-10T00:23:16Z"
      },
      "committer": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-09-15T22:50:48Z"
      },
      "message": "fuzz: Use public interface to fill addrman tried tables\n\nAfter the performance improvement for Good(), the direct method is only 2x faster\nas opposed to 60x before.",
      "tree": {
        "sha": "d8bd4f4aff5f380c5b62e63ed5c53396f95eea99",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d8bd4f4aff5f380c5b62e63ed5c53396f95eea99"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/acf656d540a82e6fc30421590305cfe295eabbb5",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/acf656d540a82e6fc30421590305cfe295eabbb5",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/acf656d540a82e6fc30421590305cfe295eabbb5",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/acf656d540a82e6fc30421590305cfe295eabbb5/comments",
    "author": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "eb2e113df13c7b1ede279878f5cbad877af49f8e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/eb2e113df13c7b1ede279878f5cbad877af49f8e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/eb2e113df13c7b1ede279878f5cbad877af49f8e"
      }
    ],
    "stats": {
      "total": 23,
      "additions": 2,
      "deletions": 21
    },
    "files": [
      {
        "sha": "1781420f4ffd1347f8073e9d380864f1ecae5d82",
        "filename": "src/test/fuzz/addrman.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 21,
        "changes": 23,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/acf656d540a82e6fc30421590305cfe295eabbb5/src/test/fuzz/addrman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/acf656d540a82e6fc30421590305cfe295eabbb5/src/test/fuzz/addrman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/fuzz/addrman.cpp?ref=acf656d540a82e6fc30421590305cfe295eabbb5",
        "patch": "@@ -96,31 +96,12 @@ class CAddrManDeterministic : public CAddrMan\n             for (size_t j = 0; j < num_addresses; ++j) {\n                 const auto addr = CAddress{CService{RandAddr(), 8333}, NODE_NETWORK};\n                 const auto time_penalty = insecure_rand.randrange(100000001);\n-#if 1\n-                // 2.83 sec to fill.\n-                if (n > 0 && mapInfo.size() % n == 0 && mapAddr.find(addr) == mapAddr.end()) {\n-                    // Add to the \"tried\" table (if the bucket slot is free).\n-                    const CAddrInfo dummy{addr, source};\n-                    const int bucket = dummy.GetTriedBucket(nKey, m_asmap);\n-                    const int bucket_pos = dummy.GetBucketPosition(nKey, false, bucket);\n-                    if (vvTried[bucket][bucket_pos] == -1) {\n-                        int id;\n-                        CAddrInfo* addr_info = Create(addr, source, &id);\n-                        vvTried[bucket][bucket_pos] = id;\n-                        addr_info->fInTried = true;\n-                        ++nTried;\n-                    }\n-                } else {\n-                    // Add to the \"new\" table.\n-                    Add_(addr, source, time_penalty);\n-                }\n-#else\n-                // 261.91 sec to fill.\n                 Add_(addr, source, time_penalty);\n+\n                 if (n > 0 && mapInfo.size() % n == 0) {\n                     Good_(addr, false, GetTime());\n                 }\n-#endif\n+\n                 // Add 10% of the addresses from more than one source.\n                 if (insecure_rand.randrange(10) == 0 && prev_source.IsValid()) {\n                     Add_(addr, prev_source, time_penalty);"
      }
    ]
  },
  {
    "sha": "57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1N2NlMjAzMDdlNjA0NTMwZjc4ZWY0ZjBmOGQ5ZmI5NGY4MGNhODFi",
    "commit": {
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-09-15T22:16:56Z"
      },
      "committer": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-09-15T22:50:48Z"
      },
      "message": "fuzz: allow lower number of sources",
      "tree": {
        "sha": "fd6283075300434f75c0ad77bb429fed482b86da",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/fd6283075300434f75c0ad77bb429fed482b86da"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/57ce20307e604530f78ef4f0f8d9fb94f80ca81b/comments",
    "author": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "acf656d540a82e6fc30421590305cfe295eabbb5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/acf656d540a82e6fc30421590305cfe295eabbb5",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/acf656d540a82e6fc30421590305cfe295eabbb5"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 1,
      "deletions": 1
    },
    "files": [
      {
        "sha": "95c5a99c1b065d73d44928390dece43ee1a76fe2",
        "filename": "src/test/fuzz/addrman.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/57ce20307e604530f78ef4f0f8d9fb94f80ca81b/src/test/fuzz/addrman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/57ce20307e604530f78ef4f0f8d9fb94f80ca81b/src/test/fuzz/addrman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/fuzz/addrman.cpp?ref=57ce20307e604530f78ef4f0f8d9fb94f80ca81b",
        "patch": "@@ -85,7 +85,7 @@ class CAddrManDeterministic : public CAddrMan\n         // 0, 1, 2, 3 corresponding to 0%, 100%, 50%, 33%\n         const size_t n = m_fuzzed_data_provider.ConsumeIntegralInRange<size_t>(0, 3);\n \n-        const size_t num_sources = m_fuzzed_data_provider.ConsumeIntegralInRange<size_t>(10, 50);\n+        const size_t num_sources = m_fuzzed_data_provider.ConsumeIntegralInRange<size_t>(1, 50);\n         CNetAddr prev_source;\n         // Use insecure_rand inside the loops instead of m_fuzzed_data_provider because when\n         // the latter is exhausted it just returns 0."
      }
    ]
  }
]