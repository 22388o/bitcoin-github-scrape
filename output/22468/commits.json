[
  {
    "sha": "8c8cd363294e1914e1ea9a83a5147f87146b612a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4YzhjZDM2MzI5NGUxOTE0ZTFlYTlhODNhNTE0N2Y4NzE0NmI2MTJh",
    "commit": {
      "author": {
        "name": "Vasil Dimov",
        "email": "vd@FreeBSD.org",
        "date": "2021-07-16T10:09:48Z"
      },
      "committer": {
        "name": "Vasil Dimov",
        "email": "vd@FreeBSD.org",
        "date": "2021-07-16T10:38:09Z"
      },
      "message": "addrman: don't overwrite addr_info when resetting I2P ports\n\nIn `CAddrMan::ResetI2PPorts()` we copy `addr_info` to\n`addr_info_newport`, change the `port` in the latter and eventually, if\nnecessary, we overwrite `addr_info` with `addr_info_newport`.\n\nThe problem is that after creating the copy, `addr_info.nRandomPos` may\nbe changed by `ClearNew() -> Delete() -> SwapRandom()`. Later,\noverwriting the entire `addr_info` with the stale `addr_info_newport`\nwould restore the previous/stale `nRandomPos`.\n\nTo fix that change just the port in `addr_info`.\n\nFixes https://github.com/bitcoin/bitcoin/issues/22467",
      "tree": {
        "sha": "e7343ac157a16f43869953df12e6a6abcad39b5e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e7343ac157a16f43869953df12e6a6abcad39b5e"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8c8cd363294e1914e1ea9a83a5147f87146b612a",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQQzBAABCAAdFiEE5k2NRWFNsHVF2czBVN8G9ktVy78FAmDxYaEACgkQVN8G9ktV\ny797Dx/7B8B9OF2SG4Ttb1guqYUeixKgCONOS8ogy60YToDRAjJR1wwK/0+M4izm\n6W4O/UrxGj+71D6MbRlbFudggAgIg2HXhu4TtahijZPoI11kJYHbzu4YbkBL7tjR\n4CgZGDjQ42RvsWy2dB2Jqrpuxqk1unml5Lj+8ceO9Mg4o1IzcbbG/NjXPUnacyaG\nkucHa2nvm2HU/i2qPNgQBQo9FzpVb22pdskTgOAe7mVle34sk6i0pF8J4gcgl1yt\njTf1iueQ09o+AwjtCfrDxff6PCB/XWGi5llEXt848ddxzAY31qJklK3pXZ00axVF\neyryC3hbEH3gxMJ5Yy4FcbUSu1JjXvT6jUWJ7h9pdzZpeCKq3yak4qzdFy8n0Mas\nLcha75/Fut3Rr7jy1gehLHZbIY66RGTR5UXpwE9ElaeyXldEEDoKikX4RUcRF6a7\nh2S/ScONchQ0hIwPC5Vbkt1uXzomuCyvPUAwBstlhssRwQ8ifO+BqwG5oiQqhDqn\n3v9R0u879ksFiPqd480qTjaAmPJvsCccBXN7PYXhPZko2BjABG4ozNBq0itivWgV\nhu0FLScJxKlN2y1TSVVWhtqRes6l83SQQmmFR5mI381DO3YsiJ5vlui/jjmecbss\n/9sc/eV59jZNOBefIpsSew6MRDWBCSMaIQ4L9U+HM9UaQY3XZGQCqIDptk900a8e\n540tfQvKYQto4P88bn/gjetByDaXRJpYOTwTVauPt5u9bUL/R8kwda9uOVjfhinV\n32sJKVOW7LU0PFm7i/+QkjzBgf9X2C08g5eOYefmR31yLRjhYSc98Jb6F2wU8TBB\n837vOrw/aAba5g0YcrGqOcNEBQw3kdRjEmMcDtwuY29HxS55432ai2diq+LjNCQ5\nTTfYWnRxhHW0NFPGFQOGQHTavZmy3q+I2lkdy1YEvimp/R7peq+7qap4zEJV/z97\nWk2Bc3lUm3VFe5Pppzh5lcb0xD/td1RrMvgA0L7dXfHelnxYWkMaOLeq9V9bHTuh\nCCPPJkUHLRpQc/FttoLUYWmSNC3sSUVOTqdy9gB3wbdl5dAB7P/dpOEfMWTRVMoO\nGqm336keM+zp59ljk1vFHWM9iXqcP9URYVvvZWxXEHhnCnXQj5RmAikhKDCvdCSb\na299yhQSf7uIo7k72SjweR4XnCnbQmuh2eX+bqd4RIU3LH/kPpl52Wv+bSg0Hc++\nRj7E2ep/hiHQPK6gf0uFGgQ61bdHw3RWmUt2RfMoJE+ctxArJqdiP2tu71IDoD7l\ngXywX6Hw7WEl9mhiBugQHlvycJdKHzuXPUSsdfDO15B/JwJ7W3j2RmEQurYAULzG\nhqdxUhzaaglgztG5ooJERHoW+nZbGw==\n=LvPH\n-----END PGP SIGNATURE-----",
        "payload": "tree e7343ac157a16f43869953df12e6a6abcad39b5e\nparent f8b20fd35b0eb42d28afb302a070e5d9bc21a99f\nauthor Vasil Dimov <vd@FreeBSD.org> 1626430188 +0200\ncommitter Vasil Dimov <vd@FreeBSD.org> 1626431889 +0200\n\naddrman: don't overwrite addr_info when resetting I2P ports\n\nIn `CAddrMan::ResetI2PPorts()` we copy `addr_info` to\n`addr_info_newport`, change the `port` in the latter and eventually, if\nnecessary, we overwrite `addr_info` with `addr_info_newport`.\n\nThe problem is that after creating the copy, `addr_info.nRandomPos` may\nbe changed by `ClearNew() -> Delete() -> SwapRandom()`. Later,\noverwriting the entire `addr_info` with the stale `addr_info_newport`\nwould restore the previous/stale `nRandomPos`.\n\nTo fix that change just the port in `addr_info`.\n\nFixes https://github.com/bitcoin/bitcoin/issues/22467\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8c8cd363294e1914e1ea9a83a5147f87146b612a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/8c8cd363294e1914e1ea9a83a5147f87146b612a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8c8cd363294e1914e1ea9a83a5147f87146b612a/comments",
    "author": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f8b20fd35b0eb42d28afb302a070e5d9bc21a99f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f8b20fd35b0eb42d28afb302a070e5d9bc21a99f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f8b20fd35b0eb42d28afb302a070e5d9bc21a99f"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 2,
      "deletions": 2
    },
    "files": [
      {
        "sha": "61650bb1e487dcc1b03497de9686b6e18be49ceb",
        "filename": "src/addrman.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8c8cd363294e1914e1ea9a83a5147f87146b612a/src/addrman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8c8cd363294e1914e1ea9a83a5147f87146b612a/src/addrman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/addrman.cpp?ref=8c8cd363294e1914e1ea9a83a5147f87146b612a",
        "patch": "@@ -771,7 +771,7 @@ void CAddrMan::ResetI2PPorts()\n             ClearNew(bucket, i_target);\n             vvNew[bucket][i_target] = id;\n             vvNew[bucket][i] = -1;\n-            addr_info = addr_info_newport;\n+            addr_info.port = I2P_SAM31_PORT;\n         }\n     }\n \n@@ -825,7 +825,7 @@ void CAddrMan::ResetI2PPorts()\n \n             vvTried[bucket_target][i_target] = id;\n             vvTried[bucket][i] = -1;\n-            addr_info = addr_info_newport;\n+            addr_info.port = I2P_SAM31_PORT;\n         }\n     }\n }"
      }
    ]
  },
  {
    "sha": "84b624ec83c3d6528ce82fe37bdc4cdc5ecb9e47",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4NGI2MjRlYzgzYzNkNjUyOGNlODJmZTM3YmRjNGNkYzVlY2I5ZTQ3",
    "commit": {
      "author": {
        "name": "Vasil Dimov",
        "email": "vd@FreeBSD.org",
        "date": "2021-07-16T10:20:14Z"
      },
      "committer": {
        "name": "Vasil Dimov",
        "email": "vd@FreeBSD.org",
        "date": "2021-07-16T10:38:25Z"
      },
      "message": "addrman: simplify ResetI2PPorts() by removing addr_info_newport\n\nIt is not necessary to have a separate variable `addr_info_newport`, we\ncan directly change the port in `addr_info`.",
      "tree": {
        "sha": "97b732960d2cc114e48d12f37217db4421076595",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/97b732960d2cc114e48d12f37217db4421076595"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/84b624ec83c3d6528ce82fe37bdc4cdc5ecb9e47",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQQzBAABCAAdFiEE5k2NRWFNsHVF2czBVN8G9ktVy78FAmDxYaIACgkQVN8G9ktV\ny7/khB//Q3sftargOSUqvCB9CzEJoUTUtVSwoYosH9w9DApgtmWSgWEDpCQSGCC4\nUjvMZHEQvnh9q7YkHuuY9OVtlFFiweI0I6VBmHvUtzX2IcXKGIvRAfZbV/ADhcyy\nr8AnH3eCI+olk5CV73ThUKB9hB4+0r33iU1RRAenjmfhrf3QZUfn4PIfVQnOPs7j\nQo/dagsQeOOb+yrdVw8OJJbebKWkCzGMuWiNqmPpQq4/y/OT+DsFpDY+Bjd2qosH\nJ/NQ/1UKthwXyqPD0ufl9rQs1Y511viNk+vWmicWZYS96XpgAMrk2sEVlJZVBLGq\n0pZkcGz5BUPPeHfNcTCu2tDtpDiAhdDhdhd8JyQ6Eu0yokqbLwrIy6ddllq7Pth6\n1rYP1u4nG0rdoUk6ws+R17z93euQNYNl7BBzzNaqAqzwvSpHSzwpVsxB5EK2BZ3n\nnKsgX0PDny3Qo3ug6cGMiZ0Q6F63eZMtZz6+V90TRjsxbVS0e1zqnddZleiKDy5j\nrUF9nTJBw0/EWO95Owe2ui1MLwA2PFnNT2STVZcS0UI45JqB/OzTpabOjF+tnaOP\nZFK8Ja2gdpHT7pDva8mK6amuF63pB6lkZbnRc9RvgNHBIeK8exvNpoTrfW8JSQEG\nv3LlXLvzsRgwfKkuh50o5fLc9e1j/1pqfRU7mzbYE7cm22NfcmKA8f2TNaSI7Scr\nlfNKPXrrjz8DcZZ/P46xivVVtjLdDM7znKVpWf6w5FeeXZUH97swqtCHSRoW8+GD\nQRFV3JtZs8AKyZ987tlox5qZEP+HFds1GGisYqsXzHGUVvOAhgQnlAxBs6JJZg47\nymUKj9ZnMoaIaYm/v/zxBHnGhCTRqiUgS26a2BjafrWm6KCOs2Lc0OmbXIRMXg1p\nLf+LRQzRW3XTowib2Cboeb6BiNpVFLy3FQD2y+avH0aO9T1p7+LCh0Eg9CaFpfc7\nocQRHSAfuoaI1PjDBwFXgL1SrKVxVRvFxCpGEloJ1QwRXvCvy4zT4oKDIv9iIFEu\nBN87+U+4W9Me3sZc1KpxPkkfve5hS5sEKLi4GDWwjfjKCL8MjD0A683OTLGYcEB0\nLbNxJ+SlzAZn6c5S5+aaEt87WitVw7E/471X1DDkWl+CTtJeyuHZMbVAOfDVJvEa\ncHnbc5CxnfjHj6Kvc9sI9mcF6UMRNMpU+ozjLcBELjK8tAyvT6/wPVeRnbUc2uq8\n4tOpY8n9TRlOcS1SYHwo1jYmbMvP+p5aYZj3xX9BqOko4oLfKLP9YhkP8rLnVw8E\nHEglBUeSoUIVECUpx4Ff5fZw6dXaROovX4Ikz3eKUAhlSZpqBQBga2khHsWi0O+f\nzl0X1pS09+AxdStQNCWAoUTlm7ivTw==\n=PhUI\n-----END PGP SIGNATURE-----",
        "payload": "tree 97b732960d2cc114e48d12f37217db4421076595\nparent 8c8cd363294e1914e1ea9a83a5147f87146b612a\nauthor Vasil Dimov <vd@FreeBSD.org> 1626430814 +0200\ncommitter Vasil Dimov <vd@FreeBSD.org> 1626431905 +0200\n\naddrman: simplify ResetI2PPorts() by removing addr_info_newport\n\nIt is not necessary to have a separate variable `addr_info_newport`, we\ncan directly change the port in `addr_info`.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/84b624ec83c3d6528ce82fe37bdc4cdc5ecb9e47",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/84b624ec83c3d6528ce82fe37bdc4cdc5ecb9e47",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/84b624ec83c3d6528ce82fe37bdc4cdc5ecb9e47/comments",
    "author": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "8c8cd363294e1914e1ea9a83a5147f87146b612a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8c8cd363294e1914e1ea9a83a5147f87146b612a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/8c8cd363294e1914e1ea9a83a5147f87146b612a"
      }
    ],
    "stats": {
      "total": 20,
      "additions": 7,
      "deletions": 13
    },
    "files": [
      {
        "sha": "2ab8260b5d859355ced002a53cbaa02b28822089",
        "filename": "src/addrman.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 13,
        "changes": 20,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/84b624ec83c3d6528ce82fe37bdc4cdc5ecb9e47/src/addrman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/84b624ec83c3d6528ce82fe37bdc4cdc5ecb9e47/src/addrman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/addrman.cpp?ref=84b624ec83c3d6528ce82fe37bdc4cdc5ecb9e47",
        "patch": "@@ -750,28 +750,25 @@ void CAddrMan::ResetI2PPorts()\n                 continue;\n             }\n \n-            auto addr_info_newport = addr_info;\n-            // The below changes addr_info_newport.GetKey(), which is used in finding a\n+            // The below changes addr_info.GetKey(), which is used in finding a\n             // bucket and a position within that bucket. So a re-bucketing may be necessary.\n-            addr_info_newport.port = I2P_SAM31_PORT;\n+            addr_info.port = I2P_SAM31_PORT;\n \n             // Reposition entries of vvNew within the same bucket because we don't know the source\n             // address which led to the decision to store the entry in vvNew[bucket] so we can't\n             // re-evaluate that decision, but even if we could, CAddrInfo::GetNewBucket() does not\n             // use CAddrInfo::GetKey() so it would end up in the same bucket as before the port\n             // change.\n-            const auto i_target = addr_info_newport.GetBucketPosition(nKey, true, bucket);\n+            const auto i_target = addr_info.GetBucketPosition(nKey, true, bucket);\n \n             if (i_target == i) { // No need to re-position.\n-                addr_info = addr_info_newport;\n                 continue;\n             }\n \n             // Reposition from i to i_target, removing the entry from i_target (if any).\n             ClearNew(bucket, i_target);\n             vvNew[bucket][i_target] = id;\n             vvNew[bucket][i] = -1;\n-            addr_info.port = I2P_SAM31_PORT;\n         }\n     }\n \n@@ -790,16 +787,14 @@ void CAddrMan::ResetI2PPorts()\n                 continue;\n             }\n \n-            auto addr_info_newport = addr_info;\n-            // The below changes addr_info_newport.GetKey(), which is used in finding a\n+            // The below changes addr_info.GetKey(), which is used in finding a\n             // bucket and a position within that bucket. So a re-bucketing may be necessary.\n-            addr_info_newport.port = I2P_SAM31_PORT;\n+            addr_info.port = I2P_SAM31_PORT;\n \n-            const auto bucket_target = addr_info_newport.GetTriedBucket(nKey, m_asmap);\n-            const auto i_target = addr_info_newport.GetBucketPosition(nKey, false, bucket_target);\n+            const auto bucket_target = addr_info.GetTriedBucket(nKey, m_asmap);\n+            const auto i_target = addr_info.GetBucketPosition(nKey, false, bucket_target);\n \n             if (bucket_target == bucket && i_target == i) { // No need to re-position.\n-                addr_info = addr_info_newport;\n                 continue;\n             }\n \n@@ -825,7 +820,6 @@ void CAddrMan::ResetI2PPorts()\n \n             vvTried[bucket_target][i_target] = id;\n             vvTried[bucket][i] = -1;\n-            addr_info.port = I2P_SAM31_PORT;\n         }\n     }\n }"
      }
    ]
  }
]