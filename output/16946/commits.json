[
  {
    "sha": "a8334f7ac39532528c5f8bd3b0eea05aa63e8794",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphODMzNGY3YWMzOTUzMjUyOGM1ZjhiZDNiMGVlYTA1YWE2M2U4Nzk0",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2019-09-23T22:10:13Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-01-30T19:42:50Z"
      },
      "message": "Read and write a checksum for encrypted keys",
      "tree": {
        "sha": "b10658788c466183e2652de0dfce52024128eef1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b10658788c466183e2652de0dfce52024128eef1"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a8334f7ac39532528c5f8bd3b0eea05aa63e8794",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a8334f7ac39532528c5f8bd3b0eea05aa63e8794",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a8334f7ac39532528c5f8bd3b0eea05aa63e8794",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a8334f7ac39532528c5f8bd3b0eea05aa63e8794/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "3b69310beb172b2b56fbfc38c45898a1b627ac54",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3b69310beb172b2b56fbfc38c45898a1b627ac54",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/3b69310beb172b2b56fbfc38c45898a1b627ac54"
      }
    ],
    "stats": {
      "total": 17,
      "additions": 16,
      "deletions": 1
    },
    "files": [
      {
        "sha": "098047bb398834e5d6911b1ac9deb7d7ef26c173",
        "filename": "src/wallet/walletdb.cpp",
        "status": "modified",
        "additions": 16,
        "deletions": 1,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a8334f7ac39532528c5f8bd3b0eea05aa63e8794/src/wallet/walletdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a8334f7ac39532528c5f8bd3b0eea05aa63e8794/src/wallet/walletdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.cpp?ref=a8334f7ac39532528c5f8bd3b0eea05aa63e8794",
        "patch": "@@ -109,7 +109,11 @@ bool WalletBatch::WriteCryptedKey(const CPubKey& vchPubKey,\n         return false;\n     }\n \n-    if (!WriteIC(std::make_pair(DBKeys::CRYPTED_KEY, vchPubKey), vchCryptedSecret, false)) {\n+    // Compute a checksum of the encrypted key\n+    uint256 checksum = Hash(vchCryptedSecret.begin(), vchCryptedSecret.end());\n+\n+    const auto key = std::make_pair(DBKeys::CRYPTED_KEY, vchPubKey);\n+    if (!WriteIC(key, std::make_pair(vchCryptedSecret, checksum), false)) {\n         return false;\n     }\n     EraseIC(std::make_pair(DBKeys::KEY, vchPubKey));\n@@ -332,6 +336,17 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             }\n             std::vector<unsigned char> vchPrivKey;\n             ssValue >> vchPrivKey;\n+\n+            // Get the checksum and check it\n+            if (!ssValue.eof()) {\n+                uint256 checksum;\n+                ssValue >> checksum;\n+                if (Hash(vchPrivKey.begin(), vchPrivKey.end()) != checksum) {\n+                    strErr = \"Error reading wallet database: Crypted key corrupt\";\n+                    return false;\n+                }\n+            }\n+\n             wss.nCKeys++;\n \n             if (!pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadCryptedKey(vchPubKey, vchPrivKey))"
      }
    ]
  },
  {
    "sha": "c9a9ddb4142af0af5f7b1a5ccd13f8e585007089",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjOWE5ZGRiNDE0MmFmMGFmNWY3YjFhNWNjZDEzZjhlNTg1MDA3MDg5",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2019-12-03T23:57:51Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-01-30T19:44:22Z"
      },
      "message": "Set fDecryptionThoroughlyChecked based on whether crypted key checksums are valid\n\nChange fDecryptionThoroughlyChecked to default to true so that it can\nlatch to false when an invalid checksum is seen. Checksums may be invalid\nif the wallet does not have checksums or if the wallet became corrupted.\n\nIt is safe to default fDecryptionThoroughlyChecked to true because any\nexisting wallet without a checksum will set it to false. Any new or\nblank wallet where encrypted keys are added will then set this to true\nwhen the first encrypted key is generated by virtue of CheckDecryptionKey\ndoing that during the initial Unlock prior to keys being added.",
      "tree": {
        "sha": "e6570eabfc96853d638b489427873820cc9cdc9e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e6570eabfc96853d638b489427873820cc9cdc9e"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c9a9ddb4142af0af5f7b1a5ccd13f8e585007089",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c9a9ddb4142af0af5f7b1a5ccd13f8e585007089",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c9a9ddb4142af0af5f7b1a5ccd13f8e585007089",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c9a9ddb4142af0af5f7b1a5ccd13f8e585007089/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "a8334f7ac39532528c5f8bd3b0eea05aa63e8794",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a8334f7ac39532528c5f8bd3b0eea05aa63e8794",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/a8334f7ac39532528c5f8bd3b0eea05aa63e8794"
      }
    ],
    "stats": {
      "total": 16,
      "additions": 11,
      "deletions": 5
    },
    "files": [
      {
        "sha": "6d65d6f69d1791439a0062607d48b6c34bf73dc1",
        "filename": "src/wallet/scriptpubkeyman.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 1,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c9a9ddb4142af0af5f7b1a5ccd13f8e585007089/src/wallet/scriptpubkeyman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c9a9ddb4142af0af5f7b1a5ccd13f8e585007089/src/wallet/scriptpubkeyman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.cpp?ref=c9a9ddb4142af0af5f7b1a5ccd13f8e585007089",
        "patch": "@@ -643,8 +643,13 @@ bool LegacyScriptPubKeyMan::AddKeyPubKeyInner(const CKey& key, const CPubKey &pu\n     return true;\n }\n \n-bool LegacyScriptPubKeyMan::LoadCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret)\n+bool LegacyScriptPubKeyMan::LoadCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret, bool checksum_valid)\n {\n+    // Set fDecryptionThoroughlyChecked to false when the checksum is invalid\n+    if (!checksum_valid) {\n+        fDecryptionThoroughlyChecked = false;\n+    }\n+\n     return AddCryptedKeyInner(vchPubKey, vchCryptedSecret);\n }\n "
      },
      {
        "sha": "176743322d32f2c14463df6baf747bf3be149375",
        "filename": "src/wallet/scriptpubkeyman.h",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c9a9ddb4142af0af5f7b1a5ccd13f8e585007089/src/wallet/scriptpubkeyman.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c9a9ddb4142af0af5f7b1a5ccd13f8e585007089/src/wallet/scriptpubkeyman.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.h?ref=c9a9ddb4142af0af5f7b1a5ccd13f8e585007089",
        "patch": "@@ -229,7 +229,7 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n {\n private:\n     //! keeps track of whether Unlock has run a thorough check before\n-    bool fDecryptionThoroughlyChecked = false;\n+    bool fDecryptionThoroughlyChecked = true;\n \n     using WatchOnlySet = std::set<CScript>;\n     using WatchKeyMap = std::map<CKeyID, CPubKey>;\n@@ -365,7 +365,7 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n     //! Adds an encrypted key to the store, and saves it to disk.\n     bool AddCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret);\n     //! Adds an encrypted key to the store, without saving it to disk (used by LoadWallet)\n-    bool LoadCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret);\n+    bool LoadCryptedKey(const CPubKey &vchPubKey, const std::vector<unsigned char> &vchCryptedSecret, bool checksum_valid);\n     void UpdateTimeFirstKey(int64_t nCreateTime) EXCLUSIVE_LOCKS_REQUIRED(cs_KeyStore);\n     //! Adds a CScript to the store\n     bool LoadCScript(const CScript& redeemScript);"
      },
      {
        "sha": "ab1ad1a64a741827f63649dcffac8562ca130a10",
        "filename": "src/wallet/walletdb.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 2,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c9a9ddb4142af0af5f7b1a5ccd13f8e585007089/src/wallet/walletdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c9a9ddb4142af0af5f7b1a5ccd13f8e585007089/src/wallet/walletdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.cpp?ref=c9a9ddb4142af0af5f7b1a5ccd13f8e585007089",
        "patch": "@@ -338,18 +338,19 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssValue >> vchPrivKey;\n \n             // Get the checksum and check it\n+            bool checksum_valid = false;\n             if (!ssValue.eof()) {\n                 uint256 checksum;\n                 ssValue >> checksum;\n-                if (Hash(vchPrivKey.begin(), vchPrivKey.end()) != checksum) {\n+                if ((checksum_valid = Hash(vchPrivKey.begin(), vchPrivKey.end()) != checksum)) {\n                     strErr = \"Error reading wallet database: Crypted key corrupt\";\n                     return false;\n                 }\n             }\n \n             wss.nCKeys++;\n \n-            if (!pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadCryptedKey(vchPubKey, vchPrivKey))\n+            if (!pwallet->GetOrCreateLegacyScriptPubKeyMan()->LoadCryptedKey(vchPubKey, vchPrivKey, checksum_valid))\n             {\n                 strErr = \"Error reading wallet database: LegacyScriptPubKeyMan::LoadCryptedKey failed\";\n                 return false;"
      }
    ]
  },
  {
    "sha": "d67055e00dd90f504384e5c3f229fc95306d5aac",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkNjcwNTVlMDBkZDkwZjUwNDM4NGU1YzNmMjI5ZmM5NTMwNmQ1YWFj",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2019-12-04T00:06:15Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-01-30T19:44:22Z"
      },
      "message": "Upgrade or rewrite encrypted key checksums\n\nIf fDecryptionThoroughlyChecked is false, after a key has been checked,\nwrite (or rewrite) its checksum. This serves to upgrade wallets\nand correct those which have the checksum corrupted but not the key.",
      "tree": {
        "sha": "1b6ff06857f4c26191e4499f766a934e0f3efaa1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1b6ff06857f4c26191e4499f766a934e0f3efaa1"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d67055e00dd90f504384e5c3f229fc95306d5aac",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d67055e00dd90f504384e5c3f229fc95306d5aac",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/d67055e00dd90f504384e5c3f229fc95306d5aac",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d67055e00dd90f504384e5c3f229fc95306d5aac/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c9a9ddb4142af0af5f7b1a5ccd13f8e585007089",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c9a9ddb4142af0af5f7b1a5ccd13f8e585007089",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c9a9ddb4142af0af5f7b1a5ccd13f8e585007089"
      }
    ],
    "stats": {
      "total": 14,
      "additions": 13,
      "deletions": 1
    },
    "files": [
      {
        "sha": "fba2bf73108d1b863a0fee0a0afea44294304156",
        "filename": "src/wallet/scriptpubkeyman.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d67055e00dd90f504384e5c3f229fc95306d5aac/src/wallet/scriptpubkeyman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d67055e00dd90f504384e5c3f229fc95306d5aac/src/wallet/scriptpubkeyman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.cpp?ref=d67055e00dd90f504384e5c3f229fc95306d5aac",
        "patch": "@@ -210,6 +210,7 @@ bool LegacyScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key\n         bool keyPass = mapCryptedKeys.empty(); // Always pass when there are no encrypted keys\n         bool keyFail = false;\n         CryptedKeyMap::const_iterator mi = mapCryptedKeys.begin();\n+        WalletBatch batch(m_storage.GetDatabase());\n         for (; mi != mapCryptedKeys.end(); ++mi)\n         {\n             const CPubKey &vchPubKey = (*mi).second.first;\n@@ -223,6 +224,10 @@ bool LegacyScriptPubKeyMan::CheckDecryptionKey(const CKeyingMaterial& master_key\n             keyPass = true;\n             if (fDecryptionThoroughlyChecked)\n                 break;\n+            else {\n+                // Rewrite these encrypted keys with checksums\n+                batch.WriteCryptedKey(vchPubKey, vchCryptedSecret, mapKeyMetadata[vchPubKey.GetID()]);\n+            }\n         }\n         if (keyPass && keyFail)\n         {"
      },
      {
        "sha": "6cb8c720f031a90119992c96ee7983f8063ec9bb",
        "filename": "src/wallet/walletdb.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 1,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d67055e00dd90f504384e5c3f229fc95306d5aac/src/wallet/walletdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d67055e00dd90f504384e5c3f229fc95306d5aac/src/wallet/walletdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.cpp?ref=d67055e00dd90f504384e5c3f229fc95306d5aac",
        "patch": "@@ -114,7 +114,14 @@ bool WalletBatch::WriteCryptedKey(const CPubKey& vchPubKey,\n \n     const auto key = std::make_pair(DBKeys::CRYPTED_KEY, vchPubKey);\n     if (!WriteIC(key, std::make_pair(vchCryptedSecret, checksum), false)) {\n-        return false;\n+        // It may already exist, so try writing just the checksum\n+        std::vector<unsigned char> val;\n+        if (!m_batch.Read(key, val)) {\n+            return false;\n+        }\n+        if (!WriteIC(key, std::make_pair(val, checksum), true)) {\n+            return false;\n+        }\n     }\n     EraseIC(std::make_pair(DBKeys::KEY, vchPubKey));\n     return true;"
      }
    ]
  }
]