[
  {
    "sha": "7ba1e839bc7d8aa6445871a74f5ebedb20834e99",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3YmExZTgzOWJjN2Q4YWE2NDQ1ODcxYTc0ZjVlYmVkYjIwODM0ZTk5",
    "commit": {
      "author": {
        "name": "Patick Strateman",
        "email": "patrick.strateman@gmail.com",
        "date": "2015-11-20T02:12:26Z"
      },
      "committer": {
        "name": "Patick Strateman",
        "email": "patrick.strateman@gmail.com",
        "date": "2015-11-20T02:12:26Z"
      },
      "message": "Rename pwalletdbEncryption to pwalletdb.",
      "tree": {
        "sha": "6f3c4454cfe9a4c0c3fc4744bd3106103d4abacc",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6f3c4454cfe9a4c0c3fc4744bd3106103d4abacc"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7ba1e839bc7d8aa6445871a74f5ebedb20834e99",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7ba1e839bc7d8aa6445871a74f5ebedb20834e99",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/7ba1e839bc7d8aa6445871a74f5ebedb20834e99",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7ba1e839bc7d8aa6445871a74f5ebedb20834e99/comments",
    "author": {
      "login": "pstratem",
      "id": 620611,
      "node_id": "MDQ6VXNlcjYyMDYxMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/620611?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pstratem",
      "html_url": "https://github.com/pstratem",
      "followers_url": "https://api.github.com/users/pstratem/followers",
      "following_url": "https://api.github.com/users/pstratem/following{/other_user}",
      "gists_url": "https://api.github.com/users/pstratem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pstratem/subscriptions",
      "organizations_url": "https://api.github.com/users/pstratem/orgs",
      "repos_url": "https://api.github.com/users/pstratem/repos",
      "events_url": "https://api.github.com/users/pstratem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pstratem/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "pstratem",
      "id": 620611,
      "node_id": "MDQ6VXNlcjYyMDYxMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/620611?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pstratem",
      "html_url": "https://github.com/pstratem",
      "followers_url": "https://api.github.com/users/pstratem/followers",
      "following_url": "https://api.github.com/users/pstratem/following{/other_user}",
      "gists_url": "https://api.github.com/users/pstratem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pstratem/subscriptions",
      "organizations_url": "https://api.github.com/users/pstratem/orgs",
      "repos_url": "https://api.github.com/users/pstratem/repos",
      "events_url": "https://api.github.com/users/pstratem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pstratem/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "73fa5e604356ab4182971376fd758b4680737b5a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/73fa5e604356ab4182971376fd758b4680737b5a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/73fa5e604356ab4182971376fd758b4680737b5a"
      }
    ],
    "stats": {
      "total": 38,
      "additions": 19,
      "deletions": 19
    },
    "files": [
      {
        "sha": "30d3831e36e59599dcb7515604839adb0237071c",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 15,
        "deletions": 15,
        "changes": 30,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7ba1e839bc7d8aa6445871a74f5ebedb20834e99/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7ba1e839bc7d8aa6445871a74f5ebedb20834e99/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=7ba1e839bc7d8aa6445871a74f5ebedb20834e99",
        "patch": "@@ -137,8 +137,8 @@ bool CWallet::AddCryptedKey(const CPubKey &vchPubKey,\n         return true;\n     {\n         LOCK(cs_wallet);\n-        if (pwalletdbEncryption)\n-            return pwalletdbEncryption->WriteCryptedKey(vchPubKey,\n+        if (pwalletdb)\n+            return pwalletdb->WriteCryptedKey(vchPubKey,\n                                                         vchCryptedSecret,\n                                                         mapKeyMetadata[vchPubKey.GetID()]);\n         else\n@@ -524,41 +524,41 @@ bool CWallet::EncryptWallet(const SecureString& strWalletPassphrase)\n         mapMasterKeys[++nMasterKeyMaxID] = kMasterKey;\n         if (fFileBacked)\n         {\n-            assert(!pwalletdbEncryption);\n-            pwalletdbEncryption = new CWalletDB(strWalletFile);\n-            if (!pwalletdbEncryption->TxnBegin()) {\n-                delete pwalletdbEncryption;\n-                pwalletdbEncryption = NULL;\n+            assert(!pwalletdb);\n+            pwalletdb = new CWalletDB(strWalletFile);\n+            if (!pwalletdb->TxnBegin()) {\n+                delete pwalletdb;\n+                pwalletdb = NULL;\n                 return false;\n             }\n-            pwalletdbEncryption->WriteMasterKey(nMasterKeyMaxID, kMasterKey);\n+            pwalletdb->WriteMasterKey(nMasterKeyMaxID, kMasterKey);\n         }\n \n         if (!EncryptKeys(vMasterKey))\n         {\n             if (fFileBacked) {\n-                pwalletdbEncryption->TxnAbort();\n-                delete pwalletdbEncryption;\n+                pwalletdb->TxnAbort();\n+                delete pwalletdb;\n             }\n             // We now probably have half of our keys encrypted in memory, and half not...\n             // die and let the user reload the unencrypted wallet.\n             assert(false);\n         }\n \n         // Encryption was introduced in version 0.4.0\n-        SetMinVersion(FEATURE_WALLETCRYPT, pwalletdbEncryption, true);\n+        SetMinVersion(FEATURE_WALLETCRYPT, pwalletdb, true);\n \n         if (fFileBacked)\n         {\n-            if (!pwalletdbEncryption->TxnCommit()) {\n-                delete pwalletdbEncryption;\n+            if (!pwalletdb->TxnCommit()) {\n+                delete pwalletdb;\n                 // We now have keys encrypted in memory, but not on disk...\n                 // die to avoid confusion and let the user reload the unencrypted wallet.\n                 assert(false);\n             }\n \n-            delete pwalletdbEncryption;\n-            pwalletdbEncryption = NULL;\n+            delete pwalletdb;\n+            pwalletdb = NULL;\n         }\n \n         Lock();"
      },
      {
        "sha": "f509f375b93279dabe701f34e7da832387b6630b",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 4,
        "deletions": 4,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7ba1e839bc7d8aa6445871a74f5ebedb20834e99/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7ba1e839bc7d8aa6445871a74f5ebedb20834e99/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=7ba1e839bc7d8aa6445871a74f5ebedb20834e99",
        "patch": "@@ -453,7 +453,7 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n      */\n     bool SelectCoins(const CAmount& nTargetValue, std::set<std::pair<const CWalletTx*,unsigned int> >& setCoinsRet, CAmount& nValueRet, const CCoinControl *coinControl = NULL) const;\n \n-    CWalletDB *pwalletdbEncryption;\n+    CWalletDB *pwalletdb;\n \n     //! the current wallet version: clients below this version are not able to load the wallet\n     int nWalletVersion;\n@@ -512,8 +512,8 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n \n     ~CWallet()\n     {\n-        delete pwalletdbEncryption;\n-        pwalletdbEncryption = NULL;\n+        delete pwalletdb;\n+        pwalletdb = NULL;\n     }\n \n     void SetNull()\n@@ -522,7 +522,7 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n         nWalletMaxVersion = FEATURE_BASE;\n         fFileBacked = false;\n         nMasterKeyMaxID = 0;\n-        pwalletdbEncryption = NULL;\n+        pwalletdb = NULL;\n         nOrderPosNext = 0;\n         nNextResend = 0;\n         nLastResend = 0;"
      }
    ]
  },
  {
    "sha": "7bc9a449fc091e8834066ccb118c0c96ad6dfd48",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3YmM5YTQ0OWZjMDkxZTg4MzQwNjZjY2IxMThjMGM5NmFkNmRmZDQ4",
    "commit": {
      "author": {
        "name": "Patick Strateman",
        "email": "patrick.strateman@gmail.com",
        "date": "2015-11-20T02:23:52Z"
      },
      "committer": {
        "name": "Patick Strateman",
        "email": "patrick.strateman@gmail.com",
        "date": "2015-11-20T02:23:52Z"
      },
      "message": "Use pwalletdb in CWallet::AddKeyPubKey if available",
      "tree": {
        "sha": "91f93d24c7643ba9636786c3568a5b78e8c66d8f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/91f93d24c7643ba9636786c3568a5b78e8c66d8f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7bc9a449fc091e8834066ccb118c0c96ad6dfd48",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7bc9a449fc091e8834066ccb118c0c96ad6dfd48",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/7bc9a449fc091e8834066ccb118c0c96ad6dfd48",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7bc9a449fc091e8834066ccb118c0c96ad6dfd48/comments",
    "author": {
      "login": "pstratem",
      "id": 620611,
      "node_id": "MDQ6VXNlcjYyMDYxMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/620611?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pstratem",
      "html_url": "https://github.com/pstratem",
      "followers_url": "https://api.github.com/users/pstratem/followers",
      "following_url": "https://api.github.com/users/pstratem/following{/other_user}",
      "gists_url": "https://api.github.com/users/pstratem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pstratem/subscriptions",
      "organizations_url": "https://api.github.com/users/pstratem/orgs",
      "repos_url": "https://api.github.com/users/pstratem/repos",
      "events_url": "https://api.github.com/users/pstratem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pstratem/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "pstratem",
      "id": 620611,
      "node_id": "MDQ6VXNlcjYyMDYxMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/620611?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pstratem",
      "html_url": "https://github.com/pstratem",
      "followers_url": "https://api.github.com/users/pstratem/followers",
      "following_url": "https://api.github.com/users/pstratem/following{/other_user}",
      "gists_url": "https://api.github.com/users/pstratem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pstratem/subscriptions",
      "organizations_url": "https://api.github.com/users/pstratem/orgs",
      "repos_url": "https://api.github.com/users/pstratem/repos",
      "events_url": "https://api.github.com/users/pstratem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pstratem/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "7ba1e839bc7d8aa6445871a74f5ebedb20834e99",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7ba1e839bc7d8aa6445871a74f5ebedb20834e99",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/7ba1e839bc7d8aa6445871a74f5ebedb20834e99"
      }
    ],
    "stats": {
      "total": 12,
      "additions": 9,
      "deletions": 3
    },
    "files": [
      {
        "sha": "3c7ed4e2baea9734bed42374e249b8dc5d0a7476",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 3,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7bc9a449fc091e8834066ccb118c0c96ad6dfd48/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7bc9a449fc091e8834066ccb118c0c96ad6dfd48/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=7bc9a449fc091e8834066ccb118c0c96ad6dfd48",
        "patch": "@@ -121,9 +121,15 @@ bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n     if (!fFileBacked)\n         return true;\n     if (!IsCrypted()) {\n-        return CWalletDB(strWalletFile).WriteKey(pubkey,\n-                                                 secret.GetPrivKey(),\n-                                                 mapKeyMetadata[pubkey.GetID()]);\n+        if (pwalletdb) {\n+            pwalletdb->WriteKey(pubkey,\n+                                 secret.GetPrivKey(),\n+                                 mapKeyMetadata[pubkey.GetID()]);\n+        } else {\n+            return CWalletDB(strWalletFile).WriteKey(pubkey,\n+                                                     secret.GetPrivKey(),\n+                                                     mapKeyMetadata[pubkey.GetID()]);\n+        }\n     }\n     return true;\n }"
      }
    ]
  },
  {
    "sha": "a4471ca9551ac6413f343c04f01700c449e31d60",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphNDQ3MWNhOTU1MWFjNjQxM2YzNDNjMDRmMDE3MDBjNDQ5ZTMxZDYw",
    "commit": {
      "author": {
        "name": "Patick Strateman",
        "email": "patrick.strateman@gmail.com",
        "date": "2015-11-20T02:26:14Z"
      },
      "committer": {
        "name": "Patick Strateman",
        "email": "patrick.strateman@gmail.com",
        "date": "2015-11-20T02:26:14Z"
      },
      "message": "Perform entire CWallet::TopUpKeyPool in a transaction.\n\nPreviously after each call to GenerateNewKey the log would be flushed\ncausing a massive performance penalty.",
      "tree": {
        "sha": "ec6a271e174f06a4f7cd88da934f9a661e21d645",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ec6a271e174f06a4f7cd88da934f9a661e21d645"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a4471ca9551ac6413f343c04f01700c449e31d60",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a4471ca9551ac6413f343c04f01700c449e31d60",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a4471ca9551ac6413f343c04f01700c449e31d60",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a4471ca9551ac6413f343c04f01700c449e31d60/comments",
    "author": {
      "login": "pstratem",
      "id": 620611,
      "node_id": "MDQ6VXNlcjYyMDYxMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/620611?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pstratem",
      "html_url": "https://github.com/pstratem",
      "followers_url": "https://api.github.com/users/pstratem/followers",
      "following_url": "https://api.github.com/users/pstratem/following{/other_user}",
      "gists_url": "https://api.github.com/users/pstratem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pstratem/subscriptions",
      "organizations_url": "https://api.github.com/users/pstratem/orgs",
      "repos_url": "https://api.github.com/users/pstratem/repos",
      "events_url": "https://api.github.com/users/pstratem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pstratem/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "pstratem",
      "id": 620611,
      "node_id": "MDQ6VXNlcjYyMDYxMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/620611?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pstratem",
      "html_url": "https://github.com/pstratem",
      "followers_url": "https://api.github.com/users/pstratem/followers",
      "following_url": "https://api.github.com/users/pstratem/following{/other_user}",
      "gists_url": "https://api.github.com/users/pstratem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pstratem/subscriptions",
      "organizations_url": "https://api.github.com/users/pstratem/orgs",
      "repos_url": "https://api.github.com/users/pstratem/repos",
      "events_url": "https://api.github.com/users/pstratem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pstratem/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "7bc9a449fc091e8834066ccb118c0c96ad6dfd48",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7bc9a449fc091e8834066ccb118c0c96ad6dfd48",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/7bc9a449fc091e8834066ccb118c0c96ad6dfd48"
      }
    ],
    "stats": {
      "total": 44,
      "additions": 28,
      "deletions": 16
    },
    "files": [
      {
        "sha": "ba6da536aee9f5c9cd939f18f86b4398cfdbfdc6",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 28,
        "deletions": 16,
        "changes": 44,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a4471ca9551ac6413f343c04f01700c449e31d60/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a4471ca9551ac6413f343c04f01700c449e31d60/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=a4471ca9551ac6413f343c04f01700c449e31d60",
        "patch": "@@ -2299,25 +2299,37 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n         if (IsLocked())\n             return false;\n \n-        CWalletDB walletdb(strWalletFile);\n-\n-        // Top up key pool\n-        unsigned int nTargetSize;\n-        if (kpSize > 0)\n-            nTargetSize = kpSize;\n-        else\n-            nTargetSize = max(GetArg(\"-keypool\", 100), (int64_t) 0);\n+        pwalletdb = new CWalletDB(strWalletFile);\n+        pwalletdb->TxnBegin();\n \n-        while (setKeyPool.size() < (nTargetSize + 1))\n+        try\n         {\n-            int64_t nEnd = 1;\n-            if (!setKeyPool.empty())\n-                nEnd = *(--setKeyPool.end()) + 1;\n-            if (!walletdb.WritePool(nEnd, CKeyPool(GenerateNewKey())))\n-                throw runtime_error(\"TopUpKeyPool(): writing generated key failed\");\n-            setKeyPool.insert(nEnd);\n-            LogPrintf(\"keypool added key %d, size=%u\\n\", nEnd, setKeyPool.size());\n+            // Top up key pool\n+            unsigned int nTargetSize;\n+            if (kpSize > 0)\n+                nTargetSize = kpSize;\n+            else\n+                nTargetSize = max(GetArg(\"-keypool\", 100), (int64_t) 0);\n+\n+            while (setKeyPool.size() < (nTargetSize + 1))\n+            {\n+                int64_t nEnd = 1;\n+                if (!setKeyPool.empty())\n+                    nEnd = *(--setKeyPool.end()) + 1;\n+                if (!pwalletdb->WritePool(nEnd, CKeyPool(GenerateNewKey())))\n+                    throw runtime_error(\"TopUpKeyPool(): writing generated key failed\");\n+                setKeyPool.insert(nEnd);\n+                LogPrintf(\"keypool added key %d, size=%u\\n\", nEnd, setKeyPool.size());\n+            }\n+        } catch(...) {\n+            pwalletdb->TxnAbort();\n+            delete pwalletdb;\n+            pwalletdb = NULL;\n+            throw;\n         }\n+        pwalletdb->TxnCommit();\n+        delete pwalletdb;\n+        pwalletdb = NULL;\n     }\n     return true;\n }"
      }
    ]
  }
]