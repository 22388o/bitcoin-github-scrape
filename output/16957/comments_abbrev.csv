jamesob,2019-09-24 19:16:46,Concept ACK. Very exciting. Will start some benchmarks tonight.,https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-534708289,534708289,
emilengler,2019-09-24 19:45:12,"Concept ACK, good found",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-534718549,534718549,
kristapsk,2019-09-24 20:04:28,Concept ACK,https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-534725323,534725323,
sipa,2019-09-24 20:10:18,"Wow, awesome.\n\nACK",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-534727322,534727322,
promag,2019-09-24 20:21:43,Little big PR! Concept ACK.,https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-534731449,534731449,
sipa,2019-09-24 20:25:28,Is it slower?,https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-534733000,534733000,
martinus,2019-09-24 20:32:13,"Yes it seems to be slower, by 1.6%. But I'm not sure how much of this is random test variation. I think the lower memory usage more than offsets this: If you increase dbcache by about 9% memory usage will be about the same as before but I'm pretty sure runtime will be faster because of better caching",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-534735646,534735646,
DrahtBot,2019-09-24 22:35:02,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#16910](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16910.html) (wallet: reduce loading time by using unorde",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-534774815,534774815,
martinus,2019-09-25 05:23:39,"I did another run with the change and `-dbcache=5471`, so I allowed more memory. The result:\n\n|                                       | runtime h:mm:ss | max RSS kbyte |\n|---------------------------------------|-----------------|--------------|\n| master -dbcache=5000                                |         4:13:59 |      7696728 |\n| noexcept -dbcache=5000 |         4:18:11 |      697141",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-534857644,534857644,
practicalswift,2019-09-25 08:12:34,"ACK 9538fce097a4acbb669e94770bce4ab8bff62031 -- diff looks correct and `SipHashUint256Extra` does not throw\n\nNice find! I believe there are similar opportunities waiting to be found: we underuse `noexcept` :)\n\nSomewhat related previous discussions about the pros/cons of `noexcept`:\n* https://github.com/bitcoin/bitcoin/pull/15926 (`tinyformat: Add format_no_throw`)\n* https://github.com/",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-534906824,534906824,
laanwj,2019-09-25 08:14:47,"ACK 9538fce097a4acbb669e94770bce4ab8bff62031, this is trivially correct, had no idea that no_except could make so much of a concrete difference in generated code.",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-534907665,534907665,
jonasschnelli,2019-09-25 08:35:41,"Nice!\nutACK 9538fce097a4acbb669e94770bce4ab8bff62031.\nShould we increase the dbcache by +~9% to not reduce the sync/reindex performance with default parameters (in this or in another PR)?",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-534915595,534915595,
jamesob,2019-09-25 14:22:56,"First bench run coincides with @martinus' findings:\n```\n-reindex-chainstate to 550,000 (dbcache=5000)\n\nbench-s      martinus/2019-09-SaltedOutp...       2:41:35    1.00  6982.89MB\nbench-s      master                               2:38:42    0.98  7469.20MB\n\non\n\nHostname:            bench-s\nKernel:              Linux 4.19.0-5-amd64\nOS:                  Debian GNU/Linux 10\nRA",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535047583,535047583,
ryanofsky,2019-09-25 14:56:33,"> when rehashing care needs to be taken. libstdc++ solves this by simply caching the hash value\n\nCurious if this applies to libc++ as well as libstdc++\n",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535063225,535063225,
MarcoFalke,2019-09-25 17:45:20,I'd prefer if the doxygen comment was extended a bit on the effects of the noexcept keyword. Maybe throw some links in there (https://gcc.gnu.org/onlinedocs/gcc-7.2.0/libstdc++/manual/manual/unordered_associative.html#containers.unordered.cache) ?,https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535133852,535133852,
jamesob,2019-09-25 18:21:25,"> Curious if this applies to libc++ as well as libstdc++\n\n@sdaftuar and I have tried reading through the [libc++ implementation of hash tables](https://github.com/llvm-mirror/libcxx/blob/master/include/__hash_table) to find the equivalent caching clause to [what's in libstdc++](https://github.com/gcc-mirror/gcc/blob/41d6b10e96a1de98e90a7c0378437c3255814b16/libstdc%2B%2B-v3/include/bits/hashtab",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535149042,535149042,
martinus,2019-09-25 18:47:52,"> I'd prefer if the doxygen comment was extended a bit on the effects of the noexcept keyword. Maybe throw some links in there (https://gcc.gnu.org/onlinedocs/gcc-7.2.0/libstdc++/manual/manual/unordered_associative.html#containers.unordered.cache) ?\n\nAh, I didn't know this was documented, thanks for the link. I've added a comment",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535159840,535159840,
jamesob,2019-09-26 14:15:17,"Tested ACK https://github.com/bitcoin/bitcoin/pull/16957/commits/67d99900b0d770038c9c5708553143137b124a6c\n\nClang results are in and they're consistent with what we've seen so far (benched IBD 500,000-535,000 at dbcache=4000).\n\n![ibd local range 500000 535000](https://user-images.githubusercontent.com/73197/65695718-0bb11d00-e046-11e9-9c49-f3ab5614dbd4.png)\n\n#### 2019-09-SaltedOutpointH",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535523126,535523126,
practicalswift,2019-09-26 15:06:00,"We should also bump the default `dbcache` to make sure IBD is not slowed down by the merge of this PR, right?",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535547897,535547897,
jamesob,2019-09-26 15:17:38,"> We should also bump the default dbcache to make sure IBD is not slowed down by the merge of this PR, right?\n\nI think that's a good idea. I'll rerun a bench comparing master:-dbcache=450 (default) and martinus:-dbcache=500 to ensure the latter undershoots the former in terms of memory usage.",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535553278,535553278,
jamesob,2019-09-26 15:21:50,"It's worth pointing out that when memory is not a limiting factor (e.g. a miner sets `-dbcache=15000` for highest possible speed), this change will impose a minor performance penalty on the order of what we've seen above (<1.6%).\n\nI still think this change is worthwhile because using `noexcept` here is the ""correct"" phrasing of this program, and the net expected performance gain is positive si",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535555181,535555181,
TheBlueMatt,2019-09-26 16:11:04,"I'm somewhat confused by the ""increase dbcache for equivalent performance"" thing - shouldn't DynamicUsage(const std::unordered_map<X, Y, Z>& m) take into account the new slightly lower memory usage and thus increase the capacity of the map? Is there some way to get the performance back with some reasonable pre-allocation of the map?",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535576273,535576273,
jamesob,2019-09-26 16:17:37,"> shouldn't DynamicUsage(const std::unordered_map<X, Y, Z>& m) take into account the new slightly lower memory usage and thus increase the capacity of the map?\n\nNah unfortunately I don't think so - because [our memusage estimator](https://github.com/bitcoin/bitcoin/blob/master/src/memusage.h#L165) optimistically assumes that each node in the hashmap consumes only as much memory as it takes to ",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535578689,535578689,
martinus,2019-09-26 16:55:57,"> I'm somewhat confused by the ""increase dbcache for equivalent performance"" thing - shouldn't DynamicUsage(const std::unordered_map<X, Y, Z>& m) take into account the new slightly lower memory usage\n\nThe problem was that DynamicMemUsage was wrong before, it underestimated memory usage. Now it's more correct. \n\nI think it might be possible to regain the performance loss by caching the hash",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535593397,535593397,
TheBlueMatt,2019-09-26 17:18:29,"Ah, I’m too tired and misread the dropping of Z there. I suppose maybe it makes sense to fix it (or note in the release notes that people may want to slightly increase their dbcache).\n\n> On Sep 26, 2019, at 09:17, jamesob <notifications@github.com> wrote:\n> \n> ﻿\n> shouldn't DynamicUsage(const std::unordered_map<X, Y, Z>& m) take into account the new slightly lower memory usage and thus increa",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535602537,535602537,
jamesob,2019-09-26 21:50:04,"Interestingly, the difference isn't pronounced near default dbcache values. This bench compares master at dbcache=450 (default) to this branch at dbcache=500. Master's runtime is 1.042x longer with this configuration. \n\nMaybe the runtime difference isn't as pronounced since this is only for a relatively small subset of the chain (35,000 blocks). In any case, it at least shows that a new dbcach",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-535699460,535699460,
laanwj,2019-09-30 07:50:57,"It seems safe to merge this for 0.19.\n\nIt's clear that there are still opportunities left for optimization in and around the UTXO hash data structure, let's look further at that for 0.20.",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-536446180,536446180,
MarcoFalke,2019-09-30 17:41:17,Does this need release notes with potential action items for node operators and/or the default bumped?,https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-536669902,536669902,
martinus,2019-09-30 19:23:47,"I'd say the default should be bumped from 450 to 500, and Node operators can increase dbcache by 10% without needing more RAM than before",https://github.com/bitcoin/bitcoin/pull/16957#issuecomment-536713463,536713463,
