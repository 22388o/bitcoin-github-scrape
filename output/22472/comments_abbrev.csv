agroce,2021-07-16 18:03:07,"Looks as if I need to add `-lstdc++fs` somewhere, perhaps, to build in all envs.  Anyone know where?",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-881623918,881623918,
MarcoFalke,2021-07-17 08:34:37,"Is this only an issue with Eclipser?\n\nIf not, can you please provide a list of the largest files/folders in that directory?\n\nLocally, I am seeing that the size stays constant, as it should be:\n\n\n```\n$ FUZZ=process_message_filteradd ./src/test/fuzz/fuzz\n```\n```\n$ du -s /tmp/test_common_Bitcoin\ Core/6d8ae75a417046414e8a64bb8398d1382b6801a363c1cd6c08512de1f63fdc38/\n17412	/tmp",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-881857527,881857527,
MarcoFalke,2021-07-17 08:35:43,"OSS-Fuzz seems to be running into the same issue: https://bugs.chromium.org/p/oss-fuzz/issues/detail?id=35027\n\n",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-881857638,881857638,
MarcoFalke,2021-07-17 11:46:39,"Also, if you want you can add Eclipser instructions to https://github.com/bitcoin/bitcoin/blob/master/doc/fuzzing.md so that it will be easier to get started with it in the future.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-881885526,881885526,
agroce,2021-07-17 13:53:55,"I haven't tried with AFL.  It may be only under rare circumstances?  But not in libFuzzer (or an AFL persist loop?)?  I'll show you a bad run later.  You end up with many (very many) entries with different hashes in the '/tmp/test_common_Bitcoin Core/` dir.   Are you saying multiple fuzz processes should use the same one?  Maybe if one is launched while another is still somehow live?\n\nYes, I p",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-881903010,881903010,
agroce,2021-07-17 14:11:57,"It looks like:\n\n```\n~/bitcoin# du -h /tmp\n18M	/tmp/test_common_Bitcoin Core/0012b9a513fd0b28db3df0331f02fcbf6a834201f7ef68173f1b8daa75dfadcc/regtest/blocks\n4.0K	/tmp/test_common_Bitcoin Core/0012b9a513fd0b28db3df0331f02fcbf6a834201f7ef68173f1b8daa75dfadcc/regtest/wallets\n18M	/tmp/test_common_Bitcoin Core/0012b9a513fd0b28db3df0331f02fcbf6a834201f7ef68173f1b8daa75dfadcc/regtest\n18M	/tm",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-881905448,881905448,
agroce,2021-07-17 14:12:43,"It seems to accumulate over time -- a single fuzz run on process_message doesn't create a new entry if one exists, or add usage.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-881905536,881905536,
agroce,2021-07-17 14:13:21,"Presumably depend on inputs to process_message, but hours of libFuzzer don't seem to cause the problem for me.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-881905593,881905593,
agroce,2021-07-17 14:18:35,"And yes, at a guess, adding and setting this will avoid what OSS-Fuzz is running into, as well.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-881906211,881906211,
MarcoFalke,2021-07-18 07:20:48,"Are there steps to reproduce?\n\nEach process should get a new directory, but the directory is cleaned once the process exits normally: https://github.com/bitcoin/bitcoin/blob/4371e635d68251202f94353aa3124d74c78f7ec9/src/test/util/setup_common.cpp#L130",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882012491,882012491,
MarcoFalke,2021-07-18 07:22:09,"So there will be plenty of leftover directories if you CTRL+C out of the process, but then the fix here wouldn't improve that either.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882012641,882012641,
agroce,2021-07-18 09:19:44,"Well, the processes are running under a fuzzer's control.  Some exit abnormally for reasons not clear, that aren't flagged as crashes.  For Eclipser these may be QEMU failures.\n\nBecause the last process may leave a non-cleaned-up directory, the next one (Eclipser/AFL may run millions) will clean itup so they don't slowly accumulate over time.\n\nRunning any fuzzer that uses a new process per",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882027101,882027101,
agroce,2021-07-18 10:01:12,"At a guess, what happens is that every 1000 or so runs die without cleaning up but without crashing.   The next run will clean up, with this set.  It's not ideal, and we should figure out the underlying solution, but it makes process-based fuzzing feasible on limited space systems.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882031823,882031823,
agroce,2021-07-18 18:35:33,"I'll add a full guide later, but I think you can reliably reproduce by installing Eclipser 1.x:\n\n```\n> git clone https://github.com/SoftSec-KAIST/Eclipser.git\n> git checkout v1.x\n> ...\n```\n\nfollowing the instructions to add dependencies, install .net (I used v2.2 iirc, but it should not matter), found here:\nhttps://github.com/SoftSec-KAIST/Eclipser/tree/v1.x\n\nand then fuzzing",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882099707,882099707,
agroce,2021-07-19 16:37:10,"Confirmed that running AFL without setting this:\n\n1.  Produces many dirs in `/tmp/test_common_Bitcoin Core`\n2. These are due to certain inputs, not crashes or timeouts of some sort, since I used plain google AFL, which terminates if a seed input dies unusually, and this was during seed execution.\n\nThe rate was 273MB, over 17 directories that did not get cleaned up, over about 6K seed inp",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882692900,882692900,
MarcoFalke,2021-07-19 16:53:22,"Good find that this doesn't reproduce with libFuzzer. OSS-Fuzz reports also ""Fuzzing Engine: afl"".\n\nOSS-Fuzz has tagged them with ""UNREPRODUCIBLE"", so I doubt the issue is with the seeds. Do you have the stdout/stderr from afl when the process exited abnormally?",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882702935,882702935,
agroce,2021-07-19 17:11:02,"Nothing ever exits abnormally.  I killed afl/eclipser after a while, and observed the extra dirs in /tmp.  Eventually, enough of these will cause src/test/fuzz/fuzz to abort with a ""no space"" message, producing spurious UNREPRODUCIBLE ""crashes.""  The only way to diagnose I see is to check which inputs cause the problem (assuming it is deterministic).  The UNREPRODUCIBLE is because the ""failing"" te",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882715237,882715237,
MarcoFalke,2021-07-19 17:31:43,"Well, *something* has to exit abnormally, unless I am misunderstanding something.\n\nThe datadir is created in the init function: https://github.com/bitcoin/bitcoin/blob/54e31742d208eb98ce706aaa6bbd4b023f42c3a5/src/test/fuzz/process_messages.cpp#L26\n\nThe `static` should keep the object around until after the process exits the `main` function normally. If the datadir is still around when it s",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882729572,882729572,
agroce,2021-07-19 17:39:57,"It's not just afl, though; it and eclipser are using very different approaches (source instrumentation via compilation, vs. QEMU on an un-instrumented binary).\n\nI should have some useful data soon.  I agree it's a mystery!",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882734507,882734507,
agroce,2021-07-19 17:55:45,"What's weird is any kind of abort/crash should stop afl corpus replay.  Eclipser does have some QEMU failures during corpu replay, but those can't affect afl...\n\nI'm scanning the QA assets now.  But it's run 1700 without seeing any ""cookie crumbs"" in /tmp, so maybe something does depend on the fuzzing process.  I'll also scan the (much larger) local corpus, in case it IS a deterministic proble",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882743895,882743895,
agroce,2021-07-19 18:12:44,"5500 without anything being left in /tmp.  Hypothesis:\n\n- nothing is wrong in bitcoin code\n- the fuzzers here (unlike libfuzzer) cause some non-crash early exits of some sort (QEMU failures will explain Eclipser, maybe afl does some kind of silent timeout/fork-server business I don't know about during corpus replay), and those prevent cleanup\n- over time this accumulates junk causing spuri",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882755361,882755361,
MarcoFalke,2021-07-19 18:14:53,"Maybe this doesn't happen during replay, but only while searching for new fuzz inputs?",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882756733,882756733,
agroce,2021-07-19 18:39:34,"it happens during corpus replay, though, with afl, I know.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882771781,882771781,
agroce,2021-07-19 18:42:57,"Ok, no crumbs in /tmp for standalone runs with no instrumentation.  Checking files I generated.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882773653,882773653,
agroce,2021-07-19 19:44:40,"Ok, 13K of my corpus inputs checked, and nothing.  It's an artifact of the fuzzers, so I'm not sure there's a way to avoid this other than something like this PR, and setting the env variable for OSS-Fuzz.  Something has to clean it up, and I'm not sure an external watchdog can even work for OSS-Fuzz.  However, OSS-Fuzz may be, as you point out, skipping fuzz.cpp's main and running AFL on the libF",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882810696,882810696,
agroce,2021-07-19 20:58:10,"Nothing.  I'll look to see if I can make this fix also fix the OSS-Fuzz issue, inside the libFuzzer signature function (just looked, and that is how afl/honggfuzz hook there, also).  I'll see if I can find a way with minimal performance impact on libFuzzer, somehow (I think a static guard to do it once per run will work for that).",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-882854049,882854049,
agroce,2021-07-20 17:38:31,"@MarcoFalke do you have any idea why trying to remove the old dirs at the start of initialization for libFuzzer breaks thatt banman assertion?  Is there initialization before that initialization, and I'm destroying it?",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-883573203,883573203,
MarcoFalke,2021-07-20 17:45:17,Your solution only works when a single process is run on the machine. This assumption is violated when several fuzz targets are running or the same target in several processes.,https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-883577518,883577518,
MarcoFalke,2021-07-20 17:46:27,"I think we only have two possible solutions here:\n\n* Get rid of all disk acess (might take some time to realize)\n* Fix the underlying bug",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-883578213,883578213,
agroce,2021-07-20 18:02:46,"Oh I see, of course, how stupid of me.\n\nMy guess is the ""underlying bug"" is fuzzers producing terminations that 1) aren't crashes but 2) avoid cleanup code execution.  I think anything QEMU based is going to do that occasionally, and looks like AFL also does it, even during corpus replay.\n\nOne idea, I don't know where the files come from, but could they be unlinked once opened?  Depending ",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-883588172,883588172,
agroce,2021-07-20 18:03:18,"No disk access will likely improve throughput, at least in some situations, anyway, even over /tmp.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-883588542,883588542,
agroce,2021-07-20 18:49:29,What about using `tmpfile` -- is that feasible?,https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-883616347,883616347,
MarcoFalke,2021-07-21 09:21:47,"> If the program terminates abnormally, it is implementation-defined if these temporary files are deleted. \n\nhttps://en.cppreference.com/w/cpp/io/c/tmpfile",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-884034521,884034521,
MarcoFalke,2021-07-24 10:04:21,"I haven't been able to reproduce, though the following diff should be able to reproduce the out-of-disk crash faster (even with an unlimited disk):\n\n```diff\ndiff --git a/src/test/util/setup_common.cpp b/src/test/util/setup_common.cpp\nindex 5334c4623..5d8478632 100644\n--- a/src/test/util/setup_common.cpp\n+++ b/src/test/util/setup_common.cpp\n@@ -90,6 +90,7 @@ BasicTestingSetup::BasicTe",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886030444,886030444,
agroce,2021-07-24 14:41:06,"Interesting.  What fuzzer have you been trying to reproduce under?  This should do it:\n\n```\n> rm -rf /tmp/test_common_Bitcoin*\n> git clone https://github.com/google/AFL.git\n> cd AFL\n> sudo make install\n> cd bitcoin\n> CC=afl-clang CXX=afl-clang++ ./configure --enable-fuzz\n> make clean; make -j 5\n> FUZZ=process_message afl-fuzz -i qa-assets/fuzz_seed_corpus/process_message -o fuz",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886062692,886062692,
MarcoFalke,2021-07-25 09:29:54,"google/AFL is unmaintained and also not used by OSS-Fuzz, so I am using AFLplusplus (See https://github.com/bitcoin/bitcoin/blob/master/doc/fuzzing.md#quickstart-guide-1).\n\nThough the fuzzers compiled with `afl-clang-lto` can't run the process_message harness (all inputs will time out).\n\nWhen I use the historic afl that starts a new process for each input, I can't observe the crash.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886173567,886173567,
agroce,2021-07-25 09:52:48,It will take quite some time depending on free space for a crash.  Do you see the leftover files in /tmp?,https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886175876,886175876,
MarcoFalke,2021-07-25 10:24:01,"With the ""historic afl"" (new process each time), I had to adjust the patch for an early crash:\n\n```diff\ndiff --git a/src/test/util/setup_common.cpp b/src/test/util/setup_common.cpp\nindex 5334c4623..01e969b49 100644\n--- a/src/test/util/setup_common.cpp\n+++ b/src/test/util/setup_common.cpp\n@@ -90,6 +90,7 @@ BasicTestingSetup::BasicTestingSetup(const std::string& chainName, const std::v",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886179490,886179490,
agroce,2021-07-25 12:30:37,"Hmm, sorry, missed that.  Ok, that's interesting.  OSS-Fuzz seems to have seen these spurious space-triggered crashes, too.  That's presumably with aflplusplus?\n\nIs there some difference in the environments?  I guess if so the QEMU failures for Eclipser might not always cause this problem, conceivably, if we can isolate the issue.\n\nProbably unrelated: do you know why aflplusplus can't hand",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886195114,886195114,
MarcoFalke,2021-07-25 14:35:22,"> do you know why aflplusplus can't handle process_message?\n\nThe ""every input times out"" issue also happens with the historic google/afl in llvm_mode. Though it doesn't happen with the aflpp_driver, otherwise OSS-Fuzz would have reported the issue, I presume?\n\nThe timeout won't happen if I comment out `SyncWithValidationInterfaceQueue`.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886211030,886211030,
MarcoFalke,2021-07-25 15:40:52,"Haven't been able to reproduce the ""/tmp/ fills up"" issue with `afl-clang-fast/++` from AFL++, yet.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886219503,886219503,
MarcoFalke,2021-07-26 13:10:49,"Ok, so the root of the problem seems to be that `fork` can't copy threads. Using another thread after `fork` is probably UB?! Unfortunately there doesn't seem to be a way in AFL(pp) to disable `fork`, even for the `aflpp_driver`. So the solution might be to remove all threads, which would likely also fix #22551 .\n\nThere is also libafl (https://github.com/AFLplusplus/LibAFL), which might enable",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886689644,886689644,
agroce,2021-07-26 13:53:22,"One threadsafe(-ish) solution I thought of:\n\nInstead of 'remove_all', crawl the dir and (even with no env variable, just unconditionally to avoid changes for OSS-Fuzz?) remove any subdirs in test_common... that are older than half an hour.  They'll never accumulate to the point of causing space issues, and no other fuzzer should have an input running anywhere near that long.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886723335,886723335,
MarcoFalke,2021-07-26 16:15:44,"I used the following diff to remove all threads, but it didn't help\n\n\n```diff\ndiff --git a/src/scheduler.cpp b/src/scheduler.cpp\nindex 02ada969a4..73d666db3d 100644\n--- a/src/scheduler.cpp\n+++ b/src/scheduler.cpp\n@@ -72,11 +72,7 @@ void CScheduler::serviceQueue()\n \n void CScheduler::schedule(CScheduler::Function f, std::chrono::system_clock::time_point t)\n {\n-    {\n-     ",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886840760,886840760,
agroce,2021-07-26 17:49:46,"What do you think of simply automatically killing ""old"" subdirs of `test_common_Bitcoin Core` in process-based fuzzing (do nothing to libFuzzer target based fuzzing)?",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886903821,886903821,
MarcoFalke,2021-07-27 07:00:20,"separate-process-based fuzzing should be unaffected. See comments https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886173567  (no crash after 12 hours with my patch) and your screenshot in #22551 (also no crash?, disk not filled up?)\n\nWith fork-based fuzzing I am seeing a background noise of crashes (though unrelated to the disk space issue).\n\nPreparing the affected fuzz targets ",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-887263083,887263083,
MarcoFalke,2021-07-27 08:54:28,cc @practicalswift Any ideas?,https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-887335258,887335258,
agroce,2021-07-27 13:36:06,"Sorry, I didn't mean true separate process-based (which might also see this problem, depending on the cause).  I meant anything that's not doing libFuzzer ""test is a function call"" approach.   My big afl run isn't crashing because it's compiled with my PR and the environment variable is set to TRUE.  :)\n\nFor me, afl or Eclipser in docker ubuntu 20.04 both reliably end up filling /tmp and faili",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-887519022,887519022,
practicalswift,2021-07-30 10:40:09,"Concept ACK on working around this issue (if we cannot fix the root cause).\n\nInstead of removing the entire tree `/tmp/test_common_Bitcoin Core/` on exit would it be possible to remove only the specific sub-directory used during the fuzzing session (say `/tmp/test_common_Bitcoin Core/6d8a[…]dc38/`)?",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-889806322,889806322,
agroce,2021-07-30 14:15:27,"The trick is it has to remove not on exit (since failing to do so as it should is the problem) but on entry, when it's the ""last"" one it needs to kill, whose name is unknown.",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-889922840,889922840,
practicalswift,2021-07-30 23:08:09,"> The trick is it has to remove not on exit (since failing to do so as it should is the problem) but on entry, when it's the ""last"" one it needs to kill, whose name is unknown.\n\nOh, of course! I misunderstood the problem. Sorry! :)",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-890245501,890245501,
agroce,2021-08-04 23:13:10,"@MarcoFalke \n\nAnother idea:\n\nIf this isn't causing much issue on OSS-Fuzz, perhaps a stopgap for Eclipser etc. fuzzing would be to remove code inside fuzz and add a script users can launch in background to occasionally clean up old leftover directories?",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-893034791,893034791,
MarcoFalke,2021-08-05 05:47:18,"I'd still prefer to fix the underlying issue over a temporary workaround.\n\nIn https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-886840760 I removed all threads. I wonder if I have to remove all locks too for `fork` to work properly in afl?",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-893182544,893182544,
agroce,2021-08-05 06:23:10,"I am concerned QEMU failures are going to always produce leftovers, for Eclipser...",https://github.com/bitcoin/bitcoin/pull/22472#issuecomment-893198711,893198711,
