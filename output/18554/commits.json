[
  {
    "sha": "02e5fb5d99cabda79c7a7e8262bf51c92fd96f08",
    "node_id": "C_kwDOABII59oAKDAyZTVmYjVkOTljYWJkYTc5YzdhN2U4MjYyYmY1MWM5MmZkOTZmMDg",
    "commit": {
      "author": {
        "name": "Seibart Nedor",
        "email": "rodentrabies@protonmail.com",
        "date": "2020-04-06T20:24:16Z"
      },
      "committer": {
        "name": "Seibart Nedor",
        "email": "rodentrabies@protonmail.com",
        "date": "2021-11-28T20:08:54Z"
      },
      "message": "wallet: ensure wallet files are not reused across chains",
      "tree": {
        "sha": "3812507c5dfa3293de2e4084428b5352298bc006",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3812507c5dfa3293de2e4084428b5352298bc006"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08/comments",
    "author": {
      "login": "rodentrabies",
      "id": 7646953,
      "node_id": "MDQ6VXNlcjc2NDY5NTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7646953?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rodentrabies",
      "html_url": "https://github.com/rodentrabies",
      "followers_url": "https://api.github.com/users/rodentrabies/followers",
      "following_url": "https://api.github.com/users/rodentrabies/following{/other_user}",
      "gists_url": "https://api.github.com/users/rodentrabies/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rodentrabies/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rodentrabies/subscriptions",
      "organizations_url": "https://api.github.com/users/rodentrabies/orgs",
      "repos_url": "https://api.github.com/users/rodentrabies/repos",
      "events_url": "https://api.github.com/users/rodentrabies/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rodentrabies/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rodentrabies",
      "id": 7646953,
      "node_id": "MDQ6VXNlcjc2NDY5NTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7646953?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rodentrabies",
      "html_url": "https://github.com/rodentrabies",
      "followers_url": "https://api.github.com/users/rodentrabies/followers",
      "following_url": "https://api.github.com/users/rodentrabies/following{/other_user}",
      "gists_url": "https://api.github.com/users/rodentrabies/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rodentrabies/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rodentrabies/subscriptions",
      "organizations_url": "https://api.github.com/users/rodentrabies/orgs",
      "repos_url": "https://api.github.com/users/rodentrabies/repos",
      "events_url": "https://api.github.com/users/rodentrabies/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rodentrabies/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "4f8b1f8759301d2553183e14f72444a0f1d80725",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4f8b1f8759301d2553183e14f72444a0f1d80725",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/4f8b1f8759301d2553183e14f72444a0f1d80725"
      }
    ],
    "stats": {
      "total": 20,
      "additions": 20,
      "deletions": 0
    },
    "files": [
      {
        "sha": "af6a9e76e19fba5878f6c9669b7e61f8ac2b0ad7",
        "filename": "src/dummywallet.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08/src/dummywallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08/src/dummywallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/dummywallet.cpp?ref=02e5fb5d99cabda79c7a7e8262bf51c92fd96f08",
        "patch": "@@ -51,6 +51,7 @@ void DummyWalletInit::AddWalletOptions(ArgsManager& argsman) const\n         \"-flushwallet\",\n         \"-privdb\",\n         \"-walletrejectlongchains\",\n+        \"-walletcrosschain\",\n         \"-unsafesqlitesync\",\n     });\n }"
      },
      {
        "sha": "d628fd3538d1834246fbdb62069617754b88adb9",
        "filename": "src/wallet/init.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08/src/wallet/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08/src/wallet/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/init.cpp?ref=02e5fb5d99cabda79c7a7e8262bf51c92fd96f08",
        "patch": "@@ -90,6 +90,7 @@ void WalletInit::AddWalletOptions(ArgsManager& argsman) const\n #endif\n \n     argsman.AddArg(\"-walletrejectlongchains\", strprintf(\"Wallet will not create transactions that violate mempool chain limits (default: %u)\", DEFAULT_WALLET_REJECT_LONG_CHAINS), ArgsManager::ALLOW_ANY | ArgsManager::DEBUG_ONLY, OptionsCategory::WALLET_DEBUG_TEST);\n+    argsman.AddArg(\"-walletcrosschain\", strprintf(\"Allow reusing wallet files across chains (default: %u)\", DEFAULT_WALLETCROSSCHAIN), ArgsManager::ALLOW_ANY | ArgsManager::DEBUG_ONLY, OptionsCategory::WALLET_DEBUG_TEST);\n \n     argsman.AddHiddenArgs({\"-zapwallettxes\"});\n }"
      },
      {
        "sha": "cc054dae95548fc18fe898fe63d4fcd124dac8dd",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 17,
        "deletions": 0,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=02e5fb5d99cabda79c7a7e8262bf51c92fd96f08",
        "patch": "@@ -2792,6 +2792,23 @@ bool CWallet::AttachChain(const std::shared_ptr<CWallet>& walletInstance, interf\n     assert(!walletInstance->m_chain || walletInstance->m_chain == &chain);\n     walletInstance->m_chain = &chain;\n \n+    // Unless allowed, ensure wallet files are not reused across chains:\n+    if (!gArgs.GetBoolArg(\"-walletcrosschain\", DEFAULT_WALLETCROSSCHAIN))\n+    {\n+        WalletBatch batch(walletInstance->GetDatabase());\n+        CBlockLocator locator;\n+        if (batch.ReadBestBlock(locator) && locator.vHave.size() > 0 && chain.getHeight() > 0)\n+        {\n+            // Wallet is assumed to be from another chain, if genesis block in the active\n+            // chain is differs from the genesis block know to the wallet.\n+            if (chain.getBlockHash(0) != locator.vHave.back())\n+            {\n+                error = _(\"Wallet files should not be reused across chains.\");\n+                return false;\n+            }\n+        }\n+    }\n+\n     // Register wallet with validationinterface. It's done before rescan to avoid\n     // missing block connections between end of rescan and validation subscribing.\n     // Because of wallet lock being hold, block connection notifications are going to"
      },
      {
        "sha": "8a67a954b8eeda4664bfa0b771ee1591f71a3660",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=02e5fb5d99cabda79c7a7e8262bf51c92fd96f08",
        "patch": "@@ -95,6 +95,7 @@ static const unsigned int DEFAULT_TX_CONFIRM_TARGET = 6;\n static const bool DEFAULT_WALLET_RBF = false;\n static const bool DEFAULT_WALLETBROADCAST = true;\n static const bool DEFAULT_DISABLE_WALLET = false;\n+static const bool DEFAULT_WALLETCROSSCHAIN = false;\n //! -maxtxfee default\n constexpr CAmount DEFAULT_TRANSACTION_MAXFEE{COIN / 10};\n //! Discourage users to set fees higher than this amount (in satoshis) per kB"
      }
    ]
  },
  {
    "sha": "ece5cd111660005ce71cb8a7092f96c3e084d975",
    "node_id": "C_kwDOABII59oAKGVjZTVjZDExMTY2MDAwNWNlNzFjYjhhNzA5MmY5NmMzZTA4NGQ5NzU",
    "commit": {
      "author": {
        "name": "Seibart Nedor",
        "email": "rodentrabies@protonmail.com",
        "date": "2020-04-06T20:26:20Z"
      },
      "committer": {
        "name": "Seibart Nedor",
        "email": "rodentrabies@protonmail.com",
        "date": "2021-11-28T20:24:18Z"
      },
      "message": "tests: add tests for cross-chain wallet use prevention",
      "tree": {
        "sha": "aec6b69e84f6813519dad780e774973dd82f57f5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/aec6b69e84f6813519dad780e774973dd82f57f5"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ece5cd111660005ce71cb8a7092f96c3e084d975",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ece5cd111660005ce71cb8a7092f96c3e084d975",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ece5cd111660005ce71cb8a7092f96c3e084d975",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ece5cd111660005ce71cb8a7092f96c3e084d975/comments",
    "author": {
      "login": "rodentrabies",
      "id": 7646953,
      "node_id": "MDQ6VXNlcjc2NDY5NTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7646953?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rodentrabies",
      "html_url": "https://github.com/rodentrabies",
      "followers_url": "https://api.github.com/users/rodentrabies/followers",
      "following_url": "https://api.github.com/users/rodentrabies/following{/other_user}",
      "gists_url": "https://api.github.com/users/rodentrabies/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rodentrabies/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rodentrabies/subscriptions",
      "organizations_url": "https://api.github.com/users/rodentrabies/orgs",
      "repos_url": "https://api.github.com/users/rodentrabies/repos",
      "events_url": "https://api.github.com/users/rodentrabies/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rodentrabies/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rodentrabies",
      "id": 7646953,
      "node_id": "MDQ6VXNlcjc2NDY5NTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7646953?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rodentrabies",
      "html_url": "https://github.com/rodentrabies",
      "followers_url": "https://api.github.com/users/rodentrabies/followers",
      "following_url": "https://api.github.com/users/rodentrabies/following{/other_user}",
      "gists_url": "https://api.github.com/users/rodentrabies/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rodentrabies/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rodentrabies/subscriptions",
      "organizations_url": "https://api.github.com/users/rodentrabies/orgs",
      "repos_url": "https://api.github.com/users/rodentrabies/repos",
      "events_url": "https://api.github.com/users/rodentrabies/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rodentrabies/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "02e5fb5d99cabda79c7a7e8262bf51c92fd96f08",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/02e5fb5d99cabda79c7a7e8262bf51c92fd96f08"
      }
    ],
    "stats": {
      "total": 57,
      "additions": 57,
      "deletions": 0
    },
    "files": [
      {
        "sha": "8a48fee3e6f2e5b7955e55622a7b2d28242a4a7a",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ece5cd111660005ce71cb8a7092f96c3e084d975/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ece5cd111660005ce71cb8a7092f96c3e084d975/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=ece5cd111660005ce71cb8a7092f96c3e084d975",
        "patch": "@@ -248,6 +248,7 @@\n     'rpc_bind.py --ipv4',\n     'rpc_bind.py --ipv6',\n     'rpc_bind.py --nonloopback',\n+    'wallet_crosschain.py',\n     'mining_basic.py',\n     'feature_signet.py',\n     'wallet_bumpfee.py --legacy-wallet',"
      },
      {
        "sha": "421496627398828ff717265fc64a84511c256c9d",
        "filename": "test/functional/wallet_crosschain.py",
        "status": "added",
        "additions": 56,
        "deletions": 0,
        "changes": 56,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ece5cd111660005ce71cb8a7092f96c3e084d975/test/functional/wallet_crosschain.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ece5cd111660005ce71cb8a7092f96c3e084d975/test/functional/wallet_crosschain.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/wallet_crosschain.py?ref=ece5cd111660005ce71cb8a7092f96c3e084d975",
        "patch": "@@ -0,0 +1,56 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+import os\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_raises_rpc_error,\n+)\n+\n+class WalletCrossChain(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def setup_network(self, split=False):\n+        self.setup_nodes()\n+\n+    def run_test(self):\n+        self.log.info(\"Generating initial blockchains\")\n+        self.nodes[0].generate(5)\n+        self.nodes[1].generate(5)\n+\n+        self.log.info(\"Creating wallets\")\n+        node_0_wallet = os.path.join(self.nodes[0].datadir, 'node_0_wallet')\n+        self.nodes[0].createwallet(node_0_wallet)\n+        self.nodes[0].unloadwallet(node_0_wallet)\n+\n+        node_1_wallet = os.path.join(self.nodes[1].datadir, 'node_1_wallet')\n+        self.nodes[1].createwallet(node_1_wallet)\n+        self.nodes[1].unloadwallet(node_1_wallet)\n+\n+        node_2_wallet = os.path.join(self.nodes[2].datadir, 'node_2_wallet')\n+        self.nodes[2].createwallet(node_2_wallet)\n+        self.nodes[2].unloadwallet(node_2_wallet)\n+\n+        self.log.info(\"Loading wallets into nodes with a different genesis blocks\")\n+        assert_raises_rpc_error(-4, 'Wallet files should not be reused across chains.', self.nodes[0].loadwallet, node_1_wallet)\n+        assert_raises_rpc_error(-4, 'Wallet files should not be reused across chains.', self.nodes[1].loadwallet, node_0_wallet)\n+\n+        self.log.info(\"Loading wallets into a node with no blocks in the chain\")\n+        self.nodes[2].loadwallet(node_0_wallet)\n+        self.nodes[2].loadwallet(node_1_wallet)\n+\n+        self.log.info(\"Loading wallets with empty known block sets\")\n+        self.nodes[0].loadwallet(node_2_wallet)\n+        self.nodes[1].loadwallet(node_2_wallet)\n+\n+\n+if __name__ == '__main__':\n+    WalletCrossChain().main()"
      }
    ]
  }
]