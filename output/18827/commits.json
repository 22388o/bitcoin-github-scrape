[
  {
    "sha": "2893a5f702a3f00199d42246f69903bef96f8586",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyODkzYTVmNzAyYTNmMDAxOTlkNDIyNDZmNjk5MDNiZWY5NmY4NTg2",
    "commit": {
      "author": {
        "name": "Harris",
        "email": "brakmic@gmail.com",
        "date": "2020-05-04T18:33:52Z"
      },
      "committer": {
        "name": "Harris",
        "email": "brakmic@gmail.com",
        "date": "2020-05-09T22:19:18Z"
      },
      "message": "rpc: added getrpcwhitelist method",
      "tree": {
        "sha": "ae9128ff46e213392b3d0bc656712d0f024c0a92",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ae9128ff46e213392b3d0bc656712d0f024c0a92"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2893a5f702a3f00199d42246f69903bef96f8586",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQEzBAABCAAdFiEED2bWxOeRx//n2QOeJiaFvHjtEfsFAl63LGYACgkQJiaFvHjt\nEfsBmgf/Vk0hl0PMulovq93NQKiAuUb4HGwLvlu2fe5BK1Bgb6J6zNW5dfjEaYyO\nyFzdx0mOBycIsNZk7jOxTFeUo9vTQsFCrGfGFn9iOpGR2I9zvbvXFEOyaArEFbpT\nc+E85KZjhdqkjif8ZALM6avVVUBuk96VP2M3gmFG9voB4T33l6+Mnxae8F7y7XfP\nBqRyEdPmChLveg500AYUSnsqHRW7knYENNqI7dtjzJOVgYRLc/a+uvOTD5/SqTpm\njRdHC/wyKrsfNJCsqfTwyeAWQsBHaQPss2cSugBC6FExhnNq6Z8zAGq2yCm3WGiC\nlsK5NpUy9EYHUnB9PfgztH0QXfgmpA==\n=COk5\n-----END PGP SIGNATURE-----",
        "payload": "tree ae9128ff46e213392b3d0bc656712d0f024c0a92\nparent 88d8b4e182bfc75e8496f7046af7aab93307b9d0\nauthor Harris <brakmic@gmail.com> 1588617232 +0200\ncommitter Harris <brakmic@gmail.com> 1589062758 +0200\n\nrpc: added getrpcwhitelist method\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2893a5f702a3f00199d42246f69903bef96f8586",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/2893a5f702a3f00199d42246f69903bef96f8586",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2893a5f702a3f00199d42246f69903bef96f8586/comments",
    "author": {
      "login": "brakmic",
      "id": 56779,
      "node_id": "MDQ6VXNlcjU2Nzc5",
      "avatar_url": "https://avatars.githubusercontent.com/u/56779?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brakmic",
      "html_url": "https://github.com/brakmic",
      "followers_url": "https://api.github.com/users/brakmic/followers",
      "following_url": "https://api.github.com/users/brakmic/following{/other_user}",
      "gists_url": "https://api.github.com/users/brakmic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brakmic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brakmic/subscriptions",
      "organizations_url": "https://api.github.com/users/brakmic/orgs",
      "repos_url": "https://api.github.com/users/brakmic/repos",
      "events_url": "https://api.github.com/users/brakmic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brakmic/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "brakmic",
      "id": 56779,
      "node_id": "MDQ6VXNlcjU2Nzc5",
      "avatar_url": "https://avatars.githubusercontent.com/u/56779?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/brakmic",
      "html_url": "https://github.com/brakmic",
      "followers_url": "https://api.github.com/users/brakmic/followers",
      "following_url": "https://api.github.com/users/brakmic/following{/other_user}",
      "gists_url": "https://api.github.com/users/brakmic/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/brakmic/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/brakmic/subscriptions",
      "organizations_url": "https://api.github.com/users/brakmic/orgs",
      "repos_url": "https://api.github.com/users/brakmic/repos",
      "events_url": "https://api.github.com/users/brakmic/events{/privacy}",
      "received_events_url": "https://api.github.com/users/brakmic/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "88d8b4e182bfc75e8496f7046af7aab93307b9d0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/88d8b4e182bfc75e8496f7046af7aab93307b9d0",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/88d8b4e182bfc75e8496f7046af7aab93307b9d0"
      }
    ],
    "stats": {
      "total": 116,
      "additions": 115,
      "deletions": 1
    },
    "files": [
      {
        "sha": "6d80199ca46e824b603c6dd9f7438fb85b6e2ee1",
        "filename": "doc/release-notes-18827.md",
        "status": "added",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2893a5f702a3f00199d42246f69903bef96f8586/doc/release-notes-18827.md",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2893a5f702a3f00199d42246f69903bef96f8586/doc/release-notes-18827.md",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/doc/release-notes-18827.md?ref=2893a5f702a3f00199d42246f69903bef96f8586",
        "patch": "@@ -0,0 +1 @@\n+- New rpc: `getrpcwhitelist` that returns a list of allowed RPCs for the calling user.\n\\ No newline at end of file"
      },
      {
        "sha": "15b81bc0c75e7c76046a7917187e65e5a79a23dc",
        "filename": "src/httprpc.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2893a5f702a3f00199d42246f69903bef96f8586/src/httprpc.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2893a5f702a3f00199d42246f69903bef96f8586/src/httprpc.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/httprpc.cpp?ref=2893a5f702a3f00199d42246f69903bef96f8586",
        "patch": "@@ -322,3 +322,8 @@ void StopHTTPRPC()\n         httpRPCTimerInterface.reset();\n     }\n }\n+\n+const std::set<std::string>& GetWhitelistedRpcs(const std::string& user_name)\n+{\n+    return g_rpc_whitelist.at(user_name);\n+}"
      },
      {
        "sha": "cb9d647742f1dfcedf10210d6e3a414866449801",
        "filename": "src/httprpc.h",
        "status": "modified",
        "additions": 5,
        "deletions": 1,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2893a5f702a3f00199d42246f69903bef96f8586/src/httprpc.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2893a5f702a3f00199d42246f69903bef96f8586/src/httprpc.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/httprpc.h?ref=2893a5f702a3f00199d42246f69903bef96f8586",
        "patch": "@@ -4,7 +4,8 @@\n \n #ifndef BITCOIN_HTTPRPC_H\n #define BITCOIN_HTTPRPC_H\n-\n+#include <string>\n+#include <set>\n \n /** Start HTTP RPC subsystem.\n  * Precondition; HTTP and RPC has been started.\n@@ -29,5 +30,8 @@ void InterruptREST();\n  * Precondition; HTTP and RPC has been stopped.\n  */\n void StopREST();\n+/** Returns a collection of whitelisted RPCs for the given user\n+ */\n+const std::set<std::string>& GetWhitelistedRpcs(const std::string& user_name);\n \n #endif"
      },
      {
        "sha": "2403f210a8db485488ab9be88d7db47a2fbccd0f",
        "filename": "src/rpc/server.cpp",
        "status": "modified",
        "additions": 33,
        "deletions": 0,
        "changes": 33,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2893a5f702a3f00199d42246f69903bef96f8586/src/rpc/server.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2893a5f702a3f00199d42246f69903bef96f8586/src/rpc/server.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/server.cpp?ref=2893a5f702a3f00199d42246f69903bef96f8586",
        "patch": "@@ -18,6 +18,7 @@\n #include <memory> // for unique_ptr\n #include <unordered_map>\n \n+const std::set<std::string>& GetWhitelistedRpcs(const std::string&);\n static RecursiveMutex cs_rpcWarmup;\n static std::atomic<bool> g_rpc_running{false};\n static bool fRPCInWarmup GUARDED_BY(cs_rpcWarmup) = true;\n@@ -235,12 +236,44 @@ static UniValue getrpcinfo(const JSONRPCRequest& request)\n     return result;\n }\n \n+static UniValue getrpcwhitelist(const JSONRPCRequest& request)\n+{\n+    RPCHelpMan{\"getrpcwhitelist\",\n+                \"\\nReturns whitelisted RPCs for the current user.\\n\",\n+                {},\n+                RPCResult{\n+                    RPCResult::Type::OBJ, \"\", \"\",\n+                    {\n+                        {RPCResult::Type::ARR, \"methods\", \"List of RPCs that the user is allowed to call\",\n+                        {\n+                            {RPCResult::Type::STR, \"rpc\", \"rpc command\"},\n+                        }},\n+                    }\n+                },\n+                RPCExamples{\n+                    HelpExampleCli(\"getrpcwhitelist\", \"\")\n+                + HelpExampleRpc(\"getrpcwhitelist\", \"\")},\n+            }.Check(request);\n+\n+    UniValue whitelisted_rpcs(UniValue::VARR);\n+    const std::set<std::string>& whitelist = GetWhitelistedRpcs(request.authUser);\n+    for (const auto& rpc : whitelist) {\n+        whitelisted_rpcs.push_back(rpc);\n+    }\n+\n+    UniValue result(UniValue::VOBJ);\n+    result.pushKV(\"methods\", whitelisted_rpcs);\n+\n+    return result;\n+}\n+\n // clang-format off\n static const CRPCCommand vRPCCommands[] =\n { //  category              name                      actor (function)         argNames\n   //  --------------------- ------------------------  -----------------------  ----------\n     /* Overall control/query calls */\n     { \"control\",            \"getrpcinfo\",             &getrpcinfo,             {}  },\n+    { \"control\",            \"getrpcwhitelist\",        &getrpcwhitelist,        {}},\n     { \"control\",            \"help\",                   &help,                   {\"command\"}  },\n     { \"control\",            \"stop\",                   &stop,                   {\"wait\"}  },\n     { \"control\",            \"uptime\",                 &uptime,                 {}  },"
      },
      {
        "sha": "d83d316bbeb30e2bd5d2b955363f6349033becf0",
        "filename": "test/functional/rpc_getrpcwhitelist.py",
        "status": "added",
        "additions": 70,
        "deletions": 0,
        "changes": 70,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2893a5f702a3f00199d42246f69903bef96f8586/test/functional/rpc_getrpcwhitelist.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2893a5f702a3f00199d42246f69903bef96f8586/test/functional/rpc_getrpcwhitelist.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_getrpcwhitelist.py?ref=2893a5f702a3f00199d42246f69903bef96f8586",
        "patch": "@@ -0,0 +1,70 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test getrpcwhitelist RPC call.\n+\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    get_datadir_path,\n+    str_to_b64str\n+)\n+import http.client\n+import json\n+import os\n+import urllib.parse\n+\n+def call_rpc(node, settings, rpc):\n+    url = urllib.parse.urlparse(node.url)\n+    headers = {\"Authorization\": \"Basic \" + str_to_b64str('{}:{}'.format(settings[0], settings[2]))}\n+    conn = http.client.HTTPConnection(url.hostname, url.port)\n+    conn.connect()\n+    conn.request('POST', '/', '{\"method\": \"' + rpc + '\"}', headers)\n+    resp = conn.getresponse()\n+    code = resp.status\n+    if code == 200:\n+        json_ret = json.loads(resp.read().decode())\n+    else:\n+        json_ret = {\"result\": None}\n+    conn.close()\n+    return {\"status\": code, \"json\": json_ret['result']}\n+\n+class RPCWhitelistTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def setup_chain(self):\n+        super().setup_chain()\n+        self.settings = [\"dummy\",\n+                         \"4e799db4b65924f4468b1c9ff3a68109$5fcd282dcaf4ae74599934a543626c0a11e7e83ead30f07b182058ead8e85da9\",\n+                         \"dummypwd\",\n+                         \"getbalance,getrpcwhitelist,getwalletinfo\"]\n+        self.settings_forbidden = [\"dummy2\",\n+                        \"f3d319f64b076012f75626c9d895fced$7f55381a24fda02c5de7c18fc377f56fc573149b4d6f83daa9fd584210b51f99\",\n+                        \"dummy2pwd\",\n+                        \"getbalance,getwalletinfo\"]\n+\n+        # declare rpc-whitelisting entries\n+        with open(os.path.join(get_datadir_path(self.options.tmpdir, 0), \"bitcoin.conf\"), 'a', encoding='utf8') as f:\n+            f.write(\"\\nrpcwhitelistdefault=0\\n\")\n+            f.write(\"rpcauth={}:{}\\n\".format(self.settings[0], self.settings[1]))\n+            f.write(\"rpcwhitelist={}:{}\\n\".format(self.settings[0], self.settings[3]))\n+            f.write(\"rpcauth={}:{}\\n\".format(self.settings_forbidden[0], self.settings_forbidden[1]))\n+            f.write(\"rpcwhitelist={}:{}\\n\".format(self.settings_forbidden[0], self.settings_forbidden[3]))\n+\n+    def run_test(self):\n+        self.log.info(\"Test getrpcwhitelist\")\n+        whitelisted = self.settings[3].split(',')\n+\n+        # should return allowed rpcs\n+        result = call_rpc(self.nodes[0], self.settings, 'getrpcwhitelist')\n+        assert_equal(200, result['status'])\n+        assert_equal(result['json']['methods'], whitelisted)\n+        # should fail because user has no rpcwhitelist-rpc entry in bitcoin.conf\n+        result = call_rpc(self.nodes[0], self.settings_forbidden, 'getrpcwhitelist')\n+        assert_equal(result['status'], 403)\n+\n+if __name__ == \"__main__\":\n+    RPCWhitelistTest().main()"
      },
      {
        "sha": "8788d0bc6cfa6056a5f23f17845b177b4b4e110f",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2893a5f702a3f00199d42246f69903bef96f8586/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2893a5f702a3f00199d42246f69903bef96f8586/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=2893a5f702a3f00199d42246f69903bef96f8586",
        "patch": "@@ -148,6 +148,7 @@\n     'rpc_psbt.py --descriptors',\n     'rpc_users.py',\n     'rpc_whitelist.py',\n+    'rpc_getrpcwhitelist.py',\n     'feature_proxy.py',\n     'rpc_signrawtransaction.py',\n     'wallet_groups.py',"
      }
    ]
  }
]