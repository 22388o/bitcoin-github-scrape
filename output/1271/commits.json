[
  {
    "sha": "9fc4c035560c59b32d6b26bdd172b3238a84d644",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5ZmM0YzAzNTU2MGM1OWIzMmQ2YjI2YmRkMTcyYjMyMzhhODRkNjQ0",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2012-05-17T23:22:57Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2013-03-24T03:29:06Z"
      },
      "message": "Fixes Issue #1234 - re-issues getblocks when current node providing them disappears.\n\nConflicts:\n\n\tsrc/net.cpp\n\nConflicts:\n\n\t.gitignore",
      "tree": {
        "sha": "d6d11b27c9275e69a0fd68ac5e44e145113c70f9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d6d11b27c9275e69a0fd68ac5e44e145113c70f9"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9fc4c035560c59b32d6b26bdd172b3238a84d644",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9fc4c035560c59b32d6b26bdd172b3238a84d644",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/9fc4c035560c59b32d6b26bdd172b3238a84d644",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9fc4c035560c59b32d6b26bdd172b3238a84d644/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "dfd71bb4509d12c26e630bc671a542ad5bab4945",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dfd71bb4509d12c26e630bc671a542ad5bab4945",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/dfd71bb4509d12c26e630bc671a542ad5bab4945"
      }
    ],
    "stats": {
      "total": 37,
      "additions": 24,
      "deletions": 13
    },
    "files": [
      {
        "sha": "a9ab058337808a3764350177ea65f4cf0532c792",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 15,
        "deletions": 12,
        "changes": 27,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9fc4c035560c59b32d6b26bdd172b3238a84d644/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9fc4c035560c59b32d6b26bdd172b3238a84d644/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=9fc4c035560c59b32d6b26bdd172b3238a84d644",
        "patch": "@@ -35,6 +35,7 @@ uint256 hashGenesisBlock(\"0x000000000019d6689c085ae165831e934ff763ae46a2a6c172b3\n static CBigNum bnProofOfWorkLimit(~uint256(0) >> 32);\n CBlockIndex* pindexGenesisBlock = NULL;\n int nBestHeight = -1;\n+int nAskedForBlocks = 0;\n CBigNum bnBestChainWork = 0;\n CBigNum bnBestInvalidWork = 0;\n uint256 hashBestChain = 0;\n@@ -3131,18 +3132,6 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n             }\n         }\n \n-        // Ask the first connected node for block updates\n-        static int nAskedForBlocks = 0;\n-        if (!pfrom->fClient && !pfrom->fOneShot && !fImporting && !fReindex &&\n-            (pfrom->nStartingHeight > (nBestHeight - 144)) &&\n-            (pfrom->nVersion < NOBLKS_VERSION_START ||\n-             pfrom->nVersion >= NOBLKS_VERSION_END) &&\n-             (nAskedForBlocks < 1 || vNodes.size() <= 1))\n-        {\n-            nAskedForBlocks++;\n-            pfrom->PushGetBlocks(pindexBest, uint256(0));\n-        }\n-\n         // Relay alerts\n         {\n             LOCK(cs_mapAlerts);\n@@ -3818,6 +3807,20 @@ bool ProcessMessages(CNode* pfrom)\n             PrintExceptionContinue(NULL, \"ProcessMessages()\");\n         }\n \n+        // Ask a connected node for block updates\n+        if (!pfrom->fClient && !pfrom->fOneShot && !fImporting && !fReindex &&\n+            (pfrom->nStartingHeight > (nBestHeight - 144)) &&\n+            (pfrom->nVersion < NOBLKS_VERSION_START ||\n+             pfrom->nVersion >= NOBLKS_VERSION_END) &&\n+            !pfrom->fAskedForBlocks &&\n+            (nAskedForBlocks < 1 || vNodes.size() <= 1))\n+        {\n+            nAskedForBlocks++;\n+            pfrom->fAskedForBlocks = true;\n+            printf(\"initial getblocks to %s\\n\", pfrom->addr.ToString().c_str());\n+            pfrom->PushGetBlocks(pindexBest, uint256(0));\n+        }\n+\n         if (!fRet)\n             printf(\"ProcessMessage(%s, %u bytes) FAILED\\n\", strCommand.c_str(), nMessageSize);\n     }"
      },
      {
        "sha": "a4d0e9d33900187911dfc32cfee6518ebf23bd73",
        "filename": "src/main.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9fc4c035560c59b32d6b26bdd172b3238a84d644/src/main.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9fc4c035560c59b32d6b26bdd172b3238a84d644/src/main.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.h?ref=9fc4c035560c59b32d6b26bdd172b3238a84d644",
        "patch": "@@ -97,6 +97,7 @@ extern bool fBenchmark;\n extern int nScriptCheckThreads;\n extern bool fTxIndex;\n extern unsigned int nCoinCacheSize;\n+extern int nAskedForBlocks;\n \n // Settings\n extern int64 nTransactionFee;"
      },
      {
        "sha": "ac194f4b55b3e9511226ed95b89d8f6203767020",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 1,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9fc4c035560c59b32d6b26bdd172b3238a84d644/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9fc4c035560c59b32d6b26bdd172b3238a84d644/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=9fc4c035560c59b32d6b26bdd172b3238a84d644",
        "patch": "@@ -535,7 +535,12 @@ void CNode::CloseSocketDisconnect()\n     fDisconnect = true;\n     if (hSocket != INVALID_SOCKET)\n     {\n-        printf(\"disconnecting node %s\\n\", addrName.c_str());\n+        printf(\"disconnecting node %s [\", addrName.c_str());\n+        if (fAskedForBlocks) {\n+            nAskedForBlocks--;\n+            printf(\"ASKFOR.\");\n+        }\n+        printf(\"]\\n\");\n         closesocket(hSocket);\n         hSocket = INVALID_SOCKET;\n         vRecv.clear();"
      },
      {
        "sha": "1539335d88285df184b9e88b769fe2d8dc92d24c",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9fc4c035560c59b32d6b26bdd172b3238a84d644/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9fc4c035560c59b32d6b26bdd172b3238a84d644/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=9fc4c035560c59b32d6b26bdd172b3238a84d644",
        "patch": "@@ -143,6 +143,7 @@ class CNode\n     int64 nLastRecv;\n     int64 nLastSendEmpty;\n     int64 nTimeConnected;\n+    bool fAskedForBlocks;\n     int nHeaderStart;\n     unsigned int nMessageStart;\n     CAddress addr;\n@@ -200,6 +201,7 @@ class CNode\n         nLastRecv = 0;\n         nLastSendEmpty = GetTime();\n         nTimeConnected = GetTime();\n+        fAskedForBlocks = false;\n         nHeaderStart = -1;\n         nMessageStart = -1;\n         addr = addrIn;"
      }
    ]
  }
]