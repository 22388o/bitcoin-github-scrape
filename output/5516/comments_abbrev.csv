jgarzik,2014-12-20T13:23:32Z,"""-pthreads"" is a compiler _and_ linker flag.  On some platforms it enables various macros in C/C++ headers.  It is the ""I am using threads"" command line switch.\n\nAs such, a poor test can silently fail (== appear to not need -pthread), resulting in code that is compiled as single-threaded code.\n\nSilently compiling to single-threaded code is a _far_ worse outcome than an annoying warning on comp",https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67735693,67735693,
paveljanik,2014-12-20T14:30:06Z,"@jgarzik ""-pthread"" is a compiler and linker flag: no. This only applies to good old GNU gcc and GNU linker world only (compare pthreads(7) on GNU/Linux: _On Linux, programs that use the Pthreads API should be  compiled  using cc -pthread._). But it is a bit different on OS X. You don't need any compiler/linker flags because all system libs contain threads support. See https://developer.apple.com/",https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67737350,67737350,
jgarzik,2014-12-20T15:36:10Z,"@paveljanik I am well aware of that.  My comment remains applicable. You must consider the case of building with gcc + third party libraries on OSX that trigger different thread/non-thread behavior at compile time.\n\nThe entire app stack on OSX needs to be verified free of MT behavior switching in headers, not just the system libs.  e.g. Boost in particular is very sensitive on OSX, and is header",https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67739316,67739316,
paveljanik,2014-12-20T19:20:20Z,"But this is ""solved"" in ax_pthread.m4 already IMO, where it checks thread functionality (not completely though, of course) with the provided compiler/libs and auto-selects the needed flags.\nWhen I think more about it, ax_pthread.m4 macros should be changed to distinguish between compile time and linking time. Of course written for GNU world, where compile and link time are the same...\n\nOn OS X:",https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67746524,67746524,
theuni,2014-12-22T18:51:47Z,"``` diff\ndiff --git a/src/Makefile.am b/src/Makefile.am\nindex d6ac6e1..d7968bd 100644\n--- a/src/Makefile.am\n+++ b/src/Makefile.am\n@@ -1,5 +1,6 @@\n DIST_SUBDIRS = secp256k1\n-AM_LDFLAGS = $(PTHREAD_CFLAGS) $(LIBTOOL_LDFLAGS)\n+AM_LDFLAGS = $(PTHREAD_LIBS) $(LIBTOOL_LDFLAGS)\n+AM_CFLAGS = $(PTHREAD_CFLAGS)\n\n\n if EMBEDDED_LEVELDB\n```\n\nIsn't that all that needs to be done? The m4 macro alr",https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67874470,67874470,
paveljanik,2014-12-22T19:25:53Z,"@theuni yes, this is all to be done. Thank you! Will you PR it or should I use it here?\n",https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67878297,67878297,
jgarzik,2014-12-22T19:29:50Z,+1 @theuni \n,https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67878782,67878782,
theuni,2014-12-22T21:43:40Z,"@paveljanik You're welcome to just take that here, to keep the discussion in one place.\n",https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67893735,67893735,
paveljanik,2014-12-22T22:12:07Z,Done. Thank you again.\n,https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67896823,67896823,
paveljanik,2014-12-22T23:09:13Z,Travis failed: https://travis-ci.org/bitcoin/bitcoin/jobs/44878072 on ARM.\n\nLooks like -pthread is missing when linking or something similar... But can't test easily. Adding debugging prints to configure.\n,https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67902775,67902775,
paveljanik,2014-12-22T23:12:32Z,"Yup, confirmed:\n\n```\nconfigure: The contents of configured PTHREAD_CFLAGS: -pthread\nconfigure: The contents of configured PTHREAD_LIBS: \nconfigure: The contents of configured PTHREAD_CC: arm-linux-gnueabihf-gcc\n```\n",https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67903084,67903084,
paveljanik,2014-12-22T23:18:02Z,@theuni Any hint now?\n,https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67903617,67903617,
paveljanik,2014-12-22T23:37:48Z,"Other platforms are OK. On all of them, _LIBS is empty, e.g.:\n\n```\nconfigure: The contents of configured PTHREAD_CFLAGS: -pthread\nconfigure: The contents of configured PTHREAD_LIBS: \nconfigure: The contents of configured PTHREAD_CC: gcc -m64\n```\n",https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67905370,67905370,
theuni,2014-12-23T00:31:17Z,"Well that's annoying. I had assumed that the m4 would treat LIBS as LDFLAGS, sticking linker options (-pthread) in LIBS as needed. But upon closer inspection, it doesn't even try to compile without linking! It just assumes you'll forward CFLAGS to the linker, which explains why I had it setup that way to begin with.\n\nAfter trying a few things and checking deep in some docs, I now agree with @jga",https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67909116,67909116,
paveljanik,2014-12-23T09:45:42Z,See https://savannah.gnu.org/patch/index.php?8585 for a bugreport to GNU Autoconf Archive.\n\nIs https://github.com/paveljanik/bitcoin/commit/e7f114cd8787cd0c107a7519b5ae143748e93af9 worth cherrypicking so we have auto-detected values saved in the Travis logs/configure log?\n\nOtherwise we can't do more here. Thank you all. Closing.\n,https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-67935338,67935338,
paveljanik,2016-02-10T21:10:58Z,JFYI: ax_pthreads.m4 is getting fixed upstream:\n\nhttps://savannah.gnu.org/patch/?8585\n,https://github.com/bitcoin/bitcoin/pull/5516#issuecomment-182583299,182583299,
