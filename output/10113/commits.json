[
  {
    "sha": "ebbce1268c2bf80ed290cfa6c3ae527f4c9ddae1",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplYmJjZTEyNjhjMmJmODBlZDI5MGNmYTZjM2FlNTI3ZjRjOWRkYWUx",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2017-03-28T21:13:10Z"
      },
      "committer": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2017-03-28T21:13:10Z"
      },
      "message": "Fix test_bitcoin-qt when DISPLAY is unset\n\nIssue reported by Matt Corallo <git@bluematt.me> in\nhttps://github.com/bitcoin/bitcoin/issues/10110\n\nFixes #10110",
      "tree": {
        "sha": "1723cef5d316c0dffb1223ac56a30722cb771ca5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1723cef5d316c0dffb1223ac56a30722cb771ca5"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ebbce1268c2bf80ed290cfa6c3ae527f4c9ddae1",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ebbce1268c2bf80ed290cfa6c3ae527f4c9ddae1",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ebbce1268c2bf80ed290cfa6c3ae527f4c9ddae1",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ebbce1268c2bf80ed290cfa6c3ae527f4c9ddae1/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "919aaf6508557439ab859c25dae86998a9bed12f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/919aaf6508557439ab859c25dae86998a9bed12f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/919aaf6508557439ab859c25dae86998a9bed12f"
      }
    ],
    "stats": {
      "total": 30,
      "additions": 28,
      "deletions": 2
    },
    "files": [
      {
        "sha": "41b479f1cfd7b3a1045a207a4adaa145b2147880",
        "filename": "src/qt/test/test_main.cpp",
        "status": "modified",
        "additions": 22,
        "deletions": 2,
        "changes": 24,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ebbce1268c2bf80ed290cfa6c3ae527f4c9ddae1/src/qt/test/test_main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ebbce1268c2bf80ed290cfa6c3ae527f4c9ddae1/src/qt/test/test_main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/test/test_main.cpp?ref=ebbce1268c2bf80ed290cfa6c3ae527f4c9ddae1",
        "patch": "@@ -19,7 +19,9 @@\n \n #include <QApplication>\n #include <QObject>\n+#include <QPluginLoader>\n #include <QTest>\n+#include <QtDebug>\n \n #include <openssl/ssl.h>\n \n@@ -41,6 +43,15 @@ Q_IMPORT_PLUGIN(QCocoaIntegrationPlugin);\n #endif\n #endif\n \n+static bool UsesXcb() {\n+    for (QObject* plugin: QPluginLoader::staticInstances()) {\n+        if (plugin->objectName() == \"platforms/qxcb\") {\n+            return true;\n+        }\n+    }\n+    return QPluginLoader(\"platforms/qxcb\").load();\n+}\n+\n extern void noui_connect();\n \n // This is all you need to run all the tests\n@@ -55,8 +66,17 @@ int main(int argc, char *argv[])\n \n     // Don't remove this, it's needed to access\n     // QApplication:: and QCoreApplication:: in the tests\n-    QApplication app(argc, argv);\n-    app.setApplicationName(\"Bitcoin-Qt-test\");\n+    std::unique_ptr<QCoreApplication> app;\n+    if (!UsesXcb() || getenv(\"DISPLAY\")) {\n+        app.reset(new QApplication(argc, argv));\n+    } else {\n+        // If the test uses XCB but the DISPLAY variable is unset, this will\n+        // cause a fatal error during QApplication construction, so fall back to\n+        // using QCoreApplication instead.\n+        app.reset(new QCoreApplication(argc, argv));\n+        qWarning() << \"DISPLAY variable is unset. Some tests will be skipped.\";\n+    }\n+    app->setApplicationName(\"Bitcoin-Qt-test\");\n \n     SSL_library_init();\n "
      },
      {
        "sha": "a2a5de7cc067bd437e7f692f43c960bbc339cb2c",
        "filename": "src/qt/test/wallettests.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ebbce1268c2bf80ed290cfa6c3ae527f4c9ddae1/src/qt/test/wallettests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ebbce1268c2bf80ed290cfa6c3ae527f4c9ddae1/src/qt/test/wallettests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/test/wallettests.cpp?ref=ebbce1268c2bf80ed290cfa6c3ae527f4c9ddae1",
        "patch": "@@ -16,6 +16,7 @@\n #include <QApplication>\n #include <QTimer>\n #include <QVBoxLayout>\n+#include <QtDebug>\n \n namespace\n {\n@@ -71,6 +72,11 @@ QModelIndex FindTx(const QAbstractItemModel& model, const uint256& txid)\n //! Simple qt wallet tests.\n void WalletTests::walletTests()\n {\n+    if (qobject_cast<QApplication*>(QCoreApplication::instance())==0) {\n+        qWarning() << \"Skipping gui wallet tests because display is not available.\";\n+        return;\n+    }\n+\n     // Set up wallet and chain with 101 blocks (1 mature block for spending).\n     TestChain100Setup test;\n     test.CreateAndProcessBlock({}, GetScriptForRawPubKey(test.coinbaseKey.GetPubKey()));"
      }
    ]
  }
]