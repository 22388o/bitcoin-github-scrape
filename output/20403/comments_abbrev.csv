achow101,2020-11-16 18:34:27,Code review ACK b95925c751fb97a1a17bf5a540ec06f0634ea72e,https://github.com/bitcoin/bitcoin/pull/20403#issuecomment-728246886,728246886,
DrahtBot,2020-11-16 18:36:45,<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.,https://github.com/bitcoin/bitcoin/pull/20403#issuecomment-728248066,728248066,
jonatack,2020-11-16 18:46:27,"Removed the cast in UpgradeWallet() per `git diff b95925c 377fa31` (thanks!)\n```diff\n@@ -4128,7 +4128,7 @@ bool CWallet::UpgradeWallet(int& version, bilingual_str& error, std::vector<bili\n     // Permanently upgrade to the version\n     const WalletFeature new_version{GetClosestWalletFeature(version)};\n     SetMinVersion(new_version);\n-    version = static_cast<int>(new_version); // ret",https://github.com/bitcoin/bitcoin/pull/20403#issuecomment-728253158,728253158,
achow101,2020-11-16 18:50:23,ACK 377fa31,https://github.com/bitcoin/bitcoin/pull/20403#issuecomment-728255170,728255170,
jonatack,2020-11-17 16:50:19,Rebased after the merge of #20139 and addressed https://github.com/bitcoin/bitcoin/pull/20403#discussion_r524992713 with 877aba836ec48bfa881ec0dd90299015a3c27cce.,https://github.com/bitcoin/bitcoin/pull/20403#issuecomment-729057297,729057297,
jonatack,2020-11-18 12:49:06,"Found an edge case bug in the first commit, ""wallet: enable CWallet::UpgradeWallet to return updated version"", and the fix led to a simpler implementation.\n\nFixed two tests in the third commit, ""wallet: fix and improve upgradewallet result responses""; thanks @MarcoFalke for catching one of them. The other one led to seeing the edge case bug.\n\nRe-verified build and the `wallet_upgradewallet",https://github.com/bitcoin/bitcoin/pull/20403#issuecomment-729655687,729655687,
jonatack,2020-11-18 15:27:10,Dropped the first commit to call `GetVersion()` in `RPCHelpMan upgradewallet()`.,https://github.com/bitcoin/bitcoin/pull/20403#issuecomment-729754336,729754336,
jonatack,2020-11-19 08:08:46,Pulled in #20420.,https://github.com/bitcoin/bitcoin/pull/20403#issuecomment-730202907,730202907,
achow101,2020-11-19 19:05:32,ACK  3eb6f8b,https://github.com/bitcoin/bitcoin/pull/20403#issuecomment-730576312,730576312,
MarcoFalke,2020-11-25 11:53:05,Backported in #20490,https://github.com/bitcoin/bitcoin/pull/20403#issuecomment-733661230,733661230,
achow101,2020-11-16 18:34:01,Is `static_cast` necessary here? `WalletFeature` should already be an int.,https://github.com/bitcoin/bitcoin/pull/20403#discussion_r524486828,524486828,src/wallet/wallet.cpp
jonatack,2020-11-16 18:38:51,"Oh you're right, looks like we can just do `version = new_version` here. Will test a push without the cast. Thanks!",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r524489680,524489680,src/wallet/wallet.cpp
MarcoFalke,2020-11-17 09:08:54,"It looks like this is dead code, and always has been.\n\nIt would be easier to have one way to deal with errors. Either return them as `JSONRPCError` or as `{""error"":...}`, but not both. Also, the error approach should be documented.",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r524992713,524992713,src/wallet/rpcwallet.cpp
jonatack,2020-11-17 09:29:19,"Yes, I plan to have a look at this later today. That's the second part of my review feedback from #20282.\n\nIn #20391 I proposed returning an error field rather than raising an RPC error for this type of errors but wasn't sure which is preferred.",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525006514,525006514,src/wallet/rpcwallet.cpp
MarcoFalke,2020-11-17 09:56:36,"I think either is fine as long as it is documented and consistent. An RPCError makes sense when the return object would otherwise be empty and would have to omit a lot of optional fields, except for the error.",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525025383,525025383,src/wallet/rpcwallet.cpp
jonatack,2020-11-17 13:00:02,"Proposing this:\n```\n$ ./src/bitcoin-cli -signet -rpcwallet=""blank"" upgradewallet 5\n{\n  ""wallet_name"": ""blank"",\n  ""previous_version"": 169900,\n  ""current_version"": 169900,\n  ""error"": ""Cannot downgrade wallet from version 169900 to version 5""\n}\n```\n",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525134613,525134613,src/wallet/rpcwallet.cpp
jonatack,2020-11-17 13:02:38,"(currently that returns):\n```\n$ ./src/bitcoin-cli -signet -rpcwallet=""blank"" upgradewallet 5\nerror code: -4\nerror message:\nCannot downgrade wallet\n```\n",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525136126,525136126,src/wallet/rpcwallet.cpp
jonatack,2020-11-17 16:48:16,Done,https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525316759,525316759,src/wallet/rpcwallet.cpp
jonatack,2020-11-17 16:51:59,Let me know if there is anything needed WRT documenting the error approach.,https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525319514,525319514,src/wallet/rpcwallet.cpp
MarcoFalke,2020-11-17 17:02:29,"```suggestion\n    else { CHECK_NONFATAL(!error.empty());\n```",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525328086,525328086,src/wallet/rpcwallet.cpp
MarcoFalke,2020-11-17 17:04:29,"the translation shouldn't be changed here, if you want this to be backported",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525329735,525329735,src/wallet/wallet.cpp
jonatack,2020-11-17 17:18:24,"Oh right (thanks!) and same for the translation just above as well, I suppose\n```diff\n-        error = _(""Cannot downgrade wallet"");\n+        error = strprintf(_(""Cannot downgrade wallet from version %i to version %i. Wallet version unchanged.""), prev_version, version);\n```\n",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525341964,525341964,src/wallet/wallet.cpp
MarcoFalke,2020-11-17 17:55:28,"If you like the translation changes, you can put them into a separate commit and write ""not for backport"" in the commit body",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525369168,525369168,src/wallet/wallet.cpp
jonatack,2020-11-17 18:43:45,Thanks--done.,https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525400534,525400534,src/wallet/rpcwallet.cpp
jonatack,2020-11-17 19:19:24,"Done, thanks",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525424342,525424342,src/wallet/wallet.cpp
MarcoFalke,2020-11-18 08:09:46,This is not testing what the log claims to test,https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525884287,525884287,test/functional/wallet_upgradewallet.py
jonatack,2020-11-18 08:12:27,Good catch ,https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525886052,525886052,test/functional/wallet_upgradewallet.py
jonatack,2020-11-18 08:13:30,Thought: do translated strings need to be static? I should look at the implementation.,https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525887477,525887477,src/wallet/wallet.cpp
MarcoFalke,2020-11-18 08:15:05,"They can only be literals, but may include format specifiers",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r525889455,525889455,src/wallet/wallet.cpp
jonatack,2020-11-18 12:46:24,Fixed,https://github.com/bitcoin/bitcoin/pull/20403#discussion_r526059121,526059121,test/functional/wallet_upgradewallet.py
jonatack,2020-11-18 12:54:41,"@achow101 sanity check, if current version is 139900 `FEATURE_HD`, and upgradewallet 159900 `FEATURE_NO_DEFAULT_KEY` is called, is the wallet actually upgrading to 169900 `FEATURE_PRE_SPLIT_KEYPOOL/FEATURE_LATEST` the expected behavior ?",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r526063920,526063920,test/functional/wallet_upgradewallet.py
MarcoFalke,2020-11-18 14:46:06,"in commit 2310fe9685246b0d505495ee98d38c82a1730293: would be a smaller diff and less complexity if this was moved to the caller, no?",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r526143279,526143279,src/wallet/wallet.cpp
jonatack,2020-11-18 14:55:39,"Yes, I tried removing the first commit and just calling GetVersion() in `RPCHelpMan upgradewallet()` but the last test failed.\n\nLines 345, 96\nAssertionError: not({'wallet_name': '', 'previous_version': 139900, 'current_version': 169900, 'result': 'Wallet upgraded successfully from version 139900 to version 159900.'} == {'wallet_name': '', 'previous_version': 139900, 'current_version': 159900",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r526150676,526150676,src/wallet/wallet.cpp
jonatack,2020-11-18 15:02:16,"Hm, will try again.",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r526156133,526156133,src/wallet/wallet.cpp
jonatack,2020-11-18 15:14:41,I didn't update one of the version variables the first time. Seems good.,https://github.com/bitcoin/bitcoin/pull/20403#discussion_r526166042,526166042,src/wallet/wallet.cpp
achow101,2020-11-18 16:18:48,"Versions less than `FEATURE_HD_SPLIT` cannot upgrade to `FEATURE_HD_SPLIT` or `FEATURE_NO_DEFAULT_KEY`. They must upgrade to `FEATURE_PRE_SPLIT_KEYPOOL` at which time both the previous features will also be applied.\n\nIf a user specifies `FEATURE_NO_DEFAULT_KEY` on ` FEATURE_HD` wallet, we should probably give an error and tell the user they can't do that.\n\nEdit: This test is `FEATURE_HD_SP",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r526218796,526218796,test/functional/wallet_upgradewallet.py
achow101,2020-11-18 18:11:50,"Found it. Here's a fix.\n\n```diff\ndiff --git a/src/wallet/scriptpubkeyman.cpp b/src/wallet/scriptpubkeyman.cpp\nindex d2e1be6402..7dbbf17302 100644\n--- a/src/wallet/scriptpubkeyman.cpp\n+++ b/src/wallet/scriptpubkeyman.cpp\n@@ -453,7 +453,7 @@ bool LegacyScriptPubKeyMan::Upgrade(int prev_version, int new_version, bilingual\n         hd_upgrade = true;\n     }\n     // Upgrade to HD ch",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r526314740,526314740,test/functional/wallet_upgradewallet.py
achow101,2020-11-19 17:42:15,"In commit 4dc34408bfe8fa1c229d99a3d0d03a42c83ced69 ""wallet: fix and improve upgradewallet result responses""\n\n`requested_version` should be 129999, not 129900",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r527077372,527077372,test/functional/wallet_upgradewallet.py
achow101,2020-11-19 17:45:00,"In commit 4dc34408bfe8fa1c229d99a3d0d03a42c83ced69 ""wallet: fix and improve upgradewallet result responses""\n\nThe `assert_equal(wallet.getwalletinfo()[""walletversion""], 159900)` below can be removed now.",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r527079206,527079206,test/functional/wallet_upgradewallet.py
jonatack,2020-11-19 19:03:50,"Good catch, thanks. Done.",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r527128305,527128305,test/functional/wallet_upgradewallet.py
jonatack,2020-11-19 19:04:07,Thanks for confirming that. Done.,https://github.com/bitcoin/bitcoin/pull/20403#discussion_r527128481,527128481,test/functional/wallet_upgradewallet.py
luke-jr,2020-11-24 23:17:19,"""a"" is correct...",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r529992162,529992162,src/wallet/rpcwallet.cpp
jonatack,2020-11-24 23:28:41,https://www.referencepointsoftware.com/a-vs-an-before-an-abbreviation/,https://github.com/bitcoin/bitcoin/pull/20403#discussion_r530003033,530003033,src/wallet/rpcwallet.cpp
MarcoFalke,2020-11-25 11:36:25,"nit 99d56e357159c7154f69f28cb5587c5ca20d6594:\n\n```suggestion\n    def test_upgradewallet(self, wallet, *, previous_version, requested_version, expected_version=None):\n```\n\nCould force named args and pass requested_version in all cases for clarity. Only one call needs to be adjusted, I think.",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r530307834,530307834,test/functional/wallet_upgradewallet.py
MarcoFalke,2020-11-25 11:44:31,"style nit ca8cd893bb56bf5d455154b0498b1f58f77d20ed:\n\nThis should check (before the if) that there is either an error or a result, but not both.\n\n```cpp\n\nCHECK_NONFATAL(error.empty != result.empty());",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r530312324,530312324,src/wallet/rpcwallet.cpp
jonatack,2020-11-25 12:22:11,"> nit [99d56e3](https://github.com/bitcoin/bitcoin/commit/99d56e357159c7154f69f28cb5587c5ca20d6594):\n> \n> Could force named args and pass requested_version in all cases for clarity. Only one call needs to be adjusted, I think.\n\nThanks! Good idea.",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r530333145,530333145,test/functional/wallet_upgradewallet.py
jonatack,2020-11-25 12:24:05,"> style nit [ca8cd89](https://github.com/bitcoin/bitcoin/commit/ca8cd893bb56bf5d455154b0498b1f58f77d20ed):\n> \n> This should check (before the if) that there is either an error or a result, but not both.\n\nGood idea, that would be better.",https://github.com/bitcoin/bitcoin/pull/20403#discussion_r530334298,530334298,src/wallet/rpcwallet.cpp
jonatack,2020-11-27 17:32:34,Done in e915a2a2c87dad5beb68a175b21a07136bcc21ca,https://github.com/bitcoin/bitcoin/pull/20403#discussion_r531710908,531710908,test/functional/wallet_upgradewallet.py
jonatack,2020-11-27 17:32:42,Done in e915a2a2c87dad5beb68a175b21a07136bcc21ca,https://github.com/bitcoin/bitcoin/pull/20403#discussion_r531710951,531710951,src/wallet/rpcwallet.cpp
