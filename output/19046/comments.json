[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634004209",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19046#issuecomment-634004209",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19046",
    "id": 634004209,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDAwNDIwOQ==",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?u=13b19d1ff2f5f914e180c41418f451a4ba6f8bd1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-26T12:50:29Z",
    "updated_at": "2020-05-26T12:50:29Z",
    "author_association": "MEMBER",
    "body": "I agree that having separate Add/Load functions instead of a confusing boolean argument improves understandability of the code quite a bit.\r\nCode review ACK f123374a661d54e091108e490f8c4cc9ebc0d251",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634004209/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634280148",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19046#issuecomment-634280148",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19046",
    "id": 634280148,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDI4MDE0OA==",
    "user": {
      "login": "Empact",
      "id": 5470,
      "node_id": "MDQ6VXNlcjU0NzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5470?u=a1574ca2038ff1dfaa9a7764c59ea5ff4f305b5d&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Empact",
      "html_url": "https://github.com/Empact",
      "followers_url": "https://api.github.com/users/Empact/followers",
      "following_url": "https://api.github.com/users/Empact/following{/other_user}",
      "gists_url": "https://api.github.com/users/Empact/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Empact/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
      "organizations_url": "https://api.github.com/users/Empact/orgs",
      "repos_url": "https://api.github.com/users/Empact/repos",
      "events_url": "https://api.github.com/users/Empact/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Empact/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-26T21:08:25Z",
    "updated_at": "2020-05-26T21:08:25Z",
    "author_association": "MEMBER",
    "body": "Concept ACK",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634280148/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634913281",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19046#issuecomment-634913281",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19046",
    "id": 634913281,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDkxMzI4MQ==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-27T20:10:33Z",
    "updated_at": "2020-07-04T09:14:59Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18354 (Use shared pointers only in validation interface by bvbfan)\n* #16546 (External signer support - Wallet Box edition by Sjors)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634913281/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430710261",
    "pull_request_review_id": 418682314,
    "id": 430710261,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxMDI2MQ==",
    "diff_hunk": "@@ -1385,19 +1385,26 @@ bool CWallet::IsWalletFlagSet(uint64_t flag) const\n     return (m_wallet_flags & flag);\n }\n \n-bool CWallet::SetWalletFlags(uint64_t overwriteFlags, bool memonly)\n+bool CWallet::LoadWalletFlags(uint64_t flags)\n {\n     LOCK(cs_wallet);\n-    m_wallet_flags = overwriteFlags;\n-    if (((overwriteFlags & KNOWN_WALLET_FLAGS) >> 32) ^ (overwriteFlags >> 32)) {\n+    m_wallet_flags = flags;\n+    if (((flags & KNOWN_WALLET_FLAGS) >> 32) ^ (flags >> 32)) {\n         // contains unknown non-tolerable wallet flags\n         return false;\n     }\n-    if (!memonly && !WalletBatch(*database).WriteWalletFlags(m_wallet_flags)) {\n+\n+    return true;\n+}\n+\n+bool CWallet::AddWalletFlags(uint64_t flags)\n+{\n+    LOCK(cs_wallet);\n+    if (!WalletBatch(*database).WriteWalletFlags(flags)) {",
    "path": "src/wallet/wallet.cpp",
    "position": 25,
    "original_position": 23,
    "commit_id": "3a9aba21a49a6d80bd187940d5e26893937b6832",
    "original_commit_id": "f123374a661d54e091108e490f8c4cc9ebc0d251",
    "user": {
      "login": "Empact",
      "id": 5470,
      "node_id": "MDQ6VXNlcjU0NzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Empact",
      "html_url": "https://github.com/Empact",
      "followers_url": "https://api.github.com/users/Empact/followers",
      "following_url": "https://api.github.com/users/Empact/following{/other_user}",
      "gists_url": "https://api.github.com/users/Empact/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Empact/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
      "organizations_url": "https://api.github.com/users/Empact/orgs",
      "repos_url": "https://api.github.com/users/Empact/repos",
      "events_url": "https://api.github.com/users/Empact/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Empact/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In the existing code, on Add, the `contains unknown non-tolerable wallet flags` test and bail will occur first and prevent writing the database. With this change, the values are written, and the failure is only identified after, which seems improper.",
    "created_at": "2020-05-26T21:11:28Z",
    "updated_at": "2020-06-22T18:59:29Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r430710261",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430710261"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r430710261"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430710261/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1405,
    "original_line": 1405,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430710719",
    "pull_request_review_id": 418682897,
    "id": 430710719,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDcxMDcxOQ==",
    "diff_hunk": "@@ -1385,19 +1385,26 @@ bool CWallet::IsWalletFlagSet(uint64_t flag) const\n     return (m_wallet_flags & flag);\n }\n \n-bool CWallet::SetWalletFlags(uint64_t overwriteFlags, bool memonly)\n+bool CWallet::LoadWalletFlags(uint64_t flags)\n {\n     LOCK(cs_wallet);\n-    m_wallet_flags = overwriteFlags;\n-    if (((overwriteFlags & KNOWN_WALLET_FLAGS) >> 32) ^ (overwriteFlags >> 32)) {\n+    m_wallet_flags = flags;\n+    if (((flags & KNOWN_WALLET_FLAGS) >> 32) ^ (flags >> 32)) {\n         // contains unknown non-tolerable wallet flags\n         return false;\n     }\n-    if (!memonly && !WalletBatch(*database).WriteWalletFlags(m_wallet_flags)) {\n+\n+    return true;\n+}\n+\n+bool CWallet::AddWalletFlags(uint64_t flags)\n+{\n+    LOCK(cs_wallet);\n+    if (!WalletBatch(*database).WriteWalletFlags(flags)) {",
    "path": "src/wallet/wallet.cpp",
    "position": 25,
    "original_position": 23,
    "commit_id": "3a9aba21a49a6d80bd187940d5e26893937b6832",
    "original_commit_id": "f123374a661d54e091108e490f8c4cc9ebc0d251",
    "user": {
      "login": "Empact",
      "id": 5470,
      "node_id": "MDQ6VXNlcjU0NzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Empact",
      "html_url": "https://github.com/Empact",
      "followers_url": "https://api.github.com/users/Empact/followers",
      "following_url": "https://api.github.com/users/Empact/following{/other_user}",
      "gists_url": "https://api.github.com/users/Empact/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Empact/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
      "organizations_url": "https://api.github.com/users/Empact/orgs",
      "repos_url": "https://api.github.com/users/Empact/repos",
      "events_url": "https://api.github.com/users/Empact/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Empact/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Perhaps add a test for this case?",
    "created_at": "2020-05-26T21:12:27Z",
    "updated_at": "2020-06-22T18:59:29Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r430710719",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430710719"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r430710719"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430710719/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1405,
    "original_line": 1405,
    "side": "RIGHT",
    "in_reply_to_id": 430710261
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436810318",
    "pull_request_review_id": 426376858,
    "id": 436810318,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjgxMDMxOA==",
    "diff_hunk": "@@ -1385,19 +1385,26 @@ bool CWallet::IsWalletFlagSet(uint64_t flag) const\n     return (m_wallet_flags & flag);\n }\n \n-bool CWallet::SetWalletFlags(uint64_t overwriteFlags, bool memonly)\n+bool CWallet::LoadWalletFlags(uint64_t flags)\n {\n     LOCK(cs_wallet);\n-    m_wallet_flags = overwriteFlags;\n-    if (((overwriteFlags & KNOWN_WALLET_FLAGS) >> 32) ^ (overwriteFlags >> 32)) {\n+    m_wallet_flags = flags;\n+    if (((flags & KNOWN_WALLET_FLAGS) >> 32) ^ (flags >> 32)) {\n         // contains unknown non-tolerable wallet flags\n         return false;\n     }\n-    if (!memonly && !WalletBatch(*database).WriteWalletFlags(m_wallet_flags)) {\n+\n+    return true;\n+}\n+\n+bool CWallet::AddWalletFlags(uint64_t flags)\n+{\n+    LOCK(cs_wallet);\n+    if (!WalletBatch(*database).WriteWalletFlags(flags)) {",
    "path": "src/wallet/wallet.cpp",
    "position": 25,
    "original_position": 23,
    "commit_id": "3a9aba21a49a6d80bd187940d5e26893937b6832",
    "original_commit_id": "f123374a661d54e091108e490f8c4cc9ebc0d251",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "That failure is only relevant when loading a wallet from disk. `AddWalletFlags` is only used internally in wallet creation; we would never add flags that we don't know.",
    "created_at": "2020-06-08T15:49:20Z",
    "updated_at": "2020-06-22T18:59:29Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r436810318",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436810318"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r436810318"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/436810318/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1405,
    "original_line": 1405,
    "side": "RIGHT",
    "in_reply_to_id": 430710261
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443611201",
    "pull_request_review_id": 434993289,
    "id": 443611201,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYxMTIwMQ==",
    "diff_hunk": "@@ -1385,19 +1385,26 @@ bool CWallet::IsWalletFlagSet(uint64_t flag) const\n     return (m_wallet_flags & flag);\n }\n \n-bool CWallet::SetWalletFlags(uint64_t overwriteFlags, bool memonly)\n+bool CWallet::LoadWalletFlags(uint64_t flags)\n {\n     LOCK(cs_wallet);\n-    m_wallet_flags = overwriteFlags;\n-    if (((overwriteFlags & KNOWN_WALLET_FLAGS) >> 32) ^ (overwriteFlags >> 32)) {\n+    m_wallet_flags = flags;\n+    if (((flags & KNOWN_WALLET_FLAGS) >> 32) ^ (flags >> 32)) {\n         // contains unknown non-tolerable wallet flags\n         return false;\n     }\n-    if (!memonly && !WalletBatch(*database).WriteWalletFlags(m_wallet_flags)) {\n+\n+    return true;\n+}\n+\n+bool CWallet::AddWalletFlags(uint64_t flags)\n+{\n+    LOCK(cs_wallet);\n+    if (!WalletBatch(*database).WriteWalletFlags(flags)) {",
    "path": "src/wallet/wallet.cpp",
    "position": 25,
    "original_position": 23,
    "commit_id": "3a9aba21a49a6d80bd187940d5e26893937b6832",
    "original_commit_id": "f123374a661d54e091108e490f8c4cc9ebc0d251",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I agree that this seems less safe than the existing code. Is it possible to maintain the current order of checking first and then writing to disk?",
    "created_at": "2020-06-22T14:43:05Z",
    "updated_at": "2020-06-22T18:59:29Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r443611201",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443611201"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r443611201"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443611201/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1405,
    "original_line": 1405,
    "side": "RIGHT",
    "in_reply_to_id": 430710261
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443624565",
    "pull_request_review_id": 435011225,
    "id": 443624565,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYyNDU2NQ==",
    "diff_hunk": "@@ -1385,19 +1385,26 @@ bool CWallet::IsWalletFlagSet(uint64_t flag) const\n     return (m_wallet_flags & flag);\n }\n \n-bool CWallet::SetWalletFlags(uint64_t overwriteFlags, bool memonly)\n+bool CWallet::LoadWalletFlags(uint64_t flags)\n {\n     LOCK(cs_wallet);\n-    m_wallet_flags = overwriteFlags;\n-    if (((overwriteFlags & KNOWN_WALLET_FLAGS) >> 32) ^ (overwriteFlags >> 32)) {\n+    m_wallet_flags = flags;\n+    if (((flags & KNOWN_WALLET_FLAGS) >> 32) ^ (flags >> 32)) {\n         // contains unknown non-tolerable wallet flags\n         return false;\n     }\n-    if (!memonly && !WalletBatch(*database).WriteWalletFlags(m_wallet_flags)) {\n+\n+    return true;\n+}\n+\n+bool CWallet::AddWalletFlags(uint64_t flags)\n+{\n+    LOCK(cs_wallet);\n+    if (!WalletBatch(*database).WriteWalletFlags(flags)) {",
    "path": "src/wallet/wallet.cpp",
    "position": 25,
    "original_position": 23,
    "commit_id": "3a9aba21a49a6d80bd187940d5e26893937b6832",
    "original_commit_id": "f123374a661d54e091108e490f8c4cc9ebc0d251",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> I agree that this seems less safe than the existing code.\r\n\r\nIn current code m_wallet_flags can be updated even if database write fails leading to inconsistency between disk and memory state and possibility for data inconsistent with flags to subseqently be written to wallet. New code writing to disk first, memory second, prevents this type of issue and would seem to be more safe. What's the scenario where it's less safe?",
    "created_at": "2020-06-22T15:01:01Z",
    "updated_at": "2020-06-22T18:59:29Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r443624565",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443624565"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r443624565"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443624565/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1405,
    "original_line": 1405,
    "side": "RIGHT",
    "in_reply_to_id": 430710261
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443641850",
    "pull_request_review_id": 435034825,
    "id": 443641850,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY0MTg1MA==",
    "diff_hunk": "@@ -1385,19 +1385,26 @@ bool CWallet::IsWalletFlagSet(uint64_t flag) const\n     return (m_wallet_flags & flag);\n }\n \n-bool CWallet::SetWalletFlags(uint64_t overwriteFlags, bool memonly)\n+bool CWallet::LoadWalletFlags(uint64_t flags)\n {\n     LOCK(cs_wallet);\n-    m_wallet_flags = overwriteFlags;\n-    if (((overwriteFlags & KNOWN_WALLET_FLAGS) >> 32) ^ (overwriteFlags >> 32)) {\n+    m_wallet_flags = flags;\n+    if (((flags & KNOWN_WALLET_FLAGS) >> 32) ^ (flags >> 32)) {\n         // contains unknown non-tolerable wallet flags\n         return false;\n     }\n-    if (!memonly && !WalletBatch(*database).WriteWalletFlags(m_wallet_flags)) {\n+\n+    return true;\n+}\n+\n+bool CWallet::AddWalletFlags(uint64_t flags)\n+{\n+    LOCK(cs_wallet);\n+    if (!WalletBatch(*database).WriteWalletFlags(flags)) {",
    "path": "src/wallet/wallet.cpp",
    "position": 25,
    "original_position": 23,
    "commit_id": "3a9aba21a49a6d80bd187940d5e26893937b6832",
    "original_commit_id": "f123374a661d54e091108e490f8c4cc9ebc0d251",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "If this function is called with an unknown wallet flag, it'll be written to disk and then won't be applied to the in-memory wallet (and won't be able to be loaded later), which is also a data inconsistency.\r\n\r\nThe unknown flag check was added to protect when loading a wallet from a newer version on an older version, so I think your concern is more valid. I don't see any harm in a sanity assert that we don't try to add an unknown flag to the wallet before writing to disk.",
    "created_at": "2020-06-22T15:25:58Z",
    "updated_at": "2020-06-22T18:59:29Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r443641850",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443641850"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r443641850"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443641850/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1405,
    "original_line": 1405,
    "side": "RIGHT",
    "in_reply_to_id": 430710261
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443764318",
    "pull_request_review_id": 435194275,
    "id": 443764318,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2NDMxOA==",
    "diff_hunk": "@@ -1385,19 +1385,26 @@ bool CWallet::IsWalletFlagSet(uint64_t flag) const\n     return (m_wallet_flags & flag);\n }\n \n-bool CWallet::SetWalletFlags(uint64_t overwriteFlags, bool memonly)\n+bool CWallet::LoadWalletFlags(uint64_t flags)\n {\n     LOCK(cs_wallet);\n-    m_wallet_flags = overwriteFlags;\n-    if (((overwriteFlags & KNOWN_WALLET_FLAGS) >> 32) ^ (overwriteFlags >> 32)) {\n+    m_wallet_flags = flags;\n+    if (((flags & KNOWN_WALLET_FLAGS) >> 32) ^ (flags >> 32)) {\n         // contains unknown non-tolerable wallet flags\n         return false;\n     }\n-    if (!memonly && !WalletBatch(*database).WriteWalletFlags(m_wallet_flags)) {\n+\n+    return true;\n+}\n+\n+bool CWallet::AddWalletFlags(uint64_t flags)\n+{\n+    LOCK(cs_wallet);\n+    if (!WalletBatch(*database).WriteWalletFlags(flags)) {",
    "path": "src/wallet/wallet.cpp",
    "position": 25,
    "original_position": 23,
    "commit_id": "3a9aba21a49a6d80bd187940d5e26893937b6832",
    "original_commit_id": "f123374a661d54e091108e490f8c4cc9ebc0d251",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I've added an assert in `AddWalletFlags` to handle that case.",
    "created_at": "2020-06-22T18:59:57Z",
    "updated_at": "2020-06-22T18:59:58Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r443764318",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443764318"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r443764318"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443764318/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1405,
    "original_line": 1405,
    "side": "RIGHT",
    "in_reply_to_id": 430710261
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443783101",
    "pull_request_review_id": 435218511,
    "id": 443783101,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc4MzEwMQ==",
    "diff_hunk": "@@ -1385,19 +1385,28 @@ bool CWallet::IsWalletFlagSet(uint64_t flag) const\n     return (m_wallet_flags & flag);\n }\n \n-bool CWallet::SetWalletFlags(uint64_t overwriteFlags, bool memonly)\n+bool CWallet::LoadWalletFlags(uint64_t flags)\n {\n     LOCK(cs_wallet);\n-    m_wallet_flags = overwriteFlags;\n-    if (((overwriteFlags & KNOWN_WALLET_FLAGS) >> 32) ^ (overwriteFlags >> 32)) {\n+    if (((flags & KNOWN_WALLET_FLAGS) >> 32) ^ (flags >> 32)) {\n         // contains unknown non-tolerable wallet flags\n         return false;\n     }\n-    if (!memonly && !WalletBatch(*database).WriteWalletFlags(m_wallet_flags)) {\n+    m_wallet_flags = flags;\n+\n+    return true;\n+}\n+\n+bool CWallet::AddWalletFlags(uint64_t flags)\n+{\n+    LOCK(cs_wallet);\n+    // We should never be writing unknown onon-tolerable wallet flags",
    "path": "src/wallet/wallet.cpp",
    "position": 23,
    "original_position": 23,
    "commit_id": "3a9aba21a49a6d80bd187940d5e26893937b6832",
    "original_commit_id": "3a9aba21a49a6d80bd187940d5e26893937b6832",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "s/onon/non/",
    "created_at": "2020-06-22T19:39:06Z",
    "updated_at": "2020-06-22T19:39:32Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r443783101",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443783101"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r443783101"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443783101/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1403,
    "original_line": 1403,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443793690",
    "pull_request_review_id": 435232354,
    "id": 443793690,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc5MzY5MA==",
    "diff_hunk": "@@ -1385,19 +1385,28 @@ bool CWallet::IsWalletFlagSet(uint64_t flag) const\n     return (m_wallet_flags & flag);\n }\n \n-bool CWallet::SetWalletFlags(uint64_t overwriteFlags, bool memonly)\n+bool CWallet::LoadWalletFlags(uint64_t flags)\n {\n     LOCK(cs_wallet);\n-    m_wallet_flags = overwriteFlags;\n-    if (((overwriteFlags & KNOWN_WALLET_FLAGS) >> 32) ^ (overwriteFlags >> 32)) {\n+    if (((flags & KNOWN_WALLET_FLAGS) >> 32) ^ (flags >> 32)) {\n         // contains unknown non-tolerable wallet flags\n         return false;\n     }\n-    if (!memonly && !WalletBatch(*database).WriteWalletFlags(m_wallet_flags)) {\n+    m_wallet_flags = flags;\n+\n+    return true;\n+}\n+\n+bool CWallet::AddWalletFlags(uint64_t flags)\n+{\n+    LOCK(cs_wallet);\n+    // We should never be writing unknown onon-tolerable wallet flags\n+    assert(!(((flags & KNOWN_WALLET_FLAGS) >> 32) ^ (flags >> 32)));",
    "path": "src/wallet/wallet.cpp",
    "position": 24,
    "original_position": 24,
    "commit_id": "3a9aba21a49a6d80bd187940d5e26893937b6832",
    "original_commit_id": "3a9aba21a49a6d80bd187940d5e26893937b6832",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Split SetWalletFlags into Add/LoadWalletFlags\" (3a9aba21a49a6d80bd187940d5e26893937b6832)\r\n\r\nIf you wind up updating check may be more readable as `assert(((flags & KNOWN_WALLET_FLAGS) >> 32) == (flags >> 32))`",
    "created_at": "2020-06-22T20:01:36Z",
    "updated_at": "2020-06-22T20:04:25Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r443793690",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443793690"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r443793690"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/443793690/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1404,
    "original_line": 1404,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/445661428",
    "pull_request_review_id": 437631187,
    "id": 445661428,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY2MTQyOA==",
    "diff_hunk": "@@ -1385,19 +1385,28 @@ bool CWallet::IsWalletFlagSet(uint64_t flag) const\n     return (m_wallet_flags & flag);\n }\n \n-bool CWallet::SetWalletFlags(uint64_t overwriteFlags, bool memonly)\n+bool CWallet::LoadWalletFlags(uint64_t flags)\n {\n     LOCK(cs_wallet);\n-    m_wallet_flags = overwriteFlags;\n-    if (((overwriteFlags & KNOWN_WALLET_FLAGS) >> 32) ^ (overwriteFlags >> 32)) {\n+    if (((flags & KNOWN_WALLET_FLAGS) >> 32) ^ (flags >> 32)) {\n         // contains unknown non-tolerable wallet flags\n         return false;\n     }\n-    if (!memonly && !WalletBatch(*database).WriteWalletFlags(m_wallet_flags)) {\n+    m_wallet_flags = flags;\n+\n+    return true;\n+}\n+\n+bool CWallet::AddWalletFlags(uint64_t flags)\n+{\n+    LOCK(cs_wallet);\n+    // We should never be writing unknown onon-tolerable wallet flags",
    "path": "src/wallet/wallet.cpp",
    "position": 23,
    "original_position": 23,
    "commit_id": "3a9aba21a49a6d80bd187940d5e26893937b6832",
    "original_commit_id": "3a9aba21a49a6d80bd187940d5e26893937b6832",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Oops. I'll fix that if I have to push again.",
    "created_at": "2020-06-25T15:52:08Z",
    "updated_at": "2020-06-25T15:52:09Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r445661428",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/445661428"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19046#discussion_r445661428"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19046"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/445661428/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1403,
    "original_line": 1403,
    "side": "RIGHT",
    "in_reply_to_id": 443783101
  }
]