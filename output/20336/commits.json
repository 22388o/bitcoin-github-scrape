[
  {
    "sha": "e8cdcc444a14441cf81bf57a8108228c595ad9e5",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplOGNkY2M0NDRhMTQ0NDFjZjgxYmY1N2E4MTA4MjI4YzU5NWFkOWU1",
    "commit": {
      "author": {
        "name": "fanquake",
        "email": "fanquake@gmail.com",
        "date": "2020-11-08T06:43:58Z"
      },
      "committer": {
        "name": "fanquake",
        "email": "fanquake@gmail.com",
        "date": "2020-11-08T06:43:58Z"
      },
      "message": "build: automatically determine macOS translations\n\nRather than using OSX_QT_TRANSLATIONS which must be manually updated,\nand we forget to update anyway, i.e: #19059, automatically find and copy\navailable translations from the translations directory.",
      "tree": {
        "sha": "52ae8a023e4d4c2d81b6e81961b426243e61854e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/52ae8a023e4d4c2d81b6e81961b426243e61854e"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e8cdcc444a14441cf81bf57a8108228c595ad9e5",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEz7FuIclQ9n+pXlWPLuufXMCVJsEFAl+nlCoACgkQLuufXMCV\nJsEfkg//ThjsRzrpMCIH1UDMKQDKipj8qCfHzXpL1+f/d/mQpkoQ243J51JQCcug\n9vK5KhmUYPVMVKUlthdJrS9u3dGJ5hxalKUdsFs5GItoA66kFVNz4KJC8Df8+4oO\n3C+IysS0OA54EtB5qN4WS+GmCYRdoxgSJUCHDCQoHVLIZsTpRTEfSwS+WtL/UOb4\nIhRm9gC/gwien+9XSv9krfCZFY3pRARDVgfhgEFJsUPfRzIT/3xPOuynTd7skVvR\n05TPKV0WpnFJXMArwhgxo5qANkSwZSn6Y/6o2PqqICqRBd7p0QIB1VkuT6+Y98Tc\njQgYwBze+S6i9M7peZrhseTdVQuiKAtrhixdp8j4KHv+Qq17oIK87SvQZ5u+/4J5\n/H0J4zmqXxnxu4sr5m8u3CPzA7liP4zzSTaYkifFmYLodpSI5Mxtc2Us14SBX5OW\n/zRl8im/YFrrGD8cRgD7f7A/ZS2VeXYPFP/wRiMjjSIsOfs/Dzez/WId7z7OUReA\nPWpn/oE2GgjWN6kUbulbVQF3NT+Z9VovCOtMMrHQMEUCfHgkZrwy8ugQE/x3Ah3V\nFyySvqKI0sH24DHc+ZAqjzZX+QWIlyRalP0OfbjFur8fm/1wz4At6Kk5ngfzkO+Z\nWDehkJdTljkQkPvcnHzC4J3lnDnfPLH0L7CIowcFf0DPmGHMVko=\n=8y3K\n-----END PGP SIGNATURE-----",
        "payload": "tree 52ae8a023e4d4c2d81b6e81961b426243e61854e\nparent 7e373294a5ae819099c39d9d03d1f5a311d63cfc\nauthor fanquake <fanquake@gmail.com> 1604817838 +0800\ncommitter fanquake <fanquake@gmail.com> 1604817838 +0800\n\nbuild: automatically determine macOS translations\n\nRather than using OSX_QT_TRANSLATIONS which must be manually updated,\nand we forget to update anyway, i.e: #19059, automatically find and copy\navailable translations from the translations directory.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e8cdcc444a14441cf81bf57a8108228c595ad9e5",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e8cdcc444a14441cf81bf57a8108228c595ad9e5",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e8cdcc444a14441cf81bf57a8108228c595ad9e5/comments",
    "author": {
      "login": "fanquake",
      "id": 863730,
      "node_id": "MDQ6VXNlcjg2MzczMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fanquake",
      "html_url": "https://github.com/fanquake",
      "followers_url": "https://api.github.com/users/fanquake/followers",
      "following_url": "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url": "https://api.github.com/users/fanquake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
      "organizations_url": "https://api.github.com/users/fanquake/orgs",
      "repos_url": "https://api.github.com/users/fanquake/repos",
      "events_url": "https://api.github.com/users/fanquake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fanquake/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "fanquake",
      "id": 863730,
      "node_id": "MDQ6VXNlcjg2MzczMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fanquake",
      "html_url": "https://github.com/fanquake",
      "followers_url": "https://api.github.com/users/fanquake/followers",
      "following_url": "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url": "https://api.github.com/users/fanquake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
      "organizations_url": "https://api.github.com/users/fanquake/orgs",
      "repos_url": "https://api.github.com/users/fanquake/repos",
      "events_url": "https://api.github.com/users/fanquake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fanquake/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "7e373294a5ae819099c39d9d03d1f5a311d63cfc",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7e373294a5ae819099c39d9d03d1f5a311d63cfc",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/7e373294a5ae819099c39d9d03d1f5a311d63cfc"
      }
    ],
    "stats": {
      "total": 69,
      "additions": 23,
      "deletions": 46
    },
    "files": [
      {
        "sha": "f7e2fbbd28b456b973b173afc1ff1e5c2ce25533",
        "filename": "Makefile.am",
        "status": "modified",
        "additions": 2,
        "deletions": 3,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e8cdcc444a14441cf81bf57a8108228c595ad9e5/Makefile.am",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e8cdcc444a14441cf81bf57a8108228c595ad9e5/Makefile.am",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/Makefile.am?ref=e8cdcc444a14441cf81bf57a8108228c595ad9e5",
        "patch": "@@ -41,7 +41,6 @@ OSX_DEPLOY_SCRIPT=$(top_srcdir)/contrib/macdeploy/macdeployqtplus\n OSX_FANCY_PLIST=$(top_srcdir)/contrib/macdeploy/fancy.plist\n OSX_INSTALLER_ICONS=$(top_srcdir)/src/qt/res/icons/bitcoin.icns\n OSX_PLIST=$(top_builddir)/share/qt/Info.plist #not installed\n-OSX_QT_TRANSLATIONS = ar,bg,ca,cs,da,de,es,fa,fi,fr,gd,gl,he,hu,it,ja,ko,lt,lv,pl,pt,ru,sk,sl,sv,uk,zh_CN,zh_TW\n \n DIST_CONTRIB = \\\n \t       $(top_srcdir)/contrib/linearize/linearize-data.py \\\n@@ -117,7 +116,7 @@ osx_volname:\n \n if BUILD_DARWIN\n $(OSX_DMG): $(OSX_APP_BUILT) $(OSX_PACKAGING) $(OSX_BACKGROUND_IMAGE)\n-\t$(PYTHON) $(OSX_DEPLOY_SCRIPT) $(OSX_APP) -add-qt-tr $(OSX_QT_TRANSLATIONS) -translations-dir=$(QT_TRANSLATION_DIR) -dmg -fancy $(OSX_FANCY_PLIST) -verbose 2 -volname $(OSX_VOLNAME)\n+\t$(PYTHON) $(OSX_DEPLOY_SCRIPT) $(OSX_APP) -translations-dir=$(QT_TRANSLATION_DIR) -dmg -fancy $(OSX_FANCY_PLIST) -verbose 2 -volname $(OSX_VOLNAME)\n \n $(OSX_BACKGROUND_IMAGE).png: contrib/macdeploy/$(OSX_BACKGROUND_SVG)\n \tsed 's/PACKAGE_NAME/$(PACKAGE_NAME)/' < \"$<\" | $(RSVG_CONVERT) -f png -d 36 -p 36 -o $@\n@@ -151,7 +150,7 @@ $(APP_DIST_DIR)/.DS_Store: $(OSX_DSSTORE_GEN)\n \t$(PYTHON) $< \"$@\" \"$(OSX_VOLNAME)\"\n \n $(APP_DIST_DIR)/$(OSX_APP)/Contents/MacOS/Bitcoin-Qt: $(OSX_APP_BUILT) $(OSX_PACKAGING)\n-\tINSTALLNAMETOOL=$(INSTALLNAMETOOL)  OTOOL=$(OTOOL) STRIP=$(STRIP) $(PYTHON) $(OSX_DEPLOY_SCRIPT) $(OSX_APP) -translations-dir=$(QT_TRANSLATION_DIR) -add-qt-tr $(OSX_QT_TRANSLATIONS) -verbose 2\n+\tINSTALLNAMETOOL=$(INSTALLNAMETOOL)  OTOOL=$(OTOOL) STRIP=$(STRIP) $(PYTHON) $(OSX_DEPLOY_SCRIPT) $(OSX_APP) -translations-dir=$(QT_TRANSLATION_DIR) -verbose 2\n \n deploydir: $(APP_DIST_EXTRAS)\n endif"
      },
      {
        "sha": "73ccf55579bbf2e741bec41ac6ace003c5161f91",
        "filename": "contrib/macdeploy/macdeployqtplus",
        "status": "modified",
        "additions": 21,
        "deletions": 42,
        "changes": 63,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e8cdcc444a14441cf81bf57a8108228c595ad9e5/contrib/macdeploy/macdeployqtplus",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e8cdcc444a14441cf81bf57a8108228c595ad9e5/contrib/macdeploy/macdeployqtplus",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/contrib/macdeploy/macdeployqtplus?ref=e8cdcc444a14441cf81bf57a8108228c595ad9e5",
        "patch": "@@ -17,8 +17,9 @@\n #\n \n import subprocess, sys, re, os, shutil, stat, os.path, time\n-from string import Template\n from argparse import ArgumentParser\n+from pathlib import Path\n+from string import Template\n from typing import List, Optional\n \n # This is ported from the original macdeployqt with modifications\n@@ -526,8 +527,7 @@ ap.add_argument(\"-no-strip\", dest=\"strip\", action=\"store_false\", default=True, h\n ap.add_argument(\"-sign\", dest=\"sign\", action=\"store_true\", default=False, help=\"sign .app bundle with codesign tool\")\n ap.add_argument(\"-dmg\", nargs=\"?\", const=\"\", metavar=\"basename\", help=\"create a .dmg disk image; if basename is not specified, a camel-cased version of the app name is used\")\n ap.add_argument(\"-fancy\", nargs=1, metavar=\"plist\", default=[], help=\"make a fancy looking disk image using the given plist file with instructions; requires -dmg to work\")\n-ap.add_argument(\"-add-qt-tr\", nargs=1, metavar=\"languages\", default=[], help=\"add Qt translation files to the bundle's resources; the language list must be separated with commas, not with whitespace\")\n-ap.add_argument(\"-translations-dir\", nargs=1, metavar=\"path\", default=None, help=\"Path to Qt's translation files\")\n+ap.add_argument(\"-translations-dir\", nargs=1, metavar=\"path\", default=None, help=\"Path to Qt's translations. Base translations will automatically be added to the bundle's resources.\")\n ap.add_argument(\"-add-resources\", nargs=\"+\", metavar=\"path\", default=[], help=\"list of additional files or folders to be copied into the bundle's resources; must be the last argument\")\n ap.add_argument(\"-volname\", nargs=1, metavar=\"volname\", default=[], help=\"custom volume name for dmg\")\n \n@@ -547,15 +547,6 @@ if not os.path.exists(app_bundle):\n app_bundle_name = os.path.splitext(os.path.basename(app_bundle))[0]\n \n # ------------------------------------------------\n-translations_dir = None\n-if config.translations_dir and config.translations_dir[0]:\n-    if os.path.exists(config.translations_dir[0]):\n-        translations_dir = config.translations_dir[0]\n-    else:\n-        if verbose >= 1:\n-            sys.stderr.write(\"Error: Could not find translation dir \\\"{}\\\"\\n\".format(translations_dir))\n-        sys.exit(1)\n-# ------------------------------------------------\n \n for p in config.add_resources:\n     if verbose >= 3:\n@@ -684,26 +675,24 @@ if config.plugins:\n \n # ------------------------------------------------\n \n-if len(config.add_qt_tr) == 0:\n-    add_qt_tr = []\n-else:\n-    if translations_dir is not None:\n-        qt_tr_dir = translations_dir\n-    else:\n-        if deploymentInfo.qtPath is not None:\n-            qt_tr_dir = os.path.join(deploymentInfo.qtPath, \"translations\")\n-        else:\n-            sys.stderr.write(\"Error: Could not find Qt translation path\\n\")\n-            sys.exit(1)\n-    add_qt_tr = [\"qt_{}.qm\".format(lng) for lng in config.add_qt_tr[0].split(\",\")]\n-    for lng_file in add_qt_tr:\n-        p = os.path.join(qt_tr_dir, lng_file)\n-        if verbose >= 3:\n-            print(\"Checking for \\\"{}\\\"...\".format(p))\n-        if not os.path.exists(p):\n-            if verbose >= 1:\n-                sys.stderr.write(\"Error: Could not find Qt translation file \\\"{}\\\"\\n\".format(lng_file))\n-                sys.exit(1)\n+if config.translations_dir:\n+    if not Path(config.translations_dir[0]).exists():\n+        sys.stderr.write(\"Error: Could not find translation dir \\\"{}\\\"\\n\".format(translations_dir))\n+        sys.exit(1)\n+\n+if verbose >= 2:\n+    print(\"+ Adding Qt translations +\")\n+\n+translations = Path(config.translations_dir[0])\n+\n+regex = re.compile('qt_[a-z]*(.qm|_[A-Z]*.qm)')\n+\n+lang_files = [x for x in translations.iterdir() if regex.match(x.name)]\n+\n+for file in lang_files:\n+    if verbose >= 3:\n+        print(file.as_posix(), \"->\", os.path.join(applicationBundle.resourcesPath, file.name))\n+    shutil.copy2(file.as_posix(), os.path.join(applicationBundle.resourcesPath, file.name))\n \n # ------------------------------------------------\n \n@@ -715,16 +704,6 @@ with open(os.path.join(applicationBundle.resourcesPath, \"qt.conf\"), \"wb\") as f:\n \n # ------------------------------------------------\n \n-if len(add_qt_tr) > 0 and verbose >= 2:\n-    print(\"+ Adding Qt translations +\")\n-\n-for lng_file in add_qt_tr:\n-    if verbose >= 3:\n-        print(os.path.join(qt_tr_dir, lng_file), \"->\", os.path.join(applicationBundle.resourcesPath, lng_file))\n-    shutil.copy2(os.path.join(qt_tr_dir, lng_file), os.path.join(applicationBundle.resourcesPath, lng_file))\n-\n-# ------------------------------------------------\n-\n if len(config.add_resources) > 0 and verbose >= 2:\n     print(\"+ Adding additional resources +\")\n "
      },
      {
        "sha": "eddd341ccae2345b140d92072545377675e109e7",
        "filename": "depends/packages/qt.mk",
        "status": "modified",
        "additions": 0,
        "deletions": 1,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e8cdcc444a14441cf81bf57a8108228c595ad9e5/depends/packages/qt.mk",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e8cdcc444a14441cf81bf57a8108228c595ad9e5/depends/packages/qt.mk",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/depends/packages/qt.mk?ref=e8cdcc444a14441cf81bf57a8108228c595ad9e5",
        "patch": "@@ -13,7 +13,6 @@ $(package)_patches+= fix_rcc_determinism.patch fix_riscv64_arch.patch xkb-defaul\n $(package)_patches+= fix_android_qmake_conf.patch fix_android_jni_static.patch dont_hardcode_pwd.patch\n $(package)_patches+= freetype_back_compat.patch drop_lrelease_dependency.patch fix_powerpc_libpng.patch\n \n-# Update OSX_QT_TRANSLATIONS when this is updated\n $(package)_qttranslations_file_name=qttranslations-$($(package)_suffix)\n $(package)_qttranslations_sha256_hash=fb5a47799754af73d3bf501fe513342cfe2fc37f64e80df5533f6110e804220c\n "
      }
    ]
  }
]