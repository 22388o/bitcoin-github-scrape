[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669408329",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-669408329",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
    "id": 669408329,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2OTQwODMyOQ==",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-05T19:00:07Z",
    "updated_at": "2020-08-05T19:00:07Z",
    "author_association": "MEMBER",
    "body": "This should fix #19500, but I need to figure out how to test this...",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669408329/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669800157",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-669800157",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
    "id": 669800157,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2OTgwMDE1Nw==",
    "user": {
      "login": "practicalswift",
      "id": 7826565,
      "node_id": "MDQ6VXNlcjc4MjY1NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7826565?u=5ff13e375b40ea55ecd3c108337dd6a23f68eddf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/practicalswift",
      "html_url": "https://github.com/practicalswift",
      "followers_url": "https://api.github.com/users/practicalswift/followers",
      "following_url": "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url": "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
      "organizations_url": "https://api.github.com/users/practicalswift/orgs",
      "repos_url": "https://api.github.com/users/practicalswift/repos",
      "events_url": "https://api.github.com/users/practicalswift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/practicalswift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-06T08:49:28Z",
    "updated_at": "2020-08-06T08:49:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "Concept ACK (modulo proper testing of course :))",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669800157/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669844501",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-669844501",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
    "id": 669844501,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2OTg0NDUwMQ==",
    "user": {
      "login": "naumenkogs",
      "id": 7975071,
      "node_id": "MDQ6VXNlcjc5NzUwNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7975071?u=06eb9ae4f9b3f954056098860decccbf1340e40f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naumenkogs",
      "html_url": "https://github.com/naumenkogs",
      "followers_url": "https://api.github.com/users/naumenkogs/followers",
      "following_url": "https://api.github.com/users/naumenkogs/following{/other_user}",
      "gists_url": "https://api.github.com/users/naumenkogs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
      "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
      "repos_url": "https://api.github.com/users/naumenkogs/repos",
      "events_url": "https://api.github.com/users/naumenkogs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-06T10:21:05Z",
    "updated_at": "2020-08-06T10:21:05Z",
    "author_association": "MEMBER",
    "body": "Concept ACK.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/669844501/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/670011410",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-670011410",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
    "id": 670011410,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3MDAxMTQxMA==",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-06T15:47:57Z",
    "updated_at": "2020-08-06T15:47:57Z",
    "author_association": "MEMBER",
    "body": "@wtogami ",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/670011410/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/670029755",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-670029755",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
    "id": 670029755,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3MDAyOTc1NQ==",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-06T16:18:33Z",
    "updated_at": "2020-08-06T16:18:33Z",
    "author_association": "MEMBER",
    "body": "Updated to fix two bugs I discovered, and I did some light manual testing and verified that this seems to now do what is intended.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/670029755/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/670228200",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-670228200",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
    "id": 670228200,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3MDIyODIwMA==",
    "user": {
      "login": "ghost",
      "id": 10137,
      "node_id": "MDQ6VXNlcjEwMTM3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10137?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ghost",
      "html_url": "https://github.com/ghost",
      "followers_url": "https://api.github.com/users/ghost/followers",
      "following_url": "https://api.github.com/users/ghost/following{/other_user}",
      "gists_url": "https://api.github.com/users/ghost/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ghost/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ghost/subscriptions",
      "organizations_url": "https://api.github.com/users/ghost/orgs",
      "repos_url": "https://api.github.com/users/ghost/repos",
      "events_url": "https://api.github.com/users/ghost/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ghost/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-06T22:47:11Z",
    "updated_at": "2020-08-12T06:45:01Z",
    "author_association": "NONE",
    "body": "@sdaftuar I've boldly copied all the changes to `net.cpp` and recompiled/rebuild `bitcoind` (0.20.0). I will report back if it solves my issue but that will take some time (a few weeks or longer).",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/670228200/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/673844477",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-673844477",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
    "id": 673844477,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3Mzg0NDQ3Nw==",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?u=63e5c438c242094837a9deeda775d77988b508bf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-14T02:12:06Z",
    "updated_at": "2020-08-14T02:12:06Z",
    "author_association": "CONTRIBUTOR",
    "body": "ACK ec4ee3fd7e9d0a8572c5e29404820bf5899b203a",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/673844477/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683158811",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-683158811",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
    "id": 683158811,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4MzE1ODgxMQ==",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-28T21:40:53Z",
    "updated_at": "2020-08-28T21:40:53Z",
    "author_association": "MEMBER",
    "body": "Anything left here?  From #19500 it seems this fixes the user's issue.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/683158811/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/684525794",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-684525794",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
    "id": 684525794,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4NDUyNTc5NA==",
    "user": {
      "login": "naumenkogs",
      "id": 7975071,
      "node_id": "MDQ6VXNlcjc5NzUwNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7975071?u=06eb9ae4f9b3f954056098860decccbf1340e40f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naumenkogs",
      "html_url": "https://github.com/naumenkogs",
      "followers_url": "https://api.github.com/users/naumenkogs/followers",
      "following_url": "https://api.github.com/users/naumenkogs/following{/other_user}",
      "gists_url": "https://api.github.com/users/naumenkogs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
      "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
      "repos_url": "https://api.github.com/users/naumenkogs/repos",
      "events_url": "https://api.github.com/users/naumenkogs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-01T07:50:57Z",
    "updated_at": "2020-09-01T07:50:57Z",
    "author_association": "MEMBER",
    "body": "ACK ec4ee3f",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/684525794/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685071090",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-685071090",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
    "id": 685071090,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4NTA3MTA5MA==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-01T19:01:03Z",
    "updated_at": "2020-09-02T18:35:19Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/685071090/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/686541063",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#issuecomment-686541063",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19670",
    "id": 686541063,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4NjU0MTA2Mw==",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?u=13b19d1ff2f5f914e180c41418f451a4ba6f8bd1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-03T14:43:29Z",
    "updated_at": "2020-09-03T14:43:29Z",
    "author_association": "MEMBER",
    "body": "I think this strategy makes sense.\r\nCode review ACK 752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/686541063/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/465993080",
    "pull_request_review_id": 462010253,
    "id": 465993080,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk5MzA4MA==",
    "diff_hunk": "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);\n+    size_t erase_size = std::min(size_t(8), vEvictionCandidates.size());\n+    std::remove_if(vEvictionCandidates.end() - erase_size, vEvictionCandidates.end(), [](NodeEvictionCandidate const &n) { return !n.fRelayTxes && n.nLastBlockTime > 0; });",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 52,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "ce35ffee1a937696ff65a38bfa9fd67032505ec8",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "@gmaxwell I should get rid of this `n.nLastBlockTime > 0` right?  So that we'll always protect up to 8 non-tx-relay peers, even if they haven't managed to be first to send us a block.  But perhaps I should only protect them if `fRelevantServices` is true, so that non-full nodes do not get protected here?",
    "created_at": "2020-08-05T20:45:11Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r465993080",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/465993080"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r465993080"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/465993080/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 924,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466007029",
    "pull_request_review_id": 462027702,
    "id": 466007029,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjAwNzAyOQ==",
    "diff_hunk": "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);\n+    size_t erase_size = std::min(size_t(8), vEvictionCandidates.size());\n+    std::remove_if(vEvictionCandidates.end() - erase_size, vEvictionCandidates.end(), [](NodeEvictionCandidate const &n) { return !n.fRelayTxes && n.nLastBlockTime > 0; });",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 52,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "ce35ffee1a937696ff65a38bfa9fd67032505ec8",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think requring fRelevantServices makes sense.  I think it's not import to require that they sent a block-- helping them stay connected so long as they (claim they) could might help keep them around long enough to successfully do so.",
    "created_at": "2020-08-05T21:12:38Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466007029",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466007029"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466007029"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466007029/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 924,
    "side": "RIGHT",
    "in_reply_to_id": 465993080
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466085368",
    "pull_request_review_id": 462118990,
    "id": 466085368,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA4NTM2OA==",
    "diff_hunk": "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);\n+    size_t erase_size = std::min(size_t(8), vEvictionCandidates.size());\n+    std::remove_if(vEvictionCandidates.end() - erase_size, vEvictionCandidates.end(), [](NodeEvictionCandidate const &n) { return !n.fRelayTxes && n.nLastBlockTime > 0; });",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 52,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "ce35ffee1a937696ff65a38bfa9fd67032505ec8",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Fixed, thanks.",
    "created_at": "2020-08-06T01:01:38Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466085368",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466085368"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466085368"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466085368/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 924,
    "side": "RIGHT",
    "in_reply_to_id": 465993080
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466313982",
    "pull_request_review_id": 462391972,
    "id": 466313982,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMxMzk4Mg==",
    "diff_hunk": "@@ -845,6 +852,14 @@ static bool CompareNodeTXTime(const NodeEvictionCandidate &a, const NodeEviction\n     return a.nTimeConnected > b.nTimeConnected;\n }\n \n+// Pick out the potential block-relay only peers, and sort them by last block time.\n+static bool CompareNodeBlockRelayOnlyTime(const NodeEvictionCandidate &a, const NodeEvictionCandidate &b)",
    "path": "src/net.cpp",
    "position": 26,
    "original_position": 26,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "e5af0d1b656c35a7b0be45b46509867265bae691",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "If this PR was built on top of #19316, you could test directly for block-relay-only peers. I think that'd be a cleaner implementation.",
    "created_at": "2020-08-06T10:20:37Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466313982",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466313982"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466313982"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466313982/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 860,
    "original_line": 860,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466352570",
    "pull_request_review_id": 462439662,
    "id": 466352570,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM1MjU3MA==",
    "diff_hunk": "@@ -845,6 +852,14 @@ static bool CompareNodeTXTime(const NodeEvictionCandidate &a, const NodeEviction\n     return a.nTimeConnected > b.nTimeConnected;\n }\n \n+// Pick out the potential block-relay only peers, and sort them by last block time.\n+static bool CompareNodeBlockRelayOnlyTime(const NodeEvictionCandidate &a, const NodeEvictionCandidate &b)",
    "path": "src/net.cpp",
    "position": 26,
    "original_position": 26,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "e5af0d1b656c35a7b0be45b46509867265bae691",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "We don\u2019t currently have a way in our codebase to know that an inbound peer is blocks-only; that is a concept we can only know for outbound peers. We can infer it for inbound peers, as this PR does, but the right way to do this in the future would be to negotiate it at startup, so both sides know that a connection will stay blocks only.\r\n\r\nI believe that PR is only cleaning things up for outbound blocks-only peers?",
    "created_at": "2020-08-06T11:41:25Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466352570",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466352570"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466352570"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466352570/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 860,
    "original_line": 860,
    "side": "RIGHT",
    "in_reply_to_id": 466313982
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466364701",
    "pull_request_review_id": 462455197,
    "id": 466364701,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM2NDcwMQ==",
    "diff_hunk": "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);",
    "path": "src/net.cpp",
    "position": 50,
    "original_position": 50,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "e5af0d1b656c35a7b0be45b46509867265bae691",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`nLastBlockTime` is updated at `ProcessNewBlock` return if the process block is new to us and connecting on our best chain, among other yardsticks. An attacker-controlled inbound connection by always being the fastest to announce block to us can trump other honest block-relay-only inbound to prevent update of their `nLastBlockTime`. I think assuming a malicious peer can be always the fastest is reasonable, just connect to Fibre and bypass some validation checks. By rotating fastest block announcement among few of its inbound connections, a malicious attacker seems to win over this protection. \r\n\r\nHave you consider instead selecting randomly among all our block-relay-only peers 8 of them ? I think that would make this protection better as an attacker can't predict its block-relay-only inbound will be favored. Because if an attacker can forge the fast-block-announcement characteristic as protected by the following protection (\"Protect 4 nodes that most recently sent us blocks\"), it's not hard to also forge this new one as signaling as block-relay-only is cheap.\r\n\r\nCorrect me I I'm wrong about `ProcessNewBlock` and `nLastBlockTime` updates, this part is fairly complex with all the anti-DoS/trickery measures. ",
    "created_at": "2020-08-06T12:06:53Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466364701",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466364701"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466364701"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466364701/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 926,
    "original_line": 926,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466388318",
    "pull_request_review_id": 462486635,
    "id": 466388318,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM4ODMxOA==",
    "diff_hunk": "@@ -845,6 +852,14 @@ static bool CompareNodeTXTime(const NodeEvictionCandidate &a, const NodeEviction\n     return a.nTimeConnected > b.nTimeConnected;\n }\n \n+// Pick out the potential block-relay only peers, and sort them by last block time.\n+static bool CompareNodeBlockRelayOnlyTime(const NodeEvictionCandidate &a, const NodeEvictionCandidate &b)",
    "path": "src/net.cpp",
    "position": 26,
    "original_position": 26,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "e5af0d1b656c35a7b0be45b46509867265bae691",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes, you're right. 19316 only changes things for outbound peers.",
    "created_at": "2020-08-06T12:51:03Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466388318",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466388318"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466388318"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466388318/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 860,
    "original_line": 860,
    "side": "RIGHT",
    "in_reply_to_id": 466313982
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466426527",
    "pull_request_review_id": 462537397,
    "id": 466426527,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQyNjUyNw==",
    "diff_hunk": "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);",
    "path": "src/net.cpp",
    "position": 50,
    "original_position": 50,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "e5af0d1b656c35a7b0be45b46509867265bae691",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "You're right about the code and behavior -- an adversary that is trying to be well-behaved by being the first to deliver blocks to us, from 8 different block-relay peers, can indeed take over this protection -- but randomly choosing among block-relay-only peers is not helpful protection.  If we choose randomly each time, an attacker can game that by merely spamming us with inbound connections until any given peer that had protection in a prior round has lots its protection in this round, and might get evicted.\r\n\r\nNote also that it is free to pretend to be a blocks-only full-node peer; you merely send the right version message to us on connection.  It is more work, and useful work, to be the first peer to deliver us a new block.  So randomly protecting inbound peers who turn off tx-relay is not a useful thing to do, even if your random selection were on a longer timer to try to avoid the spamming problem I described above.\r\n\r\nOne way to think about the protections here is: if we can pick out a set of peers that may be useful to us, protect them.  Because the alternative to protection is that we may lose peers that are demonstrably useful just because an attacker is spamming us.  If we make a mistake and include peers that happen to also be adversaries because they're acting like good peers, that's no worse than if we didn't add the protection at all; but if we can meaningfully increase the cost to an adversary of bypassing the protection, then we've accomplished something.\r\n\r\nSo maybe a poor criteria would be one where an attacker does useful work for us once and then can misbehave but still take over most or all of our protected spots.  I don't think that's what is happening here (arguably, earliest connection time has the risk of an attacker being able to take it over, eventually -- but the first sort is on most-recently-gave-us-a-block, so an attacker would have to be able to keep doing this to ensure that other peers don't gain an advantage).",
    "created_at": "2020-08-06T13:50:05Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466426527",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466426527"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466426527"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466426527/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 926,
    "original_line": 926,
    "side": "RIGHT",
    "in_reply_to_id": 466364701
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466431403",
    "pull_request_review_id": 462543853,
    "id": 466431403,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjQzMTQwMw==",
    "diff_hunk": "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);",
    "path": "src/net.cpp",
    "position": 50,
    "original_position": 50,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "e5af0d1b656c35a7b0be45b46509867265bae691",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> So maybe a poor criteria would be one where an attacker does useful work for us once and then can misbehave but still take over most or all of our protected spots. I don't think that's what is happening here (arguably, earliest connection time has the risk of an attacker being able to take it over, eventually -- but the first sort is on most-recently-gave-us-a-block, so an attacker would have to be able to keep doing this to ensure that other peers don't gain an advantage).\r\n\r\nI do worry that this might be the case, however, because block-relay-only peers may not be the first to deliver us blocks very often (it's possible that due to compact block relay, there are biases in favor of compact block reconstruction happening best on links that are also relaying transactions -- I am not sure).  In which case, the attack you describe of an adversary connecting 8 times, delivering the next 8 blocks from each one, and then being silent, may well work for a while to cause only their links to be protected, because the honest peers have a tough time beating other peers.\r\n\r\nWe can try to get some anecdotal data on this by looking at our own existing nodes to see if apparent block-relay peers are being selected as HB compact block peers?  @gmaxwell any thoughts here?\r\n\r\nEDIT: I guess my overall thought is that even if this is somewhat gameable, adding this won't hurt and may help. If anyone comes up with something better we can always improve it.",
    "created_at": "2020-08-06T13:56:49Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466431403",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466431403"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466431403"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466431403/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 926,
    "original_line": 926,
    "side": "RIGHT",
    "in_reply_to_id": 466364701
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466511844",
    "pull_request_review_id": 462649966,
    "id": 466511844,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUxMTg0NA==",
    "diff_hunk": "@@ -887,7 +902,7 @@ bool CConnman::AttemptToEvictConnection()\n                                                node->nLastBlockTime, node->nLastTXTime,\n                                                HasAllDesirableServiceFlags(node->nServices),\n                                                peer_relay_txes, peer_filter_not_null, node->addr, node->nKeyedNetGroup,\n-                                               node->m_prefer_evict};\n+                                               node->m_prefer_evict, node->addr.IsLocal()};",
    "path": "src/net.cpp",
    "position": 41,
    "original_position": 41,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "ec4ee3fd7e9d0a8572c5e29404820bf5899b203a",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I discovered that doing `IsLocal(node->addr)` is different from `node->addr.IsLocal()`, and the latter appears to be correct, but if someone can confirm that this captures the right idea I'd appreciate it. ",
    "created_at": "2020-08-06T15:50:31Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466511844",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466511844"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466511844"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466511844/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 909,
    "original_line": 909,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466551170",
    "pull_request_review_id": 462700100,
    "id": 466551170,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU1MTE3MA==",
    "diff_hunk": "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);",
    "path": "src/net.cpp",
    "position": 50,
    "original_position": 50,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "e5af0d1b656c35a7b0be45b46509867265bae691",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes, after writing this, I realized thinking further that my counter-proposal wasn't worthy it. As you hinted, analyzing eviction as a serie of interdependent events means sooner or latter, an attacker still has a high-chance of success.\r\n\r\n>  If we make a mistake and include peers that happen to also be adversaries because they're acting like good peers, that's no worse than if we didn't add the protection at all; but if we can meaningfully increase the cost to an adversary of bypassing the protection, then we've accomplished something.\r\n\r\nThanks for the explanation. I agree that the current protection of fast-delivery-block peers is worth it and compel an attacker to position its nodes well with regard to block-topology and propagation, even if potentially gameable. Where I was more doubtful was on the value of adding a second protection relying on an-already used assumption. Even I was presuming that an attacker, by forgetting validation because it's a zero-cost accepting invalid blocks, will always trump block announcement, independently of being in concurrence with compact block peers.\r\n\r\nI think there is the interesting property with block-relay-only peers that it's far far harder to guess their pairing, as you remember back in commit. Whereas our protected-by-netgroup peers (1st heuristic) might be full-relay ones, and thus an attacker might be able to guess their IP prefix by tx-relay topology probing. \r\n\r\nBlock-relay-only peers don't have this weakness so it could be more worthy to combine them with the netgroup critera rather than with the fast-block-delivery one ?\r\n\r\nOverall, if we can't come up with better ideas, you right let's move further and try to address this kind of issues in future works on network anomalies detection/anti-eclipse.",
    "created_at": "2020-08-06T16:54:47Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466551170",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466551170"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466551170"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466551170/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 926,
    "original_line": 926,
    "side": "RIGHT",
    "in_reply_to_id": 466364701
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466673825",
    "pull_request_review_id": 462860946,
    "id": 466673825,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY3MzgyNQ==",
    "diff_hunk": "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);",
    "path": "src/net.cpp",
    "position": 50,
    "original_position": 50,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "e5af0d1b656c35a7b0be45b46509867265bae691",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "@ariaid There are, unfortunately, a lot of \"nodes\" that just connect and don't do anything useful.   Reserving slots for zombies that don't even once do something useful isn't very helpful.  Unfortunately the software doesn't really have that much criteria for deciding usefulness and most things you could imagine could be easily faked.  One advantage of favouring many peers that have recently sent blocks is that even if the leader is someone who's only making themselves first for a little while before misbehaving there are still many other slots.  (Also, aside, the public fibre network is gone and the software is now unmaintained)\r\n\r\nKeep in mind that blocks-only peers are currently disadvantaged because they're ineligible for the CompareNodeTXTime criteria-- yet they are important: because they're difficult for an attacker to map they are intended form an important part of the network's protection against an attacker carving partitions into the network via DOS attacks. It would be extremely unfortunate to have that protection get undermined by a simple connection flooding attack that gets most of the blocks-only peers evicted.\r\n\r\nYou can see the recent blocks protection for blocks-only peers being morally similar to reserving part of the longest uptime slots for localhost/onion connections. In this case actually 'reserving' doesn't make sense because the number protected for that reason is relatively few.  Basically there are now two reasons for a group to exist:  Spreading connections across orthogonal kinds of being good under the theory that its harder for an attacker to be good in many ways,  and spreading connections across different kinds of (useful) peers.\r\n\r\nOne could even imagine a generalization where you have a collection of different kinds of peers {ipv4, ipv6, onion, local-network, blocks-only, accepts-inbound-according-to-the-feeler-test} and different kinds of goodness {latency, block relay, tx relay, netgroups, uptime}  and then you form a cross-product of the two sets and keep the best in each bucket--- but currently there just aren't that many slots to fight over.\r\n\r\nIf it were changed to netgroup based, I'd still recommend nLastBlockTime!=0 and fRelevantServices as sorting criteria ahead of a random netgroup preference.\r\n\r\nAt one point I wanted to add a generic \"helpful\" flag that was based on some a set of criteria that judged if the peer was probably capable of serving us a novel block-- do they have the right services? if not-- not helpful. have they recently given us a block? helpful.  have they recently given us a new transaction we accepted? helpful.  Have they been recently announcing blocks we eventually accepted? helpful. Otherwise not helpful. ... stuff like that-- so essentially all working peers should be flagged as helpful.\r\n\r\nAnd then have all the eviction criteria (except perhaps the longest uptime) use the helpful flag as the first sorting key, so that reserved slots won't be taken by stuff that is very obviously broken.  Attackers can feign helpfulness-- sure, but some won't bother.  And weirdly broken nodes (some of which are just incompetent attackers) are common and don't feign anything.\r\n\r\nI just found it to be too difficult to meet people's expectations for testing for this kind of behaviour.\r\n",
    "created_at": "2020-08-06T20:40:49Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466673825",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466673825"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466673825"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466673825/reactions",
      "total_count": 3,
      "+1": 3,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 926,
    "original_line": 926,
    "side": "RIGHT",
    "in_reply_to_id": 466364701
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466684163",
    "pull_request_review_id": 462874066,
    "id": 466684163,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4NDE2Mw==",
    "diff_hunk": "@@ -887,7 +902,7 @@ bool CConnman::AttemptToEvictConnection()\n                                                node->nLastBlockTime, node->nLastTXTime,\n                                                HasAllDesirableServiceFlags(node->nServices),\n                                                peer_relay_txes, peer_filter_not_null, node->addr, node->nKeyedNetGroup,\n-                                               node->m_prefer_evict};\n+                                               node->m_prefer_evict, node->addr.IsLocal()};",
    "path": "src/net.cpp",
    "position": 41,
    "original_position": 41,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "ec4ee3fd7e9d0a8572c5e29404820bf5899b203a",
    "user": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Somewhat confusingly:\r\n\r\n- `node->addr.IsLocal()` returns true only if `node->addr` is IPv[46] and is in the loopback address ranges\r\n- `IsLocal(node->addr)` checks whether or not `node->addr` resides in `mapLocalHost`, which tracks our view of addresses we might be referred to externally\r\n\r\nSo in this case, I believe your use of `node->addr.IsLocal()` is correct.",
    "created_at": "2020-08-06T21:01:41Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466684163",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466684163"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466684163"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466684163/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 909,
    "original_line": 909,
    "side": "RIGHT",
    "in_reply_to_id": 466511844
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466687565",
    "pull_request_review_id": 462878446,
    "id": 466687565,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjY4NzU2NQ==",
    "diff_hunk": "@@ -887,7 +902,7 @@ bool CConnman::AttemptToEvictConnection()\n                                                node->nLastBlockTime, node->nLastTXTime,\n                                                HasAllDesirableServiceFlags(node->nServices),\n                                                peer_relay_txes, peer_filter_not_null, node->addr, node->nKeyedNetGroup,\n-                                               node->m_prefer_evict};\n+                                               node->m_prefer_evict, node->addr.IsLocal()};",
    "path": "src/net.cpp",
    "position": 41,
    "original_position": 41,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "ec4ee3fd7e9d0a8572c5e29404820bf5899b203a",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes. addr.IsLocal() is right. IsLocal() ought to be renamed to  IsProbablyMyAddress. :)",
    "created_at": "2020-08-06T21:08:57Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466687565",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466687565"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r466687565"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/466687565/reactions",
      "total_count": 4,
      "+1": 0,
      "-1": 0,
      "laugh": 4,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 909,
    "original_line": 909,
    "side": "RIGHT",
    "in_reply_to_id": 466511844
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/467329274",
    "pull_request_review_id": 463690406,
    "id": 467329274,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMyOTI3NA==",
    "diff_hunk": "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);",
    "path": "src/net.cpp",
    "position": 50,
    "original_position": 50,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "e5af0d1b656c35a7b0be45b46509867265bae691",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "@gmaxwell thanks for your explanation, I would push your model a bit further, beyond types of peers/goodness, you can classify goodness criterias between themselves, with regards to hardness assumptions on attackers. Some are good-behavioral monitoring (block-delivery, stable connections, ...), other costly-topological-identifier (asmap, net-address), other non-observable ones (netgroup sort, you could imagine peer nonce sort). \r\n\r\nIt needs further research but I fear good-behavioral ones are on the low scale of hardness, because once you have an attacker infrastructure deployed it sounds a marginal cost to fake good-behavioral ones (e.g learn the block first, give it to all your node puppets). These types of goodness are the ones we use the most, I don't deny their usefulness but I lean to think about them more like sanitization measures than inbound slot overtakes protections. By pruning out zombies nodes like you underscore, they optimize your resources, in the sense for a given bucket, increase potential utility.\r\n\r\nWith regards to switching to a pro-active logic, like the \"helpful\" described, it defavor low-grade full-nodes even when they are protocol compliant. I presume that's already an effect of our eviction heuristics but I would be cautious going further and such breaking some network-wise diversity of peers. Obviously pushing for more efficiency-based pairing isn't great for robustness.\r\n\r\nStricter slot allocation, especially based on netgroup might have the side-effect to facilitate some net-splits, like if you allocate X slots based on netgroup ABC, an attacker, once deployed in this netgroup can exhaust the quota towards every listening peers. I guess peers netaddresses aren't evenly distributed across netgroup so you might be able to drop a fair chunk of the network.\r\n\r\nNote,  we do addr-relay for blocks-only peers, not for block-relay-only. So it might be easier for an attacker to map them than expected. I don't think we want to severe addr-relay for blocks-only as otherwise it would be harder (impossible?) for them to learn about new addresses. \r\n",
    "created_at": "2020-08-07T23:43:27Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r467329274",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/467329274"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r467329274"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/467329274/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 926,
    "original_line": 926,
    "side": "RIGHT",
    "in_reply_to_id": 466364701
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/470371927",
    "pull_request_review_id": 467264783,
    "id": 470371927,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3MTkyNw==",
    "diff_hunk": "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);",
    "path": "src/net.cpp",
    "position": 50,
    "original_position": 50,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "e5af0d1b656c35a7b0be45b46509867265bae691",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> other non-observable ones (netgroup sort, you could imagine peer nonce sort).\r\n\r\nNot sure if it was clear, but the motivation for netgroup diverse peers was also along the lines of trying to restore topology diversity.\r\n\r\nMany criteria-- latency, block relay, and tx relay all somewhat favor peers that are geographically close.  So you don't want a situation where most nodes are just incestuously linked within the same geography, resulting in a small min-cut to other continents. It's easy to imaging the network becoming that way over time when you factor in the fact that further links crossing more networks are a little less reliable than shorter ones.\r\n\r\n > I fear good-behavioral ones are on the low scale of hardness, because once you have an attacker infrastructure deployed it sounds a marginal cost to fake good-behavioral ones\r\n\r\nSure, though if they stop being good, they'll quickly lose the advantage it gave them. ... assuming they haven't already successfully eclipsed you entirely. If they keep being good then hurrah, you won.\r\n\r\n> , once deployed in this netgroup can exhaust the quota towards every listening peers\r\n\r\nYes, though the preference isn't directly observable. \r\n\r\n>  presume that's already an effect of our eviction heuristics but I would be cautious going further and such breaking some network-wise diversity of peers\r\n\r\nI really disagree. It's a reason to be not overly specific in what constitutes helpful, but there are a pretty obvious set of behaviours (like relaying us blocks) which if a peer doesn't do, it isn't helping us stay non-partitioned from the honest network.  A peer is free to not to helpful stuff, they wouldn't be disconnected directly for it--  but for criteria that is expressly intended to protect the nodes' connectivity, it can make sense to filter it.\r\n\r\nI don't even think it would be completely absurd to reserve some connection capacity for peers which claim to be exactly the same protocol & subversion as you. Sure, a malicious party could spoof it, always matching it--  but there have been several incidents in the past where we were concerned about fork software accidentally engaging in a partitioning attack:  Say Mallory release a fork of the software that on some date will change its consensus rules to require every block sends half its coinbase to her, Mallory isn't malicious, just stupid.  She suckers a fair number of people into running this fork. When the time comes, your node is, by chance, totally surrounded by BitcoinMallory nodes.  No one mines any Mallory blocks (or, if they do-- the Mallory node graph may be partitioned and not get them to any of your neighbours) and the Mallory peers block the 'invalid' valid blocks from reaching you. Without any blocks showing up you can't tell the Mallory nodes consensus rules differ.   The stale tip detection is a last ditch hail marry to recover from this state, but it may not work well when you need it (e.g. due to honest nodes being full or attacked, or just taking a long time to find one that's up and not a Mallory node).  Wouldn't it have been better if a couple of your connections were running the same software as you-- so that if any of them were connected to the graph of healthy nodes you would be too?\r\n\r\nIt's critical to keep in mind that *broken* software radically outnumbers attackers at almost all times. Esp because if countermeasures against attackers are generally effective then there won't be attackers.  Also, if merely being a \"broken\" peer is enough to harm the network \r\n\r\n> Note, we do addr-relay for blocks-only peers,\r\n\r\nIt's a choice of the peer if they want to announce themselves through us.  You make a great point that a peer might be wise to suppress its announcements toward and from its outbound block-only connections because those connections exist in part to help obscure the node connectivity graph.  I thought they already did this.\r\n",
    "created_at": "2020-08-14T02:11:22Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r470371927",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/470371927"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r470371927"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/470371927/reactions",
      "total_count": 3,
      "+1": 3,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 926,
    "original_line": 926,
    "side": "RIGHT",
    "in_reply_to_id": 466364701
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473202940",
    "pull_request_review_id": 470687668,
    "id": 473202940,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIwMjk0MA==",
    "diff_hunk": "@@ -845,6 +852,14 @@ static bool CompareNodeTXTime(const NodeEvictionCandidate &a, const NodeEviction\n     return a.nTimeConnected > b.nTimeConnected;\n }\n \n+// Pick out the potential block-relay only peers, and sort them by last block time.",
    "path": "src/net.cpp",
    "position": 25,
    "original_position": 25,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "ec4ee3fd7e9d0a8572c5e29404820bf5899b203a",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "If you have to modify,  you might change to non-tx-relay peers/`CompareNonTxRelayPeers` as comment above the sort is referring to.",
    "created_at": "2020-08-19T17:26:46Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r473202940",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473202940"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r473202940"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473202940/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 859,
    "original_line": 859,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473220014",
    "pull_request_review_id": 470687668,
    "id": 473220014,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzIyMDAxNA==",
    "diff_hunk": "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);\n+    size_t erase_size = std::min(size_t(8), vEvictionCandidates.size());\n+    vEvictionCandidates.erase(std::remove_if(vEvictionCandidates.end() - erase_size, vEvictionCandidates.end(), [](NodeEvictionCandidate const &n) { return !n.fRelayTxes && n.fRelevantServices; }), vEvictionCandidates.end());\n+\n     // Protect 4 nodes that most recently sent us blocks.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeBlockTime, 4);\n+\n     // Protect the half of the remaining nodes which have been connected the longest.\n     // This replicates the non-eviction implicit behavior, and precludes attacks that start later.\n-    EraseLastKElements(vEvictionCandidates, ReverseCompareNodeTimeConnected, vEvictionCandidates.size() / 2);\n+    // Reserve half of these protected spots for localhost peers, even if\n+    // they're not longest-uptime overall. This helps protect tor peers, which\n+    // tend to be otherwise disadvantaged under our eviction criteria.\n+    size_t initial_size = vEvictionCandidates.size();\n+    size_t total_protect_size = initial_size / 2;\n+\n+    // Pick out up to 1/4 peers that are localhost, sorted by longest uptime.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareLocalHostTimeConnected);\n+    size_t local_erase_size = total_protect_size / 2;\n+    vEvictionCandidates.erase(std::remove_if(vEvictionCandidates.end() - local_erase_size, vEvictionCandidates.end(), [](NodeEvictionCandidate const &n) { return n.m_is_local; }), vEvictionCandidates.end());\n+    // Calculate how many we removed, and update our total number of peers that\n+    // we want to protect based on uptime accordingly.\n+    total_protect_size -= initial_size - vEvictionCandidates.size();",
    "path": "src/net.cpp",
    "position": 73,
    "original_position": 73,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "ec4ee3fd7e9d0a8572c5e29404820bf5899b203a",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "You can write it as `size_t total_protect_size = initial_size / 2 - (initial_size - vEvictionCandidates.size())` and thus save one line above. I found this equation expressing better that up to 1/2 remaining peers are protected in function of effectively protected localhost.",
    "created_at": "2020-08-19T17:56:40Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r473220014",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473220014"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r473220014"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/473220014/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 948,
    "original_line": 948,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479546414",
    "pull_request_review_id": 478040081,
    "id": 479546414,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTU0NjQxNA==",
    "diff_hunk": "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);\n+    size_t erase_size = std::min(size_t(8), vEvictionCandidates.size());\n+    vEvictionCandidates.erase(std::remove_if(vEvictionCandidates.end() - erase_size, vEvictionCandidates.end(), [](NodeEvictionCandidate const &n) { return !n.fRelayTxes && n.fRelevantServices; }), vEvictionCandidates.end());\n+\n     // Protect 4 nodes that most recently sent us blocks.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeBlockTime, 4);\n+\n     // Protect the half of the remaining nodes which have been connected the longest.\n     // This replicates the non-eviction implicit behavior, and precludes attacks that start later.\n-    EraseLastKElements(vEvictionCandidates, ReverseCompareNodeTimeConnected, vEvictionCandidates.size() / 2);\n+    // Reserve half of these protected spots for localhost peers, even if\n+    // they're not longest-uptime overall. This helps protect tor peers, which\n+    // tend to be otherwise disadvantaged under our eviction criteria.\n+    size_t initial_size = vEvictionCandidates.size();\n+    size_t total_protect_size = initial_size / 2;\n+\n+    // Pick out up to 1/4 peers that are localhost, sorted by longest uptime.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareLocalHostTimeConnected);\n+    size_t local_erase_size = total_protect_size / 2;\n+    vEvictionCandidates.erase(std::remove_if(vEvictionCandidates.end() - local_erase_size, vEvictionCandidates.end(), [](NodeEvictionCandidate const &n) { return n.m_is_local; }), vEvictionCandidates.end());\n+    // Calculate how many we removed, and update our total number of peers that\n+    // we want to protect based on uptime accordingly.\n+    total_protect_size -= initial_size - vEvictionCandidates.size();",
    "path": "src/net.cpp",
    "position": 73,
    "original_position": 73,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "ec4ee3fd7e9d0a8572c5e29404820bf5899b203a",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think the way I wrote it makes sense, so not inclined to change this (seems like mostly style and not actually any more or less confusing?).",
    "created_at": "2020-08-28T21:40:24Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r479546414",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479546414"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r479546414"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/479546414/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 948,
    "original_line": 948,
    "side": "RIGHT",
    "in_reply_to_id": 473220014
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/480935119",
    "pull_request_review_id": 479482567,
    "id": 480935119,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDkzNTExOQ==",
    "diff_hunk": "@@ -903,12 +918,31 @@ bool CConnman::AttemptToEvictConnection()\n     // Protect 4 nodes that most recently sent us transactions.\n     // An attacker cannot manipulate this metric without performing useful work.\n     EraseLastKElements(vEvictionCandidates, CompareNodeTXTime, 4);\n+    // Protect up to 8 non-tx-relay peers that have sent us blocks.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareNodeBlockRelayOnlyTime);",
    "path": "src/net.cpp",
    "position": 50,
    "original_position": 50,
    "commit_id": "752e6ad5336d5af0db9fe16d24c0c6aa25b74a3f",
    "original_commit_id": "e5af0d1b656c35a7b0be45b46509867265bae691",
    "user": {
      "login": "naumenkogs",
      "id": 7975071,
      "node_id": "MDQ6VXNlcjc5NzUwNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naumenkogs",
      "html_url": "https://github.com/naumenkogs",
      "followers_url": "https://api.github.com/users/naumenkogs/followers",
      "following_url": "https://api.github.com/users/naumenkogs/following{/other_user}",
      "gists_url": "https://api.github.com/users/naumenkogs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
      "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
      "repos_url": "https://api.github.com/users/naumenkogs/repos",
      "events_url": "https://api.github.com/users/naumenkogs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Considering how easy it is to be the first to announce a block and then launch a rotation right after, I'm not very positive abound this solution.\r\n\r\nI acknowledge that finding these criteria is hard though. \r\nI would suggest \"take all no-tx nodes announced a block within a day, and save the most long-living connections among them\".\r\n\r\nIt would still protect from completely fake nodes (no blocks at all), and impose a stronger attack cost I'd say (in terms of connection lifetime). Another benefit is slower-but-persistent honest blocks-only peers won't be evicted.\r\n\r\nNot a strong opinion, I'm not a big fan of long-lifetime bias either, it just feels a bit stronger for now.\r\nFor now gonna ACK the existing code.",
    "created_at": "2020-09-01T07:48:10Z",
    "updated_at": "2020-09-02T13:22:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r480935119",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/480935119"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19670#discussion_r480935119"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19670"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/480935119/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 926,
    "original_line": 926,
    "side": "RIGHT",
    "in_reply_to_id": 466364701
  }
]