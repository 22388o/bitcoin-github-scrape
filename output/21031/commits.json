[
  {
    "sha": "7f37fbc3b60646a21a3228022abad19e4689abd7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3ZjM3ZmJjM2I2MDY0NmEyMWEzMjI4MDIyYWJhZDE5ZTQ2ODlhYmQ3",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2021-01-29T06:44:06Z"
      },
      "committer": {
        "name": "Reggie Noble",
        "email": "77251516+RonSherfey@users.noreply.github.com",
        "date": "2021-01-29T08:28:14Z"
      },
      "message": "Merge #20724: Cleanup of -debug=net log messages\n\n48c8a9b96453ca429b38fc5d5181a310ae5a93bf net_processing: log txrelay flag from version message (Anthony Towns)\n98fab37ca0517bfe58296e47266cd5bd112e90bf net: use peer=N instead of from=N in debug log (Anthony Towns)\n12302105bb0bf14721e91b7a3a9d1bf83c8d4154 net_processing: additional debug logging for ignored messages (Anthony Towns)\nf7edea3b7c873d6c9bcd50cf528349ef84961a75 net: make debug logging conditional on -debug=net (Anthony Towns)\na410ae8cb09f1b809755316566f9e6bccd41c0c4 net, net_processing: log disconnect reasons with -debug=net (Anthony Towns)\n\nPull request description:\n\n  A few changes to -debug=net logging:\n\n   * always log when disconnecting a peer\n   * only log various connection errors when -debug=net is enabled, since errors from random untrusted peers is completely expected\n   * log when ignoring a message due to violating protocol (primarily to make it easier to debug other implementations)\n   * use \"peer=123\" rather than \"from 123\" to make grepping logs a bit easier\n   * log the value of the bip-37 `fRelay` field in version messages both when sending and receiving a version message\n\nACKs for top commit:\n  jnewbery:\n    ACK 48c8a9b96453ca429b38fc5d5181a310ae5a93bf\n  MarcoFalke:\n    re-ACK 48c8a9b96453ca429b38fc5d5181a310ae5a93bf only change is rebase \ud83d\ude93\n  practicalswift:\n    re-ACK 48c8a9b96453ca429b38fc5d5181a310ae5a93bf\n\nTree-SHA512: 6ac530d883dffc4fd7fe20b1dc5ebb5394374c9b499aa7a253eb4a3a660d8901edd72e5ad21ce4a2bf71df25e8f142087755f9756f3497f564ef453a7e9246c1",
      "tree": {
        "sha": "af6aabe71bf8863a7ee7638d0cb0ad9ab19a618b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/af6aabe71bf8863a7ee7638d0cb0ad9ab19a618b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7f37fbc3b60646a21a3228022abad19e4689abd7",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7f37fbc3b60646a21a3228022abad19e4689abd7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/7f37fbc3b60646a21a3228022abad19e4689abd7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7f37fbc3b60646a21a3228022abad19e4689abd7/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "RonSherfey",
      "id": 77251516,
      "node_id": "MDQ6VXNlcjc3MjUxNTE2",
      "avatar_url": "https://avatars.githubusercontent.com/u/77251516?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/RonSherfey",
      "html_url": "https://github.com/RonSherfey",
      "followers_url": "https://api.github.com/users/RonSherfey/followers",
      "following_url": "https://api.github.com/users/RonSherfey/following{/other_user}",
      "gists_url": "https://api.github.com/users/RonSherfey/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/RonSherfey/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/RonSherfey/subscriptions",
      "organizations_url": "https://api.github.com/users/RonSherfey/orgs",
      "repos_url": "https://api.github.com/users/RonSherfey/repos",
      "events_url": "https://api.github.com/users/RonSherfey/events{/privacy}",
      "received_events_url": "https://api.github.com/users/RonSherfey/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "40dd757bf6ce1ae81599af4d204e210583b7c7bc",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/40dd757bf6ce1ae81599af4d204e210583b7c7bc",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/40dd757bf6ce1ae81599af4d204e210583b7c7bc"
      },
      {
        "sha": "48c8a9b96453ca429b38fc5d5181a310ae5a93bf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/48c8a9b96453ca429b38fc5d5181a310ae5a93bf",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/48c8a9b96453ca429b38fc5d5181a310ae5a93bf"
      }
    ],
    "stats": {
      "total": 55,
      "additions": 38,
      "deletions": 17
    },
    "files": [
      {
        "sha": "76bf7effa47f9abcef60fb1d11f28afeae9f036b",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 11,
        "deletions": 7,
        "changes": 18,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7f37fbc3b60646a21a3228022abad19e4689abd7/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7f37fbc3b60646a21a3228022abad19e4689abd7/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=7f37fbc3b60646a21a3228022abad19e4689abd7",
        "patch": "@@ -815,7 +815,7 @@ size_t CConnman::SocketSendData(CNode& node) const\n                 // error\n                 int nErr = WSAGetLastError();\n                 if (nErr != WSAEWOULDBLOCK && nErr != WSAEMSGSIZE && nErr != WSAEINTR && nErr != WSAEINPROGRESS) {\n-                    LogPrintf(\"socket send error %s\\n\", NetworkErrorString(nErr));\n+                    LogPrint(BCLog::NET, \"socket send error for peer=%d: %s\\n\", node.GetId(), NetworkErrorString(nErr));\n                     node.CloseSocketDisconnect();\n                 }\n             }\n@@ -1004,6 +1004,7 @@ bool CConnman::AttemptToEvictConnection()\n     LOCK(cs_vNodes);\n     for (CNode* pnode : vNodes) {\n         if (pnode->GetId() == *node_id_to_evict) {\n+            LogPrint(BCLog::NET, \"selected %s connection for eviction peer=%d; disconnecting\\n\", pnode->ConnectionTypeAsString(), pnode->GetId());\n             pnode->fDisconnect = true;\n             return true;\n         }\n@@ -1052,7 +1053,7 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     }\n \n     if (!fNetworkActive) {\n-        LogPrintf(\"connection from %s dropped: not accepting new connections\\n\", addr.ToString());\n+        LogPrint(BCLog::NET, \"connection from %s dropped: not accepting new connections\\n\", addr.ToString());\n         CloseSocket(hSocket);\n         return;\n     }\n@@ -1230,30 +1231,30 @@ bool CConnman::InactivityCheck(const CNode& node) const\n     }\n \n     if (node.nLastRecv == 0 || node.nLastSend == 0) {\n-        LogPrint(BCLog::NET, \"socket no message in first %i seconds, %d %d from %d\\n\", m_peer_connect_timeout, node.nLastRecv != 0, node.nLastSend != 0, node.GetId());\n+        LogPrint(BCLog::NET, \"socket no message in first %i seconds, %d %d peer=%d\\n\", m_peer_connect_timeout, node.nLastRecv != 0, node.nLastSend != 0, node.GetId());\n         return true;\n     }\n \n     if (now > node.nLastSend + TIMEOUT_INTERVAL) {\n-        LogPrintf(\"socket sending timeout: %is\\n\", now - node.nLastSend);\n+        LogPrint(BCLog::NET, \"socket sending timeout: %is peer=%d\\n\", now - node.nLastSend, node.GetId());\n         return true;\n     }\n \n     if (now > node.nLastRecv + TIMEOUT_INTERVAL) {\n-        LogPrintf(\"socket receive timeout: %is\\n\", now - node.nLastRecv);\n+        LogPrint(BCLog::NET, \"socket receive timeout: %is peer=%d\\n\", now - node.nLastRecv, node.GetId());\n         return true;\n     }\n \n     if (node.nPingNonceSent && node.m_ping_start.load() + std::chrono::seconds{TIMEOUT_INTERVAL} < GetTime<std::chrono::microseconds>()) {\n         // We use mockable time for ping timeouts. This means that setmocktime\n         // may cause pings to time out for peers that have been connected for\n         // longer than m_peer_connect_timeout.\n-        LogPrintf(\"ping timeout: %fs\\n\", 0.000001 * count_microseconds(GetTime<std::chrono::microseconds>() - node.m_ping_start.load()));\n+        LogPrint(BCLog::NET, \"ping timeout: %fs peer=%d\\n\", 0.000001 * count_microseconds(GetTime<std::chrono::microseconds>() - node.m_ping_start.load()), node.GetId());\n         return true;\n     }\n \n     if (!node.fSuccessfullyConnected) {\n-        LogPrint(BCLog::NET, \"version handshake timeout from %d\\n\", node.GetId());\n+        LogPrint(BCLog::NET, \"version handshake timeout peer=%d\\n\", node.GetId());\n         return true;\n     }\n \n@@ -2693,6 +2694,7 @@ bool CConnman::DisconnectNode(const std::string& strNode)\n {\n     LOCK(cs_vNodes);\n     if (CNode* pnode = FindNode(strNode)) {\n+        LogPrint(BCLog::NET, \"disconnect by address%s matched peer=%d; disconnecting\\n\", (fLogIPs ? strprintf(\"=%s\", strNode) : \"\"), pnode->GetId());\n         pnode->fDisconnect = true;\n         return true;\n     }\n@@ -2705,6 +2707,7 @@ bool CConnman::DisconnectNode(const CSubNet& subnet)\n     LOCK(cs_vNodes);\n     for (CNode* pnode : vNodes) {\n         if (subnet.Match(pnode->addr)) {\n+            LogPrint(BCLog::NET, \"disconnect by subnet%s matched peer=%d; disconnecting\\n\", (fLogIPs ? strprintf(\"=%s\", subnet.ToString()) : \"\"), pnode->GetId());\n             pnode->fDisconnect = true;\n             disconnected = true;\n         }\n@@ -2722,6 +2725,7 @@ bool CConnman::DisconnectNode(NodeId id)\n     LOCK(cs_vNodes);\n     for(CNode* pnode : vNodes) {\n         if (id == pnode->GetId()) {\n+            LogPrint(BCLog::NET, \"disconnect by id peer=%d; disconnecting\\n\", pnode->GetId());\n             pnode->fDisconnect = true;\n             return true;\n         }"
      },
      {
        "sha": "a4070f5b63377f6524a33f9f28b96069bb4e9801",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 24,
        "deletions": 7,
        "changes": 31,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7f37fbc3b60646a21a3228022abad19e4689abd7/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7f37fbc3b60646a21a3228022abad19e4689abd7/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=7f37fbc3b60646a21a3228022abad19e4689abd7",
        "patch": "@@ -880,13 +880,14 @@ void PeerManagerImpl::PushNodeVersion(CNode& pnode, int64_t nTime)\n                            CAddress(CService(), addr.nServices);\n     CAddress addrMe = CAddress(CService(), nLocalNodeServices);\n \n+    const bool tx_relay = !m_ignore_incoming_txs && pnode.m_tx_relay != nullptr;\n     m_connman.PushMessage(&pnode, CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERSION, PROTOCOL_VERSION, (uint64_t)nLocalNodeServices, nTime, addrYou, addrMe,\n-            nonce, strSubVersion, nNodeStartingHeight, !m_ignore_incoming_txs && pnode.m_tx_relay != nullptr));\n+            nonce, strSubVersion, nNodeStartingHeight, tx_relay));\n \n     if (fLogIPs) {\n-        LogPrint(BCLog::NET, \"send version message: version %d, blocks=%d, us=%s, them=%s, peer=%d\\n\", PROTOCOL_VERSION, nNodeStartingHeight, addrMe.ToString(), addrYou.ToString(), nodeid);\n+        LogPrint(BCLog::NET, \"send version message: version %d, blocks=%d, us=%s, them=%s, txrelay=%d, peer=%d\\n\", PROTOCOL_VERSION, nNodeStartingHeight, addrMe.ToString(), addrYou.ToString(), tx_relay, nodeid);\n     } else {\n-        LogPrint(BCLog::NET, \"send version message: version %d, blocks=%d, us=%s, peer=%d\\n\", PROTOCOL_VERSION, nNodeStartingHeight, addrMe.ToString(), nodeid);\n+        LogPrint(BCLog::NET, \"send version message: version %d, blocks=%d, us=%s, txrelay=%d, peer=%d\\n\", PROTOCOL_VERSION, nNodeStartingHeight, addrMe.ToString(), tx_relay, nodeid);\n     }\n }\n \n@@ -2642,9 +2643,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         if (fLogIPs)\n             remoteAddr = \", peeraddr=\" + pfrom.addr.ToString();\n \n-        LogPrint(BCLog::NET, \"receive version message: %s: version %d, blocks=%d, us=%s, peer=%d%s\\n\",\n+        LogPrint(BCLog::NET, \"receive version message: %s: version %d, blocks=%d, us=%s, txrelay=%d, peer=%d%s\\n\",\n                   cleanSubVer, pfrom.nVersion,\n-                  peer->m_starting_height, addrMe.ToString(), pfrom.GetId(),\n+                  peer->m_starting_height, addrMe.ToString(), fRelay, pfrom.GetId(),\n                   remoteAddr);\n \n         int64_t nTimeOffset = nTime - GetTime();\n@@ -2659,6 +2660,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n         // Feeler connections exist only to verify if address is online.\n         if (pfrom.IsFeelerConn()) {\n+            LogPrint(BCLog::NET, \"feeler connection completed peer=%d; disconnecting\\n\", pfrom.GetId());\n             pfrom.fDisconnect = true;\n         }\n         return;\n@@ -2674,7 +2676,10 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n     const CNetMsgMaker msgMaker(pfrom.GetCommonVersion());\n \n     if (msg_type == NetMsgType::VERACK) {\n-        if (pfrom.fSuccessfullyConnected) return;\n+        if (pfrom.fSuccessfullyConnected) {\n+            LogPrint(BCLog::NET, \"ignoring redundant verack message from peer=%d\\n\", pfrom.GetId());\n+            return;\n+        }\n \n         if (!pfrom.IsInboundConn()) {\n             LogPrintf(\"New outbound peer connected: version: %d, blocks=%d, peer=%d%s (%s)\\n\",\n@@ -2746,6 +2751,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         if (pfrom.fSuccessfullyConnected) {\n             // Disconnect peers that send wtxidrelay message after VERACK; this\n             // must be negotiated between VERSION and VERACK.\n+            LogPrint(BCLog::NET, \"wtxidrelay received after verack from peer=%d; disconnecting\\n\", pfrom.GetId());\n             pfrom.fDisconnect = true;\n             return;\n         }\n@@ -2754,7 +2760,11 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             if (!State(pfrom.GetId())->m_wtxid_relay) {\n                 State(pfrom.GetId())->m_wtxid_relay = true;\n                 g_wtxid_relay_peers++;\n+            } else {\n+                LogPrint(BCLog::NET, \"ignoring duplicate wtxidrelay from peer=%d\\n\", pfrom.GetId());\n             }\n+        } else {\n+            LogPrint(BCLog::NET, \"ignoring wtxidrelay due to old common version=%d from peer=%d\\n\", pfrom.GetCommonVersion(), pfrom.GetId());\n         }\n         return;\n     }\n@@ -2763,6 +2773,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         if (pfrom.fSuccessfullyConnected) {\n             // Disconnect peers that send SENDADDRV2 message after VERACK; this\n             // must be negotiated between VERSION and VERACK.\n+            LogPrint(BCLog::NET, \"sendaddrv2 received after verack from peer=%d; disconnecting\\n\", pfrom.GetId());\n             pfrom.fDisconnect = true;\n             return;\n         }\n@@ -2789,6 +2800,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         s >> vAddr;\n \n         if (!pfrom.RelayAddrsWithConn()) {\n+            LogPrint(BCLog::NET, \"ignoring %s message from %s peer=%d\\n\", msg_type, pfrom.ConnectionTypeAsString(), pfrom.GetId());\n             return;\n         }\n         if (vAddr.size() > MAX_ADDR_TO_SEND)\n@@ -2832,8 +2844,10 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         m_connman.AddNewAddresses(vAddrOk, pfrom.addr, 2 * 60 * 60);\n         if (vAddr.size() < 1000)\n             pfrom.fGetAddr = false;\n-        if (pfrom.IsAddrFetchConn())\n+        if (pfrom.IsAddrFetchConn()) {\n+            LogPrint(BCLog::NET, \"addrfetch connection completed peer=%d; disconnecting\\n\", pfrom.GetId());\n             pfrom.fDisconnect = true;\n+        }\n         return;\n     }\n \n@@ -3840,6 +3854,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n     if (msg_type == NetMsgType::FILTERLOAD) {\n         if (!(pfrom.GetLocalServices() & NODE_BLOOM)) {\n+            LogPrint(BCLog::NET, \"filterload received despite not offering bloom services from peer=%d; disconnecting\\n\", pfrom.GetId());\n             pfrom.fDisconnect = true;\n             return;\n         }\n@@ -3862,6 +3877,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n     if (msg_type == NetMsgType::FILTERADD) {\n         if (!(pfrom.GetLocalServices() & NODE_BLOOM)) {\n+            LogPrint(BCLog::NET, \"filteradd received despite not offering bloom services from peer=%d; disconnecting\\n\", pfrom.GetId());\n             pfrom.fDisconnect = true;\n             return;\n         }\n@@ -3889,6 +3905,7 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n     if (msg_type == NetMsgType::FILTERCLEAR) {\n         if (!(pfrom.GetLocalServices() & NODE_BLOOM)) {\n+            LogPrint(BCLog::NET, \"filterclear received despite not offering bloom services from peer=%d; disconnecting\\n\", pfrom.GetId());\n             pfrom.fDisconnect = true;\n             return;\n         }"
      },
      {
        "sha": "a7e240dcfab9ad0972694e64daee89b1d41d55d5",
        "filename": "test/functional/p2p_timeouts.py",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7f37fbc3b60646a21a3228022abad19e4689abd7/test/functional/p2p_timeouts.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7f37fbc3b60646a21a3228022abad19e4689abd7/test/functional/p2p_timeouts.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_timeouts.py?ref=7f37fbc3b60646a21a3228022abad19e4689abd7",
        "patch": "@@ -74,9 +74,9 @@ def run_test(self):\n         no_version_node.send_message(msg_ping())\n \n         expected_timeout_logs = [\n-            \"version handshake timeout from 0\",\n-            \"socket no message in first 3 seconds, 1 0 from 1\",\n-            \"socket no message in first 3 seconds, 0 0 from 2\",\n+            \"version handshake timeout peer=0\",\n+            \"socket no message in first 3 seconds, 1 0 peer=1\",\n+            \"socket no message in first 3 seconds, 0 0 peer=2\",\n         ]\n \n         with self.nodes[0].assert_debug_log(expected_msgs=expected_timeout_logs):"
      }
    ]
  }
]