[
  {
    "sha": "a6f6f77a86a50de32275f7aac37aa6eaf79f79eb",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphNmY2Zjc3YTg2YTUwZGUzMjI3NWY3YWFjMzdhYTZlYWY3OWY3OWVi",
    "commit": {
      "author": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2019-04-25T07:44:00Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2019-10-30T18:56:25Z"
      },
      "message": "QA: Add wallet_implicitsegwit to test the ability to transform keys between address types",
      "tree": {
        "sha": "f990dcfd28a215cd26c5af3d4d1ad85062a13574",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f990dcfd28a215cd26c5af3d4d1ad85062a13574"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a6f6f77a86a50de32275f7aac37aa6eaf79f79eb",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a6f6f77a86a50de32275f7aac37aa6eaf79f79eb",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a6f6f77a86a50de32275f7aac37aa6eaf79f79eb",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a6f6f77a86a50de32275f7aac37aa6eaf79f79eb/comments",
    "author": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "8afa602f308ef003bb6893718eae1fe5a830690c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8afa602f308ef003bb6893718eae1fe5a830690c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/8afa602f308ef003bb6893718eae1fe5a830690c"
      }
    ],
    "stats": {
      "total": 65,
      "additions": 65,
      "deletions": 0
    },
    "files": [
      {
        "sha": "b6f2afd6c73203dc1c25ee5a10be69395c8155f4",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a6f6f77a86a50de32275f7aac37aa6eaf79f79eb/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a6f6f77a86a50de32275f7aac37aa6eaf79f79eb/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=a6f6f77a86a50de32275f7aac37aa6eaf79f79eb",
        "patch": "@@ -181,6 +181,7 @@\n     'mining_basic.py',\n     'wallet_bumpfee.py',\n     'wallet_bumpfee_totalfee_deprecation.py',\n+    'wallet_implicitsegwit.py',\n     'rpc_named_arguments.py',\n     'wallet_listsinceblock.py',\n     'p2p_leak.py',"
      },
      {
        "sha": "379fa6a12ffe14d58aec99f9cc738e41d93df822",
        "filename": "test/functional/wallet_implicitsegwit.py",
        "status": "added",
        "additions": 64,
        "deletions": 0,
        "changes": 64,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a6f6f77a86a50de32275f7aac37aa6eaf79f79eb/test/functional/wallet_implicitsegwit.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a6f6f77a86a50de32275f7aac37aa6eaf79f79eb/test/functional/wallet_implicitsegwit.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/wallet_implicitsegwit.py?ref=a6f6f77a86a50de32275f7aac37aa6eaf79f79eb",
        "patch": "@@ -0,0 +1,64 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the wallet implicit segwit feature.\"\"\"\n+\n+import test_framework.address as address\n+from test_framework.test_framework import BitcoinTestFramework\n+\n+# TODO: Might be nice to test p2pk here too\n+address_types = ('legacy', 'bech32', 'p2sh-segwit')\n+\n+def key_to_address(key, address_type):\n+    if address_type == 'legacy':\n+        return address.key_to_p2pkh(key)\n+    elif address_type == 'p2sh-segwit':\n+        return address.key_to_p2sh_p2wpkh(key)\n+    elif address_type == 'bech32':\n+        return address.key_to_p2wpkh(key)\n+\n+def send_a_to_b(receive_node, send_node):\n+    keys = {}\n+    for a in address_types:\n+        a_address = receive_node.getnewaddress(address_type=a)\n+        pubkey = receive_node.getaddressinfo(a_address)['pubkey']\n+        keys[a] = pubkey\n+        for b in address_types:\n+            b_address = key_to_address(pubkey, b)\n+            send_node.sendtoaddress(address=b_address, amount=1)\n+    return keys\n+\n+def check_implicit_transactions(implicit_keys, implicit_node):\n+    # The implicit segwit node allows conversion all possible ways\n+    txs = implicit_node.listtransactions(None, 99999)\n+    for a in address_types:\n+        pubkey = implicit_keys[a]\n+        for b in address_types:\n+            b_address = key_to_address(pubkey, b)\n+            assert(('receive', b_address) in tuple((tx['category'], tx['address']) for tx in txs))\n+\n+class ImplicitSegwitTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def run_test(self):\n+        self.log.info(\"Manipulating addresses and sending transactions to all variations\")\n+        implicit_keys = send_a_to_b(self.nodes[0], self.nodes[1])\n+\n+        self.sync_all()\n+\n+        self.log.info(\"Checking that transactions show up correctly without a restart\")\n+        check_implicit_transactions(implicit_keys, self.nodes[0])\n+\n+        self.log.info(\"Checking that transactions still show up correctly after a restart\")\n+        self.restart_node(0)\n+        self.restart_node(1)\n+\n+        check_implicit_transactions(implicit_keys, self.nodes[0])\n+\n+if __name__ == '__main__':\n+    ImplicitSegwitTest().main()"
      }
    ]
  }
]