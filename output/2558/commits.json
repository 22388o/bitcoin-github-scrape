[
  {
    "sha": "e79110822efdc5fef27b1b24232a0655359e7df3",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplNzkxMTA4MjJlZmRjNWZlZjI3YjFiMjQyMzJhMDY1NTM1OWU3ZGYz",
    "commit": {
      "author": {
        "name": "Philip Kaufmann",
        "email": "phil.kaufmann@t-online.de",
        "date": "2013-02-23T22:51:02Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-04-23T22:49:50Z"
      },
      "message": "remove duplicate bitdb.Open() code from init\n\n- remove code from step 7, which we already have in step 5 of init",
      "tree": {
        "sha": "1b341906d968306ebcecdcc6d667d97d0c2d61ba",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1b341906d968306ebcecdcc6d667d97d0c2d61ba"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e79110822efdc5fef27b1b24232a0655359e7df3",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e79110822efdc5fef27b1b24232a0655359e7df3",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e79110822efdc5fef27b1b24232a0655359e7df3",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e79110822efdc5fef27b1b24232a0655359e7df3/comments",
    "author": null,
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "af10e3f6ac26a1ece7950f5263864c94049bf89d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/af10e3f6ac26a1ece7950f5263864c94049bf89d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/af10e3f6ac26a1ece7950f5263864c94049bf89d"
      }
    ],
    "stats": {
      "total": 9,
      "additions": 0,
      "deletions": 9
    },
    "files": [
      {
        "sha": "11b7554ed1b0831c89525586ffc326a36ddce447",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 0,
        "deletions": 9,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e79110822efdc5fef27b1b24232a0655359e7df3/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e79110822efdc5fef27b1b24232a0655359e7df3/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=e79110822efdc5fef27b1b24232a0655359e7df3",
        "patch": "@@ -733,15 +733,6 @@ bool AppInit2(boost::thread_group& threadGroup)\n \n     fReindex = GetBoolArg(\"-reindex\");\n \n-    // Todo: Check if needed, because in step 5 we do the same\n-    if (!bitdb.Open(GetDataDir()))\n-    {\n-        string msg = strprintf(_(\"Error initializing database environment %s!\"\n-                                 \" To recover, BACKUP THAT DIRECTORY, then remove\"\n-                                 \" everything from it except for wallet.dat.\"), strDataDir.c_str());\n-        return InitError(msg);\n-    }\n-\n     // Upgrading to 0.8; hard-link the old blknnnn.dat files into /blocks/\n     filesystem::path blocksDir = GetDataDir() / \"blocks\";\n     if (!filesystem::exists(blocksDir))"
      }
    ]
  },
  {
    "sha": "1859aafef0a273e27e886646e36140cc5e375ee1",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxODU5YWFmZWYwYTI3M2UyN2U4ODY2NDZlMzYxNDBjYzVlMzc1ZWUx",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-04-23T22:41:04Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-04-23T23:37:19Z"
      },
      "message": "Try moving database/ away in case of failure",
      "tree": {
        "sha": "2d3198020445ad827635e0395b06ac6d60a7f79a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2d3198020445ad827635e0395b06ac6d60a7f79a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1859aafef0a273e27e886646e36140cc5e375ee1",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1859aafef0a273e27e886646e36140cc5e375ee1",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1859aafef0a273e27e886646e36140cc5e375ee1",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1859aafef0a273e27e886646e36140cc5e375ee1/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e79110822efdc5fef27b1b24232a0655359e7df3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e79110822efdc5fef27b1b24232a0655359e7df3",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e79110822efdc5fef27b1b24232a0655359e7df3"
      }
    ],
    "stats": {
      "total": 18,
      "additions": 16,
      "deletions": 2
    },
    "files": [
      {
        "sha": "48495c446a441bdda17bc37da273e6a4bc0784cb",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 16,
        "deletions": 2,
        "changes": 18,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1859aafef0a273e27e886646e36140cc5e375ee1/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1859aafef0a273e27e886646e36140cc5e375ee1/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=1859aafef0a273e27e886646e36140cc5e375ee1",
        "patch": "@@ -605,8 +605,22 @@ bool AppInit2(boost::thread_group& threadGroup)\n \n     if (!bitdb.Open(GetDataDir()))\n     {\n-        string msg = strprintf(_(\"Error initializing wallet database environment %s!\"), strDataDir.c_str());\n-        return InitError(msg);\n+        // try moving the database env out of the way\n+        boost::filesystem::path pathDatabase = GetDataDir() / \"database\";\n+        boost::filesystem::path pathDatabaseBak = GetDataDir() / strprintf(\"database.%\"PRI64d\".bak\", GetTime());\n+        try {\n+            boost::filesystem::rename(pathDatabase, pathDatabaseBak);\n+            printf(\"Moved old %s to %s. Retrying.\\n\", pathDatabase.string().c_str(), pathDatabaseBak.string().c_str());\n+        } catch(boost::filesystem::filesystem_error &error) {\n+             // failure is ok (well, not really, but it's not worse than what we started with)\n+        }\n+\n+        // try again\n+        if (!bitdb.Open(GetDataDir())) {\n+            // if it still fails, it probably means we can't even create the database env\n+            string msg = strprintf(_(\"Error initializing wallet database environment %s!\"), strDataDir.c_str());\n+            return InitError(msg);\n+        }\n     }\n \n     if (GetBoolArg(\"-salvagewallet\"))"
      }
    ]
  },
  {
    "sha": "ccda03b57022369c4352d0f5a816cff9ace833e6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjY2RhMDNiNTcwMjIzNjljNDM1MmQwZjVhODE2Y2ZmOWFjZTgzM2U2",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-04-23T22:43:14Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-04-24T20:38:56Z"
      },
      "message": "Remove database/ after clean shutdown",
      "tree": {
        "sha": "9969d73bf4b7878c891be84739279fc4f544ee56",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9969d73bf4b7878c891be84739279fc4f544ee56"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ccda03b57022369c4352d0f5a816cff9ace833e6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ccda03b57022369c4352d0f5a816cff9ace833e6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ccda03b57022369c4352d0f5a816cff9ace833e6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ccda03b57022369c4352d0f5a816cff9ace833e6/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1859aafef0a273e27e886646e36140cc5e375ee1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1859aafef0a273e27e886646e36140cc5e375ee1",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1859aafef0a273e27e886646e36140cc5e375ee1"
      }
    ],
    "stats": {
      "total": 12,
      "additions": 7,
      "deletions": 5
    },
    "files": [
      {
        "sha": "52d613bc3b860d40e1d96233b964d30c0d74e1a1",
        "filename": "src/db.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 4,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ccda03b57022369c4352d0f5a816cff9ace833e6/src/db.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ccda03b57022369c4352d0f5a816cff9ace833e6/src/db.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/db.cpp?ref=ccda03b57022369c4352d0f5a816cff9ace833e6",
        "patch": "@@ -38,7 +38,7 @@ void CDBEnv::EnvShutdown()\n     if (ret != 0)\n         printf(\"EnvShutdown exception: %s (%d)\\n\", DbEnv::strerror(ret), ret);\n     if (!fMockDb)\n-        DbEnv(0).remove(strPath.c_str(), 0);\n+        DbEnv(0).remove(path.string().c_str(), 0);\n }\n \n CDBEnv::CDBEnv() : dbenv(DB_CXX_NO_EXCEPTIONS)\n@@ -57,14 +57,14 @@ void CDBEnv::Close()\n     EnvShutdown();\n }\n \n-bool CDBEnv::Open(const boost::filesystem::path& path)\n+bool CDBEnv::Open(const boost::filesystem::path& pathIn)\n {\n     if (fDbEnvInit)\n         return true;\n \n     boost::this_thread::interruption_point();\n \n-    strPath = path.string();\n+    path = pathIn;\n     filesystem::path pathLogDir = path / \"database\";\n     filesystem::create_directory(pathLogDir);\n     filesystem::path pathErrorFile = path / \"db.log\";\n@@ -84,7 +84,7 @@ bool CDBEnv::Open(const boost::filesystem::path& path)\n     dbenv.set_flags(DB_AUTO_COMMIT, 1);\n     dbenv.set_flags(DB_TXN_WRITE_NOSYNC, 1);\n     dbenv.log_set_config(DB_LOG_AUTO_REMOVE, 1);\n-    int ret = dbenv.open(strPath.c_str(),\n+    int ret = dbenv.open(path.string().c_str(),\n                      DB_CREATE     |\n                      DB_INIT_LOCK  |\n                      DB_INIT_LOG   |\n@@ -456,6 +456,8 @@ void CDBEnv::Flush(bool fShutdown)\n             {\n                 dbenv.log_archive(&listp, DB_ARCH_REMOVE);\n                 Close();\n+                if (!fMockDb)\n+                    boost::filesystem::remove_all(path / \"database\");\n             }\n         }\n     }"
      },
      {
        "sha": "ea440c496079f7f3ded0ec8ecae0b6c3d4e980d3",
        "filename": "src/db.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ccda03b57022369c4352d0f5a816cff9ace833e6/src/db.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ccda03b57022369c4352d0f5a816cff9ace833e6/src/db.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/db.h?ref=ccda03b57022369c4352d0f5a816cff9ace833e6",
        "patch": "@@ -33,7 +33,7 @@ class CDBEnv\n private:\n     bool fDbEnvInit;\n     bool fMockDb;\n-    std::string strPath;\n+    boost::filesystem::path path;\n \n     void EnvShutdown();\n "
      }
    ]
  }
]