sipa,2016-06-05T15:42:58Z,"This mixed locking for mapNodeState is not particularly easy to reason about.\n\nWhat about creating a separate map (alongside mapNodeState) for storing misbehaviour information? Longer term, we'll want to see mapNodeState (and the processing-related data in CNode itself) split up into multiple modules (each with their own state) anyway.\n",https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-223820229,223820229,
kazcw,2016-06-05T21:19:35Z,That does sound better. I didn't like protecting the struct with different locks but I was trying to avoid the overhead of a new map. Reimplemented with a CMisbehaviorTracker that encapsulates its lock. TODO before mergeable: add unit tests for the new class.\n,https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-223838347,223838347,
sipa,2016-06-06T15:26:34Z,"Nice, utACK with 2 nits, but needs rebase.\n",https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-223993572,223993572,
kazcw,2016-06-06T16:01:04Z,Rebased and fixed indentation.\n,https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-224004335,224004335,
sipa,2016-06-06T16:21:36Z,utACK ae3c24040cfef500daf5c4b890d1cabe2e191d9a\n,https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-224009866,224009866,
kazcw,2016-06-10T14:56:30Z,"Some things about this design bug me, but I think I found a solution to my API nits that could fit well with future main state encapsulation improvements too.\n\n(TLDR; minor reimplementation coming soon)\n\nThis interface is inconsistent about what happens when an unregistered NodeId is referenced; for some functions it's an internal error, for others it's an expected possibility. It works, becau",https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-225205324,225205324,
sipa,2016-06-10T15:01:22Z,"Long term, I think having the CNodeState pointed to by CNode is wrong: the\nnetwork layer should not depend on the message handlers that are\nimplemented elsewhere (and especially not on main, where they are now).\n\nIdeally, CNode becomes private inside net, and is never exposed. Message\nhandlers get called with the NodeId passed to them, and sending messages in\ndone through a function exposed ",https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-225206764,225206764,
kazcw,2016-06-10T17:10:44Z,"Codifying expectations about lifetime with the NodeInfo handle can be done orthogonally to CNode encapsulation: If InitializeNode assigns the NodeIds, they could be the NodeInfo handles (`typedef shared_ptr<NodeInfo> NodeId`). Getting the NodeInfo handle in the message handler would be the same as getting the NodeId in the message handler (currently with CNode::GetId, eventually as a parameter to ",https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-225240666,225240666,
theuni,2016-06-10T17:49:28Z,"Many of those problems are already solved by #8085, so I'd like to very much request that we get that in before messing with CNode/CNodeState refactors.\n\n@sipa that PR works towards exactly what you describe. CNodes are no longer generally accessible except by proxy through CConnman, which also takes care of messages to keep CNodeState in sync without CNode having to know anything about it. In f",https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-225249760,225249760,
kazcw,2016-06-10T18:25:18Z,"@theuni I'm excited to see that p2p refactor land, it's much needed work. I think I can make these changes for more encapsulated, cs_main-less CNodeState data without any nontrivial conflict with that PR. NodeIds are mostly opaque to the net layer and the net layer doesn't know anything about CNodeStates. There are a couple lines of changes for this that would overlap (moving NodeId assignment out",https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-225259029,225259029,
theuni,2016-06-10T18:33:47Z,"@kazcw That sounds great, thanks! Also, maybe I could convince you to review that PR when you've got some time, since some of this is fresh in your mind :)\n",https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-225261239,225261239,
kazcw,2016-06-17T07:19:00Z,I'm going to break much smaller independent changes out of this for separate merging (with the eventual actual modularization being pure code movement). It seems like separating misbehavior from cs_main properly depends on the first steps of modularization. This PR is superseded by the coming incremental changes.\n,https://github.com/bitcoin/bitcoin/pull/8147#issuecomment-226698377,226698377,
sipa,2016-06-06T14:52:13Z,"Is the std::move necessary here, if nameIn is already an rvalue reference?\n",https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65904015,65904015,src/main.cpp
sipa,2016-06-06T15:15:57Z,Indentation?\n,https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65908907,65908907,src/main.cpp
kazcw,2016-06-06T15:54:27Z,"The `Info` ctor accepts an rvalue reference and binds it to `nameIn`, making it an lvalue.\n",https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65916528,65916528,src/main.cpp
sipa,2016-06-06T16:15:38Z,"Thanks for clearing that up, I'm still learning all the details related to rvalue reference semantics. I'm starting to understand the necessity of all the logic related to forwarding arguments...\n",https://github.com/bitcoin/bitcoin/pull/8147#discussion_r65920308,65920308,src/main.cpp
