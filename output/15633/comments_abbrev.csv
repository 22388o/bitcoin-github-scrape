gmaxwell,2019-03-21T09:55:55Z,@TheBlueMatt @pstratem ,https://github.com/bitcoin/bitcoin/pull/15633#issuecomment-475168548,475168548,
fanquake,2019-03-21T10:47:46Z,"`p2p_compactblocks.py` is failing with this change:\n```\nbash-3.2$ test/functional/test_runner.py p2p_compactblocks.py\nTemporary test directory at /var/folders/z2/cn877pxd3czdfh47mfkmbwgm0000gn/T/test_runner_₿_🏃_20190321_184436\nRemaining jobs: [p2p_compactblocks.py]\n1/1 - p2p_compactblocks.py failed, Duration: 3 s\n\nstdout:\n2019-03-21T10:44:36.761000Z TestFramework (INFO): Initializi",https://github.com/bitcoin/bitcoin/pull/15633#issuecomment-475183620,475183620,
gmaxwell,2019-03-21T11:15:43Z,"nevermind. after spending an hour trying to update the tests to support this, I give up. it's not worth the effort.",https://github.com/bitcoin/bitcoin/pull/15633#issuecomment-475191025,475191025,
sdaftuar,2019-03-21T17:55:22Z,Sorry for the pain here — I’ll try to rework the test to be more maintainable (and update for this PR).,https://github.com/bitcoin/bitcoin/pull/15633#issuecomment-475338058,475338058,
laanwj,2019-03-22T06:23:17Z,"it would be unfortunate if a clear improvement couldn't been done because of test impact, but if you're sure it's not worth the effort then let's leave it be\n\n> Sorry for the pain here — I’ll try to rework the test to be more maintainable (and update for this PR).\n\noh great!\n",https://github.com/bitcoin/bitcoin/pull/15633#issuecomment-475507719,475507719,
gmaxwell,2019-03-23T01:12:47Z,"It's a small improvement--  but the test makes really extensive assumptions about the protocol flow, and unfortunately its base case is a v1 peer (so it breaks much more than one case that tries HB vs non-HB for v1 peers).\n\nThe easy change would be switching almost all the test to v2, but then I'm concerned that it would leave v1 under-tested.\n\nSome of this is the product of the test desig",https://github.com/bitcoin/bitcoin/pull/15633#issuecomment-475826705,475826705,
jnewbery,2020-01-19T22:27:17Z,Is this any easier now that #15660 is merged?,https://github.com/bitcoin/bitcoin/pull/15633#issuecomment-576054404,576054404,
sdaftuar,2019-03-24T14:11:11Z,"Isn't `GetLocalServices()` always equal to what our services are, rather than our peers?  (I find this very confusing, but tracing through the code I can't see how this relates to what our peer sends us.)\n\nI think this code should be checking against the fWantsCmpctWitness variable for the peer, not GetLocalServices(). ",https://github.com/bitcoin/bitcoin/pull/15633#discussion_r268435516,268435516,src/net_processing.cpp
gmaxwell,2019-03-24T23:46:49Z,"Indeed, it's gated on nCMPCTBLOCKVersion on my branch now, but it isn't showing up here because the PR is closed.   What I was actually intending to match on was pfrom->nServices ... I'm not actually sure what will happen if a peer requests v2 compact blocks while not sending NODE_WITNESS",https://github.com/bitcoin/bitcoin/pull/15633#discussion_r268460540,268460540,src/net_processing.cpp
sdaftuar,2019-03-24T23:55:04Z,"I think (but haven't checked recently) that NODE_WITNESS is only used for finding outbound peers that we want to be connected to, and that we don't use it anywhere else in our p2p protocol logic (eg deciding how to serialize transactions/blocks and negotiating compact block versions).  So I suspect it would work just fine?",https://github.com/bitcoin/bitcoin/pull/15633#discussion_r268460916,268460916,src/net_processing.cpp
