promag,2018-06-17T14:18:53Z,"This should be simple, I don't think libevent would force such workarounds.\n\n> since event_base_loopexit seems to drop unstarted event\n\nAccording to the documentation it ignores pending events but active events are handled.\n\nAnd looks like sending the reply is an active event ():\n\nhttps://github.com/bitcoin/bitcoin/blob/d6cf4bd7eb3b675cdffec9884a6033f41033ad82/src/httpserver.cpp#L5",https://github.com/bitcoin/bitcoin/pull/13485#issuecomment-397882048,397882048,
ken2812221,2018-06-17T14:48:02Z,"That`event_active` could be called after threadHTTP exited and the event wouldn't get called in rare case. This can be tested by adding `sleep(1)` between `StartShutdown()` and `return` statement.\nhttps://github.com/bitcoin/bitcoin/blob/d6cf4bd7eb3b675cdffec9884a6033f41033ad82/src/rpc/server.cpp#L229-L240",https://github.com/bitcoin/bitcoin/pull/13485#issuecomment-397883771,397883771,
promag,2018-06-17T17:52:17Z,@ken2812221 so instead it should make sure the reply is handled before `event_base_loopexit` is called?,https://github.com/bitcoin/bitcoin/pull/13485#issuecomment-397895101,397895101,
ken2812221,2018-06-17T18:25:26Z,should make sure the reply is handled before threadHTTP loop exit because the loop can exit earlier than `event_base_loopexit` called. However I have no idea how to do that.,https://github.com/bitcoin/bitcoin/pull/13485#issuecomment-397897041,397897041,
MarcoFalke,2018-08-08T21:54:12Z,@ken2812221 Are you still working on this?,https://github.com/bitcoin/bitcoin/pull/13485#issuecomment-411564834,411564834,
ken2812221,2018-08-09T00:10:13Z,"@MarcoFalke If necessary, I can work on this again.",https://github.com/bitcoin/bitcoin/pull/13485#issuecomment-411594322,411594322,
DrahtBot,2018-08-09T05:06:16Z,"<!--e57a25ab6845829454e8d69fc972939a-->Reviewers, this pull request conflicts with the following ones:\n\n* #13501 (Correctly terminate HTTP server by promag)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",https://github.com/bitcoin/bitcoin/pull/13485#issuecomment-411637927,411637927,
MarcoFalke,2018-08-10T12:31:05Z,Tested 4e79d3e28167ac169f417623f07f48dd3cb0f6ac on current master and could run the tests for 24 hours in a loop. (Which is not possible on current master),https://github.com/bitcoin/bitcoin/pull/13485#issuecomment-412068151,412068151,
