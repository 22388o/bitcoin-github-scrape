DrahtBot,2020-06-20 03:33:09,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19102 (wallet: Introduce and use DummyDatabase instead of dummy BerkeleyDatabase by achow101)\n* #18904 (Don't call lsn_r",https://github.com/bitcoin/bitcoin/pull/19335#issuecomment-646931777,646931777,
laanwj,2020-07-29 16:02:38,Code review ACK 74507ce71eb61105fb3ae8460999099234ca7b8b,https://github.com/bitcoin/bitcoin/pull/19335#issuecomment-665753008,665753008,
ryanofsky,2020-07-15 23:08:36,"In commit ""walletdb: track database file use as m_refcount within BerkeleyDatabase"" (61da2fa6a159b0d318978cb8713f83705bb97035)\n\nNotes for reviewers: Assert here is moving to `BerkeleyDatabase::Verify` below. The reason the assert is currently true is because of the `IsWalletLoaded` check and `cs_wallets` lock in wallets.cpp. The lock is just being dropped and not moving, but should not be need",https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455415631,455415631,src/wallet/bdb.cpp
ryanofsky,2020-07-15 23:30:51,"In commit ""walletdb: track database file use as m_refcount within BerkeleyDatabase"" (61da2fa6a159b0d318978cb8713f83705bb97035)\n\nIt looks like there's a minor change behavior here could lead to extra logging and checkpoint and lsn reset calls. Previously this only iterated over unflushed databases, now it iterates over all databases even if they were already flushed.\n\nWould be good to eithe",https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455422879,455422879,src/wallet/bdb.cpp
ryanofsky,2020-07-15 23:44:17,"In commit ""walletdb: track database file use as m_refcount within BerkeleyDatabase"" (61da2fa6a159b0d318978cb8713f83705bb97035)\n\nThis looks like a bug that causes flushes to no longer happen when needed. Previous code checked if there were any batch operations since the last flush. New code is checking if a batch operation is currently in progress. This new check also appears to be always false",https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455427236,455427236,src/wallet/bdb.cpp
ryanofsky,2020-07-16 00:21:54,"In commit ""walletdb: Move Db->open to BerkeleyDatabase::Open"" (33554edc24a51685cfc3ca0053372c253d1fb4b9)\n\nThis is annoying, but I think there is another bug here. It's necessary to move the AddRef call before the Open call to avoid a race condition: https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437020063. But now there is another problem because if Open throws, then the reference c",https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455438675,455438675,src/wallet/bdb.cpp
ryanofsky,2020-07-16 00:59:42,"In commit ""walletdb: Use a global g_fileids instead of m_fileids for each env"" (8a98a83232fab6ff653c9475bb6e01249eadfa5c)\n\nI think now that we have .walletlock files, the ""in the future a more relaxed check"" TODO above has been implemented, and neither having the `for g_dbenvs` loop nor having a global fileid list make sense anymore. Like the comment and https://github.com/bitcoin/bitcoin/pull",https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455448730,455448730,src/wallet/bdb.cpp
achow101,2020-07-16 18:30:51,I've added a commit to merge `BerkeleyEnvironment::Verify` and `BerkeleyDatabase::Verify`,https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455989719,455989719,src/wallet/bdb.cpp
achow101,2020-07-16 18:32:31,I've changed `m_refcount` to track when the database has been flushed by setting it to `-1`. This is being done everywhere `mapFileUseCount.erase()` was happening. This allows us to restore the original behavior by checking for `m_refcount < 0`.,https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455990656,455990656,src/wallet/bdb.cpp
achow101,2020-07-16 18:33:18,Changed to use `m_refcount < 0` as mentioned in a previous comment.,https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455991075,455991075,src/wallet/bdb.cpp
achow101,2020-07-16 18:33:54,I've moved `m_database.RemoveRef()` to the destructor.,https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455991428,455991428,src/wallet/bdb.cpp
achow101,2020-07-16 18:34:06,Replaced that commit to do as you suggest.,https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455991570,455991570,src/wallet/bdb.cpp
ryanofsky,2020-07-16 20:02:49,"re: https://github.com/bitcoin/bitcoin/pull/19335#discussion_r455990656\n\nIn commit ""walletdb: track database file use as m_refcount within BerkeleyDatabase"" (516084a2738364f3922c08d8703fd737541bb2da)\n\n> I've changed `m_refcount` to track when the database has been flushed by setting it to `-1`. This is being done everywhere `mapFileUseCount.erase()` was happening. This allows us to restore",https://github.com/bitcoin/bitcoin/pull/19335#discussion_r456044809,456044809,src/wallet/bdb.cpp
promag,2020-07-25 00:11:33,Why was this removed?,https://github.com/bitcoin/bitcoin/pull/19335#discussion_r460336989,460336989,src/wallet/bdb.cpp
achow101,2020-07-25 15:31:55,It was there to guard mapFileUseCount which we've now removed.,https://github.com/bitcoin/bitcoin/pull/19335#discussion_r460415741,460415741,src/wallet/bdb.cpp
