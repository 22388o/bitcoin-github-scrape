[
  {
    "sha": "8c41469140584f3cbdd09fb62a1287da0216f431",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4YzQxNDY5MTQwNTg0ZjNjYmRkMDlmYjYyYTEyODdkYTAyMTZmNDMx",
    "commit": {
      "author": {
        "name": "Patrick Varilly",
        "email": "patvarilly@gmail.com",
        "date": "2011-07-14T00:45:34Z"
      },
      "committer": {
        "name": "St\u00e9phane Gimenez",
        "email": "dev@gim.name",
        "date": "2011-07-14T01:29:07Z"
      },
      "message": "Single DB transaction for all addresses in a message\n\nCuts disk activity at startup immensely",
      "tree": {
        "sha": "da2b8d9445fb2db927f3f3f0fd19da36378bb0a9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/da2b8d9445fb2db927f3f3f0fd19da36378bb0a9"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8c41469140584f3cbdd09fb62a1287da0216f431",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8c41469140584f3cbdd09fb62a1287da0216f431",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/8c41469140584f3cbdd09fb62a1287da0216f431",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8c41469140584f3cbdd09fb62a1287da0216f431/comments",
    "author": {
      "login": "patvarilly",
      "id": 1490362,
      "node_id": "MDQ6VXNlcjE0OTAzNjI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1490362?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/patvarilly",
      "html_url": "https://github.com/patvarilly",
      "followers_url": "https://api.github.com/users/patvarilly/followers",
      "following_url": "https://api.github.com/users/patvarilly/following{/other_user}",
      "gists_url": "https://api.github.com/users/patvarilly/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/patvarilly/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/patvarilly/subscriptions",
      "organizations_url": "https://api.github.com/users/patvarilly/orgs",
      "repos_url": "https://api.github.com/users/patvarilly/repos",
      "events_url": "https://api.github.com/users/patvarilly/events{/privacy}",
      "received_events_url": "https://api.github.com/users/patvarilly/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sgimenez",
      "id": 858993,
      "node_id": "MDQ6VXNlcjg1ODk5Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858993?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sgimenez",
      "html_url": "https://github.com/sgimenez",
      "followers_url": "https://api.github.com/users/sgimenez/followers",
      "following_url": "https://api.github.com/users/sgimenez/following{/other_user}",
      "gists_url": "https://api.github.com/users/sgimenez/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sgimenez/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sgimenez/subscriptions",
      "organizations_url": "https://api.github.com/users/sgimenez/orgs",
      "repos_url": "https://api.github.com/users/sgimenez/repos",
      "events_url": "https://api.github.com/users/sgimenez/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sgimenez/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "9cd22ab86296ae7039132423c7f9847bdc19a644",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9cd22ab86296ae7039132423c7f9847bdc19a644",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/9cd22ab86296ae7039132423c7f9847bdc19a644"
      }
    ],
    "stats": {
      "total": 22,
      "additions": 17,
      "deletions": 5
    },
    "files": [
      {
        "sha": "e3ad35044e1f30629ed4f6ac0b68adb4973c4b60",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 1,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8c41469140584f3cbdd09fb62a1287da0216f431/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8c41469140584f3cbdd09fb62a1287da0216f431/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=8c41469140584f3cbdd09fb62a1287da0216f431",
        "patch": "@@ -1899,6 +1899,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n             return error(\"message addr size() = %d\", vAddr.size());\n \n         // Store the new addresses\n+        CAddrDB addrDB;\n+        addrDB.TxnBegin();\n         int64 nNow = GetAdjustedTime();\n         int64 nSince = nNow - 10 * 60;\n         BOOST_FOREACH(CAddress& addr, vAddr)\n@@ -1910,7 +1912,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n                 continue;\n             if (addr.nTime <= 100000000 || addr.nTime > nNow + 10 * 60)\n                 addr.nTime = nNow - 5 * 24 * 60 * 60;\n-            AddAddress(addr, 2 * 60 * 60);\n+            AddAddress(addr, 2 * 60 * 60, &addrDB);\n             pfrom->AddAddressKnown(addr);\n             if (addr.nTime > nSince && !pfrom->fGetAddr && vAddr.size() <= 10 && addr.IsRoutable())\n             {\n@@ -1941,6 +1943,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n                 }\n             }\n         }\n+        addrDB.TxnCommit();  // Save addresses (it's ok if this fails)\n         if (vAddr.size() < 1000)\n             pfrom->fGetAddr = false;\n     }"
      },
      {
        "sha": "dcfff934b625be9ab4805e1aed2463b7929271df",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 11,
        "deletions": 3,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8c41469140584f3cbdd09fb62a1287da0216f431/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8c41469140584f3cbdd09fb62a1287da0216f431/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=8c41469140584f3cbdd09fb62a1287da0216f431",
        "patch": "@@ -440,7 +440,7 @@ void ThreadGetMyExternalIP(void* parg)\n \n \n \n-bool AddAddress(CAddress addr, int64 nTimePenalty)\n+bool AddAddress(CAddress addr, int64 nTimePenalty, CAddrDB *pAddrDB)\n {\n     if (!addr.IsRoutable())\n         return false;\n@@ -455,7 +455,10 @@ bool AddAddress(CAddress addr, int64 nTimePenalty)\n             // New address\n             printf(\"AddAddress(%s)\\n\", addr.ToString().c_str());\n             mapAddresses.insert(make_pair(addr.GetKey(), addr));\n-            CAddrDB().WriteAddress(addr);\n+            if (pAddrDB)\n+                pAddrDB->WriteAddress(addr);\n+            else\n+                CAddrDB().WriteAddress(addr);\n             return true;\n         }\n         else\n@@ -477,7 +480,12 @@ bool AddAddress(CAddress addr, int64 nTimePenalty)\n                 fUpdated = true;\n             }\n             if (fUpdated)\n-                CAddrDB().WriteAddress(addrFound);\n+            {\n+                if (pAddrDB)\n+                    pAddrDB->WriteAddress(addrFound);\n+                else\n+                    CAddrDB().WriteAddress(addrFound);\n+            }\n         }\n     }\n     return false;"
      },
      {
        "sha": "78055bfc697e2b01961b5ccf785fd174458267ce",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8c41469140584f3cbdd09fb62a1287da0216f431/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8c41469140584f3cbdd09fb62a1287da0216f431/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=8c41469140584f3cbdd09fb62a1287da0216f431",
        "patch": "@@ -14,6 +14,7 @@\n \n class CMessageHeader;\n class CAddress;\n+class CAddrDB;\n class CInv;\n class CRequestTracker;\n class CNode;\n@@ -39,7 +40,7 @@ bool ConnectSocket(const CAddress& addrConnect, SOCKET& hSocketRet, int nTimeout\n bool Lookup(const char *pszName, std::vector<CAddress>& vaddr, int nServices, int nMaxSolutions, bool fAllowLookup = false, int portDefault = 0, bool fAllowPort = false);\n bool Lookup(const char *pszName, CAddress& addr, int nServices, bool fAllowLookup = false, int portDefault = 0, bool fAllowPort = false);\n bool GetMyExternalIP(unsigned int& ipRet);\n-bool AddAddress(CAddress addr, int64 nTimePenalty=0);\n+bool AddAddress(CAddress addr, int64 nTimePenalty=0, CAddrDB *pAddrDB=NULL);\n void AddressCurrentlyConnected(const CAddress& addr);\n CNode* FindNode(unsigned int ip);\n CNode* ConnectNode(CAddress addrConnect, int64 nTimeout=0);"
      }
    ]
  },
  {
    "sha": "d655a26c9dd157a9e4bf08bff14bfaa69791287a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkNjU1YTI2YzlkZDE1N2E5ZTRiZjA4YmZmMTRiZmFhNjk3OTEyODdh",
    "commit": {
      "author": {
        "name": "St\u00e9phane Gimenez",
        "email": "dev@gim.name",
        "date": "2011-07-14T00:57:39Z"
      },
      "committer": {
        "name": "St\u00e9phane Gimenez",
        "email": "dev@gim.name",
        "date": "2011-07-14T01:50:06Z"
      },
      "message": "Single DB transaction for addresses from DNS seeds",
      "tree": {
        "sha": "809ec2e92ae795dbe006b3f4c94f0631f4db02e7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/809ec2e92ae795dbe006b3f4c94f0631f4db02e7"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d655a26c9dd157a9e4bf08bff14bfaa69791287a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d655a26c9dd157a9e4bf08bff14bfaa69791287a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/d655a26c9dd157a9e4bf08bff14bfaa69791287a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d655a26c9dd157a9e4bf08bff14bfaa69791287a/comments",
    "author": {
      "login": "sgimenez",
      "id": 858993,
      "node_id": "MDQ6VXNlcjg1ODk5Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858993?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sgimenez",
      "html_url": "https://github.com/sgimenez",
      "followers_url": "https://api.github.com/users/sgimenez/followers",
      "following_url": "https://api.github.com/users/sgimenez/following{/other_user}",
      "gists_url": "https://api.github.com/users/sgimenez/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sgimenez/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sgimenez/subscriptions",
      "organizations_url": "https://api.github.com/users/sgimenez/orgs",
      "repos_url": "https://api.github.com/users/sgimenez/repos",
      "events_url": "https://api.github.com/users/sgimenez/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sgimenez/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sgimenez",
      "id": 858993,
      "node_id": "MDQ6VXNlcjg1ODk5Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858993?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sgimenez",
      "html_url": "https://github.com/sgimenez",
      "followers_url": "https://api.github.com/users/sgimenez/followers",
      "following_url": "https://api.github.com/users/sgimenez/following{/other_user}",
      "gists_url": "https://api.github.com/users/sgimenez/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sgimenez/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sgimenez/subscriptions",
      "organizations_url": "https://api.github.com/users/sgimenez/orgs",
      "repos_url": "https://api.github.com/users/sgimenez/repos",
      "events_url": "https://api.github.com/users/sgimenez/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sgimenez/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "8c41469140584f3cbdd09fb62a1287da0216f431",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8c41469140584f3cbdd09fb62a1287da0216f431",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/8c41469140584f3cbdd09fb62a1287da0216f431"
      }
    ],
    "stats": {
      "total": 6,
      "additions": 5,
      "deletions": 1
    },
    "files": [
      {
        "sha": "2a90f6d0ccf03a0869db9c5a3e57b8a551a52ebb",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 1,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d655a26c9dd157a9e4bf08bff14bfaa69791287a/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d655a26c9dd157a9e4bf08bff14bfaa69791287a/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=d655a26c9dd157a9e4bf08bff14bfaa69791287a",
        "patch": "@@ -1166,6 +1166,8 @@ void DNSAddressSeed()\n     if (!fTestNet)\n     {\n         printf(\"Loading addresses from DNS seeds (could take a while)\\n\");\n+        CAddrDB addrDB;\n+        addrDB.TxnBegin();\n \n         for (int seed_idx = 0; seed_idx < ARRAYLEN(strDNSSeed); seed_idx++) {\n             vector<CAddress> vaddr;\n@@ -1176,12 +1178,14 @@ void DNSAddressSeed()\n                     if (addr.GetByte(3) != 127)\n                     {\n                         addr.nTime = 0;\n-                        AddAddress(addr);\n+                        AddAddress(addr, 0, &addrDB);\n                         found++;\n                     }\n                 }\n             }\n         }\n+\n+        addrDB.TxnCommit();  // Save addresses (it's ok if this fails)\n     }\n \n     printf(\"%d addresses found from DNS seeds\\n\", found);"
      }
    ]
  }
]