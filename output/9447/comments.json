[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269788793",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-269788793",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 269788793,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2OTc4ODc5Mw==",
    "user": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?u=b7dd63827227d69794b5fe28797b1bd107b930dd&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-12-30T16:09:06Z",
    "updated_at": "2016-12-30T16:09:06Z",
    "author_association": "MEMBER",
    "body": "Seems to fail `sendheaders.py` but not on my local machine...  I'll look into it...",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269788793/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269851859",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-269851859",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 269851859,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2OTg1MTg1OQ==",
    "user": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?u=6a4a31aaddbc438e053c52d084a698a5f622f1ea&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-12-31T06:17:06Z",
    "updated_at": "2016-12-31T06:17:06Z",
    "author_association": "CONTRIBUTOR",
    "body": "I like the coding style and elegance of this. Will help with testing.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269851859/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269867345",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-269867345",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 269867345,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2OTg2NzM0NQ==",
    "user": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?u=b7dd63827227d69794b5fe28797b1bd107b930dd&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-12-31T14:30:18Z",
    "updated_at": "2016-12-31T14:30:18Z",
    "author_association": "MEMBER",
    "body": "@rebroad As mentioned in the PR comment, this is built off 3 other PR's.  All of your comments either belong on those PR's or are related to the last commit which was just for debugging the travis failure and will be removed.  I have just left it there for now in case anyone else wants to see the error details.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269867345/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269871743",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-269871743",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 269871743,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2OTg3MTc0Mw==",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2016-12-31T16:19:12Z",
    "updated_at": "2016-12-31T16:19:12Z",
    "author_association": "CONTRIBUTOR",
    "body": "@morcos claimed on IRC the test failures might be (in part) due to the issue mentioned at https://github.com/bitcoin/bitcoin/pull/9375#issuecomment-269871618",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269871743/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269898285",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-269898285",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 269898285,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2OTg5ODI4NQ==",
    "user": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?u=6a4a31aaddbc438e053c52d084a698a5f622f1ea&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-01-01T10:32:50Z",
    "updated_at": "2017-01-01T10:33:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "@morcos although most of the lines I am commenting on have not been introduced by you, given you are changing the code near to them, I tought it was a good opportunity to suggest these changes as I believe they ought to be changed at some point, so perhaps could be with this PR.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269898285/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269913476",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-269913476",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 269913476,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2OTkxMzQ3Ng==",
    "user": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?u=b7dd63827227d69794b5fe28797b1bd107b930dd&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-01-01T18:19:34Z",
    "updated_at": "2017-01-01T18:19:34Z",
    "author_association": "MEMBER",
    "body": "Rebased with the newest commit from #9375 which fixes the failure.\r\n\r\nFor clarity only the 5 commits on which I'm the author are meant for review here.  The others are contained in the linked PR's...\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269913476/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269914553",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-269914553",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 269914553,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI2OTkxNDU1Mw==",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?u=0691974eedcc2ab5366cc1080fb1c030e87244c2&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-01-01T18:51:57Z",
    "updated_at": "2017-01-01T18:51:57Z",
    "author_association": "MEMBER",
    "body": "OT: Imo it makes sense to octomerge all pulls which this pull depends on and rebase the commits of this pull on top of the merge commit. Thus, the original commit hashes are preserved and it is clear what was old and should be reviewed in other pulls. Also, it is easier to see the fresh commits.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/269914553/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271004747",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-271004747",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 271004747,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI3MTAwNDc0Nw==",
    "user": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?u=b7dd63827227d69794b5fe28797b1bd107b930dd&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-01-06T21:00:30Z",
    "updated_at": "2017-01-06T21:00:30Z",
    "author_association": "MEMBER",
    "body": "Rebased and I think done the way @MarcoFalke suggested.\r\n\r\nAddressed feedback\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/271004747/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/273252886",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-273252886",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 273252886,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI3MzI1Mjg4Ng==",
    "user": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?u=b7dd63827227d69794b5fe28797b1bd107b930dd&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-01-17T18:19:25Z",
    "updated_at": "2017-01-17T18:19:25Z",
    "author_association": "MEMBER",
    "body": "rebased",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/273252886/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/278053808",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-278053808",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 278053808,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI3ODA1MzgwOA==",
    "user": {
      "login": "da2ce7",
      "id": 691439,
      "node_id": "MDQ6VXNlcjY5MTQzOQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/691439?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/da2ce7",
      "html_url": "https://github.com/da2ce7",
      "followers_url": "https://api.github.com/users/da2ce7/followers",
      "following_url": "https://api.github.com/users/da2ce7/following{/other_user}",
      "gists_url": "https://api.github.com/users/da2ce7/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/da2ce7/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/da2ce7/subscriptions",
      "organizations_url": "https://api.github.com/users/da2ce7/orgs",
      "repos_url": "https://api.github.com/users/da2ce7/repos",
      "events_url": "https://api.github.com/users/da2ce7/events{/privacy}",
      "received_events_url": "https://api.github.com/users/da2ce7/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-02-07T16:29:09Z",
    "updated_at": "2017-02-07T16:29:09Z",
    "author_association": "NONE",
    "body": "#9375, #9252, and #9400 are merged, needs rebase.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/278053808/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/279795397",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-279795397",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 279795397,
    "node_id": "MDEyOklzc3VlQ29tbWVudDI3OTc5NTM5Nw==",
    "user": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?u=b7dd63827227d69794b5fe28797b1bd107b930dd&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-02-14T18:38:42Z",
    "updated_at": "2017-02-14T18:38:42Z",
    "author_association": "MEMBER",
    "body": "rebased",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/279795397/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/327341699",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-327341699",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 327341699,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMyNzM0MTY5OQ==",
    "user": {
      "login": "jtimon",
      "id": 1008458,
      "node_id": "MDQ6VXNlcjEwMDg0NTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1008458?u=636a89c913ac407f52bb8d57c4fff384b98f421f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jtimon",
      "html_url": "https://github.com/jtimon",
      "followers_url": "https://api.github.com/users/jtimon/followers",
      "following_url": "https://api.github.com/users/jtimon/following{/other_user}",
      "gists_url": "https://api.github.com/users/jtimon/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jtimon/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jtimon/subscriptions",
      "organizations_url": "https://api.github.com/users/jtimon/orgs",
      "repos_url": "https://api.github.com/users/jtimon/repos",
      "events_url": "https://api.github.com/users/jtimon/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jtimon/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-09-06T00:41:35Z",
    "updated_at": "2017-09-06T00:41:35Z",
    "author_association": "MEMBER",
    "body": "More concurrency! concept ACK",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/327341699/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/327342404",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-327342404",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 327342404,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMyNzM0MjQwNA==",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-09-06T00:46:52Z",
    "updated_at": "2017-09-06T00:46:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "This should likely be closed in favor of #10984.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/327342404/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/336219907",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#issuecomment-336219907",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/9447",
    "id": 336219907,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMzNjIxOTkwNw==",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-10-12T18:08:44Z",
    "updated_at": "2017-10-12T18:08:44Z",
    "author_association": "CONTRIBUTOR",
    "body": "Should this still be closed in favor of #10984?\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/336219907/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269789",
    "pull_request_review_id": 14800768,
    "id": 94269789,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk0MjY5Nzg5",
    "diff_hunk": "@@ -1782,30 +1880,63 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             }\n         }\n \n+        // When we succeed in decoding a block's txids from a cmpctblock\n+        // message we typically jump to the BLOCKTXN handling code, with a\n+        // dummy (empty) BLOCKTXN message, to re-use the logic there in\n+        // completing processing of the putative block (without cs_main).\n+        bool fProcessBLOCKTXN = false;\n+        CDataStream blockTxnMsg(SER_NETWORK, PROTOCOL_VERSION);\n+\n+        // If we end up treating this as a plain headers message, call that as well\n+        // without cs_main.\n+        bool fRevertToHeaderProcessing = false;\n+        CDataStream vHeadersMsg(SER_NETWORK, PROTOCOL_VERSION);\n+\n         // Keep a CBlock for \"optimistic\" compactblock reconstructions (see\n         // below)\n         std::shared_ptr<CBlock> pblock = std::make_shared<CBlock>();\n         bool fBlockReconstructed = false;\n \n+        {\n         LOCK(cs_main);\n         // If AcceptBlockHeader returned true, it set pindex\n         assert(pindex);\n         UpdateBlockAvailability(pfrom->GetId(), pindex->GetBlockHash());\n \n-        std::map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n+        std::pair<BlockDownloadMap::iterator, BlockDownloadMap::iterator> rangeInFlight = mmapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        bool fAlreadyInFlight = rangeInFlight.first != rangeInFlight.second;\n+        bool fInFlightFromSamePeer = false;\n+        bool fPeerWasFirstRequest = true;\n+        bool peerFound = false;\n+        size_t countPartialBlocksStarted = 0;\n+        while (rangeInFlight.first != rangeInFlight.second) {\n+            if (rangeInFlight.first->second.first == pfrom->GetId()) {\n+                fInFlightFromSamePeer = true;\n+                peerFound = true;\n+            }\n+            if (rangeInFlight.first->second.second->partialBlock)\n+                countPartialBlocksStarted++;\n+            rangeInFlight.first++;\n+            if (!peerFound)\n+                fPeerWasFirstRequest = false;\n+        }\n \n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return true;\n-\n+        LogPrintf(\"ChainWork check at height %d new: %s  tip: %s\\n\",pindex->nHeight,pindex->nChainWork.GetHex(),chainActive.Tip()->nChainWork.GetHex());\n         if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know something better",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 518,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
    "user": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "why not make this < instead of <= ? why do we avoid requesting compact blocks for competing best blocks?",
    "created_at": "2016-12-31T06:06:53Z",
    "updated_at": "2017-02-14T18:37:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269789",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269789"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269789"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269789/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1927,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269821",
    "pull_request_review_id": 14800796,
    "id": 94269821,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk0MjY5ODIx",
    "diff_hunk": "@@ -1893,24 +2022,41 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                     fBlockReconstructed = true;\n                 }\n             }\n+            if (pindex->nHeight == 165) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 607,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
    "user": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "What is the deal with block height 165?",
    "created_at": "2016-12-31T06:11:00Z",
    "updated_at": "2017-02-14T18:37:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269821",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269821"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269821"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269821/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2025,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269827",
    "pull_request_review_id": 14800805,
    "id": 94269827,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk0MjY5ODI3",
    "diff_hunk": "@@ -1946,17 +2084,27 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         {\n             LOCK(cs_main);\n \n-            map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator it = mapBlocksInFlight.find(resp.blockhash);\n-            if (it == mapBlocksInFlight.end() || !it->second.second->partialBlock ||\n-                    it->second.first != pfrom->GetId()) {\n+            bool fExpectedBLOCKTXN = false;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 682,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
    "user": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Very much approve of the variable namings chosen in various places.",
    "created_at": "2016-12-31T06:12:12Z",
    "updated_at": "2017-02-14T18:37:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269827",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269827"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269827"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269827/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2087,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269850",
    "pull_request_review_id": 14800829,
    "id": 94269850,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk0MjY5ODUw",
    "diff_hunk": "@@ -2142,10 +2304,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                             pindexLast->GetBlockHash().ToString(), pindexLast->nHeight);\n                 }\n                 if (vGetData.size() > 0) {\n-                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mapBlocksInFlight.size() == 1 && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {\n-                        // We seem to be rather well-synced, so it appears pfrom was the first to provide us\n-                        // with this block! Let's get them to announce using compact blocks in the future.\n-                        MaybeSetPeerAsAnnouncingHeaderAndIDs(nodestate, pfrom, connman);\n+                    if (nodestate->fSupportsDesiredCmpctVersion && vGetData.size() == 1 && mmapBlocksInFlight.size() == mmapBlocksInFlight.count(vGetData[0].hash) && pindexLast->pprev->IsValid(BLOCK_VALID_CHAIN)) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 791,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
    "user": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Why not make this <=2 rather than ==1 (for mapBlocksInFlight.size())? this way if two blocks get announced in close proximity we can request compact blocks for both of them (rather than compact block for the oldest, and full block for the most recent).",
    "created_at": "2016-12-31T06:15:06Z",
    "updated_at": "2017-02-14T18:37:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269850",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269850"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94269850"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94269850/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2307,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94282342",
    "pull_request_review_id": 14811965,
    "id": 94282342,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk0MjgyMzQy",
    "diff_hunk": "@@ -1782,30 +1880,63 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             }\n         }\n \n+        // When we succeed in decoding a block's txids from a cmpctblock\n+        // message we typically jump to the BLOCKTXN handling code, with a\n+        // dummy (empty) BLOCKTXN message, to re-use the logic there in\n+        // completing processing of the putative block (without cs_main).\n+        bool fProcessBLOCKTXN = false;\n+        CDataStream blockTxnMsg(SER_NETWORK, PROTOCOL_VERSION);\n+\n+        // If we end up treating this as a plain headers message, call that as well\n+        // without cs_main.\n+        bool fRevertToHeaderProcessing = false;\n+        CDataStream vHeadersMsg(SER_NETWORK, PROTOCOL_VERSION);\n+\n         // Keep a CBlock for \"optimistic\" compactblock reconstructions (see\n         // below)\n         std::shared_ptr<CBlock> pblock = std::make_shared<CBlock>();\n         bool fBlockReconstructed = false;\n \n+        {\n         LOCK(cs_main);\n         // If AcceptBlockHeader returned true, it set pindex\n         assert(pindex);\n         UpdateBlockAvailability(pfrom->GetId(), pindex->GetBlockHash());\n \n-        std::map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator blockInFlightIt = mapBlocksInFlight.find(pindex->GetBlockHash());\n-        bool fAlreadyInFlight = blockInFlightIt != mapBlocksInFlight.end();\n+        std::pair<BlockDownloadMap::iterator, BlockDownloadMap::iterator> rangeInFlight = mmapBlocksInFlight.equal_range(pindex->GetBlockHash());\n+        bool fAlreadyInFlight = rangeInFlight.first != rangeInFlight.second;\n+        bool fInFlightFromSamePeer = false;\n+        bool fPeerWasFirstRequest = true;\n+        bool peerFound = false;\n+        size_t countPartialBlocksStarted = 0;\n+        while (rangeInFlight.first != rangeInFlight.second) {\n+            if (rangeInFlight.first->second.first == pfrom->GetId()) {\n+                fInFlightFromSamePeer = true;\n+                peerFound = true;\n+            }\n+            if (rangeInFlight.first->second.second->partialBlock)\n+                countPartialBlocksStarted++;\n+            rangeInFlight.first++;\n+            if (!peerFound)\n+                fPeerWasFirstRequest = false;\n+        }\n \n         if (pindex->nStatus & BLOCK_HAVE_DATA) // Nothing to do here\n             return true;\n-\n+        LogPrintf(\"ChainWork check at height %d new: %s  tip: %s\\n\",pindex->nHeight,pindex->nChainWork.GetHex(),chainActive.Tip()->nChainWork.GetHex());\n         if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know something better",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 518,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "f4832c33f0862b7013f33a1a3ffc8c83642225b0",
    "user": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "@morcos I couldn't see this added line in any of the 3 PRs you mentioned.",
    "created_at": "2017-01-01T10:31:14Z",
    "updated_at": "2017-02-14T18:37:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94282342",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94282342"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94282342"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94282342/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1927,
    "side": "RIGHT",
    "in_reply_to_id": 94269789
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94608924",
    "pull_request_review_id": 15138419,
    "id": 94608924,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk0NjA4OTI0",
    "diff_hunk": "@@ -2035,13 +2054,21 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             }\n         } else {\n             if (fInFlightFromSamePeer) {\n-                // We requested this block, but its far into the future, so our\n-                // mempool will probably be useless - request the block normally\n-                std::vector<CInv> vInv(1);\n-                vInv[0] = CInv(MSG_BLOCK | GetFetchFlags(pfrom, pindex->pprev, chainparams.GetConsensus()), cmpctblock.header.GetHash());\n-                connman.PushMessage(pfrom, msgMaker.Make(NetMsgType::GETDATA, vInv));\n-                return true;\n-            } else {\n+                if (fPeerWasFirstRequest) {\n+                    // We requested this block, but its far into the future, so our\n+                    // mempool will probably be useless - request the block normally\n+                    // Only allow a the first peer to request a full block",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 92,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "6060f3da8f3260e92ab9a46580c38b7eb4d31aa5",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "\"Only ask for the full block from the first peer we requested from\"?",
    "created_at": "2017-01-04T15:58:47Z",
    "updated_at": "2017-02-14T18:37:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94608924",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94608924"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94608924"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94608924/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2060,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94610828",
    "pull_request_review_id": 15138419,
    "id": 94610828,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk0NjEwODI4",
    "diff_hunk": "@@ -273,6 +273,41 @@ void InitializeNode(CNode *pnode, CConnman& connman) {\n         PushNodeVersion(pnode, connman, GetTime());\n }\n \n+// Requires cs_main\n+// Helper function for MarkBlockAsReceived and MarkBlockAsNotInFlight\n+void ClearDownloadState(BlockDownloadMap::iterator itInFlight) {\n+    CNodeState *state = State(itInFlight->second.first);\n+    state->nBlocksInFlightValidHeaders -= itInFlight->second.second->fValidatedHeaders;\n+    if (state->nBlocksInFlightValidHeaders == 0 && itInFlight->second.second->fValidatedHeaders) {\n+        // Last validated block on the queue was received.\n+        nPeersWithValidatedDownloads--;",
    "path": "src/net_processing.cpp",
    "position": 29,
    "original_position": 29,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "2ea1ceca56137b86dbe7f3d7a1194df62031a233",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "could just do the `-= itInFlight->second.second->fValidatedHeaders` as above to match.",
    "created_at": "2017-01-04T16:07:51Z",
    "updated_at": "2017-02-14T18:37:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94610828",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94610828"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94610828"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94610828/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 284,
    "original_line": 283,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94615561",
    "pull_request_review_id": 15138419,
    "id": 94615561,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk0NjE1NTYx",
    "diff_hunk": "@@ -297,35 +332,26 @@ void FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTime) {\n \n     if (mapNodeState.empty()) {\n         // Do a consistency check after the last peer is removed.\n-        assert(mapBlocksInFlight.empty());\n+        assert(mmapBlocksInFlight.empty());\n         assert(nPreferredDownload == 0);\n         assert(nPeersWithValidatedDownloads == 0);\n     }\n }\n \n+\n // Requires cs_main.\n // Returns a bool indicating whether we requested this block.\n-// Also used if a block was /not/ received and timed out or started with another peer\n bool MarkBlockAsReceived(const uint256& hash) {\n-    map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator itInFlight = mapBlocksInFlight.find(hash);\n-    if (itInFlight != mapBlocksInFlight.end()) {\n-        CNodeState *state = State(itInFlight->second.first);\n-        state->nBlocksInFlightValidHeaders -= itInFlight->second.second->fValidatedHeaders;\n-        if (state->nBlocksInFlightValidHeaders == 0 && itInFlight->second.second->fValidatedHeaders) {\n-            // Last validated block on the queue was received.\n-            nPeersWithValidatedDownloads--;\n-        }\n-        if (state->vBlocksInFlight.begin() == itInFlight->second.second) {\n-            // First block on the queue was received, update the start download time for the next one\n-            state->nDownloadingSince = std::max(state->nDownloadingSince, GetTimeMicros());\n-        }\n-        state->vBlocksInFlight.erase(itInFlight->second.second);\n-        state->nBlocksInFlight--;\n-        state->nStallingSince = 0;\n-        mapBlocksInFlight.erase(itInFlight);\n-        return true;\n-    }\n-    return false;\n+    bool found = false;\n+    std::pair<BlockDownloadMap::iterator, BlockDownloadMap::iterator> range = mmapBlocksInFlight.equal_range(hash);\n+    while (range.first != range.second) {\n+        found = true;\n+        BlockDownloadMap::iterator itInFlight = range.first;\n+        ClearDownloadState(itInFlight);\n+        range.first++;\n+        mmapBlocksInFlight.erase(itInFlight);",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 111,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "2ea1ceca56137b86dbe7f3d7a1194df62031a233",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "since C++11 can also just capture the return value and set as `range.first` instead of worrying about iterator invalidation.",
    "created_at": "2017-01-04T16:30:50Z",
    "updated_at": "2017-02-14T18:37:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94615561",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94615561"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94615561"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94615561/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 352,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94855329",
    "pull_request_review_id": 15396236,
    "id": 94855329,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk0ODU1MzI5",
    "diff_hunk": "@@ -105,7 +105,8 @@ namespace {\n         bool fValidatedHeaders;                                  //!< Whether this block has validated headers at the time of request.\n         std::unique_ptr<PartiallyDownloadedBlock> partialBlock;  //!< Optional, used for CMPCTBLOCK downloads\n     };\n-    map<uint256, pair<NodeId, list<QueuedBlock>::iterator> > mapBlocksInFlight;\n+    typedef std::multimap<uint256, pair<NodeId, list<QueuedBlock>::iterator>> BlockDownloadMap;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "2ea1ceca56137b86dbe7f3d7a1194df62031a233",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think indexing might by `NodeId` would be better than using a multimap, because it would ensure that there couldn't be multiple entries for a block from the same node. I'd suggest:\r\n\r\n```\r\ntypedef map<pair<uint256, NodeId>, list<QueuedBlock>::iterator> BlockDownloadMap;\r\n```\r\n\r\nThis also would let you replace some of the while loops added here with direct lookups. I thought some of these (especially the while loop with the break statement setting `fExpectedBLOCKTXN`) were kind of confusing.\r\n\r\nThe downside of using a map is that you wouldn't have an `equal_range` method to call in the places that do require a loop. But you could replace those equal_range calls with calls to an equivalent helper function:\r\n\r\n```\r\npair<BlockDownloadMap::iterator, BlockDownloadMap::iterator>\r\nGetBlockDownloadRange(BlockDownloadMap& blocks, const uint256& hash) {\r\n    return {blocks.lower_bound({hash, numeric_limits<NodeId>::min()}),\r\n            blocks.upper_bound({hash, numeric_limits<NodeId>::max()})};\r\n}\r\n```",
    "created_at": "2017-01-05T21:29:06Z",
    "updated_at": "2017-02-14T18:37:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94855329",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94855329"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94855329"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94855329/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 108,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94860099",
    "pull_request_review_id": 15396236,
    "id": 94860099,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk0ODYwMDk5",
    "diff_hunk": "@@ -2292,6 +2292,18 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                 }\n                 pindexWalk = pindexWalk->pprev;\n             }\n+            // Special case for second cmpctblock request of tip",
    "path": "src/net_processing.cpp",
    "position": 400,
    "original_position": 4,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "69a8ca6fb0f9d6d470fc34a70d7fa7e317c2c0d8",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Could you expand this comment a little bit to describe the condition being checked? In particular I don't understand how the IsWitnessEnabled and fHaveWitness parts relate to making the request.",
    "created_at": "2017-01-05T21:55:45Z",
    "updated_at": "2017-02-14T18:37:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94860099",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94860099"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94860099"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94860099/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 2395,
    "original_line": 2295,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94861101",
    "pull_request_review_id": 15396236,
    "id": 94861101,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk0ODYxMTAx",
    "diff_hunk": "@@ -1947,7 +1947,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n         if (pindex->nChainWork <= chainActive.Tip()->nChainWork || // We know something better\n                 pindex->nTx != 0) { // We had this block at some point, but pruned it\n-            if (fAlreadyInFlight) {\n+            if (fInFlightFromSamePeer) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "558a807f8e88c0a5cfdfe24eafd600d559d281d0",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Is this change (\"Only request full blocks from the peer we thought had the block in-flight\") a change in behavior? Or is it just a cleanup after the previous multimap commit? It seems like this commit should be merged into the preceding or following one, or the commit message should be extended to say what the effect is, what motivates it.",
    "created_at": "2017-01-05T22:01:36Z",
    "updated_at": "2017-02-14T18:37:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94861101",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94861101"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r94861101"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/94861101/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1950,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95018911",
    "pull_request_review_id": 15565189,
    "id": 95018911,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk1MDE4OTEx",
    "diff_hunk": "@@ -105,7 +105,8 @@ namespace {\n         bool fValidatedHeaders;                                  //!< Whether this block has validated headers at the time of request.\n         std::unique_ptr<PartiallyDownloadedBlock> partialBlock;  //!< Optional, used for CMPCTBLOCK downloads\n     };\n-    map<uint256, pair<NodeId, list<QueuedBlock>::iterator> > mapBlocksInFlight;\n+    typedef std::multimap<uint256, pair<NodeId, list<QueuedBlock>::iterator>> BlockDownloadMap;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "2ea1ceca56137b86dbe7f3d7a1194df62031a233",
    "user": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I'm unsure about this change.  In particular there are a lot of mmapBlocksInFlight.count(hash) calls that would get a bit less clear...   I'll think about it some more",
    "created_at": "2017-01-06T20:58:06Z",
    "updated_at": "2017-02-14T18:37:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r95018911",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95018911"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r95018911"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95018911/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 108,
    "side": "RIGHT",
    "in_reply_to_id": 94855329
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95022954",
    "pull_request_review_id": 15569437,
    "id": 95022954,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDk1MDIyOTU0",
    "diff_hunk": "@@ -105,7 +105,8 @@ namespace {\n         bool fValidatedHeaders;                                  //!< Whether this block has validated headers at the time of request.\n         std::unique_ptr<PartiallyDownloadedBlock> partialBlock;  //!< Optional, used for CMPCTBLOCK downloads\n     };\n-    map<uint256, pair<NodeId, list<QueuedBlock>::iterator> > mapBlocksInFlight;\n+    typedef std::multimap<uint256, pair<NodeId, list<QueuedBlock>::iterator>> BlockDownloadMap;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "2ea1ceca56137b86dbe7f3d7a1194df62031a233",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yeah, I noticed that in the later commits. You could have a count helper function returning std::distance(range.first, range.second). I do think a map is a better way to represent the data, but the c++ map implementation does makes it a little awkward. Anyway, it's just something to consider.",
    "created_at": "2017-01-06T21:24:20Z",
    "updated_at": "2017-02-14T18:37:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r95022954",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95022954"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r95022954"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/95022954/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 108,
    "side": "RIGHT",
    "in_reply_to_id": 94855329
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102987559",
    "pull_request_review_id": 23764444,
    "id": 102987559,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEwMjk4NzU1OQ==",
    "diff_hunk": "@@ -274,6 +274,41 @@ void InitializeNode(CNode *pnode, CConnman& connman) {\n         PushNodeVersion(pnode, connman, GetTime());\n }\n \n+// Requires cs_main",
    "path": "src/net_processing.cpp",
    "position": 22,
    "original_position": 22,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "d0260aea66dc3e9f5233842f088d83cceacc6cd8",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Can you AssertLockHeld?",
    "created_at": "2017-02-24T17:15:01Z",
    "updated_at": "2017-02-24T21:34:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r102987559",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102987559"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r102987559"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102987559/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 277,
    "original_line": 277,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102987571",
    "pull_request_review_id": 23764444,
    "id": 102987571,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEwMjk4NzU3MQ==",
    "diff_hunk": "@@ -274,6 +274,41 @@ void InitializeNode(CNode *pnode, CConnman& connman) {\n         PushNodeVersion(pnode, connman, GetTime());\n }\n \n+// Requires cs_main\n+// Helper function for MarkBlockAsReceived and MarkBlockAsNotInFlight\n+void ClearDownloadState(BlockDownloadMap::iterator itInFlight) {\n+    CNodeState *state = State(itInFlight->second.first);\n+    state->nBlocksInFlightValidHeaders -= itInFlight->second.second->fValidatedHeaders;\n+    if (state->nBlocksInFlightValidHeaders == 0 && itInFlight->second.second->fValidatedHeaders) {\n+        // Last validated block on the queue was received.\n+        nPeersWithValidatedDownloads--;\n+    }\n+    if (state->vBlocksInFlight.begin() == itInFlight->second.second) {\n+        // First block on the queue was received, update the start download time for the next one\n+        state->nDownloadingSince = std::max(state->nDownloadingSince, GetTimeMicros());\n+    }\n+    state->vBlocksInFlight.erase(itInFlight->second.second);\n+    state->nBlocksInFlight--;\n+    state->nStallingSince = 0;\n+}\n+\n+// Requires cs_main.",
    "path": "src/net_processing.cpp",
    "position": 40,
    "original_position": 40,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "d0260aea66dc3e9f5233842f088d83cceacc6cd8",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Can you AssertLockHeld?",
    "created_at": "2017-02-24T17:15:05Z",
    "updated_at": "2017-02-24T21:34:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r102987571",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102987571"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r102987571"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/102987571/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 295,
    "original_line": 295,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103034117",
    "pull_request_review_id": 23764444,
    "id": 103034117,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEwMzAzNDExNw==",
    "diff_hunk": "@@ -2292,6 +2292,18 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                 }\n                 pindexWalk = pindexWalk->pprev;\n             }\n+            // Special case for second cmpctblock request of tip",
    "path": "src/net_processing.cpp",
    "position": 400,
    "original_position": 4,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "69a8ca6fb0f9d6d470fc34a70d7fa7e317c2c0d8",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Also, maybe consider just pulling the MSG_CMPCT_BLOCK setting a bit later down up to here and just requesting the block in this if statement (possibly before the while loop above).",
    "created_at": "2017-02-24T21:12:37Z",
    "updated_at": "2017-02-24T21:34:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103034117",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103034117"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103034117"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103034117/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 2395,
    "original_line": 2295,
    "side": "RIGHT",
    "in_reply_to_id": 94860099
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103034317",
    "pull_request_review_id": 23764444,
    "id": 103034317,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEwMzAzNDMxNw==",
    "diff_hunk": "@@ -2392,6 +2392,20 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n                 pindexWalk = pindexWalk->pprev;\n             }\n+            // Special case for second cmpctblock request of tip\n+            // Must match all conditions to add to vToFetch above (except mmapBlocksInFlight.count)\n+            // and conditions to do CMPCT_BLOCK announcement below.\n+            if (vToFetch.size() == 0 && pindexLast->pprev == chainActive.Tip() &&\n+                mmapBlocksInFlight.size() == mmapBlocksInFlight.count(pindexLast->GetBlockHash()) &&\n+                mmapBlocksInFlight.count(pindexLast->GetBlockHash()) < MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK &&\n+                !(pindexLast->nStatus & BLOCK_HAVE_DATA) &&\n+                (!IsWitnessEnabled(pindexLast->pprev, chainparams.GetConsensus()) || State(pfrom->GetId())->fHaveWitness) &&",
    "path": "src/net_processing.cpp",
    "position": 407,
    "original_position": 11,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In the strange case that a peer does not set the fHaveWItness service bit, but does announce compact blocks v2, I believe this line would result in a full block request. More generally, because the two if statements always have to be in sync to avoid this, I really prefer we pull the actual request logic into this if statement.",
    "created_at": "2017-02-24T21:13:44Z",
    "updated_at": "2017-02-24T21:34:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103034317",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103034317"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103034317"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103034317/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 2402,
    "original_line": 2402,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103035443",
    "pull_request_review_id": 23764444,
    "id": 103035443,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEwMzAzNTQ0Mw==",
    "diff_hunk": "@@ -2072,8 +2086,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         // We want to be a bit conservative just to be extra careful about DoS\n         // possibilities in compact block processing...\n         if (pindex->nHeight <= chainActive.Height() + 2) {\n-            if ((!fAlreadyInFlight && nodestate->nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) ||\n-                fInFlightFromSamePeer) {\n+            if ((countPartialBlocksStarted < MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK && nodestate->nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER)) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 49,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "3f62b2cc1822503b35ec257ef01a64675ac33687",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The way I read this, the use of countPartialBlocksStarted, instead of a countBlocksStarted, means that we will request up to two compact blocks at a time, even if we are already requesting the full block from a peer. This seems strange to me, why not just max 2 in-flights at the same time for a given block, with the second never being a full block?",
    "created_at": "2017-02-24T21:20:38Z",
    "updated_at": "2017-02-24T21:34:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103035443",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103035443"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103035443"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103035443/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2089,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103036470",
    "pull_request_review_id": 23764444,
    "id": 103036470,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEwMzAzNjQ3MA==",
    "diff_hunk": "@@ -2392,6 +2392,20 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n                 pindexWalk = pindexWalk->pprev;\n             }\n+            // Special case for second cmpctblock request of tip\n+            // Must match all conditions to add to vToFetch above (except mmapBlocksInFlight.count)\n+            // and conditions to do CMPCT_BLOCK announcement below.\n+            if (vToFetch.size() == 0 && pindexLast->pprev == chainActive.Tip() &&\n+                mmapBlocksInFlight.size() == mmapBlocksInFlight.count(pindexLast->GetBlockHash()) &&\n+                mmapBlocksInFlight.count(pindexLast->GetBlockHash()) < MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK &&\n+                !(pindexLast->nStatus & BLOCK_HAVE_DATA) &&\n+                (!IsWitnessEnabled(pindexLast->pprev, chainparams.GetConsensus()) || State(pfrom->GetId())->fHaveWitness) &&\n+                nodestate->fSupportsDesiredCmpctVersion) {\n+                vToFetch.push_back(pindexLast);",
    "path": "src/net_processing.cpp",
    "position": 409,
    "original_position": 13,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Further, simply adding the entry to vToFetch here may result in a null pointer dereference, I believe. If a peer announces two headers messages back-to-back, the first time we will MarkBlockAsInFlight to them, and the second time we'll hit this condition and add the entry to vToFetch again (which should also be fixed). Further down, we'll MarkBlockAsInFlight to them again, but MarkBlockAsInFlight requires that, if the block is already in-flight to the same peer, pit be something non-NULL as it will be dereferenced, but it is NULL in the call below.",
    "created_at": "2017-02-24T21:26:55Z",
    "updated_at": "2017-02-24T21:34:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103036470",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103036470"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103036470"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103036470/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 2404,
    "original_line": 2404,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103036611",
    "pull_request_review_id": 23764444,
    "id": 103036611,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEwMzAzNjYxMQ==",
    "diff_hunk": "@@ -2392,6 +2392,20 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                 }\n                 pindexWalk = pindexWalk->pprev;\n             }\n+            // Special case for second cmpctblock request of tip\n+            // Must match all conditions to add to vToFetch above (except mmapBlocksInFlight.count)\n+            // and conditions to do CMPCT_BLOCK announcement below.\n+            if (vToFetch.size() == 0 && pindexLast->pprev == chainActive.Tip() &&\n+                mmapBlocksInFlight.size() == mmapBlocksInFlight.count(pindexLast->GetBlockHash()) &&\n+                mmapBlocksInFlight.count(pindexLast->GetBlockHash()) < MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK &&\n+                !(pindexLast->nStatus & BLOCK_HAVE_DATA) &&\n+                (!IsWitnessEnabled(pindexLast->pprev, chainparams.GetConsensus()) || State(pfrom->GetId())->fHaveWitness) &&\n+                nodestate->fSupportsDesiredCmpctVersion) {\n+                vToFetch.push_back(pindexLast);",
    "path": "src/net_processing.cpp",
    "position": 409,
    "original_position": 13,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I believe the above needs fixing in three ways - MarkBlockAsInFlight needs to be more robust against NULL pit, the request needs to move into this if statement and skip the remainder of this block of code, and we shouldn't double-request from the same peer.",
    "created_at": "2017-02-24T21:27:49Z",
    "updated_at": "2017-02-24T21:34:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103036611",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103036611"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103036611"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103036611/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 2404,
    "original_line": 2404,
    "side": "RIGHT",
    "in_reply_to_id": 103036470
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103037047",
    "pull_request_review_id": 23764444,
    "id": 103037047,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEwMzAzNzA0Nw==",
    "diff_hunk": "@@ -2072,8 +2086,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         // We want to be a bit conservative just to be extra careful about DoS\n         // possibilities in compact block processing...\n         if (pindex->nHeight <= chainActive.Height() + 2) {\n-            if ((!fAlreadyInFlight && nodestate->nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER) ||\n-                fInFlightFromSamePeer) {\n+            if ((countPartialBlocksStarted < MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK && nodestate->nBlocksInFlight < MAX_BLOCKS_IN_TRANSIT_PER_PEER)) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 49,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "3f62b2cc1822503b35ec257ef01a64675ac33687",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Also, why drop the fInFlightFromSamePeer option? It looks like we'll never getblocktxn from two peers simultaneously?",
    "created_at": "2017-02-24T21:30:17Z",
    "updated_at": "2017-02-24T21:34:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103037047",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103037047"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103037047"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103037047/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2089,
    "side": "RIGHT",
    "in_reply_to_id": 103035443
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103037352",
    "pull_request_review_id": 23764444,
    "id": 103037352,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEwMzAzNzM1Mg==",
    "diff_hunk": "@@ -2094,6 +2107,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                     return true;\n                 } else if (status == READ_STATUS_FAILED) {\n                     // Duplicate txindexes, the block is now in-flight, so just request it\n+                    // NOTE: This is the one place two full block requests can be outstanding",
    "path": "src/net_processing.cpp",
    "position": 260,
    "original_position": 57,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "3f62b2cc1822503b35ec257ef01a64675ac33687",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "OK, so why not just check fPeerWasFirstRequest and MarkBlockAsNotInFlight otherwise?",
    "created_at": "2017-02-24T21:31:57Z",
    "updated_at": "2017-02-24T21:34:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103037352",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103037352"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r103037352"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/103037352/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 2110,
    "original_line": 2110,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124669986",
    "pull_request_review_id": 46982937,
    "id": 124669986,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNDY2OTk4Ng==",
    "diff_hunk": "@@ -9,6 +9,8 @@\n #include \"net.h\"\n #include \"validationinterface.h\"\n \n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+static const int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 2;",
    "path": "src/net_processing.h",
    "position": 5,
    "original_position": 5,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "user": {
      "login": "jameshilliard",
      "id": 3298484,
      "node_id": "MDQ6VXNlcjMyOTg0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3298484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jameshilliard",
      "html_url": "https://github.com/jameshilliard",
      "followers_url": "https://api.github.com/users/jameshilliard/followers",
      "following_url": "https://api.github.com/users/jameshilliard/following{/other_user}",
      "gists_url": "https://api.github.com/users/jameshilliard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jameshilliard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jameshilliard/subscriptions",
      "organizations_url": "https://api.github.com/users/jameshilliard/orgs",
      "repos_url": "https://api.github.com/users/jameshilliard/repos",
      "events_url": "https://api.github.com/users/jameshilliard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jameshilliard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Should this be configurable? Might make sense for miners to have this higher.",
    "created_at": "2017-06-28T22:11:52Z",
    "updated_at": "2017-06-28T22:11:53Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r124669986",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124669986"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r124669986"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124669986/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 13,
    "original_line": 13,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124671168",
    "pull_request_review_id": 46984228,
    "id": 124671168,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNDY3MTE2OA==",
    "diff_hunk": "@@ -9,6 +9,8 @@\n #include \"net.h\"\n #include \"validationinterface.h\"\n \n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+static const int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 2;",
    "path": "src/net_processing.h",
    "position": 5,
    "original_position": 5,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Likely not, asking all your peers for a copy of the block poses the same network-DoS risks as connecting to hundreds of nodes, which people like to do because they believe it will help (though it usually actually hurts) them get their blocks out faster.\r\n\r\nMore importantly, if you're a miner and have good peers, I think it'd be somewhat rare for you to receive a third compact block announce before the first can respond to your blocktxn request, at least it will be once we get proper multi-threaded ProcessMessages implemented to respond to blocktxn requests for the latest block in the background (see #10652 for the beginnings of the steps to do so).",
    "created_at": "2017-06-28T22:18:47Z",
    "updated_at": "2017-06-28T22:18:47Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r124671168",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124671168"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r124671168"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124671168/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 13,
    "original_line": 13,
    "side": "RIGHT",
    "in_reply_to_id": 124669986
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124676221",
    "pull_request_review_id": 46989436,
    "id": 124676221,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNDY3NjIyMQ==",
    "diff_hunk": "@@ -9,6 +9,8 @@\n #include \"net.h\"\n #include \"validationinterface.h\"\n \n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+static const int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 2;",
    "path": "src/net_processing.h",
    "position": 5,
    "original_position": 5,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "user": {
      "login": "jameshilliard",
      "id": 3298484,
      "node_id": "MDQ6VXNlcjMyOTg0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3298484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jameshilliard",
      "html_url": "https://github.com/jameshilliard",
      "followers_url": "https://api.github.com/users/jameshilliard/followers",
      "following_url": "https://api.github.com/users/jameshilliard/following{/other_user}",
      "gists_url": "https://api.github.com/users/jameshilliard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jameshilliard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jameshilliard/subscriptions",
      "organizations_url": "https://api.github.com/users/jameshilliard/orgs",
      "repos_url": "https://api.github.com/users/jameshilliard/repos",
      "events_url": "https://api.github.com/users/jameshilliard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jameshilliard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "What do you think the upper limit is before it would generally cause a negative impact? Maybe just have an upper limit like we do for max outbound connections.",
    "created_at": "2017-06-28T22:50:22Z",
    "updated_at": "2017-06-28T22:50:23Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r124676221",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124676221"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r124676221"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124676221/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 13,
    "original_line": 13,
    "side": "RIGHT",
    "in_reply_to_id": 124669986
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124676800",
    "pull_request_review_id": 46990102,
    "id": 124676800,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNDY3NjgwMA==",
    "diff_hunk": "@@ -9,6 +9,8 @@\n #include \"net.h\"\n #include \"validationinterface.h\"\n \n+/** Maximum number of outstanding CMPCTBLOCK requests for the same block. */\n+static const int MAX_CMPCTBLOCKS_INFLIGHT_PER_BLOCK = 2;",
    "path": "src/net_processing.h",
    "position": 5,
    "original_position": 5,
    "commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "original_commit_id": "5eb857dccddbf0fc31b345deeab4c4b9c4c36800",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Probably around 2 :p. Its really only useful if your peer got stuck doing something and wasn't able to respond or is being actively malicious. Once we've fixed the block-on-block-validation-before-responding-to-blocktxn-requests issue, it should be somewhat rare for this to help more than a very small amount.",
    "created_at": "2017-06-28T22:54:22Z",
    "updated_at": "2017-06-28T22:54:22Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r124676800",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124676800"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/9447#discussion_r124676800"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/9447"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/124676800/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 13,
    "original_line": 13,
    "side": "RIGHT",
    "in_reply_to_id": 124669986
  }
]