[
  {
    "sha": "bcd2c9bb55a730ebf4dabfba1cfab599eb18e66e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiY2QyYzliYjU1YTczMGViZjRkYWJmYmExY2ZhYjU5OWViMThlNjZl",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-06-27T01:41:52Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-09-03T01:52:28Z"
      },
      "message": "Add CaughtUp() function (needed by later commits)",
      "tree": {
        "sha": "a5401d144312c8d34611f0db660333a622ddbdae",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a5401d144312c8d34611f0db660333a622ddbdae"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bcd2c9bb55a730ebf4dabfba1cfab599eb18e66e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bcd2c9bb55a730ebf4dabfba1cfab599eb18e66e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/bcd2c9bb55a730ebf4dabfba1cfab599eb18e66e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bcd2c9bb55a730ebf4dabfba1cfab599eb18e66e/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "2e731f24b5a5c894e013a6d752f1cd409303e916",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2e731f24b5a5c894e013a6d752f1cd409303e916",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/2e731f24b5a5c894e013a6d752f1cd409303e916"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 5,
      "deletions": 0
    },
    "files": [
      {
        "sha": "8f698b07f769c1d82dff31fef1a87a5090471552",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/bcd2c9bb55a730ebf4dabfba1cfab599eb18e66e/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/bcd2c9bb55a730ebf4dabfba1cfab599eb18e66e/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=bcd2c9bb55a730ebf4dabfba1cfab599eb18e66e",
        "patch": "@@ -1166,6 +1166,11 @@ int64_t GetBlockValue(int nHeight, int64_t nFees)\n     return nSubsidy + nFees;\n }\n \n+bool CaughtUp()\n+{\n+    return ((chainActive.Height() >= Checkpoints::GetTotalBlocksEstimate()) && chainActive.Tip()->GetBlockTime() > GetTime() - 90 * 60);\n+}\n+\n bool IsInitialBlockDownload()\n {\n     LOCK(cs_main);"
      }
    ]
  },
  {
    "sha": "d36e39ac05b2f0a1e56f0a4d88451979a58d5968",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkMzZlMzlhYzA1YjJmMGExZTU2ZjBhNGQ4ODQ1MTk3OWE1OGQ1OTY4",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-07-04T06:37:15Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-09-03T01:52:28Z"
      },
      "message": "Rearrange ProcessMessages + add nLastDataPos variable for partial message tracking.",
      "tree": {
        "sha": "79aafad7baf3daa49f8b3ef839feab320cec180a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/79aafad7baf3daa49f8b3ef839feab320cec180a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d36e39ac05b2f0a1e56f0a4d88451979a58d5968",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d36e39ac05b2f0a1e56f0a4d88451979a58d5968",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/d36e39ac05b2f0a1e56f0a4d88451979a58d5968",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d36e39ac05b2f0a1e56f0a4d88451979a58d5968/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "bcd2c9bb55a730ebf4dabfba1cfab599eb18e66e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bcd2c9bb55a730ebf4dabfba1cfab599eb18e66e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/bcd2c9bb55a730ebf4dabfba1cfab599eb18e66e"
      }
    ],
    "stats": {
      "total": 15,
      "additions": 7,
      "deletions": 8
    },
    "files": [
      {
        "sha": "5a36cee3e9e75fb6819ec65128ddc35ed8551bec",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 8,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d36e39ac05b2f0a1e56f0a4d88451979a58d5968/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d36e39ac05b2f0a1e56f0a4d88451979a58d5968/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=d36e39ac05b2f0a1e56f0a4d88451979a58d5968",
        "patch": "@@ -4126,10 +4126,13 @@ bool ProcessMessages(CNode* pfrom)\n \n         // get next message\n         CNetMessage& msg = *it;\n+        CMessageHeader& hdr = msg.hdr;\n+        unsigned int nMessageSize = hdr.nMessageSize;\n+        string strCommand = hdr.GetCommand();\n \n         //if (fDebug)\n         //    LogPrintf(\"ProcessMessages(message %u msgsz, %u bytes, complete:%s)\\n\",\n-        //            msg.hdr.nMessageSize, msg.vRecv.size(),\n+        //            nMessageSize, msg.vRecv.size(),\n         //            msg.complete() ? \"Y\" : \"N\");\n \n         // end, if an incomplete message is found\n@@ -4146,17 +4149,11 @@ bool ProcessMessages(CNode* pfrom)\n             break;\n         }\n \n-        // Read header\n-        CMessageHeader& hdr = msg.hdr;\n         if (!hdr.IsValid())\n         {\n-            LogPrintf(\"\\n\\nPROCESSMESSAGE: ERRORS IN HEADER %s\\n\\n\\n\", hdr.GetCommand());\n+            LogPrintf(\"\\n\\nPROCESSMESSAGE: ERRORS IN HEADER %s\\n\\n\\n\", strCommand);\n             continue;\n         }\n-        string strCommand = hdr.GetCommand();\n-\n-        // Message size\n-        unsigned int nMessageSize = hdr.nMessageSize;\n \n         // Checksum\n         CDataStream& vRecv = msg.vRecv;"
      },
      {
        "sha": "ad9b5bb3e7e6c91cc0fdb02b3c55f328bf84c74a",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d36e39ac05b2f0a1e56f0a4d88451979a58d5968/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d36e39ac05b2f0a1e56f0a4d88451979a58d5968/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=d36e39ac05b2f0a1e56f0a4d88451979a58d5968",
        "patch": "@@ -176,6 +176,7 @@ class CNetMessage {\n \n     CDataStream vRecv;              // received message data\n     unsigned int nDataPos;\n+    unsigned int nLastDataPos;\n \n     int64_t nTime;                  // time (in microseconds) of message receipt.\n \n@@ -184,6 +185,7 @@ class CNetMessage {\n         in_data = false;\n         nHdrPos = 0;\n         nDataPos = 0;\n+        nLastDataPos = 0;\n         nTime = 0;\n     }\n "
      }
    ]
  },
  {
    "sha": "673ed30f53503afc6aab94b45177913f67f44ec5",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2NzNlZDMwZjUzNTAzYWZjNmFhYjk0YjQ1MTc3OTEzZjY3ZjQ0ZWM1",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-06-24T04:22:28Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-09-03T01:52:29Z"
      },
      "message": "Don't request blocks when block invs received unless it's the syncnode, or we've CaughtUp()",
      "tree": {
        "sha": "b4c3be0e7e342651961c8fc6189b91bfb3facee2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b4c3be0e7e342651961c8fc6189b91bfb3facee2"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/673ed30f53503afc6aab94b45177913f67f44ec5",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/673ed30f53503afc6aab94b45177913f67f44ec5",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/673ed30f53503afc6aab94b45177913f67f44ec5",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/673ed30f53503afc6aab94b45177913f67f44ec5/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "d36e39ac05b2f0a1e56f0a4d88451979a58d5968",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d36e39ac05b2f0a1e56f0a4d88451979a58d5968",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/d36e39ac05b2f0a1e56f0a4d88451979a58d5968"
      }
    ],
    "stats": {
      "total": 48,
      "additions": 39,
      "deletions": 9
    },
    "files": [
      {
        "sha": "9d0f1e1397e2047aa7d2cca5185e5e773b84204f",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 24,
        "deletions": 6,
        "changes": 30,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/673ed30f53503afc6aab94b45177913f67f44ec5/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/673ed30f53503afc6aab94b45177913f67f44ec5/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=673ed30f53503afc6aab94b45177913f67f44ec5",
        "patch": "@@ -3616,6 +3616,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         }\n \n         LOCK(cs_main);\n+        int nBlocksGet = 0;\n \n         for (unsigned int nInv = 0; nInv < vInv.size(); nInv++)\n         {\n@@ -3629,21 +3630,26 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n             if (!fAlreadyHave) {\n                 if (!fImporting && !fReindex) {\n-                    if (inv.type == MSG_BLOCK)\n-                        AddBlockToQueue(pfrom->GetId(), inv.hash);\n-                    else\n+                    if (inv.type == MSG_BLOCK) {\n+                        if (pfrom->tGetblocks > pfrom->tBlockInvs || CaughtUp()) {\n+                            AddBlockToQueue(pfrom->GetId(), inv.hash);\n+                            nBlocksGet++;\n+                        }\n+                    } else\n                         pfrom->AskFor(inv);\n                 }\n-            } else if (inv.type == MSG_BLOCK && mapOrphanBlocks.count(inv.hash)) {\n+            } else if (inv.type == MSG_BLOCK && mapOrphanBlocks.count(inv.hash))\n                 PushGetBlocks(pfrom, chainActive.Tip(), GetOrphanRoot(inv.hash));\n-            }\n \n             if (inv.type == MSG_BLOCK)\n                 UpdateBlockAvailability(pfrom->GetId(), inv.hash);\n \n             // Track requests for our stuff\n             g_signals.Inventory(inv.hash);\n         }\n+\n+        if (nBlocksGet)\n+            pfrom->tBlockInvs = GetTimeMillis();\n     }\n \n \n@@ -3854,7 +3860,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         }\n \n         CValidationState state;\n-        ProcessBlock(state, pfrom, &block);\n+        if (ProcessBlock(state, pfrom, &block))\n+            pfrom->tBlockRecved = GetTimeMillis();\n         int nDoS;\n         if (state.IsInvalid(nDoS)) {\n             pfrom->PushMessage(\"reject\", strCommand, state.GetRejectCode(),\n@@ -4134,6 +4141,14 @@ bool ProcessMessages(CNode* pfrom)\n         //    LogPrintf(\"ProcessMessages(message %u msgsz, %u bytes, complete:%s)\\n\",\n         //            nMessageSize, msg.vRecv.size(),\n         //            msg.complete() ? \"Y\" : \"N\");\n+        if (msg.nDataPos != msg.nLastDataPos) {\n+            if (strCommand == \"block\") {\n+                if (msg.nLastDataPos == 0)\n+                    pfrom->tBlockRecvStart = GetTimeMillis();\n+                pfrom->tBlockRecving = GetTimeMillis();\n+            }\n+            msg.nLastDataPos = msg.nDataPos;\n+        }\n \n         // end, if an incomplete message is found\n         if (!msg.complete())\n@@ -4327,6 +4342,7 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         if (pto->fStartSync && !fImporting && !fReindex) {\n             pto->fStartSync = false;\n             PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+            pto->tGetblocks = GetTimeMillis();\n         }\n \n         // Resend wallet transactions that haven't gotten in a block yet\n@@ -4410,6 +4426,8 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n             vGetData.push_back(CInv(MSG_BLOCK, hash));\n             MarkBlockAsInFlight(pto->GetId(), hash);\n             LogPrint(\"net\", \"Requesting block %s peer=%d\\n\", hash.ToString(), pto->id);\n+            if (!pto->tGetdataBlock)\n+                pto->tGetdataBlock = GetTimeMillis();\n             if (vGetData.size() >= 1000)\n             {\n                 pto->PushMessage(\"getdata\", vGetData);"
      },
      {
        "sha": "f55a20175a2a37f39e7008fc86bd24e24de992d5",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/673ed30f53503afc6aab94b45177913f67f44ec5/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/673ed30f53503afc6aab94b45177913f67f44ec5/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=673ed30f53503afc6aab94b45177913f67f44ec5",
        "patch": "@@ -2052,6 +2052,12 @@ CNode::CNode(SOCKET hSocketIn, CAddress addrIn, std::string addrNameIn, bool fIn\n     nSendBytes = 0;\n     nRecvBytes = 0;\n     nTimeConnected = GetTime();\n+    tGetblocks = 0;\n+    tBlockInvs = 0;\n+    tGetdataBlock = 0;\n+    tBlockRecvStart = 0;\n+    tBlockRecving = 0;\n+    tBlockRecved = 0;\n     addr = addrIn;\n     addrName = addrNameIn == \"\" ? addr.ToStringIPPort() : addrNameIn;\n     nVersion = 0;"
      },
      {
        "sha": "e9773786c50ad9652796769639e82504ebb3b35a",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 9,
        "deletions": 3,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/673ed30f53503afc6aab94b45177913f67f44ec5/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/673ed30f53503afc6aab94b45177913f67f44ec5/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=673ed30f53503afc6aab94b45177913f67f44ec5",
        "patch": "@@ -230,9 +230,15 @@ class CNode\n     uint64_t nRecvBytes;\n     int nRecvVersion;\n \n-    int64_t nLastSend;\n-    int64_t nLastRecv;\n-    int64_t nTimeConnected;\n+    int64_t nLastSend;       // Time data last sent to peer.\n+    int64_t nLastRecv;       // Time data last received from peer.\n+    int64_t nTimeConnected;  // Time connection to peer was established.\n+    int64_t tGetblocks;      // When we became a sync node.\n+    int64_t tBlockInvs;      // Time new block invs arrived from peer.\n+    int64_t tGetdataBlock;   // Time getdata block sent.\n+    int64_t tBlockRecvStart; // Time block reception first detected.\n+    int64_t tBlockRecving;   // Time block reception last progressed.\n+    int64_t tBlockRecved;    // Time last complete block received.\n     CAddress addr;\n     std::string addrName;\n     CService addrLocal;"
      }
    ]
  },
  {
    "sha": "3fae9f481317cc59040537a91d40ddb0a1a0fffb",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozZmFlOWY0ODEzMTdjYzU5MDQwNTM3YTkxZDQwZGRiMGExYTBmZmZi",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-06-28T02:03:44Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-09-03T01:52:29Z"
      },
      "message": "Force selection of a new syncnode since the current syncnode is about to stop sending blocks.",
      "tree": {
        "sha": "702171d7790d1f39ad00fef3a9d25f916a2beaf9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/702171d7790d1f39ad00fef3a9d25f916a2beaf9"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3fae9f481317cc59040537a91d40ddb0a1a0fffb",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3fae9f481317cc59040537a91d40ddb0a1a0fffb",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/3fae9f481317cc59040537a91d40ddb0a1a0fffb",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3fae9f481317cc59040537a91d40ddb0a1a0fffb/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "673ed30f53503afc6aab94b45177913f67f44ec5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/673ed30f53503afc6aab94b45177913f67f44ec5",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/673ed30f53503afc6aab94b45177913f67f44ec5"
      }
    ],
    "stats": {
      "total": 9,
      "additions": 9,
      "deletions": 0
    },
    "files": [
      {
        "sha": "c054ddfc3d38758ccbf8d89084cab00f97bc5a9f",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 0,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/3fae9f481317cc59040537a91d40ddb0a1a0fffb/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/3fae9f481317cc59040537a91d40ddb0a1a0fffb/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=3fae9f481317cc59040537a91d40ddb0a1a0fffb",
        "patch": "@@ -4125,6 +4125,15 @@ bool ProcessMessages(CNode* pfrom)\n     // this maintains the order of responses\n     if (!pfrom->vRecvGetData.empty()) return fOk;\n \n+    int nBlocksToDownload = State(pfrom->id)->nBlocksToDownload;\n+    int nBlocksInFlight = State(pfrom->id)->nBlocksInFlight;\n+\n+    // Cause a new syncnode to be reselected since we're about to stop receiving blocks\n+    // (and we'll be ignoring the inv the current syncnode sends in favour of selecting\n+    // a potentially better syncnode.\n+    if (nBlocksInFlight + nBlocksToDownload == 1 && !CaughtUp())\n+        pfrom->tGetblocks = 0;\n+\n     std::deque<CNetMessage>::iterator it = pfrom->vRecvMsg.begin();\n     while (!pfrom->fDisconnect && it != pfrom->vRecvMsg.end()) {\n         // Don't bother if send buffer is too full to respond anyway"
      }
    ]
  },
  {
    "sha": "48474db015bc2462fe833d563947d02b9013be5e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0ODQ3NGRiMDE1YmMyNDYyZmU4MzNkNTYzOTQ3ZDAyYjkwMTNiZTVl",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-06-26T14:01:07Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-09-03T01:52:29Z"
      },
      "message": "Replacement stalled block logic. Depending on the situation, it will either disconnect\nthe peer (as previous behaviour), or it will reselect a syncnode (e.g. when 500 blocks\nhave been received from the syncnode).",
      "tree": {
        "sha": "b4602fa5cbaca325eb93d41b13be94f35cea7c55",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b4602fa5cbaca325eb93d41b13be94f35cea7c55"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/48474db015bc2462fe833d563947d02b9013be5e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/48474db015bc2462fe833d563947d02b9013be5e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/48474db015bc2462fe833d563947d02b9013be5e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/48474db015bc2462fe833d563947d02b9013be5e/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "3fae9f481317cc59040537a91d40ddb0a1a0fffb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3fae9f481317cc59040537a91d40ddb0a1a0fffb",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/3fae9f481317cc59040537a91d40ddb0a1a0fffb"
      }
    ],
    "stats": {
      "total": 49,
      "additions": 31,
      "deletions": 18
    },
    "files": [
      {
        "sha": "e41663f9f87ac9fdf0025137306d1056552d3e23",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 27,
        "deletions": 15,
        "changes": 42,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/48474db015bc2462fe833d563947d02b9013be5e/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/48474db015bc2462fe833d563947d02b9013be5e/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=48474db015bc2462fe833d563947d02b9013be5e",
        "patch": "@@ -3405,10 +3405,6 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         return true;\n     }\n \n-    {\n-        LOCK(cs_main);\n-        State(pfrom->GetId())->nLastBlockProcess = GetTimeMicros();\n-    }\n \n \n \n@@ -4349,9 +4345,9 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n \n         // Start block sync\n         if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n             PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n             pto->tGetblocks = GetTimeMillis();\n+            pto->fStartSync = false;\n         }\n \n         // Resend wallet transactions that haven't gotten in a block yet\n@@ -4411,16 +4407,31 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n             pto->PushMessage(\"inv\", vInv);\n \n \n-        // Detect stalled peers. Require that blocks are in flight, we haven't\n-        // received a (requested) block in one minute, and that all blocks are\n-        // in flight for over two minutes, since we first had a chance to\n-        // process an incoming block.\n-        int64_t nNow = GetTimeMicros();\n-        if (!pto->fDisconnect && state.nBlocksInFlight &&\n-            state.nLastBlockReceive < state.nLastBlockProcess - BLOCK_DOWNLOAD_TIMEOUT*1000000 &&\n-            state.vBlocksInFlight.front().nTime < state.nLastBlockProcess - 2*BLOCK_DOWNLOAD_TIMEOUT*1000000) {\n-            LogPrintf(\"Peer %s is stalling block download, disconnecting\\n\", state.name.c_str());\n-            pto->fDisconnect = true;\n+        // Detect stalled peers.\n+        int64_t tNow = GetTimeMillis();\n+        if (pto->tGetblocks) {\n+            if (pto->tBlockRecving > pto->tBlockRecved) {\n+                if (tNow-pto->tBlockRecving > BLOCK_DOWNLOAD_TIMEOUT * 1000) {\n+                    LogPrintf(\"sync peer=%d: Block download stalled for over %d seconds.\\n\",\n+                        pto->id, BLOCK_DOWNLOAD_TIMEOUT);\n+                    pto->fDisconnect = true;\n+                }\n+            } else if (pto->tGetblocks > pto->tBlockInvs && tNow-pto->tGetblocks > BLOCK_DOWNLOAD_TIMEOUT * 1000) {\n+                LogPrintf(\"sync peer=%d: No invs of new blocks received within %d seconds.\\n\",\n+                    pto->id, BLOCK_DOWNLOAD_TIMEOUT);\n+                pto->fDisconnect = true;\n+            } else if (!CaughtUp() && pto->tBlockRecved && tNow-pto->tBlockRecved > BLOCK_DOWNLOAD_TIMEOUT * 1000) {\n+                LogPrintf(\"sync peer=%d: No block reception for over %d seconds.\\n\",\n+                    pto->id, BLOCK_DOWNLOAD_TIMEOUT);\n+                if (state.nBlocksInFlight)\n+                    pto->fDisconnect = true;\n+                else\n+                    pto->tGetblocks = 0; // shouldn't ever get here\n+            } else if (pto->tGetdataBlock > pto->tBlockRecving && tNow-pto->tGetdataBlock > BLOCK_DOWNLOAD_TIMEOUT * 1000) {\n+                LogPrintf(\"sync peer=%d: No block download started for over %d seconds.\\n\",\n+                    pto->id, BLOCK_DOWNLOAD_TIMEOUT);\n+                pto->fDisconnect = true;\n+            }\n         }\n \n         // Update knowledge of peer's block availability.\n@@ -4447,6 +4458,7 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n         //\n         // Message: getdata (non-blocks)\n         //\n+        int64_t nNow = GetTimeMicros();\n         while (!pto->fDisconnect && !pto->mapAskFor.empty() && (*pto->mapAskFor.begin()).first <= nNow)\n         {\n             const CInv& inv = (*pto->mapAskFor.begin()).second;"
      },
      {
        "sha": "14a1b15cd6159bc5d85bef9948c40762014498e6",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 3,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/48474db015bc2462fe833d563947d02b9013be5e/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/48474db015bc2462fe833d563947d02b9013be5e/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=48474db015bc2462fe833d563947d02b9013be5e",
        "patch": "@@ -1509,7 +1509,7 @@ void static StartSync(const vector<CNode*> &vNodes) {\n         // check preconditions for allowing a sync\n         if (!pnode->fClient && !pnode->fOneShot &&\n             !pnode->fDisconnect && pnode->fSuccessfullyConnected &&\n-            (pnode->nStartingHeight > (nBestHeight - 144)) &&\n+            (pnode->nStartingHeight > nBestHeight) &&\n             (pnode->nVersion < NOBLKS_VERSION_START || pnode->nVersion >= NOBLKS_VERSION_END)) {\n             // if ok, compare node's score with the best so far\n             int64_t nScore = NodeSyncScore(pnode);\n@@ -1521,8 +1521,9 @@ void static StartSync(const vector<CNode*> &vNodes) {\n     }\n     // if a new sync candidate was found, start sync!\n     if (pnodeNewSync) {\n-        pnodeNewSync->fStartSync = true;\n         pnodeSync = pnodeNewSync;\n+        pnodeSync->fStartSync = true;\n+        LogPrint(\"net\", \"Setting peer=%d as syncnode.\\n\", pnodeSync->id);\n     }\n }\n \n@@ -1539,7 +1540,7 @@ void ThreadMessageHandler()\n             vNodesCopy = vNodes;\n             BOOST_FOREACH(CNode* pnode, vNodesCopy) {\n                 pnode->AddRef();\n-                if (pnode == pnodeSync)\n+                if (pnode == pnodeSync && (pnode->fStartSync || pnode->tGetblocks))\n                     fHaveSyncNode = true;\n             }\n         }"
      }
    ]
  },
  {
    "sha": "284fcfafc10c40ad1d59f69ea8427e8bc3c23615",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyODRmY2ZhZmMxMGM0MGFkMWQ1OWY2OWVhODQyN2U4YmMzYzIzNjE1",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-07-04T08:40:52Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-09-03T01:52:29Z"
      },
      "message": "Add commandline option for sync timeout",
      "tree": {
        "sha": "01b7fde601f203502b1b8e1b052e00316d71b143",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/01b7fde601f203502b1b8e1b052e00316d71b143"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/284fcfafc10c40ad1d59f69ea8427e8bc3c23615",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/284fcfafc10c40ad1d59f69ea8427e8bc3c23615",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/284fcfafc10c40ad1d59f69ea8427e8bc3c23615",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/284fcfafc10c40ad1d59f69ea8427e8bc3c23615/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "48474db015bc2462fe833d563947d02b9013be5e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/48474db015bc2462fe833d563947d02b9013be5e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/48474db015bc2462fe833d563947d02b9013be5e"
      }
    ],
    "stats": {
      "total": 18,
      "additions": 10,
      "deletions": 8
    },
    "files": [
      {
        "sha": "3938200c7114f05590c5a100eecb5580f91a68a7",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/284fcfafc10c40ad1d59f69ea8427e8bc3c23615/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/284fcfafc10c40ad1d59f69ea8427e8bc3c23615/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=284fcfafc10c40ad1d59f69ea8427e8bc3c23615",
        "patch": "@@ -239,6 +239,7 @@ std::string HelpMessage(HelpMessageMode mode)\n     strUsage += \"  -banscore=<n>          \" + _(\"Threshold for disconnecting misbehaving peers (default: 100)\") + \"\\n\";\n     strUsage += \"  -bantime=<n>           \" + _(\"Number of seconds to keep misbehaving peers from reconnecting (default: 86400)\") + \"\\n\";\n     strUsage += \"  -bind=<addr>           \" + _(\"Bind to given address and always listen on it. Use [host]:port notation for IPv6\") + \"\\n\";\n+    strUsage += \"  -synctimeout=<n>       \" + _(\"Specify block download timeout in seconds (default: 60)\") + \"\\n\";\n     strUsage += \"  -connect=<ip>          \" + _(\"Connect only to the specified node(s)\") + \"\\n\";\n     strUsage += \"  -discover              \" + _(\"Discover own IP address (default: 1 when listening and no -externalip)\") + \"\\n\";\n     strUsage += \"  -dns                   \" + _(\"Allow DNS lookups for -addnode, -seednode and -connect\") + \" \" + _(\"(default: 1)\") + \"\\n\";"
      },
      {
        "sha": "eab43aea206402e8c94a121837df0afdd052b3da",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 8,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/284fcfafc10c40ad1d59f69ea8427e8bc3c23615/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/284fcfafc10c40ad1d59f69ea8427e8bc3c23615/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=284fcfafc10c40ad1d59f69ea8427e8bc3c23615",
        "patch": "@@ -4409,27 +4409,28 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n \n         // Detect stalled peers.\n         int64_t tNow = GetTimeMillis();\n+        int nSyncTimeout = GetArg(\"-synctimeout\", 60);\n         if (pto->tGetblocks) {\n             if (pto->tBlockRecving > pto->tBlockRecved) {\n-                if (tNow-pto->tBlockRecving > BLOCK_DOWNLOAD_TIMEOUT * 1000) {\n+                if (tNow-pto->tBlockRecving > nSyncTimeout * 1000) {\n                     LogPrintf(\"sync peer=%d: Block download stalled for over %d seconds.\\n\",\n-                        pto->id, BLOCK_DOWNLOAD_TIMEOUT);\n+                        pto->id, nSyncTimeout);\n                     pto->fDisconnect = true;\n                 }\n-            } else if (pto->tGetblocks > pto->tBlockInvs && tNow-pto->tGetblocks > BLOCK_DOWNLOAD_TIMEOUT * 1000) {\n+            } else if (pto->tGetblocks > pto->tBlockInvs && tNow-pto->tGetblocks > nSyncTimeout * 1000) {\n                 LogPrintf(\"sync peer=%d: No invs of new blocks received within %d seconds.\\n\",\n-                    pto->id, BLOCK_DOWNLOAD_TIMEOUT);\n+                    pto->id, nSyncTimeout);\n                 pto->fDisconnect = true;\n-            } else if (!CaughtUp() && pto->tBlockRecved && tNow-pto->tBlockRecved > BLOCK_DOWNLOAD_TIMEOUT * 1000) {\n+            } else if (!CaughtUp() && pto->tBlockRecved && tNow-pto->tBlockRecved > nSyncTimeout * 1000) {\n                 LogPrintf(\"sync peer=%d: No block reception for over %d seconds.\\n\",\n-                    pto->id, BLOCK_DOWNLOAD_TIMEOUT);\n+                    pto->id, nSyncTimeout);\n                 if (state.nBlocksInFlight)\n                     pto->fDisconnect = true;\n                 else\n                     pto->tGetblocks = 0; // shouldn't ever get here\n-            } else if (pto->tGetdataBlock > pto->tBlockRecving && tNow-pto->tGetdataBlock > BLOCK_DOWNLOAD_TIMEOUT * 1000) {\n+            } else if (pto->tGetdataBlock > pto->tBlockRecving && tNow-pto->tGetdataBlock > nSyncTimeout * 1000) {\n                 LogPrintf(\"sync peer=%d: No block download started for over %d seconds.\\n\",\n-                    pto->id, BLOCK_DOWNLOAD_TIMEOUT);\n+                    pto->id, nSyncTimeout);\n                 pto->fDisconnect = true;\n             }\n         }"
      }
    ]
  },
  {
    "sha": "917aca9fb3fc7f5047bb583cb87428c1406592e5",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5MTdhY2E5ZmIzZmM3ZjUwNDdiYjU4M2NiODc0MjhjMTQwNjU5MmU1",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-06-27T12:29:04Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-09-03T01:52:30Z"
      },
      "message": "Rename MarkBlockAsReceived to MarkBlockAsRequested to reduce confusion.",
      "tree": {
        "sha": "3499ec015457ff5573f8112ec4b7d106986a2534",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3499ec015457ff5573f8112ec4b7d106986a2534"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/917aca9fb3fc7f5047bb583cb87428c1406592e5",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/917aca9fb3fc7f5047bb583cb87428c1406592e5",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/917aca9fb3fc7f5047bb583cb87428c1406592e5",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/917aca9fb3fc7f5047bb583cb87428c1406592e5/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "284fcfafc10c40ad1d59f69ea8427e8bc3c23615",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/284fcfafc10c40ad1d59f69ea8427e8bc3c23615",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/284fcfafc10c40ad1d59f69ea8427e8bc3c23615"
      }
    ],
    "stats": {
      "total": 6,
      "additions": 4,
      "deletions": 2
    },
    "files": [
      {
        "sha": "7b98d834c2d2ae811e7b40befeda48c81adb4c5a",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 2,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/917aca9fb3fc7f5047bb583cb87428c1406592e5/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/917aca9fb3fc7f5047bb583cb87428c1406592e5/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=917aca9fb3fc7f5047bb583cb87428c1406592e5",
        "patch": "@@ -269,15 +269,17 @@ void FinalizeNode(NodeId nodeid) {\n }\n \n // Requires cs_main.\n-void MarkBlockAsReceived(const uint256 &hash, NodeId nodeFrom = -1) {\n+void MarkBlockAsRequested(const uint256 &hash, NodeId nodeFrom = -1) {\n     map<uint256, pair<NodeId, list<uint256>::iterator> >::iterator itToDownload = mapBlocksToDownload.find(hash);\n     if (itToDownload != mapBlocksToDownload.end()) {\n         CNodeState *state = State(itToDownload->second.first);\n         state->vBlocksToDownload.erase(itToDownload->second.second);\n         state->nBlocksToDownload--;\n         mapBlocksToDownload.erase(itToDownload);\n     }\n+}\n \n+void MarkBlockAsReceived(const uint256 &hash, NodeId nodeFrom = -1) {\n     map<uint256, pair<NodeId, list<QueuedBlock>::iterator> >::iterator itInFlight = mapBlocksInFlight.find(hash);\n     if (itInFlight != mapBlocksInFlight.end()) {\n         CNodeState *state = State(itInFlight->second.first);\n@@ -312,7 +314,7 @@ void MarkBlockAsInFlight(NodeId nodeid, const uint256 &hash) {\n     assert(state != NULL);\n \n     // Make sure it's not listed somewhere already.\n-    MarkBlockAsReceived(hash);\n+    MarkBlockAsRequested(hash);\n \n     QueuedBlock newentry = {hash, GetTimeMicros(), state->nBlocksInFlight};\n     if (state->nBlocksInFlight == 0)"
      }
    ]
  },
  {
    "sha": "39e81660530f8784f6605aca7206a15a6407f9b2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozOWU4MTY2MDUzMGY4Nzg0ZjY2MDVhY2E3MjA2YTE1YTY0MDdmOWIy",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-06-26T18:06:13Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-09-03T01:52:30Z"
      },
      "message": "Show downloaded block size and time taken to download.",
      "tree": {
        "sha": "da560cb11dc7309ae8856e96339ef3e7aef42061",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/da560cb11dc7309ae8856e96339ef3e7aef42061"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/39e81660530f8784f6605aca7206a15a6407f9b2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/39e81660530f8784f6605aca7206a15a6407f9b2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/39e81660530f8784f6605aca7206a15a6407f9b2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/39e81660530f8784f6605aca7206a15a6407f9b2/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "917aca9fb3fc7f5047bb583cb87428c1406592e5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/917aca9fb3fc7f5047bb583cb87428c1406592e5",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/917aca9fb3fc7f5047bb583cb87428c1406592e5"
      }
    ],
    "stats": {
      "total": 10,
      "additions": 8,
      "deletions": 2
    },
    "files": [
      {
        "sha": "aa3a2a9a723d6b93deaeddb2a92aa1af2828e777",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 2,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/39e81660530f8784f6605aca7206a15a6407f9b2/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/39e81660530f8784f6605aca7206a15a6407f9b2/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=39e81660530f8784f6605aca7206a15a6407f9b2",
        "patch": "@@ -3842,14 +3842,20 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n     else if (strCommand == \"block\" && !fImporting && !fReindex) // Ignore blocks received while importing\n     {\n+        int size = vRecv.size();\n         CBlock block;\n         vRecv >> block;\n \n-        LogPrint(\"net\", \"received block %s peer=%d\\n\", block.GetHash().ToString(), pfrom->id);\n-\n         CInv inv(MSG_BLOCK, block.GetHash());\n         pfrom->AddInventoryKnown(inv);\n \n+        int timetodownload = GetTimeMillis() - State(pfrom->id)->nLastBlockReceive/1000;\n+        if (timetodownload > 1000)\n+            LogPrint(\"net\", \"received block %s (%u bytes, %us, %uB/s) peer=%d\\n\",\n+              inv.hash.ToString(), size, timetodownload / 1000, size * 1000 / timetodownload, pfrom->id);\n+        else\n+            LogPrint(\"net\", \"received block %s (%u bytes) peer=%d\\n\", inv.hash.ToString(), size, pfrom->id);\n+\n         {\n             LOCK(cs_main);\n             // Remember who we got this block from."
      }
    ]
  },
  {
    "sha": "cf203c45e2b2dadf74ec20494015680218dd5fa5",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjZjIwM2M0NWUyYjJkYWRmNzRlYzIwNDk0MDE1NjgwMjE4ZGQ1ZmE1",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-07-04T05:32:42Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-09-03T01:52:30Z"
      },
      "message": "Debug when a block is incoming and show how many blocks still to come.",
      "tree": {
        "sha": "02394ba85cf6dafaa9a62109e6eb809a294c8a22",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/02394ba85cf6dafaa9a62109e6eb809a294c8a22"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/cf203c45e2b2dadf74ec20494015680218dd5fa5",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/cf203c45e2b2dadf74ec20494015680218dd5fa5",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/cf203c45e2b2dadf74ec20494015680218dd5fa5",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/cf203c45e2b2dadf74ec20494015680218dd5fa5/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "39e81660530f8784f6605aca7206a15a6407f9b2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/39e81660530f8784f6605aca7206a15a6407f9b2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/39e81660530f8784f6605aca7206a15a6407f9b2"
      }
    ],
    "stats": {
      "total": 7,
      "additions": 6,
      "deletions": 1
    },
    "files": [
      {
        "sha": "b5cfaf06fb1eb04d9589c704b5e6b8fd893602ae",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 1,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/cf203c45e2b2dadf74ec20494015680218dd5fa5/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/cf203c45e2b2dadf74ec20494015680218dd5fa5/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=cf203c45e2b2dadf74ec20494015680218dd5fa5",
        "patch": "@@ -4156,8 +4156,13 @@ bool ProcessMessages(CNode* pfrom)\n         //            msg.complete() ? \"Y\" : \"N\");\n         if (msg.nDataPos != msg.nLastDataPos) {\n             if (strCommand == \"block\") {\n-                if (msg.nLastDataPos == 0)\n+                if (msg.nLastDataPos == 0) {\n                     pfrom->tBlockRecvStart = GetTimeMillis();\n+                    if (pfrom->tBlockRecved)\n+                        LogPrint(\"net\", \"%ums later, \", pfrom->tBlockRecvStart - pfrom->tBlockRecved);\n+                    LogPrint(\"net\", \"incoming block (%u bytes) (%d still to get, %d in flight) peer=%d\\n\",\n+                        nMessageSize, nBlocksToDownload, nBlocksInFlight, pfrom->id);\n+                }\n                 pfrom->tBlockRecving = GetTimeMillis();\n             }\n             msg.nLastDataPos = msg.nDataPos;"
      }
    ]
  }
]