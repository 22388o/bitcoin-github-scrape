[
  {
    "sha": "741f0177c53ae536801a67c8ec194d6be3505d2d",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3NDFmMDE3N2M1M2FlNTM2ODAxYTY3YzhlYzE5NGQ2YmUzNTA1ZDJk",
    "commit": {
      "author": {
        "name": "Evan Klitzke",
        "email": "evan@eklitzke.org",
        "date": "2018-03-05T19:24:12Z"
      },
      "committer": {
        "name": "Evan Klitzke",
        "email": "evan@eklitzke.org",
        "date": "2018-03-06T05:25:39Z"
      },
      "message": "Add DynamicMemoryUsage() to LevelDB\n\nThis adds a DynamicMemoryUsage() method similar to the existing methods\nof the same name, and adds logging of memory usage to\nCDBWrapper::WriteBatch.",
      "tree": {
        "sha": "78ede3487e47ecbce7c72b54e4d444d73d526afb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/78ede3487e47ecbce7c72b54e4d444d73d526afb"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/741f0177c53ae536801a67c8ec194d6be3505d2d",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/741f0177c53ae536801a67c8ec194d6be3505d2d",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/741f0177c53ae536801a67c8ec194d6be3505d2d",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/741f0177c53ae536801a67c8ec194d6be3505d2d/comments",
    "author": {
      "login": "eklitzke",
      "id": 2734,
      "node_id": "MDQ6VXNlcjI3MzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2734?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eklitzke",
      "html_url": "https://github.com/eklitzke",
      "followers_url": "https://api.github.com/users/eklitzke/followers",
      "following_url": "https://api.github.com/users/eklitzke/following{/other_user}",
      "gists_url": "https://api.github.com/users/eklitzke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eklitzke/subscriptions",
      "organizations_url": "https://api.github.com/users/eklitzke/orgs",
      "repos_url": "https://api.github.com/users/eklitzke/repos",
      "events_url": "https://api.github.com/users/eklitzke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eklitzke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "eklitzke",
      "id": 2734,
      "node_id": "MDQ6VXNlcjI3MzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2734?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eklitzke",
      "html_url": "https://github.com/eklitzke",
      "followers_url": "https://api.github.com/users/eklitzke/followers",
      "following_url": "https://api.github.com/users/eklitzke/following{/other_user}",
      "gists_url": "https://api.github.com/users/eklitzke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eklitzke/subscriptions",
      "organizations_url": "https://api.github.com/users/eklitzke/orgs",
      "repos_url": "https://api.github.com/users/eklitzke/repos",
      "events_url": "https://api.github.com/users/eklitzke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eklitzke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "47a7666dbe385cf138fa3cc0d48bb04507d11af2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/47a7666dbe385cf138fa3cc0d48bb04507d11af2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/47a7666dbe385cf138fa3cc0d48bb04507d11af2"
      }
    ],
    "stats": {
      "total": 26,
      "additions": 26,
      "deletions": 0
    },
    "files": [
      {
        "sha": "6cac625abc822b6b0b8b22d7966c2c9a264960a7",
        "filename": "src/dbwrapper.cpp",
        "status": "modified",
        "additions": 20,
        "deletions": 0,
        "changes": 20,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/741f0177c53ae536801a67c8ec194d6be3505d2d/src/dbwrapper.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/741f0177c53ae536801a67c8ec194d6be3505d2d/src/dbwrapper.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/dbwrapper.cpp?ref=741f0177c53ae536801a67c8ec194d6be3505d2d",
        "patch": "@@ -89,6 +89,7 @@ static leveldb::Options GetOptions(size_t nCacheSize)\n }\n \n CDBWrapper::CDBWrapper(const fs::path& path, size_t nCacheSize, bool fMemory, bool fWipe, bool obfuscate)\n+    : m_name(fs::basename(path))\n {\n     penv = nullptr;\n     readoptions.verify_checksums = true;\n@@ -155,11 +156,30 @@ CDBWrapper::~CDBWrapper()\n \n bool CDBWrapper::WriteBatch(CDBBatch& batch, bool fSync)\n {\n+    const bool log_memory = LogAcceptCategory(BCLog::LEVELDB);\n+    double mem_before = 0;\n+    if (log_memory) {\n+        mem_before = DynamicMemoryUsage() / 1024 / 1024;\n+    }\n     leveldb::Status status = pdb->Write(fSync ? syncoptions : writeoptions, &batch.batch);\n     dbwrapper_private::HandleError(status);\n+    if (log_memory) {\n+        double mem_after = DynamicMemoryUsage() / 1024 / 1024;\n+        LogPrint(BCLog::LEVELDB, \"WriteBatch memory usage: db=%s, before=%.1fMiB, after=%.1fMiB\\n\",\n+                 m_name, mem_before, mem_after);\n+    }\n     return true;\n }\n \n+size_t CDBWrapper::DynamicMemoryUsage() const {\n+    std::string memory;\n+    if (!pdb->GetProperty(\"leveldb.approximate-memory-usage\", &memory)) {\n+        LogPrint(BCLog::LEVELDB, \"Failed to get approximate-memory-usage property\\n\");\n+        return 0;\n+    }\n+    return stoul(memory);\n+}\n+\n // Prefixed with null character to avoid collisions with other keys\n //\n // We must use a string constructor which specifies length so that we copy"
      },
      {
        "sha": "6f80eedc7a4b235d127c6bf8dedb9461f4d7aa96",
        "filename": "src/dbwrapper.h",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/741f0177c53ae536801a67c8ec194d6be3505d2d/src/dbwrapper.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/741f0177c53ae536801a67c8ec194d6be3505d2d/src/dbwrapper.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/dbwrapper.h?ref=741f0177c53ae536801a67c8ec194d6be3505d2d",
        "patch": "@@ -198,6 +198,9 @@ class CDBWrapper\n     //! the database itself\n     leveldb::DB* pdb;\n \n+    //! the name of this database\n+    std::string m_name;\n+\n     //! a key used for optional XOR-obfuscation of the database\n     std::vector<unsigned char> obfuscate_key;\n \n@@ -284,6 +287,9 @@ class CDBWrapper\n \n     bool WriteBatch(CDBBatch& batch, bool fSync = false);\n \n+    // Get an estimate of LevelDB memory usage (in bytes).\n+    size_t DynamicMemoryUsage() const;\n+\n     // not available for LevelDB; provide for compatibility with BDB\n     bool Flush()\n     {"
      }
    ]
  }
]