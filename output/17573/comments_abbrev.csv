TheBlueMatt,2019-11-23 18:29:50,It was pointed out that this would make processing of small net messages particularly slower. Instead of only mixing in extra randomness for large net messages I switched it to SHA256 to use our existing ASM optimizations here. Also changed the fn name to be closer to the rest of random.h.,https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557821681,557821681,
sipa,2019-11-23 18:44:22,"A comment on including the timestamp: GetPerformanceCounter on ARM is not extremely cheap (it involves a system call), perhaps you'd want a way for the caller to provide their own timestamp (or timestamp-like variable), as I assume generally they already have one?",https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557822758,557822758,
TheBlueMatt,2019-11-23 18:48:04,"Hmm, net does have one, but its also mostly intended for things exactly like net, where you are handling an ""event"" that is the result of a syscall already...Unless its particularly more expensive than poll() + read(), I'm not too worried :). Its not like we're gonna call it somewhere where performance in nanoseconds is absolutely critical, though may be calling it in places where DoS is a risk. S",https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557823042,557823042,
sipa,2019-11-23 18:52:24,"I would indeed assume that it's not more expensive than poll+read, good point.",https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557823324,557823324,
sipa,2019-11-23 19:18:13,"Here is another idea: use the serialization-based interface, but instead feeding it directly into events_hasher, feed it into a SipHasher instead. Then feed a few bits (8, 16, 32?) of the SipHash of all passed data to events_hasher. That should be both simpler (no need to expose internals as much), and faster (much less SHA256'ing, don't hold lock as long).",https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557825163,557825163,
TheBlueMatt,2019-11-23 19:21:35,"Even simpler idea, just use the damn message hash instead of the command :). Its nice and small (4 bytes), plus has more entropy in it anyway. Since our (real) goal is to get the time when we receive a message, that's more than sufficient, but we also steal our peers' entropy in their ping nonces :).",https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557825437,557825437,
sipa,2019-11-23 20:27:07,Nice... if the caller has too much data they can always siphash or wahtever it thenselves. You could simplify the interface by just allowing a uint32_t to be passed or so.,https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557830190,557830190,
TheBlueMatt,2019-11-23 20:44:27,Done. Its now an explicit uint32_t.,https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557831281,557831281,
sipa,2019-11-23 21:51:00,utACK https://github.com/bitcoin/bitcoin/commit/02d8c56a18b9a2960888d6ec1209955105bae847,https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557836177,557836177,
DrahtBot,2019-11-23 22:22:20,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17167](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17167.html) (Allow whitelisting outgoing connections by ",https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557838189,557838189,
sipa,2019-11-23 22:27:03,"This effectively adds one SHA256 compression per 8 messages/connections. That seems acceptably low, compared to the work already done for message checksumming.",https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557838499,557838499,
TheBlueMatt,2019-11-24 17:30:52,"The AppVeyor build fail occurs before build even starts, so is a false positive.",https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557909882,557909882,
practicalswift,2019-11-25 00:02:08,Concept ACK: nice idea and straightforward implementation,https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557943444,557943444,
practicalswift,2019-11-25 00:11:58,Clang Thread Safety Analysis annotations seem to be missing? :),https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-557944329,557944329,
naumenkogs,2019-12-03 20:09:51,Concept ACK,https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-561335950,561335950,
laanwj,2019-12-04 12:12:23,ACK 02d8c56a18b9a2960888d6ec1209955105bae847,https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-561617435,561617435,
practicalswift,2019-12-04 13:22:09,"@laanwj I was a bit surprised to see this merged without thread safety annotations, or more specifically before the thread safety questions were addressed. Was there a reason for that? :)",https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-561643388,561643388,
laanwj,2019-12-04 13:39:00,"It has three ACKs and passes travis. \n\nIf you want to add any annotations, go ahead, but we're not going to block merges on always new requirements.",https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-561649548,561649548,
sipsorcery,2019-12-04 20:37:04,"This change is causing problems on Windows. No appveyor tests have passed since it was merged and I've also verified locally that  `bitcoind.exe`, `bitcoin-qt.exe`, `bench_bitcoin.exe` and `test_bitcoin.exe` are failing. Failing in this case means exiting almost immediately with no error message.\n\nRunning the programs in the Visual Studio debugger gets an `Access Violation` exception reported ",https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-561828251,561828251,
sipa,2019-12-04 20:39:59,"@sipsorcery I should have known that would happen; I suspect it is invoking the RNG before global initialization is complete, and thus potentially before events_mutex is initialized. Working on a fix.\n\nEDIT: see #17670.",https://github.com/bitcoin/bitcoin/pull/17573#issuecomment-561829305,561829305,
sipa,2019-11-23 17:00:07,"Do we expect the argument to always be a string? The interface could be made a bit simpler and safer if that's the case (you could also avoid the size_t prefix, and instead just write the c_str() including null byte, which self-describes the length).",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349880372,349880372,src/random.h
TheBlueMatt,2019-11-23 17:02:22,"I presume not, both for upcoming p2p encryption where the message type may just be a char, and I currently have some radio stuff hooked up that dumps RSSI information into this.",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349880432,349880432,src/random.h
sipa,2019-11-23 17:06:55,"If you'd abstract this code block out, and then call it from say both `SeedPeriodic` and `SeedSlow`, the additional entropy would always be available to strong RNG output, even if a minute has not yet passed. You could make the hashing step conditional on `events_hasher.Size() != 0`.",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349880600,349880600,src/random.cpp
laanwj,2019-11-23 17:23:13,"I kind of prefer this general (ptr,size) interface to using C strings, whose use we're generally trying to avoid in bitcoin code. `std::string_view` would be a safer interface, if only C++11 had it.",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349881230,349881230,src/random.h
TheBlueMatt,2019-11-23 18:03:06,"Hmm, you mean in SeedSlow Finalize the events_hasher, then write the buffer back into the events_hasher and have SeedPeriodic wipe it? Cause SeedSlow doesn't store the data back into the RNGState.",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349882703,349882703,src/random.cpp
sipa,2019-11-23 18:24:11,"Here is a more C++ish interface, that serializes (through the serialization framework) all arguments passed to SeedEvent (without any allocations): https://github.com/sipa/bitcoin/tree/bluematt_2019-11-rng-netmsg",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349883594,349883594,src/random.h
sipa,2019-11-23 18:26:01,"All the Seed* functions just add to a CSHA512; ultimately, they're all called from ProcRand, which mixes it with the existing RNGState, and produces output.\n\nSeedPeriodic goes a step further, in trying to make sure that the existing RNGState is also fed through the strengthener, but that isn't really required.\n\nSo just copying this code block to SeedSlow would work.",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349883668,349883668,src/random.cpp
TheBlueMatt,2019-11-23 18:28:02,"Oof, that's....quite a bigger diff. Are you worried about the current interface introducing bugs? I don't think it's particularly likely (nor are we likely to add calls to this *everywhere*), and it matches the rest of the random. interface.",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349883763,349883763,src/random.h
TheBlueMatt,2019-11-23 18:28:18,"Right, so I did this.",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349883770,349883770,src/random.cpp
sipa,2019-11-23 18:35:12,"If you switch to SHA256 (which you did) it's much smaller.\n\nIt also enables efficiently adding extra information without first copying everything into a buffer (say, you could call `SeedEvent(msg.command, peerid);` just as easily)\n\nI agree it's perhaps overkill - up to you.",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349884064,349884064,src/random.h
sipa,2019-11-23 18:37:19,"You could also limit this to 4 bytes (or even 2...), if size is an issue.",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349884165,349884165,src/random.cpp
sipa,2019-11-23 18:37:36,Nit: `uint32_t` is probably more appropriate ,https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349884174,349884174,src/random.cpp
TheBlueMatt,2019-11-23 18:43:41,"Hmm, I'm not too worried about it? Its mostly up to the caller and right now net will only ever pass in 12+4+8 bytes per call, which means it will never be more than one extra hash per two messages, which seems reasonable.",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349884427,349884427,src/random.cpp
sipa,2019-11-23 20:53:30,`ReadLE32(hash.begin())` ?,https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349889537,349889537,src/net.cpp
sipa,2019-11-23 21:02:04,This comment seems outdated now.,https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349889888,349889888,src/random.h
TheBlueMatt,2019-11-23 21:06:16,"Heh, I figured I'd leave it, since it doesn't actually matter what the 4 bytes are, they just have to be aligned and typed as a u32.",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349890024,349890024,src/random.h
sipa,2019-11-23 21:50:34,"Ha, neat.",https://github.com/bitcoin/bitcoin/pull/17573#discussion_r349891853,349891853,src/random.cpp
