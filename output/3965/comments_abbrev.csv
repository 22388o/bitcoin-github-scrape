theuni,2014-03-27T00:37:34Z,ping @sipa . I'm hoping this resembles what you had in mind.\n,https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-38757622,38757622,
jgarzik,2014-03-27T00:55:24Z,"Hum.  Wish you had pinged me.  Had this half-done already.  Oh well -- fully done is better than that.\n\nUntested, quick-review ACK.  This is the direction I was headed -- ScriptNum replaces BigNum.  Looks good to me.\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-38758577,38758577,
theuni,2014-03-27T02:24:27Z,"@jgarzik Ah, I didn't realize you were working on it. I've seen a few discussions lately about outside-access to script verification, and this seemed the logical place to start hacking toward that end.\n\nDo you have anything in the works regarding such libification? If so, I'd definitely prefer not to duplicate the work. Otherwise, I'll keep at it after a short detour for some build-system stuff.",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-38763014,38763014,
sipa,2014-03-27T05:21:31Z,"Oh, I (and others) have been talking about the idea of separating script evaluation (and later perhaps the whole of validation) into separate low-dependency libraries. I didn't expect such immediate progress towards that... sorry if that caused some duplicate work.\n\nApproach looks good to me, but this will require very careful inspection and testing.\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-38770077,38770077,
laanwj,2014-03-27T09:45:01Z,"Agree on the direction and code changes look good on first glace (though as @sipa says, as this affects consensus it will have to be thoroughly scrutinized).\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-38783747,38783747,
sipa,2014-03-29T16:33:57Z,"I think we want unit tests for CScriptNum, to ensure their compatibility with CBigNum.\n\nShouldn't be too hard I think; construct some random and non-random numbers (0, max, min, ...), do some operations on combinations of them, and compare the result with doing the same operation on CBigNum (and serialize/deserialize to vectors).\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-39000747,39000747,
theuni,2014-03-29T17:10:07Z,"@sipa Can't believe I didn't think of that, that's very obviously the correct way forward with this.\n\nGreat idea, will do.\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-39001915,39001915,
theuni,2014-03-31T02:28:32Z,"I threw in a few quick tests as @sipa suggested over the weekend, and there are some significant problems. I'll push up a fixed tomorrow.\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-39049310,39049310,
theuni,2014-04-01T05:25:22Z,"Updated, and pretty much rewritten. Lots of tests added, it now conforms to the previous usage of CBigNum as much as possible. See the note in 8ca9e9b about the usage differences.\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-39171967,39171967,
gavinandresen,2014-04-03T14:51:29Z,Code review ACK.\n\nI also tested to make sure the unit tests can fail (ran tests against a script.h with intentionally introduced bugs).\n,https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-39460384,39460384,
theuni,2014-04-03T20:52:07Z,"@gavinandresen thanks for the review. Your description above finally helped me put a finger on the overflow subtleties that had been bothering me, so I made a few more changes.\nThe nMaxNumValue/nMinNumValue were not enough to handle all overflow scenarios, so I split them into OperandValue/TotalValue. Also, the current (possibly overflown) value was not tested on subsequent math operations, so I ",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-39503334,39503334,
theuni,2014-04-03T23:06:34Z,"Mmm, there are still several details that aren't quite right here. Several tests need to be added for hitting the corner cases. Will keep at it.\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-39515885,39515885,
theuni,2014-04-04T03:50:29Z,"Ok, I really think that's everything now, sorry for all the wavering. Thanks to @gmaxwell for gently answering some dumb questions after the tunnel-vision set in.\n\n@gavinandresen I left some uglies in rather than force-pushing. No history before your comment has been rewritten.\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-39529517,39529517,
theuni,2014-04-04T07:01:19Z,"Testnet reindexed from scratch to height=208945 after the last set of changes, without issue.\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-39536970,39536970,
theuni,2014-04-04T22:20:05Z,"@maaku I have no idea where your comment went.. Github seems to have swallowed it somehow.\n\n```\nIn src/script.h:\nWhat about zero-padded bignums? These can be more than 4 bytes in length but still pass CastToBigNum()\n```\n\nWe no longer have a CBigNum cast, so there's no way to get a BigNum into a script directly.\nBut more importantly, see the previous behavior: https://github.com/bitcoin/bit",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-39617353,39617353,
maaku,2014-04-04T23:23:06Z,"Yeah, right after making that comment I figured I should double-check,\nand sure enough it matches the previous behavior. So I deleted the\ncomment, but I guess you got the notification email. Sorry to waste your\ntime with it.\n\nOn 04/04/2014 03:20 PM, Cory Fields wrote:\n\n> @maaku https://github.com/maaku I have no idea where your comment\n> went.. Github seems to have swallowed it somehow.\n>",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-39620916,39620916,
theuni,2014-04-04T23:29:17Z,"No worries, thanks for the review. Please point out anything you're unsure of, it's worth the few min it takes me to double-check. :)\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-39621193,39621193,
maaku,2014-04-05T22:19:24Z,"ACK.\n\nDuring the review the only part that had me worried was the `setvch()` and `serialize()` implementations, since that's a lot of new consensus-critical code. It looked correct but rather than trust my judgement I performed an exhaustive test of all possible (non-overflow) values. It only took 661m 35.921s to run:\n\n```\nBOOST_AUTO_TEST_CASE(scriptnum_i64_2)\n{\n    for (int64_t i  = CScrip",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-39652469,39652469,
gmaxwell,2014-04-17T07:59:34Z,"ACK (my comments about the inclusive/exclusive ranges being unclear in the comments, aside).\n\nI added 80 more script tests for areas of number handling that I thought were under-tested. All passed, I'll pullreq after this is merged so I don't conflict with it.  Maaku's tests were great though I had some concern that they didn't test the overflows, so I added a test for the byte-pattern a,x,x,x,b",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-40690226,40690226,
theuni,2014-04-17T10:17:31Z,"@gmaxwell Thanks for the thorough review. New test-cases are most welcome. If you'd like, I'd be more than happy to split this PR into two so that (your) test-cases can go in first, then the scriptnum changes. That way it's clear that the same cases passed before and after. Reconciling some conflicts is hardly a concern compared to the possibility of introducing a consensus change.\n\nAs for the d",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-40700123,40700123,
sipa,2014-04-17T10:41:11Z,"The code and the tests look very good.\n\nI have one suggested simplification. In the old code, the only place where bounds-checking was done (afaict) was in CastToBigNum, so when converting a byte vector to a number. I don't think there is any need for going beyond that in CScriptNum (where this logic moved to its constructor).\n\nThis means the operators themselves don't need bounds checking, an",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-40701692,40701692,
sipa,2014-04-17T10:48:09Z,"Hmm, I see the reasoning for wanting to be defensive about unexpectedly large values, as - even though conversion to CScriptNum is protected - you don't want overflows inside the int64_t type.\n\nSuch cases would not be script evaluation errors, though, just implementation errors. An assert should suffice, I think?\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-40702092,40702092,
theuni,2014-04-17T23:23:46Z,"@sipa: I've now written 4 responses to this and deleted them each in favor of doing more research... ultimately, I agree with you.\n\nAs-is, the only thing these operators protect from is something like:\n\n```\nCScript() << CScriptNum(nMaxOperandValue)+1;\n```\n\nWhich is incorrect 'protection', because that should be a valid operation.\n\nDoes anyone object to this change?\n\nAnyone disagree wit",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-40773579,40773579,
gmaxwell,2014-04-17T23:27:06Z,I agree with removing them. The additional boundary testing was what concerned me enough to go write a bunch of additional script tests.\n,https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-40773782,40773782,
luke-jr,2014-04-18T07:13:51Z,"Crazy idea: If we are potentially going to soft-fork script-upgrade in the near future, it might be worth considering just making the soft-fork remove any opcodes that have weird/complicated implementations if they're not in use...\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-40791619,40791619,
theuni,2014-04-18T21:48:36Z,"Cleaned up the operators as suggested by @sipa and @gmaxwell . Fixed the tests enough to build, but they need to be cleaned up to remove the old assumptions.\n\nIf you guys are reasonably happy with the way it looks, I'll cleanup and squash it down for further review (it's gotten pretty messy with all the fixups).\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-40847481,40847481,
sipa,2014-04-18T22:09:07Z,"ACK.\n\nI made a few nits inline, but looks good.\n\nCan you adapt the coding style, though?\n",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-40848900,40848900,
theuni,2014-04-22T04:40:05Z,Squashed down with the following changes:\n- rebased to master.\n- replaced busted overflow check with a good one (learned lots in the process).\n- added overflow check for operator-(int64_min)\n- cleaned up tests to match final constraints.\n- Matched coding style (I hope).\n\n@gmaxwell It would be much appreciated if you could run your additional script tests against the latest changes.\n,https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-41003318,41003318,
BitcoinPullTester,2014-04-22T05:21:26Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/b1fdd5475d9040445d7655730f262f214ea87c5f for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/cu",https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-41004866,41004866,
gmaxwell,2014-04-22T07:12:35Z,It indeed passes my additional tests. I've also started a full testnet resync and I'll give it another visual code review tomorrow.\n,https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-41010102,41010102,
sipa,2014-04-22T07:46:09Z,ACK.\n,https://github.com/bitcoin/bitcoin/pull/3965#issuecomment-41012311,41012311,
laanwj,2014-04-07T08:37:24Z,"Just to check: this minimum is correct?\nIt would be easy to make mistakes here, as in principle `-0x80000000` is the lowest representable value in a 32-bit int. The old `CastToBigNum` just checks the size of the vector so it doesn't tell me much.\n",https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11334851,11334851,src/script.h
maaku,2014-04-07T15:09:14Z,"Bignums have explicit sign bits, so `-0x80000000` requires five bytes to represent: `0000008080`.\n",https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11347763,11347763,src/script.h
theuni,2014-04-07T15:56:41Z,"@laanwj Note that the sizes are verified in the tests:\n\n```\n [""-2147483647"", ""0x04 0xFFFFFFFF EQUAL""],\n [""-2147483648"", ""0x05 0x0000008080 EQUAL""],\n```\n\nThat's confusing at first glance, but see what @maaku said above. -2147483647 is -0x7FFFFFFF, sent over the wire as 0xFFFFFFFF. So that's the minimum value of a 4-byte operand.\n\nI suppose it would be helpful to verify the operand bounds e",https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11350662,11350662,src/script.h
theuni,2014-04-07T16:12:37Z,"Just checked, and it's already covered in a few places. From existing tests:\nvalid:\n\n```\n[""2147483647 -2147483647 ADD"", ""0 EQUAL""]\n[""0 -2147483647 MIN"", ""-2147483647 NUMEQUAL""]\n[""0 -2147483647 MAX"", ""0 NUMEQUAL""]\n```\n\ninvalid:\n\n```\n[""-2147483648 0 ADD"", ""NOP"", ""arithmetic operands must be in range [-2^31...2^31] ""]\n[""-2147483648"", ""1ADD 1"", ""Because we use a sign bit, -2147483648 is a",https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11351466,11351466,src/script.h
sipa,2014-04-17T10:52:49Z,Nit: I think the actual maximum possible total value is 0x7FFFFFFFFELL.\n,https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11727170,11727170,src/script.h
theuni,2014-04-17T23:28:16Z,"Bound by which criteria? See the passing test:\n\n```\n[""549755813887"", ""SIZE 5 EQUAL""]\n```\n\nwhere 7FFFFFFFFF == 549755813887\n",https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11759096,11759096,src/script.h
gmaxwell,2014-04-17T23:33:28Z,Thats never a bignum in that example it's just a byte vector (and can be much larger than 5 bytes).\n,https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11759223,11759223,src/script.h
theuni,2014-04-17T23:48:47Z,"@gmaxwell Erm, I did a poor job with my point on that one.\n\nI was stating that 7FFFFFFFFF fits neatly into 5 bytes, as shown by '549755813887 SIZE 5 EQUAL', which is the criteria for nMaxTotalValue.\n",https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11759604,11759604,src/script.h
maaku,2014-04-18T00:16:47Z,"Try `9223372036854775807 SIZE 8 EQUAL` -- you'll find it passes too. In this script the number is never treated as a bignum, so it never gets range checked.\n\nThe correct, most restrictive limit is `0xfffffffe == 0x7fffffff + 0x7fffffff`, but as far as I can tell it doesn't affect consensus code.\n",https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11760258,11760258,src/script.h
theuni,2014-04-18T00:23:47Z,"@maaku I considered 0xfffffffe, but decided against assuming that other operators wouldn't be re-enabled/added in the future. The 5byte boundary is the only constraint for consideration here, no?\n",https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11760391,11760391,src/script.h
maaku,2014-04-18T00:35:02Z,"The disabled opcodes cannot be re-enabled in the future. I'm not sure why the 5 byte boundary matters here? If you re-enabled OP_MUL, for example, you could certainly do `0x7fffffff * 0x7fffffff == 0x3fffffff00000001` (eight bytes).\n",https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11760603,11760603,src/script.h
sipa,2014-04-18T11:34:25Z,"I should not have made this comment, it's immaterial.\n\nThere is no range limit on the values of operands. There is only a size limit on which byte vectors can be converted to integers.\n\nHow about:\n- Only the CScriptNum constructor check the vector size (if arg.size() > 4 throw scripnum_error).\n- The + and - operators get an assertion that prevents int64 overflows.\n\nI think that should be a",https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11769589,11769589,src/script.h
sipa,2014-04-18T22:06:38Z,"This seems to imply that there usually is a range checking when serializing. AFAIK, that is never the case.\n",https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11788796,11788796,src/script.h
sipa,2014-04-18T22:07:34Z,"These can move to the unit tests now, I think.\n",https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11788812,11788812,src/script.h
sipa,2014-04-22T07:42:08Z,"This comment is not wrong, but misleading. An input 0x0000000000 would be rejected, even though it is within that range.\n",https://github.com/bitcoin/bitcoin/pull/3965#discussion_r11841454,11841454,src/script.h
