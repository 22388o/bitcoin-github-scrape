[
  {
    "sha": "bcb40f3dc31aed92505cd8d4cbce5fdc04898f36",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiY2I0MGYzZGMzMWFlZDkyNTA1Y2Q4ZDRjYmNlNWZkYzA0ODk4ZjM2",
    "commit": {
      "author": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2020-10-20T06:28:56Z"
      },
      "committer": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2020-10-20T06:58:21Z"
      },
      "message": "AttemptToEvictConnection: identify onions using m_inbound_onion",
      "tree": {
        "sha": "dd82912685226e9920ad69fae7710b6eb7c47024",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/dd82912685226e9920ad69fae7710b6eb7c47024"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bcb40f3dc31aed92505cd8d4cbce5fdc04898f36",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEd6u7+MhX7zEv6RP5T1chs9Djkh0FAl+OipsACgkQT1chs9Dj\nkh3fZg/9ECbmE6Ke9k3LHgaHOo8JO4K4e6+QgG7Rs4i7Zi8trpASadJWYActm0nO\n6gIt4ZJEQb8RZMFxLT4VzSjOGjUm44REN07U7yoksh47Du5F66FmPiv+JlDuHbRQ\n7YT5juJnBHJIivBxOvo5nN1LkrGeudWicALlX6x4RaIMKz4Vhy+nhKPTOd+RAt4q\niReXnThn8pi+LDSvB9QMhu0jTJm8c/dpL93p4FXklxjaeFXMVYohicoP8PIc2jWT\nE6WjdWznCc5pyoLOmlvQl8FObaeiaB6YYaMFbSWtgTnhBvTAr4a5W/iRvcyGekqW\noksE332igkVOh4X8rsvbhFmAP0jRFVCFrdxHypzLWCIFIjU0i0ng1Ux0RoQsMVBN\nSKJXbS8W97U3qWZdnJ9TtJ2EWdYB0cMPAyPheBa5krTtcx0uGTblksKGkqcRlwtv\n0H/DmUbGMizgwamJm/Nn6HVmrgvhnZ1oQNQYttYVwMnqEvv7SEYzMPIdbVd0Un/r\nPSi09xGKrtbe8y/jhSHE2093pM4FsV03baoxCblAWhTfDCwCd5YTevANRWOOU9YQ\n+GHALE5jTBIGLdI9P4mjxNwpq4XH9vZjwlYhTHMewJ/Uunwust61/NPRECfQzHGs\nGrKPzGG8tkP/bXnL8wGRGNbOIUydLqiP2CWF0JYIqckLlfL2vKQ=\n=1h3+\n-----END PGP SIGNATURE-----\n-----BEGIN OPENTIMESTAMPS GIT TIMESTAMP-----\n\nAQHwIGu4suoDv/4ktdGyIqyh32aIrmtCnLXg2IbVFPddBtaSCP/wEBKennLn+0x8\nnDJjvoveRzcI8QRfjoqd8AjeMuj6LEas5wCD3+MNLvkMjiMiaHR0cHM6Ly9idGMu\nY2FsZW5kYXIuY2F0YWxsYXh5LmNvbf/wEFtLhvgP5hstXhAbjhux2UII8QRfjoqc\n8AhTPlEI47a2lQCD3+MNLvkMjiwraHR0cHM6Ly9ib2IuYnRjLmNhbGVuZGFyLm9w\nZW50aW1lc3RhbXBzLm9yZ//wEL+8wdVk1iQpO/sMfMQXdT4I8QRfjoqd8Aia920h\nGCcgtwCD3+MNLvkMji4taHR0cHM6Ly9hbGljZS5idGMuY2FsZW5kYXIub3BlbnRp\nbWVzdGFtcHMub3Jn8BD+CiyNXXDkIsNhoY4U7GeoCPEEX46KnvAIohVHuL3sotwA\ng9/jDS75DI4pKGh0dHBzOi8vZmlubmV5LmNhbGVuZGFyLmV0ZXJuaXR5d2FsbC5j\nb20=\n-----END OPENTIMESTAMPS GIT TIMESTAMP-----",
        "payload": "tree dd82912685226e9920ad69fae7710b6eb7c47024\nparent f5bd46a4cc6d395ce71ecb99852c1774235a249c\nauthor Jon Atack <jon@atack.com> 1603175336 +0200\ncommitter Jon Atack <jon@atack.com> 1603177101 +0200\n\nAttemptToEvictConnection: identify onions using m_inbound_onion\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bcb40f3dc31aed92505cd8d4cbce5fdc04898f36",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/bcb40f3dc31aed92505cd8d4cbce5fdc04898f36",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bcb40f3dc31aed92505cd8d4cbce5fdc04898f36/comments",
    "author": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f5bd46a4cc6d395ce71ecb99852c1774235a249c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f5bd46a4cc6d395ce71ecb99852c1774235a249c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f5bd46a4cc6d395ce71ecb99852c1774235a249c"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 1,
      "deletions": 1
    },
    "files": [
      {
        "sha": "73fd6b60044cbe17b4bf5fab0a6b7960e2e8ff5c",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/bcb40f3dc31aed92505cd8d4cbce5fdc04898f36/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/bcb40f3dc31aed92505cd8d4cbce5fdc04898f36/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=bcb40f3dc31aed92505cd8d4cbce5fdc04898f36",
        "patch": "@@ -951,7 +951,7 @@ bool CConnman::AttemptToEvictConnection()\n                                                node->nLastBlockTime, node->nLastTXTime,\n                                                HasAllDesirableServiceFlags(node->nServices),\n                                                peer_relay_txes, peer_filter_not_null, node->addr, node->nKeyedNetGroup,\n-                                               node->m_prefer_evict, node->addr.IsLocal()};\n+                                               node->m_prefer_evict, node->m_inbound_onion};\n             vEvictionCandidates.push_back(candidate);\n         }\n     }"
      }
    ]
  },
  {
    "sha": "e48f150de010af2f2453e724bd51fa17bc2180d7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplNDhmMTUwZGUwMTBhZjJmMjQ1M2U3MjRiZDUxZmExN2JjMjE4MGQ3",
    "commit": {
      "author": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2020-10-20T06:27:17Z"
      },
      "committer": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2020-10-20T06:58:37Z"
      },
      "message": "AttemptToEvictConnection: update method/variable naming, documentation\n\nfrom local/localhost to onion",
      "tree": {
        "sha": "e4197c7ec25dacadbdc3909f2475b861b44f45d1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e4197c7ec25dacadbdc3909f2475b861b44f45d1"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e48f150de010af2f2453e724bd51fa17bc2180d7",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEd6u7+MhX7zEv6RP5T1chs9Djkh0FAl+Oip0ACgkQT1chs9Dj\nkh2mDQ/7Byt2+lzwuozXaAyJII302nwdeeNE4HCYUPAAtuoUcEmpA/TwC9kLNZN/\n8OPyZheWmdferpg4DRJNHRujpd8F75GoMZnAEUbWuXrPeTJw0XVpAB00DRKofQrm\nVETMP5SWuH3Fiug35bOycWErXLR3nsSIgz5uI6Z+nhrD17optOCAOTnnUPH1FzqD\n0NLZC7No9eV3LmnKf7h9WlkHyFKU9G+WerKhmFefHIKsVpNCY05sVdlBUaB1BA0x\n4EjWcF48b8BKZewUf43SI53MQCk9e73z4U5/fldZnhHDuH2yBYFNB0YvsmuL84rS\njky9oQBCehMY3I5z9QwIZ3tUlM1yUd6ZmeSTYNZjqhsFYS1vrR++okPoGliP4bgL\n901/NTDafoomIgWCJSKYkibXZajukukFxSJjAYWtGhvVX69ebtGVTEHh/VZf+bZ5\nO6S3yiudgPfX5gKhF2UuSt+uGRRitaSFKC4nWpH/pgdxwLnRP7rUcMKKP/bJi2Tp\nIST8Ihqv9tEO/mQrez5cB4e49QBNhJidN1JYM/+PQvWdbzbdQJnqVahEy6Rtmz7h\nUfWklXyz2GMk2lnaA3jf3CfCA7B3srX3nUJvvwqYR2eFz6qC76dcaenodmicUVE+\n+ecEo+xr2W8VLgnxGjzcCzWfu62R1uWljXM1K8BEu6HWaV1Sw90=\n=4T8N\n-----END PGP SIGNATURE-----\n-----BEGIN OPENTIMESTAMPS GIT TIMESTAMP-----\n\nAQHwINeKVwrais/hxDG/f1zSRCDK82Q1tFgNiog5d8DkiBvFCP/wED/8ZwzBfiB6\nL9HKFONta90I8QRfjoqf8AjOfvGyNK2+rgCD3+MNLvkMjiMiaHR0cHM6Ly9idGMu\nY2FsZW5kYXIuY2F0YWxsYXh5LmNvbf/wELeFLKtrEdd+5M0BtElnK7EI8QRfjoqf\n8AhoWZiXgo6adwCD3+MNLvkMji4taHR0cHM6Ly9hbGljZS5idGMuY2FsZW5kYXIu\nb3BlbnRpbWVzdGFtcHMub3Jn//AQuMQlPiDOSTQNJg2U6IYL6QjwIL/6SgsYxlXp\n5MQIDyaYIcJFVAxU8qXVTSAEp6gnJhZPCPEEX46KofAIODMFIGsb6JwAg9/jDS75\nDI4pKGh0dHBzOi8vZmlubmV5LmNhbGVuZGFyLmV0ZXJuaXR5d2FsbC5jb23wEL0s\nfkfOSPTelmUwADCbvtoI8CCUDC+D+YVN3irEW2VPQtr6xegJiLcR9SaAQ3lGNbIl\nrwjxBF+Oip/wCOhfsUJob/DOAIPf4w0u+QyOLCtodHRwczovL2JvYi5idGMuY2Fs\nZW5kYXIub3BlbnRpbWVzdGFtcHMub3Jn\n-----END OPENTIMESTAMPS GIT TIMESTAMP-----",
        "payload": "tree e4197c7ec25dacadbdc3909f2475b861b44f45d1\nparent bcb40f3dc31aed92505cd8d4cbce5fdc04898f36\nauthor Jon Atack <jon@atack.com> 1603175237 +0200\ncommitter Jon Atack <jon@atack.com> 1603177117 +0200\n\nAttemptToEvictConnection: update method/variable naming, documentation\n\nfrom local/localhost to onion\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e48f150de010af2f2453e724bd51fa17bc2180d7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e48f150de010af2f2453e724bd51fa17bc2180d7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e48f150de010af2f2453e724bd51fa17bc2180d7/comments",
    "author": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "bcb40f3dc31aed92505cd8d4cbce5fdc04898f36",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bcb40f3dc31aed92505cd8d4cbce5fdc04898f36",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/bcb40f3dc31aed92505cd8d4cbce5fdc04898f36"
      }
    ],
    "stats": {
      "total": 19,
      "additions": 9,
      "deletions": 10
    },
    "files": [
      {
        "sha": "2f2418109ac5c61a517aaf1f05cd9c2baa7dd9f5",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 10,
        "changes": 19,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e48f150de010af2f2453e724bd51fa17bc2180d7/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e48f150de010af2f2453e724bd51fa17bc2180d7/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=e48f150de010af2f2453e724bd51fa17bc2180d7",
        "patch": "@@ -861,7 +861,7 @@ struct NodeEvictionCandidate\n     CAddress addr;\n     uint64_t nKeyedNetGroup;\n     bool prefer_evict;\n-    bool m_is_local;\n+    bool m_is_onion;\n };\n \n static bool ReverseCompareNodeMinPingTime(const NodeEvictionCandidate &a, const NodeEvictionCandidate &b)\n@@ -874,9 +874,9 @@ static bool ReverseCompareNodeTimeConnected(const NodeEvictionCandidate &a, cons\n     return a.nTimeConnected > b.nTimeConnected;\n }\n \n-static bool CompareLocalHostTimeConnected(const NodeEvictionCandidate &a, const NodeEvictionCandidate &b)\n+static bool CompareOnionTimeConnected(const NodeEvictionCandidate &a, const NodeEvictionCandidate &b)\n {\n-    if (a.m_is_local != b.m_is_local) return b.m_is_local;\n+    if (a.m_is_onion != b.m_is_onion) return b.m_is_onion;\n     return a.nTimeConnected > b.nTimeConnected;\n }\n \n@@ -978,16 +978,15 @@ bool CConnman::AttemptToEvictConnection()\n \n     // Protect the half of the remaining nodes which have been connected the longest.\n     // This replicates the non-eviction implicit behavior, and precludes attacks that start later.\n-    // Reserve half of these protected spots for localhost peers, even if\n-    // they're not longest-uptime overall. This helps protect tor peers, which\n-    // tend to be otherwise disadvantaged under our eviction criteria.\n+    // Reserve half of these protected spots for tor onion peers, even if they do not have the longest\n+    // uptime overall, as they tend to be otherwise disadvantaged under our eviction criteria.\n     size_t initial_size = vEvictionCandidates.size();\n     size_t total_protect_size = initial_size / 2;\n \n-    // Pick out up to 1/4 peers that are localhost, sorted by longest uptime.\n-    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareLocalHostTimeConnected);\n-    size_t local_erase_size = total_protect_size / 2;\n-    vEvictionCandidates.erase(std::remove_if(vEvictionCandidates.end() - local_erase_size, vEvictionCandidates.end(), [](NodeEvictionCandidate const &n) { return n.m_is_local; }), vEvictionCandidates.end());\n+    // Pick out up to 1/4 peers that are connected via our tor onion service, sorted by longest uptime.\n+    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), CompareOnionTimeConnected);\n+    size_t onion_erase_size = total_protect_size / 2;\n+    vEvictionCandidates.erase(std::remove_if(vEvictionCandidates.end() - onion_erase_size, vEvictionCandidates.end(), [](NodeEvictionCandidate const &n) { return n.m_is_onion; }), vEvictionCandidates.end());\n     // Calculate how many we removed, and update our total number of peers that\n     // we want to protect based on uptime accordingly.\n     total_protect_size -= initial_size - vEvictionCandidates.size();"
      }
    ]
  }
]