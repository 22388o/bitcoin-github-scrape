laanwj,2014-06-24T12:44:05Z,"I like this idea!\nIt makes dependency on OpenSSL[for randomness] less widespread, and focused on a single place where it could easier be swapped out.\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-46965763,46965763,
theuni,2014-06-24T14:27:59Z,"Agreed. I'd like it even more if it were moved out of util and into a new file, so that util would drop that dependency.\n\nI should think that a simple RAII class for seeding and teardown would be pretty easy to whip up?\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-46977847,46977847,
laanwj,2014-06-24T14:38:44Z,"What do you mean with a RAII class for seeding and teardown? Isn't that global state, not local state?\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-46979294,46979294,
theuni,2014-06-24T17:54:07Z,"@laanwj Yes openssl's rand stuff is global, but others may not be. And it doesn't hurt to scope, so that we know it's always seeded and valid. But don't worry about it here, we can discuss that later/elsewhere.\n\nMy request to have it moved to another file still stands, though.\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47005880,47005880,
laanwj,2014-06-25T10:27:19Z,"@theuni So to be concrete, to introduce a random.cpp + random.h? Agreed on that. All the Rand\* functions could move there.\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47084308,47084308,
sipa,2014-06-25T10:52:18Z,How about putting that in crypto/?\n,https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47086604,47086604,
laanwj,2014-06-25T11:02:27Z,"I thought about that, but didn't propose it, that would make crypto dependent on OpenSSL :p\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47087417,47087417,
theuni,2014-06-25T16:45:06Z,"@laanwj Yes, that's what I had in mind.\n\n-1 to moving to crypto. crypto stands alone with no dependencies, this doesn't seem like a good enough reason to change that.\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47127960,47127960,
Diapolo,2014-06-26T11:40:03Z,"Agreed, I'll rework this and move RandXYZ() from util to a new random.\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47215544,47215544,
Diapolo,2014-06-26T12:46:56Z,"@laanwj @theuni I moved the rand functions from util to new random.h/.cpp, can you check?\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47220852,47220852,
jgarzik,2014-06-26T13:53:29Z,"Bonus points:  most of the uses involve vector<unsigned char>.  It would be nice to have a wrapper or two to provide type-safe interfaces, permitting\n\n```\n    vector<unsigned char> v;\n    GetRandBytes(v, 32);\nversus\n    vector<unsigned char> v;\n    GetRandBytes(&v[0], 32);\n```\n\nLess margin for error.\n\nSmarter types permit better safety checks.  If you pass in a vector, you may check .s",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47227961,47227961,
laanwj,2014-06-26T14:08:16Z,"I agree that is useful to do in the future, But I think we should keep the scope of this pull down to the code movement and a trivial wrapper.\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47229775,47229775,
Diapolo,2014-06-27T07:15:04Z,"@laanwj Rebased after the recent change to `RandAddSeedPerfmon()`, can you test?\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47314395,47314395,
Diapolo,2014-06-27T08:58:31Z,"Added required changes to `canonical_tests.cpp`, which I forgot...\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47322040,47322040,
Diapolo,2014-06-27T09:11:25Z,Fixed `crypto_tests.cpp`.\n,https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47323101,47323101,
Diapolo,2014-06-30T06:29:00Z,"@laanwj See third commit, `GetPerformanceCounter()` was moved.\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47498593,47498593,
Diapolo,2014-06-30T12:45:55Z,"@laanwj I rebased, so that we have only 2 commits left. Last and only change was the check for `-1` from `RAND_bytes()`. Also needed to add changes to skiplist_test.cpp.\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47526883,47526883,
Diapolo,2014-07-02T10:21:24Z,"@laanwj Perhaps you can also help me find files, which could now also work without util.h.\n@sipa @gmaxwell @gavinandresen @jgarzik Can you also help testing and reviewing.\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-47759584,47759584,
Diapolo,2014-07-07T06:13:12Z,Any more testing done yet?\n,https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-48144107,48144107,
laanwj,2014-07-07T08:27:32Z,This mostly needs code review. Testing is also great (I'm using these changes on my (walletless) nodes) but changes to randomness aren't very well testable.\nI'd feel better if at least one more person could take a thorough look at this.\n,https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-48152308,48152308,
BitcoinPullTester,2014-07-09T08:29:22Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4400_4eedf4ffeea6a3734f245f785a8d82d69634dccd/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-te",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-48442880,48442880,
gmaxwell,2014-07-14T11:02:47Z,"Sorry for the late comments but:\n\n"" if (RAND_bytes(buf, num) == 0) ""\n\nMy manpage here says ""RAND_bytes() returns 1 on success, 0 otherwise. The error code can be obtained by ERR_get_error(3). RAND_pseudo_bytes() returns 1 if the bytes generated are\n       cryptographically strong, 0 otherwise. Both functions return -1 if they are not supported by the current RAND method.""\n\nShouldn't we best",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-48887703,48887703,
laanwj,2014-07-14T11:07:46Z,"We already check against 1: `RAND_bytes(buf, num) != 1`\n(I had the same comment)\n\nNot sure about asserting on failure, returning failures to the caller is already a big leap from what we used to do: ignore failures.\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-48888027,48888027,
gmaxwell,2014-07-14T11:35:02Z,"Sorry, I was reading the actual commits in order out of git and missed it in the pull. I can't think of any case we'd not like to fail, and a failure of the RNG can be a fatal total loss of security.\n",https://github.com/bitcoin/bitcoin/pull/4400#issuecomment-48889943,48889943,
Diapolo,2014-06-26T12:51:52Z,This will be removed in the next rebase!\n,https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14237980,14237980,src/util.cpp
Diapolo,2014-06-26T13:14:18Z,"I'm going to remove the `""rand""` in the next rebase as this seems important to log!\n",https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14238983,14238983,src/random.cpp
laanwj,2014-06-26T13:16:26Z,Agreed!\n,https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14239066,14239066,src/random.cpp
theuni,2014-06-27T16:20:14Z,This re-adds the dependency that we were breaking.\n,https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14301204,14301204,src/random.cpp
laanwj,2014-06-27T16:55:38Z,What dependency? How do you mean?\nI don't think we can avoid an util.cpp-random.cpp cross-dependency unless we split up util.cpp further into a logging part and the part-that-uses-random...\n,https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14302807,14302807,src/random.cpp
theuni,2014-06-27T17:12:40Z,"I don't see any reason for stand-alone helper functions to be using program state and internal functions. For example:\n\n```\nbool GetRandBytes(unsigned char *buf, int num)\n```\n\nshould become\n\n```\nbool GetRandBytes(unsigned char *buf, int num, std::string& error)\n```\n\nThen the caller decides how to handle it, in this case using LogPrintf() if the result is false;\n\nIgnore my complaint f",https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14303644,14303644,src/random.cpp
laanwj,2014-06-27T20:01:41Z,I don't like returning an error/warning string from a low-level utility\nfunction. That just moves the burden to every caller site. IMO the function\nshould be allowed to log if necessary.\n,https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14312392,14312392,src/random.cpp
Diapolo,2014-06-27T21:11:53Z,"I also think it complicates things, if we just return an error an let the caller decide what to do. The dependency we broke is that we don't need the OpenSSL rand.h in util.h (+ many others) and can replace OpenSSL rand.h in random.h by something better in the future. I also think logging is THAT basic, that every file should be able to do that. I have been thinking about a better place for the Op",https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14315534,14315534,src/random.cpp
laanwj,2014-06-28T06:17:27Z,BTW; this function can be moved to the implementation file and made static. It's only used in random seeding.\nI think this means that the header doesn't need to include compat.h and time.h anymore.\n,https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14322828,14322828,src/random.h
Diapolo,2014-06-30T06:04:07Z,"Guess you are right, will update later...\n",https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14336853,14336853,src/random.h
laanwj,2014-06-30T06:15:19Z,"Util.cpp no longer needs random.h after this, right?\n",https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14337037,14337037,src/util.cpp
Diapolo,2014-06-30T06:17:39Z,"The problem is the OpenSSL init code, which uses `RandAddSeed()`.\n",https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14337090,14337090,src/util.cpp
laanwj,2014-06-30T07:00:17Z,"Ah yes, we need to move the OpenSSL init code at some point, you already mentioned that sorry.\n",https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14337826,14337826,src/util.cpp
laanwj,2014-06-30T07:01:24Z,+1 on checking error return values here\n,https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14337851,14337851,src/wallet.cpp
laanwj,2014-06-30T07:06:29Z,"Bleh that we need this here at all (I know why, there's a GetRand call in EndMessage(), at some point we should move the non-trivial functions from net.h to net.cpp, but not in this pull)\n",https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14337954,14337954,src/net.h
laanwj,2014-06-30T07:09:07Z,The function can also return `-1` if `they are not supported by the current RAND method` (see https://www.openssl.org/docs/crypto/RAND_bytes.html). So I'd prefer `!= 1` instead to explicitly check for succes instead of not failure.\n,https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14338000,14338000,src/random.cpp
Diapolo,2014-06-30T12:41:30Z,"Agreed, will update.\nEdit: Updated!\n",https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14347572,14347572,src/random.cpp
Diapolo,2014-07-01T11:22:17Z,"We could use `OPENSSL_cleanse()` here and remove the cstring include I guess. Not sure if a secure erase is needed here, but we also do that when adding the performance data as entropy source.\n",https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14398649,14398649,src/random.cpp
laanwj,2014-07-01T11:43:45Z,"That would be consistent, but no need to do it in this pull, let's leave code movements and functional changes separate.\n",https://github.com/bitcoin/bitcoin/pull/4400#discussion_r14399305,14399305,src/random.cpp
