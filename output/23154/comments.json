[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/951379201",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#issuecomment-951379201",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23154",
    "id": 951379201,
    "node_id": "IC_kwDOABII5844tOUB",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-25T22:22:59Z",
    "updated_at": "2021-10-25T22:22:59Z",
    "author_association": "MEMBER",
    "body": "ACK 9ab4401",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/951379201/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/951663883",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#issuecomment-951663883",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23154",
    "id": 951663883,
    "node_id": "IC_kwDOABII5844uT0L",
    "user": {
      "login": "naumenkogs",
      "id": 7975071,
      "node_id": "MDQ6VXNlcjc5NzUwNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7975071?u=06eb9ae4f9b3f954056098860decccbf1340e40f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naumenkogs",
      "html_url": "https://github.com/naumenkogs",
      "followers_url": "https://api.github.com/users/naumenkogs/followers",
      "following_url": "https://api.github.com/users/naumenkogs/following{/other_user}",
      "gists_url": "https://api.github.com/users/naumenkogs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
      "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
      "repos_url": "https://api.github.com/users/naumenkogs/repos",
      "events_url": "https://api.github.com/users/naumenkogs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-26T08:03:31Z",
    "updated_at": "2021-10-26T08:03:31Z",
    "author_association": "MEMBER",
    "body": "ACK 9ab4401",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/951663883/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/954764775",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#issuecomment-954764775",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23154",
    "id": 954764775,
    "node_id": "IC_kwDOABII58446I3n",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-29T13:55:28Z",
    "updated_at": "2021-10-29T13:55:28Z",
    "author_association": "MEMBER",
    "body": "Anything left to do here? Seems like a pretty low-risk merge given it's just doc.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/954764775/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/954792624",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#issuecomment-954792624",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23154",
    "id": 954792624,
    "node_id": "IC_kwDOABII58446Pqw",
    "user": {
      "login": "michaelfolkson",
      "id": 16323900,
      "node_id": "MDQ6VXNlcjE2MzIzOTAw",
      "avatar_url": "https://avatars.githubusercontent.com/u/16323900?u=e2201a78ad660e42fd175003d02ad749b855e0a9&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelfolkson",
      "html_url": "https://github.com/michaelfolkson",
      "followers_url": "https://api.github.com/users/michaelfolkson/followers",
      "following_url": "https://api.github.com/users/michaelfolkson/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelfolkson/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelfolkson/orgs",
      "repos_url": "https://api.github.com/users/michaelfolkson/repos",
      "events_url": "https://api.github.com/users/michaelfolkson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelfolkson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-29T14:31:11Z",
    "updated_at": "2021-10-29T14:44:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "ACK 9ab440199d5c888363a42c957433d0e46cd0d2ff\r\n\r\nAgree this is a low risk merge. To be really finicky maybe a new standalone doc for any project should only be merged once the project is completed (fully merged) and functional. But it can obviously be easily be reverted if for some reason the project wasn't completed/fully merged.\r\n\r\nedit: I do think docs and future GUI changes will be important for AssumeUTXO on completion (assuming it is fully merged). How it should be used, what is encouraged, what warnings are displayed to the user etc. We do (imo) want to do everything that we can to ensure the user does full IBD from genesis in the background rather than skipping it and is aware of the risks of sending or receiving funds before full IBD has completed. But that discussion is for later.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/954792624/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/958974768",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#issuecomment-958974768",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23154",
    "id": 958974768,
    "node_id": "IC_kwDOABII5845KMsw",
    "user": {
      "login": "michaelfolkson",
      "id": 16323900,
      "node_id": "MDQ6VXNlcjE2MzIzOTAw",
      "avatar_url": "https://avatars.githubusercontent.com/u/16323900?u=e2201a78ad660e42fd175003d02ad749b855e0a9&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelfolkson",
      "html_url": "https://github.com/michaelfolkson",
      "followers_url": "https://api.github.com/users/michaelfolkson/followers",
      "following_url": "https://api.github.com/users/michaelfolkson/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelfolkson/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelfolkson/orgs",
      "repos_url": "https://api.github.com/users/michaelfolkson/repos",
      "events_url": "https://api.github.com/users/michaelfolkson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelfolkson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-03T12:15:39Z",
    "updated_at": "2021-11-03T12:15:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "I think @MarcoFalke and @ryanofsky have some good points above on docs generally so added their comments to #20132. This doc and the docs generally are definitely a work in progress with lots of scope for improvement. I agree with this being merged though as James' first attempt at a doc for Assume UTXO as there are no inaccuracies or clear sources of confusion (as far as I can tell) and follow up PRs can improve it (e.g. target it directly at developers or users).",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/958974768/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720868458",
    "pull_request_review_id": 769614599,
    "id": 720868458,
    "node_id": "PRRC_kwDOABII584q95Rq",
    "diff_hunk": "@@ -0,0 +1,137 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC commands `dumptxoutset` and `loadtxoutset` are used to respectively generate\n+and load UTXO snapshots. The utility script `./contrib/devtools/utxo_snapshot.sh` may\n+be of use.\n+\n+## General background\n+\n+- [assumeutxo proposal](https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal)\n+- [Github issue](https://github.com/bitcoin/bitcoin/issues/15605)\n+- [draft PR](https://github.com/bitcoin/bitcoin/pull/15606)\n+\n+## Design notes\n+\n+- A new block index `nStatus` flag is introduced, `BLOCK_ASSUMED_VALID`, to mark block\n+  index entries that are required to be assumed-valid by a chainstate created\n+  from a UTXO snapshot. This flag is mostly used as a way to modify certain\n+  CheckBlockIndex() logic to account for index entries that are pending validation by a\n+  chainstate running asynchronously in the background. We also use this flag to control\n+  which index entries are added to setBlockIndexCandidates during LoadBlockIndex().\n+\n+- Indexing implementations via BaseIndex can no longer assume that indexation happens\n+  sequentially, since background validation chainstates can submit BlockConnected\n+  events out of order with the active chain.\n+\n+- The concept of UTXO snapshots is treated as an implementation detail that lives\n+  behind the ChainstateManager interface. The external presentation of the changes\n+  required to facilitate the use of UTXO snapshots is the understanding that there are\n+  now certain regions of the chain that can be temporarily assumed to be valid (using\n+  the nStatus flag mentioned above). In certain cases, e.g. wallet rescanning, this is\n+  very similar to dealing with a pruned chain.\n+\n+  Logic outside ChainstateManager should try not to know about snapshots, instead\n+  preferring to work in terms of more general states like assumed-valid.\n+\n+\n+## Chainstate phases\n+\n+Chainstate within the system goes through a number of phases when UTXO snapshots are\n+used, as managed by `ChainstateManager`. At various points there can be multiple\n+`CChainState` objects in existence to facilitate both maintaining the network tip and\n+performing historical validation of the assumed-valid chain.\n+\n+It is worth noting that though there are multiple separate chainstates, those\n+chainstates share use of a common block index (i.e. they hold the same `BlockManager`\n+reference).\n+\n+The subheadings below outline the phases and the corresponding changes to chainstate\n+data.\n+\n+### \"Normal\" operation via initial block download\n+\n+`ChainstateManager` manages a single CChainState object, for which\n+`m_snapshot_blockhash` is null. This chainstate is (maybe obviously)\n+considered active. This is the \"traditional\" mode of operation for bitcoind.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 1 |\n+| active chainstate | ibd |\n+\n+### User loads a UTXO snapshot via `loadtxoutset` RPC\n+\n+`ChainstateManager` initializes a new chainstate to load the snapshot contents into.",
    "path": "doc/assumeutxo.md",
    "position": null,
    "original_position": 67,
    "commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "original_commit_id": "4c29459b44f70d264466dd5e23aa456d9c1b62c8",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "\"see `ActivateSnapshot()`\" ?",
    "created_at": "2021-10-03T18:32:05Z",
    "updated_at": "2021-10-03T18:45:10Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r720868458",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720868458"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r720868458"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720868458/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 67,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720868523",
    "pull_request_review_id": 769614599,
    "id": 720868523,
    "node_id": "PRRC_kwDOABII584q95Sr",
    "diff_hunk": "@@ -0,0 +1,137 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC commands `dumptxoutset` and `loadtxoutset` are used to respectively generate\n+and load UTXO snapshots. The utility script `./contrib/devtools/utxo_snapshot.sh` may\n+be of use.\n+\n+## General background\n+\n+- [assumeutxo proposal](https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal)\n+- [Github issue](https://github.com/bitcoin/bitcoin/issues/15605)\n+- [draft PR](https://github.com/bitcoin/bitcoin/pull/15606)\n+\n+## Design notes\n+\n+- A new block index `nStatus` flag is introduced, `BLOCK_ASSUMED_VALID`, to mark block\n+  index entries that are required to be assumed-valid by a chainstate created\n+  from a UTXO snapshot. This flag is mostly used as a way to modify certain\n+  CheckBlockIndex() logic to account for index entries that are pending validation by a\n+  chainstate running asynchronously in the background. We also use this flag to control\n+  which index entries are added to setBlockIndexCandidates during LoadBlockIndex().\n+\n+- Indexing implementations via BaseIndex can no longer assume that indexation happens\n+  sequentially, since background validation chainstates can submit BlockConnected\n+  events out of order with the active chain.\n+\n+- The concept of UTXO snapshots is treated as an implementation detail that lives\n+  behind the ChainstateManager interface. The external presentation of the changes\n+  required to facilitate the use of UTXO snapshots is the understanding that there are\n+  now certain regions of the chain that can be temporarily assumed to be valid (using\n+  the nStatus flag mentioned above). In certain cases, e.g. wallet rescanning, this is\n+  very similar to dealing with a pruned chain.\n+\n+  Logic outside ChainstateManager should try not to know about snapshots, instead\n+  preferring to work in terms of more general states like assumed-valid.\n+\n+\n+## Chainstate phases\n+\n+Chainstate within the system goes through a number of phases when UTXO snapshots are\n+used, as managed by `ChainstateManager`. At various points there can be multiple\n+`CChainState` objects in existence to facilitate both maintaining the network tip and\n+performing historical validation of the assumed-valid chain.\n+\n+It is worth noting that though there are multiple separate chainstates, those\n+chainstates share use of a common block index (i.e. they hold the same `BlockManager`\n+reference).\n+\n+The subheadings below outline the phases and the corresponding changes to chainstate\n+data.\n+\n+### \"Normal\" operation via initial block download\n+\n+`ChainstateManager` manages a single CChainState object, for which\n+`m_snapshot_blockhash` is null. This chainstate is (maybe obviously)\n+considered active. This is the \"traditional\" mode of operation for bitcoind.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 1 |\n+| active chainstate | ibd |\n+\n+### User loads a UTXO snapshot via `loadtxoutset` RPC\n+\n+`ChainstateManager` initializes a new chainstate to load the snapshot contents into.\n+During snapshot load and validation (see `PopulateAndValidateSnapshot()`), the\n+new chainstate is not considered active and\n+the original chainstate remains in use as active.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | ibd |\n+\n+Once the snapshot chainstate is loaded and validated, it is promoted to active\n+chainstate and a sync to tip begins. A new chainstate directory is created in the\n+datadir for the snapshot chainstate called\n+`chainstate_[SHA256 blockhash of snapshot base block]`.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | snapshot |\n+\n+The snapshot begins to sync to tip from its base block, technically in parallel with\n+the original chainstate, but it is given priority during block download and is\n+allocated most of the cache as our chief consideration is getting to network tip.",
    "path": "doc/assumeutxo.md",
    "position": null,
    "original_position": 89,
    "commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "original_commit_id": "4c29459b44f70d264466dd5e23aa456d9c1b62c8",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "\"see `MaybeRebalanceCaches`\" ? ?",
    "created_at": "2021-10-03T18:32:43Z",
    "updated_at": "2021-10-03T18:45:11Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r720868523",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720868523"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r720868523"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720868523/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 89,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720869222",
    "pull_request_review_id": 769614599,
    "id": 720869222,
    "node_id": "PRRC_kwDOABII584q95dm",
    "diff_hunk": "@@ -0,0 +1,137 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC commands `dumptxoutset` and `loadtxoutset` are used to respectively generate\n+and load UTXO snapshots. The utility script `./contrib/devtools/utxo_snapshot.sh` may\n+be of use.\n+\n+## General background\n+\n+- [assumeutxo proposal](https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal)\n+- [Github issue](https://github.com/bitcoin/bitcoin/issues/15605)\n+- [draft PR](https://github.com/bitcoin/bitcoin/pull/15606)\n+\n+## Design notes\n+\n+- A new block index `nStatus` flag is introduced, `BLOCK_ASSUMED_VALID`, to mark block\n+  index entries that are required to be assumed-valid by a chainstate created\n+  from a UTXO snapshot. This flag is mostly used as a way to modify certain\n+  CheckBlockIndex() logic to account for index entries that are pending validation by a\n+  chainstate running asynchronously in the background. We also use this flag to control\n+  which index entries are added to setBlockIndexCandidates during LoadBlockIndex().\n+\n+- Indexing implementations via BaseIndex can no longer assume that indexation happens\n+  sequentially, since background validation chainstates can submit BlockConnected\n+  events out of order with the active chain.\n+\n+- The concept of UTXO snapshots is treated as an implementation detail that lives\n+  behind the ChainstateManager interface. The external presentation of the changes\n+  required to facilitate the use of UTXO snapshots is the understanding that there are\n+  now certain regions of the chain that can be temporarily assumed to be valid (using\n+  the nStatus flag mentioned above). In certain cases, e.g. wallet rescanning, this is\n+  very similar to dealing with a pruned chain.\n+\n+  Logic outside ChainstateManager should try not to know about snapshots, instead\n+  preferring to work in terms of more general states like assumed-valid.\n+\n+\n+## Chainstate phases\n+\n+Chainstate within the system goes through a number of phases when UTXO snapshots are\n+used, as managed by `ChainstateManager`. At various points there can be multiple\n+`CChainState` objects in existence to facilitate both maintaining the network tip and\n+performing historical validation of the assumed-valid chain.\n+\n+It is worth noting that though there are multiple separate chainstates, those\n+chainstates share use of a common block index (i.e. they hold the same `BlockManager`\n+reference).\n+\n+The subheadings below outline the phases and the corresponding changes to chainstate\n+data.\n+\n+### \"Normal\" operation via initial block download\n+\n+`ChainstateManager` manages a single CChainState object, for which\n+`m_snapshot_blockhash` is null. This chainstate is (maybe obviously)\n+considered active. This is the \"traditional\" mode of operation for bitcoind.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 1 |\n+| active chainstate | ibd |\n+\n+### User loads a UTXO snapshot via `loadtxoutset` RPC\n+\n+`ChainstateManager` initializes a new chainstate to load the snapshot contents into.\n+During snapshot load and validation (see `PopulateAndValidateSnapshot()`), the\n+new chainstate is not considered active and\n+the original chainstate remains in use as active.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | ibd |\n+\n+Once the snapshot chainstate is loaded and validated, it is promoted to active\n+chainstate and a sync to tip begins. A new chainstate directory is created in the\n+datadir for the snapshot chainstate called\n+`chainstate_[SHA256 blockhash of snapshot base block]`.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | snapshot |\n+\n+The snapshot begins to sync to tip from its base block, technically in parallel with\n+the original chainstate, but it is given priority during block download and is\n+allocated most of the cache as our chief consideration is getting to network tip.\n+\n+**Failure consideration:** if shutdown happens at any point during this phase, both\n+chainstates will be detected during the next init and the process will resume.\n+\n+### Snapshot chainstate hits network tip\n+\n+Once the snapshot chainstate leaves IBD, caches are rebalanced\n+(via `MaybeRebalanceCaches()` in `ActivateBestChain()`) and more cache is given\n+to the background chainstate, which is responsible for doing full validation of the\n+assumed-valid parts of the chain.\n+\n+**Note:** at this point, ValidationInterface callbacks will be coming in from both\n+chainstates. Considerations here must be made for indexing, which may no longer be happening\n+sequentially.",
    "path": "doc/assumeutxo.md",
    "position": 104,
    "original_position": 103,
    "commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "original_commit_id": "4c29459b44f70d264466dd5e23aa456d9c1b62c8",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Do you have a Big Comment(tm) warning users of ValidationInterface callbacks of this subtlety ? Grepping quickly `src/validationinterface.h`, I don't see a mention of background/snapshot chainstate. Could be nice to be added at somepoint.",
    "created_at": "2021-10-03T18:38:09Z",
    "updated_at": "2021-10-03T18:45:11Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r720869222",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720869222"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r720869222"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720869222/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 104,
    "original_line": 104,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720869709",
    "pull_request_review_id": 769614599,
    "id": 720869709,
    "node_id": "PRRC_kwDOABII584q95lN",
    "diff_hunk": "@@ -0,0 +1,137 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC commands `dumptxoutset` and `loadtxoutset` are used to respectively generate\n+and load UTXO snapshots. The utility script `./contrib/devtools/utxo_snapshot.sh` may\n+be of use.\n+\n+## General background\n+\n+- [assumeutxo proposal](https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal)\n+- [Github issue](https://github.com/bitcoin/bitcoin/issues/15605)\n+- [draft PR](https://github.com/bitcoin/bitcoin/pull/15606)\n+\n+## Design notes\n+\n+- A new block index `nStatus` flag is introduced, `BLOCK_ASSUMED_VALID`, to mark block\n+  index entries that are required to be assumed-valid by a chainstate created\n+  from a UTXO snapshot. This flag is mostly used as a way to modify certain\n+  CheckBlockIndex() logic to account for index entries that are pending validation by a\n+  chainstate running asynchronously in the background. We also use this flag to control\n+  which index entries are added to setBlockIndexCandidates during LoadBlockIndex().\n+\n+- Indexing implementations via BaseIndex can no longer assume that indexation happens\n+  sequentially, since background validation chainstates can submit BlockConnected\n+  events out of order with the active chain.\n+\n+- The concept of UTXO snapshots is treated as an implementation detail that lives\n+  behind the ChainstateManager interface. The external presentation of the changes\n+  required to facilitate the use of UTXO snapshots is the understanding that there are\n+  now certain regions of the chain that can be temporarily assumed to be valid (using\n+  the nStatus flag mentioned above). In certain cases, e.g. wallet rescanning, this is\n+  very similar to dealing with a pruned chain.\n+\n+  Logic outside ChainstateManager should try not to know about snapshots, instead\n+  preferring to work in terms of more general states like assumed-valid.\n+\n+\n+## Chainstate phases\n+\n+Chainstate within the system goes through a number of phases when UTXO snapshots are\n+used, as managed by `ChainstateManager`. At various points there can be multiple\n+`CChainState` objects in existence to facilitate both maintaining the network tip and\n+performing historical validation of the assumed-valid chain.\n+\n+It is worth noting that though there are multiple separate chainstates, those\n+chainstates share use of a common block index (i.e. they hold the same `BlockManager`\n+reference).\n+\n+The subheadings below outline the phases and the corresponding changes to chainstate\n+data.\n+\n+### \"Normal\" operation via initial block download\n+\n+`ChainstateManager` manages a single CChainState object, for which\n+`m_snapshot_blockhash` is null. This chainstate is (maybe obviously)\n+considered active. This is the \"traditional\" mode of operation for bitcoind.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 1 |\n+| active chainstate | ibd |\n+\n+### User loads a UTXO snapshot via `loadtxoutset` RPC\n+\n+`ChainstateManager` initializes a new chainstate to load the snapshot contents into.\n+During snapshot load and validation (see `PopulateAndValidateSnapshot()`), the\n+new chainstate is not considered active and\n+the original chainstate remains in use as active.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | ibd |\n+\n+Once the snapshot chainstate is loaded and validated, it is promoted to active\n+chainstate and a sync to tip begins. A new chainstate directory is created in the\n+datadir for the snapshot chainstate called\n+`chainstate_[SHA256 blockhash of snapshot base block]`.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | snapshot |\n+\n+The snapshot begins to sync to tip from its base block, technically in parallel with\n+the original chainstate, but it is given priority during block download and is\n+allocated most of the cache as our chief consideration is getting to network tip.\n+\n+**Failure consideration:** if shutdown happens at any point during this phase, both\n+chainstates will be detected during the next init and the process will resume.\n+\n+### Snapshot chainstate hits network tip\n+\n+Once the snapshot chainstate leaves IBD, caches are rebalanced\n+(via `MaybeRebalanceCaches()` in `ActivateBestChain()`) and more cache is given\n+to the background chainstate, which is responsible for doing full validation of the\n+assumed-valid parts of the chain.\n+\n+**Note:** at this point, ValidationInterface callbacks will be coming in from both\n+chainstates. Considerations here must be made for indexing, which may no longer be happening\n+sequentially.\n+\n+### Background chainstate hits snapshot base block\n+\n+Once the tip of the background chainstate hits the base block of the snapshot\n+chainstate, we stop use of the background chainstate (by setting `m_stop_use` in",
    "path": "doc/assumeutxo.md",
    "position": null,
    "original_position": 108,
    "commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "original_commit_id": "4c29459b44f70d264466dd5e23aa456d9c1b62c8",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think `m_stop_use` isn't yet landed. Maybe add a \"//XXX:\" pointing to the downstream branch where it's present ? Like docs isn't matching yet the code.",
    "created_at": "2021-10-03T18:41:34Z",
    "updated_at": "2021-10-03T18:45:11Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r720869709",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720869709"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r720869709"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720869709/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 108,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720869990",
    "pull_request_review_id": 769614599,
    "id": 720869990,
    "node_id": "PRRC_kwDOABII584q95pm",
    "diff_hunk": "@@ -0,0 +1,137 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC commands `dumptxoutset` and `loadtxoutset` are used to respectively generate\n+and load UTXO snapshots. The utility script `./contrib/devtools/utxo_snapshot.sh` may\n+be of use.\n+\n+## General background\n+\n+- [assumeutxo proposal](https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal)\n+- [Github issue](https://github.com/bitcoin/bitcoin/issues/15605)\n+- [draft PR](https://github.com/bitcoin/bitcoin/pull/15606)\n+\n+## Design notes\n+\n+- A new block index `nStatus` flag is introduced, `BLOCK_ASSUMED_VALID`, to mark block\n+  index entries that are required to be assumed-valid by a chainstate created\n+  from a UTXO snapshot. This flag is mostly used as a way to modify certain\n+  CheckBlockIndex() logic to account for index entries that are pending validation by a\n+  chainstate running asynchronously in the background. We also use this flag to control\n+  which index entries are added to setBlockIndexCandidates during LoadBlockIndex().\n+\n+- Indexing implementations via BaseIndex can no longer assume that indexation happens\n+  sequentially, since background validation chainstates can submit BlockConnected\n+  events out of order with the active chain.\n+\n+- The concept of UTXO snapshots is treated as an implementation detail that lives\n+  behind the ChainstateManager interface. The external presentation of the changes\n+  required to facilitate the use of UTXO snapshots is the understanding that there are\n+  now certain regions of the chain that can be temporarily assumed to be valid (using\n+  the nStatus flag mentioned above). In certain cases, e.g. wallet rescanning, this is\n+  very similar to dealing with a pruned chain.\n+\n+  Logic outside ChainstateManager should try not to know about snapshots, instead\n+  preferring to work in terms of more general states like assumed-valid.\n+\n+\n+## Chainstate phases\n+\n+Chainstate within the system goes through a number of phases when UTXO snapshots are\n+used, as managed by `ChainstateManager`. At various points there can be multiple\n+`CChainState` objects in existence to facilitate both maintaining the network tip and\n+performing historical validation of the assumed-valid chain.\n+\n+It is worth noting that though there are multiple separate chainstates, those\n+chainstates share use of a common block index (i.e. they hold the same `BlockManager`\n+reference).\n+\n+The subheadings below outline the phases and the corresponding changes to chainstate\n+data.\n+\n+### \"Normal\" operation via initial block download\n+\n+`ChainstateManager` manages a single CChainState object, for which\n+`m_snapshot_blockhash` is null. This chainstate is (maybe obviously)\n+considered active. This is the \"traditional\" mode of operation for bitcoind.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 1 |\n+| active chainstate | ibd |\n+\n+### User loads a UTXO snapshot via `loadtxoutset` RPC\n+\n+`ChainstateManager` initializes a new chainstate to load the snapshot contents into.\n+During snapshot load and validation (see `PopulateAndValidateSnapshot()`), the\n+new chainstate is not considered active and\n+the original chainstate remains in use as active.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | ibd |\n+\n+Once the snapshot chainstate is loaded and validated, it is promoted to active\n+chainstate and a sync to tip begins. A new chainstate directory is created in the\n+datadir for the snapshot chainstate called\n+`chainstate_[SHA256 blockhash of snapshot base block]`.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | snapshot |\n+\n+The snapshot begins to sync to tip from its base block, technically in parallel with\n+the original chainstate, but it is given priority during block download and is\n+allocated most of the cache as our chief consideration is getting to network tip.\n+\n+**Failure consideration:** if shutdown happens at any point during this phase, both\n+chainstates will be detected during the next init and the process will resume.\n+\n+### Snapshot chainstate hits network tip\n+\n+Once the snapshot chainstate leaves IBD, caches are rebalanced\n+(via `MaybeRebalanceCaches()` in `ActivateBestChain()`) and more cache is given\n+to the background chainstate, which is responsible for doing full validation of the\n+assumed-valid parts of the chain.\n+\n+**Note:** at this point, ValidationInterface callbacks will be coming in from both\n+chainstates. Considerations here must be made for indexing, which may no longer be happening\n+sequentially.\n+\n+### Background chainstate hits snapshot base block\n+\n+Once the tip of the background chainstate hits the base block of the snapshot\n+chainstate, we stop use of the background chainstate (by setting `m_stop_use` in\n+`CompleteSnapshotValidation()`, which is checked in `ActivateBestChain()`). We hash the\n+background chainstate's UTXO set contents and ensure it matches the compiled\n+value in `CMainParams::m_assumeutxo_data`.\n+\n+The background chainstate data lingers on disk until shutdown, when in\n+`ChainstateManager::Reset()`, the background chainstate is cleaned up with\n+`ValidatedSnapshotShutdownCleanup()`, which renames the `chainstate_[hash]` datadir as\n+`chainstate`.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 (ibd has `m_stop_use=true`) |\n+| active chainstate | snapshot |\n+\n+**Failure consideration:** if bitcoind unexpectedly halts after `m_stop_use` is set on\n+the background chainstate but before `CompleteSnapshotValidation()` can finish, the\n+need to complete snapshot validation will be detected on subsequent init by\n+`ChainstateManager::CheckForUncleanShutdown()`.\n+\n+### Bitcoind restarts sometime after snapshot validation has completed\n+\n+When the bitcoind initializes again, what began as the snapshot chainstate is now\n+indistinguishable from a chainstate that has been built from the traditional IBD\n+process, and will be initialized as such.",
    "path": "doc/assumeutxo.md",
    "position": 133,
    "original_position": 132,
    "commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "original_commit_id": "4c29459b44f70d264466dd5e23aa456d9c1b62c8",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "From a user, observing the chainstate from RPC calls, do you have any difference with the above \"Normal\" operation\" at that stage or they're fully similar ?",
    "created_at": "2021-10-03T18:44:35Z",
    "updated_at": "2021-10-03T18:45:11Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r720869990",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720869990"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r720869990"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720869990/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 133,
    "original_line": 133,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721252232",
    "pull_request_review_id": 770142961,
    "id": 721252232,
    "node_id": "PRRC_kwDOABII584q_W-I",
    "diff_hunk": "@@ -0,0 +1,137 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC commands `dumptxoutset` and `loadtxoutset` are used to respectively generate\n+and load UTXO snapshots. The utility script `./contrib/devtools/utxo_snapshot.sh` may\n+be of use.\n+\n+## General background\n+\n+- [assumeutxo proposal](https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal)\n+- [Github issue](https://github.com/bitcoin/bitcoin/issues/15605)\n+- [draft PR](https://github.com/bitcoin/bitcoin/pull/15606)\n+\n+## Design notes\n+\n+- A new block index `nStatus` flag is introduced, `BLOCK_ASSUMED_VALID`, to mark block\n+  index entries that are required to be assumed-valid by a chainstate created\n+  from a UTXO snapshot. This flag is mostly used as a way to modify certain\n+  CheckBlockIndex() logic to account for index entries that are pending validation by a\n+  chainstate running asynchronously in the background. We also use this flag to control\n+  which index entries are added to setBlockIndexCandidates during LoadBlockIndex().\n+\n+- Indexing implementations via BaseIndex can no longer assume that indexation happens\n+  sequentially, since background validation chainstates can submit BlockConnected\n+  events out of order with the active chain.\n+\n+- The concept of UTXO snapshots is treated as an implementation detail that lives\n+  behind the ChainstateManager interface. The external presentation of the changes\n+  required to facilitate the use of UTXO snapshots is the understanding that there are\n+  now certain regions of the chain that can be temporarily assumed to be valid (using\n+  the nStatus flag mentioned above). In certain cases, e.g. wallet rescanning, this is\n+  very similar to dealing with a pruned chain.\n+\n+  Logic outside ChainstateManager should try not to know about snapshots, instead\n+  preferring to work in terms of more general states like assumed-valid.\n+\n+\n+## Chainstate phases\n+\n+Chainstate within the system goes through a number of phases when UTXO snapshots are\n+used, as managed by `ChainstateManager`. At various points there can be multiple\n+`CChainState` objects in existence to facilitate both maintaining the network tip and\n+performing historical validation of the assumed-valid chain.\n+\n+It is worth noting that though there are multiple separate chainstates, those\n+chainstates share use of a common block index (i.e. they hold the same `BlockManager`\n+reference).\n+\n+The subheadings below outline the phases and the corresponding changes to chainstate\n+data.\n+\n+### \"Normal\" operation via initial block download\n+\n+`ChainstateManager` manages a single CChainState object, for which\n+`m_snapshot_blockhash` is null. This chainstate is (maybe obviously)\n+considered active. This is the \"traditional\" mode of operation for bitcoind.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 1 |\n+| active chainstate | ibd |\n+\n+### User loads a UTXO snapshot via `loadtxoutset` RPC\n+\n+`ChainstateManager` initializes a new chainstate to load the snapshot contents into.\n+During snapshot load and validation (see `PopulateAndValidateSnapshot()`), the\n+new chainstate is not considered active and\n+the original chainstate remains in use as active.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | ibd |\n+\n+Once the snapshot chainstate is loaded and validated, it is promoted to active\n+chainstate and a sync to tip begins. A new chainstate directory is created in the\n+datadir for the snapshot chainstate called\n+`chainstate_[SHA256 blockhash of snapshot base block]`.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | snapshot |\n+\n+The snapshot begins to sync to tip from its base block, technically in parallel with\n+the original chainstate, but it is given priority during block download and is\n+allocated most of the cache as our chief consideration is getting to network tip.\n+\n+**Failure consideration:** if shutdown happens at any point during this phase, both\n+chainstates will be detected during the next init and the process will resume.\n+\n+### Snapshot chainstate hits network tip\n+\n+Once the snapshot chainstate leaves IBD, caches are rebalanced\n+(via `MaybeRebalanceCaches()` in `ActivateBestChain()`) and more cache is given\n+to the background chainstate, which is responsible for doing full validation of the\n+assumed-valid parts of the chain.\n+\n+**Note:** at this point, ValidationInterface callbacks will be coming in from both\n+chainstates. Considerations here must be made for indexing, which may no longer be happening\n+sequentially.\n+\n+### Background chainstate hits snapshot base block",
    "path": "doc/assumeutxo.md",
    "position": 106,
    "original_position": 105,
    "commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "original_commit_id": "4c29459b44f70d264466dd5e23aa456d9c1b62c8",
    "user": {
      "login": "naumenkogs",
      "id": 7975071,
      "node_id": "MDQ6VXNlcjc5NzUwNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naumenkogs",
      "html_url": "https://github.com/naumenkogs",
      "followers_url": "https://api.github.com/users/naumenkogs/followers",
      "following_url": "https://api.github.com/users/naumenkogs/following{/other_user}",
      "gists_url": "https://api.github.com/users/naumenkogs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
      "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
      "repos_url": "https://api.github.com/users/naumenkogs/repos",
      "events_url": "https://api.github.com/users/naumenkogs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Perhaps you could call this ibd chainstate, and not background? Or anything not background, because at some point background also refers to the snapshot as well",
    "created_at": "2021-10-04T10:54:40Z",
    "updated_at": "2021-10-04T10:54:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r721252232",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721252232"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r721252232"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721252232/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 106,
    "original_line": 106,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721432465",
    "pull_request_review_id": 770389939,
    "id": 721432465,
    "node_id": "PRRC_kwDOABII584rAC-R",
    "diff_hunk": "@@ -0,0 +1,137 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC commands `dumptxoutset` and `loadtxoutset` are used to respectively generate\n+and load UTXO snapshots. The utility script `./contrib/devtools/utxo_snapshot.sh` may\n+be of use.\n+\n+## General background\n+\n+- [assumeutxo proposal](https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal)\n+- [Github issue](https://github.com/bitcoin/bitcoin/issues/15605)\n+- [draft PR](https://github.com/bitcoin/bitcoin/pull/15606)\n+\n+## Design notes\n+\n+- A new block index `nStatus` flag is introduced, `BLOCK_ASSUMED_VALID`, to mark block\n+  index entries that are required to be assumed-valid by a chainstate created\n+  from a UTXO snapshot. This flag is mostly used as a way to modify certain\n+  CheckBlockIndex() logic to account for index entries that are pending validation by a\n+  chainstate running asynchronously in the background. We also use this flag to control\n+  which index entries are added to setBlockIndexCandidates during LoadBlockIndex().\n+\n+- Indexing implementations via BaseIndex can no longer assume that indexation happens\n+  sequentially, since background validation chainstates can submit BlockConnected\n+  events out of order with the active chain.\n+\n+- The concept of UTXO snapshots is treated as an implementation detail that lives\n+  behind the ChainstateManager interface. The external presentation of the changes\n+  required to facilitate the use of UTXO snapshots is the understanding that there are\n+  now certain regions of the chain that can be temporarily assumed to be valid (using\n+  the nStatus flag mentioned above). In certain cases, e.g. wallet rescanning, this is\n+  very similar to dealing with a pruned chain.\n+\n+  Logic outside ChainstateManager should try not to know about snapshots, instead\n+  preferring to work in terms of more general states like assumed-valid.\n+\n+\n+## Chainstate phases\n+\n+Chainstate within the system goes through a number of phases when UTXO snapshots are\n+used, as managed by `ChainstateManager`. At various points there can be multiple\n+`CChainState` objects in existence to facilitate both maintaining the network tip and\n+performing historical validation of the assumed-valid chain.\n+\n+It is worth noting that though there are multiple separate chainstates, those\n+chainstates share use of a common block index (i.e. they hold the same `BlockManager`\n+reference).\n+\n+The subheadings below outline the phases and the corresponding changes to chainstate\n+data.\n+\n+### \"Normal\" operation via initial block download\n+\n+`ChainstateManager` manages a single CChainState object, for which\n+`m_snapshot_blockhash` is null. This chainstate is (maybe obviously)\n+considered active. This is the \"traditional\" mode of operation for bitcoind.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 1 |\n+| active chainstate | ibd |\n+\n+### User loads a UTXO snapshot via `loadtxoutset` RPC\n+\n+`ChainstateManager` initializes a new chainstate to load the snapshot contents into.\n+During snapshot load and validation (see `PopulateAndValidateSnapshot()`), the\n+new chainstate is not considered active and\n+the original chainstate remains in use as active.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | ibd |\n+\n+Once the snapshot chainstate is loaded and validated, it is promoted to active\n+chainstate and a sync to tip begins. A new chainstate directory is created in the\n+datadir for the snapshot chainstate called\n+`chainstate_[SHA256 blockhash of snapshot base block]`.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | snapshot |\n+\n+The snapshot begins to sync to tip from its base block, technically in parallel with\n+the original chainstate, but it is given priority during block download and is\n+allocated most of the cache as our chief consideration is getting to network tip.\n+\n+**Failure consideration:** if shutdown happens at any point during this phase, both\n+chainstates will be detected during the next init and the process will resume.\n+\n+### Snapshot chainstate hits network tip\n+\n+Once the snapshot chainstate leaves IBD, caches are rebalanced\n+(via `MaybeRebalanceCaches()` in `ActivateBestChain()`) and more cache is given\n+to the background chainstate, which is responsible for doing full validation of the\n+assumed-valid parts of the chain.\n+\n+**Note:** at this point, ValidationInterface callbacks will be coming in from both\n+chainstates. Considerations here must be made for indexing, which may no longer be happening\n+sequentially.\n+\n+### Background chainstate hits snapshot base block",
    "path": "doc/assumeutxo.md",
    "position": 106,
    "original_position": 105,
    "commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "original_commit_id": "4c29459b44f70d264466dd5e23aa456d9c1b62c8",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yeah, I had been calling it IBD chainstate, but eventually standardized on background chainstate to cut down on jargon (see https://github.com/bitcoin/bitcoin/pull/15606#pullrequestreview-692965905). ",
    "created_at": "2021-10-04T14:40:24Z",
    "updated_at": "2021-10-04T14:40:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r721432465",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721432465"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r721432465"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721432465/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 106,
    "original_line": 106,
    "side": "RIGHT",
    "in_reply_to_id": 721252232
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721701221",
    "pull_request_review_id": 770751212,
    "id": 721701221,
    "node_id": "PRRC_kwDOABII584rBEll",
    "diff_hunk": "@@ -0,0 +1,137 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC commands `dumptxoutset` and `loadtxoutset` are used to respectively generate\n+and load UTXO snapshots. The utility script `./contrib/devtools/utxo_snapshot.sh` may\n+be of use.\n+\n+## General background\n+\n+- [assumeutxo proposal](https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal)\n+- [Github issue](https://github.com/bitcoin/bitcoin/issues/15605)\n+- [draft PR](https://github.com/bitcoin/bitcoin/pull/15606)\n+\n+## Design notes\n+\n+- A new block index `nStatus` flag is introduced, `BLOCK_ASSUMED_VALID`, to mark block\n+  index entries that are required to be assumed-valid by a chainstate created\n+  from a UTXO snapshot. This flag is mostly used as a way to modify certain\n+  CheckBlockIndex() logic to account for index entries that are pending validation by a\n+  chainstate running asynchronously in the background. We also use this flag to control\n+  which index entries are added to setBlockIndexCandidates during LoadBlockIndex().\n+\n+- Indexing implementations via BaseIndex can no longer assume that indexation happens\n+  sequentially, since background validation chainstates can submit BlockConnected\n+  events out of order with the active chain.\n+\n+- The concept of UTXO snapshots is treated as an implementation detail that lives\n+  behind the ChainstateManager interface. The external presentation of the changes\n+  required to facilitate the use of UTXO snapshots is the understanding that there are\n+  now certain regions of the chain that can be temporarily assumed to be valid (using\n+  the nStatus flag mentioned above). In certain cases, e.g. wallet rescanning, this is\n+  very similar to dealing with a pruned chain.\n+\n+  Logic outside ChainstateManager should try not to know about snapshots, instead\n+  preferring to work in terms of more general states like assumed-valid.\n+\n+\n+## Chainstate phases\n+\n+Chainstate within the system goes through a number of phases when UTXO snapshots are\n+used, as managed by `ChainstateManager`. At various points there can be multiple\n+`CChainState` objects in existence to facilitate both maintaining the network tip and\n+performing historical validation of the assumed-valid chain.\n+\n+It is worth noting that though there are multiple separate chainstates, those\n+chainstates share use of a common block index (i.e. they hold the same `BlockManager`\n+reference).\n+\n+The subheadings below outline the phases and the corresponding changes to chainstate\n+data.\n+\n+### \"Normal\" operation via initial block download\n+\n+`ChainstateManager` manages a single CChainState object, for which\n+`m_snapshot_blockhash` is null. This chainstate is (maybe obviously)\n+considered active. This is the \"traditional\" mode of operation for bitcoind.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 1 |\n+| active chainstate | ibd |\n+\n+### User loads a UTXO snapshot via `loadtxoutset` RPC\n+\n+`ChainstateManager` initializes a new chainstate to load the snapshot contents into.\n+During snapshot load and validation (see `PopulateAndValidateSnapshot()`), the\n+new chainstate is not considered active and\n+the original chainstate remains in use as active.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | ibd |\n+\n+Once the snapshot chainstate is loaded and validated, it is promoted to active\n+chainstate and a sync to tip begins. A new chainstate directory is created in the\n+datadir for the snapshot chainstate called\n+`chainstate_[SHA256 blockhash of snapshot base block]`.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | snapshot |\n+\n+The snapshot begins to sync to tip from its base block, technically in parallel with\n+the original chainstate, but it is given priority during block download and is\n+allocated most of the cache as our chief consideration is getting to network tip.\n+\n+**Failure consideration:** if shutdown happens at any point during this phase, both\n+chainstates will be detected during the next init and the process will resume.\n+\n+### Snapshot chainstate hits network tip\n+\n+Once the snapshot chainstate leaves IBD, caches are rebalanced\n+(via `MaybeRebalanceCaches()` in `ActivateBestChain()`) and more cache is given\n+to the background chainstate, which is responsible for doing full validation of the\n+assumed-valid parts of the chain.\n+\n+**Note:** at this point, ValidationInterface callbacks will be coming in from both\n+chainstates. Considerations here must be made for indexing, which may no longer be happening\n+sequentially.\n+\n+### Background chainstate hits snapshot base block\n+\n+Once the tip of the background chainstate hits the base block of the snapshot\n+chainstate, we stop use of the background chainstate (by setting `m_stop_use` in\n+`CompleteSnapshotValidation()`, which is checked in `ActivateBestChain()`). We hash the\n+background chainstate's UTXO set contents and ensure it matches the compiled\n+value in `CMainParams::m_assumeutxo_data`.\n+\n+The background chainstate data lingers on disk until shutdown, when in\n+`ChainstateManager::Reset()`, the background chainstate is cleaned up with\n+`ValidatedSnapshotShutdownCleanup()`, which renames the `chainstate_[hash]` datadir as\n+`chainstate`.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 (ibd has `m_stop_use=true`) |\n+| active chainstate | snapshot |\n+\n+**Failure consideration:** if bitcoind unexpectedly halts after `m_stop_use` is set on\n+the background chainstate but before `CompleteSnapshotValidation()` can finish, the\n+need to complete snapshot validation will be detected on subsequent init by\n+`ChainstateManager::CheckForUncleanShutdown()`.\n+\n+### Bitcoind restarts sometime after snapshot validation has completed\n+\n+When the bitcoind initializes again, what began as the snapshot chainstate is now\n+indistinguishable from a chainstate that has been built from the traditional IBD\n+process, and will be initialized as such.",
    "path": "doc/assumeutxo.md",
    "position": 133,
    "original_position": 132,
    "commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "original_commit_id": "4c29459b44f70d264466dd5e23aa456d9c1b62c8",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "At the stage they're fully similar, but we could probably leave behind some indication that a snapshot was used if that's preferable for some reason. But at the moment I don't think there are any artifacts in the block index that could be used to indicate this.",
    "created_at": "2021-10-04T20:39:42Z",
    "updated_at": "2021-10-04T20:39:42Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r721701221",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721701221"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r721701221"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721701221/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 133,
    "original_line": 133,
    "side": "RIGHT",
    "in_reply_to_id": 720869990
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721710261",
    "pull_request_review_id": 770762939,
    "id": 721710261,
    "node_id": "PRRC_kwDOABII584rBGy1",
    "diff_hunk": "@@ -0,0 +1,137 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC commands `dumptxoutset` and `loadtxoutset` are used to respectively generate\n+and load UTXO snapshots. The utility script `./contrib/devtools/utxo_snapshot.sh` may\n+be of use.\n+\n+## General background\n+\n+- [assumeutxo proposal](https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal)\n+- [Github issue](https://github.com/bitcoin/bitcoin/issues/15605)\n+- [draft PR](https://github.com/bitcoin/bitcoin/pull/15606)\n+\n+## Design notes\n+\n+- A new block index `nStatus` flag is introduced, `BLOCK_ASSUMED_VALID`, to mark block\n+  index entries that are required to be assumed-valid by a chainstate created\n+  from a UTXO snapshot. This flag is mostly used as a way to modify certain\n+  CheckBlockIndex() logic to account for index entries that are pending validation by a\n+  chainstate running asynchronously in the background. We also use this flag to control\n+  which index entries are added to setBlockIndexCandidates during LoadBlockIndex().\n+\n+- Indexing implementations via BaseIndex can no longer assume that indexation happens\n+  sequentially, since background validation chainstates can submit BlockConnected\n+  events out of order with the active chain.\n+\n+- The concept of UTXO snapshots is treated as an implementation detail that lives\n+  behind the ChainstateManager interface. The external presentation of the changes\n+  required to facilitate the use of UTXO snapshots is the understanding that there are\n+  now certain regions of the chain that can be temporarily assumed to be valid (using\n+  the nStatus flag mentioned above). In certain cases, e.g. wallet rescanning, this is\n+  very similar to dealing with a pruned chain.\n+\n+  Logic outside ChainstateManager should try not to know about snapshots, instead\n+  preferring to work in terms of more general states like assumed-valid.\n+\n+\n+## Chainstate phases\n+\n+Chainstate within the system goes through a number of phases when UTXO snapshots are\n+used, as managed by `ChainstateManager`. At various points there can be multiple\n+`CChainState` objects in existence to facilitate both maintaining the network tip and\n+performing historical validation of the assumed-valid chain.\n+\n+It is worth noting that though there are multiple separate chainstates, those\n+chainstates share use of a common block index (i.e. they hold the same `BlockManager`\n+reference).\n+\n+The subheadings below outline the phases and the corresponding changes to chainstate\n+data.\n+\n+### \"Normal\" operation via initial block download\n+\n+`ChainstateManager` manages a single CChainState object, for which\n+`m_snapshot_blockhash` is null. This chainstate is (maybe obviously)\n+considered active. This is the \"traditional\" mode of operation for bitcoind.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 1 |\n+| active chainstate | ibd |\n+\n+### User loads a UTXO snapshot via `loadtxoutset` RPC\n+\n+`ChainstateManager` initializes a new chainstate to load the snapshot contents into.\n+During snapshot load and validation (see `PopulateAndValidateSnapshot()`), the\n+new chainstate is not considered active and\n+the original chainstate remains in use as active.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | ibd |\n+\n+Once the snapshot chainstate is loaded and validated, it is promoted to active\n+chainstate and a sync to tip begins. A new chainstate directory is created in the\n+datadir for the snapshot chainstate called\n+`chainstate_[SHA256 blockhash of snapshot base block]`.\n+\n+|    |    |\n+| ---------- | ----------- |\n+| number of chainstates | 2 |\n+| active chainstate | snapshot |\n+\n+The snapshot begins to sync to tip from its base block, technically in parallel with\n+the original chainstate, but it is given priority during block download and is\n+allocated most of the cache as our chief consideration is getting to network tip.\n+\n+**Failure consideration:** if shutdown happens at any point during this phase, both\n+chainstates will be detected during the next init and the process will resume.\n+\n+### Snapshot chainstate hits network tip\n+\n+Once the snapshot chainstate leaves IBD, caches are rebalanced\n+(via `MaybeRebalanceCaches()` in `ActivateBestChain()`) and more cache is given\n+to the background chainstate, which is responsible for doing full validation of the\n+assumed-valid parts of the chain.\n+\n+**Note:** at this point, ValidationInterface callbacks will be coming in from both\n+chainstates. Considerations here must be made for indexing, which may no longer be happening\n+sequentially.",
    "path": "doc/assumeutxo.md",
    "position": 104,
    "original_position": 103,
    "commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "original_commit_id": "4c29459b44f70d264466dd5e23aa456d9c1b62c8",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Good point - I'll verify that I'm making a note somewhere in comments about this.",
    "created_at": "2021-10-04T20:54:00Z",
    "updated_at": "2021-10-04T20:54:00Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r721710261",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721710261"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r721710261"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721710261/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 104,
    "original_line": 104,
    "side": "RIGHT",
    "in_reply_to_id": 720869222
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741439020",
    "pull_request_review_id": 795884772,
    "id": 741439020,
    "node_id": "PRRC_kwDOABII584sMXYs",
    "diff_hunk": "@@ -0,0 +1,138 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC commands `dumptxoutset` and `loadtxoutset` are used to respectively generate\n+and load UTXO snapshots. The utility script `./contrib/devtools/utxo_snapshot.sh` may\n+be of use.",
    "path": "doc/assumeutxo.md",
    "position": 8,
    "original_position": 8,
    "commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "original_commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Would be good to tell the reader for what it is of use: \r\n\"[...]may be of use to create or validate historic snapshots.\"",
    "created_at": "2021-11-02T20:28:09Z",
    "updated_at": "2021-11-02T21:49:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r741439020",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741439020"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r741439020"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741439020/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 8,
    "original_line": 8,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741440102",
    "pull_request_review_id": 795884772,
    "id": 741440102,
    "node_id": "PRRC_kwDOABII584sMXpm",
    "diff_hunk": "@@ -0,0 +1,138 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC commands `dumptxoutset` and `loadtxoutset` are used to respectively generate\n+and load UTXO snapshots. The utility script `./contrib/devtools/utxo_snapshot.sh` may\n+be of use.\n+\n+## General background\n+\n+- [assumeutxo proposal](https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal)\n+- [Github issue](https://github.com/bitcoin/bitcoin/issues/15605)\n+- [draft PR](https://github.com/bitcoin/bitcoin/pull/15606)\n+\n+## Design notes\n+\n+- A new block index `nStatus` flag is introduced, `BLOCK_ASSUMED_VALID`, to mark block\n+  index entries that are required to be assumed-valid by a chainstate created\n+  from a UTXO snapshot. This flag is mostly used as a way to modify certain\n+  CheckBlockIndex() logic to account for index entries that are pending validation by a",
    "path": "doc/assumeutxo.md",
    "position": 21,
    "original_position": 21,
    "commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "original_commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I would like some backticks at least for the functions: `CheckBlockIndex()` and `LoadBlockIndex()` below.",
    "created_at": "2021-11-02T20:29:51Z",
    "updated_at": "2021-11-02T21:49:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r741440102",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741440102"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r741440102"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741440102/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 21,
    "original_line": 21,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741673855",
    "pull_request_review_id": 796183974,
    "id": 741673855,
    "node_id": "PRRC_kwDOABII584sNQt_",
    "diff_hunk": "@@ -0,0 +1,138 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC commands `dumptxoutset` and `loadtxoutset` are used to respectively generate\n+and load UTXO snapshots. The utility script `./contrib/devtools/utxo_snapshot.sh` may\n+be of use.\n+\n+## General background\n+\n+- [assumeutxo proposal](https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal)\n+- [Github issue](https://github.com/bitcoin/bitcoin/issues/15605)\n+- [draft PR](https://github.com/bitcoin/bitcoin/pull/15606)\n+\n+## Design notes\n+\n+- A new block index `nStatus` flag is introduced, `BLOCK_ASSUMED_VALID`, to mark block",
    "path": "doc/assumeutxo.md",
    "position": 18,
    "original_position": 18,
    "commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "original_commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I am wondering who is the audience of this document?\r\n\r\nIf it is a developer, it might be better to put the documentation in the source code. Otherwise it will be hard for developers to find it and it will more easily get out of date.\r\n\r\nIf the target audience is a user, I am wondering why internal implementation details are mentioned and why they are relevant to the user.\r\n\r\nIf the target audience is a reviewer of your pull request, I am wondering why this needs a doc at all in the source tree. Wouldn't a pull request description or so be a better place?",
    "created_at": "2021-11-03T07:41:19Z",
    "updated_at": "2021-11-03T07:46:40Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r741673855",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741673855"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r741673855"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741673855/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 18,
    "original_line": 18,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741855503",
    "pull_request_review_id": 796424913,
    "id": 741855503,
    "node_id": "PRRC_kwDOABII584sN9EP",
    "diff_hunk": "@@ -0,0 +1,138 @@\n+# assumeutxo\n+\n+Assumeutxo is a feature that allows fast bootstrapping of a validating bitcoind\n+instance with a very similar security model to assumevalid.\n+\n+The RPC commands `dumptxoutset` and `loadtxoutset` are used to respectively generate\n+and load UTXO snapshots. The utility script `./contrib/devtools/utxo_snapshot.sh` may\n+be of use.\n+\n+## General background\n+\n+- [assumeutxo proposal](https://github.com/jamesob/assumeutxo-docs/tree/2019-04-proposal/proposal)\n+- [Github issue](https://github.com/bitcoin/bitcoin/issues/15605)\n+- [draft PR](https://github.com/bitcoin/bitcoin/pull/15606)\n+\n+## Design notes\n+\n+- A new block index `nStatus` flag is introduced, `BLOCK_ASSUMED_VALID`, to mark block",
    "path": "doc/assumeutxo.md",
    "position": 18,
    "original_position": 18,
    "commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "original_commit_id": "9ab440199d5c888363a42c957433d0e46cd0d2ff",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "re: https://github.com/bitcoin/bitcoin/pull/23154#discussion_r741673855\r\n\r\n> I am wondering who is the audience of this document? [...]\r\n\r\nI think the concerns here go a little beyond scope of this PR. Some of the files in the doc/ folder are clearly targeted at developers and not helpful to users like https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md. Some files like https://github.com/bitcoin/bitcoin/blob/master/doc/JSON-RPC-interface.md and the release notes are mostly useful for end users, and definitely intended to be read by them. I think ideally someone would go through the doc folder, keeping the files that are intended to be read by users but moving the other ones that are intended for developers/testers/contributors somewhere else like `doc/devel`,`doc/internal`, `doc/contrib`, `doc/design`.\r\n\r\nThis document is a basically a design document (other examples: [golang](https://go.googlesource.com/proposal/+/master/design), [chromium](https://www.chromium.org/developers/design-documents)) intended to by read by developers. It should be useful not just to people reviewing the PR, but also anybody going forward who want to understand how this feature which touches different parts of the source code is implemented and what some of design considerations are.\r\n\r\nAt the top of this file, there is a small amount of information that could be useful to users, but it is brief and basically just linking to RPCs and a script. If bitcoin had a user manual like [many other projects](https://www.gnu.org/manual/manual.en.html) do, this section could be copied there. But bitcoin doesn't have a user manual so, \ud83e\udd37\r\n\r\n> If it is a developer, it might be better to put the documentation in the source code. Otherwise it will be hard for developers to find it and it will more easily get out of date.\r\n\r\nI think this could be addressed by organizing the doc directory a little better and linking to the document from the source code so it is easier to find.\r\n\r\n> If the target audience is a user, I am wondering why internal implementation details are mentioned and why they are relevant to the user.\r\n\r\nUsers are not target audience here, AFAICT.\r\n\r\n> If the target audience is a reviewer of your pull request, I am wondering why this needs a doc at all in the source tree. Wouldn't a pull request description or so be a better place?\r\n\r\nI think this is a false dichotomy. If I am reviewing a pull request that includes end-user release notes, those release notes are usually more helpful to me for understanding behavior of the PR than any of the weedsy implementation details in the PR description or other parts of the diff.\r\n\r\nPR descriptions do tend to be better places than design documents for certain information, like describing details or drawbacks of previous code, but design documents are useful _both_ for current developers reviewing changes, and for future developers want to understand how a feature works. It is not an either/or.",
    "created_at": "2021-11-03T11:42:05Z",
    "updated_at": "2021-11-03T11:42:06Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r741855503",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741855503"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23154#discussion_r741855503"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23154"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741855503/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 18,
    "original_line": 18,
    "side": "RIGHT",
    "in_reply_to_id": 741673855
  }
]