paulyc,2020-01-04 14:35:28,"Whoa i dunno what just happened. Was just adding a comment but i inadvertently hit ""close conversation"" not as if i know what that button does but everything disappeared. Good thing i always write everything in a text editor because I'm so used to Android killing my apps and taking my drafts with them i dont like any ux that just deletes what you were working on because you hit one button. People ",https://github.com/bitcoin/bitcoin/pull/17852#issuecomment-570790339,570790339,
MarcoFalke,2020-01-06 21:30:54,"> What happens is, if you interrupt bitcoind in the middle of a sync with txindex on, the next time you run it, the txindexer has suddenly seemed to have fallen many blocks behind where it was when you interrupted the first process\n\nTxindex is a background thread, so it might fall back arbitrarily. Though it shouldn't lose progress from where it was in normal operation.",https://github.com/bitcoin/bitcoin/pull/17852#issuecomment-571323207,571323207,
jimpo,2020-01-07 02:57:17,"@paulyc Oh, thank you, very nice catch. This is happening because the txindex (and the other indices) are stopped in `Shutdown` (init.cpp) before `ForceFlushStateToDisk` is called. `ForceFlushStateToDisk` triggers the `ChainStateFlushed` callback on the indices which commits the indexed state to disk. So probably the best solution is to move the index stops after that. Alternately, `BaseIndex::Sto",https://github.com/bitcoin/bitcoin/pull/17852#issuecomment-571411047,571411047,
paulyc,2020-01-07 14:23:13,"Ah, @jimpo thanks for tracking that down as well. Must not have had enough coffee or something when I submitted this, but glad it helped find the issue, which clearly had to be a little more complex. ;) In the immortal words of Samwise Gamgee all's well as ends well, or at least it will be when a working PR is merged. Not sure if I'll have time to do it soon, but it's been there long enough, it ca",https://github.com/bitcoin/bitcoin/pull/17852#issuecomment-571607022,571607022,
MarcoFalke,2020-01-03 11:18:02,Why is this needed? The pointer should be reset when the TxIndex is destructed,https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362776455,362776455,src/index/txindex.cpp
paulyc,2020-01-03 14:34:54,"Good point, it should, (shouldn't it???) (clearly both C++ and myself are too old for me to be writing it), so it would seem that, at least in some corner case, ~TxIndex isn't getting called at all. So I will close this for now and reopen it if I figure out what's going on further investigation. Thanks",https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362829332,362829332,src/index/txindex.cpp
paulyc,2020-01-03 15:20:31,"I wonder, but wouldn't really know, if the default destructor call isn't somehow ordered, or being reordered, such that it doesn't finish before the process exits, and the explicit call here maybe allows it to finish, but I'd still have to test it more and maybe figure out a way to write an integration test that verifies all the leveldbs are properly closed (or not). Will investigate further",https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362846350,362846350,src/index/txindex.cpp
paulyc,2020-01-03 15:22:52,"Particularly since leveldb is rather poorly designed imo to put some very important closing the database code in the destructor, since, after all, the compiler (and programmer, and OS), don't necessarily know or care that any of those objects still in memory that are about to be wiped out by the OS when the process exits, actually do important things that need to happen before the process does exi",https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362847203,362847203,src/index/txindex.cpp
paulyc,2020-01-03 15:37:51,"It certainly seems like the patch works, but, I can neither explain why nor prove that it does definitively, so, not sure if that quite reaches the merge bar, in light of it being such a minor change to such a minor subsystem that isn't functionally broken, rather just a little bit inconvenient having to wait a while, while it reindexes the same blocks ;) but it's been bugging me (no pun intended)",https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362853352,362853352,src/index/txindex.cpp
MarcoFalke,2020-01-03 16:18:15,"What is the issue you are seeing? Any stacktraces or anything?\n\nReminds me of #13894, #14071, #15410 ",https://github.com/bitcoin/bitcoin/pull/17852#discussion_r362868171,362868171,src/index/txindex.cpp
paulyc,2020-01-04 14:31:45,"Ah yes, was just able to verify that this patch does not in fact mysteriously fix the issue, so it remains mysterious at the moment.\n\nWhat happens is, if you interrupt bitcoind in the middle of a sync with txindex on, the next time you run it, the txindexer has suddenly seemed to have fallen many blocks behind where it was when you interrupted the first process, for whatever reason that is yet",https://github.com/bitcoin/bitcoin/pull/17852#discussion_r363038234,363038234,src/index/txindex.cpp
