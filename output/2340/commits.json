[
  {
    "sha": "ba7fcc8de06602576ab6a5911879d3d8df80d36a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiYTdmY2M4ZGUwNjYwMjU3NmFiNmE1OTExODc5ZDNkOGRmODBkMzZh",
    "commit": {
      "author": {
        "name": "Peter Todd",
        "email": "pete@petertodd.org",
        "date": "2013-08-25T18:13:25Z"
      },
      "committer": {
        "name": "Peter Todd",
        "email": "pete@petertodd.org",
        "date": "2014-10-13T12:18:06Z"
      },
      "message": "Discourage fee sniping with nLockTime",
      "tree": {
        "sha": "c6150c3300576cd903c94ca0c5ef05ba25c2e95f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c6150c3300576cd903c94ca0c5ef05ba25c2e95f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ba7fcc8de06602576ab6a5911879d3d8df80d36a",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGrBAABCACVBQJUO8MAXhSAAAAAABUAQGJsb2NraGFzaEBiaXRjb2luLm9yZzAw\nMDAwMDAwMDAwMDAwMDAxNDBiZTE2YzU0N2MxM2QxNmUyNGYwMjYwNmRkMTA1NTNk\nMjE4OWUyYzBlZmNhNjUvFIAAAAAAFQARcGthLWFkZHJlc3NAZ251cGcub3JncGV0\nZUBwZXRlcnRvZC5vcmcACgkQJIFAPaXwkfslAwgArpRD7NLCVnEqLfsvOtZ1PTTM\n/QMkwGfunAijnGsY4afrP5wCdK+UskztJ+u/ZdfRtuSqGXDSvXLhE2licTOengU9\nNTamgYoMKzyx3sgiMge9y2358GQvxnUN0ZmaAvzOWAMLj847/vVTbhCH0ctOksfv\nCfvAyHKFshGcLNLQfD62KlPhcILyn9cJ536j9XFfkmgvkh1zN9OFyVosgbHo8dsB\nhsqqtDX+0nssBoM1isMPM5QOnW/nVfbVrFE6ocO629V+Rq3gmvMeJ2kzzYHme0ZN\nDvRlC9mFq4GJqKLMiVbvtyOXtykAjpPShshEkCXGWQlBxjHYha64gpwB38jT/w==\n=Fs3G\n-----END PGP SIGNATURE-----",
        "payload": "tree c6150c3300576cd903c94ca0c5ef05ba25c2e95f\nparent fe36e031cde8cd0e1cb446d761f229c088a0403f\nauthor Peter Todd <pete@petertodd.org> 1377454405 -0400\ncommitter Peter Todd <pete@petertodd.org> 1413202686 -0400\n\nDiscourage fee sniping with nLockTime\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ba7fcc8de06602576ab6a5911879d3d8df80d36a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ba7fcc8de06602576ab6a5911879d3d8df80d36a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ba7fcc8de06602576ab6a5911879d3d8df80d36a/comments",
    "author": {
      "login": "petertodd",
      "id": 7042,
      "node_id": "MDQ6VXNlcjcwNDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7042?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/petertodd",
      "html_url": "https://github.com/petertodd",
      "followers_url": "https://api.github.com/users/petertodd/followers",
      "following_url": "https://api.github.com/users/petertodd/following{/other_user}",
      "gists_url": "https://api.github.com/users/petertodd/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/petertodd/subscriptions",
      "organizations_url": "https://api.github.com/users/petertodd/orgs",
      "repos_url": "https://api.github.com/users/petertodd/repos",
      "events_url": "https://api.github.com/users/petertodd/events{/privacy}",
      "received_events_url": "https://api.github.com/users/petertodd/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "petertodd",
      "id": 7042,
      "node_id": "MDQ6VXNlcjcwNDI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7042?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/petertodd",
      "html_url": "https://github.com/petertodd",
      "followers_url": "https://api.github.com/users/petertodd/followers",
      "following_url": "https://api.github.com/users/petertodd/following{/other_user}",
      "gists_url": "https://api.github.com/users/petertodd/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/petertodd/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/petertodd/subscriptions",
      "organizations_url": "https://api.github.com/users/petertodd/orgs",
      "repos_url": "https://api.github.com/users/petertodd/repos",
      "events_url": "https://api.github.com/users/petertodd/events{/privacy}",
      "received_events_url": "https://api.github.com/users/petertodd/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "fe36e031cde8cd0e1cb446d761f229c088a0403f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fe36e031cde8cd0e1cb446d761f229c088a0403f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/fe36e031cde8cd0e1cb446d761f229c088a0403f"
      }
    ],
    "stats": {
      "total": 28,
      "additions": 27,
      "deletions": 1
    },
    "files": [
      {
        "sha": "a64d27a9412d894007194c3ce8d007a68c8903f8",
        "filename": "src/wallet.cpp",
        "status": "modified",
        "additions": 27,
        "deletions": 1,
        "changes": 28,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ba7fcc8de06602576ab6a5911879d3d8df80d36a/src/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ba7fcc8de06602576ab6a5911879d3d8df80d36a/src/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet.cpp?ref=ba7fcc8de06602576ab6a5911879d3d8df80d36a",
        "patch": "@@ -1347,6 +1347,28 @@ bool CWallet::CreateTransaction(const vector<pair<CScript, CAmount> >& vecSend,\n     wtxNew.BindWallet(this);\n     CMutableTransaction txNew;\n \n+    // Discourage fee sniping.\n+    //\n+    // However because of a off-by-one-error in previous versions we need to\n+    // neuter it by setting nLockTime to at least one less than nBestHeight.\n+    // Secondly currently propagation of transactions created for block heights\n+    // corresponding to blocks that were just mined may be iffy - transactions\n+    // aren't re-accepted into the mempool - we additionally neuter the code by\n+    // going ten blocks back. Doesn't yet do anything for sniping, but does act\n+    // to shake out wallet bugs like not showing nLockTime'd transactions at\n+    // all.\n+    txNew.nLockTime = std::max(0, chainActive.Height() - 10);\n+\n+    // Secondly occasionally randomly pick a nLockTime even further back, so\n+    // that transactions that are delayed after signing for whatever reason,\n+    // e.g. high-latency mix networks and some CoinJoin implementations, have\n+    // better privacy.\n+    if (GetRandInt(10) == 0)\n+        txNew.nLockTime = std::max(0, (int)txNew.nLockTime - GetRandInt(100));\n+\n+    assert(txNew.nLockTime <= (unsigned int)chainActive.Height());\n+    assert(txNew.nLockTime < LOCKTIME_THRESHOLD);\n+\n     {\n         LOCK2(cs_main, cs_wallet);\n         {\n@@ -1440,8 +1462,12 @@ bool CWallet::CreateTransaction(const vector<pair<CScript, CAmount> >& vecSend,\n                     reservekey.ReturnKey();\n \n                 // Fill vin\n+                //\n+                // Note how the sequence number is set to max()-1 so that the\n+                // nLockTime set above actually works.\n                 BOOST_FOREACH(const PAIRTYPE(const CWalletTx*,unsigned int)& coin, setCoins)\n-                    txNew.vin.push_back(CTxIn(coin.first->GetHash(),coin.second));\n+                    txNew.vin.push_back(CTxIn(coin.first->GetHash(),coin.second,CScript(),\n+                                              std::numeric_limits<unsigned int>::max()-1));\n \n                 // Sign\n                 int nIn = 0;"
      }
    ]
  }
]