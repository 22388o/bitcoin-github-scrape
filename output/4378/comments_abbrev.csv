dsnark,2014-06-21T14:41:07Z,"Appears functional with a quick test. Was able to bind two different ports and have clients connected to each, an intentionally misbehaving node on the whitelisted interface was not banned. Would it be sensible to show this as a line in `getpeerinfo` as well?\n",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46755330,46755330,
jgarzik,2014-06-21T14:43:53Z,"Comments:\n- Code review ACK\n- Agree w/ @dsnark that showing ""I'm whitelisted"" in getpeerinfo would be nice\n- -whitebind looks correct, but makes me nervous.  Was this a requested feature?  An IP address whitelist is consciously built, while a -whitebind port _hopes_ the whitelist is consciously built elsewhere.\n\nIt seems easier for sysadmins, etc. to make a bad mistake with -whitebind, even t",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46755391,46755391,
sipa,2014-06-21T14:57:05Z,"@jgarzik `-whitelist` just is not enough when you have both trusted and untrusted local services running. Right now, we're unable to perform DoS banning on hidden service peers because they appear to be coming from localhost.\n",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46755780,46755780,
sipa,2014-06-21T15:08:42Z,Added 'whitelisted' to `getpeerinfo`.\n,https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46756044,46756044,
sipa,2014-06-21T15:09:54Z,@dsnark Thanks for testing!\n,https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46756073,46756073,
jgarzik,2014-06-21T15:10:39Z,"Agree that is an issue, but this is still adding a Big Ole Security Exemption.  I would suggest inverting the problem, to achieve a more secure result:\n- Add -torbind (-shadybind?), where all incoming connections are untrusted, and point Tor hidden service at this port\n- Mark connections coming into this port with a special taint flag, so that they _cannot_ be whitelisted\n\nI think it would be ",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46756084,46756084,
sipa,2014-06-21T15:24:02Z,"Interesting idea, but I'm not sure I like the double exception behavior of ""normally peers are subjected to DoS banning, UNLESS they are whitelisted, which happens when they're in a whitelisted range, UNLESS they are connecting to shadybind.""\n",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46756420,46756420,
jgarzik,2014-06-21T15:33:09Z,"Fundamentally, it is still adding a ""default: insecure"" feature where the only justification for such insecurity is not a use case, a user request, but an implementation artifact (""that's how our code works"").\n\nBased on the problem description, it sounds like the needs are\n- -whitelist\n- -torbind\n- Fix our stupid DoS code, so that bitcoind can recognize that -torbind nodes have a second level",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46756654,46756654,
dsnark,2014-06-21T15:48:47Z,"> we need to DoS-ban a single Tor peer, not all of Tor.\n\nIf the peers are connected to a Hidden Service they _can't_ be identified due to the design of the network, they'll always be localhost. I don't see a way around that outside of just not allowing HS peers. \n",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46757051,46757051,
jgarzik,2014-06-21T15:55:21Z,"@dsnark You must consider the design of Tor + bitcoin, not just Tor alone.\n",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46757219,46757219,
sipa,2014-06-21T15:55:44Z,"@dsnark You're absolutely right... I didn't think about that.\n\nStill, we want to at least be able to disconnect a misbehaving Tor peer, and not exclude them from DoS banning just because they seem to be connecting from localhost. However, it's not as simple as this patch, as we need also a way to not ban 127.0.0.1.\n",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46757236,46757236,
sipa,2014-06-21T18:32:36Z,"@jgarzik Not disagreeing with you, but I'm not sure that potential security exception weighs up against the more complex semantics.\n\nI'll wait for some more opinions.\n",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46761185,46761185,
gmaxwell,2014-06-21T20:54:59Z,"@jgarzik In a lot of places the network security policy is implemented elsewhere, blocking that is annoying. The harm of being whitelisted inappropriately is also smallâ€”  though I'm a little worried that the unconditional relaying is a little bit too powerful... since it does make you into a blind attack multiplier.\n\nThis is also a little coarse in that immunity from ban is not the same as immun",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46764543,46764543,
sipa,2014-06-22T15:29:12Z,"So, two solutions:\n- Either adding special logic for localhost again to prevent it from being banned (even though connections from it may be DoS disconnected) [implemented now in this PR, as it was trivial]\n- Or add Jeff's suggested `-shadybind`, and give it that the extra logic of never banning.\n\nAlso new suggested names: `-trusted` and `-trustedbind` (instead of `-whitelist` and `-whitebind`",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46783928,46783928,
sipa,2014-06-22T15:39:34Z,@gmaxwell There is still the setInventoryKnown caching. One single inv will never be announced twice to the same peer (unless the setInventoryKnown cache overflows and is pruned). The largest advantage to rebroadcasts is that it does relay to new peers since the previous broadcast.\n,https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46784230,46784230,
BitcoinPullTester,2014-06-22T16:10:39Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4378_95b5f1961edb7a8b393d1cb298de7756621da20d for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tes",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46785092,46785092,
gmaxwell,2014-06-22T23:44:21Z,"A third thought:  extend the whitelist interface so that an ACL entry can specify the port that it was connected _to_, then instead of trusted bind you'd be able to just bind multiple ports and write whitelist entries like 0/0:1234.\n\nI still suspect that special casing localhost to prevent banning is something we want to do, even for onion peers. Banning all onion peers because one behaves is th",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-46796567,46796567,
laanwj,2014-06-25T08:14:11Z,Extending the ACLs to include what port/interface it is connected to sounds like feature creep to me. Too much work to maintain and test all that.\n\nIn cases such advanced configurability is needed I suggest using the host firewall combined with `trustedbind` to control access to a specific port.\n,https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-47072597,47072597,
mikehearn,2014-06-27T10:09:07Z,"For as long as anti-DoS policy involves the notion of banning peers, it won't be completely compatible with Tor either via hidden services or exit nodes. We can still use Tor when it works and hope that some attacker that is willing to very noisily interfere with the entire network to force people back onto the clearnet doesn't come along.\n\nEventually perhaps we'll have an alternative strategy t",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-47327851,47327851,
sipa,2014-07-09T16:12:36Z,Rebased.\n,https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-48496708,48496708,
BitcoinPullTester,2014-07-09T19:01:54Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4378_dc942e6f276b9fabc21f06d11cd16871d4054f82/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-te",https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-48519339,48519339,
laanwj,2014-07-10T06:11:02Z,ACK\n,https://github.com/bitcoin/bitcoin/pull/4378#issuecomment-48568647,48568647,
rebroad,2014-07-16T04:35:45Z,Why? This will cause any misbehaviour that is equal to or greater than the threshold set to cause the node to never be disconnected!\n,https://github.com/bitcoin/bitcoin/pull/4378#discussion_r14980981,14980981,src/main.cpp
gmaxwell,2014-07-16T13:55:28Z,As I pointed out in #4378 this isn't the case. (though I'm glad you're reading the code!)\n,https://github.com/bitcoin/bitcoin/pull/4378#discussion_r14998223,14998223,src/main.cpp
