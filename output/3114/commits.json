[
  {
    "sha": "a616206865d62106944300d7b912e3af8d357610",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphNjE2MjA2ODY1ZDYyMTA2OTQ0MzAwZDdiOTEyZTNhZjhkMzU3NjEw",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-10-19T13:55:08Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-10-26T12:43:26Z"
      },
      "message": "Give peer time-adjustment data an own lock\n\nInstead of relying on cs_main (defined in a different module) to\nprevent concurrent access to it.",
      "tree": {
        "sha": "18e4c06383c1f3ce6a2bda72857afe787fadaeef",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/18e4c06383c1f3ce6a2bda72857afe787fadaeef"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a616206865d62106944300d7b912e3af8d357610",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a616206865d62106944300d7b912e3af8d357610",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a616206865d62106944300d7b912e3af8d357610",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a616206865d62106944300d7b912e3af8d357610/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "0d09b3e8b0218169ab7ad2aa787c43ea11bc7060",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0d09b3e8b0218169ab7ad2aa787c43ea11bc7060",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/0d09b3e8b0218169ab7ad2aa787c43ea11bc7060"
      }
    ],
    "stats": {
      "total": 10,
      "additions": 7,
      "deletions": 3
    },
    "files": [
      {
        "sha": "ca58d931330770ee3d5633e07d1a970f377063fe",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 2,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a616206865d62106944300d7b912e3af8d357610/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a616206865d62106944300d7b912e3af8d357610/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=a616206865d62106944300d7b912e3af8d357610",
        "patch": "@@ -49,7 +49,7 @@ int64 CTransaction::nMinTxFee = 10000;  // Override with -mintxfee\n /** Fees smaller than this (in satoshi) are considered zero fee (for relaying) */\n int64 CTransaction::nMinRelayTxFee = 10000;\n \n-CMedianFilter<int> cPeerBlockCounts(8, 0); // Amount of blocks that other nodes claim to have\n+static CMedianFilter<int> cPeerBlockCounts(8, 0); // Amount of blocks that other nodes claim to have\n \n map<uint256, CBlock*> mapOrphanBlocks;\n multimap<uint256, CBlock*> mapOrphanBlocksByPrev;\n@@ -3460,8 +3460,9 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n \n         LogPrintf(\"receive version message: version %d, blocks=%d, us=%s, them=%s, peer=%s\\n\", pfrom->nVersion, pfrom->nStartingHeight, addrMe.ToString().c_str(), addrFrom.ToString().c_str(), pfrom->addr.ToString().c_str());\n \n-        LOCK(cs_main);\n         AddTimeData(pfrom->addr, nTime);\n+\n+        LOCK(cs_main);\n         cPeerBlockCounts.input(pfrom->nStartingHeight);\n     }\n "
      },
      {
        "sha": "e098ee56c91364be44ceb2e8b94d128a44fca032",
        "filename": "src/util.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 1,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a616206865d62106944300d7b912e3af8d357610/src/util.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a616206865d62106944300d7b912e3af8d357610/src/util.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util.cpp?ref=a616206865d62106944300d7b912e3af8d357610",
        "patch": "@@ -81,7 +81,6 @@ bool fServer = false;\n string strMiscWarning;\n bool fNoListen = false;\n bool fLogTimestamps = false;\n-CMedianFilter<int64> vTimeOffsets(200,0);\n volatile bool fReopenDebugLog = false;\n \n // Init OpenSSL library multithreading support\n@@ -1296,10 +1295,12 @@ void SetMockTime(int64 nMockTimeIn)\n     nMockTime = nMockTimeIn;\n }\n \n+static CCriticalSection cs_nTimeOffset;\n static int64 nTimeOffset = 0;\n \n int64 GetTimeOffset()\n {\n+    LOCK(cs_nTimeOffset);\n     return nTimeOffset;\n }\n \n@@ -1312,12 +1313,14 @@ void AddTimeData(const CNetAddr& ip, int64 nTime)\n {\n     int64 nOffsetSample = nTime - GetTime();\n \n+    LOCK(cs_nTimeOffset);\n     // Ignore duplicates\n     static set<CNetAddr> setKnown;\n     if (!setKnown.insert(ip).second)\n         return;\n \n     // Add data\n+    static CMedianFilter<int64> vTimeOffsets(200,0);\n     vTimeOffsets.input(nOffsetSample);\n     LogPrintf(\"Added time data, samples %d, offset %+\"PRI64d\" (%+\"PRI64d\" minutes)\\n\", vTimeOffsets.size(), nOffsetSample, nOffsetSample/60);\n     if (vTimeOffsets.size() >= 5 && vTimeOffsets.size() % 2 == 1)"
      }
    ]
  }
]