[
  {
    "sha": "e198c521d39bb0ec17f42dfe72026969984af2c7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplMTk4YzUyMWQzOWJiMGVjMTdmNDJkZmU3MjAyNjk2OTk4NGFmMmM3",
    "commit": {
      "author": {
        "name": "Patrick Strateman",
        "email": "patrick.strateman@gmail.com",
        "date": "2016-07-19T23:43:11Z"
      },
      "committer": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2016-09-30T17:11:00Z"
      },
      "message": "Move key derivation logic from GenerateNewKey to DeriveNewChildKey",
      "tree": {
        "sha": "8c4a869dedb488aef6661b6499af70831ff742de",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8c4a869dedb488aef6661b6499af70831ff742de"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e198c521d39bb0ec17f42dfe72026969984af2c7",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e198c521d39bb0ec17f42dfe72026969984af2c7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e198c521d39bb0ec17f42dfe72026969984af2c7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e198c521d39bb0ec17f42dfe72026969984af2c7/comments",
    "author": {
      "login": "pstratem",
      "id": 620611,
      "node_id": "MDQ6VXNlcjYyMDYxMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/620611?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pstratem",
      "html_url": "https://github.com/pstratem",
      "followers_url": "https://api.github.com/users/pstratem/followers",
      "following_url": "https://api.github.com/users/pstratem/following{/other_user}",
      "gists_url": "https://api.github.com/users/pstratem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pstratem/subscriptions",
      "organizations_url": "https://api.github.com/users/pstratem/orgs",
      "repos_url": "https://api.github.com/users/pstratem/repos",
      "events_url": "https://api.github.com/users/pstratem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pstratem/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f560d9564f74ae8f4b449121b22703b23db3d010",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f560d9564f74ae8f4b449121b22703b23db3d010",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f560d9564f74ae8f4b449121b22703b23db3d010"
      }
    ],
    "stats": {
      "total": 79,
      "additions": 42,
      "deletions": 37
    },
    "files": [
      {
        "sha": "a1f69dd94dd6c0d65e023b868b1ef25014bdb146",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 41,
        "deletions": 37,
        "changes": 78,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e198c521d39bb0ec17f42dfe72026969984af2c7/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e198c521d39bb0ec17f42dfe72026969984af2c7/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=e198c521d39bb0ec17f42dfe72026969984af2c7",
        "patch": "@@ -100,43 +100,7 @@ CPubKey CWallet::GenerateNewKey()\n \n     // use HD key derivation if HD was enabled during wallet creation\n     if (IsHDEnabled()) {\n-        // for now we use a fixed keypath scheme of m/0'/0'/k\n-        CKey key;                      //master key seed (256bit)\n-        CExtKey masterKey;             //hd master key\n-        CExtKey accountKey;            //key at m/0'\n-        CExtKey externalChainChildKey; //key at m/0'/0'\n-        CExtKey childKey;              //key at m/0'/0'/<n>'\n-\n-        // try to get the master key\n-        if (!GetKey(hdChain.masterKeyID, key))\n-            throw std::runtime_error(std::string(__func__) + \": Master key not found\");\n-\n-        masterKey.SetMaster(key.begin(), key.size());\n-\n-        // derive m/0'\n-        // use hardened derivation (child keys >= 0x80000000 are hardened after bip32)\n-        masterKey.Derive(accountKey, BIP32_HARDENED_KEY_LIMIT);\n-\n-        // derive m/0'/0'\n-        accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT);\n-\n-        // derive child key at next index, skip keys already known to the wallet\n-        do\n-        {\n-            // always derive hardened keys\n-            // childIndex | BIP32_HARDENED_KEY_LIMIT = derive childIndex in hardened child-index-range\n-            // example: 1 | BIP32_HARDENED_KEY_LIMIT == 0x80000001 == 2147483649\n-            externalChainChildKey.Derive(childKey, hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n-            metadata.hdKeypath     = \"m/0'/0'/\"+std::to_string(hdChain.nExternalChainCounter)+\"'\";\n-            metadata.hdMasterKeyID = hdChain.masterKeyID;\n-            // increment childkey index\n-            hdChain.nExternalChainCounter++;\n-        } while(HaveKey(childKey.key.GetPubKey().GetID()));\n-        secret = childKey.key;\n-\n-        // update the chain model in the database\n-        if (!CWalletDB(strWalletFile).WriteHDChain(hdChain))\n-            throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n+        DeriveNewChildKey(metadata, secret);\n     } else {\n         secret.MakeNewKey(fCompressed);\n     }\n@@ -157,6 +121,46 @@ CPubKey CWallet::GenerateNewKey()\n     return pubkey;\n }\n \n+void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret)\n+{\n+    // for now we use a fixed keypath scheme of m/0'/0'/k\n+    CKey key;                      //master key seed (256bit)\n+    CExtKey masterKey;             //hd master key\n+    CExtKey accountKey;            //key at m/0'\n+    CExtKey externalChainChildKey; //key at m/0'/0'\n+    CExtKey childKey;              //key at m/0'/0'/<n>'\n+\n+    // try to get the master key\n+    if (!GetKey(hdChain.masterKeyID, key))\n+        throw std::runtime_error(std::string(__func__) + \": Master key not found\");\n+\n+    masterKey.SetMaster(key.begin(), key.size());\n+\n+    // derive m/0'\n+    // use hardened derivation (child keys >= 0x80000000 are hardened after bip32)\n+    masterKey.Derive(accountKey, BIP32_HARDENED_KEY_LIMIT);\n+\n+    // derive m/0'/0'\n+    accountKey.Derive(externalChainChildKey, BIP32_HARDENED_KEY_LIMIT);\n+\n+    // derive child key at next index, skip keys already known to the wallet\n+    do {\n+        // always derive hardened keys\n+        // childIndex | BIP32_HARDENED_KEY_LIMIT = derive childIndex in hardened child-index-range\n+        // example: 1 | BIP32_HARDENED_KEY_LIMIT == 0x80000001 == 2147483649\n+        externalChainChildKey.Derive(childKey, hdChain.nExternalChainCounter | BIP32_HARDENED_KEY_LIMIT);\n+        metadata.hdKeypath = \"m/0'/0'/\" + std::to_string(hdChain.nExternalChainCounter) + \"'\";\n+        metadata.hdMasterKeyID = hdChain.masterKeyID;\n+        // increment childkey index\n+        hdChain.nExternalChainCounter++;\n+    } while (HaveKey(childKey.key.GetPubKey().GetID()));\n+    secret = childKey.key;\n+\n+    // update the chain model in the database\n+    if (!CWalletDB(strWalletFile).WriteHDChain(hdChain))\n+        throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n+}\n+\n bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata"
      },
      {
        "sha": "077edcab2daa9b23e09f7dbf57536e4c34509355",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e198c521d39bb0ec17f42dfe72026969984af2c7/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e198c521d39bb0ec17f42dfe72026969984af2c7/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=e198c521d39bb0ec17f42dfe72026969984af2c7",
        "patch": "@@ -698,6 +698,7 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n      * Generate a new key\n      */\n     CPubKey GenerateNewKey();\n+    void DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret);\n     //! Adds a key to the store, and saves it to disk.\n     bool AddKeyPubKey(const CKey& key, const CPubKey &pubkey);\n     //! Adds a key to the store, without saving it to disk (used by LoadWallet)"
      }
    ]
  }
]