[
  {
    "sha": "93d1aa9abc4402715f781db2bc26bdde4447e951",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5M2QxYWE5YWJjNDQwMjcxNWY3ODFkYjJiYzI2YmRkZTQ0NDdlOTUx",
    "commit": {
      "author": {
        "name": "whythat",
        "email": "whythat@protonmail.com",
        "date": "2018-10-05T21:24:06Z"
      },
      "committer": {
        "name": "whythat",
        "email": "whythat@protonmail.com",
        "date": "2018-10-13T16:30:13Z"
      },
      "message": "rpcwallet: add 'ischange' field to 'getaddressinfo' response",
      "tree": {
        "sha": "30a929c15431a127d60b0603b9b4909849db70b3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/30a929c15431a127d60b0603b9b4909849db70b3"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/93d1aa9abc4402715f781db2bc26bdde4447e951",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/93d1aa9abc4402715f781db2bc26bdde4447e951",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/93d1aa9abc4402715f781db2bc26bdde4447e951",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/93d1aa9abc4402715f781db2bc26bdde4447e951/comments",
    "author": {
      "login": "rodentrabies",
      "id": 7646953,
      "node_id": "MDQ6VXNlcjc2NDY5NTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7646953?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rodentrabies",
      "html_url": "https://github.com/rodentrabies",
      "followers_url": "https://api.github.com/users/rodentrabies/followers",
      "following_url": "https://api.github.com/users/rodentrabies/following{/other_user}",
      "gists_url": "https://api.github.com/users/rodentrabies/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rodentrabies/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rodentrabies/subscriptions",
      "organizations_url": "https://api.github.com/users/rodentrabies/orgs",
      "repos_url": "https://api.github.com/users/rodentrabies/repos",
      "events_url": "https://api.github.com/users/rodentrabies/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rodentrabies/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rodentrabies",
      "id": 7646953,
      "node_id": "MDQ6VXNlcjc2NDY5NTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7646953?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rodentrabies",
      "html_url": "https://github.com/rodentrabies",
      "followers_url": "https://api.github.com/users/rodentrabies/followers",
      "following_url": "https://api.github.com/users/rodentrabies/following{/other_user}",
      "gists_url": "https://api.github.com/users/rodentrabies/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rodentrabies/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rodentrabies/subscriptions",
      "organizations_url": "https://api.github.com/users/rodentrabies/orgs",
      "repos_url": "https://api.github.com/users/rodentrabies/repos",
      "events_url": "https://api.github.com/users/rodentrabies/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rodentrabies/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f504a1402afd0760e9d348ecc8bad0094aa7d705",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f504a1402afd0760e9d348ecc8bad0094aa7d705",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f504a1402afd0760e9d348ecc8bad0094aa7d705"
      }
    ],
    "stats": {
      "total": 15,
      "additions": 13,
      "deletions": 2
    },
    "files": [
      {
        "sha": "900ca04324d3d4eddbbf5a58856e9315ddaa764e",
        "filename": "doc/release-notes-14282.md",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/93d1aa9abc4402715f781db2bc26bdde4447e951/doc/release-notes-14282.md",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/93d1aa9abc4402715f781db2bc26bdde4447e951/doc/release-notes-14282.md",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/doc/release-notes-14282.md?ref=93d1aa9abc4402715f781db2bc26bdde4447e951",
        "patch": "@@ -4,3 +4,6 @@ Low-level RPC changes\n `-usehd` was removed in version 0.16. From that version onwards, all new\n wallets created are hierarchical deterministic wallets. Version 0.18 makes\n specifying `-usehd` invalid config.\n+\n+`ischange` field of boolean type that shows if an address was used for change\n+output was added to `getaddressinfo` method response."
      },
      {
        "sha": "00c809740c4ed2b9bb79d1494ae5831d2f8b3b33",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/93d1aa9abc4402715f781db2bc26bdde4447e951/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/93d1aa9abc4402715f781db2bc26bdde4447e951/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=93d1aa9abc4402715f781db2bc26bdde4447e951",
        "patch": "@@ -3540,6 +3540,7 @@ UniValue getaddressinfo(const JSONRPCRequest& request)\n             \"  \\\"ismine\\\" : true|false,        (boolean) If the address is yours or not\\n\"\n             \"  \\\"iswatchonly\\\" : true|false,   (boolean) If the address is watchonly\\n\"\n             \"  \\\"isscript\\\" : true|false,      (boolean) If the key is a script\\n\"\n+            \"  \\\"ischange\\\" : true|false,      (boolean) If the address was used for change output\\n\"\n             \"  \\\"iswitness\\\" : true|false,     (boolean) If the address is a witness address\\n\"\n             \"  \\\"witness_version\\\" : version   (numeric, optional) The version number of the witness program\\n\"\n             \"  \\\"witness_program\\\" : \\\"hex\\\"     (string, optional) The hex value of the witness program\\n\"\n@@ -3597,6 +3598,7 @@ UniValue getaddressinfo(const JSONRPCRequest& request)\n     if (pwallet->mapAddressBook.count(dest)) {\n         ret.pushKV(\"label\", pwallet->mapAddressBook[dest].name);\n     }\n+    ret.pushKV(\"ischange\", pwallet->IsChange(scriptPubKey));\n     const CKeyMetadata* meta = nullptr;\n     CKeyID key_id = GetKeyForDestination(*pwallet, dest);\n     if (!key_id.IsNull()) {"
      },
      {
        "sha": "f37aa3211bc594f00213472ae03e9feba555e7c2",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 2,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/93d1aa9abc4402715f781db2bc26bdde4447e951/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/93d1aa9abc4402715f781db2bc26bdde4447e951/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=93d1aa9abc4402715f781db2bc26bdde4447e951",
        "patch": "@@ -1261,6 +1261,11 @@ CAmount CWallet::GetCredit(const CTxOut& txout, const isminefilter& filter) cons\n }\n \n bool CWallet::IsChange(const CTxOut& txout) const\n+{\n+    return IsChange(txout.scriptPubKey);\n+}\n+\n+bool CWallet::IsChange(const CScript& script) const\n {\n     // TODO: fix handling of 'change' outputs. The assumption is that any\n     // payment to a script that is ours, but is not in the address book\n@@ -1269,10 +1274,10 @@ bool CWallet::IsChange(const CTxOut& txout) const\n     // a better way of identifying which outputs are 'the send' and which are\n     // 'the change' will need to be implemented (maybe extend CWalletTx to remember\n     // which output, if any, was change).\n-    if (::IsMine(*this, txout.scriptPubKey))\n+    if (::IsMine(*this, script))\n     {\n         CTxDestination address;\n-        if (!ExtractDestination(txout.scriptPubKey, address))\n+        if (!ExtractDestination(script, address))\n             return true;\n \n         LOCK(cs_wallet);"
      },
      {
        "sha": "64740fd82e7e4d5c69341d8a54ec279b90ee04b8",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/93d1aa9abc4402715f781db2bc26bdde4447e951/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/93d1aa9abc4402715f781db2bc26bdde4447e951/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=93d1aa9abc4402715f781db2bc26bdde4447e951",
        "patch": "@@ -961,6 +961,7 @@ class CWallet final : public CCryptoKeyStore, public CValidationInterface\n     isminetype IsMine(const CTxOut& txout) const;\n     CAmount GetCredit(const CTxOut& txout, const isminefilter& filter) const;\n     bool IsChange(const CTxOut& txout) const;\n+    bool IsChange(const CScript& script) const;\n     CAmount GetChange(const CTxOut& txout) const;\n     bool IsMine(const CTransaction& tx) const;\n     /** should probably be renamed to IsRelevantToMe */"
      }
    ]
  },
  {
    "sha": "14a06525b2ed41d9a549e744019c06afeef9b0c5",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxNGEwNjUyNWIyZWQ0MWQ5YTU0OWU3NDQwMTljMDZhZmVlZjliMGM1",
    "commit": {
      "author": {
        "name": "whythat",
        "email": "whythat@protonmail.com",
        "date": "2018-10-12T08:57:22Z"
      },
      "committer": {
        "name": "whythat",
        "email": "whythat@protonmail.com",
        "date": "2018-10-13T16:37:44Z"
      },
      "message": "tests: add test for 'getaddressinfo' RPC result 'ischange' field",
      "tree": {
        "sha": "8b44c9da22c55913313aabd0605a69df82d3ba33",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8b44c9da22c55913313aabd0605a69df82d3ba33"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/14a06525b2ed41d9a549e744019c06afeef9b0c5",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/14a06525b2ed41d9a549e744019c06afeef9b0c5",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/14a06525b2ed41d9a549e744019c06afeef9b0c5",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/14a06525b2ed41d9a549e744019c06afeef9b0c5/comments",
    "author": {
      "login": "rodentrabies",
      "id": 7646953,
      "node_id": "MDQ6VXNlcjc2NDY5NTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7646953?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rodentrabies",
      "html_url": "https://github.com/rodentrabies",
      "followers_url": "https://api.github.com/users/rodentrabies/followers",
      "following_url": "https://api.github.com/users/rodentrabies/following{/other_user}",
      "gists_url": "https://api.github.com/users/rodentrabies/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rodentrabies/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rodentrabies/subscriptions",
      "organizations_url": "https://api.github.com/users/rodentrabies/orgs",
      "repos_url": "https://api.github.com/users/rodentrabies/repos",
      "events_url": "https://api.github.com/users/rodentrabies/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rodentrabies/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rodentrabies",
      "id": 7646953,
      "node_id": "MDQ6VXNlcjc2NDY5NTM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7646953?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rodentrabies",
      "html_url": "https://github.com/rodentrabies",
      "followers_url": "https://api.github.com/users/rodentrabies/followers",
      "following_url": "https://api.github.com/users/rodentrabies/following{/other_user}",
      "gists_url": "https://api.github.com/users/rodentrabies/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rodentrabies/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rodentrabies/subscriptions",
      "organizations_url": "https://api.github.com/users/rodentrabies/orgs",
      "repos_url": "https://api.github.com/users/rodentrabies/repos",
      "events_url": "https://api.github.com/users/rodentrabies/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rodentrabies/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "93d1aa9abc4402715f781db2bc26bdde4447e951",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/93d1aa9abc4402715f781db2bc26bdde4447e951",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/93d1aa9abc4402715f781db2bc26bdde4447e951"
      }
    ],
    "stats": {
      "total": 18,
      "additions": 17,
      "deletions": 1
    },
    "files": [
      {
        "sha": "09e03fa7873c659f18887e391c62201c36190267",
        "filename": "test/functional/wallet_basic.py",
        "status": "modified",
        "additions": 17,
        "deletions": 1,
        "changes": 18,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/14a06525b2ed41d9a549e744019c06afeef9b0c5/test/functional/wallet_basic.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/14a06525b2ed41d9a549e744019c06afeef9b0c5/test/functional/wallet_basic.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/wallet_basic.py?ref=14a06525b2ed41d9a549e744019c06afeef9b0c5",
        "patch": "@@ -479,14 +479,30 @@ def run_test(self):\n         # Verify nothing new in wallet\n         assert_equal(total_txs, len(self.nodes[0].listtransactions(\"*\", 99999)))\n \n-        # Test getaddressinfo. Note that these addresses are taken from disablewallet.py\n+        # Test getaddressinfo on external address. Note that these addresses are taken from disablewallet.py\n         assert_raises_rpc_error(-5, \"Invalid address\", self.nodes[0].getaddressinfo, \"3J98t1WpEZ73CNmQviecrnyiWrnqRhWNLy\")\n         address_info = self.nodes[0].getaddressinfo(\"mneYUmWYsuk7kySiURxCi3AGxrAqZxLgPZ\")\n         assert_equal(address_info['address'], \"mneYUmWYsuk7kySiURxCi3AGxrAqZxLgPZ\")\n         assert_equal(address_info[\"scriptPubKey\"], \"76a9144e3854046c7bd1594ac904e4793b6a45b36dea0988ac\")\n         assert not address_info[\"ismine\"]\n         assert not address_info[\"iswatchonly\"]\n         assert not address_info[\"isscript\"]\n+        assert not address_info[\"ischange\"]\n+\n+        # Test getaddressinfo 'ischange' field on change address.\n+        self.nodes[0].generate(1)\n+        destination = self.nodes[1].getnewaddress()\n+        txid = self.nodes[0].sendtoaddress(destination, 0.123)\n+        tx = self.nodes[0].decoderawtransaction(self.nodes[0].getrawtransaction(txid))\n+        output_addresses = [vout['scriptPubKey']['addresses'][0] for vout in tx[\"vout\"]]\n+        assert len(output_addresses) > 1\n+        for address in output_addresses:\n+            ischange = self.nodes[0].getaddressinfo(address)['ischange']\n+            assert_equal(ischange, address != destination)\n+            if ischange:\n+                change = address\n+        self.nodes[0].setlabel(change, 'foobar')\n+        assert_equal(self.nodes[0].getaddressinfo(change)['ischange'], False)\n \n if __name__ == '__main__':\n     WalletTest().main()"
      }
    ]
  }
]