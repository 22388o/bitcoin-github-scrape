[
  {
    "sha": "e7ad1768fe7e130cd4dddeb902216f4a8ca6f339",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplN2FkMTc2OGZlN2UxMzBjZDRkZGRlYjkwMjIxNmY0YThjYTZmMzM5",
    "commit": {
      "author": {
        "name": "tecnovert",
        "email": "tecnovert@particl.io",
        "date": "2018-07-07T18:46:26Z"
      },
      "committer": {
        "name": "tecnovert",
        "email": "tecnovert@particl.io",
        "date": "2018-07-07T18:50:00Z"
      },
      "message": "Avoid calling tryGetBalances in pollBalanceChanged if the result won't be used.\ngetBalances takes significant processing if the wallet has many transactions.",
      "tree": {
        "sha": "3d2ce5224e427d4cb076e28e9dda7d109704591a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3d2ce5224e427d4cb076e28e9dda7d109704591a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e7ad1768fe7e130cd4dddeb902216f4a8ca6f339",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEjlF9wS7BzDf2QjqKE/E2UcnPDWsFAltBC1gACgkQE/E2UcnP\nDWu5Ag//W4Xu3d1OxSORDHLlWBurmyMbSaWU4GKwn0JSnJNeqqkWbH/8WEYW5LPA\nHNMw+BnueVgH1XFnbKTMuCXxKRHaAkpOV74ey4uJVERaxwiQwZZeBH3N1jCDNsz8\n8Ec7pJ3nG1mxBaRfcCPgnc0CrYF0meIupK2s4lSkukCZ3/RBLez+662IQLk4ea8S\n/aIIITiXhqixfG+Z1y5tgBvaDnPsD4rB5m49prDFzcWs1QNRPDWVXNHr2K5vZu4W\nV35EzN7KVFpYa9i9STIRnvxfkMIT/nAG3fArkJk0Uh0fVgIIO5SjljrIwZKinPL0\nhQ1TiKjD05D3uA/F7D4CRkb6GTpW+MNOgQRP1cKGb1d4AD923Qcmp1ozne2rdBrK\nXqAiUhWtMUuNK6f4+n65OsYsX+vsjTnf2M+gBELUd7xCkK4loG1I3Y4up6FW2472\nV83DC3zvYUV60nVtmLHMxmOky3oihuLoGFmbYoae7kDZt5gHiMresG0Bwaxu/W7N\nnttCZin+mZ1fjsJYwgW5UeI7DpEzqnQJCxavh5cjFXBORur7sjzXYV1Bwdt/7rDG\nVDVy+a/17TfVKfN+KOTTPFLqGMgRjexD+nOdwHoyEa8kaCgBkbVePor6IbyPerBv\ncRFJNyKCtj4ztoW0XgiqYuWPzJ3mWjAkIaJNOjEnzolus6LL0W8=\n=etgC\n-----END PGP SIGNATURE-----",
        "payload": "tree 3d2ce5224e427d4cb076e28e9dda7d109704591a\nparent 88a15ebc8d317a6fd4851adb344ff944d497284c\nauthor tecnovert <tecnovert@particl.io> 1530989186 +0200\ncommitter tecnovert <tecnovert@particl.io> 1530989400 +0200\n\nAvoid calling tryGetBalances in pollBalanceChanged if the result won't be used.\ngetBalances takes significant processing if the wallet has many transactions.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e7ad1768fe7e130cd4dddeb902216f4a8ca6f339",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e7ad1768fe7e130cd4dddeb902216f4a8ca6f339",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e7ad1768fe7e130cd4dddeb902216f4a8ca6f339/comments",
    "author": {
      "login": "tecnovert",
      "id": 8041488,
      "node_id": "MDQ6VXNlcjgwNDE0ODg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8041488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tecnovert",
      "html_url": "https://github.com/tecnovert",
      "followers_url": "https://api.github.com/users/tecnovert/followers",
      "following_url": "https://api.github.com/users/tecnovert/following{/other_user}",
      "gists_url": "https://api.github.com/users/tecnovert/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tecnovert/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tecnovert/subscriptions",
      "organizations_url": "https://api.github.com/users/tecnovert/orgs",
      "repos_url": "https://api.github.com/users/tecnovert/repos",
      "events_url": "https://api.github.com/users/tecnovert/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tecnovert/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "tecnovert",
      "id": 8041488,
      "node_id": "MDQ6VXNlcjgwNDE0ODg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8041488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tecnovert",
      "html_url": "https://github.com/tecnovert",
      "followers_url": "https://api.github.com/users/tecnovert/followers",
      "following_url": "https://api.github.com/users/tecnovert/following{/other_user}",
      "gists_url": "https://api.github.com/users/tecnovert/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tecnovert/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tecnovert/subscriptions",
      "organizations_url": "https://api.github.com/users/tecnovert/orgs",
      "repos_url": "https://api.github.com/users/tecnovert/repos",
      "events_url": "https://api.github.com/users/tecnovert/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tecnovert/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "88a15ebc8d317a6fd4851adb344ff944d497284c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/88a15ebc8d317a6fd4851adb344ff944d497284c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/88a15ebc8d317a6fd4851adb344ff944d497284c"
      }
    ],
    "stats": {
      "total": 21,
      "additions": 10,
      "deletions": 11
    },
    "files": [
      {
        "sha": "56cafb3fe48d736de2cebc4988f81edf20fa8ca3",
        "filename": "src/qt/walletmodel.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 11,
        "changes": 21,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e7ad1768fe7e130cd4dddeb902216f4a8ca6f339/src/qt/walletmodel.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e7ad1768fe7e130cd4dddeb902216f4a8ca6f339/src/qt/walletmodel.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/walletmodel.cpp?ref=e7ad1768fe7e130cd4dddeb902216f4a8ca6f339",
        "patch": "@@ -66,18 +66,17 @@ void WalletModel::updateStatus()\n \n void WalletModel::pollBalanceChanged()\n {\n-    // Try to get balances and return early if locks can't be acquired. This\n-    // avoids the GUI from getting stuck on periodical polls if the core is\n-    // holding the locks for a longer time - for example, during a wallet\n-    // rescan.\n-    interfaces::WalletBalances new_balances;\n-    int numBlocks = -1;\n-    if (!m_wallet->tryGetBalances(new_balances, numBlocks)) {\n-        return;\n-    }\n+    if (fForceCheckBalanceChanged || m_node.getNumBlocks() != cachedNumBlocks) {\n+        // Try to get balances and return early if locks can't be acquired. This\n+        // avoids the GUI from getting stuck on periodical polls if the core is\n+        // holding the locks for a longer time - for example, during a wallet\n+        // rescan.\n+        interfaces::WalletBalances new_balances;\n+        int numBlocks = -1;\n+        if (!m_wallet->tryGetBalances(new_balances, numBlocks)) {\n+            return;\n+        }\n \n-    if(fForceCheckBalanceChanged || m_node.getNumBlocks() != cachedNumBlocks)\n-    {\n         fForceCheckBalanceChanged = false;\n \n         // Balance and number of transactions might have changed"
      }
    ]
  },
  {
    "sha": "899d8f68a09d57d579b81a7e1d721a51e8c611bf",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4OTlkOGY2OGEwOWQ1N2Q1NzliODFhN2UxZDcyMWE1MWU4YzYxMWJm",
    "commit": {
      "author": {
        "name": "tecnovert",
        "email": "tecnovert@particl.io",
        "date": "2018-07-08T09:56:50Z"
      },
      "committer": {
        "name": "tecnovert",
        "email": "tecnovert@particl.io",
        "date": "2018-07-08T13:02:13Z"
      },
      "message": "Rearranged so TRY_LOCK is called first.\nThe LOCK in getNumBlocks shouldn't be run before the TRY_LOCK in\ntryGetBalances\nThe neatest fix seems to be to move the height check into tryGetBalances.",
      "tree": {
        "sha": "86893cd0dc405e76192ffa82078ec1f1dc52f02e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/86893cd0dc405e76192ffa82078ec1f1dc52f02e"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/899d8f68a09d57d579b81a7e1d721a51e8c611bf",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/899d8f68a09d57d579b81a7e1d721a51e8c611bf",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/899d8f68a09d57d579b81a7e1d721a51e8c611bf",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/899d8f68a09d57d579b81a7e1d721a51e8c611bf/comments",
    "author": {
      "login": "tecnovert",
      "id": 8041488,
      "node_id": "MDQ6VXNlcjgwNDE0ODg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8041488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tecnovert",
      "html_url": "https://github.com/tecnovert",
      "followers_url": "https://api.github.com/users/tecnovert/followers",
      "following_url": "https://api.github.com/users/tecnovert/following{/other_user}",
      "gists_url": "https://api.github.com/users/tecnovert/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tecnovert/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tecnovert/subscriptions",
      "organizations_url": "https://api.github.com/users/tecnovert/orgs",
      "repos_url": "https://api.github.com/users/tecnovert/repos",
      "events_url": "https://api.github.com/users/tecnovert/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tecnovert/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "tecnovert",
      "id": 8041488,
      "node_id": "MDQ6VXNlcjgwNDE0ODg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8041488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/tecnovert",
      "html_url": "https://github.com/tecnovert",
      "followers_url": "https://api.github.com/users/tecnovert/followers",
      "following_url": "https://api.github.com/users/tecnovert/following{/other_user}",
      "gists_url": "https://api.github.com/users/tecnovert/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/tecnovert/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/tecnovert/subscriptions",
      "organizations_url": "https://api.github.com/users/tecnovert/orgs",
      "repos_url": "https://api.github.com/users/tecnovert/repos",
      "events_url": "https://api.github.com/users/tecnovert/events{/privacy}",
      "received_events_url": "https://api.github.com/users/tecnovert/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e7ad1768fe7e130cd4dddeb902216f4a8ca6f339",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e7ad1768fe7e130cd4dddeb902216f4a8ca6f339",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e7ad1768fe7e130cd4dddeb902216f4a8ca6f339"
      }
    ],
    "stats": {
      "total": 51,
      "additions": 28,
      "deletions": 23
    },
    "files": [
      {
        "sha": "cf70ea7f2f1fabce0aca5becabf3c19f6bbe624b",
        "filename": "src/interfaces/wallet.cpp",
        "status": "modified",
        "additions": 11,
        "deletions": 3,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/899d8f68a09d57d579b81a7e1d721a51e8c611bf/src/interfaces/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/899d8f68a09d57d579b81a7e1d721a51e8c611bf/src/interfaces/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/interfaces/wallet.cpp?ref=899d8f68a09d57d579b81a7e1d721a51e8c611bf",
        "patch": "@@ -345,16 +345,24 @@ class WalletImpl : public Wallet\n         }\n         return result;\n     }\n-    bool tryGetBalances(WalletBalances& balances, int& num_blocks) override\n+    bool tryGetBalances(WalletBalances& balances, bool skip_height_check, int cached_blocks, int& num_blocks) override\n     {\n         TRY_LOCK(cs_main, locked_chain);\n-        if (!locked_chain) return false;\n+        if (!locked_chain) {\n+            return false;\n+        }\n+\n+        num_blocks = ::chainActive.Height();\n+        if (!skip_height_check && num_blocks == cached_blocks) {\n+            return false;\n+        }\n+\n         TRY_LOCK(m_wallet.cs_wallet, locked_wallet);\n         if (!locked_wallet) {\n             return false;\n         }\n         balances = getBalances();\n-        num_blocks = ::chainActive.Height();\n+\n         return true;\n     }\n     CAmount getBalance() override { return m_wallet.GetBalance(); }"
      },
      {
        "sha": "f2ed883a03ff9787ea2afd16de416cae0731b9b9",
        "filename": "src/interfaces/wallet.h",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/899d8f68a09d57d579b81a7e1d721a51e8c611bf/src/interfaces/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/899d8f68a09d57d579b81a7e1d721a51e8c611bf/src/interfaces/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/interfaces/wallet.h?ref=899d8f68a09d57d579b81a7e1d721a51e8c611bf",
        "patch": "@@ -192,8 +192,8 @@ class Wallet\n     //! Get balances.\n     virtual WalletBalances getBalances() = 0;\n \n-    //! Get balances if possible without blocking.\n-    virtual bool tryGetBalances(WalletBalances& balances, int& num_blocks) = 0;\n+    //! Get balances if cached_blocks != num_blocks and if possible without blocking.\n+    virtual bool tryGetBalances(WalletBalances& balances, bool skip_height_check, int cached_blocks, int& num_blocks) = 0;\n \n     //! Get balance.\n     virtual CAmount getBalance() = 0;"
      },
      {
        "sha": "029eba3c8ff688ec9a2f7c9ccb1e19919397add4",
        "filename": "src/qt/walletmodel.cpp",
        "status": "modified",
        "additions": 15,
        "deletions": 18,
        "changes": 33,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/899d8f68a09d57d579b81a7e1d721a51e8c611bf/src/qt/walletmodel.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/899d8f68a09d57d579b81a7e1d721a51e8c611bf/src/qt/walletmodel.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/walletmodel.cpp?ref=899d8f68a09d57d579b81a7e1d721a51e8c611bf",
        "patch": "@@ -66,25 +66,22 @@ void WalletModel::updateStatus()\n \n void WalletModel::pollBalanceChanged()\n {\n-    if (fForceCheckBalanceChanged || m_node.getNumBlocks() != cachedNumBlocks) {\n-        // Try to get balances and return early if locks can't be acquired. This\n-        // avoids the GUI from getting stuck on periodical polls if the core is\n-        // holding the locks for a longer time - for example, during a wallet\n-        // rescan.\n-        interfaces::WalletBalances new_balances;\n-        int numBlocks = -1;\n-        if (!m_wallet->tryGetBalances(new_balances, numBlocks)) {\n-            return;\n-        }\n-\n-        fForceCheckBalanceChanged = false;\n-\n-        // Balance and number of transactions might have changed\n-        cachedNumBlocks = m_node.getNumBlocks();\n+    interfaces::WalletBalances new_balances;\n+    int numBlocks = -1;\n+\n+    // Try to get balances and return early if locks can't be acquired. This\n+    // avoids the GUI from getting stuck on periodical polls if the core is\n+    // holding the locks for a longer time - for example, during a wallet\n+    // rescan.\n+    if (!m_wallet->tryGetBalances(new_balances, fForceCheckBalanceChanged, cachedNumBlocks, numBlocks)) {\n+        return;\n+    }\n+    fForceCheckBalanceChanged = false;\n \n-        checkBalanceChanged(new_balances);\n-        if(transactionTableModel)\n-            transactionTableModel->updateConfirmations();\n+    checkBalanceChanged(new_balances);\n+    cachedNumBlocks = numBlocks;\n+    if (transactionTableModel) {\n+        transactionTableModel->updateConfirmations();\n     }\n }\n "
      }
    ]
  }
]