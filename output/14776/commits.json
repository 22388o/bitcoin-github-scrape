[
  {
    "sha": "e2779a07e0b1efefc27fa4d33e2c62eacf8847a1",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplMjc3OWEwN2UwYjFlZmVmYzI3ZmE0ZDMzZTJjNjJlYWNmODg0N2Ex",
    "commit": {
      "author": {
        "name": "James Hilliard",
        "email": "james.hilliard1@gmail.com",
        "date": "2018-11-21T06:40:43Z"
      },
      "committer": {
        "name": "James Hilliard",
        "email": "james.hilliard1@gmail.com",
        "date": "2018-11-21T09:01:47Z"
      },
      "message": "Add process based prctl spectre mitigation controls.",
      "tree": {
        "sha": "46ff95d545b2672eec8bddc034fc21431fd53844",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/46ff95d545b2672eec8bddc034fc21431fd53844"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e2779a07e0b1efefc27fa4d33e2c62eacf8847a1",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e2779a07e0b1efefc27fa4d33e2c62eacf8847a1",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e2779a07e0b1efefc27fa4d33e2c62eacf8847a1",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e2779a07e0b1efefc27fa4d33e2c62eacf8847a1/comments",
    "author": {
      "login": "jameshilliard",
      "id": 3298484,
      "node_id": "MDQ6VXNlcjMyOTg0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3298484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jameshilliard",
      "html_url": "https://github.com/jameshilliard",
      "followers_url": "https://api.github.com/users/jameshilliard/followers",
      "following_url": "https://api.github.com/users/jameshilliard/following{/other_user}",
      "gists_url": "https://api.github.com/users/jameshilliard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jameshilliard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jameshilliard/subscriptions",
      "organizations_url": "https://api.github.com/users/jameshilliard/orgs",
      "repos_url": "https://api.github.com/users/jameshilliard/repos",
      "events_url": "https://api.github.com/users/jameshilliard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jameshilliard/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jameshilliard",
      "id": 3298484,
      "node_id": "MDQ6VXNlcjMyOTg0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3298484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jameshilliard",
      "html_url": "https://github.com/jameshilliard",
      "followers_url": "https://api.github.com/users/jameshilliard/followers",
      "following_url": "https://api.github.com/users/jameshilliard/following{/other_user}",
      "gists_url": "https://api.github.com/users/jameshilliard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jameshilliard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jameshilliard/subscriptions",
      "organizations_url": "https://api.github.com/users/jameshilliard/orgs",
      "repos_url": "https://api.github.com/users/jameshilliard/repos",
      "events_url": "https://api.github.com/users/jameshilliard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jameshilliard/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6b90a2a0e06548b5c30a160fe76351a44fe3f861",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6b90a2a0e06548b5c30a160fe76351a44fe3f861",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6b90a2a0e06548b5c30a160fe76351a44fe3f861"
      }
    ],
    "stats": {
      "total": 79,
      "additions": 79,
      "deletions": 0
    },
    "files": [
      {
        "sha": "b206040545107b37e37dd0f4e25f781333da36a7",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 0,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e2779a07e0b1efefc27fa4d33e2c62eacf8847a1/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e2779a07e0b1efefc27fa4d33e2c62eacf8847a1/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=e2779a07e0b1efefc27fa4d33e2c62eacf8847a1",
        "patch": "@@ -358,6 +358,13 @@ void SetupServerArgs()\n     gArgs.AddArg(\"-minimumchainwork=<hex>\", strprintf(\"Minimum work assumed to exist on a valid chain in hex (default: %s, testnet: %s)\", defaultChainParams->GetConsensus().nMinimumChainWork.GetHex(), testnetChainParams->GetConsensus().nMinimumChainWork.GetHex()), true, OptionsCategory::OPTIONS);\n     gArgs.AddArg(\"-par=<n>\", strprintf(\"Set the number of script verification threads (%u to %d, 0 = auto, <0 = leave that many cores free, default: %d)\",\n         -GetNumCores(), MAX_SCRIPTCHECK_THREADS, DEFAULT_SCRIPTCHECK_THREADS), false, OptionsCategory::OPTIONS);\n+    gArgs.AddArg(\"-mitigatespectre\", strprintf(\"Attempt to enable per process spectre mitigations (default: %u%s)\", DEFAULT_MITIGATE_SPECTRE, (\n+#ifdef ENABLE_WALLET\n+    \" or 0 if -disablewallet set\"\n+#else\n+    \"\"\n+#endif\n+    )), true, OptionsCategory::OPTIONS);\n     gArgs.AddArg(\"-persistmempool\", strprintf(\"Whether to save the mempool on shutdown and load on restart (default: %u)\", DEFAULT_PERSIST_MEMPOOL), false, OptionsCategory::OPTIONS);\n #ifndef WIN32\n     gArgs.AddArg(\"-pid=<file>\", strprintf(\"Specify pid file. Relative paths will be prefixed by a net-specific datadir location. (default: %s)\", BITCOIN_PID_FILENAME), false, OptionsCategory::OPTIONS);\n@@ -888,6 +895,9 @@ bool AppInitBasicSetup()\n     if (setProcDEPPol != nullptr) setProcDEPPol(PROCESS_DEP_ENABLE);\n #endif\n \n+    bool mitigatespectre_default = !gArgs.GetBoolArg(\"-disablewallet\", false) && DEFAULT_MITIGATE_SPECTRE;\n+    SpectreMitigation(gArgs.GetBoolArg(\"-mitigatespectre\", mitigatespectre_default));\n+\n     if (!SetupNetworking())\n         return InitError(\"Initializing networking failed\");\n "
      },
      {
        "sha": "8bde0b002452e69e75e4b6ecbf68a22070b9ecaf",
        "filename": "src/util/system.cpp",
        "status": "modified",
        "additions": 63,
        "deletions": 0,
        "changes": 63,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e2779a07e0b1efefc27fa4d33e2c62eacf8847a1/src/util/system.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e2779a07e0b1efefc27fa4d33e2c62eacf8847a1/src/util/system.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/system.cpp?ref=e2779a07e0b1efefc27fa4d33e2c62eacf8847a1",
        "patch": "@@ -67,6 +67,31 @@\n \n #ifdef HAVE_SYS_PRCTL_H\n #include <sys/prctl.h>\n+// Set spectre prctl defines so that we can build on older kernels\n+#ifndef PR_GET_SPECULATION_CTRL\n+#define PR_GET_SPECULATION_CTRL 52\n+#endif\n+#ifndef PR_SET_SPECULATION_CTRL\n+#define PR_SET_SPECULATION_CTRL 53\n+#endif\n+#ifndef PR_SPEC_STORE_BYPASS\n+#define PR_SPEC_STORE_BYPASS 0\n+#endif\n+#ifndef PR_SPEC_NOT_AFFECTED\n+#define PR_SPEC_NOT_AFFECTED 0\n+#endif\n+#ifndef PR_SPEC_PRCTL\n+#define PR_SPEC_PRCTL (1UL << 0)\n+#endif\n+#ifndef PR_SPEC_ENABLE\n+#define PR_SPEC_ENABLE (1UL << 1)\n+#endif\n+#ifndef PR_SPEC_DISABLE\n+#define PR_SPEC_DISABLE (1UL << 2)\n+#endif\n+#ifndef PR_SPEC_FORCE_DISABLE\n+#define PR_SPEC_FORCE_DISABLE (1UL << 3)\n+#endif\n #endif\n \n #ifdef HAVE_MALLOPT_ARENA_MAX\n@@ -1186,6 +1211,44 @@ void RenameThread(const char* name)\n #endif\n }\n \n+void SpectreMitigation(bool enable)\n+{\n+#if defined(HAVE_SYS_PRCTL_H)\n+    int status = prctl(PR_GET_SPECULATION_CTRL, PR_SPEC_STORE_BYPASS, 0, 0, 0);\n+    if (status == -1) {\n+        LogPrintf(\"Kernel does not support per process spectre mitigation control: %s.\\n\", strerror(errno));\n+    } else if (status == PR_SPEC_NOT_AFFECTED) {\n+        LogPrintf(\"System is not affected by spectre.\\n\");\n+    } else if (status & PR_SPEC_DISABLE && enable) {\n+        LogPrintf(\"Spectre mitigation is already enabled.\\n\");\n+    } else if (status & PR_SPEC_ENABLE && !enable) {\n+        LogPrintf(\"Spectre mitigation is already disabled.\\n\");\n+    } else if (!(status & PR_SPEC_PRCTL) || status & PR_SPEC_FORCE_DISABLE) {\n+        if (status & PR_SPEC_DISABLE && !enable) {\n+            LogPrintf(\"Spectre mitigation is enabled and can not be disabled.\\n\");\n+        } else if (status & PR_SPEC_ENABLE && enable) {\n+            LogPrintf(\"Spectre mitigation is disabled and can not be enabled.\\n\");\n+        }\n+    } else if (status & PR_SPEC_PRCTL && status & PR_SPEC_DISABLE && !enable) {\n+        if (!prctl(PR_SET_SPECULATION_CTRL, PR_SPEC_STORE_BYPASS, PR_SPEC_ENABLE, 0, 0)) {\n+            LogPrintf(\"Failed to disable spectre mitigation: %s.\\n\", strerror(errno));\n+        } else {\n+            LogPrintf(\"Spectre mitigation has been disabled.\\n\");\n+        }\n+    } else if (status & PR_SPEC_PRCTL && status & PR_SPEC_ENABLE && enable) {\n+        if (!prctl(PR_SET_SPECULATION_CTRL, PR_SPEC_STORE_BYPASS, PR_SPEC_DISABLE, 0, 0)) {\n+            LogPrintf(\"Failed to enable spectre mitigation: %s.\\n\", strerror(errno));\n+        } else {\n+            LogPrintf(\"Spectre mitigation has been enabled.\\n\");\n+        }\n+    } else {\n+        LogPrintf(\"Spectre mitigation control returned status %d.\\n\", status);\n+    }\n+#else\n+    LogPrintf(\"Per process spectre mitigation control is not available on this platform.\\n\");\n+#endif\n+}\n+\n void SetupEnvironment()\n {\n #ifdef HAVE_MALLOPT_ARENA_MAX"
      },
      {
        "sha": "5cb82a1d10356636adbab14c3fb84f1da1270546",
        "filename": "src/util/system.h",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e2779a07e0b1efefc27fa4d33e2c62eacf8847a1/src/util/system.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e2779a07e0b1efefc27fa4d33e2c62eacf8847a1/src/util/system.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/system.h?ref=e2779a07e0b1efefc27fa4d33e2c62eacf8847a1",
        "patch": "@@ -40,6 +40,11 @@ int64_t GetStartupTime();\n \n extern const char * const BITCOIN_CONF_FILENAME;\n extern const char * const BITCOIN_PID_FILENAME;\n+#ifdef ENABLE_WALLET\n+static const bool DEFAULT_MITIGATE_SPECTRE = true;\n+#else\n+static const bool DEFAULT_MITIGATE_SPECTRE = false;\n+#endif\n \n /** Translate a message to the native language of the user. */\n const extern std::function<std::string(const char*)> G_TRANSLATION_FUN;\n@@ -53,6 +58,7 @@ inline std::string _(const char* psz)\n     return G_TRANSLATION_FUN ? (G_TRANSLATION_FUN)(psz) : psz;\n }\n \n+void SpectreMitigation(bool enable);\n void SetupEnvironment();\n bool SetupNetworking();\n "
      }
    ]
  }
]