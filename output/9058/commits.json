[
  {
    "sha": "47e9659ecfbe07077a4564591095bd5510e0f917",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0N2U5NjU5ZWNmYmUwNzA3N2E0NTY0NTkxMDk1YmQ1NTEwZTBmOTE3",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@chaincode.com",
        "date": "2016-10-24T19:33:14Z"
      },
      "committer": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2016-11-02T19:35:11Z"
      },
      "message": "[qa] Fix bug in compactblocks v2 merge\n\nBug caused the wait_for_block_announcement to be called on the wrong node,\nleading to nondeterminism and occasional test failures. Bug was introduced in\nmerge commit:\n\nd075479 Merge #8882: [qa] Fix race conditions in p2p-compactblocks.py and sendheaders.py\n\nUnderlying commits which conflicted were:\n\n27acfc1 [qa] Update p2p-compactblocks.py for compactblocks v2\n6976db2 [qa] Another attempt to fix race condition in p2p-compactblocks.py\n\nThe first commit changed the test_compactblock_construction function signature\nand second commit added code which wasn't updated during the merge to use the\nnew arguments.\n\nSuhas Daftuar <sdaftuar@chaincode.com> noticed the bug and suggested the fix.",
      "tree": {
        "sha": "753b4375529597fcaf5900bfb533a11c2989f47c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/753b4375529597fcaf5900bfb533a11c2989f47c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/47e9659ecfbe07077a4564591095bd5510e0f917",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/47e9659ecfbe07077a4564591095bd5510e0f917",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/47e9659ecfbe07077a4564591095bd5510e0f917",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/47e9659ecfbe07077a4564591095bd5510e0f917/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "273bde37d867d1f6ab67e22a65097b7adfc4831a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/273bde37d867d1f6ab67e22a65097b7adfc4831a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/273bde37d867d1f6ab67e22a65097b7adfc4831a"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 2,
      "deletions": 2
    },
    "files": [
      {
        "sha": "8a5f589d0fdda152bb4834f51d560af20e1e8a51",
        "filename": "qa/rpc-tests/p2p-compactblocks.py",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/47e9659ecfbe07077a4564591095bd5510e0f917/qa/rpc-tests/p2p-compactblocks.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/47e9659ecfbe07077a4564591095bd5510e0f917/qa/rpc-tests/p2p-compactblocks.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/p2p-compactblocks.py?ref=47e9659ecfbe07077a4564591095bd5510e0f917",
        "patch": "@@ -300,8 +300,8 @@ def test_compactblock_construction(self, node, test_node, version, use_witness_a\n             assert(segwit_tx_generated) # check that our test is not broken\n \n         # Wait until we've seen the block announcement for the resulting tip\n-        tip = int(self.nodes[0].getbestblockhash(), 16)\n-        assert(self.test_node.wait_for_block_announcement(tip))\n+        tip = int(node.getbestblockhash(), 16)\n+        assert(test_node.wait_for_block_announcement(tip))\n \n         # Now mine a block, and look at the resulting compact block.\n         test_node.clear_block_announcement()"
      }
    ]
  },
  {
    "sha": "55bfddcabbf9e8a3743f77167ba4a43aaba9f948",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1NWJmZGRjYWJiZjllOGEzNzQzZjc3MTY3YmE0YTQzYWFiYTlmOTQ4",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@chaincode.com",
        "date": "2016-10-26T18:15:16Z"
      },
      "committer": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2016-11-02T19:35:11Z"
      },
      "message": "[qa] Fix stale data bug in test_compactblocks_not_at_tip\n\nClear test_node.last_block before requesting blocks in the\ncompactblocks_not_at_tip test so comparisons won't fail if a blocks were received\nbefore the test started.\n\nThe bug doesn't currently cause any problems due to the order tests run, but\nthis will change in the next commit.",
      "tree": {
        "sha": "d3d5a521cb764a4e222ff2d517613779198ba220",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d3d5a521cb764a4e222ff2d517613779198ba220"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/55bfddcabbf9e8a3743f77167ba4a43aaba9f948",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/55bfddcabbf9e8a3743f77167ba4a43aaba9f948",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/55bfddcabbf9e8a3743f77167ba4a43aaba9f948",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/55bfddcabbf9e8a3743f77167ba4a43aaba9f948/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "47e9659ecfbe07077a4564591095bd5510e0f917",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/47e9659ecfbe07077a4564591095bd5510e0f917",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/47e9659ecfbe07077a4564591095bd5510e0f917"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 2,
      "deletions": 0
    },
    "files": [
      {
        "sha": "4b49dad03442c50d86483c7cba79e98d315c5d39",
        "filename": "qa/rpc-tests/p2p-compactblocks.py",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/55bfddcabbf9e8a3743f77167ba4a43aaba9f948/qa/rpc-tests/p2p-compactblocks.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/55bfddcabbf9e8a3743f77167ba4a43aaba9f948/qa/rpc-tests/p2p-compactblocks.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/p2p-compactblocks.py?ref=55bfddcabbf9e8a3743f77167ba4a43aaba9f948",
        "patch": "@@ -648,6 +648,8 @@ def test_compactblocks_not_at_tip(self, node, test_node):\n         node.generate(1)\n         wait_until(test_node.received_block_announcement, timeout=30)\n         test_node.clear_block_announcement()\n+        with mininode_lock:\n+            test_node.last_block = None\n         test_node.send_message(msg_getdata([CInv(4, int(new_blocks[0], 16))]))\n         success = wait_until(lambda: test_node.last_block is not None, timeout=30)\n         assert(success)"
      }
    ]
  },
  {
    "sha": "dac53b58b555183ccc0d5e64c428528267cd98b3",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkYWM1M2I1OGI1NTUxODNjY2MwZDVlNjRjNDI4NTI4MjY3Y2Q5OGIz",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@chaincode.com",
        "date": "2016-10-26T18:53:18Z"
      },
      "committer": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2016-11-07T19:35:11Z"
      },
      "message": "Modify getblocktxn handler not to drop requests for old blocks\n\nThe current getblocktxn implementation drops and ignores requests for old\nblocks, which causes occasional sync_block timeouts during the\np2p-compactblocks.py test as reported in\nhttps://github.com/bitcoin/bitcoin/issues/8842.\n\nThe p2p-compactblocks.py test setup creates many new blocks in a short\nperiod of time, which can lead to getblocktxn requests for blocks below the\nhardcoded depth limit of 10 blocks. This commit changes the getblocktxn\nhandler not to ignore these requests, so the peer nodes in the test setup\nwill reliably be able to sync.\n\nThe protocol change is documented in BIP-152 update \"Allow block responses\nto getblocktxn requests\" at https://github.com/bitcoin/bips/pull/469.\n\nThe protocol change is not expected to affect nodes running outside the test\nenvironment, because there shouldn't normally be lots of new blocks being\nrapidly added that need to be synced.",
      "tree": {
        "sha": "0b5679b91658ac1feb93dcedf6247fa61c04c0c6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0b5679b91658ac1feb93dcedf6247fa61c04c0c6"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/dac53b58b555183ccc0d5e64c428528267cd98b3",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dac53b58b555183ccc0d5e64c428528267cd98b3",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/dac53b58b555183ccc0d5e64c428528267cd98b3",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dac53b58b555183ccc0d5e64c428528267cd98b3/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "55bfddcabbf9e8a3743f77167ba4a43aaba9f948",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/55bfddcabbf9e8a3743f77167ba4a43aaba9f948",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/55bfddcabbf9e8a3743f77167ba4a43aaba9f948"
      }
    ],
    "stats": {
      "total": 24,
      "additions": 21,
      "deletions": 3
    },
    "files": [
      {
        "sha": "ecd1e42169d02d0cd62ae4eafad5f1a21b09fe34",
        "filename": "qa/rpc-tests/p2p-compactblocks.py",
        "status": "modified",
        "additions": 9,
        "deletions": 3,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dac53b58b555183ccc0d5e64c428528267cd98b3/qa/rpc-tests/p2p-compactblocks.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dac53b58b555183ccc0d5e64c428528267cd98b3/qa/rpc-tests/p2p-compactblocks.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/p2p-compactblocks.py?ref=dac53b58b555183ccc0d5e64c428528267cd98b3",
        "patch": "@@ -589,8 +589,8 @@ def test_incorrect_blocktxn_response(self, node, test_node, version):\n         assert_equal(int(node.getbestblockhash(), 16), block.sha256)\n \n     def test_getblocktxn_handler(self, node, test_node, version):\n-        # bitcoind won't respond for blocks whose height is more than 15 blocks\n-        # deep.\n+        # bitcoind will not send blocktxn responses for blocks whose height is\n+        # more than 10 blocks deep.\n         MAX_GETBLOCKTXN_DEPTH = 10\n         chain_height = node.getblockcount()\n         current_height = chain_height\n@@ -623,11 +623,17 @@ def test_getblocktxn_handler(self, node, test_node, version):\n                 test_node.last_blocktxn = None\n             current_height -= 1\n \n-        # Next request should be ignored, as we're past the allowed depth.\n+        # Next request should send a full block response, as we're past the\n+        # allowed depth for a blocktxn response.\n         block_hash = node.getblockhash(current_height)\n         msg.block_txn_request = BlockTransactionsRequest(int(block_hash, 16), [0])\n+        with mininode_lock:\n+            test_node.last_block = None\n+            test_node.last_blocktxn = None\n         test_node.send_and_ping(msg)\n         with mininode_lock:\n+            test_node.last_block.block.calc_sha256()\n+            assert_equal(test_node.last_block.block.sha256, int(block_hash, 16))\n             assert_equal(test_node.last_blocktxn, None)\n \n     def test_compactblocks_not_at_tip(self, node, test_node):"
      },
      {
        "sha": "55e3d934ea6bbbad01eaee209a441209029d2b58",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 12,
        "deletions": 0,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dac53b58b555183ccc0d5e64c428528267cd98b3/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dac53b58b555183ccc0d5e64c428528267cd98b3/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=dac53b58b555183ccc0d5e64c428528267cd98b3",
        "patch": "@@ -5450,7 +5450,19 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         }\n \n         if (it->second->nHeight < chainActive.Height() - MAX_BLOCKTXN_DEPTH) {\n+            // If an older block is requested (should never happen in practice,\n+            // but can happen in tests) send a block response instead of a\n+            // blocktxn response. Sending a full block response instead of a\n+            // small blocktxn response is preferable in the case where a peer\n+            // might maliciously send lots of getblocktxn requests to trigger\n+            // expensive disk reads, because it will require the peer to\n+            // actually receive all the data read from disk over the network.\n             LogPrint(\"net\", \"Peer %d sent us a getblocktxn for a block > %i deep\", pfrom->id, MAX_BLOCKTXN_DEPTH);\n+            CInv vInv;\n+            vInv.type = State(pfrom->GetId())->fWantsCmpctWitness ? MSG_WITNESS_BLOCK : MSG_BLOCK;\n+            vInv.hash = req.blockhash;\n+            pfrom->vRecvGetData.push_back(vInv);\n+            ProcessGetData(pfrom, chainparams.GetConsensus(), connman);\n             return true;\n         }\n "
      }
    ]
  }
]