[
  {
    "sha": "eb63bf86cf6dc99f150574463df6ffb013a34493",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplYjYzYmY4NmNmNmRjOTlmMTUwNTc0NDYzZGY2ZmZiMDEzYTM0NDkz",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2015-04-13T16:55:41Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2015-04-13T18:29:44Z"
      },
      "message": "Fix missing lock in submitblock",
      "tree": {
        "sha": "488727fec0231a10501e62ae541e6d55236b3a4e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/488727fec0231a10501e62ae541e6d55236b3a4e"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/eb63bf86cf6dc99f150574463df6ffb013a34493",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/eb63bf86cf6dc99f150574463df6ffb013a34493",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/eb63bf86cf6dc99f150574463df6ffb013a34493",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/eb63bf86cf6dc99f150574463df6ffb013a34493/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "9125c08f3468928eba004636bd95494a94e1a82b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9125c08f3468928eba004636bd95494a94e1a82b",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/9125c08f3468928eba004636bd95494a94e1a82b"
      }
    ],
    "stats": {
      "total": 23,
      "additions": 14,
      "deletions": 9
    },
    "files": [
      {
        "sha": "949fe3ed5243802120c7ed31d26390fd2d7a7d4a",
        "filename": "src/rpcmining.cpp",
        "status": "modified",
        "additions": 14,
        "deletions": 9,
        "changes": 23,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/eb63bf86cf6dc99f150574463df6ffb013a34493/src/rpcmining.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/eb63bf86cf6dc99f150574463df6ffb013a34493/src/rpcmining.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpcmining.cpp?ref=eb63bf86cf6dc99f150574463df6ffb013a34493",
        "patch": "@@ -629,22 +629,27 @@ Value submitblock(const Array& params, bool fHelp)\n         throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"Block decode failed\");\n \n     uint256 hash = block.GetHash();\n-    BlockMap::iterator mi = mapBlockIndex.find(hash);\n-    if (mi != mapBlockIndex.end()) {\n-        CBlockIndex *pindex = mi->second;\n-        if (pindex->IsValid(BLOCK_VALID_SCRIPTS))\n-            return \"duplicate\";\n-        if (pindex->nStatus & BLOCK_FAILED_MASK)\n-            return \"duplicate-invalid\";\n-        // Otherwise, we might only have the header - process the block before returning\n+    bool fBlockPresent = false;\n+    {\n+        LOCK(cs_main);\n+        BlockMap::iterator mi = mapBlockIndex.find(hash);\n+        if (mi != mapBlockIndex.end()) {\n+            CBlockIndex *pindex = mi->second;\n+            if (pindex->IsValid(BLOCK_VALID_SCRIPTS))\n+                return \"duplicate\";\n+            if (pindex->nStatus & BLOCK_FAILED_MASK)\n+                return \"duplicate-invalid\";\n+            // Otherwise, we might only have the header - process the block before returning\n+            fBlockPresent = true;\n+        }\n     }\n \n     CValidationState state;\n     submitblock_StateCatcher sc(block.GetHash());\n     RegisterValidationInterface(&sc);\n     bool fAccepted = ProcessNewBlock(state, NULL, &block);\n     UnregisterValidationInterface(&sc);\n-    if (mi != mapBlockIndex.end())\n+    if (fBlockPresent)\n     {\n         if (fAccepted && !sc.found)\n             return \"duplicate-inconclusive\";"
      }
    ]
  }
]