benma,2017-06-17T12:15:13Z,"Under which circumstances can Tip() be NULL? \nIsn't there always at least the genesis block? \n\nIf it is NULL, it crashes anyway as there are many more instances  of Tip() dereferences without NULL checks in the same function alone (i.e. for `bestblockhash`, chainwork`, etc.).\n \nIf it can be NULL, then we should define how the rpc output should look like in this case, and fix all instance",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309211611,309211611,
pavlosantoniou,2017-06-17T12:23:40Z,"If Tip() never returns NULL, then checking `block` for nullness in the following statment:\n`while (block && block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA))`\n is redundant.\n\nDo you think this should become:\n`while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA))`\nwith the rest of the code remaining as is?\n\nSince Tip() can theoretically return NULL, I think that",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309211996,309211996,
benma,2017-06-17T12:31:27Z,"> If Tip() never returns NULL [...] Do you think this should become:\n`while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA))`\nwith the rest of the code remaining as is?\n\nIn that case, yes.\n\nAs I said, if tip actually returns null, the function will crash as it is today, so we should either fix all of that (and document/test it), or have tip() not return null (and work backwa",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309212366,309212366,
pavlosantoniou,2017-06-17T12:38:44Z,"I think that checking the return value of a function that returns a pointer for nullness is a good practice that will safeguard the code from dereferencing a null pointer either under the current or under any other future implementation of Tip().\n\nActually, I see that in other parts of the code the return value of Tip() is checked for nullness. \nDo you think this PR should be merged to ensur",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309212741,309212741,
benma,2017-06-17T12:54:25Z,"C++ has the problem that pointers are used for two orthogonal reasons: 1) to avoid unneeded copies, and 2) to encode the possibility of NULL. If a function can't return NULL but still returns a pointer (for the first reason), I don't think callers need to check, as it complicates the code for no good reason. If someone changes the function to return null in the future, it's an API change (unfortun",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309213569,309213569,
pavlosantoniou,2017-06-17T13:25:26Z,"I have modified the commit for this PR.\nNow an `JSONRPCError` is thrown before any return value of Tip() is used.",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309215052,309215052,
benma,2017-06-17T13:39:31Z,"Thank you.\n\nutACK cf67a3c64d0813e1131bc30e7f628b7bfd21fc96 for the code.\n\nAs for the concept, I'd rather have more people confirm if this makes sense.",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309215717,309215717,
practicalswift,2017-06-17T14:26:08Z,"Concept ACK.\n\nIn addition to the check you added I suggest adding an assertion before accessing `block->nHeight`:\n\n```c++\n         CBlockIndex *block = chainActive.Tip();\n         while (block && block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA))\n             block = block->pprev;\n+        assert(block && ""An empty blockchain should not be possible here."");\n         obj.p",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309218195,309218195,
pavlosantoniou,2017-06-17T14:43:32Z,"Thank you all for your comments, I have added the assertion in the commit for this PR.",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309219195,309219195,
practicalswift,2017-06-17T16:44:17Z,"@pavlosantoniou Oh, I forgot to mention: I think you should restore the null check in the while loop too:\n\n```diff\n-        while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA))\n+        while (block && block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA))\n```",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309225990,309225990,
benma,2017-06-17T16:56:50Z,"@practicalswift that shouldn't be necessary with the check before that the tip is not null?\n\nIf you are afraid that the return value changes between two calls of Tip() in that function, the result should just be stored in a variable in the beginning and reused.",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309226828,309226828,
practicalswift,2017-06-18T15:38:09Z,"@pavlosantoniou I suggest using the following patch (while removing the other changes):\n\n```diff\ndiff --git a/src/rpc/blockchain.cpp b/src/rpc/blockchain.cpp\nindex 8f7f768..baf8dae 100644\n--- a/src/rpc/blockchain.cpp\n+++ b/src/rpc/blockchain.cpp\n@@ -1165,6 +1165,7 @@ UniValue getblockchaininfo(const JSONRPCRequest& request)\n             + HelpExampleRpc(""getblockchaininfo"", """")\n ",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309284918,309284918,
benma,2017-06-18T16:46:59Z,"@practicalswift why are the asserts needed? I guess they don't hurt, on the other hand, those asserts check something trivial.\n\n@pavlosantoniou can you assign Tip() to one var and reuse it in the rest of the function? Then there should be no doubt about its value.",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309288888,309288888,
practicalswift,2017-06-18T17:53:12Z,@benma The asserts serve as documentation of an assumption that is not obvious from reading the source code. As an added bonus it guides static analysis tools such as `clang-tidy` which will otherwise warn about a potential NULL pointer dereference here.,https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309292299,309292299,
benma,2017-06-19T06:13:21Z,"@practicalswift thanks, I didn't know about this tool. How many warnings like this are there? ",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309347796,309347796,
pavlosantoniou,2017-06-19T07:13:56Z,"@practicalswift Concerning your proposed patch, I agree with the addition of the two assertions.\nBut since `block` is checked for nullness in: \n`while (block && block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA))` \nthe possibility of nullness is implied. \nShouldn't `block` be dereferenced conditionally then ?\ne.g. in:\n`obj.push_back(Pair(""pruneheight"",        block->nHeight));`",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309357742,309357742,
practicalswift,2017-06-19T07:27:35Z,"@pavlosantoniou \n\nIn this code …\n\n```c++\n        CBlockIndex *block = chainActive.Tip();\n        while (block && block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA))\n            block = block->pprev;\n```\n\n… then `nullptr` check does only cover the `while`. After the `while` the `block` variable could still be set to `nullptr` – that's why the assertion is needed :-)",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309360262,309360262,
pavlosantoniou,2017-06-19T18:26:08Z,I have updated the commit with the suggested changes.,https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309525258,309525258,
pavlosantoniou,2017-06-20T05:33:54Z,Yes @benma you are right! Corrected,https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309649391,309649391,
practicalswift,2017-06-20T07:32:35Z,ACK be42c0d80e1de2bfd4f2658014eda18cab5a398d,https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309669459,309669459,
benma,2017-06-20T08:17:13Z,utACK be42c0d,https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309679507,309679507,
practicalswift,2017-06-20T21:31:19Z,"@benma There are currently three null pointer dereference warnings reported by `clang-tidy`'s module `clang-analyzer-core.NullDereference`:\n\n* Addressed in PR #9549 – `net_processing.cpp:345:14: warning: Dereference of null pointer (loaded from variable 'pit')`\n* Addressed in PR #10619 – `rpc/blockchain.cpp:1199:50: warning: Access to field 'nHeight' results in a dereference of a null pointe",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309897845,309897845,
TheBlueMatt,2017-06-21T22:27:54Z,"There are a ton of places we assume chainActive.Tip() is non-NULL, and init makes sure there is something there. Adding assert()s everywhere we dereference chainActive.Tip() during normal runtime seems like an excersize in too many assert()s.",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-310223175,310223175,
practicalswift,2017-06-22T02:24:36Z,@TheBlueMatt I think it makes sense to add an assertion in this case to guide `clang-tidy`. This is one of only two remaining null pointer dereference warnings emitted by `clang-tidy`'s module `clang-analyzer-core.NullDereference`.,https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-310257582,310257582,
pavlosantoniou,2017-07-06T17:20:40Z,@sipa @benma Is there something more I can do for this PR?,https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-313462215,313462215,
benma,2017-07-08T15:20:00Z,"utACK be42c0d80e1de2bfd4f2658014eda18cab5a398d (edit: just noticed I already ACK'd this commit before)\n\n@pavlosantoniou I feel like https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309357742 hasn't been addressed, really (i.e. why `block &&` should be restored). Not a blocker of course.",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-313862315,313862315,
pavlosantoniou,2017-07-08T17:27:27Z,@benma Are you refering to the saving-and-reusing-block's-value part of the comment?,https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-313869581,313869581,
benma,2017-07-08T18:33:00Z,"Yes, with regards to the `block &&` part that you originally removed. In other words, I am not sure why @practicalswift requested this: https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-309225990",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-313873486,313873486,
jtimon,2017-07-18T22:03:38Z,utACK be42c0d80e1de2bfd4f2658014eda18cab5a398d,https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-316211719,316211719,
promag,2017-07-18T22:54:41Z,Agree with @TheBlueMatt.,https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-316221543,316221543,
laanwj,2017-07-24T12:16:40Z,"""Avoid possibility of NULL pointer dereference"" is overly alarmist as this cannot happen in practice.\n\nI agree with @TheBlueMatt . We make sure that `chainActive.Tip()` is non-zero before allowing RPC calls, so asserting everywhere before use should be unnecessary. And adding it only on one place is even less useful, as it's not consistent.\n\n",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-317403946,317403946,
laanwj,2017-07-26T05:57:49Z,"Which automated warning, from what?",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-317955728,317955728,
TheBlueMatt,2017-07-26T15:10:02Z,@laanwj I was referring to the one at https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-310257582,https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-318083634,318083634,
gmaxwell,2017-07-26T15:14:00Z,"Just a bit of advice, I'd prefer that titles like ""Avoid null deference"" be reserved for cases where we believe one is actually possible.   Among other reasons, commits like this in the history will suppress legitimate issue reports when someone sees a crash then ""oh, I guess thats been fixed"". :)\n\nIn terms of guarding them with asserts, sure. That is a reasonable thing to do which we do elsew",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-318084804,318084804,
practicalswift,2017-07-26T15:31:17Z,"@sipa Agree about the wording!\n\n@laanwj I think the reason for the static analyzer warning in this case (and other cases reported as ""possible null pointer dereference"") is that a `NULL` check is performed earlier in the code which would imply that the variable can be `NULL` (not necessarily in practice, but in the reasoning of the analyzer). A dereference takes place later in the code where n",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-318090187,318090187,
fanquake,2018-04-11T15:08:08Z,"Closing for now, discussing has died out, and this needs a rebase.",https://github.com/bitcoin/bitcoin/pull/10619#issuecomment-380486787,380486787,
sipa,2017-06-17T17:37:06Z,"This can be an assert too; RPC isn't available before the `InitBlockIndex` call, after which chainActive cannot be empty.",https://github.com/bitcoin/bitcoin/pull/10619#discussion_r122573305,122573305,src/rpc/blockchain.cpp
benma,2017-06-19T22:50:31Z,wasn't this supposed to be `assert(block && ...)`?,https://github.com/bitcoin/bitcoin/pull/10619#discussion_r122844173,122844173,src/rpc/blockchain.cpp
TheBlueMatt,2017-07-25T20:07:58Z,"This needs to be inside the cs_main, I'd think.",https://github.com/bitcoin/bitcoin/pull/10619#discussion_r129411200,129411200,src/rpc/blockchain.cpp
laanwj,2017-08-23T10:35:51Z,Good point.,https://github.com/bitcoin/bitcoin/pull/10619#discussion_r134715519,134715519,src/rpc/blockchain.cpp
