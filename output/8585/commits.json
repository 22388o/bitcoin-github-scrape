[
  {
    "sha": "ac68d20322bf1e435e3906cd6d7ebcf2b6575d33",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphYzY4ZDIwMzIyYmYxZTQzNWUzOTA2Y2Q2ZDdlYmNmMmI2NTc1ZDMz",
    "commit": {
      "author": {
        "name": "Patrick Strateman",
        "email": "patrick.strateman@gmail.com",
        "date": "2016-08-25T03:55:53Z"
      },
      "committer": {
        "name": "Patrick Strateman",
        "email": "patrick.strateman@gmail.com",
        "date": "2016-08-25T04:12:49Z"
      },
      "message": "Move IncOrderPosNext to CWallet::AddAccountingEntry",
      "tree": {
        "sha": "25189c163861d1957fa3f2376167e5b3d45d200c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/25189c163861d1957fa3f2376167e5b3d45d200c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ac68d20322bf1e435e3906cd6d7ebcf2b6575d33",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ac68d20322bf1e435e3906cd6d7ebcf2b6575d33",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ac68d20322bf1e435e3906cd6d7ebcf2b6575d33",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ac68d20322bf1e435e3906cd6d7ebcf2b6575d33/comments",
    "author": {
      "login": "pstratem",
      "id": 620611,
      "node_id": "MDQ6VXNlcjYyMDYxMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/620611?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pstratem",
      "html_url": "https://github.com/pstratem",
      "followers_url": "https://api.github.com/users/pstratem/followers",
      "following_url": "https://api.github.com/users/pstratem/following{/other_user}",
      "gists_url": "https://api.github.com/users/pstratem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pstratem/subscriptions",
      "organizations_url": "https://api.github.com/users/pstratem/orgs",
      "repos_url": "https://api.github.com/users/pstratem/repos",
      "events_url": "https://api.github.com/users/pstratem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pstratem/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "pstratem",
      "id": 620611,
      "node_id": "MDQ6VXNlcjYyMDYxMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/620611?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pstratem",
      "html_url": "https://github.com/pstratem",
      "followers_url": "https://api.github.com/users/pstratem/followers",
      "following_url": "https://api.github.com/users/pstratem/following{/other_user}",
      "gists_url": "https://api.github.com/users/pstratem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pstratem/subscriptions",
      "organizations_url": "https://api.github.com/users/pstratem/orgs",
      "repos_url": "https://api.github.com/users/pstratem/repos",
      "events_url": "https://api.github.com/users/pstratem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pstratem/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f12d2b5a8ac397e4bcaefcc19898f8ff5705dea5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f12d2b5a8ac397e4bcaefcc19898f8ff5705dea5",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f12d2b5a8ac397e4bcaefcc19898f8ff5705dea5"
      }
    ],
    "stats": {
      "total": 17,
      "additions": 9,
      "deletions": 8
    },
    "files": [
      {
        "sha": "1030237e57d9f5417688e982def32e19c56a1f0c",
        "filename": "src/wallet/test/accounting_tests.cpp",
        "status": "modified",
        "additions": 0,
        "deletions": 4,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ac68d20322bf1e435e3906cd6d7ebcf2b6575d33/src/wallet/test/accounting_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ac68d20322bf1e435e3906cd6d7ebcf2b6575d33/src/wallet/test/accounting_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/test/accounting_tests.cpp?ref=ac68d20322bf1e435e3906cd6d7ebcf2b6575d33",
        "patch": "@@ -51,7 +51,6 @@ BOOST_AUTO_TEST_CASE(acc_orderupgrade)\n     pwalletMain->AddToWallet(wtx);\n     vpwtx.push_back(&pwalletMain->mapWallet[wtx.GetHash()]);\n     vpwtx[0]->nTimeReceived = (unsigned int)1333333335;\n-    vpwtx[0]->nOrderPos = -1;\n \n     ae.nTime = 1333333336;\n     ae.strOtherAccount = \"c\";\n@@ -70,7 +69,6 @@ BOOST_AUTO_TEST_CASE(acc_orderupgrade)\n \n     ae.nTime = 1333333330;\n     ae.strOtherAccount = \"d\";\n-    ae.nOrderPos = pwalletMain->IncOrderPosNext();\n     pwalletMain->AddAccountingEntry(ae, walletdb);\n \n     GetResults(walletdb, results);\n@@ -103,7 +101,6 @@ BOOST_AUTO_TEST_CASE(acc_orderupgrade)\n     pwalletMain->AddToWallet(wtx);\n     vpwtx.push_back(&pwalletMain->mapWallet[wtx.GetHash()]);\n     vpwtx[2]->nTimeReceived = (unsigned int)1333333329;\n-    vpwtx[2]->nOrderPos = -1;\n \n     GetResults(walletdb, results);\n \n@@ -120,7 +117,6 @@ BOOST_AUTO_TEST_CASE(acc_orderupgrade)\n \n     ae.nTime = 1333333334;\n     ae.strOtherAccount = \"e\";\n-    ae.nOrderPos = -1;\n     pwalletMain->AddAccountingEntry(ae, walletdb);\n \n     GetResults(walletdb, results);"
      },
      {
        "sha": "df3d169b72bfe3b85f1597d517d3923b530839fb",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 2,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ac68d20322bf1e435e3906cd6d7ebcf2b6575d33/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ac68d20322bf1e435e3906cd6d7ebcf2b6575d33/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=ac68d20322bf1e435e3906cd6d7ebcf2b6575d33",
        "patch": "@@ -2488,11 +2488,15 @@ bool CWallet::CommitTransaction(CWalletTx& wtxNew, CReserveKey& reservekey)\n     return true;\n }\n \n-bool CWallet::AddAccountingEntry(const CAccountingEntry& acentry, CWalletDB & pwalletdb)\n+bool CWallet::AddAccountingEntry(CAccountingEntry& acentry, CWalletDB & walletdb)\n {\n-    if (!pwalletdb.WriteAccountingEntry_Backend(acentry))\n+    if (!walletdb.WriteAccountingEntry_Backend(acentry))\n         return false;\n \n+    if (acentry.nOrderPos == -1) {\n+        acentry.nOrderPos = IncOrderPosNext(&walletdb);\n+    }\n+\n     laccentries.push_back(acentry);\n     CAccountingEntry & entry = laccentries.back();\n     wtxOrdered.insert(make_pair(entry.nOrderPos, TxPair((CWalletTx*)0, &entry)));"
      },
      {
        "sha": "f8f1d2e80ab6189ec6f70d19a556c05da303b983",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 3,
        "deletions": 2,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ac68d20322bf1e435e3906cd6d7ebcf2b6575d33/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ac68d20322bf1e435e3906cd6d7ebcf2b6575d33/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=ac68d20322bf1e435e3906cd6d7ebcf2b6575d33",
        "patch": "@@ -584,6 +584,8 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n     bool fFileBacked;\n \n     std::set<int64_t> setKeyPool;\n+\n+    int64_t IncOrderPosNext(CWalletDB *pwalletdb = NULL);\n public:\n     /*\n      * Main wallet lock.\n@@ -737,7 +739,6 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n      * Increment the next transaction order id\n      * @return next transaction order id\n      */\n-    int64_t IncOrderPosNext(CWalletDB *pwalletdb = NULL);\n     bool AccountMove(std::string strFrom, std::string strTo, CAmount nAmount, std::string strComment = \"\");\n     bool GetAccountPubkey(CPubKey &pubKey, std::string strAccount, bool bForceNew = false);\n \n@@ -772,7 +773,7 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n                            std::string& strFailReason, const CCoinControl *coinControl = NULL, bool sign = true);\n     bool CommitTransaction(CWalletTx& wtxNew, CReserveKey& reservekey);\n \n-    bool AddAccountingEntry(const CAccountingEntry&, CWalletDB & pwalletdb);\n+    bool AddAccountingEntry(CAccountingEntry&, CWalletDB &walletdb);\n \n     static CFeeRate minTxFee;\n     static CFeeRate fallbackFee;"
      }
    ]
  }
]