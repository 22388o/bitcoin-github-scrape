[
  {
    "sha": "1d207bc46f995ad3b5ae89bb504affaca09d10b1",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxZDIwN2JjNDZmOTk1YWQzYjVhZTg5YmI1MDRhZmZhY2EwOWQxMGIx",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2018-12-17T23:50:31Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2019-05-06T22:15:04Z"
      },
      "message": "Add hash strengthening to the RNG\n\nOnce every minute, this will feed the RNG state through repeated SHA512\nfor 10ms. The timings of that operation are used as entropy source as\nwell.",
      "tree": {
        "sha": "7add5e5b3f141f86412c17eece63cda9995266b7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7add5e5b3f141f86412c17eece63cda9995266b7"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1d207bc46f995ad3b5ae89bb504affaca09d10b1",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1d207bc46f995ad3b5ae89bb504affaca09d10b1",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1d207bc46f995ad3b5ae89bb504affaca09d10b1",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1d207bc46f995ad3b5ae89bb504affaca09d10b1/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "94167e2b5b7b6cb3cb1465ee67dd50676c5c8a14",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/94167e2b5b7b6cb3cb1465ee67dd50676c5c8a14",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/94167e2b5b7b6cb3cb1465ee67dd50676c5c8a14"
      }
    ],
    "stats": {
      "total": 58,
      "additions": 54,
      "deletions": 4
    },
    "files": [
      {
        "sha": "20bab363e4d133ab52cb246d6fa3149e517e488b",
        "filename": "src/random.cpp",
        "status": "modified",
        "additions": 54,
        "deletions": 4,
        "changes": 58,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1d207bc46f995ad3b5ae89bb504affaca09d10b1/src/random.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1d207bc46f995ad3b5ae89bb504affaca09d10b1/src/random.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/random.cpp?ref=1d207bc46f995ad3b5ae89bb504affaca09d10b1",
        "patch": "@@ -143,6 +143,34 @@ static bool GetHardwareRand(unsigned char* ent32) noexcept {\n     return false;\n }\n \n+/** Use repeated SHA512 to strengthen the randomness in seed32, and feed into hasher. */\n+static void Strengthen(const unsigned char (&seed)[32], int microseconds, CSHA512& hasher) noexcept\n+{\n+    CSHA512 inner_hasher;\n+    inner_hasher.Write(seed, sizeof(seed));\n+\n+    // Hash loop\n+    unsigned char buffer[64];\n+    int64_t stop = GetTimeMicros() + microseconds;\n+    do {\n+        for (int i = 0; i < 1000; ++i) {\n+            inner_hasher.Finalize(buffer);\n+            inner_hasher.Reset();\n+            inner_hasher.Write(buffer, sizeof(buffer));\n+        }\n+        // Benchmark operation and feed it into outer hasher.\n+        int64_t perf = GetPerformanceCounter();\n+        hasher.Write((const unsigned char*)&perf, sizeof(perf));\n+    } while (GetTimeMicros() < stop);\n+\n+    // Produce output from inner state and feed it to outer hasher.\n+    inner_hasher.Finalize(buffer);\n+    hasher.Write(buffer, sizeof(buffer));\n+    // Try to clean up.\n+    inner_hasher.Reset();\n+    memory_cleanse(buffer, sizeof(buffer));\n+}\n+\n static void RandAddSeedPerfmon(CSHA512& hasher)\n {\n #ifdef WIN32\n@@ -436,7 +464,23 @@ static void SeedSlow(CSHA512& hasher) noexcept\n     SeedTimestamp(hasher);\n }\n \n-static void SeedSleep(CSHA512& hasher)\n+/** Extract entropy from rng, strengthen it, and feed it into hasher. */\n+static void SeedStrengthen(CSHA512& hasher, RNGState& rng) noexcept\n+{\n+    static std::atomic<int64_t> last_strengthen{0};\n+    int64_t last_time = last_strengthen.load();\n+    int64_t current_time = GetTimeMicros();\n+    if (current_time > last_time + 60000000) { // Only run once a minute\n+        // Generate 32 bytes of entropy from the RNG, and a copy of the entropy already in hasher.\n+        unsigned char strengthen_seed[32];\n+        rng.MixExtract(strengthen_seed, sizeof(strengthen_seed), CSHA512(hasher), false);\n+        // Strengthen it for 10ms (100ms on first run), and feed it into hasher.\n+        Strengthen(strengthen_seed, last_time == 0 ? 100000 : 10000, hasher);\n+        last_strengthen = current_time;\n+    }\n+}\n+\n+static void SeedSleep(CSHA512& hasher, RNGState& rng)\n {\n     // Everything that the 'fast' seeder includes\n     SeedFast(hasher);\n@@ -452,9 +496,12 @@ static void SeedSleep(CSHA512& hasher)\n \n     // Windows performance monitor data (once every 10 minutes)\n     RandAddSeedPerfmon(hasher);\n+\n+    // Strengthen every minute\n+    SeedStrengthen(hasher, rng);\n }\n \n-static void SeedStartup(CSHA512& hasher) noexcept\n+static void SeedStartup(CSHA512& hasher, RNGState& rng) noexcept\n {\n #ifdef WIN32\n     RAND_screen();\n@@ -465,6 +512,9 @@ static void SeedStartup(CSHA512& hasher) noexcept\n \n     // Windows performance monitor data.\n     RandAddSeedPerfmon(hasher);\n+\n+    // Strengthen\n+    SeedStrengthen(hasher, rng);\n }\n \n enum class RNGLevel {\n@@ -489,15 +539,15 @@ static void ProcRand(unsigned char* out, int num, RNGLevel level)\n         SeedSlow(hasher);\n         break;\n     case RNGLevel::SLEEP:\n-        SeedSleep(hasher);\n+        SeedSleep(hasher, rng);\n         break;\n     }\n \n     // Combine with and update state\n     if (!rng.MixExtract(out, num, std::move(hasher), false)) {\n         // On the first invocation, also seed with SeedStartup().\n         CSHA512 startup_hasher;\n-        SeedStartup(startup_hasher);\n+        SeedStartup(startup_hasher, rng);\n         rng.MixExtract(out, num, std::move(startup_hasher), true);\n     }\n "
      }
    ]
  },
  {
    "sha": "3cb9ce85d0c6d01217babf0df7efc2eabde1b12f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozY2I5Y2U4NWQwYzZkMDEyMTdiYWJmMGRmN2VmYzJlYWJkZTFiMTJm",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2019-01-21T21:25:14Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2019-05-06T22:15:04Z"
      },
      "message": "Document strenghtening",
      "tree": {
        "sha": "e74fa04bb8c7dc07f58b1c4cc86dc0fb6a99f51b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e74fa04bb8c7dc07f58b1c4cc86dc0fb6a99f51b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3cb9ce85d0c6d01217babf0df7efc2eabde1b12f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3cb9ce85d0c6d01217babf0df7efc2eabde1b12f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/3cb9ce85d0c6d01217babf0df7efc2eabde1b12f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3cb9ce85d0c6d01217babf0df7efc2eabde1b12f/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1d207bc46f995ad3b5ae89bb504affaca09d10b1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1d207bc46f995ad3b5ae89bb504affaca09d10b1",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1d207bc46f995ad3b5ae89bb504affaca09d10b1"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 2,
      "deletions": 0
    },
    "files": [
      {
        "sha": "884bff48e16084b4cc4ae80d1366a752fe5d415d",
        "filename": "src/random.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/3cb9ce85d0c6d01217babf0df7efc2eabde1b12f/src/random.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/3cb9ce85d0c6d01217babf0df7efc2eabde1b12f/src/random.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/random.h?ref=3cb9ce85d0c6d01217babf0df7efc2eabde1b12f",
        "patch": "@@ -43,13 +43,15 @@\n  * - RandAddSeedSleep() seeds everything that fast seeding includes, but additionally:\n  *   - A high-precision timestamp before and after sleeping 1ms.\n  *   - (On Windows) Once every 10 minutes, performance monitoring data from the OS.\n+ -   - Once every minute, strengthen the entropy for 10 ms using repeated SHA512.\n  *   These just exploit the fact the system is idle to improve the quality of the RNG\n  *   slightly.\n  *\n  * On first use of the RNG (regardless of what function is called first), all entropy\n  * sources used in the 'slow' seeder are included, but also:\n  * - (On Windows) Performance monitoring data from the OS.\n  * - (On Windows) Through OpenSSL, the screen contents.\n+ * - Strengthen the entropy for 100 ms using repeated SHA512.\n  *\n  * When mixing in new entropy, H = SHA512(entropy || old_rng_state) is computed, and\n  * (up to) the first 32 bytes of H are produced as output, while the last 32 bytes"
      }
    ]
  }
]