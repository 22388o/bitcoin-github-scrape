[
  {
    "sha": "114b79c829779ad13383e1624c1ee28dc550c14a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxMTRiNzljODI5Nzc5YWQxMzM4M2UxNjI0YzFlZTI4ZGM1NTBjMTRh",
    "commit": {
      "author": {
        "name": "NicolasDorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2017-04-13T12:13:47Z"
      },
      "committer": {
        "name": "NicolasDorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2017-05-17T08:40:46Z"
      },
      "message": "[Wallet] Pass CCoinControl as parameter of CWallet::FundTransaction",
      "tree": {
        "sha": "0226159d635e19d8cca9fa6a3abdfc4668d758dc",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0226159d635e19d8cca9fa6a3abdfc4668d758dc"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/114b79c829779ad13383e1624c1ee28dc550c14a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/114b79c829779ad13383e1624c1ee28dc550c14a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/114b79c829779ad13383e1624c1ee28dc550c14a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/114b79c829779ad13383e1624c1ee28dc550c14a/comments",
    "author": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c91ca0ace9bd62eea8158b92cfc53d6d219e37b7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c91ca0ace9bd62eea8158b92cfc53d6d219e37b7",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c91ca0ace9bd62eea8158b92cfc53d6d219e37b7"
      }
    ],
    "stats": {
      "total": 27,
      "additions": 14,
      "deletions": 13
    },
    "files": [
      {
        "sha": "da798f1f0195a79351e7a47fd95f27703ed6d060",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 12,
        "deletions": 1,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/114b79c829779ad13383e1624c1ee28dc550c14a/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/114b79c829779ad13383e1624c1ee28dc550c14a/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=114b79c829779ad13383e1624c1ee28dc550c14a",
        "patch": "@@ -21,6 +21,7 @@\n #include \"wallet/feebumper.h\"\n #include \"wallet/wallet.h\"\n #include \"wallet/walletdb.h\"\n+#include \"wallet/coincontrol.h\"\n \n #include <stdint.h>\n \n@@ -2767,7 +2768,17 @@ UniValue fundrawtransaction(const JSONRPCRequest& request)\n     CAmount nFeeOut;\n     std::string strFailReason;\n \n-    if (!pwallet->FundTransaction(tx, nFeeOut, overrideEstimatedFeerate, feeRate, changePosition, strFailReason, includeWatching, lockUnspents, setSubtractFeeFromOutputs, reserveChangeKey, changeAddress)) {\n+    CCoinControl coinControl;\n+    coinControl.destChange = changeAddress;\n+    coinControl.fAllowOtherInputs = true;\n+    coinControl.fAllowWatchOnly = includeWatching;\n+    coinControl.fOverrideFeeRate = overrideEstimatedFeerate;\n+    coinControl.nFeeRate = feeRate;\n+\n+    BOOST_FOREACH(const CTxIn& txin, tx.vin)\n+        coinControl.Select(txin.prevout);\n+\n+    if (!pwallet->FundTransaction(tx, nFeeOut, coinControl, changePosition, strFailReason, lockUnspents, setSubtractFeeFromOutputs, reserveChangeKey)) {\n         throw JSONRPCError(RPC_WALLET_ERROR, strFailReason);\n     }\n "
      },
      {
        "sha": "227668f759fba007e26fe0568620875a1ae1b206",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 11,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/114b79c829779ad13383e1624c1ee28dc550c14a/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/114b79c829779ad13383e1624c1ee28dc550c14a/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=114b79c829779ad13383e1624c1ee28dc550c14a",
        "patch": "@@ -2312,7 +2312,7 @@ bool CWallet::SignTransaction(CMutableTransaction &tx)\n     return true;\n }\n \n-bool CWallet::FundTransaction(CMutableTransaction& tx, CAmount& nFeeRet, bool overrideEstimatedFeeRate, const CFeeRate& specificFeeRate, int& nChangePosInOut, std::string& strFailReason, bool includeWatching, bool lockUnspents, const std::set<int>& setSubtractFeeFromOutputs, bool keepReserveKey, const CTxDestination& destChange)\n+bool CWallet::FundTransaction(CMutableTransaction& tx, CAmount& nFeeRet, const CCoinControl& coinControl, int& nChangePosInOut, std::string& strFailReason, bool lockUnspents, const std::set<int>& setSubtractFeeFromOutputs, bool keepReserveKey)\n {\n     std::vector<CRecipient> vecSend;\n \n@@ -2324,16 +2324,6 @@ bool CWallet::FundTransaction(CMutableTransaction& tx, CAmount& nFeeRet, bool ov\n         vecSend.push_back(recipient);\n     }\n \n-    CCoinControl coinControl;\n-    coinControl.destChange = destChange;\n-    coinControl.fAllowOtherInputs = true;\n-    coinControl.fAllowWatchOnly = includeWatching;\n-    coinControl.fOverrideFeeRate = overrideEstimatedFeeRate;\n-    coinControl.nFeeRate = specificFeeRate;\n-\n-    BOOST_FOREACH(const CTxIn& txin, tx.vin)\n-        coinControl.Select(txin.prevout);\n-\n     CReserveKey reservekey(this);\n     CWalletTx wtx;\n     if (!CreateTransaction(vecSend, wtx, reservekey, nFeeRet, nChangePosInOut, strFailReason, &coinControl, false))"
      },
      {
        "sha": "b8f16a5a51b91ac8f0b6c5225063444d03d34d5d",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/114b79c829779ad13383e1624c1ee28dc550c14a/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/114b79c829779ad13383e1624c1ee28dc550c14a/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=114b79c829779ad13383e1624c1ee28dc550c14a",
        "patch": "@@ -908,7 +908,7 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n      * Insert additional inputs into the transaction by\n      * calling CreateTransaction();\n      */\n-    bool FundTransaction(CMutableTransaction& tx, CAmount& nFeeRet, bool overrideEstimatedFeeRate, const CFeeRate& specificFeeRate, int& nChangePosInOut, std::string& strFailReason, bool includeWatching, bool lockUnspents, const std::set<int>& setSubtractFeeFromOutputs, bool keepReserveKey = true, const CTxDestination& destChange = CNoDestination());\n+    bool FundTransaction(CMutableTransaction& tx, CAmount& nFeeRet, const CCoinControl& coinControl, int& nChangePosInOut, std::string& strFailReason, bool lockUnspents, const std::set<int>& setSubtractFeeFromOutputs, bool keepReserveKey = true);\n     bool SignTransaction(CMutableTransaction& tx);\n \n     /**"
      }
    ]
  },
  {
    "sha": "afb40b40e72451ae43aa07f69d8d313201f81fca",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphZmI0MGI0MGU3MjQ1MWFlNDNhYTA3ZjY5ZDhkMzEzMjAxZjgxZmNh",
    "commit": {
      "author": {
        "name": "NicolasDorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2017-04-13T13:11:57Z"
      },
      "committer": {
        "name": "NicolasDorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2017-05-17T09:02:40Z"
      },
      "message": "[Wallet] Fetch CInputCoins from CWallet before calling FundTransaction",
      "tree": {
        "sha": "7f4cebbe541f53f275df21724f789a4a94593eff",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7f4cebbe541f53f275df21724f789a4a94593eff"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/afb40b40e72451ae43aa07f69d8d313201f81fca",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/afb40b40e72451ae43aa07f69d8d313201f81fca",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/afb40b40e72451ae43aa07f69d8d313201f81fca",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/afb40b40e72451ae43aa07f69d8d313201f81fca/comments",
    "author": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "114b79c829779ad13383e1624c1ee28dc550c14a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/114b79c829779ad13383e1624c1ee28dc550c14a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/114b79c829779ad13383e1624c1ee28dc550c14a"
      }
    ],
    "stats": {
      "total": 49,
      "additions": 47,
      "deletions": 2
    },
    "files": [
      {
        "sha": "6a14f1aab43ad3ea9011092bbfaf46a5bf28744c",
        "filename": "src/wallet/coincontrol.h",
        "status": "modified",
        "additions": 17,
        "deletions": 0,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/afb40b40e72451ae43aa07f69d8d313201f81fca/src/wallet/coincontrol.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/afb40b40e72451ae43aa07f69d8d313201f81fca/src/wallet/coincontrol.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/coincontrol.h?ref=afb40b40e72451ae43aa07f69d8d313201f81fca",
        "patch": "@@ -7,6 +7,7 @@\n \n #include \"primitives/transaction.h\"\n #include \"wallet/wallet.h\"\n+#include <map>\n \n /** Coin Control Features. */\n class CCoinControl\n@@ -76,8 +77,24 @@ class CCoinControl\n         vOutpoints.assign(setSelected.begin(), setSelected.end());\n     }\n \n+    void AddKnownCoins(const CInputCoin& coin)\n+    {\n+        knownCoins.insert(std::make_pair(coin.outpoint, coin));\n+    }\n+\n+    boost::optional<CInputCoin> FindKnownCoin(const COutPoint& outpoint) const\n+    {\n+        boost::optional<CInputCoin> foundCoin;\n+        auto it = knownCoins.find(outpoint);\n+        if (it != knownCoins.end())\n+            foundCoin = it->second;\n+        return foundCoin;\n+    }\n+\n private:\n     std::set<COutPoint> setSelected;\n+    //! A map of known UTXO\n+    std::map<COutPoint, CInputCoin> knownCoins;\n };\n \n #endif // BITCOIN_WALLET_COINCONTROL_H"
      },
      {
        "sha": "99778dea8d65376d7d40d90a63cfe750e6c95508",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 0,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/afb40b40e72451ae43aa07f69d8d313201f81fca/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/afb40b40e72451ae43aa07f69d8d313201f81fca/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=afb40b40e72451ae43aa07f69d8d313201f81fca",
        "patch": "@@ -2776,7 +2776,14 @@ UniValue fundrawtransaction(const JSONRPCRequest& request)\n     coinControl.nFeeRate = feeRate;\n \n     BOOST_FOREACH(const CTxIn& txin, tx.vin)\n+    {\n         coinControl.Select(txin.prevout);\n+        boost::optional<CInputCoin> foundCoin;\n+        foundCoin = pwallet->FindCoin(txin.prevout);\n+        if(!foundCoin)\n+            throw JSONRPCError(RPC_WALLET_ERROR, _(\"Insufficient funds\"));\n+        coinControl.AddKnownCoins(*foundCoin);\n+    }\n \n     if (!pwallet->FundTransaction(tx, nFeeOut, coinControl, changePosition, strFailReason, lockUnspents, setSubtractFeeFromOutputs, reserveChangeKey)) {\n         throw JSONRPCError(RPC_WALLET_ERROR, strFailReason);"
      },
      {
        "sha": "283e8bb919865cf1e524031d205adbd5f67c0f59",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 21,
        "deletions": 2,
        "changes": 23,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/afb40b40e72451ae43aa07f69d8d313201f81fca/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/afb40b40e72451ae43aa07f69d8d313201f81fca/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=afb40b40e72451ae43aa07f69d8d313201f81fca",
        "patch": "@@ -2247,6 +2247,8 @@ bool CWallet::SelectCoins(const std::vector<COutput>& vAvailableCoins, const CAm\n         coinControl->ListSelected(vPresetInputs);\n     BOOST_FOREACH(const COutPoint& outpoint, vPresetInputs)\n     {\n+        // TODO: This is kept to not break QT Wallet which does not feed the KnownCoins before making the transaction\n+        // This should probably be removed once QT Wallet is aware of it.\n         std::map<uint256, CWalletTx>::const_iterator it = mapWallet.find(outpoint.hash);\n         if (it != mapWallet.end())\n         {\n@@ -2256,8 +2258,15 @@ bool CWallet::SelectCoins(const std::vector<COutput>& vAvailableCoins, const CAm\n                 return false;\n             nValueFromPresetInputs += pcoin->tx->vout[outpoint.n].nValue;\n             setPresetCoins.insert(CInputCoin(pcoin, outpoint.n));\n-        } else\n-            return false; // TODO: Allow non-wallet inputs\n+        }\n+        else\n+        {\n+            auto foundCoin = coinControl->FindKnownCoin(outpoint);\n+            if (!foundCoin)\n+                return false;\n+            nValueFromPresetInputs += foundCoin->txout.nValue;\n+            setPresetCoins.insert(*foundCoin);\n+        }\n     }\n \n     // remove preset inputs from vCoins\n@@ -2358,6 +2367,16 @@ bool CWallet::FundTransaction(CMutableTransaction& tx, CAmount& nFeeRet, const C\n     return true;\n }\n \n+boost::optional<CInputCoin> CWallet::FindCoin(const COutPoint& outpoint)\n+{\n+    LOCK(cs_wallet);\n+    boost::optional<CInputCoin> foundCoin;\n+    std::map<uint256, CWalletTx>::const_iterator it = mapWallet.find(outpoint.hash);\n+    if (it != mapWallet.end())\n+        foundCoin = CInputCoin(&it->second, outpoint.n);\n+    return foundCoin;\n+}\n+\n bool CWallet::CreateTransaction(const std::vector<CRecipient>& vecSend, CWalletTx& wtxNew, CReserveKey& reservekey, CAmount& nFeeRet,\n                                 int& nChangePosInOut, std::string& strFailReason, const CCoinControl* coinControl, bool sign)\n {"
      },
      {
        "sha": "54f38196952a8625b9cf5bb451b5f3f20bc86e83",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/afb40b40e72451ae43aa07f69d8d313201f81fca/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/afb40b40e72451ae43aa07f69d8d313201f81fca/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=afb40b40e72451ae43aa07f69d8d313201f81fca",
        "patch": "@@ -904,6 +904,8 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n     CAmount GetUnconfirmedWatchOnlyBalance() const;\n     CAmount GetImmatureWatchOnlyBalance() const;\n \n+    boost::optional<CInputCoin> FindCoin(const COutPoint& outpoint);\n+\n     /**\n      * Insert additional inputs into the transaction by\n      * calling CreateTransaction();"
      }
    ]
  },
  {
    "sha": "60ceea88242893fcbb2340ca5c5926190fe51035",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2MGNlZWE4ODI0Mjg5M2ZjYmIyMzQwY2E1YzU5MjYxOTBmZTUxMDM1",
    "commit": {
      "author": {
        "name": "NicolasDorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2017-04-13T13:27:55Z"
      },
      "committer": {
        "name": "NicolasDorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2017-05-17T09:02:54Z"
      },
      "message": "[Wallet] Fetch CInputCoins from CCoinView before calling FundTransaction",
      "tree": {
        "sha": "5adb9bb79615ba72fca6a0e615eefd5e339963b2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5adb9bb79615ba72fca6a0e615eefd5e339963b2"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/60ceea88242893fcbb2340ca5c5926190fe51035",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/60ceea88242893fcbb2340ca5c5926190fe51035",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/60ceea88242893fcbb2340ca5c5926190fe51035",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/60ceea88242893fcbb2340ca5c5926190fe51035/comments",
    "author": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "afb40b40e72451ae43aa07f69d8d313201f81fca",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/afb40b40e72451ae43aa07f69d8d313201f81fca",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/afb40b40e72451ae43aa07f69d8d313201f81fca"
      }
    ],
    "stats": {
      "total": 39,
      "additions": 35,
      "deletions": 4
    },
    "files": [
      {
        "sha": "6b6381ea94eab882f1be8587bfc2b0cc73922131",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 17,
        "deletions": 0,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/60ceea88242893fcbb2340ca5c5926190fe51035/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/60ceea88242893fcbb2340ca5c5926190fe51035/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=60ceea88242893fcbb2340ca5c5926190fe51035",
        "patch": "@@ -2622,6 +2622,21 @@ UniValue listunspent(const JSONRPCRequest& request)\n     return results;\n }\n \n+boost::optional<CInputCoin> FindInCoinView(const COutPoint& outpoint)\n+{\n+    LOCK2(cs_main, mempool.cs);\n+    boost::optional<CInputCoin> foundCoin;\n+    CCoinsViewMemPool coinsTipMempool(pcoinsTip, mempool);\n+    CCoinsViewCache view(&coinsTipMempool);\n+    CCoins coins;\n+    if (!view.GetCoins(outpoint.hash, coins))\n+        return foundCoin;\n+    if (!coins.IsAvailable(outpoint.n))\n+        return foundCoin;\n+    foundCoin = CInputCoin(coins.vout[outpoint.n], outpoint);\n+    return foundCoin;\n+}\n+\n UniValue fundrawtransaction(const JSONRPCRequest& request)\n {\n     CWallet * const pwallet = GetWalletForJSONRPCRequest(request);\n@@ -2780,6 +2795,8 @@ UniValue fundrawtransaction(const JSONRPCRequest& request)\n         coinControl.Select(txin.prevout);\n         boost::optional<CInputCoin> foundCoin;\n         foundCoin = pwallet->FindCoin(txin.prevout);\n+        if(!foundCoin)\n+            foundCoin = FindInCoinView(txin.prevout);\n         if(!foundCoin)\n             throw JSONRPCError(RPC_WALLET_ERROR, _(\"Insufficient funds\"));\n         coinControl.AddKnownCoins(*foundCoin);"
      },
      {
        "sha": "cb031fdce457ca5787fa1220e6b6cd9c2189cb43",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 18,
        "deletions": 4,
        "changes": 22,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/60ceea88242893fcbb2340ca5c5926190fe51035/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/60ceea88242893fcbb2340ca5c5926190fe51035/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=60ceea88242893fcbb2340ca5c5926190fe51035",
        "patch": "@@ -475,6 +475,16 @@ class CWalletTx : public CMerkleTx\n \n class CInputCoin {\n public:\n+\n+    CInputCoin(const CTxOut& txoutIn, const COutPoint& outpointIn)\n+    {\n+        if(txoutIn.IsNull())\n+            throw std::invalid_argument(\"txoutIn should not be null\");\n+        if (outpointIn.IsNull())\n+            throw std::invalid_argument(\"outpointIn should not be null\");\n+        outpoint = outpointIn;\n+        txout = txoutIn;\n+    }\n     CInputCoin(const CWalletTx* walletTx, unsigned int i)\n     {\n         if (!walletTx)\n@@ -1172,11 +1182,15 @@ bool CWallet::DummySignTx(CMutableTransaction &txNew, const ContainerType &coins\n         const CScript& scriptPubKey = coin.txout.scriptPubKey;\n         SignatureData sigdata;\n \n-        if (!ProduceSignature(DummySignatureCreator(this), scriptPubKey, sigdata))\n+        auto ismine = IsMine(coin.txout);\n+        if (ismine == ISMINE_SPENDABLE || ismine == ISMINE_WATCH_SOLVABLE)\n         {\n-            return false;\n-        } else {\n-            UpdateTransaction(txNew, nIn, sigdata);\n+            if (!ProduceSignature(DummySignatureCreator(this), scriptPubKey, sigdata))\n+            {\n+                return false;\n+            } else {\n+                UpdateTransaction(txNew, nIn, sigdata);\n+            }\n         }\n \n         nIn++;"
      }
    ]
  },
  {
    "sha": "1dd91edf892d01265449bfe9be459d8c07824f85",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxZGQ5MWVkZjg5MmQwMTI2NTQ0OWJmZTliZTQ1OWQ4YzA3ODI0Zjg1",
    "commit": {
      "author": {
        "name": "NicolasDorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2017-04-13T13:32:13Z"
      },
      "committer": {
        "name": "NicolasDorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2017-05-17T09:02:57Z"
      },
      "message": "[Wallet] FundRawTransaction returns unknown-input error on invalid input",
      "tree": {
        "sha": "668911d2edc32313e1545d089f1ec1d97349048c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/668911d2edc32313e1545d089f1ec1d97349048c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1dd91edf892d01265449bfe9be459d8c07824f85",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1dd91edf892d01265449bfe9be459d8c07824f85",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1dd91edf892d01265449bfe9be459d8c07824f85",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1dd91edf892d01265449bfe9be459d8c07824f85/comments",
    "author": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "60ceea88242893fcbb2340ca5c5926190fe51035",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/60ceea88242893fcbb2340ca5c5926190fe51035",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/60ceea88242893fcbb2340ca5c5926190fe51035"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 2,
      "deletions": 2
    },
    "files": [
      {
        "sha": "34fda473ca03dacc70a8ccc1b1e5173efbce86f1",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1dd91edf892d01265449bfe9be459d8c07824f85/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1dd91edf892d01265449bfe9be459d8c07824f85/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=1dd91edf892d01265449bfe9be459d8c07824f85",
        "patch": "@@ -2798,7 +2798,7 @@ UniValue fundrawtransaction(const JSONRPCRequest& request)\n         if(!foundCoin)\n             foundCoin = FindInCoinView(txin.prevout);\n         if(!foundCoin)\n-            throw JSONRPCError(RPC_WALLET_ERROR, _(\"Insufficient funds\"));\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"unknown-input\");\n         coinControl.AddKnownCoins(*foundCoin);\n     }\n "
      },
      {
        "sha": "6055f1cb0a5eb6fb2703a0e177d320a3d394a655",
        "filename": "test/functional/fundrawtransaction.py",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1dd91edf892d01265449bfe9be459d8c07824f85/test/functional/fundrawtransaction.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1dd91edf892d01265449bfe9be459d8c07824f85/test/functional/fundrawtransaction.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/fundrawtransaction.py?ref=1dd91edf892d01265449bfe9be459d8c07824f85",
        "patch": "@@ -316,7 +316,7 @@ def run_test(self):\n         rawtx   = self.nodes[2].createrawtransaction(inputs, outputs)\n         dec_tx  = self.nodes[2].decoderawtransaction(rawtx)\n \n-        assert_raises_jsonrpc(-4, \"Insufficient funds\", self.nodes[2].fundrawtransaction, rawtx)\n+        assert_raises_jsonrpc(-4, \"unknown-input\", self.nodes[2].fundrawtransaction, rawtx)\n \n         ############################################################\n         #compare fee of a standard pubkeyhash transaction"
      }
    ]
  },
  {
    "sha": "aa3a812759530b336a4aee90a8e6c91b5d764303",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphYTNhODEyNzU5NTMwYjMzNmE0YWVlOTBhOGU2YzkxYjVkNzY0MzAz",
    "commit": {
      "author": {
        "name": "NicolasDorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2017-04-13T13:37:21Z"
      },
      "committer": {
        "name": "NicolasDorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2017-05-17T09:03:00Z"
      },
      "message": "[Wallet] Test FundRawTransaction with inputs from the CoinView",
      "tree": {
        "sha": "d64085720ce879a64b1eff80ff9765524105defb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d64085720ce879a64b1eff80ff9765524105defb"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/aa3a812759530b336a4aee90a8e6c91b5d764303",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/aa3a812759530b336a4aee90a8e6c91b5d764303",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/aa3a812759530b336a4aee90a8e6c91b5d764303",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/aa3a812759530b336a4aee90a8e6c91b5d764303/comments",
    "author": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1dd91edf892d01265449bfe9be459d8c07824f85",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1dd91edf892d01265449bfe9be459d8c07824f85",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1dd91edf892d01265449bfe9be459d8c07824f85"
      }
    ],
    "stats": {
      "total": 25,
      "additions": 25,
      "deletions": 0
    },
    "files": [
      {
        "sha": "0eda7ab2eab19bfabb6566ae1e0ff168cb0f0b8a",
        "filename": "test/functional/fundrawtransaction.py",
        "status": "modified",
        "additions": 25,
        "deletions": 0,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/aa3a812759530b336a4aee90a8e6c91b5d764303/test/functional/fundrawtransaction.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/aa3a812759530b336a4aee90a8e6c91b5d764303/test/functional/fundrawtransaction.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/fundrawtransaction.py?ref=aa3a812759530b336a4aee90a8e6c91b5d764303",
        "patch": "@@ -63,6 +63,7 @@ def run_test(self):\n         self.nodes[0].sendtoaddress(self.nodes[2].getnewaddress(), 1.5)\n         self.nodes[0].sendtoaddress(self.nodes[2].getnewaddress(), 1.0)\n         self.nodes[0].sendtoaddress(self.nodes[2].getnewaddress(), 5.0)\n+        self.nodes[0].sendtoaddress(self.nodes[2].getnewaddress(), 3.0)\n \n         self.nodes[0].generate(1)\n         self.sync_all()\n@@ -307,6 +308,30 @@ def run_test(self):\n         assert_equal(matchingOuts, 2)\n         assert_equal(len(dec_tx['vout']), 3)\n \n+        ##############################################################################################\n+        # test a fundrawtransaction with one vin from wallet and one from mempool, one from CoinView #\n+        ##############################################################################################\n+        utx = get_unspent(self.nodes[0].listunspent(), 50)\n+        recei = self.nodes[0].sendtoaddress(self.nodes[2].getnewaddress(), 4)\n+        self.sync_all()\n+        # utx2 is unconfirmed, utx3 is confirmed (sent at the beginning of this test)\n+        utx2 = get_unspent(self.nodes[2].listunspent(minconf=0, maxconf=0, addresses=None, include_unsafe=True), 4)\n+        utx3 = get_unspent(self.nodes[2].listunspent(), 3)\n+        inputs  = [ {'txid' : utx['txid'], 'vout' : utx['vout']},{'txid' : utx2['txid'], 'vout' : utx2['vout']},{'txid' : utx3['txid'], 'vout' : utx3['vout']} ]\n+        outputs = { self.nodes[0].getnewaddress() : 50 + 4 + 3 + 2 }\n+        rawtx   = self.nodes[0].createrawtransaction(inputs, outputs)\n+        rawtxfund = self.nodes[0].fundrawtransaction(rawtx)\n+        dec_tx  = self.nodes[0].decoderawtransaction(rawtxfund['hex'])\n+        # Should contains the 3 previous vin + a new one added by the wallet\n+        assert_equal(len(dec_tx['vin']), 4)\n+        # Should contains the change, nodes[0] having only 50 BTC coins, it should returns around 43 BTC\n+        assert_equal(len(dec_tx['vout']), 2)\n+        totalOut = 0\n+        for out in dec_tx['vout']:\n+            totalOut += out['value']\n+        assert_greater_than(totalOut, 50 + 4 + 3 + 2 + 42.9)\n+        assert_greater_than(50 + 4 + 3 + 2 + 43, totalOut)\n+\n         ##############################################\n         # test a fundrawtransaction with invalid vin #\n         ##############################################"
      }
    ]
  }
]