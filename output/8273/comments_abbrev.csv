laanwj,2016-06-27T14:00:59Z,Specific numbers are of course open for discussion.\n,https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-228753998,228753998,
MarcoFalke,2016-06-27T18:39:43Z,"Would this require mention in the release notes?\n\nImagine someone updating on weak hardware, which does not support the new memory requirement.\n",https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-228836145,228836145,
jonasschnelli,2016-06-27T19:21:19Z,"This is a good idea and we should def. do this!\n\nLong term I would wish a flexible solution. If you have to catch up a couple of days/week (or during IBD), bitcoind/qt should use a catchup-cache-setting (can be a different, second `-dbcacheibd` [or similar] settings).\nOr we could think about adding ""profiles"" (set-changes of some CPU/MEM related settings).\n",https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-228847697,228847697,
jonasschnelli,2016-06-27T19:22:29Z,utACK https://github.com/bitcoin/bitcoin/pull/8273/commits/fdf085fcaccd012a54ead0de4c01cf35f541f257\nACK for 0.13.\nWould need prominent releasenotes part.\n,https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-228847980,228847980,
dcousens,2016-06-28T04:38:13Z,concept ACK\n,https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-228946298,228946298,
laanwj,2016-06-28T07:51:38Z,"> Would this require mention in the release notes?\n\nYes.\n\n> Imagine someone updating on weak hardware, which does not support the new memory requirement.\n\nWell at least now that the mempool is capped, that ought to free up some memory for other uses. But yes  it could be the final straw, sure...\n\n> Long term I would wish a flexible solution. If you have to catch up a couple of days/week (o",https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-228977292,228977292,
MarcoFalke,2016-06-28T08:39:27Z,Concept ACK for .13\n,https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-228987616,228987616,
gmaxwell,2016-06-28T11:35:09Z,I am (slowly) trying various leveldb cache sizes to see how big it really needs to be.\n,https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-229024122,229024122,
gmaxwell,2016-06-28T19:09:17Z,"On a Xeon-D 1541 with 64GB ram, 7200 rpm disk,  with no txindex, and all signature checks disabled, I found that:\n\nCapping GetOptions ncachesize to 1MB (holding all else constant) resulted in a 1% performance loss and capping at  4MB to a 0.1% loss (31072.23 to reindex instead of 31021.76). (2MB was very close to the 1MB numbers). On this basis I recommend clamping at leveldb 4MB or 8MB (just in",https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-229151117,229151117,
laanwj,2016-06-29T07:23:48Z,"> Capping GetOptions ncachesize to 1MB (holding all else constant) resulted in a 1% performance loss and capping at 4MB to a 0.1% loss (31072.23 to reindex instead of 31021.76). (2MB was very close to the 1MB numbers). On this basis I recommend clamping at leveldb 4MB or 8MB (just in case future growth or other workloads makes it matter more), and handing the rest of the memory to the coins cache.",https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-229277149,229277149,
gmaxwell,2016-06-29T17:34:53Z,"Benchmarked this pull req on the above system with reindex (and no signature checking at all),  went from 31021.76 seconds to 21303.22.\n\nIt's still a lot slower than the 'infinite' dbcache size results; but a huge improvement over the old results.\n\nACK.\n",https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-229430211,229430211,
roques,2016-06-29T18:22:48Z,"@gmaxwell I recently enabled `txindex` and reindexed. Reindexing was IO-bound by LevelDB compacting. When setting `-dbcache=16384` I observed that LevelDB's Level-0 files became much larger (~350MB) than with the default settings. This resulted in top LevelDB compactions of 4@0 + 0@1 files => 1458007320 bytes, resulting in several hundred new level-1 files of which the great majority can simply be",https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-229444169,229444169,
gmaxwell,2016-06-29T18:26:55Z,@roques I started that test before commenting above. Will update when it's done.\n,https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-229445384,229445384,
gmaxwell,2016-06-30T00:52:00Z,"With dbcache set to 8192,  reindex with this patch and no signature checks took 8071.65 seconds, and without 8071.65 seconds.  Test with txindex isn't done yet (it was later in my testqueue).\n",https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-229531417,229531417,
laanwj,2016-06-30T08:03:18Z,"Could set `static const int64_t nMaxBlockDBAndTxIndexCache = 8;` back to 32, that would be safer. It's possible that it makes more of a difference there then for the UTXO cache, as the access pattern is different, and I wasn't really planning to make any changes for `-txindex` here anyway.\n",https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-229590037,229590037,
gmaxwell,2016-06-30T08:57:21Z,"With txindex, no signature checks, and 8GB dbcache,  before this PR 10131.43 and after 11682.22. So it makes a meaningful difference.  I'm starting a test with the txindex case at 32 and seeing how that goes.\n",https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-229601991,229601991,
laanwj,2016-06-30T09:03:42Z,Added mention in release notes.\n,https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-229603421,229603421,
petertodd,2016-06-30T19:40:13Z,Concept ACK\n,https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-229766431,229766431,
gmaxwell,2016-06-30T19:54:21Z,"10721.93 with txindex, infinite dbcache, and the 32MB clamp.\n",https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-229769762,229769762,
laanwj,2016-07-01T07:50:20Z,"Ok, thanks for measuring, so that still suffers.\nRemoving the ceiling for txindex cache completely (well, bump it up to some unlikely number,1 GiB) in this PR. The exact performance compromise for txindex can be figured out later, this PR just aims to improve the common case.\n",https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-229880444,229880444,
jonasschnelli,2016-07-01T18:27:09Z,Positing some slightly off topic results here:\n\nSettings:\n- Current master da50997a3ee7d3b73180c71cd454580af49c2244\n- `--disable-debug`\n- `-dbcache=8000`\n- SSD\n\nResults:\n- `~3h04min` IBD from random peers [debug.log](http://bitcoinsrv.jonasschnelli.ch/log.ibd.nodebug.da5099.full.txt)\n- `~2h45min` `-reindex` [debug.log](http://bitcoinsrv.jonasschnelli.ch/log.reindex.nodebug.da5099.full.tx,https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-230016622,230016622,
jonasschnelli,2016-07-02T19:10:52Z,More data:\n- `~5h22min` default DB cache `-reindex` with master (`da50997`) [debug.log](http://bitcoinsrv.jonasschnelli.ch/log.reindex.nodebug.defdbcache.da5099.full.txt)\n- `~4h06min` default DB cache `-reindex` **this PR** (`f2bdbb7`) [debug.log](http://bitcoinsrv.jonasschnelli.ch/log.reindex.nodebug.defdbcache.f2bdbb.full.txt)\n,https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-230117320,230117320,
jonasschnelli,2016-07-04T13:35:00Z,Tested ACK 1009626d308ff70e3c0457559b87aacd510d0c42.\n,https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-230292098,230292098,
laanwj,2016-07-06T05:46:25Z,Squashed and updated the commit messages for the new values.\n,https://github.com/bitcoin/bitcoin/pull/8273#issuecomment-230676320,230676320,
dcousens,2016-06-28T04:37:44Z,"nit: without knowing the shorthand by heart,   it isn't exactly clear what `<< 20` represents here.   It could have some implied context compared to the fact its just shorthand for `MiB` (assuming I've understood it correctly!)\n",https://github.com/bitcoin/bitcoin/pull/8273#discussion_r68696573,68696573,src/txdb.h
laanwj,2016-06-28T07:50:34Z,"yes, I don't want to mention numbers in the comments (as everyone forgets to update those as they're not checked by the compiler) but specifying that it's MiB is fine with me\n",https://github.com/bitcoin/bitcoin/pull/8273#discussion_r68711696,68711696,src/txdb.h
MarcoFalke,2016-06-28T08:41:52Z,"Nit: braces should be ""(in MiB)"" or remove ""in""\n",https://github.com/bitcoin/bitcoin/pull/8273#discussion_r68718530,68718530,src/txdb.h
MarcoFalke,2016-06-28T08:42:21Z,"Nit: Mention ""(in bytes)"" or ""(bytes)""\n",https://github.com/bitcoin/bitcoin/pull/8273#discussion_r68718600,68718600,src/txdb.h
laanwj,2016-06-28T10:01:16Z,"bah, it's kind of messy that some of these are in bytes, and some in MiB\nWe probably should switch them all to bytes, or all to MiB.\n",https://github.com/bitcoin/bitcoin/pull/8273#discussion_r68729625,68729625,src/txdb.h
laanwj,2016-06-28T13:18:45Z,"All the constants are in MiB now, and that's documented as such\n",https://github.com/bitcoin/bitcoin/pull/8273#discussion_r68754042,68754042,src/txdb.h
