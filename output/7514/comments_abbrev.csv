laanwj,2016-02-11T09:11:56Z,"Are we sure this condition cannot happen on mainnet?\n\nIntroducing testnet-specific behavior is bad, as it makes testnet less useful as a proxy for testing mainnet. Also comparing strings here isn't acceptable - if you really need to do this it should be a flag on CChainParams. But I hope we can come up with a general solution.\n",https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-182775643,182775643,
jmacwhyte,2016-02-11T21:58:25Z,"Thanks for the feedback. I agree, testnet-specific behavior should be avoided if at all possible, but the testnet-specific difficulty rules seem to be what is causing the problem. Maybe another solution would be to have the code that resets testnet difficulty after 20 minutes also reset the work value for pindexBestHeader so a new block with less work is able to replace it. I'm not sure where that",https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183076265,183076265,
gmaxwell,2016-02-11T22:01:22Z,It's certainly possible for mainnet to have a chain with more blocks but lower total work. \n,https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183077476,183077476,
jmacwhyte,2016-02-11T22:12:56Z,"If that were the case, wouldn't the chain with more work be chosen as the active chain?\n",https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183081042,183081042,
gmaxwell,2016-02-11T22:14:09Z,"Yes, and that should be true for testnet too.\n",https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183081339,183081339,
jmacwhyte,2016-02-11T22:34:32Z,"Can we therefore assume chainActive is what we always believe to the be the ""correct"" chain? If so, can we just check to see if chainActive is within 24 hours of us when doing the IsInitialBlockDownload check (instead of pindexBestHeader)? That's another solution I had thought of, but didn't know if it would have other implications on mainnet.\n",https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183087033,183087033,
sipa,2016-02-11T22:39:53Z,"chainActive is the currently best fully validated chain, always.\n\nI think this issue can be fixed by using `std::max(chainActive.Tip()->GetBlockTime(), pindexBestHeader->GetBlockTime())` instead of just `pindexBestHeader->GetBlockTime()`.\n",https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183088282,183088282,
jmacwhyte,2016-02-12T02:06:42Z,"I think that's a great idea. As long as it only triggers until the node thinks it's close to finishing the initial block download, this method will accomplish its purpose. Either using the active chain or the best header should work.\n\nI have updated the pull request.\n",https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183149443,183149443,
luke-jr,2016-02-13T02:49:11Z,"> The nChainWork calculation can cause pindexBestHeader to be set with an old block that has more work than chainActive.Tip().\n\nIf it's an old block (ie, presumably one we have), shouldn't it be the active tip???\n",https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183570013,183570013,
jmacwhyte,2016-02-13T07:07:08Z,"It should be, but for some reason my node's BestHeader wasn't even in the\nactive chain. Where is the 20-minute difficulty reset rule defined? Is it\npossible something in there is facilitating high-POW orphans?\n\nOn Fri, Feb 12, 2016 at 6:49 PM Luke-Jr notifications@github.com wrote:\n\n> The nChainWork calculation can cause pindexBestHeader to be set with an\n> old block that has more work than",https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183613664,183613664,
sipa,2016-02-13T16:19:21Z,"That can only be the case while we're still catching up on the more-work\nchain (so we know about its headers, but haven't validated the blocks).\n",https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-183698513,183698513,
laanwj,2016-02-16T11:47:43Z,Needs ACKs before merge\n,https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-184650593,184650593,
jmacwhyte,2016-02-23T00:43:06Z,"I will do some more research on the deeper problem and present what I can find, if anything.\n",https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-187455125,187455125,
dcousens,2016-02-24T14:21:33Z,utACK\n,https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-188274121,188274121,
sipa,2016-03-05T21:38:46Z,"I'm not convinced the current code is sufficient to solve all problems related to the wonkyness of testnet mining, but it won't hurt. utACK.\n",https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-192747074,192747074,
jmacwhyte,2016-03-11T00:14:21Z,"I'm no longer able to reproduce the problem, as my node's chain tip and best header are now in sync. I agree there is probably a deeper problem here, but I think the proposed changes are acceptable because they help testnet nodes act more like mainnet in some fringe cases without affecting anything other than isInitialBlockDownload (which should only matter when nodes are first getting started).\n",https://github.com/bitcoin/bitcoin/pull/7514#issuecomment-195110910,195110910,
