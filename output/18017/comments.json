[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579594113",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-579594113",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
    "id": 579594113,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3OTU5NDExMw==",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?u=8cdd8653982252593843d7369ecfebe432b89768&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-29T05:04:14Z",
    "updated_at": "2020-01-29T05:04:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "Concept ACK. Will need to play around with it a little bit to test that clang actually prevents compiling incorrect uses.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579594113/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579666481",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-579666481",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
    "id": 579666481,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3OTY2NjQ4MQ==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-29T09:20:53Z",
    "updated_at": "2021-02-09T21:01:06Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/579666481/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584205068",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-584205068",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
    "id": 584205068,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU4NDIwNTA2OA==",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?u=13b19d1ff2f5f914e180c41418f451a4ba6f8bd1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-02-10T16:21:07Z",
    "updated_at": "2020-02-10T16:21:07Z",
    "author_association": "MEMBER",
    "body": "Concept ACK, nice",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/584205068/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/633196020",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-633196020",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
    "id": 633196020,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMzE5NjAyMA==",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?u=7297e8aaf9188c0cb98bc549a8a02a1dc8d59e4c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-24T08:12:48Z",
    "updated_at": "2020-05-24T08:12:48Z",
    "author_association": "MEMBER",
    "body": "Concept ACK.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/633196020/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/633984070",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-633984070",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
    "id": 633984070,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMzk4NDA3MA==",
    "user": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-26T12:07:20Z",
    "updated_at": "2020-05-26T12:07:20Z",
    "author_association": "CONTRIBUTOR",
    "body": "Incorporated @hebasto's suggested changes",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/633984070/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634134624",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-634134624",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
    "id": 634134624,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDEzNDYyNA==",
    "user": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-26T16:30:34Z",
    "updated_at": "2020-05-26T16:30:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "@hebasto - `AssertLockNotHeld(m_epoch)` won't work -- epochs aren't sync.h locks. I think the annotation for UpdateForDescendents would be better made after #18191 is merged?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634134624/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634138030",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-634138030",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
    "id": 634138030,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNDEzODAzMA==",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?u=7297e8aaf9188c0cb98bc549a8a02a1dc8d59e4c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-26T16:36:53Z",
    "updated_at": "2020-05-26T16:36:53Z",
    "author_association": "MEMBER",
    "body": "@ajtowns \r\n> @hebasto - `AssertLockNotHeld(m_epoch)` won't work -- epochs aren't sync.h locks. I think the annotation for UpdateForDescendents would be better made after #18191 is merged?\r\n\r\nAgree.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/634138030/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/690774658",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-690774658",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
    "id": 690774658,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5MDc3NDY1OA==",
    "user": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-10T22:57:41Z",
    "updated_at": "2020-09-10T22:57:41Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rebased",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/690774658/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/692815496",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-692815496",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
    "id": 692815496,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5MjgxNTQ5Ng==",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?u=8cdd8653982252593843d7369ecfebe432b89768&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-15T16:05:18Z",
    "updated_at": "2020-09-15T16:05:18Z",
    "author_association": "CONTRIBUTOR",
    "body": "re CR-ACK",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/692815496/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/694737531",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-694737531",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
    "id": 694737531,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5NDczNzUzMQ==",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-18T08:37:56Z",
    "updated_at": "2020-09-18T08:37:56Z",
    "author_association": "MEMBER",
    "body": "Concept ACK, the code looks like a nice refactoring.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/694737531/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/760130294",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-760130294",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
    "id": 760130294,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc2MDEzMDI5NA==",
    "user": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-14T11:14:23Z",
    "updated_at": "2021-01-14T11:14:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rebased to deal with adjacent lines changed in #19935",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/760130294/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775682083",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-775682083",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
    "id": 775682083,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3NTY4MjA4Mw==",
    "user": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-09T05:41:39Z",
    "updated_at": "2021-02-09T05:41:39Z",
    "author_association": "CONTRIBUTOR",
    "body": ":birthday: This PR turned 1 the other week! Rebased on top of #20944 due to header reordering, and addressed @hebasto's nits.\r\n\r\n(I think the mempool visited methods are public deliberately, so that they could be used by external functions if desired; so haven't made them private)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775682083/reactions",
      "total_count": 3,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 1,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776435206",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#issuecomment-776435206",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18017",
    "id": 776435206,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3NjQzNTIwNg==",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?u=8cdd8653982252593843d7369ecfebe432b89768&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-10T04:42:30Z",
    "updated_at": "2021-02-10T04:42:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "Yes this is correct; IIRC there's some stalled out patches which require them to be visible :)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/776435206/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429613083",
    "pull_request_review_id": 417338366,
    "id": 429613083,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYxMzA4Mw==",
    "diff_hunk": "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch;\n+    bool m_guarded;\n+\n+public:\n+    Epoch() : m_raw_epoch{0}, m_guarded{false} { }",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 31,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "7485e0f9db4455212e930ba68c26daa972956faf",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Mind switching from the member initialization list to the default member initializers?",
    "created_at": "2020-05-24T08:37:48Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429613083",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429613083"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429613083"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429613083/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 80,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429613209",
    "pull_request_review_id": 417338366,
    "id": 429613209,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYxMzIwOQ==",
    "diff_hunk": "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch;\n+    bool m_guarded;\n+\n+public:\n+    Epoch() : m_raw_epoch{0}, m_guarded{false} { }\n+\n+    Epoch(const Epoch&) = delete; // no copy constructor\n+    Epoch& operator=(const Epoch&) = delete; // not assignable\n+\n+    bool guarded() const { return m_guarded; }\n+\n+    class Marker {\n+    private:\n+        uint64_t m_marker;\n+\n+    public:\n+        Marker() : m_marker{0} { }",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 43,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "7485e0f9db4455212e930ba68c26daa972956faf",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Mind switching from the member initialization list to the default member initializer?",
    "created_at": "2020-05-24T08:39:33Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429613209",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429613209"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429613209"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429613209/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 92,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429621402",
    "pull_request_review_id": 417338366,
    "id": 429621402,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYyMTQwMg==",
    "diff_hunk": "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch;\n+    bool m_guarded;\n+\n+public:\n+    Epoch() : m_raw_epoch{0}, m_guarded{false} { }\n+\n+    Epoch(const Epoch&) = delete; // no copy constructor\n+    Epoch& operator=(const Epoch&) = delete; // not assignable",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 34,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "7485e0f9db4455212e930ba68c26daa972956faf",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "micro-nit: These comments are so obvious that seem redundant :)",
    "created_at": "2020-05-24T10:23:22Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429621402",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429621402"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429621402"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429621402/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 82,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 83,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429627015",
    "pull_request_review_id": 417338366,
    "id": 429627015,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYyNzAxNQ==",
    "diff_hunk": "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 24,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "7485e0f9db4455212e930ba68c26daa972956faf",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Tested on top of the #18635, and had loads of warnings:\r\n```\r\n./txmempool.h:102:38: warning: 'exclusive_lock_function' attribute requires arguments whose type is annotated with 'capability' attribute; type here is 'Epoch' [-Wthread-safety-attributes]\r\n        explicit Guard(Epoch& epoch) EXCLUSIVE_LOCK_FUNCTION(epoch) LOCKS_EXCLUDED(epoch);\r\n                                     ^\r\n...\r\n./txmempool.h:106:40: warning: 'exclusive_locks_required' attribute requires arguments whose type is annotated with 'capability' attribute; type here is 'const Epoch' [-Wthread-safety-attributes]\r\n    bool visited(Marker& marker) const EXCLUSIVE_LOCKS_REQUIRED(*this) {\r\n                                       ^\r\n...\r\n./txmempool.h:691:121: warning: 'locks_excluded' attribute requires arguments whose type is annotated with 'capability' attribute; type here is 'Epoch' [-Wthread-safety-attributes]\r\n    void UpdateTransactionsFromBlock(const std::vector<uint256>& vHashesToUpdate) EXCLUSIVE_LOCKS_REQUIRED(cs, cs_main) LOCKS_EXCLUDED(m_epoch);\r\n                                                                                                                        ^\r\n...\r\n./txmempool.h:812:41: warning: 'exclusive_locks_required' attribute requires arguments whose type is annotated with 'capability' attribute; type here is 'Epoch' [-Wthread-safety-attributes]\r\n    bool visited(const txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs, m_epoch) {\r\n                                        ^\r\n...\r\n./txmempool.h:816:45: warning: 'exclusive_locks_required' attribute requires arguments whose type is annotated with 'capability' attribute; type here is 'Epoch' [-Wthread-safety-attributes]\r\n    bool visited(Optional<txiter> it) const EXCLUSIVE_LOCKS_REQUIRED(cs, m_epoch) {\r\n                                            ^\r\n```\r\n\r\nTo make the Clang Thread Safety Analysis work as expected I suggest: \r\n```suggestion\r\nclass LOCKABLE Epoch\r\n```\r\n\r\n_and_ change the type of the `Epoch::Guard::m_epoch` from `Epoch&` to `Epoch*`.",
    "created_at": "2020-05-24T11:33:51Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429627015",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429627015"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429627015"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429627015/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 73,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429627231",
    "pull_request_review_id": 417338366,
    "id": 429627231,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTYyNzIzMQ==",
    "diff_hunk": "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch;\n+    bool m_guarded;\n+\n+public:\n+    Epoch() : m_raw_epoch{0}, m_guarded{false} { }\n+\n+    Epoch(const Epoch&) = delete; // no copy constructor\n+    Epoch& operator=(const Epoch&) = delete; // not assignable\n+\n+    bool guarded() const { return m_guarded; }\n+\n+    class Marker {\n+    private:\n+        uint64_t m_marker;\n+\n+    public:\n+        Marker() : m_marker{0} { }\n+\n+        friend class Epoch;\n+    };\n+\n+    class SCOPED_LOCKABLE Guard {\n+    private:\n+        Epoch& m_epoch;\n+\n+    public:\n+        explicit Guard(Epoch& epoch) EXCLUSIVE_LOCK_FUNCTION(epoch) LOCKS_EXCLUDED(epoch);",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 53,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "7485e0f9db4455212e930ba68c26daa972956faf",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "From the Thread Safety Analysis [docs](https://clang.llvm.org/docs/ThreadSafetyAnalysis.html#acquire-acquire-shared-release-release-shared):\r\n> The caller must not hold the given capability on entry\r\n\r\nIt seems `LOCKS_EXCLUDED(epoch)` is redundant, no?",
    "created_at": "2020-05-24T11:37:01Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429627231",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429627231"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r429627231"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/429627231/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 102,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430353995",
    "pull_request_review_id": 418221221,
    "id": 430353995,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM1Mzk5NQ==",
    "diff_hunk": "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 24,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "7485e0f9db4455212e930ba68c26daa972956faf",
    "user": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I'm not seeing what benefit changing `Epoch::Guard::m_epoch` from reference to pointer would have -- the analysis shouldn't (and doesn't) treat them any different, as far as I can see?",
    "created_at": "2020-05-26T11:51:32Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r430353995",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430353995"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r430353995"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430353995/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 73,
    "side": "RIGHT",
    "in_reply_to_id": 429627015
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430479806",
    "pull_request_review_id": 418386811,
    "id": 430479806,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ3OTgwNg==",
    "diff_hunk": "@@ -50,6 +50,68 @@ struct LockPoints\n     LockPoints() : height(0), time(0), maxInputBlock(nullptr) { }\n };\n \n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class Epoch",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 24,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "7485e0f9db4455212e930ba68c26daa972956faf",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Indeed :)\r\nIDK why I saw warnings...",
    "created_at": "2020-05-26T14:59:56Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r430479806",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430479806"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r430479806"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/430479806/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 73,
    "side": "RIGHT",
    "in_reply_to_id": 429627015
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486785464",
    "pull_request_review_id": 486487328,
    "id": 486785464,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc4NTQ2NA==",
    "diff_hunk": "@@ -63,6 +63,64 @@ struct CompareIteratorByHash {\n         return a->GetTx().GetHash() < b->GetTx().GetHash();\n     }\n };\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class LOCKABLE Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch = 0;\n+    bool m_guarded = false;\n+\n+public:\n+    Epoch() { }\n+    Epoch(const Epoch&) = delete;\n+    Epoch& operator=(const Epoch&) = delete;\n+\n+    bool guarded() const { return m_guarded; }",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 36,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "c95663c9350735a6200f9d29a1d8ac0ca8d41a4c",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Is this used?",
    "created_at": "2020-09-11T05:41:41Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r486785464",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486785464"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r486785464"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486785464/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 98,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486785695",
    "pull_request_review_id": 486487328,
    "id": 486785695,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc4NTY5NQ==",
    "diff_hunk": "@@ -63,6 +63,64 @@ struct CompareIteratorByHash {\n         return a->GetTx().GetHash() < b->GetTx().GetHash();\n     }\n };\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class LOCKABLE Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch = 0;\n+    bool m_guarded = false;\n+\n+public:\n+    Epoch() { }\n+    Epoch(const Epoch&) = delete;\n+    Epoch& operator=(const Epoch&) = delete;\n+\n+    bool guarded() const { return m_guarded; }",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 36,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "c95663c9350735a6200f9d29a1d8ac0ca8d41a4c",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "(I'm fine leaving it if it isn't used, just curious).",
    "created_at": "2020-09-11T05:42:24Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r486785695",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486785695"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r486785695"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486785695/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 98,
    "side": "RIGHT",
    "in_reply_to_id": 486785464
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486788819",
    "pull_request_review_id": 486487328,
    "id": 486788819,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc4ODgxOQ==",
    "diff_hunk": "@@ -63,6 +63,64 @@ struct CompareIteratorByHash {\n         return a->GetTx().GetHash() < b->GetTx().GetHash();\n     }\n };\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class LOCKABLE Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch = 0;\n+    bool m_guarded = false;\n+\n+public:\n+    Epoch() { }\n+    Epoch(const Epoch&) = delete;\n+    Epoch& operator=(const Epoch&) = delete;\n+\n+    bool guarded() const { return m_guarded; }\n+\n+    class Marker {\n+    private:\n+        uint64_t m_marker = 0;\n+        friend class Epoch;\n+    };\n+\n+    class SCOPED_LOCKABLE Guard {\n+    private:\n+        Epoch& m_epoch;\n+\n+    public:\n+        explicit Guard(Epoch& epoch) EXCLUSIVE_LOCK_FUNCTION(epoch);\n+        ~Guard() UNLOCK_FUNCTION();\n+    };\n+\n+    bool visited(Marker& marker) const EXCLUSIVE_LOCKS_REQUIRED(*this) {\n+        assert(m_guarded);\n+        bool ret = marker.m_marker >= m_raw_epoch;\n+        if (!ret) marker.m_marker = m_raw_epoch;\n+        return ret;\n+    }",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 58,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "c95663c9350735a6200f9d29a1d8ac0ca8d41a4c",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: how would you feel about:\r\n\r\n```\r\nuint64_t marker_old = marker.m_marker;\r\nmarker.m_marker = std::max(marker.m_marker, m_raw_epoch);\r\nreturn marker.m_marker != marker_old;\r\n```\r\n\r\nfor whatever reason I find it easier to read/reason about when we always set it to max.",
    "created_at": "2020-09-11T05:52:31Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r486788819",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486788819"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r486788819"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486788819/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 120,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486790383",
    "pull_request_review_id": 486487328,
    "id": 486790383,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njc5MDM4Mw==",
    "diff_hunk": "@@ -1113,22 +1113,17 @@ void CTxMemPool::SetIsLoaded(bool loaded)\n }\n \n \n-CTxMemPool::EpochGuard CTxMemPool::GetFreshEpoch() const\n+Epoch::Guard::Guard(Epoch& epoch) : m_epoch(epoch)",
    "path": "src/txmempool.cpp",
    "position": null,
    "original_position": 32,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "c95663c9350735a6200f9d29a1d8ac0ca8d41a4c",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Maybe best to move this into it's own header-only file/all headers to minimize conflict with #17786?",
    "created_at": "2020-09-11T05:57:40Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r486790383",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486790383"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r486790383"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486790383/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1116,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488334488",
    "pull_request_review_id": 488267663,
    "id": 488334488,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMzNDQ4OA==",
    "diff_hunk": "@@ -63,6 +63,64 @@ struct CompareIteratorByHash {\n         return a->GetTx().GetHash() < b->GetTx().GetHash();\n     }\n };\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class LOCKABLE Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch = 0;\n+    bool m_guarded = false;\n+\n+public:\n+    Epoch() { }\n+    Epoch(const Epoch&) = delete;\n+    Epoch& operator=(const Epoch&) = delete;\n+\n+    bool guarded() const { return m_guarded; }",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 36,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "c95663c9350735a6200f9d29a1d8ac0ca8d41a4c",
    "user": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "There's an `assert(m_epoch.guarded());` in `CTxMemPool::visited(Optional<txiter> it)` to check the lock's held in the case where `it->visited` isn't called.",
    "created_at": "2020-09-15T01:52:04Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r488334488",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488334488"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r488334488"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488334488/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 98,
    "side": "RIGHT",
    "in_reply_to_id": 486785464
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488339385",
    "pull_request_review_id": 488272985,
    "id": 488339385,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODMzOTM4NQ==",
    "diff_hunk": "@@ -63,6 +63,64 @@ struct CompareIteratorByHash {\n         return a->GetTx().GetHash() < b->GetTx().GetHash();\n     }\n };\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class LOCKABLE Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch = 0;\n+    bool m_guarded = false;\n+\n+public:\n+    Epoch() { }\n+    Epoch(const Epoch&) = delete;\n+    Epoch& operator=(const Epoch&) = delete;\n+\n+    bool guarded() const { return m_guarded; }\n+\n+    class Marker {\n+    private:\n+        uint64_t m_marker = 0;\n+        friend class Epoch;\n+    };\n+\n+    class SCOPED_LOCKABLE Guard {\n+    private:\n+        Epoch& m_epoch;\n+\n+    public:\n+        explicit Guard(Epoch& epoch) EXCLUSIVE_LOCK_FUNCTION(epoch);\n+        ~Guard() UNLOCK_FUNCTION();\n+    };\n+\n+    bool visited(Marker& marker) const EXCLUSIVE_LOCKS_REQUIRED(*this) {\n+        assert(m_guarded);\n+        bool ret = marker.m_marker >= m_raw_epoch;\n+        if (!ret) marker.m_marker = m_raw_epoch;\n+        return ret;\n+    }",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 58,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "c95663c9350735a6200f9d29a1d8ac0ca8d41a4c",
    "user": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "That reverses the logic (`ret == false` causes `m_marker` to change originally, but your code returns `true` if `m_marker` changed) ? Seems like that's evidence it's not that easy to read/reason about? :)\r\n\r\nIt might be less confusing to write it out in full:\r\n\r\n```c++\r\nif (marker.m_marker < m_raw_epoch ) {\r\n    // this entry is from an earlier epoch, so it hasn't been visited\r\n    marker.m_marker = m_raw_epoch;\r\n    return false;\r\n} else {\r\n    return true;\r\n}\r\n```\r\n\r\nI'd guess the compiler will make all these variants essentially the same anyway, so no objection to any variation from me.",
    "created_at": "2020-09-15T02:09:23Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r488339385",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488339385"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r488339385"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488339385/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 120,
    "side": "RIGHT",
    "in_reply_to_id": 486788819
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488347408",
    "pull_request_review_id": 488282100,
    "id": 488347408,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM0NzQwOA==",
    "diff_hunk": "@@ -63,6 +63,64 @@ struct CompareIteratorByHash {\n         return a->GetTx().GetHash() < b->GetTx().GetHash();\n     }\n };\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class LOCKABLE Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch = 0;\n+    bool m_guarded = false;\n+\n+public:\n+    Epoch() { }\n+    Epoch(const Epoch&) = delete;\n+    Epoch& operator=(const Epoch&) = delete;\n+\n+    bool guarded() const { return m_guarded; }\n+\n+    class Marker {\n+    private:\n+        uint64_t m_marker = 0;\n+        friend class Epoch;\n+    };\n+\n+    class SCOPED_LOCKABLE Guard {\n+    private:\n+        Epoch& m_epoch;\n+\n+    public:\n+        explicit Guard(Epoch& epoch) EXCLUSIVE_LOCK_FUNCTION(epoch);\n+        ~Guard() UNLOCK_FUNCTION();\n+    };\n+\n+    bool visited(Marker& marker) const EXCLUSIVE_LOCKS_REQUIRED(*this) {\n+        assert(m_guarded);\n+        bool ret = marker.m_marker >= m_raw_epoch;\n+        if (!ret) marker.m_marker = m_raw_epoch;\n+        return ret;\n+    }",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 58,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "c95663c9350735a6200f9d29a1d8ac0ca8d41a4c",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Ah my bad, I've made a case against myself -- for what it's worth, I made the proposed version by translating your proposed version, which I have trouble parsing logically, and thought it was equivalent to that logic (and still can't figure out the concrete reason it's opposite).\r\n\r\nI'm fine with the completely written out version as it is the most obvious for sleepy brains like mine.",
    "created_at": "2020-09-15T02:37:57Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r488347408",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488347408"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r488347408"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488347408/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 120,
    "side": "RIGHT",
    "in_reply_to_id": 486788819
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488358871",
    "pull_request_review_id": 488294821,
    "id": 488358871,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM1ODg3MQ==",
    "diff_hunk": "@@ -63,6 +63,64 @@ struct CompareIteratorByHash {\n         return a->GetTx().GetHash() < b->GetTx().GetHash();\n     }\n };\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class LOCKABLE Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch = 0;\n+    bool m_guarded = false;\n+\n+public:\n+    Epoch() { }\n+    Epoch(const Epoch&) = delete;\n+    Epoch& operator=(const Epoch&) = delete;\n+\n+    bool guarded() const { return m_guarded; }\n+\n+    class Marker {\n+    private:\n+        uint64_t m_marker = 0;\n+        friend class Epoch;\n+    };\n+\n+    class SCOPED_LOCKABLE Guard {\n+    private:\n+        Epoch& m_epoch;\n+\n+    public:\n+        explicit Guard(Epoch& epoch) EXCLUSIVE_LOCK_FUNCTION(epoch);\n+        ~Guard() UNLOCK_FUNCTION();\n+    };\n+\n+    bool visited(Marker& marker) const EXCLUSIVE_LOCKS_REQUIRED(*this) {\n+        assert(m_guarded);\n+        bool ret = marker.m_marker >= m_raw_epoch;\n+        if (!ret) marker.m_marker = m_raw_epoch;\n+        return ret;\n+    }",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 58,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "c95663c9350735a6200f9d29a1d8ac0ca8d41a4c",
    "user": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think the translation goes:\r\n\r\n- `r = a >= b; if (!r) a = b; return r;`  (current)\r\n- `o = a; if (! (a >= b)) a = b; return o >= b;`   (store old value, replace `r`)\r\n- `o = a; if (a < b) a = b; return !(o < b);`  (switch to less than)\r\n- `o = a; a = max(a,b); return !(o != a);`  (`o < b` iff the if was taken, and `a` was changed)\r\n- `o = a; a = max(a,b); return o == a;`  (simplify)\r\n\r\nAnyway, changed to KISS version.",
    "created_at": "2020-09-15T03:20:48Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r488358871",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488358871"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r488358871"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488358871/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 120,
    "side": "RIGHT",
    "in_reply_to_id": 486788819
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488358955",
    "pull_request_review_id": 488294926,
    "id": 488358955,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODM1ODk1NQ==",
    "diff_hunk": "@@ -1113,22 +1113,17 @@ void CTxMemPool::SetIsLoaded(bool loaded)\n }\n \n \n-CTxMemPool::EpochGuard CTxMemPool::GetFreshEpoch() const\n+Epoch::Guard::Guard(Epoch& epoch) : m_epoch(epoch)",
    "path": "src/txmempool.cpp",
    "position": null,
    "original_position": 32,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "c95663c9350735a6200f9d29a1d8ac0ca8d41a4c",
    "user": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Moved into util/epochguard.h",
    "created_at": "2020-09-15T03:21:04Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r488358955",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488358955"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r488358955"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488358955/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1116,
    "side": "RIGHT",
    "in_reply_to_id": 486790383
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488785835",
    "pull_request_review_id": 488839517,
    "id": 488785835,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc4NTgzNQ==",
    "diff_hunk": "@@ -814,52 +815,20 @@ class CTxMemPool\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n public:\n-    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n-     *     When walking ancestors or descendants, we generally want to avoid\n-     * visiting the same transactions twice. Some traversal algorithms use\n-     * std::set (or setEntries) to deduplicate the transaction we visit.\n-     * However, use of std::set is algorithmically undesirable because it both\n-     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n-     * more dynamic memory allocations.\n-     *     In many algorithms we can replace std::set with an internal mempool\n-     * counter to track the time (or, \"epoch\") that we began a traversal, and\n-     * check + update a per-transaction epoch for each transaction we look at to\n-     * determine if that transaction has not yet been visited during the current\n-     * traversal's epoch.\n-     *     Algorithms using std::set can be replaced on a one by one basis.\n-     * Both techniques are not fundamentally incompatible across the codebase.\n-     * Generally speaking, however, the remaining use of std::set for mempool\n-     * traversal should be viewed as a TODO for replacement with an epoch based\n-     * traversal, rather than a preference for std::set over epochs in that\n-     * algorithm.\n-     */\n-    class EpochGuard {\n-        const CTxMemPool& pool;\n-        public:\n-        EpochGuard(const CTxMemPool& in);\n-        ~EpochGuard();\n-    };\n-    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n-    // (and later destruction)\n-    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n-\n     /** visited marks a CTxMemPoolEntry as having been traversed\n-     * during the lifetime of the most recently created EpochGuard\n+     * during the lifetime of the most recently created Epoch::Guard\n      * and returns false if we are the first visitor, true otherwise.\n      *\n-     * An EpochGuard must be held when visited is called or an assert will be\n+     * An Epoch::Guard must be held when visited is called or an assert will be\n      * triggered.\n      *\n      */\n-    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n-        assert(m_has_epoch_guard);\n-        bool ret = it->m_epoch >= m_epoch;\n-        it->m_epoch = std::max(it->m_epoch, m_epoch);\n-        return ret;\n+    bool visited(const txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs, m_epoch) {\n+        return m_epoch.visited(it->m_epoch_marker);\n     }\n \n-    bool visited(Optional<txiter> it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n-        assert(m_has_epoch_guard);\n+    bool visited(Optional<txiter> it) const EXCLUSIVE_LOCKS_REQUIRED(cs, m_epoch) {\n+        assert(m_epoch.guarded());",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 99,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "55c1c7e5db72a343936487c03d555974f97daaf5",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "micronit: may be worth adding a comment here that the assert is redundant when it != nullopt, but is used for consistency when it == nullopt.",
    "created_at": "2020-09-15T16:04:41Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r488785835",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488785835"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r488785835"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/488785835/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 831,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558593664",
    "pull_request_review_id": 569619362,
    "id": 558593664,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU5MzY2NA==",
    "diff_hunk": "@@ -21,6 +21,7 @@\n #include <primitives/transaction.h>\n #include <sync.h>\n #include <random.h>\n+#include <util/epochguard.h>",
    "path": "src/txmempool.h",
    "position": 4,
    "original_position": 4,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "88019f9a183d396713fd357604a6e472c5ed8807",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "style nit: while touching headers they could be sorted:\r\n```\r\n#include <random.h>\r\n#include <sync.h>\r\n#include <util/epochguard.h>\r\n```",
    "created_at": "2021-01-15T21:09:00Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558593664",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558593664"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558593664"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558593664/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 24,
    "original_line": 24,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558595243",
    "pull_request_review_id": 569619362,
    "id": 558595243,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU5NTI0Mw==",
    "diff_hunk": "@@ -819,52 +820,20 @@ class CTxMemPool\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n public:\n-    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n-     *     When walking ancestors or descendants, we generally want to avoid\n-     * visiting the same transactions twice. Some traversal algorithms use\n-     * std::set (or setEntries) to deduplicate the transaction we visit.\n-     * However, use of std::set is algorithmically undesirable because it both\n-     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n-     * more dynamic memory allocations.\n-     *     In many algorithms we can replace std::set with an internal mempool\n-     * counter to track the time (or, \"epoch\") that we began a traversal, and\n-     * check + update a per-transaction epoch for each transaction we look at to\n-     * determine if that transaction has not yet been visited during the current\n-     * traversal's epoch.\n-     *     Algorithms using std::set can be replaced on a one by one basis.\n-     * Both techniques are not fundamentally incompatible across the codebase.\n-     * Generally speaking, however, the remaining use of std::set for mempool\n-     * traversal should be viewed as a TODO for replacement with an epoch based\n-     * traversal, rather than a preference for std::set over epochs in that\n-     * algorithm.\n-     */\n-    class EpochGuard {\n-        const CTxMemPool& pool;\n-        public:\n-        explicit EpochGuard(const CTxMemPool& in);\n-        ~EpochGuard();\n-    };\n-    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n-    // (and later destruction)\n-    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n-\n     /** visited marks a CTxMemPoolEntry as having been traversed\n-     * during the lifetime of the most recently created EpochGuard\n+     * during the lifetime of the most recently created Epoch::Guard\n      * and returns false if we are the first visitor, true otherwise.\n      *\n-     * An EpochGuard must be held when visited is called or an assert will be\n+     * An Epoch::Guard must be held when visited is called or an assert will be\n      * triggered.\n      *\n      */\n-    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n-        assert(m_has_epoch_guard);\n-        bool ret = it->m_epoch >= m_epoch;\n-        it->m_epoch = std::max(it->m_epoch, m_epoch);\n-        return ret;\n+    bool visited(const txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs, m_epoch) {",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 92,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "88019f9a183d396713fd357604a6e472c5ed8807",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "style nit, suggested by `clang-format`:\r\n```suggestion\r\n    bool visited(const txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs, m_epoch)\r\n    {\r\n```",
    "created_at": "2021-01-15T21:13:01Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558595243",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558595243"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558595243"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558595243/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 831,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558595646",
    "pull_request_review_id": 569619362,
    "id": 558595646,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU5NTY0Ng==",
    "diff_hunk": "@@ -819,52 +820,20 @@ class CTxMemPool\n      */\n     void removeUnchecked(txiter entry, MemPoolRemovalReason reason) EXCLUSIVE_LOCKS_REQUIRED(cs);\n public:\n-    /** EpochGuard: RAII-style guard for using epoch-based graph traversal algorithms.\n-     *     When walking ancestors or descendants, we generally want to avoid\n-     * visiting the same transactions twice. Some traversal algorithms use\n-     * std::set (or setEntries) to deduplicate the transaction we visit.\n-     * However, use of std::set is algorithmically undesirable because it both\n-     * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n-     * more dynamic memory allocations.\n-     *     In many algorithms we can replace std::set with an internal mempool\n-     * counter to track the time (or, \"epoch\") that we began a traversal, and\n-     * check + update a per-transaction epoch for each transaction we look at to\n-     * determine if that transaction has not yet been visited during the current\n-     * traversal's epoch.\n-     *     Algorithms using std::set can be replaced on a one by one basis.\n-     * Both techniques are not fundamentally incompatible across the codebase.\n-     * Generally speaking, however, the remaining use of std::set for mempool\n-     * traversal should be viewed as a TODO for replacement with an epoch based\n-     * traversal, rather than a preference for std::set over epochs in that\n-     * algorithm.\n-     */\n-    class EpochGuard {\n-        const CTxMemPool& pool;\n-        public:\n-        explicit EpochGuard(const CTxMemPool& in);\n-        ~EpochGuard();\n-    };\n-    // N.B. GetFreshEpoch modifies mutable state via the EpochGuard construction\n-    // (and later destruction)\n-    EpochGuard GetFreshEpoch() const EXCLUSIVE_LOCKS_REQUIRED(cs);\n-\n     /** visited marks a CTxMemPoolEntry as having been traversed\n-     * during the lifetime of the most recently created EpochGuard\n+     * during the lifetime of the most recently created Epoch::Guard\n      * and returns false if we are the first visitor, true otherwise.\n      *\n-     * An EpochGuard must be held when visited is called or an assert will be\n+     * An Epoch::Guard must be held when visited is called or an assert will be\n      * triggered.\n      *\n      */\n-    bool visited(txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n-        assert(m_has_epoch_guard);\n-        bool ret = it->m_epoch >= m_epoch;\n-        it->m_epoch = std::max(it->m_epoch, m_epoch);\n-        return ret;\n+    bool visited(const txiter it) const EXCLUSIVE_LOCKS_REQUIRED(cs, m_epoch) {\n+        return m_epoch.visited(it->m_epoch_marker);\n     }\n \n-    bool visited(Optional<txiter> it) const EXCLUSIVE_LOCKS_REQUIRED(cs) {\n-        assert(m_has_epoch_guard);\n+    bool visited(Optional<txiter> it) const EXCLUSIVE_LOCKS_REQUIRED(cs, m_epoch) {",
    "path": "src/txmempool.h",
    "position": null,
    "original_position": 98,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "88019f9a183d396713fd357604a6e472c5ed8807",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "style nit, suggested by `clang-format`:\r\n```suggestion\r\n    bool visited(Optional<txiter> it) const EXCLUSIVE_LOCKS_REQUIRED(cs, m_epoch)\r\n    {\r\n```",
    "created_at": "2021-01-15T21:14:04Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558595646",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558595646"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558595646"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558595646/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 835,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558595862",
    "pull_request_review_id": 569619362,
    "id": 558595862,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU5NTg2Mg==",
    "diff_hunk": "@@ -0,0 +1,88 @@\n+// Copyright (c) 2009-2010 Satoshi Nakamoto\n+// Copyright (c) 2009-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_EPOCHGUARD_H\n+#define BITCOIN_UTIL_EPOCHGUARD_H\n+\n+#include <threadsafety.h>\n+\n+#include <cassert>\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class LOCKABLE Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch = 0;\n+    bool m_guarded = false;\n+\n+public:\n+    Epoch() { }",
    "path": "src/util/epochguard.h",
    "position": null,
    "original_position": 40,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "88019f9a183d396713fd357604a6e472c5ed8807",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "style nit, suggested by `clang-format`:\r\n```suggestion\r\n    Epoch() {}\r\n```",
    "created_at": "2021-01-15T21:14:35Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558595862",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558595862"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558595862"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558595862/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 40,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558596003",
    "pull_request_review_id": 569619362,
    "id": 558596003,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU5NjAwMw==",
    "diff_hunk": "@@ -0,0 +1,88 @@\n+// Copyright (c) 2009-2010 Satoshi Nakamoto\n+// Copyright (c) 2009-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_EPOCHGUARD_H\n+#define BITCOIN_UTIL_EPOCHGUARD_H\n+\n+#include <threadsafety.h>\n+\n+#include <cassert>\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class LOCKABLE Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch = 0;\n+    bool m_guarded = false;\n+\n+public:\n+    Epoch() { }\n+    Epoch(const Epoch&) = delete;\n+    Epoch& operator=(const Epoch&) = delete;\n+\n+    bool guarded() const { return m_guarded; }\n+\n+    class Marker {",
    "path": "src/util/epochguard.h",
    "position": null,
    "original_position": 46,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "88019f9a183d396713fd357604a6e472c5ed8807",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "style nit, suggested by `clang-format`:\r\n```suggestion\r\n    class Marker\r\n    {\r\n```",
    "created_at": "2021-01-15T21:14:58Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558596003",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558596003"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558596003"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558596003/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 46,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558596167",
    "pull_request_review_id": 569619362,
    "id": 558596167,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU5NjE2Nw==",
    "diff_hunk": "@@ -0,0 +1,88 @@\n+// Copyright (c) 2009-2010 Satoshi Nakamoto\n+// Copyright (c) 2009-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_EPOCHGUARD_H\n+#define BITCOIN_UTIL_EPOCHGUARD_H\n+\n+#include <threadsafety.h>\n+\n+#include <cassert>\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class LOCKABLE Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch = 0;\n+    bool m_guarded = false;\n+\n+public:\n+    Epoch() { }\n+    Epoch(const Epoch&) = delete;\n+    Epoch& operator=(const Epoch&) = delete;\n+\n+    bool guarded() const { return m_guarded; }\n+\n+    class Marker {\n+    private:\n+        uint64_t m_marker = 0;\n+\n+        // only allow modification via Epoch member functions\n+        friend class Epoch;\n+        Marker& operator=(const Marker&) = delete;\n+    };\n+\n+    class SCOPED_LOCKABLE Guard {",
    "path": "src/util/epochguard.h",
    "position": null,
    "original_position": 55,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "88019f9a183d396713fd357604a6e472c5ed8807",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "style nit, suggested by `clang-format`:\r\n```suggestion\r\n    class SCOPED_LOCKABLE Guard\r\n    {\r\n```",
    "created_at": "2021-01-15T21:15:22Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558596167",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558596167"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558596167"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558596167/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 55,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558596990",
    "pull_request_review_id": 569619362,
    "id": 558596990,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU5Njk5MA==",
    "diff_hunk": "@@ -0,0 +1,88 @@\n+// Copyright (c) 2009-2010 Satoshi Nakamoto\n+// Copyright (c) 2009-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_EPOCHGUARD_H\n+#define BITCOIN_UTIL_EPOCHGUARD_H\n+\n+#include <threadsafety.h>\n+\n+#include <cassert>\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)",
    "path": "src/util/epochguard.h",
    "position": null,
    "original_position": 18,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "88019f9a183d396713fd357604a6e472c5ed8807",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "typo, https://github.com/bitcoin/bitcoin/pull/17925#discussion_r374052497:\r\n```suggestion\r\n * adds an asymptotic factor of O(log n) to traversals cost and triggers O(n)\r\n```",
    "created_at": "2021-01-15T21:17:15Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558596990",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558596990"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558596990"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558596990/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 18,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558607064",
    "pull_request_review_id": 569619362,
    "id": 558607064,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODYwNzA2NA==",
    "diff_hunk": "@@ -0,0 +1,88 @@\n+// Copyright (c) 2009-2010 Satoshi Nakamoto\n+// Copyright (c) 2009-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_EPOCHGUARD_H\n+#define BITCOIN_UTIL_EPOCHGUARD_H\n+\n+#include <threadsafety.h>\n+\n+#include <cassert>\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traverals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based\n+ * traversal, rather than a preference for std::set over epochs in that\n+ * algorithm.\n+ */\n+\n+class LOCKABLE Epoch\n+{\n+private:\n+    uint64_t m_raw_epoch = 0;\n+    bool m_guarded = false;\n+\n+public:\n+    Epoch() { }\n+    Epoch(const Epoch&) = delete;\n+    Epoch& operator=(const Epoch&) = delete;\n+\n+    bool guarded() const { return m_guarded; }\n+\n+    class Marker {\n+    private:\n+        uint64_t m_marker = 0;\n+\n+        // only allow modification via Epoch member functions\n+        friend class Epoch;\n+        Marker& operator=(const Marker&) = delete;\n+    };\n+\n+    class SCOPED_LOCKABLE Guard {\n+    private:\n+        Epoch& m_epoch;\n+\n+    public:\n+        explicit Guard(Epoch& epoch) EXCLUSIVE_LOCK_FUNCTION(epoch) : m_epoch(epoch)\n+        {\n+            assert(!m_epoch.m_guarded);\n+            ++m_epoch.m_raw_epoch;\n+            m_epoch.m_guarded = true;\n+        }\n+        ~Guard() UNLOCK_FUNCTION()\n+        {\n+            ++m_epoch.m_raw_epoch; // ensure clear separation between epochs",
    "path": "src/util/epochguard.h",
    "position": null,
    "original_position": 68,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "88019f9a183d396713fd357604a6e472c5ed8807",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n        {\r\n            assert(m_epoch.m_guarded);\r\n            ++m_epoch.m_raw_epoch; // ensure clear separation between epochs\r\n```",
    "created_at": "2021-01-15T21:40:39Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558607064",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558607064"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r558607064"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/558607064/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 67,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 71,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572593067",
    "pull_request_review_id": 586178649,
    "id": 572593067,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjU5MzA2Nw==",
    "diff_hunk": "@@ -21,6 +21,7 @@\n #include <primitives/transaction.h>\n #include <sync.h>\n #include <random.h>\n+#include <util/epochguard.h>",
    "path": "src/txmempool.h",
    "position": 4,
    "original_position": 4,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "88019f9a183d396713fd357604a6e472c5ed8807",
    "user": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Sorted in #20944",
    "created_at": "2021-02-09T04:53:23Z",
    "updated_at": "2021-02-09T05:37:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r572593067",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572593067"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r572593067"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572593067/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 24,
    "original_line": 24,
    "side": "RIGHT",
    "in_reply_to_id": 558593664
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573958822",
    "pull_request_review_id": 587905023,
    "id": 573958822,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mzk1ODgyMg==",
    "diff_hunk": "@@ -0,0 +1,91 @@\n+// Copyright (c) 2009-2010 Satoshi Nakamoto\n+// Copyright (c) 2009-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_EPOCHGUARD_H\n+#define BITCOIN_UTIL_EPOCHGUARD_H\n+\n+#include <threadsafety.h>\n+\n+#include <cassert>\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traversals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and",
    "path": "src/util/epochguard.h",
    "position": 21,
    "original_position": 21,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n * counter to track the time (or, \"epoch\") that we began a traversal and\r\n```",
    "created_at": "2021-02-10T18:10:07Z",
    "updated_at": "2021-02-10T19:02:34Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r573958822",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573958822"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r573958822"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573958822/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 21,
    "original_line": 21,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573959000",
    "pull_request_review_id": 587905023,
    "id": 573959000,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3Mzk1OTAwMA==",
    "diff_hunk": "@@ -0,0 +1,91 @@\n+// Copyright (c) 2009-2010 Satoshi Nakamoto\n+// Copyright (c) 2009-2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_UTIL_EPOCHGUARD_H\n+#define BITCOIN_UTIL_EPOCHGUARD_H\n+\n+#include <threadsafety.h>\n+\n+#include <cassert>\n+\n+/** Epoch: RAII-style guard for using epoch-based graph traversal algorithms.\n+ *     When walking ancestors or descendants, we generally want to avoid\n+ * visiting the same transactions twice. Some traversal algorithms use\n+ * std::set (or setEntries) to deduplicate the transaction we visit.\n+ * However, use of std::set is algorithmically undesirable because it both\n+ * adds an asymptotic factor of O(log n) to traversals cost and triggers O(n)\n+ * more dynamic memory allocations.\n+ *     In many algorithms we can replace std::set with an internal mempool\n+ * counter to track the time (or, \"epoch\") that we began a traversal, and\n+ * check + update a per-transaction epoch for each transaction we look at to\n+ * determine if that transaction has not yet been visited during the current\n+ * traversal's epoch.\n+ *     Algorithms using std::set can be replaced on a one by one basis.\n+ * Both techniques are not fundamentally incompatible across the codebase.\n+ * Generally speaking, however, the remaining use of std::set for mempool\n+ * traversal should be viewed as a TODO for replacement with an epoch based",
    "path": "src/util/epochguard.h",
    "position": 28,
    "original_position": 28,
    "commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "original_commit_id": "fd6580e405699ccb051fd2a34525e48d3253673d",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n * traversal should be viewed as a TODO for replacement with an epoch-based\r\n```",
    "created_at": "2021-02-10T18:10:20Z",
    "updated_at": "2021-02-10T19:02:34Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r573959000",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573959000"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18017#discussion_r573959000"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18017"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573959000/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 28,
    "original_line": 28,
    "side": "RIGHT"
  }
]