[
  {
    "sha": "321decffa1fbf213462d97e5372bd0c4eeb99635",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozMjFkZWNmZmExZmJmMjEzNDYyZDk3ZTUzNzJiZDBjNGVlYjk5NjM1",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-10-09T23:32:27Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-10-18T22:33:36Z"
      },
      "message": "rpc: Fix wallet unload during walletpassphrase timeout",
      "tree": {
        "sha": "ae345f8e0ef765aa3417acec9473215aacc2ffb6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ae345f8e0ef765aa3417acec9473215aacc2ffb6"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/321decffa1fbf213462d97e5372bd0c4eeb99635",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/321decffa1fbf213462d97e5372bd0c4eeb99635",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/321decffa1fbf213462d97e5372bd0c4eeb99635",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/321decffa1fbf213462d97e5372bd0c4eeb99635/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1d1417430c829a0c21bf5a2fe4a5b2f592a9423f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1d1417430c829a0c21bf5a2fe4a5b2f592a9423f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1d1417430c829a0c21bf5a2fe4a5b2f592a9423f"
      }
    ],
    "stats": {
      "total": 20,
      "additions": 12,
      "deletions": 8
    },
    "files": [
      {
        "sha": "37c8ce12b89f696481e5f4c5793f422bf0677553",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 12,
        "deletions": 8,
        "changes": 20,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/321decffa1fbf213462d97e5372bd0c4eeb99635/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/321decffa1fbf213462d97e5372bd0c4eeb99635/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=321decffa1fbf213462d97e5372bd0c4eeb99635",
        "patch": "@@ -1928,13 +1928,6 @@ static UniValue keypoolrefill(const JSONRPCRequest& request)\n }\n \n \n-static void LockWallet(CWallet* pWallet)\n-{\n-    LOCK(pWallet->cs_wallet);\n-    pWallet->nRelockTime = 0;\n-    pWallet->Lock();\n-}\n-\n static UniValue walletpassphrase(const JSONRPCRequest& request)\n {\n     std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(request);\n@@ -2004,7 +1997,18 @@ static UniValue walletpassphrase(const JSONRPCRequest& request)\n     pwallet->TopUpKeyPool();\n \n     pwallet->nRelockTime = GetTime() + nSleepTime;\n-    RPCRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), std::bind(LockWallet, pwallet), nSleepTime);\n+\n+    // Keep a weak pointer to the wallet so that it is possible to unload the\n+    // wallet before the following callback is called. If a valid shared pointer\n+    // is acquired in the callback then the wallet is still loaded.\n+    std::weak_ptr<CWallet> weak_wallet = wallet;\n+    RPCRunLater(strprintf(\"lockwallet(%s)\", pwallet->GetName()), [weak_wallet] {\n+        if (auto shared_wallet = weak_wallet.lock()) {\n+            LOCK(shared_wallet->cs_wallet);\n+            shared_wallet->Lock();\n+            shared_wallet->nRelockTime = 0;\n+        }\n+    }, nSleepTime);\n \n     return NullUniValue;\n }"
      }
    ]
  },
  {
    "sha": "8907df9e02ec47ef249a7422faa766f06aa01e94",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4OTA3ZGY5ZTAyZWM0N2VmMjQ5YTc0MjJmYWE3NjZmMDZhYTAxZTk0",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-10-19T22:10:49Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-10-20T10:02:35Z"
      },
      "message": "qa: Ensure wallet unload during walletpassphrase timeout",
      "tree": {
        "sha": "8c449ebc353097fcf754580c9664459829fde7e4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8c449ebc353097fcf754580c9664459829fde7e4"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8907df9e02ec47ef249a7422faa766f06aa01e94",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8907df9e02ec47ef249a7422faa766f06aa01e94",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/8907df9e02ec47ef249a7422faa766f06aa01e94",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8907df9e02ec47ef249a7422faa766f06aa01e94/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "321decffa1fbf213462d97e5372bd0c4eeb99635",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/321decffa1fbf213462d97e5372bd0c4eeb99635",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/321decffa1fbf213462d97e5372bd0c4eeb99635"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 5,
      "deletions": 0
    },
    "files": [
      {
        "sha": "af6c34e854a6d86cc6e2f5f45b0f22ae0eabaeca",
        "filename": "test/functional/wallet_multiwallet.py",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8907df9e02ec47ef249a7422faa766f06aa01e94/test/functional/wallet_multiwallet.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8907df9e02ec47ef249a7422faa766f06aa01e94/test/functional/wallet_multiwallet.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/wallet_multiwallet.py?ref=8907df9e02ec47ef249a7422faa766f06aa01e94",
        "patch": "@@ -8,6 +8,7 @@\n \"\"\"\n import os\n import shutil\n+import time\n \n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.test_node import ErrorMatch\n@@ -267,7 +268,11 @@ def wallet_file(name):\n         assert 'w1' not in self.nodes[0].listwallets()\n \n         # Successfully unload the wallet referenced by the request endpoint\n+        # Also ensure unload works during walletpassphrase timeout\n+        w2.encryptwallet('test')\n+        w2.walletpassphrase('test', 1)\n         w2.unloadwallet()\n+        time.sleep(1.1)\n         assert 'w2' not in self.nodes[0].listwallets()\n \n         # Successfully unload all wallets"
      }
    ]
  }
]