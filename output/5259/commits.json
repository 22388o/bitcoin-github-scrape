[
  {
    "sha": "d216ad27064d33a1c5c4250e0972fffceeb544b4",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkMjE2YWQyNzA2NGQzM2ExYzVjNDI1MGUwOTcyZmZmY2VlYjU0NGI0",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2014-11-10T15:53:27Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2014-11-10T16:08:35Z"
      },
      "message": "Make BIP62 rules 1 and 5 apply to non-evaluated signatures",
      "tree": {
        "sha": "9facba292e84a4bff0d76ffb5bc46e06640f1ae4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9facba292e84a4bff0d76ffb5bc46e06640f1ae4"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d216ad27064d33a1c5c4250e0972fffceeb544b4",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d216ad27064d33a1c5c4250e0972fffceeb544b4",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/d216ad27064d33a1c5c4250e0972fffceeb544b4",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d216ad27064d33a1c5c4250e0972fffceeb544b4/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "5406f61373fe93326ab1f546e4da9f4528236cc7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5406f61373fe93326ab1f546e4da9f4528236cc7",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/5406f61373fe93326ab1f546e4da9f4528236cc7"
      }
    ],
    "stats": {
      "total": 58,
      "additions": 54,
      "deletions": 4
    },
    "files": [
      {
        "sha": "85b5f779f76e02473f0593b31e9a28a4acbec6cb",
        "filename": "src/script/interpreter.cpp",
        "status": "modified",
        "additions": 14,
        "deletions": 1,
        "changes": 15,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d216ad27064d33a1c5c4250e0972fffceeb544b4/src/script/interpreter.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d216ad27064d33a1c5c4250e0972fffceeb544b4/src/script/interpreter.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/interpreter.cpp?ref=d216ad27064d33a1c5c4250e0972fffceeb544b4",
        "patch": "@@ -151,6 +151,15 @@ bool static CheckSignatureEncoding(const valtype &vchSig, unsigned int flags) {\n     return true;\n }\n \n+bool static CheckUnusedSignatureEncoding(const valtype &vchSig, unsigned int flags) {\n+    if ((flags & (SCRIPT_VERIFY_DERSIG | SCRIPT_VERIFY_LOW_S)) != 0 && !IsDERSignature(vchSig)) {\n+        return false;\n+    } else if ((flags & SCRIPT_VERIFY_LOW_S) != 0 && !IsLowDERSignature(vchSig)) {\n+        return false;\n+    }\n+    return true;\n+}\n+\n bool static CheckPubKeyEncoding(const valtype &vchSig, unsigned int flags) {\n     if ((flags & SCRIPT_VERIFY_STRICTENC) != 0 && !IsCompressedOrUncompressedPubKey(vchSig)) {\n         return false;\n@@ -813,8 +822,12 @@ bool EvalScript(vector<vector<unsigned char> >& stack, const CScript& script, un\n                     }\n \n                     // Clean up stack of actual arguments\n-                    while (i-- > 1)\n+                    while (i-- > 1) {\n+                        if (!CheckUnusedSignatureEncoding(stacktop(-1), flags)) {\n+                            return false;\n+                        }\n                         popstack(stack);\n+                    }\n \n                     // A bug causes CHECKMULTISIG to consume one extra argument\n                     // whose contents were not checked in any way."
      },
      {
        "sha": "1f175b476e9bc0b2c3f7754d02d2dd1c162e85f3",
        "filename": "src/script/interpreter.h",
        "status": "modified",
        "additions": 4,
        "deletions": 3,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d216ad27064d33a1c5c4250e0972fffceeb544b4/src/script/interpreter.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d216ad27064d33a1c5c4250e0972fffceeb544b4/src/script/interpreter.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/interpreter.h?ref=d216ad27064d33a1c5c4250e0972fffceeb544b4",
        "patch": "@@ -37,11 +37,12 @@ enum\n     // skipped (not softfork safe: this flag can widen the validity of OP_CHECKSIG OP_NOT).\n     SCRIPT_VERIFY_STRICTENC = (1U << 1),\n \n-    // Passing a non-strict-DER signature to a checksig operation causes script failure (softfork safe, BIP62 rule 1)\n+    // Passing any non-strict-DER signature to a checksig operation causes script failure, even if that signature would\n+    // not normally be evaluated. (softfork safe, BIP62 rule 1)\n     SCRIPT_VERIFY_DERSIG    = (1U << 2),\n \n-    // Passing a non-strict-DER signature or one with S > order/2 to a checksig operation causes script failure\n-    // (softfork safe, BIP62 rule 5).\n+    // Passing any non-strict-DER signature or one with S > order/2 to a checksig operation causes script failure, even\n+    // if that signature would not normally be evaluated. (softfork safe, BIP62 rule 5).\n     SCRIPT_VERIFY_LOW_S     = (1U << 3),\n \n     // verify dummy stack item consumed by CHECKMULTISIG is of zero-length (softfork safe, BIP62 rule 7)."
      },
      {
        "sha": "f8df36d4f72cb3442b5f2b22189f8c3b0590197c",
        "filename": "src/test/data/script_invalid.json",
        "status": "modified",
        "additions": 12,
        "deletions": 0,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d216ad27064d33a1c5c4250e0972fffceeb544b4/src/test/data/script_invalid.json",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d216ad27064d33a1c5c4250e0972fffceeb544b4/src/test/data/script_invalid.json",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/data/script_invalid.json?ref=d216ad27064d33a1c5c4250e0972fffceeb544b4",
        "patch": "@@ -557,12 +557,24 @@ nSequences are max.\n     \"DERSIG\",\n     \"P2PK NOT with too much R padding\"\n ],\n+[\n+    \"0 0x47 0x3044022016662440f74c7fc6b687b0de044715b5c7620693cbe9cadf324d3e918ce4fd1702205851d1a1e7ead730858bbd39f60cdc5ea4c9db13d48e783d32155bd33fca222c01 0x48 0x3045022067da1d860794e290d75cc17b9116d2476dd2e04a1dc131c0aa5513b61078ae28022100521200a8a3f2a7b83c39d9221368eaf4b45442e3e45451ea86f645836bce8de901\",\n+    \"2 0x21 0x0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798 0x21 0x038282263212c609d9ea2a6e3e172de238d8c39cabd5ac1ca10646e23fd5f51508 2 CHECKMULTISIG NOT\",\n+    \"DERSIG\",\n+    \"2-of-2 NOT with one invalid signature and one valid non-DER signature\"\n+],\n [\n     \"0x48 0x304502206c43e065c8a8db3bbe69015afb86a51fb2fc8870defd41d436da2a197d9d6c12022100fcec35816ee2d84ec271ad159fcabf5dd712157051169e48ac328a7818cdb51e01\",\n     \"0x21 0x03363d90d447b00c9c99ceac05b6262ee053441c7e55552ffe526bad8f83ff4640 CHECKSIG\",\n     \"LOW_S,STRICTENC\",\n     \"P2PK with high S\"\n ],\n+[\n+    \"0 0x47 0x304402207c31742e1e069dd60feccf731a81c1ad211e004526be64b07fbbddd3c86c2512022032eeec29e63e28f1437da97ad03ef2f0f993e4b73c43487d3f24c947b8b319ff01 0x48 0x3045022046fa255d82eb9a1de1f86fb876dc73ad4a32d8b2efd58492b609498d27a181f7022100d99558ae9d8e8dc0dc4d46c37c37e01f82d5c3e731661bfee13747151023fdf801\",\n+    \"2 0x21 0x0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798 0x21 0x038282263212c609d9ea2a6e3e172de238d8c39cabd5ac1ca10646e23fd5f51508 2 CHECKMULTISIG NOT\",\n+    \"LOW_S\",\n+    \"2-of-2 NOT with one invalid signature and one valid high-S signature\"\n+],\n [\n     \"0x47 0x304402203aab50cd7c30cc1e1475dee615b295bcee6ccf8aa8a7f6cda6b696c70d79cbb40220558e43fe7596c31146e2d077698d5a9c38351d8ba567549a2ae43ca97231c39501\",\n     \"0x41 0x0679be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8 CHECKSIG\","
      },
      {
        "sha": "f93c7d09d4d77d1ec9e0beb85d4fbf1ebf006f82",
        "filename": "src/test/data/script_valid.json",
        "status": "modified",
        "additions": 12,
        "deletions": 0,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d216ad27064d33a1c5c4250e0972fffceeb544b4/src/test/data/script_valid.json",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d216ad27064d33a1c5c4250e0972fffceeb544b4/src/test/data/script_valid.json",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/data/script_valid.json?ref=d216ad27064d33a1c5c4250e0972fffceeb544b4",
        "patch": "@@ -726,12 +726,24 @@ nSequences are max.\n     \"\",\n     \"P2PK NOT with bad sig with too much R padding but no DERSIG\"\n ],\n+[\n+    \"0 0x47 0x30440220094e01d641543aec146913f67133abd7f774b9654835a47ad9134a213864280102201cc83e796d5700b064b42a8f48513faf81efe79a4eeb1dd12793ecafa762054801 0x48 0x3045022040382ec7684f856aeac2837ce27f36b8d3816ba55ab5ed565f19ee87307805930221004b0b446476a460e8ae26e638a0839dff4af1b6ee0dd8f500e9e3085715311c3301\",\n+    \"2 0x21 0x0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798 0x21 0x038282263212c609d9ea2a6e3e172de238d8c39cabd5ac1ca10646e23fd5f51508 2 CHECKMULTISIG NOT\",\n+    \"\",\n+    \"2-of-2 NOT with one invalid signature and one valid non-DER signature, without DERSIG\"\n+],\n [\n     \"0x48 0x3045022021bf9184d94f208ac9f4757ebca9b1cbebf008cfc244fe5be1360b1b9aba0e92022100e55074f72f3a1bfddf2ea4ea7ba984f78822e136fe04c8f9c1363238e0233bd801\",\n     \"0x21 0x03363d90d447b00c9c99ceac05b6262ee053441c7e55552ffe526bad8f83ff4640 CHECKSIG\",\n     \"STRICTENC\",\n     \"P2PK with high S but no LOW_S\"\n ],\n+[\n+    \"0 0x47 0x304402202486889f8c58bc8cd146de1f682e622539fa58e3ef180f0ecfd2e90771a1657102204fa6be9b55878270b01975908ed006e2e68933f5c1e397046914e4856536033e01 0x48 0x304502200f0b3be9a9a851839d6724f59fbdbb9a9b46d7476144a7dd8677c1aa379cb458022100df6388085860776f91459cb33f49bb8f44a7714ca0590a93a8f2c6b6048a2ebc01\",\n+    \"2 0x21 0x0279be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798 0x21 0x038282263212c609d9ea2a6e3e172de238d8c39cabd5ac1ca10646e23fd5f51508 2 CHECKMULTISIG NOT\",\n+    \"\",\n+    \"2-of-2 NOT with one invalid signature and one valid high-S signature, without LOW_S\"\n+],\n [\n     \"0x47 0x304402202163bc732c21b7de0251297d3c6c2ece182782e85fc5e19d6036f1130a79051e022033827811634924ebba68767537d78dd7bd9109ae2a89a60587927abdc25eb06401\",\n     \"0x41 0x0679be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798483ada7726a3c4655da4fbfc0e1108a8fd17b448a68554199c47d08ffb10d4b8 CHECKSIG\","
      },
      {
        "sha": "aea3952475c9f1ae6b8a6786d065f6e6feb7b803",
        "filename": "src/test/script_tests.cpp",
        "status": "modified",
        "additions": 12,
        "deletions": 0,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d216ad27064d33a1c5c4250e0972fffceeb544b4/src/test/script_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d216ad27064d33a1c5c4250e0972fffceeb544b4/src/test/script_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/script_tests.cpp?ref=d216ad27064d33a1c5c4250e0972fffceeb544b4",
        "patch": "@@ -351,13 +351,25 @@ BOOST_AUTO_TEST_CASE(script_build)\n     bad.push_back(TestBuilder(CScript() << ToByteVector(keys.pubkey2C) << OP_CHECKSIG << OP_NOT,\n                               \"P2PK NOT with too much R padding\", SCRIPT_VERIFY_DERSIG\n                              ).PushSig(keys.key2, SIGHASH_ALL, 31, 32).EditPush(1, \"43021F\", \"44022000\"));\n+    good.push_back(TestBuilder(CScript() << OP_2 << ToByteVector(keys.pubkey0C) << ToByteVector(keys.pubkey1C) << OP_2 << OP_CHECKMULTISIG << OP_NOT,\n+                               \"2-of-2 NOT with one invalid signature and one valid non-DER signature, without DERSIG\", 0\n+                              ).Num(0).PushSig(keys.key2).PushSig(keys.key1).EditPush(1, \"44\", \"45\").EditPush(37, \"20\", \"2100\"));\n+    bad.push_back(TestBuilder(CScript() << OP_2 << ToByteVector(keys.pubkey0C) << ToByteVector(keys.pubkey1C) << OP_2 << OP_CHECKMULTISIG << OP_NOT,\n+                              \"2-of-2 NOT with one invalid signature and one valid non-DER signature\", SCRIPT_VERIFY_DERSIG\n+                             ).Num(0).PushSig(keys.key2).PushSig(keys.key1).EditPush(1, \"44\", \"45\").EditPush(37, \"20\", \"2100\"));\n \n     good.push_back(TestBuilder(CScript() << ToByteVector(keys.pubkey2C) << OP_CHECKSIG,\n                                \"P2PK with high S but no LOW_S\", 0\n                               ).PushSig(keys.key2, SIGHASH_ALL, 32, 33));\n     bad.push_back(TestBuilder(CScript() << ToByteVector(keys.pubkey2C) << OP_CHECKSIG,\n                               \"P2PK with high S\", SCRIPT_VERIFY_LOW_S\n                              ).PushSig(keys.key2, SIGHASH_ALL, 32, 33));\n+    good.push_back(TestBuilder(CScript() << OP_2 << ToByteVector(keys.pubkey0C) << ToByteVector(keys.pubkey1C) << OP_2 << OP_CHECKMULTISIG << OP_NOT,\n+                               \"2-of-2 NOT with one invalid signature and one valid high-S signature, without LOW_S\", 0\n+                              ).Num(0).PushSig(keys.key2).PushSig(keys.key1, SIGHASH_ALL, 32, 33));\n+    bad.push_back(TestBuilder(CScript() << OP_2 << ToByteVector(keys.pubkey0C) << ToByteVector(keys.pubkey1C) << OP_2 << OP_CHECKMULTISIG << OP_NOT,\n+                              \"2-of-2 NOT with one invalid signature and one valid high-S signature\", SCRIPT_VERIFY_LOW_S\n+                             ).Num(0).PushSig(keys.key2).PushSig(keys.key1, SIGHASH_ALL, 32, 33));\n \n     good.push_back(TestBuilder(CScript() << ToByteVector(keys.pubkey0H) << OP_CHECKSIG,\n                                \"P2PK with hybrid pubkey but no STRICTENC\", 0"
      }
    ]
  }
]