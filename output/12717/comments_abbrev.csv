promag,2018-03-20T22:55:50Z,"utACK b1038af.\n\nNit, could get rid of `viewDummy` by using `viewChain` by default:\n```cpp\n        LOCK2(cs_main, mempool.cs);\n\n        CCoinsViewCache& viewChain = *pcoinsTip;\n        CCoinsViewMemPool viewMempool(&viewChain, mempool);\n        CCoinsViewCache view(&viewChain);\n        if (fCheckMemPool) {\n            // switch cache backend to db+mempool in case user likes to q",https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-374785128,374785128,
eklitzke,2018-03-21T01:22:36Z,"utACK b1038afceadacb640ab1fa4fd9b577bb51d45e84 \n\nBut since we are nitting, I would probably do it like this\n\n```c++\nCCoinsViewCache view(fCheckMemPool ? &viewMempool : &viewChain);\n```\n\nNot a big deal either way.",https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-374810297,374810297,
romanz,2018-03-21T06:42:12Z,"Thanks for the review!\nI have removed `viewDummy` as suggested.",https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-374845762,374845762,
promag,2018-03-21T14:13:22Z,"@eklitzke that gives:\n```cpp\nrest.cpp:495:44: error: incompatible operand types ('CCoinsViewMemPool *' and 'CCoinsViewCache *')\n```\nit needs a cast:\n```cpp\nCCoinsViewCache view(fCheckMemPool ? (CCoinsView*) &viewMempool : &viewChain);\n```\nBut yeah, either way.",https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-374950942,374950942,
promag,2018-03-21T14:18:06Z,"But I wonder if it pays off dealing with both cases separately:\n```cpp\nif (fCheckMemPool) {\n    LOCK2(cs_main, mempool.cs);\n    CCoinsViewCache& viewChain = *pcoinsTip;\n    CCoinsViewMemPool viewMempool(&viewChain, mempool);\n    CCoinsViewCache view(&viewMempool);\n    ...\n} else {\n    LOCK(cs_main);  // no need to lock mempool!\n    CCoinsViewCache& viewChain = *pcoinsTip;\n   ",https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-374952539,374952539,
romanz,2018-03-21T17:06:52Z,"@eklitzke @promag I'm fine with both suggestions, please let me know which is the preferred one :)",https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-375020462,375020462,
eklitzke,2018-03-21T23:05:03Z,The way @promag just suggested is best of all. If you want to do that you'll have to refactor the loop out so it can be called in both code paths. You can do that by adding a new static method or using a lambda.,https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-375124584,375124584,
romanz,2018-03-22T12:10:18Z,"Thanks!\nI have updated the code according to the suggestion above (refactoring the loop into a lambda), and added a few more tests (to make sure that we don't return outputs, being spent by mempool transactions).",https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-375282319,375282319,
romanz,2018-03-22T20:22:46Z,"Thanks for the review and the suggestion!\nI agree, and would be happy to fix this issue (together with a general tidying-up of `interface_rest.py` tests) in a following PR.",https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-375444680,375444680,
jnewbery,2018-03-22T20:57:28Z,"> I agree, and would be happy to fix this issue (together with a general tidying-up of interface_rest.py tests) in a following PR.\n\nGreat! I already started tidying up the test here: https://github.com/jnewbery/bitcoin/tree/tidy_up_rest_test . I haven't opened a PR yet. Let me know what you think (and feel free to take the branch, modify as you see fit and open a PR if you want to take this on",https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-375455058,375455058,
sipa,2018-03-22T21:22:02Z,utACK 5e2cfcba4a46a6d39f38f03dcd30543d259f181b,https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-375461695,375461695,
romanz,2018-03-22T21:39:00Z,"@jnewbery The branch looks great :)\nI will continue the development at https://github.com/romanz/bitcoin/commits/tidy_up_rest_test in the upcoming days.\nMuch appreciated, and thanks again!",https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-375466352,375466352,
jnewbery,2018-03-26T15:42:11Z,"Tested ACK 9cb9af8c41e4a7abd6b3e011127c4274557ca7e4.\n\nOnly differences are addressing @sipa's and @promag's review comments.\n\nmeta point - I'm not sure if this conflicted with master and needed rebase. In general it's better to avoid rebase if possible since it makes re-reviewing easier if old and new branches are from the same base commit.",https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-376212070,376212070,
romanz,2018-03-26T17:45:51Z,">  In general it's better to avoid rebase if possible since it makes re-reviewing easier if old and new branches are from the same base commit.\n\nWill do, thanks for the tip!",https://github.com/bitcoin/bitcoin/pull/12717#issuecomment-376252029,376252029,
jnewbery,2018-03-22T16:07:25Z,"I think this comment could be clearer. Something like `# tx not found since it is in the mempool (and /mempool not included in request`\n\nedit: in fact, I think you could remove all the inline comments and just place a comment at the top of the section explaining what's happening (create a transaction, check that it's found with `/checkmempool`, but not found without, then confirm the transacti",https://github.com/bitcoin/bitcoin/pull/12717#discussion_r176478821,176478821,test/functional/interface_rest.py
sipa,2018-03-22T20:52:42Z,"There's no need for an intermediary cache here anymore. You can make the lambda take a `CCoinsView&` instead, and either pass it `viewMempool` (here) or `*pcoinsTip` (below) directly.",https://github.com/bitcoin/bitcoin/pull/12717#discussion_r176568629,176568629,src/rest.cpp
romanz,2018-03-22T21:10:47Z,"You're right, thanks for the catch!\nWill amend the commit, and update this PR.",https://github.com/bitcoin/bitcoin/pull/12717#discussion_r176573437,176573437,src/rest.cpp
promag,2018-03-24T20:46:34Z,"Alternative:\n```cpp\nCoin coin;\nconst bool hit = !mempool.isSpent(vOutPoint) && view.GetCoin(vOutPoint, coin);\nhits.push_back(hit);\nif (hit) outs.emplace_back(std::move(coin));\n```\nAlso, cheapest condition to fail should come first, and I think `!isSpent` is the cheapest in both cases.",https://github.com/bitcoin/bitcoin/pull/12717#discussion_r176919689,176919689,src/rest.cpp
romanz,2018-03-25T08:56:00Z,"Thanks for the suggestion!\nI have updated and rebased the PR.",https://github.com/bitcoin/bitcoin/pull/12717#discussion_r176933522,176933522,src/rest.cpp
