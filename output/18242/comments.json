[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/593496115",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-593496115",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 593496115,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5MzQ5NjExNQ==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-02T16:41:08Z",
    "updated_at": "2021-01-25T06:34:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21000 (fuzz: Add UBSan suppressions needed for fuzz tests to not warn under -fsanitize=integer by practicalswift)\n* #20685 (Add I2P support using I2P SAM by vasild)\n* #20429 (refactor: replace (sizeof(a)/sizeof(a[0])) with C++17 std::size by theStack)\n* #20196 (net: fix GetListenPort() to derive the proper port by vasild)\n* #19064 (refactor: Cleanup thread ctor calls by hebasto)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/593496115/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/593665514",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-593665514",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 593665514,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5MzY2NTUxNA==",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?u=7297e8aaf9188c0cb98bc549a8a02a1dc8d59e4c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-02T22:54:12Z",
    "updated_at": "2020-03-02T22:54:12Z",
    "author_association": "MEMBER",
    "body": "Concept ACK.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/593665514/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/593674721",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-593674721",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 593674721,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5MzY3NDcyMQ==",
    "user": {
      "login": "practicalswift",
      "id": 7826565,
      "node_id": "MDQ6VXNlcjc4MjY1NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7826565?u=5ff13e375b40ea55ecd3c108337dd6a23f68eddf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/practicalswift",
      "html_url": "https://github.com/practicalswift",
      "followers_url": "https://api.github.com/users/practicalswift/followers",
      "following_url": "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url": "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
      "organizations_url": "https://api.github.com/users/practicalswift/orgs",
      "repos_url": "https://api.github.com/users/practicalswift/repos",
      "events_url": "https://api.github.com/users/practicalswift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/practicalswift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-02T23:22:18Z",
    "updated_at": "2020-03-03T11:06:03Z",
    "author_association": "CONTRIBUTOR",
    "body": "Concept:\r\n\r\nConcept ACK - thanks for working on this!\r\n\r\n---\r\n\r\nImplementation:\r\n\r\nSome comments after first read-through of the implementation:\r\n\r\n**1. Uninitialized read in case of invalid command name**\r\n\r\nIn the \"Invalid command name\" case then a read (and use) of the uninitialized variable `size_or_shortid` will take place on L808:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/73db845771628983c7f288ead73cd3a8793f8c6a/src/net.cpp#L802-L808\r\n\r\n_Shameless plug:_ For those interested in killing the uninitialised read bug class, consider reviewing:\r\n* #17639 \u2013 tests: Add `make check-valgrind` to run the unit tests under Valgrind\r\n* #17895 \u2013 build: Enable Clang's `-Wconditional-uninitialized` to warn on potential uninitialized reads\r\n\r\n**2. Use of a locale dependent formatting function `itostr(\u2026)`**\r\n\r\n`itostr` is used here:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/73db845771628983c7f288ead73cd3a8793f8c6a/src/net.cpp#L819-L823\r\n\r\n`itostr` calls `strprintf` which calls `tfm::format` (tinyformat) which uses the standard C++ formatting stringstream interface which is locale dependent.\r\n\r\n_Shameless plug:_ For those interested in permanently killing the locale dependency bug class, consider reviewing:\r\n* #18124 \u2013 init: Clarify C and C++ locale assumptions. Add locale sanity checks to verify assumptions at run-time\r\n* #18126 \u2013 tests: Add fuzzing harness testing the locale independence of the strencodings.h functions\r\n* #18147 \u2013 qt: Kill the locale dependency bug class by not allowing Qt to mess with `LC_NUMERIC`\r\n\r\n**3. `std::exception` vs expected `std::ios_base::failure`**\r\n\r\nA question: I notice that `std::exception` is guarded against instead of the expected `std::ios_base::failure` in case of deserialization errors throughout this PR. Is it intentional? :)\r\n\r\nIt is somewhat related to another deserialization-exception anomaly I mailed you about back in October last year:\r\n\r\n```\r\nWhen fuzzing some deserialization code I noticed that `CExtKey::Unserialize(...)`\r\nand `CExtPubKey::(...)` throw `std::runtime_error` instead of the\r\n`std::ios_base::failure` I expected in case of deserialization errors.\r\n\r\nI saw that this code was written by you originally: do you remember if there\r\nwas a particular reason to go with `std::runtime_error` instead of\r\n`std::ios_base::failure`? If not, do you think it would be safe to change it? :)\r\n\r\nThe commits in question:\r\n*\u00a0https://github.com/bitcoin/bitcoin/commit/07685d1bc1b0b815c00a68a5b7b335ffa0d4d90d\r\n*\u00a0https://github.com/bitcoin/bitcoin/commit/90604f16af63ec066d6561337f476ccd8acec326\r\n```\r\n\r\nThese deviations from the expected`std::ios_base::failure` puzzle me - are they intentional, and if so why? I want to learn :)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/593674721/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/593678921",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-593678921",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 593678921,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5MzY3ODkyMQ==",
    "user": {
      "login": "practicalswift",
      "id": 7826565,
      "node_id": "MDQ6VXNlcjc4MjY1NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7826565?u=5ff13e375b40ea55ecd3c108337dd6a23f68eddf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/practicalswift",
      "html_url": "https://github.com/practicalswift",
      "followers_url": "https://api.github.com/users/practicalswift/followers",
      "following_url": "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url": "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
      "organizations_url": "https://api.github.com/users/practicalswift/orgs",
      "repos_url": "https://api.github.com/users/practicalswift/repos",
      "events_url": "https://api.github.com/users/practicalswift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/practicalswift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-02T23:36:42Z",
    "updated_at": "2020-03-02T23:53:06Z",
    "author_association": "CONTRIBUTOR",
    "body": "Very nice to see that the `V2TransportDeserializer` is fuzzed already from birth! I hope that fuzz testing will be as natural as unit testing when introducing security critical code in the future. Kudos for taking care of it here!\r\n\r\nA small comment regarding the fuzzer:\r\n\r\nI think the assertion \u2026\r\n\r\n```\r\nassert(msg.m_raw_message_size == CMessageHeader::HEADER_SIZE + msg.m_message_size);\r\n```\r\n\r\n\u2026 in the fuzzing harness is guaranteed to hold for `V1TransportDeserializer` but not for `V2TransportDeserializer`.\r\n\r\nCould that be the case? :)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/593678921/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/602028339",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-602028339",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 602028339,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwMjAyODMzOQ==",
    "user": {
      "login": "practicalswift",
      "id": 7826565,
      "node_id": "MDQ6VXNlcjc4MjY1NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7826565?u=5ff13e375b40ea55ecd3c108337dd6a23f68eddf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/practicalswift",
      "html_url": "https://github.com/practicalswift",
      "followers_url": "https://api.github.com/users/practicalswift/followers",
      "following_url": "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url": "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
      "organizations_url": "https://api.github.com/users/practicalswift/orgs",
      "repos_url": "https://api.github.com/users/practicalswift/repos",
      "events_url": "https://api.github.com/users/practicalswift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/practicalswift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-21T11:09:32Z",
    "updated_at": "2020-03-21T11:09:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "Add \"Waiting for author\" tag? :)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/602028339/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/604891842",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-604891842",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 604891842,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwNDg5MTg0Mg==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-27T09:04:15Z",
    "updated_at": "2020-03-27T09:04:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks @practicalswift for the review. I tried to fix the exception handling as well as uninitialised read. I also fixed the invalid fuzzing assertion (for V2).\r\n\r\nI'm unsure about the locale dependent formatting. What would you recommend instead of `itotsr`?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/604891842/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/605020188",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-605020188",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 605020188,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwNTAyMDE4OA==",
    "user": {
      "login": "practicalswift",
      "id": 7826565,
      "node_id": "MDQ6VXNlcjc4MjY1NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7826565?u=5ff13e375b40ea55ecd3c108337dd6a23f68eddf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/practicalswift",
      "html_url": "https://github.com/practicalswift",
      "followers_url": "https://api.github.com/users/practicalswift/followers",
      "following_url": "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url": "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
      "organizations_url": "https://api.github.com/users/practicalswift/orgs",
      "repos_url": "https://api.github.com/users/practicalswift/repos",
      "events_url": "https://api.github.com/users/practicalswift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/practicalswift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-27T14:08:11Z",
    "updated_at": "2020-03-27T14:08:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "@jonasschnelli \r\n\r\n> I'm unsure about the locale dependent formatting. What would you recommend instead of `itotsr`?\r\n\r\nI recommend `ToString(\u2026)` (`util/string.h`) :)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/605020188/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/607614762",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-607614762",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 607614762,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwNzYxNDc2Mg==",
    "user": {
      "login": "practicalswift",
      "id": 7826565,
      "node_id": "MDQ6VXNlcjc4MjY1NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7826565?u=5ff13e375b40ea55ecd3c108337dd6a23f68eddf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/practicalswift",
      "html_url": "https://github.com/practicalswift",
      "followers_url": "https://api.github.com/users/practicalswift/followers",
      "following_url": "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url": "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
      "organizations_url": "https://api.github.com/users/practicalswift/orgs",
      "repos_url": "https://api.github.com/users/practicalswift/repos",
      "events_url": "https://api.github.com/users/practicalswift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/practicalswift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-02T04:32:18Z",
    "updated_at": "2020-04-02T04:32:18Z",
    "author_association": "CONTRIBUTOR",
    "body": "@PastaPastaPasta Worth mentioning for future reviews: we use `clang-format` in the project so the 11 specific whitespace review comments could be simplified to a one general review comment \"Nit: Please use `clang-format-diff.py ` on this diff\" :)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/607614762/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/608056625",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-608056625",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 608056625,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYwODA1NjYyNQ==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-02T19:23:15Z",
    "updated_at": "2020-04-02T19:23:15Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks @PastaPastaPasta and @practicalswift. Applied clang-format now.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/608056625/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/613350737",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-613350737",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 613350737,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYxMzM1MDczNw==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-14T10:11:34Z",
    "updated_at": "2020-04-14T10:11:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks @hebasto, @dongcarl and @MarcoFalke for the review.\r\nI tried to address all the points. You'r invited to go again through the PR for further findings.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/613350737/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/615322957",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-615322957",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 615322957,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYxNTMyMjk1Nw==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-04-17T15:52:29Z",
    "updated_at": "2020-04-17T15:52:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rebased.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/615322957/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622825133",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-622825133",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 622825133,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyMjgyNTEzMw==",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-02T07:55:10Z",
    "updated_at": "2020-05-02T07:55:10Z",
    "author_association": "MEMBER",
    "body": "Fuzzer updates:\r\n\r\nv1. `src/test/fuzz/p2p_v1_transport_deserializer ../qa-assets/fuzz_seed_corpus/` still running after 11 million iterations.\r\n```\r\n#11209522\tREDUCE cov: 1175 ft: 7368 corp: 138/1841Kb exec/s: 170 rss: 806Mb L: 1510/1048576 MS: 4 CMP-CMP-InsertRepeatedBytes-EraseBytes- DE: \"d\\x00\"-\"\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x16\"-\r\n#11215383\tREDUCE cov: 1175 ft: 7368 corp: 138/1841Kb exec/s: 170 rss: 806Mb L: 456/1048576 MS: 1 EraseBytes-\r\n#11399712\tREDUCE cov: 1175 ft: 7368 corp: 138/1841Kb exec/s: 170 rss: 806Mb L: 1509/1048576 MS: 4 EraseBytes-ChangeASCIIInt-CMP-CMP- DE: \"\\x00s\\x00\\x00\"-\"\\x00\\x00\\x00v\"-\r\n\r\n```\r\n\r\nv2. `src/test/fuzz/p2p_v2_transport_deserializer` without `qa-assets/fuzz_seed_corpus` crashed after a few million iterations.\r\n```\r\n#1048576\tpulse  cov: 2395 ft: 2701 corp: 15/2571b exec/s: 110 rss: 423Mb\r\n#2097152\tpulse  cov: 2395 ft: 2701 corp: 15/2571b exec/s: 112 rss: 424Mb\r\n#4194304\tpulse  cov: 2395 ft: 2701 corp: 15/2571b exec/s: 117 rss: 426Mb\r\n```\r\n\r\n<details>\r\n<summary>v2 fuzzer crash output</summary>\r\n<p>\r\n\r\n<code>$ src/test/fuzz/p2p_v2_transport_deserializer</code>\r\n\r\n```\r\n#4194304\tpulse  cov: 2395 ft: 2701 corp: 15/2571b exec/s: 117 rss: 426Mb\r\np2p_v2_transport_deserializer: test/fuzz/p2p_transport_deserializer.cpp:37: void test_deserializer(std::unique_ptr<TransportDeserializer> &, const std::vector<uint8_t> &, const int): Assertion `msg.m_raw_message_size == header_size + msg.m_message_size' failed.\r\n==8131== ERROR: libFuzzer: deadly signal\r\n    #0 0x564d8d9e69a7 in __sanitizer_print_stack_trace /tmp/final/llvm.src/projects/compiler-rt/lib/asan/asan_stack.cc:38:3\r\n    #1 0x564d8d924826 in fuzzer::Fuzzer::CrashCallback() /tmp/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:233:5\r\n    #2 0x564d8d9247ef in fuzzer::Fuzzer::StaticCrashSignalCallback() /tmp/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:206:6\r\n    #3 0x7f53564b372f  (/lib/x86_64-linux-gnu/libpthread.so.0+0x1272f)\r\n    #4 0x7f5355d107ba in gsignal (/lib/x86_64-linux-gnu/libc.so.6+0x377ba)\r\n    #5 0x7f5355cfb534 in abort (/lib/x86_64-linux-gnu/libc.so.6+0x22534)\r\n    #6 0x7f5355cfb40e in __tls_get_addr (/lib/x86_64-linux-gnu/libc.so.6+0x2240e)\r\n    #7 0x7f5355d09101 in __assert_fail (/lib/x86_64-linux-gnu/libc.so.6+0x30101)\r\n    #8 0x564d8da0ee4f in test_deserializer(std::unique_ptr<TransportDeserializer, std::default_delete<TransportDeserializer> >&, std::vector<unsigned char, std::allocator<unsigned char> > const&, int) /home/jon/projects/bitcoin/bitcoin/src/test/fuzz/p2p_transport_deserializer.cpp:37:13\r\n    #9 0x564d8da0f2ce in test_one_input(std::vector<unsigned char, std::allocator<unsigned char> > const&) /home/jon/projects/bitcoin/bitcoin/src/test/fuzz/p2p_transport_deserializer.cpp:59:5\r\n    #10 0x564d8ec5f1af in LLVMFuzzerTestOneInput /home/jon/projects/bitcoin/bitcoin/src/test/fuzz/fuzz.cpp:38:5\r\n    #11 0x564d8d925a7c in fuzzer::Fuzzer::ExecuteCallback(unsigned char const*, unsigned long) /tmp/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:515:13\r\n    #12 0x564d8d9252db in fuzzer::Fuzzer::RunOne(unsigned char const*, unsigned long, bool, fuzzer::InputInfo*, bool*) /tmp/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:440:3\r\n    #13 0x564d8d926d0d in fuzzer::Fuzzer::MutateAndTestOne() /tmp/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:648:19\r\n    #14 0x564d8d9275c5 in fuzzer::Fuzzer::Loop(std::vector<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> >, fuzzer::fuzzer_allocator<std::__cxx11::basic_string<char, std::char_traits<char>, std::allocator<char> > > > const&) /tmp/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerLoop.cpp:775:5\r\n    #15 0x564d8d91c2d0 in fuzzer::FuzzerDriver(int*, char***, int (*)(unsigned char const*, unsigned long)) /tmp/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerDriver.cpp:754:6\r\n    #16 0x564d8d93ded2 in main /tmp/final/llvm.src/projects/compiler-rt/lib/fuzzer/FuzzerMain.cpp:20:10\r\n    #17 0x7f5355cfd09a in __libc_start_main (/lib/x86_64-linux-gnu/libc.so.6+0x2409a)\r\n    #18 0x564d8d915369 in _start (/home/jon/projects/bitcoin/bitcoin/src/test/fuzz/p2p_v2_transport_deserializer+0x1d28369)\r\n\r\nNOTE: libFuzzer has rudimentary signal handlers.\r\n      Combine libFuzzer with AddressSanitizer or similar for better crash reports.\r\nSUMMARY: libFuzzer: deadly signal\r\nMS: 5 CMP-ChangeBinInt-CopyPart-CopyPart-InsertRepeatedBytes- DE: \"\\x9bG\\x1f\\x00\"-; base unit: 6931e757f50084d7f7e1142dae37b88f384b7c28\r\n0x65,0xb8,0xe0,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0x60,0xf5,0x65,0xb8,0xe0,0xf5,\r\ne\\xb8\\xe0```````````````````````````````````````````````````````````````````````````````````\\xf5e\\xb8\\xe0\\xf5\r\nartifact_prefix='./'; Test unit written to ./crash-7a494e2caeec52213088a24c43216beb0f331a65\r\nBase64: ZbjgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGBgYGD1Zbjg9Q==\r\n```\r\n</p>\r\n</details>\r\n\r\nIt appears to be the same crash as the ones I was seeing immediately when running the v2 fuzz test with the qa-assets seeds in https://github.com/bitcoin/bitcoin/pull/18242#pullrequestreview-404120272 above, e.g.\r\n\r\n```\r\nsrc/test/fuzz/p2p_v2_transport_deserializer ../qa-assets/fuzz_seed_corpus/\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/622825133/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/625710068",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-625710068",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 625710068,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNTcxMDA2OA==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-08T08:43:16Z",
    "updated_at": "2020-05-08T08:43:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "I found the issue revealed by the fuzzer crash (reported by @jonatack).\r\n\r\nThe fuzzer assertion `assert(msg.m_raw_message_size == header_size + msg.m_message_size);` assumes that the `msg.m_message_size` never contains the size of the header (in V2, the header is the `MAC` & the `AD` [AD == encrypted message length]).\r\n\r\nThough, if the decryption failed (due to a valid size message but an invalid `MAC`), the code did **not** reduce the header size from `msg.m_message_size` and thus violating the `TransportDeserializer` protocol.\r\n\r\nThe just added commit d1a000d70aa6eccc45a8f7062c4f835073f625ed fixes this.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/625710068/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/625711283",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-625711283",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 625711283,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNTcxMTI4Mw==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-08T08:46:35Z",
    "updated_at": "2020-05-08T08:46:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "I added another commit (222d5334681c517636c933c9491200fbbabf3c8d) that fixes the issue reported by @ariard (https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418933381).\r\nThe bytes counter for detecting a violation of the 1GB rekey limit was not correctly incremented.\r\nIn case a valid size message had an invalid MAC, the bytes counter was not incremented leading to the problem that a flooding of messages with invalid MACs will not trigger the transmition-limit rekey.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/625711283/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/626172638",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-626172638",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 626172638,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNjE3MjYzOA==",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-09T13:00:18Z",
    "updated_at": "2020-05-09T13:00:18Z",
    "author_association": "MEMBER",
    "body": "Ran the new fuzzer for 24 hours with the qa-assets seeds, which previously crashed immediately (https://github.com/bitcoin/bitcoin/pull/18242#pullrequestreview-404120272)... looks good after 5.5M execs.\r\n```\r\n$ src/test/fuzz/p2p_v2_transport_deserializer ../qa-assets/fuzz_seed_corpus/\r\n\r\n#5332942\tREDUCE cov: 3039 ft: 6681 corp: 55/10942Kb exec/s: 58 rss: 712Mb L: 738789/1040651 MS: 1 EraseBytes-\r\n#5369365\tREDUCE cov: 3039 ft: 6681 corp: 55/10940Kb exec/s: 58 rss: 712Mb L: 736365/1040651 MS: 3 CMP-PersAutoDict-EraseBytes- DE: \"\\x0d\\x00\\x00\\x00\"-\"\\x01\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"-\r\n#5552616\tREDUCE cov: 3039 ft: 6681 corp: 55/10939Kb exec/s: 58 rss: 712Mb L: 751449/1040651 MS: 1 CrossOver-\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/626172638/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/627806757",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-627806757",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 627806757,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYyNzgwNjc1Nw==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-13T07:37:26Z",
    "updated_at": "2020-05-13T07:37:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rebased.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/627806757/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632012221",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-632012221",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 632012221,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzMjAxMjIyMQ==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-05-21T10:32:55Z",
    "updated_at": "2020-05-21T10:32:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rebased (only code formatting conflicts in `protocol.h`).",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/632012221/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637666341",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-637666341",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 637666341,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNzY2NjM0MQ==",
    "user": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?u=62e3204f6586795420395a7059ec7dc7c4a40c7d&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-02T16:30:12Z",
    "updated_at": "2020-06-02T16:30:12Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rebased this PR for you :relaxed:: https://github.com/bitcoin/bitcoin/compare/master...dongcarl:2020-06-net_v2-rebased",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637666341/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637711905",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-637711905",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 637711905,
    "node_id": "MDEyOklzc3VlQ29tbWVudDYzNzcxMTkwNQ==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-06-02T18:00:02Z",
    "updated_at": "2020-06-02T18:00:02Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks @dongcarl. Was a trivial closing bracket rebase. Rebase pushed.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/637711905/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666455394",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-666455394",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 666455394,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY2NjQ1NTM5NA==",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?u=13b19d1ff2f5f914e180c41418f451a4ba6f8bd1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-30T15:27:18Z",
    "updated_at": "2020-07-30T15:27:18Z",
    "author_association": "MEMBER",
    "body": "Needs rebase and comments addressed (there's a lot by now).",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/666455394/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/671003584",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-671003584",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 671003584,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3MTAwMzU4NA==",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?u=ca58f5c566ff1ad12d396a5b2a5b9e2c5d40e4c0&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-09T04:11:02Z",
    "updated_at": "2020-08-09T04:11:02Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hopefully this helps this PR continue:\r\n\r\nI went ahead and rebased this PR, there were a bit of conflicts that I had to resolve. The branch can be found here https://github.com/bitcoin/bitcoin/compare/master...PastaPastaPasta:pr_btc_18242 https://github.com/PastaPastaPasta/dash/commits/pr_btc_18242 This branch builds and passes all tests locally\r\n\r\nAdditionally, I have created a branch that addresses any nits I could find in the review. That branch can be found here https://github.com/bitcoin/bitcoin/compare/master...PastaPastaPasta:pr_btc_18242_code_review",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/671003584/reactions",
      "total_count": 3,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/671844569",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-671844569",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 671844569,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3MTg0NDU2OQ==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-11T09:43:10Z",
    "updated_at": "2020-08-11T09:43:10Z",
    "author_association": "CONTRIBUTOR",
    "body": "Sorry for the delay. Will pick this up in the next days.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/671844569/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/672898394",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-672898394",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 672898394,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3Mjg5ODM5NA==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-12T14:16:31Z",
    "updated_at": "2020-08-12T14:16:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "Improved PR; followed recommendations in various comments. Fixed many nits.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/672898394/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/673342550",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-673342550",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 673342550,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3MzM0MjU1MA==",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-13T08:33:29Z",
    "updated_at": "2020-08-13T08:33:29Z",
    "author_association": "MEMBER",
    "body": "Nice. Will re-review soon.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/673342550/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/677982274",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-677982274",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 677982274,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3Nzk4MjI3NA==",
    "user": {
      "login": "jules23",
      "id": 36807746,
      "node_id": "MDQ6VXNlcjM2ODA3NzQ2",
      "avatar_url": "https://avatars.githubusercontent.com/u/36807746?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jules23",
      "html_url": "https://github.com/jules23",
      "followers_url": "https://api.github.com/users/jules23/followers",
      "following_url": "https://api.github.com/users/jules23/following{/other_user}",
      "gists_url": "https://api.github.com/users/jules23/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jules23/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jules23/subscriptions",
      "organizations_url": "https://api.github.com/users/jules23/orgs",
      "repos_url": "https://api.github.com/users/jules23/repos",
      "events_url": "https://api.github.com/users/jules23/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jules23/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-21T01:09:04Z",
    "updated_at": "2020-08-21T01:09:22Z",
    "author_association": "NONE",
    "body": "I've compiled, and run the unit tests with no issues at b1ef92a on macOS Catalina.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/677982274/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/679974920",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-679974920",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 679974920,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY3OTk3NDkyMA==",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-08-25T11:45:23Z",
    "updated_at": "2020-08-25T11:49:18Z",
    "author_association": "MEMBER",
    "body": "Two conversations with outstanding unresolved issues buried in the discussion above:\r\n\r\n- https://github.com/bitcoin/bitcoin/pull/18242#discussion_r424750339 - comparison always true\r\n\r\n- https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418937474 - time clock attacks",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/679974920/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/686586509",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-686586509",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 686586509,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4NjU4NjUwOQ==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-03T15:53:37Z",
    "updated_at": "2020-09-03T15:53:37Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rebased.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/686586509/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688812330",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-688812330",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 688812330,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4ODgxMjMzMA==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-08T11:41:12Z",
    "updated_at": "2020-09-08T11:41:12Z",
    "author_association": "CONTRIBUTOR",
    "body": "@jonatack:\r\n* I think the \"always true comparison\" is fixed (#18242 (comment) - comparison always true). Agree?\r\n* The time clock attack is something that needs to be discussed first on the BIP draft (which is happening).",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688812330/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688848674",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-688848674",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 688848674,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4ODg0ODY3NA==",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-08T12:58:35Z",
    "updated_at": "2020-09-08T12:58:35Z",
    "author_association": "MEMBER",
    "body": "Thanks @jonasschnelli, I've been planning to get back to this, and study Lloyd's last comment in the BIP draft as well.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688848674/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/721239244",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-721239244",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 721239244,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcyMTIzOTI0NA==",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-03T16:34:27Z",
    "updated_at": "2020-11-03T16:34:27Z",
    "author_association": "MEMBER",
    "body": "IRC discussion today about rekey implementation: http://www.erisian.com.au/bitcoin-core-dev/log-2020-11-03.html#l-504",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/721239244/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/745019545",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-745019545",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 745019545,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NTAxOTU0NQ==",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?u=ca58f5c566ff1ad12d396a5b2a5b9e2c5d40e4c0&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-15T02:58:14Z",
    "updated_at": "2020-12-15T02:58:14Z",
    "author_association": "CONTRIBUTOR",
    "body": "@jonasschnelli Do you think you could summarize / talk about what is blocking this PR from moving forward at this point? ",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/745019545/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/745106873",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-745106873",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 745106873,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0NTEwNjg3Mw==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-15T07:23:58Z",
    "updated_at": "2020-12-15T07:23:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "@PastaPastaPasta: there is an attempt to overhaul and optimise the AEAD construct. I'd like to work that into the BIP. See https://gist.github.com/jonasschnelli/c530ea8421b8d0e80c51486325587c52 for discussion.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/745106873/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767405698",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-767405698",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 767405698,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc2NzQwNTY5OA==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-26T09:08:01Z",
    "updated_at": "2021-01-26T09:08:01Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--cf906140f33d8803c4a75a2196329ecb-->\n\ud83d\udc19 This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/767405698/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901069138",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-901069138",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 901069138,
    "node_id": "IC_kwDOABII5841tTlS",
    "user": {
      "login": "fanquake",
      "id": 863730,
      "node_id": "MDQ6VXNlcjg2MzczMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/863730?u=a0e0040aacd7d4f0787481e8ac30b494fa429e11&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fanquake",
      "html_url": "https://github.com/fanquake",
      "followers_url": "https://api.github.com/users/fanquake/followers",
      "following_url": "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url": "https://api.github.com/users/fanquake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
      "organizations_url": "https://api.github.com/users/fanquake/orgs",
      "repos_url": "https://api.github.com/users/fanquake/repos",
      "events_url": "https://api.github.com/users/fanquake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fanquake/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-18T12:24:18Z",
    "updated_at": "2021-08-18T12:24:18Z",
    "author_association": "MEMBER",
    "body": "My understanding is that someone else is helping with / taking over these changes, and that the BIP is still being overhauled. \r\nI think we'll be better off with new PRs, and clean discussion when work on the implementation resumes in this repo.\r\nChanges from here are be cherry-picked if / when needed. So I'm going to close this PR for now. ",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901069138/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901104043",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-901104043",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 901104043,
    "node_id": "IC_kwDOABII5841tcGr",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-18T13:12:26Z",
    "updated_at": "2021-08-18T13:12:26Z",
    "author_association": "MEMBER",
    "body": "FWIW, I reviewed this repeatedly, hosted a review club meeting on BIP324 (https://bitcoincore.reviews/16202), and proposed a few times to @jonasschnelli to help move this forward. The reply was that help wasn't needed. So I am curious when that changed and who is helping with it, as little seems to be happening?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901104043/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901508086",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-901508086",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 901508086,
    "node_id": "IC_kwDOABII5841u-v2",
    "user": {
      "login": "fanquake",
      "id": 863730,
      "node_id": "MDQ6VXNlcjg2MzczMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/863730?u=a0e0040aacd7d4f0787481e8ac30b494fa429e11&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fanquake",
      "html_url": "https://github.com/fanquake",
      "followers_url": "https://api.github.com/users/fanquake/followers",
      "following_url": "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url": "https://api.github.com/users/fanquake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
      "organizations_url": "https://api.github.com/users/fanquake/orgs",
      "repos_url": "https://api.github.com/users/fanquake/repos",
      "events_url": "https://api.github.com/users/fanquake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fanquake/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-19T00:03:29Z",
    "updated_at": "2021-08-19T00:03:29Z",
    "author_association": "MEMBER",
    "body": "The [BIP overhaul](https://gist.github.com/jonasschnelli/c530ea8421b8d0e80c51486325587c52) has been ongoing for a long time, and [recently](https://gist.github.com/jonasschnelli/c530ea8421b8d0e80c51486325587c52#gistcomment-3863598) @dhruv has taken it over in https://gist.github.com/dhruv/5b1275751bc98f3b64bcafce7876b489.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901508086/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901793360",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-901793360",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 901793360,
    "node_id": "IC_kwDOABII5841wEZQ",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-19T10:19:33Z",
    "updated_at": "2021-08-19T10:24:00Z",
    "author_association": "MEMBER",
    "body": "Thanks for the update, @fanquake.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901793360/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/939155233",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#issuecomment-939155233",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18242",
    "id": 939155233,
    "node_id": "IC_kwDOABII5843-l8h",
    "user": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?u=65406da0f40524c00b8b647f916d31cbbb449edb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-08T22:51:02Z",
    "updated_at": "2021-10-08T22:51:02Z",
    "author_association": "CONTRIBUTOR",
    "body": "This PR is superseded by #23233 which is ready for review. I've tried to go over the comment history here and address anything that's wasn't previously.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/939155233/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401989046",
    "pull_request_review_id": 386040031,
    "id": 401989046,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4OTA0Ng==",
    "diff_hunk": "@@ -199,3 +199,116 @@ const std::vector<std::string> &getAllNetMessageTypes()\n {\n     return allNetMessageTypesVec;\n }\n+\n+",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "0e9b029fdceafceffe92a66ac08b74748c92d9da",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Nit remove extra newline \r\n```suggestion\r\n```",
    "created_at": "2020-04-02T00:38:12Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401989046",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401989046"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401989046"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401989046/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 232,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401989454",
    "pull_request_review_id": 386040031,
    "id": 401989454,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4OTQ1NA==",
    "diff_hunk": "@@ -319,4 +321,73 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs) {\n+    // use 32 bytey keys with all zeros",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 16,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "500e268eb1d9feefddecba8f47becfbdac2f7e3f",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n    // use 32 byte keys with all zeros\r\n```",
    "created_at": "2020-04-02T00:39:41Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401989454",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401989454"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401989454"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401989454/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 325,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401990279",
    "pull_request_review_id": 386040031,
    "id": 401990279,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MDI3OQ==",
    "diff_hunk": "@@ -319,4 +321,73 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs) {\n+    // use 32 bytey keys with all zeros\n+    CPrivKey k1(32, 0);\n+    CPrivKey k2(32, 0);\n+\n+    // construct the serializers\n+    std::unique_ptr<TransportSerializer> serializer;\n+    std::unique_ptr<TransportDeserializer> deserializer;\n+\n+    if (v2) {\n+        serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2));\n+        deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(Params().MessageStart(), k1, k2));\n+    }\n+    else {",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 28,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "500e268eb1d9feefddecba8f47becfbdac2f7e3f",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I could be wrong but style guide seems to say these should be on the same line https://github.com/bitcoin/bitcoin/blob/master/doc/developer-notes.md#coding-style-c\r\n```suggestion\r\n    } else {\r\n```",
    "created_at": "2020-04-02T00:43:06Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401990279",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401990279"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401990279"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401990279/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 336,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 337,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401990508",
    "pull_request_review_id": 386040031,
    "id": 401990508,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MDUwOA==",
    "diff_hunk": "@@ -319,4 +321,73 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs) {\n+    // use 32 bytey keys with all zeros\n+    CPrivKey k1(32, 0);\n+    CPrivKey k2(32, 0);\n+\n+    // construct the serializers\n+    std::unique_ptr<TransportSerializer> serializer;\n+    std::unique_ptr<TransportDeserializer> deserializer;\n+\n+    if (v2) {\n+        serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2));\n+        deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(Params().MessageStart(), k1, k2));\n+    }\n+    else {\n+        serializer = MakeUnique<V1TransportSerializer>(V1TransportSerializer());\n+        deserializer = MakeUnique<V1TransportDeserializer>(V1TransportDeserializer(Params().MessageStart(), SER_NETWORK, INIT_PROTO_VERSION));\n+    }\n+    // run a couple of times through all messages with the same AEAD instance\n+    for (unsigned int i=0; i<100;i++) {",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 33,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "500e268eb1d9feefddecba8f47becfbdac2f7e3f",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Proper social distancing should be followed and pre-inc is preferred.\r\n```suggestion\r\n    for (unsigned int i = 0; i < 100; ++i) {\r\n```",
    "created_at": "2020-04-02T00:43:50Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401990508",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401990508"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401990508"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401990508/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 342,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401990612",
    "pull_request_review_id": 386040031,
    "id": 401990612,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MDYxMg==",
    "diff_hunk": "@@ -319,4 +321,73 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs) {\n+    // use 32 bytey keys with all zeros\n+    CPrivKey k1(32, 0);\n+    CPrivKey k2(32, 0);\n+\n+    // construct the serializers\n+    std::unique_ptr<TransportSerializer> serializer;\n+    std::unique_ptr<TransportDeserializer> deserializer;\n+\n+    if (v2) {\n+        serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2));\n+        deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(Params().MessageStart(), k1, k2));\n+    }\n+    else {\n+        serializer = MakeUnique<V1TransportSerializer>(V1TransportSerializer());\n+        deserializer = MakeUnique<V1TransportDeserializer>(V1TransportDeserializer(Params().MessageStart(), SER_NETWORK, INIT_PROTO_VERSION));\n+    }\n+    // run a couple of times through all messages with the same AEAD instance\n+    for (unsigned int i=0; i<100;i++) {\n+        for(const CSerializedNetMsg& msg_orig : test_msgs) {\n+            // bypass the copy protection\n+            CSerializedNetMsg msg;\n+            msg.data = msg_orig.data;\n+            msg.command = msg_orig.command;\n+            size_t raw_msg_size = msg.data.size();\n+\n+            std::vector<unsigned char> serialized_header;\n+            serializer->prepareForTransport(msg, serialized_header);\n+\n+            // read two times\n+            //  first: read header",
    "path": "src/test/net_tests.cpp",
    "position": 42,
    "original_position": 45,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "500e268eb1d9feefddecba8f47becfbdac2f7e3f",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Not sure if this was intended or not, but if it was intended I don't understand why\r\n```suggestion\r\n            // first: read header\r\n```",
    "created_at": "2020-04-02T00:44:10Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401990612",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401990612"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401990612"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401990612/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 963,
    "original_line": 963,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401990710",
    "pull_request_review_id": 386040031,
    "id": 401990710,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MDcxMA==",
    "diff_hunk": "@@ -319,4 +321,73 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs) {\n+    // use 32 bytey keys with all zeros\n+    CPrivKey k1(32, 0);\n+    CPrivKey k2(32, 0);\n+\n+    // construct the serializers\n+    std::unique_ptr<TransportSerializer> serializer;\n+    std::unique_ptr<TransportDeserializer> deserializer;\n+\n+    if (v2) {\n+        serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2));\n+        deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(Params().MessageStart(), k1, k2));\n+    }\n+    else {\n+        serializer = MakeUnique<V1TransportSerializer>(V1TransportSerializer());\n+        deserializer = MakeUnique<V1TransportDeserializer>(V1TransportDeserializer(Params().MessageStart(), SER_NETWORK, INIT_PROTO_VERSION));\n+    }\n+    // run a couple of times through all messages with the same AEAD instance\n+    for (unsigned int i=0; i<100;i++) {\n+        for(const CSerializedNetMsg& msg_orig : test_msgs) {\n+            // bypass the copy protection\n+            CSerializedNetMsg msg;\n+            msg.data = msg_orig.data;\n+            msg.command = msg_orig.command;\n+            size_t raw_msg_size = msg.data.size();\n+\n+            std::vector<unsigned char> serialized_header;\n+            serializer->prepareForTransport(msg, serialized_header);\n+\n+            // read two times\n+            //  first: read header\n+            size_t read_bytes = 0;\n+            if (serialized_header.size() > 0) read_bytes += deserializer->Read((const char *)serialized_header.data(), serialized_header.size());\n+            //  second: read the encrypted payload (if required)",
    "path": "src/test/net_tests.cpp",
    "position": 46,
    "original_position": 48,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "500e268eb1d9feefddecba8f47becfbdac2f7e3f",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n            // second: read the encrypted payload (if required)\r\n```",
    "created_at": "2020-04-02T00:44:34Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401990710",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401990710"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401990710"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401990710/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 967,
    "original_line": 967,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401991160",
    "pull_request_review_id": 386040031,
    "id": 401991160,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MTE2MA==",
    "diff_hunk": "@@ -319,4 +321,73 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs) {\n+    // use 32 bytey keys with all zeros\n+    CPrivKey k1(32, 0);\n+    CPrivKey k2(32, 0);\n+\n+    // construct the serializers\n+    std::unique_ptr<TransportSerializer> serializer;\n+    std::unique_ptr<TransportDeserializer> deserializer;\n+\n+    if (v2) {\n+        serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2));\n+        deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(Params().MessageStart(), k1, k2));\n+    }\n+    else {\n+        serializer = MakeUnique<V1TransportSerializer>(V1TransportSerializer());\n+        deserializer = MakeUnique<V1TransportDeserializer>(V1TransportDeserializer(Params().MessageStart(), SER_NETWORK, INIT_PROTO_VERSION));\n+    }\n+    // run a couple of times through all messages with the same AEAD instance\n+    for (unsigned int i=0; i<100;i++) {\n+        for(const CSerializedNetMsg& msg_orig : test_msgs) {\n+            // bypass the copy protection\n+            CSerializedNetMsg msg;\n+            msg.data = msg_orig.data;\n+            msg.command = msg_orig.command;\n+            size_t raw_msg_size = msg.data.size();\n+\n+            std::vector<unsigned char> serialized_header;\n+            serializer->prepareForTransport(msg, serialized_header);\n+\n+            // read two times\n+            //  first: read header\n+            size_t read_bytes = 0;\n+            if (serialized_header.size() > 0) read_bytes += deserializer->Read((const char *)serialized_header.data(), serialized_header.size());\n+            //  second: read the encrypted payload (if required)\n+            if (msg.data.size() > 0) read_bytes += deserializer->Read((const char *)msg.data.data(), msg.data.size());\n+            if (msg.data.size() > read_bytes && msg.data.size()-read_bytes > 0) read_bytes += deserializer->Read((const char *)msg.data.data()+read_bytes, msg.data.size()-read_bytes);\n+            BOOST_CHECK(deserializer->Complete());\n+            BOOST_CHECK_EQUAL(read_bytes, msg.data.size()+serialized_header.size());\n+            // message must be complete\n+            CNetMessage msg_deser = deserializer->GetMessage(Params().MessageStart(), GetTimeMicros());\n+            BOOST_CHECK_EQUAL(msg_deser.m_command, msg.command);\n+            BOOST_CHECK_EQUAL(raw_msg_size, msg_deser.m_message_size);\n+        }\n+    }\n+}\n+\n+BOOST_AUTO_TEST_CASE(net_v2)\n+{\n+    // create some messages where we perform serialization and deserialization\n+    std::vector<CSerializedNetMsg> test_msgs;\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK));\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERSION, PROTOCOL_VERSION, (int)NODE_NETWORK, 123, CAddress(CService(), NODE_NONE), CAddress(CService(), NODE_NONE), 123, \"foobar\", 500000, true));\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::PING, 123456));\n+    CDataStream stream(ParseHex(\"020000000001013107ca31e1950a9b44b75ce3e8f30127e4d823ed8add1263a1cc8adcc8e49164000000001716001487835ecf51ea0351ef266d216a7e7a3e74b84b4efeffffff02082268590000000017a9144a94391b99e672b03f56d3f60800ef28bc304c4f8700ca9a3b0000000017a9146d5df9e79f752e3c53fc468db89cafda4f7d00cb87024730440220677de5b11a5617d541ba06a1fa5921ab6b4509f8028b23f18ab8c01c5eb1fcfb02202fe382e6e87653f60ff157aeb3a18fc888736720f27ced546b0b77431edabdb0012102608c772598e9645933a86bcd662a3b939e02fb3e77966c9713db5648d5ba8a0006010000\"), SER_NETWORK, PROTOCOL_VERSION);\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::TX, CTransaction(deserialize, stream)));\n+    std::vector<CInv> vInv;\n+    for (unsigned int i=0;i<1000;i++) { vInv.push_back(CInv(MSG_BLOCK, Params().GenesisBlock().GetHash())); }",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 71,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "500e268eb1d9feefddecba8f47becfbdac2f7e3f",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n    for (unsigned int i = 0;i < 1000; ++i) { \r\n        vInv.push_back(CInv(MSG_BLOCK, Params().GenesisBlock().GetHash()));\r\n    }\r\n```",
    "created_at": "2020-04-02T00:46:09Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401991160",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401991160"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401991160"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401991160/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 380,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401991466",
    "pull_request_review_id": 386040031,
    "id": 401991466,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MTQ2Ng==",
    "diff_hunk": "@@ -319,4 +321,73 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs) {\n+    // use 32 bytey keys with all zeros\n+    CPrivKey k1(32, 0);\n+    CPrivKey k2(32, 0);\n+\n+    // construct the serializers\n+    std::unique_ptr<TransportSerializer> serializer;\n+    std::unique_ptr<TransportDeserializer> deserializer;\n+\n+    if (v2) {\n+        serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2));\n+        deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(Params().MessageStart(), k1, k2));\n+    }\n+    else {\n+        serializer = MakeUnique<V1TransportSerializer>(V1TransportSerializer());\n+        deserializer = MakeUnique<V1TransportDeserializer>(V1TransportDeserializer(Params().MessageStart(), SER_NETWORK, INIT_PROTO_VERSION));\n+    }\n+    // run a couple of times through all messages with the same AEAD instance\n+    for (unsigned int i=0; i<100;i++) {\n+        for(const CSerializedNetMsg& msg_orig : test_msgs) {\n+            // bypass the copy protection\n+            CSerializedNetMsg msg;\n+            msg.data = msg_orig.data;\n+            msg.command = msg_orig.command;\n+            size_t raw_msg_size = msg.data.size();\n+\n+            std::vector<unsigned char> serialized_header;\n+            serializer->prepareForTransport(msg, serialized_header);\n+\n+            // read two times\n+            //  first: read header\n+            size_t read_bytes = 0;\n+            if (serialized_header.size() > 0) read_bytes += deserializer->Read((const char *)serialized_header.data(), serialized_header.size());\n+            //  second: read the encrypted payload (if required)\n+            if (msg.data.size() > 0) read_bytes += deserializer->Read((const char *)msg.data.data(), msg.data.size());\n+            if (msg.data.size() > read_bytes && msg.data.size()-read_bytes > 0) read_bytes += deserializer->Read((const char *)msg.data.data()+read_bytes, msg.data.size()-read_bytes);\n+            BOOST_CHECK(deserializer->Complete());\n+            BOOST_CHECK_EQUAL(read_bytes, msg.data.size()+serialized_header.size());\n+            // message must be complete\n+            CNetMessage msg_deser = deserializer->GetMessage(Params().MessageStart(), GetTimeMicros());\n+            BOOST_CHECK_EQUAL(msg_deser.m_command, msg.command);\n+            BOOST_CHECK_EQUAL(raw_msg_size, msg_deser.m_message_size);\n+        }\n+    }\n+}\n+\n+BOOST_AUTO_TEST_CASE(net_v2)\n+{\n+    // create some messages where we perform serialization and deserialization\n+    std::vector<CSerializedNetMsg> test_msgs;\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK));\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERSION, PROTOCOL_VERSION, (int)NODE_NETWORK, 123, CAddress(CService(), NODE_NONE), CAddress(CService(), NODE_NONE), 123, \"foobar\", 500000, true));\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::PING, 123456));\n+    CDataStream stream(ParseHex(\"020000000001013107ca31e1950a9b44b75ce3e8f30127e4d823ed8add1263a1cc8adcc8e49164000000001716001487835ecf51ea0351ef266d216a7e7a3e74b84b4efeffffff02082268590000000017a9144a94391b99e672b03f56d3f60800ef28bc304c4f8700ca9a3b0000000017a9146d5df9e79f752e3c53fc468db89cafda4f7d00cb87024730440220677de5b11a5617d541ba06a1fa5921ab6b4509f8028b23f18ab8c01c5eb1fcfb02202fe382e6e87653f60ff157aeb3a18fc888736720f27ced546b0b77431edabdb0012102608c772598e9645933a86bcd662a3b939e02fb3e77966c9713db5648d5ba8a0006010000\"), SER_NETWORK, PROTOCOL_VERSION);\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::TX, CTransaction(deserialize, stream)));\n+    std::vector<CInv> vInv;\n+    for (unsigned int i=0;i<1000;i++) { vInv.push_back(CInv(MSG_BLOCK, Params().GenesisBlock().GetHash())); }\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::INV, vInv));\n+\n+    // add a dummy message\n+    std::string dummy;\n+    for (unsigned int i=0;i<100;i++) { dummy += \"020000000001013107ca31e1950a9b44b75ce3e8f30127e4d823ed8add1263a1cc8adcc8e49164000000001716001487835ecf51ea0351ef266d216a7e7a3e74b84b4efeffffff02082268590000000017a9144a94391b99e672b03f56d3f60800ef28bc304c4f8700ca9a3b0000000017a9146d5df9e79f752e3c53fc468db89cafda4f7d00cb87024730440220677de5b11a5617d541ba06a1fa5921ab6b4509f8028b23f18ab8c01c5eb1fcfb02202fe382e6e87653f60ff157aeb3a18fc888736720f27ced546b0b77431edabdb0012102608c772598e9645933a86bcd662a3b939e02fb3e77966c9713db5648d5ba8a0006010000\"; }",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 76,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "500e268eb1d9feefddecba8f47becfbdac2f7e3f",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n    for (unsigned int i = 0; i < 100; ++i) { \r\n        dummy += \"020000000001013107ca31e1950a9b44b75ce3e8f30127e4d823ed8add1263a1cc8adcc8e49164000000001716001487835ecf51ea0351ef266d216a7e7a3e74b84b4efeffffff02082268590000000017a9144a94391b99e672b03f56d3f60800ef28bc304c4f8700ca9a3b0000000017a9146d5df9e79f752e3c53fc468db89cafda4f7d00cb87024730440220677de5b11a5617d541ba06a1fa5921ab6b4509f8028b23f18ab8c01c5eb1fcfb02202fe382e6e87653f60ff157aeb3a18fc888736720f27ced546b0b77431edabdb0012102608c772598e9645933a86bcd662a3b939e02fb3e77966c9713db5648d5ba8a0006010000\";\r\n    }\r\n```",
    "created_at": "2020-04-02T00:47:10Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401991466",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401991466"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401991466"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401991466/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 385,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401992204",
    "pull_request_review_id": 386040031,
    "id": 401992204,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MjIwNA==",
    "diff_hunk": "@@ -834,6 +846,30 @@ CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     msg.m_message_size = msg.m_recv.size(); //message payload size (excluding command)\n     msg.m_raw_message_size =  CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN; // raw wire size\n \n+    if (m_rekey_flag) {\n+        // make sure we rekey at this point, next message is supposed to be encrypted with the new key\n+        CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k1.data(), m_aead_k1.size()).Finalize(m_aead_k1.data());\n+        CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k2.data(), m_aead_k2.size()).Finalize(m_aead_k2.data());\n+\n+        // reset the AEAD context\n+        m_aead.reset(new ChaCha20Poly1305AEAD(m_aead_k1.data(), m_aead_k1.size(), m_aead_k2.data(), m_aead_k2.size()));\n+        LogPrint(BCLog::NET, \"Rekey: new recv keys (%s, %s)\\n\", HexStr(m_aead_k1), HexStr(m_aead_k2));\n+\n+        // reset sequence numbers\n+        m_payload_seqnr = 0;\n+        m_aad_seqnr = 0;\n+        m_aad_pos = 0;\n+        m_bytes_decrypted = 0;\n+        m_time_last_rekey = GetTime();\n+    }\n+    else if (m_bytes_decrypted > REKEY_ABORT_LIMIT_BYTES || GetTime() - m_time_last_rekey > REKEY_ABORT_LIMIT_TIME ||",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 46,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b2397b06c0b644ca5c0984ed5f17a7c97a4b8844",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "maybe \r\n```suggestion\r\n    } else if (m_bytes_decrypted > REKEY_ABORT_LIMIT_BYTES || GetTime() - m_time_last_rekey > REKEY_ABORT_LIMIT_TIME ||\r\n```",
    "created_at": "2020-04-02T00:49:50Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401992204",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401992204"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401992204"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401992204/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 864,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 865,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401992396",
    "pull_request_review_id": 386040031,
    "id": 401992396,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MjM5Ng==",
    "diff_hunk": "@@ -389,5 +397,78 @@ BOOST_AUTO_TEST_CASE(net_v2)\n     message_serialize_deserialize_test(false, test_msgs);\n }\n \n+BOOST_AUTO_TEST_CASE(net_rekey)\n+{\n+    CPrivKey mutable_k1 = k1;\n+    CPrivKey mutable_k2 = k2;\n+    uint256 mutable_session_id = session_id;\n+\n+    CSerializedNetMsg test_msg = CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERSION, PROTOCOL_VERSION, (int)NODE_NETWORK, 123, CAddress(CService(), NODE_NONE), CAddress(CService(), NODE_NONE), 123, \"foobar\", 500000, true);\n+    CSerializedNetMsg test_msg_short = CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK);\n+\n+    // make sure we use the fast rekey rules\n+    std::unique_ptr<TransportSerializer> serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2, session_id));;\n+    std::unique_ptr<TransportDeserializer> deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(Params().MessageStart(), k1, k2, session_id));\n+\n+    ChaCha20Poly1305AEAD test_decryption_aead(k1.data(), k1.size(), k2.data(), k2.size());\n+\n+    for (unsigned int i=0; i<=76;i++) {",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 78,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b2397b06c0b644ca5c0984ed5f17a7c97a4b8844",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n    for (unsigned int i = 0; i <= 76; ++i) {\r\n```",
    "created_at": "2020-04-02T00:50:40Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401992396",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401992396"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401992396"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401992396/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 415,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401992502",
    "pull_request_review_id": 386040031,
    "id": 401992502,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MjUwMg==",
    "diff_hunk": "@@ -389,5 +397,78 @@ BOOST_AUTO_TEST_CASE(net_v2)\n     message_serialize_deserialize_test(false, test_msgs);\n }\n \n+BOOST_AUTO_TEST_CASE(net_rekey)\n+{\n+    CPrivKey mutable_k1 = k1;\n+    CPrivKey mutable_k2 = k2;\n+    uint256 mutable_session_id = session_id;\n+\n+    CSerializedNetMsg test_msg = CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERSION, PROTOCOL_VERSION, (int)NODE_NETWORK, 123, CAddress(CService(), NODE_NONE), CAddress(CService(), NODE_NONE), 123, \"foobar\", 500000, true);\n+    CSerializedNetMsg test_msg_short = CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK);\n+\n+    // make sure we use the fast rekey rules\n+    std::unique_ptr<TransportSerializer> serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2, session_id));;\n+    std::unique_ptr<TransportDeserializer> deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(Params().MessageStart(), k1, k2, session_id));\n+\n+    ChaCha20Poly1305AEAD test_decryption_aead(k1.data(), k1.size(), k2.data(), k2.size());\n+\n+    for (unsigned int i=0; i<=76;i++) {\n+        // encrypt the message without the fast-rekey rules\n+        gArgs.ForceSetArg(\"-netencryptionfastrekey\", \"0\");\n+        std::vector<unsigned char> serialized_header;\n+        serializer->prepareForTransport(test_msg, serialized_header);\n+\n+        // decrypt the message with the fast rekey-rules\n+        gArgs.ForceSetArg(\"-netencryptionfastrekey\", \"1\");\n+        read_message(deserializer, serialized_header, test_msg);\n+        CNetMessage msg_deser = deserializer->GetMessage(Params().MessageStart(), GetTimeMicros());\n+\n+        // make sure we detect the failed rekey\n+        // the 76. message (32kb) must have violated the fast rekey limits\n+        BOOST_CHECK(msg_deser.m_valid_header == (i!=76));\n+    }\n+\n+    // now make sure we are rekeying by checking against a manual aead instance\n+    serializer.reset(new V2TransportSerializer(mutable_k1, mutable_k2, mutable_session_id));\n+    deserializer.reset(new V2TransportDeserializer(Params().MessageStart(), mutable_k1, mutable_k2, mutable_session_id));\n+    uint32_t aad_seqnr = 0;\n+    uint32_t aad_pos = 0;\n+    for (unsigned int i=0; i<=100;i++) {",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 99,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b2397b06c0b644ca5c0984ed5f17a7c97a4b8844",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n    for (unsigned int i = 0; i <= 100; ++i) {\r\n```",
    "created_at": "2020-04-02T00:51:08Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401992502",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401992502"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401992502"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401992502/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 436,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401992678",
    "pull_request_review_id": 386040031,
    "id": 401992678,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MjY3OA==",
    "diff_hunk": "@@ -17,24 +18,22 @@ void initialize()\n     SelectParams(CBaseChainParams::REGTEST);\n }\n \n-void test_one_input(const std::vector<uint8_t>& buffer)\n-{\n-    V1TransportDeserializer deserializer{Params().MessageStart(), SER_NETWORK, INIT_PROTO_VERSION};\n+void test_deserializer(std::unique_ptr<TransportDeserializer>& deserializer, const std::vector<uint8_t>& buffer, const int header_size) {",
    "path": "src/test/fuzz/p2p_transport_deserializer.cpp",
    "position": null,
    "original_position": 15,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "818b19787a01edf2a043450f5a9bd362d8521cfe",
    "user": {
      "login": "PastaPastaPasta",
      "id": 6443210,
      "node_id": "MDQ6VXNlcjY0NDMyMTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6443210?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/PastaPastaPasta",
      "html_url": "https://github.com/PastaPastaPasta",
      "followers_url": "https://api.github.com/users/PastaPastaPasta/followers",
      "following_url": "https://api.github.com/users/PastaPastaPasta/following{/other_user}",
      "gists_url": "https://api.github.com/users/PastaPastaPasta/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/PastaPastaPasta/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/PastaPastaPasta/subscriptions",
      "organizations_url": "https://api.github.com/users/PastaPastaPasta/orgs",
      "repos_url": "https://api.github.com/users/PastaPastaPasta/repos",
      "events_url": "https://api.github.com/users/PastaPastaPasta/events{/privacy}",
      "received_events_url": "https://api.github.com/users/PastaPastaPasta/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\nvoid test_deserializer(std::unique_ptr<TransportDeserializer>& deserializer, const std::vector<uint8_t>& buffer, const int header_size) \r\n{\r\n```",
    "created_at": "2020-04-02T00:51:49Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401992678",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401992678"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r401992678"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/401992678/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 21,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407260396",
    "pull_request_review_id": 391900410,
    "id": 407260396,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2MDM5Ng==",
    "diff_hunk": "@@ -718,6 +719,163 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 16,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit:\r\n```suggestion\r\n        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\r\n```",
    "created_at": "2020-04-12T22:30:06Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407260396",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407260396"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407260396"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407260396/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 726,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407260785",
    "pull_request_review_id": 391900410,
    "id": 407260785,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2MDc4NQ==",
    "diff_hunk": "@@ -718,6 +719,163 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        unsigned int copy_bytes = std::min(remaining, bytes);",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 17,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit:\r\n```suggestion\r\n        const unsigned int copy_bytes = std::min(remaining, bytes);\r\n```\r\n\r\nAlso `#include <algorithm>` header for `std::min()`.",
    "created_at": "2020-04-12T22:34:20Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407260785",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407260785"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407260785"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407260785/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 727,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407261271",
    "pull_request_review_id": 391900410,
    "id": 407261271,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2MTI3MQ==",
    "diff_hunk": "@@ -718,6 +719,163 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = (m_message_size & (1U << 23));",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 36,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "An explicit type conversion could improve readability:\r\n```suggestion\r\n        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\r\n```",
    "created_at": "2020-04-12T22:39:59Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407261271",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407261271"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407261271"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407261271/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 746,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407261365",
    "pull_request_review_id": 391900410,
    "id": 407261365,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2MTM2NQ==",
    "diff_hunk": "@@ -718,6 +719,163 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = (m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected %ld\\n\", m_message_size);",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 38,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "What is the purpose of `m_message_size` in the log message?",
    "created_at": "2020-04-12T22:41:29Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407261365",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407261365"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407261365"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407261365/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 748,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407261568",
    "pull_request_review_id": 391900410,
    "id": 407261568,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2MTU2OA==",
    "diff_hunk": "@@ -718,6 +719,163 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = (m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected %ld\\n\", m_message_size);\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int AAD_LEN = CHACHA20_POLY1305_AEAD_AAD_LEN;\n+        unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        unsigned int copy_bytes = std::min(remaining, bytes);",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 54,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit:\r\n```suggestion\r\n        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\r\n        const unsigned int copy_bytes = std::min(remaining, bytes);\r\n```",
    "created_at": "2020-04-12T22:44:00Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407261568",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407261568"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407261568"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407261568/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 763,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 764,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407261836",
    "pull_request_review_id": 391900410,
    "id": 407261836,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2MTgzNg==",
    "diff_hunk": "@@ -718,6 +719,163 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = (m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected %ld\\n\", m_message_size);\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int AAD_LEN = CHACHA20_POLY1305_AEAD_AAD_LEN;\n+        unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[AAD_LEN + m_data_pos], pch, copy_bytes);",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 62,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\r\n```\r\n\r\n... and drop the line 762:\r\n```\r\n       const unsigned int AAD_LEN = CHACHA20_POLY1305_AEAD_AAD_LEN;\r\n```",
    "created_at": "2020-04-12T22:46:45Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407261836",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407261836"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407261836"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407261836/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 772,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407262244",
    "pull_request_review_id": 391900410,
    "id": 407262244,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2MjI0NA==",
    "diff_hunk": "@@ -718,6 +719,163 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = (m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected %ld\\n\", m_message_size);\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int AAD_LEN = CHACHA20_POLY1305_AEAD_AAD_LEN;\n+        unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // count bytes we decrypted including MAC tag + AD\n+        m_bytes_decrypted += vRecv.size();\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= 12 && vRecv.size() >= size_or_shortid) {\n+            // string command\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID\n+        if (!valid_header && size_or_shortid > 0) {\n+            valid_header = true;\n+            if (!GetCommandFromShortCommandID(size_or_shortid, command_name)) {\n+                // unknown-short-id\n+                //  results in a valid but unknown message (will be skipped)\n+                command_name = \"unknown-\" + ToString(size_or_shortid);\n+            }\n+        }",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 115,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "What if `size_or_shortid` is still `== 0` ?",
    "created_at": "2020-04-12T22:50:46Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407262244",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407262244"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407262244"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407262244/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 809,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 859,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407262788",
    "pull_request_review_id": 391900410,
    "id": 407262788,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2Mjc4OA==",
    "diff_hunk": "@@ -731,6 +889,97 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 179,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit:\r\n```suggestion\r\n    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\r\n```",
    "created_at": "2020-04-12T22:56:44Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407262788",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407262788"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407262788"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407262788/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 903,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407263182",
    "pull_request_review_id": 391900410,
    "id": 407263182,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2MzE4Mg==",
    "diff_hunk": "@@ -731,6 +889,97 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command\n+    std::vector<unsigned char> serialized_header;\n+    // reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    serialized_header.resize(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 193,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Could be combined:\r\n```suggestion\r\n    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\r\n```",
    "created_at": "2020-04-12T23:00:42Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407263182",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407263182"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407263182"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407263182/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 907,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 917,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407263223",
    "pull_request_review_id": 391900410,
    "id": 407263223,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2MzIyMw==",
    "diff_hunk": "@@ -731,6 +889,97 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command\n+    std::vector<unsigned char> serialized_header;\n+    // reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    serialized_header.resize(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID (or eventually) the varstr of the command",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 199,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n    // append the short-ID or (eventually) the varstr of the command\r\n```",
    "created_at": "2020-04-12T23:01:07Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407263223",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407263223"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407263223"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407263223/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 923,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407263272",
    "pull_request_review_id": 391900410,
    "id": 407263272,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2MzI3Mg==",
    "diff_hunk": "@@ -731,6 +889,97 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command\n+    std::vector<unsigned char> serialized_header;\n+    // reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    serialized_header.resize(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID (or eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow sepearte buffers for",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 210,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "typo:\r\n```suggestion\r\n    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow separate buffers for\r\n```",
    "created_at": "2020-04-12T23:02:00Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407263272",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407263272"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407263272"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407263272/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 934,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407263619",
    "pull_request_review_id": 391900410,
    "id": 407263619,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2MzYxOQ==",
    "diff_hunk": "@@ -731,6 +889,97 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command\n+    std::vector<unsigned char> serialized_header;\n+    // reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    serialized_header.resize(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID (or eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow sepearte buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + 16, 0);\n+\n+    // length is only allowed up to 2^23 (bit24 is used for indicating rekey)\n+    bool bit24 = msg.data[2] & (1u << 7);\n+    assert(!bit24);\n+\n+    // check if we should rekey after this message\n+    int64_t now = GetTime(); //TODO: check how expansive the GetTime call is and if it is avoidable",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 222,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit:\r\n```suggestion\r\n    const int64_t now = GetTime(); //TODO: check how expansive the GetTime call is and if it is avoidable\r\n```",
    "created_at": "2020-04-12T23:06:06Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407263619",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407263619"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407263619"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407263619/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 946,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407264511",
    "pull_request_review_id": 391900410,
    "id": 407264511,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2NDUxMQ==",
    "diff_hunk": "@@ -731,6 +889,97 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command\n+    std::vector<unsigned char> serialized_header;\n+    // reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    serialized_header.resize(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID (or eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow sepearte buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + 16, 0);\n+\n+    // length is only allowed up to 2^23 (bit24 is used for indicating rekey)\n+    bool bit24 = msg.data[2] & (1u << 7);\n+    assert(!bit24);\n+\n+    // check if we should rekey after this message\n+    int64_t now = GetTime(); //TODO: check how expansive the GetTime call is and if it is avoidable\n+    bool rekey = false;",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 223,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Actually, `bit24` is equivalent to `rekey`. Maybe drop `bit24` in lines 934-935 and:\r\n```suggestion\r\n    bool rekey = msg.data[2] & (1U << 7);\r\n    assert(!rekey);\r\n```",
    "created_at": "2020-04-12T23:15:51Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407264511",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407264511"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407264511"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407264511/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1021,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407264883",
    "pull_request_review_id": 391900410,
    "id": 407264883,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2NDg4Mw==",
    "diff_hunk": "@@ -731,6 +889,97 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command\n+    std::vector<unsigned char> serialized_header;\n+    // reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    serialized_header.resize(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID (or eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow sepearte buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + 16, 0);",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 215,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Mind using a named constant:\r\n```suggestion\r\n    msg.data.resize(msg.data.size() + CHACHA20_POLY1305_AEAD_TAG_LEN, 0);\r\n```\r\n?",
    "created_at": "2020-04-12T23:19:39Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407264883",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407264883"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407264883"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407264883/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 939,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265167",
    "pull_request_review_id": 391900410,
    "id": 407265167,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2NTE2Nw==",
    "diff_hunk": "@@ -731,6 +889,97 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command\n+    std::vector<unsigned char> serialized_header;\n+    // reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    serialized_header.resize(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID (or eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow sepearte buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + 16, 0);\n+\n+    // length is only allowed up to 2^23 (bit24 is used for indicating rekey)\n+    bool bit24 = msg.data[2] & (1u << 7);\n+    assert(!bit24);\n+\n+    // check if we should rekey after this message\n+    int64_t now = GetTime(); //TODO: check how expansive the GetTime call is and if it is avoidable\n+    bool rekey = false;\n+    if (m_bytes_encrypted >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 32 * 1024 : REKEY_LIMIT_BYTES) || now - m_time_last_rekey >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 10 : REKEY_LIMIT_TIME)) {\n+        LogPrint(BCLog::NET, \"Rekey limits reached, performing rekey.\\n\");\n+        msg.data[2] |= (1u << 7);\n+        rekey = true;\n+    }\n+\n+    // encrypt the payload, ignore return code since it can't fail in this case (controlled buffers, don't check the MAC during encrypting)\n+    m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, msg.data.data(), msg.data.size(), msg.data.data(), msg.data.size() - 16, true);",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 231,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Mind using a named constant:\r\n```suggestion\r\n    m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, msg.data.data(), msg.data.size(), msg.data.data(), msg.data.size() - CHACHA20_POLY1305_AEAD_TAG_LEN, true);\r\n```\r\n?",
    "created_at": "2020-04-12T23:22:49Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407265167",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265167"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407265167"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265167/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 955,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265366",
    "pull_request_review_id": 391900410,
    "id": 407265366,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2NTM2Ng==",
    "diff_hunk": "@@ -703,6 +705,68 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS\n+\n+class V2TransportDeserializer : public TransportDeserializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_decrypted; // counter of bytes decrypted under the same key\n+    int64_t m_time_last_rekey;\n+    uint256 m_session_id;     // the encryption session_id, relevant for rekeying\n+    uint64_t m_payload_seqnr; // sequence number for the payload\n+    uint64_t m_aad_seqnr;     // sequence number for the packet length (AD)\n+    int m_aad_pos;            // position in the aad keystream\n+    bool m_in_data;           // parsing header (false) or data (true)\n+    uint32_t m_message_size;  // expected message size\n+    CDataStream vRecv;        // received message data\n+    unsigned int m_hdr_pos;   // read pos in header\n+    unsigned int m_data_pos;  // read pos in data\n+    bool m_rekey_flag;        // rekey in message detected\n+\n+public:\n+    V2TransportDeserializer(const CMessageHeader::MessageStartChars& pchMessageStartIn, const CPrivKey& k1, const CPrivKey& k2, const uint256& session_id) : m_aead(new ChaCha20Poly1305AEAD(k1.data(), k1.size(), k2.data(), k2.size())), m_aead_k1(k1), m_aead_k2(k2), m_bytes_decrypted(0), m_time_last_rekey(GetTime()), m_session_id(session_id), m_payload_seqnr(0), m_aad_seqnr(0), m_aad_pos(0), vRecv(SER_NETWORK, INIT_PROTO_VERSION)",
    "path": "src/net.h",
    "position": null,
    "original_position": 44,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Mind moving the member initializer list to next line to improve readability?",
    "created_at": "2020-04-12T23:24:30Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407265366",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265366"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407265366"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265366/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 737,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265633",
    "pull_request_review_id": 391900410,
    "id": 407265633,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2NTYzMw==",
    "diff_hunk": "@@ -703,6 +705,68 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS\n+\n+class V2TransportDeserializer : public TransportDeserializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_decrypted; // counter of bytes decrypted under the same key\n+    int64_t m_time_last_rekey;\n+    uint256 m_session_id;     // the encryption session_id, relevant for rekeying\n+    uint64_t m_payload_seqnr; // sequence number for the payload\n+    uint64_t m_aad_seqnr;     // sequence number for the packet length (AD)\n+    int m_aad_pos;            // position in the aad keystream\n+    bool m_in_data;           // parsing header (false) or data (true)\n+    uint32_t m_message_size;  // expected message size\n+    CDataStream vRecv;        // received message data\n+    unsigned int m_hdr_pos;   // read pos in header\n+    unsigned int m_data_pos;  // read pos in data\n+    bool m_rekey_flag;        // rekey in message detected\n+\n+public:\n+    V2TransportDeserializer(const CMessageHeader::MessageStartChars& pchMessageStartIn, const CPrivKey& k1, const CPrivKey& k2, const uint256& session_id) : m_aead(new ChaCha20Poly1305AEAD(k1.data(), k1.size(), k2.data(), k2.size())), m_aead_k1(k1), m_aead_k2(k2), m_bytes_decrypted(0), m_time_last_rekey(GetTime()), m_session_id(session_id), m_payload_seqnr(0), m_aad_seqnr(0), m_aad_pos(0), vRecv(SER_NETWORK, INIT_PROTO_VERSION)\n+    {\n+        Reset();\n+    }\n+\n+    void Reset()\n+    {\n+        vRecv.clear();\n+        vRecv.resize(CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        m_in_data = false;\n+        m_hdr_pos = 0;\n+        m_message_size = 0;\n+        m_data_pos = 0;\n+        m_rekey_flag = false;\n+    }\n+    bool Complete() const\n+    {\n+        if (!m_in_data)\n+            return false;",
    "path": "src/net.h",
    "position": null,
    "original_position": 62,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "style nit: could be placed into one line or in braces.",
    "created_at": "2020-04-12T23:27:29Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407265633",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265633"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407265633"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265633/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 754,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 865,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265779",
    "pull_request_review_id": 391900410,
    "id": 407265779,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2NTc3OQ==",
    "diff_hunk": "@@ -717,6 +781,27 @@ class V1TransportSerializer  : public TransportSerializer {\n     void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) override;\n };\n \n+class V2TransportSerializer : public TransportSerializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for a later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_encrypted = 0; //counter of bytes encrypted with same key\n+    int64_t m_time_last_rekey = 0;\n+    uint256 m_session_id; // the encryption session_id, relevant for rekeying\n+    uint64_t m_payload_seqnr = 0;\n+    uint64_t m_aad_seqnr = 0;\n+    int m_aad_pos = 0;\n+\n+public:\n+    V2TransportSerializer(const CPrivKey& k1, const CPrivKey& k2, const uint256& session_id) : m_aead(new ChaCha20Poly1305AEAD(k1.data(), k1.size(), k2.data(), k2.size())), m_aead_k1(k1), m_aead_k2(k2), m_session_id(session_id)",
    "path": "src/net.h",
    "position": null,
    "original_position": 98,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Mind moving the member initializer list to next line to improve readability?",
    "created_at": "2020-04-12T23:28:46Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407265779",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265779"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407265779"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265779/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 916,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265968",
    "pull_request_review_id": 391900410,
    "id": 407265968,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2NTk2OA==",
    "diff_hunk": "@@ -199,3 +199,127 @@ const std::vector<std::string> &getAllNetMessageTypes()\n {\n     return allNetMessageTypesVec;\n }\n+\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 8,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Have you consider a `switch` statement as an alternative?",
    "created_at": "2020-04-12T23:30:49Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407265968",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265968"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407265968"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265968/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 253,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265992",
    "pull_request_review_id": 391900410,
    "id": 407265992,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2NTk5Mg==",
    "diff_hunk": "@@ -199,3 +199,127 @@ const std::vector<std::string> &getAllNetMessageTypes()\n {\n     return allNetMessageTypesVec;\n }\n+\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FILTERLOAD) {\n+        return NetMsgType::FILTERLOAD_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETADDR) {\n+        return NetMsgType::GETADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETBLOCKS) {\n+        return NetMsgType::GETBLOCKS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::GETBLOCKTXN) {\n+        return NetMsgType::GETBLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETDATA) {\n+        return NetMsgType::GETDATA_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETHEADERS) {\n+        return NetMsgType::GETHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::HEADERS) {\n+        return NetMsgType::HEADERS_SHORT_ID;\n+    } else if (cmd == NetMsgType::INV) {\n+        return NetMsgType::INV_SHORT_ID;\n+    } else if (cmd == NetMsgType::MEMPOOL) {\n+        return NetMsgType::MEMPOOL_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::MERKLEBLOCK) {\n+        return NetMsgType::MERKLEBLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::NOTFOUND) {\n+        return NetMsgType::NOTFOUND_SHORT_ID;\n+    } else if (cmd == NetMsgType::PING) {\n+        return NetMsgType::PING_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::PONG) {\n+        return NetMsgType::PONG_SHORT_ID;\n+    } else if (cmd == NetMsgType::SENDCMPCT) {\n+        return NetMsgType::SENDCMPCT_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::SENDHEADERS) {\n+        return NetMsgType::SENDHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::TX) {\n+        return NetMsgType::TX_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERACK) {\n+        return NetMsgType::VERACK_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERSION) {\n+        return NetMsgType::VERSION_SHORT_ID;\n+        ;\n+    }\n+    return 0; //no short command\n+}\n+\n+bool GetCommandFromShortCommandID(uint8_t shortID, std::string& cmd)\n+{\n+    if (shortID == NetMsgType::ADDR_SHORT_ID) {",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 73,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Have you consider a `switch` statement as an alternative?",
    "created_at": "2020-04-12T23:31:04Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407265992",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265992"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407265992"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407265992/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 318,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407266260",
    "pull_request_review_id": 391900410,
    "id": 407266260,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2NjI2MA==",
    "diff_hunk": "@@ -71,99 +71,115 @@ namespace NetMsgType {\n  * @see https://bitcoin.org/en/developer-reference#version\n  */\n extern const char *VERSION;\n+const uint8_t VERSION_SHORT_ID = 38;",
    "path": "src/protocol.h",
    "position": null,
    "original_position": 4,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: hereinafter\r\n```suggestion\r\nconstexpr uint8_t VERSION_SHORT_ID = 38;\r\n```",
    "created_at": "2020-04-12T23:33:59Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407266260",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407266260"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407266260"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407266260/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 74,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407266630",
    "pull_request_review_id": 391900410,
    "id": 407266630,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI2NjYzMA==",
    "diff_hunk": "@@ -703,6 +705,68 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS",
    "path": "src/net.h",
    "position": null,
    "original_position": 22,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`MIN_REKEY_TIME` is unused now. Is it added intended on purpose in the future?",
    "created_at": "2020-04-12T23:38:24Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407266630",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407266630"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407266630"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407266630/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 834,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407715006",
    "pull_request_review_id": 392431872,
    "id": 407715006,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcxNTAwNg==",
    "diff_hunk": "@@ -393,5 +402,79 @@ BOOST_AUTO_TEST_CASE(net_v2)\n     message_serialize_deserialize_test(false, test_msgs);\n }\n \n+BOOST_AUTO_TEST_CASE(net_rekey)\n+{\n+    CPrivKey mutable_k1 = k1;\n+    CPrivKey mutable_k2 = k2;\n+    uint256 mutable_session_id = session_id;\n+\n+    CSerializedNetMsg test_msg = CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERSION, PROTOCOL_VERSION, (int)NODE_NETWORK, 123, CAddress(CService(), NODE_NONE), CAddress(CService(), NODE_NONE), 123, \"foobar\", 500000, true);\n+    CSerializedNetMsg test_msg_short = CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK);\n+\n+    // make sure we use the fast rekey rules\n+    std::unique_ptr<TransportSerializer> serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2, session_id));\n+    ;\n+    std::unique_ptr<TransportDeserializer> deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(Params().MessageStart(), k1, k2, session_id));\n+\n+    ChaCha20Poly1305AEAD test_decryption_aead(k1.data(), k1.size(), k2.data(), k2.size());\n+\n+    for (unsigned int i = 0; i <= 76; i++) {\n+        // encrypt the message without the fast-rekey rules\n+        gArgs.ForceSetArg(\"-netencryptionfastrekey\", \"0\");\n+        std::vector<unsigned char> serialized_header;\n+        serializer->prepareForTransport(test_msg, serialized_header);\n+\n+        // decrypt the message with the fast rekey-rules\n+        gArgs.ForceSetArg(\"-netencryptionfastrekey\", \"1\");\n+        read_message(deserializer, serialized_header, test_msg);\n+        CNetMessage msg_deser = deserializer->GetMessage(Params().MessageStart(), GetTimeMicros());\n+\n+        // make sure we detect the failed rekey\n+        // the 76. message (32kb) must have violated the fast rekey limits\n+        BOOST_CHECK(msg_deser.m_valid_header == (i != 76));",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 94,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "1b2f52af4f85910673ac43be1568e3ad32e878ee",
    "user": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Could you explain a bit what you envision the `-netencryptionfastrekey` flag to do? Is it a command line flag for testing purposes?",
    "created_at": "2020-04-13T20:54:12Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407715006",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407715006"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407715006"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407715006/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 422,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 514,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407726340",
    "pull_request_review_id": 392431872,
    "id": 407726340,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyNjM0MA==",
    "diff_hunk": "@@ -703,6 +705,55 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+class V2TransportDeserializer : public TransportDeserializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    uint64_t m_payload_seqnr; // sequence number for the payload\n+    uint64_t m_aad_seqnr;     // sequence number for the packet length (AD)\n+    int m_aad_pos;            // position in the aad keystream\n+    bool m_in_data;           // parsing header (false) or data (true)\n+    uint32_t m_message_size;  // expected message size\n+    CDataStream vRecv;        // received message data\n+    unsigned int m_hdr_pos;   // read pos in header\n+    unsigned int m_data_pos;  // read pos in data\n+\n+    int readHeader(const char* pch, unsigned int nBytes);\n+    int readData(const char* pch, unsigned int nBytes);\n+\n+public:\n+    V2TransportDeserializer(const CMessageHeader::MessageStartChars& pchMessageStartIn, const CPrivKey& k1, const CPrivKey& k2) : m_aead(new ChaCha20Poly1305AEAD(k1.data(), k1.size(), k2.data(), k2.size())), m_payload_seqnr(0), m_aad_seqnr(0), m_aad_pos(0), vRecv(SER_NETWORK, INIT_PROTO_VERSION)",
    "path": "src/net.h",
    "position": null,
    "original_position": 32,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "786ec9bffc09c73d5b94e5056e7396adc0c2eb3d",
    "user": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Perhaps I'm mistaken, but it seems like this `pchMessageStartIn` is not needed. I tried compiling with it removed and that seemed to work.",
    "created_at": "2020-04-13T21:16:25Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407726340",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407726340"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407726340"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407726340/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 725,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407729684",
    "pull_request_review_id": 392431872,
    "id": 407729684,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcyOTY4NA==",
    "diff_hunk": "@@ -703,6 +705,55 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+class V2TransportDeserializer : public TransportDeserializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    uint64_t m_payload_seqnr; // sequence number for the payload\n+    uint64_t m_aad_seqnr;     // sequence number for the packet length (AD)\n+    int m_aad_pos;            // position in the aad keystream\n+    bool m_in_data;           // parsing header (false) or data (true)\n+    uint32_t m_message_size;  // expected message size\n+    CDataStream vRecv;        // received message data\n+    unsigned int m_hdr_pos;   // read pos in header\n+    unsigned int m_data_pos;  // read pos in data",
    "path": "src/net.h",
    "position": null,
    "original_position": 26,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "786ec9bffc09c73d5b94e5056e7396adc0c2eb3d",
    "user": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Perhaps we could use in-class member initializers to de-clutter the constructor signature",
    "created_at": "2020-04-13T21:23:14Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407729684",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407729684"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407729684"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407729684/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 711,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 719,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407741063",
    "pull_request_review_id": 392463471,
    "id": 407741063,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0MTA2Mw==",
    "diff_hunk": "@@ -199,3 +199,127 @@ const std::vector<std::string> &getAllNetMessageTypes()\n {\n     return allNetMessageTypesVec;\n }\n+\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FILTERLOAD) {\n+        return NetMsgType::FILTERLOAD_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETADDR) {\n+        return NetMsgType::GETADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETBLOCKS) {\n+        return NetMsgType::GETBLOCKS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::GETBLOCKTXN) {\n+        return NetMsgType::GETBLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETDATA) {\n+        return NetMsgType::GETDATA_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETHEADERS) {\n+        return NetMsgType::GETHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::HEADERS) {\n+        return NetMsgType::HEADERS_SHORT_ID;\n+    } else if (cmd == NetMsgType::INV) {\n+        return NetMsgType::INV_SHORT_ID;\n+    } else if (cmd == NetMsgType::MEMPOOL) {\n+        return NetMsgType::MEMPOOL_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::MERKLEBLOCK) {\n+        return NetMsgType::MERKLEBLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::NOTFOUND) {\n+        return NetMsgType::NOTFOUND_SHORT_ID;\n+    } else if (cmd == NetMsgType::PING) {\n+        return NetMsgType::PING_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::PONG) {\n+        return NetMsgType::PONG_SHORT_ID;\n+    } else if (cmd == NetMsgType::SENDCMPCT) {\n+        return NetMsgType::SENDCMPCT_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::SENDHEADERS) {\n+        return NetMsgType::SENDHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::TX) {\n+        return NetMsgType::TX_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERACK) {\n+        return NetMsgType::VERACK_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERSION) {\n+        return NetMsgType::VERSION_SHORT_ID;\n+        ;\n+    }\n+    return 0; //no short command\n+}\n+\n+bool GetCommandFromShortCommandID(uint8_t shortID, std::string& cmd)",
    "path": "src/protocol.cpp",
    "position": 110,
    "original_position": 71,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Please replace occurrences of \"command\" with something like \"msg_type\" at least in new code. See also #18533 ",
    "created_at": "2020-04-13T21:48:06Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407741063",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407741063"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407741063"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407741063/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 249,
    "original_line": 249,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407962780",
    "pull_request_review_id": 392717158,
    "id": 407962780,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzk2Mjc4MA==",
    "diff_hunk": "@@ -199,3 +199,127 @@ const std::vector<std::string> &getAllNetMessageTypes()\n {\n     return allNetMessageTypesVec;\n }\n+\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FILTERLOAD) {\n+        return NetMsgType::FILTERLOAD_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETADDR) {\n+        return NetMsgType::GETADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETBLOCKS) {\n+        return NetMsgType::GETBLOCKS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::GETBLOCKTXN) {\n+        return NetMsgType::GETBLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETDATA) {\n+        return NetMsgType::GETDATA_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETHEADERS) {\n+        return NetMsgType::GETHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::HEADERS) {\n+        return NetMsgType::HEADERS_SHORT_ID;\n+    } else if (cmd == NetMsgType::INV) {\n+        return NetMsgType::INV_SHORT_ID;\n+    } else if (cmd == NetMsgType::MEMPOOL) {\n+        return NetMsgType::MEMPOOL_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::MERKLEBLOCK) {\n+        return NetMsgType::MERKLEBLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::NOTFOUND) {\n+        return NetMsgType::NOTFOUND_SHORT_ID;\n+    } else if (cmd == NetMsgType::PING) {\n+        return NetMsgType::PING_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::PONG) {\n+        return NetMsgType::PONG_SHORT_ID;\n+    } else if (cmd == NetMsgType::SENDCMPCT) {\n+        return NetMsgType::SENDCMPCT_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::SENDHEADERS) {\n+        return NetMsgType::SENDHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::TX) {\n+        return NetMsgType::TX_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERACK) {\n+        return NetMsgType::VERACK_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERSION) {\n+        return NetMsgType::VERSION_SHORT_ID;\n+        ;\n+    }\n+    return 0; //no short command\n+}\n+\n+bool GetCommandFromShortCommandID(uint8_t shortID, std::string& cmd)",
    "path": "src/protocol.cpp",
    "position": 110,
    "original_position": 71,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I'd like to keep it to be consistent with BIP324 (and other bips). Changing it might make it more confusing.",
    "created_at": "2020-04-14T08:37:36Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407962780",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407962780"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r407962780"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/407962780/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 249,
    "original_line": 249,
    "side": "RIGHT",
    "in_reply_to_id": 407741063
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408000719",
    "pull_request_review_id": 392762346,
    "id": 408000719,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAwMDcxOQ==",
    "diff_hunk": "@@ -703,6 +705,68 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS",
    "path": "src/net.h",
    "position": null,
    "original_position": 22,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks. I added the check for not violating the `MIN_REKEY_TIME`.",
    "created_at": "2020-04-14T09:36:46Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r408000719",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408000719"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r408000719"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408000719/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 834,
    "side": "RIGHT",
    "in_reply_to_id": 407266630
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408001077",
    "pull_request_review_id": 392762761,
    "id": 408001077,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAwMTA3Nw==",
    "diff_hunk": "@@ -199,3 +199,127 @@ const std::vector<std::string> &getAllNetMessageTypes()\n {\n     return allNetMessageTypesVec;\n }\n+\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FILTERLOAD) {\n+        return NetMsgType::FILTERLOAD_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETADDR) {\n+        return NetMsgType::GETADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETBLOCKS) {\n+        return NetMsgType::GETBLOCKS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::GETBLOCKTXN) {\n+        return NetMsgType::GETBLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETDATA) {\n+        return NetMsgType::GETDATA_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETHEADERS) {\n+        return NetMsgType::GETHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::HEADERS) {\n+        return NetMsgType::HEADERS_SHORT_ID;\n+    } else if (cmd == NetMsgType::INV) {\n+        return NetMsgType::INV_SHORT_ID;\n+    } else if (cmd == NetMsgType::MEMPOOL) {\n+        return NetMsgType::MEMPOOL_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::MERKLEBLOCK) {\n+        return NetMsgType::MERKLEBLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::NOTFOUND) {\n+        return NetMsgType::NOTFOUND_SHORT_ID;\n+    } else if (cmd == NetMsgType::PING) {\n+        return NetMsgType::PING_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::PONG) {\n+        return NetMsgType::PONG_SHORT_ID;\n+    } else if (cmd == NetMsgType::SENDCMPCT) {\n+        return NetMsgType::SENDCMPCT_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::SENDHEADERS) {\n+        return NetMsgType::SENDHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::TX) {\n+        return NetMsgType::TX_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERACK) {\n+        return NetMsgType::VERACK_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERSION) {\n+        return NetMsgType::VERSION_SHORT_ID;\n+        ;\n+    }\n+    return 0; //no short command\n+}\n+\n+bool GetCommandFromShortCommandID(uint8_t shortID, std::string& cmd)\n+{\n+    if (shortID == NetMsgType::ADDR_SHORT_ID) {",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 73,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Can you elaborate on the differences? Aren't the compiler differences marginal?",
    "created_at": "2020-04-14T09:37:17Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r408001077",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408001077"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r408001077"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408001077/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 318,
    "side": "RIGHT",
    "in_reply_to_id": 407265992
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408001745",
    "pull_request_review_id": 392763565,
    "id": 408001745,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAwMTc0NQ==",
    "diff_hunk": "@@ -718,6 +719,163 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = (m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected %ld\\n\", m_message_size);",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 38,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "It was initially to debug the most significant bit. I'll remove it.",
    "created_at": "2020-04-14T09:38:22Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r408001745",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408001745"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r408001745"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408001745/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 748,
    "side": "RIGHT",
    "in_reply_to_id": 407261365
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408013698",
    "pull_request_review_id": 392777788,
    "id": 408013698,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAxMzY5OA==",
    "diff_hunk": "@@ -718,6 +719,163 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = (m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected %ld\\n\", m_message_size);\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int AAD_LEN = CHACHA20_POLY1305_AEAD_AAD_LEN;\n+        unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // count bytes we decrypted including MAC tag + AD\n+        m_bytes_decrypted += vRecv.size();\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= 12 && vRecv.size() >= size_or_shortid) {\n+            // string command\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID\n+        if (!valid_header && size_or_shortid > 0) {\n+            valid_header = true;\n+            if (!GetCommandFromShortCommandID(size_or_shortid, command_name)) {\n+                // unknown-short-id\n+                //  results in a valid but unknown message (will be skipped)\n+                command_name = \"unknown-\" + ToString(size_or_shortid);\n+            }\n+        }",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 115,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Good catch. Add `0` now to the `unknown` branch.",
    "created_at": "2020-04-14T09:57:00Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r408013698",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408013698"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r408013698"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408013698/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 809,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 859,
    "side": "RIGHT",
    "in_reply_to_id": 407262244
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408018775",
    "pull_request_review_id": 392783952,
    "id": 408018775,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAxODc3NQ==",
    "diff_hunk": "@@ -731,6 +889,97 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command\n+    std::vector<unsigned char> serialized_header;\n+    // reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    serialized_header.resize(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID (or eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow sepearte buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + 16, 0);\n+\n+    // length is only allowed up to 2^23 (bit24 is used for indicating rekey)\n+    bool bit24 = msg.data[2] & (1u << 7);\n+    assert(!bit24);\n+\n+    // check if we should rekey after this message\n+    int64_t now = GetTime(); //TODO: check how expansive the GetTime call is and if it is avoidable\n+    bool rekey = false;",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 223,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Let's keep it for readability.",
    "created_at": "2020-04-14T10:05:17Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r408018775",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408018775"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r408018775"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/408018775/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1021,
    "side": "RIGHT",
    "in_reply_to_id": 407264511
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414820256",
    "pull_request_review_id": 400224123,
    "id": 414820256,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgyMDI1Ng==",
    "diff_hunk": "@@ -45,3 +45,14 @@ void test_one_input(const std::vector<uint8_t>& buffer)\n         }\n     }\n }\n+\n+void test_one_input(const std::vector<uint8_t>& buffer)\n+{\n+    std::unique_ptr<TransportDeserializer> v1_deserializer = MakeUnique<V1TransportDeserializer>(Params().MessageStart(), SER_NETWORK, INIT_PROTO_VERSION);\n+    const CPrivKey k1(32, 0);\n+    const CPrivKey k2(32, 0);\n+    const uint256 session_id;\n+    std::unique_ptr<TransportDeserializer> v2_deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(k1, k2, session_id));\n+    test_deserializer(v1_deserializer, buffer, CMessageHeader::HEADER_SIZE);\n+    test_deserializer(v2_deserializer, buffer, CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);",
    "path": "src/test/fuzz/p2p_transport_deserializer.cpp",
    "position": null,
    "original_position": 51,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "f9d3052f986ceb583aca47a15bd51a0bdce838ab",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Can you explain the fuzzer a bit more? It seems you are reusing the buffer for both deserializers. Assuming that the structure of the buffer for both deserializers should be different, this might cause the fuzz engine to only focus on one of them (the \"easier\" one) and rarely explore paths in the v2 one, no?\r\n\r\nIf so, maybe you can split them up in two targets. See `./src/test/fuzz/deserialize.cpp` on how to do that.",
    "created_at": "2020-04-24T19:43:44Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r414820256",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414820256"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r414820256"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/414820256/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 56,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/415674338",
    "pull_request_review_id": 400799152,
    "id": 415674338,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTY3NDMzOA==",
    "diff_hunk": "@@ -45,3 +45,14 @@ void test_one_input(const std::vector<uint8_t>& buffer)\n         }\n     }\n }\n+\n+void test_one_input(const std::vector<uint8_t>& buffer)\n+{\n+    std::unique_ptr<TransportDeserializer> v1_deserializer = MakeUnique<V1TransportDeserializer>(Params().MessageStart(), SER_NETWORK, INIT_PROTO_VERSION);\n+    const CPrivKey k1(32, 0);\n+    const CPrivKey k2(32, 0);\n+    const uint256 session_id;\n+    std::unique_ptr<TransportDeserializer> v2_deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(k1, k2, session_id));\n+    test_deserializer(v1_deserializer, buffer, CMessageHeader::HEADER_SIZE);\n+    test_deserializer(v2_deserializer, buffer, CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);",
    "path": "src/test/fuzz/p2p_transport_deserializer.cpp",
    "position": null,
    "original_position": 51,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "f9d3052f986ceb583aca47a15bd51a0bdce838ab",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks!\r\nI switched to the same preprocessor bridge then used in `deserialize.cpp`.",
    "created_at": "2020-04-27T09:55:02Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r415674338",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/415674338"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r415674338"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/415674338/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 56,
    "side": "RIGHT",
    "in_reply_to_id": 414820256
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417787978",
    "pull_request_review_id": 403241154,
    "id": 417787978,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc4Nzk3OA==",
    "diff_hunk": "@@ -199,3 +199,127 @@ const std::vector<std::string> &getAllNetMessageTypes()\n {\n     return allNetMessageTypesVec;\n }\n+\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FILTERLOAD) {\n+        return NetMsgType::FILTERLOAD_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETADDR) {\n+        return NetMsgType::GETADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETBLOCKS) {\n+        return NetMsgType::GETBLOCKS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::GETBLOCKTXN) {\n+        return NetMsgType::GETBLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETDATA) {\n+        return NetMsgType::GETDATA_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETHEADERS) {\n+        return NetMsgType::GETHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::HEADERS) {\n+        return NetMsgType::HEADERS_SHORT_ID;\n+    } else if (cmd == NetMsgType::INV) {\n+        return NetMsgType::INV_SHORT_ID;\n+    } else if (cmd == NetMsgType::MEMPOOL) {\n+        return NetMsgType::MEMPOOL_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::MERKLEBLOCK) {\n+        return NetMsgType::MERKLEBLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::NOTFOUND) {\n+        return NetMsgType::NOTFOUND_SHORT_ID;\n+    } else if (cmd == NetMsgType::PING) {\n+        return NetMsgType::PING_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::PONG) {\n+        return NetMsgType::PONG_SHORT_ID;\n+    } else if (cmd == NetMsgType::SENDCMPCT) {\n+        return NetMsgType::SENDCMPCT_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::SENDHEADERS) {\n+        return NetMsgType::SENDHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::TX) {\n+        return NetMsgType::TX_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERACK) {\n+        return NetMsgType::VERACK_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERSION) {\n+        return NetMsgType::VERSION_SHORT_ID;\n+        ;\n+    }\n+    return 0; //no short command\n+}\n+\n+bool GetCommandFromShortCommandID(uint8_t shortID, std::string& cmd)\n+{\n+    if (shortID == NetMsgType::ADDR_SHORT_ID) {",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 73,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Alternatively have you considered a translation table, defining a struct \r\n\r\n```\r\nstruct {\r\n           std::string  long_cmd;\r\n           std::string  short_cmd;\r\n} short_id_table\r\n```\r\nYou statically declare an array of such structs, with one element for every pair. And `GetCommandFromShortCommandID` just iter through array until funding a match.\r\n\r\nThat way in the future we may have a parser to load a new table (`bitcoin-cli loadv2mappings`) to enable custom peer-agreement mappings without code modifications. ",
    "created_at": "2020-04-30T06:42:34Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417787978",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417787978"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417787978"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417787978/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 318,
    "side": "RIGHT",
    "in_reply_to_id": 407265992
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417797877",
    "pull_request_review_id": 403241154,
    "id": 417797877,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzc5Nzg3Nw==",
    "diff_hunk": "@@ -216,29 +237,44 @@ extern const char *FEEFILTER;\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *SENDCMPCT;\n+constexpr uint8_t SENDCMPCT_SHORT_ID = 34;\n /**\n  * Contains a CBlockHeaderAndShortTxIDs object - providing a header and\n  * list of \"short txids\".\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *CMPCTBLOCK;\n+constexpr uint8_t CMPCTBLOCK_SHORT_ID = 16;\n /**\n  * Contains a BlockTransactionsRequest\n  * Peer should respond with \"blocktxn\" message.\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *GETBLOCKTXN;\n+constexpr uint8_t GETBLOCKTXN_SHORT_ID = 23;\n /**\n  * Contains a BlockTransactions.\n  * Sent in response to a \"getblocktxn\" message.\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *BLOCKTXN;\n+constexpr uint8_t BLOCKTXN_SHORT_ID = 15;\n };\n \n /* Get a vector of all valid message types (see above) */\n const std::vector<std::string> &getAllNetMessageTypes();\n \n+// Short Command IDs are a low bandwidth representations of a message type\n+// The mapping is a peer to peer agreement",
    "path": "src/protocol.h",
    "position": null,
    "original_position": 187,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "caa6c582f415dd7ac2fdd2bafae7c896d4e05239",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think here or BIP should lay out what the advantage and example of p2p agreement mapping. I can foresee people willingly to experiment or deploy their own light-clients protocols inside v2, and therefore favor bandwidth-reduction for what make sense for them.\r\n\r\nHowever, I can't see how peer may signal custom mapping or at least agree they are on the default ones. You can agree out-of-band but can't assert peer identity until you succeed an authentication. And authentication protocol success may rely on mappings like COUNTERSIGN_PUBKEY_SHORT_ID = 47.\r\n\r\nYou may want a MAPPING/MAPPINGACK exchanged via a regular command-string. Actually BIP only precise \"The ID/string mapping is a peer to peer arrangement and MAY be negotiated between the initiating and responding peer.\" You may update to say \"Negotiation mechanism is left open to a future specification effort\"",
    "created_at": "2020-04-30T07:05:01Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417797877",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417797877"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417797877"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417797877/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 257,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417801470",
    "pull_request_review_id": 403241154,
    "id": 417801470,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgwMTQ3MA==",
    "diff_hunk": "@@ -701,6 +703,53 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+class V2TransportDeserializer : public TransportDeserializer",
    "path": "src/net.h",
    "position": null,
    "original_position": 15,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "You may add a reference saying serializer/deserializer are BIP-324 compliant",
    "created_at": "2020-04-30T07:12:47Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417801470",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417801470"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417801470"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417801470/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 837,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417816870",
    "pull_request_review_id": 403241154,
    "id": 417816870,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgxNjg3MA==",
    "diff_hunk": "@@ -715,6 +764,24 @@ class V1TransportSerializer  : public TransportSerializer {\n     void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) override;\n };\n \n+class V2TransportSerializer : public TransportSerializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for a later rekeying",
    "path": "src/net.h",
    "position": null,
    "original_position": 73,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "You may want to add old_ prefix and precise at first key rotation m_old_aead == m_aead",
    "created_at": "2020-04-30T07:42:27Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417816870",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417816870"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417816870"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417816870/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 895,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417829120",
    "pull_request_review_id": 403241154,
    "id": 417829120,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgyOTEyMA==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 31,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Why the encrypted length doesn't get its own MAC to guarantee integrity ? It can decrypt to some garbage and therefore open to manipulating ciphertext-MAC seek in message ?",
    "created_at": "2020-04-30T08:04:45Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417829120",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417829120"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417829120"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417829120/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 784,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417833895",
    "pull_request_review_id": 403241154,
    "id": 417833895,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgzMzg5NQ==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 36,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Hmmm isn't the spec making the assumption you rely on some ordered transport protocol (TCP) ? If yes I think that's okay because you should be guarantee against network failure and peers may out-of-sync. But BIP should precise message shouldn't be resend with same sequence number?\r\n\r\nNote IIRC Fibre is using UDP.",
    "created_at": "2020-04-30T08:13:50Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417833895",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417833895"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417833895"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417833895/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 789,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417839203",
    "pull_request_review_id": 403241154,
    "id": 417839203,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgzOTIwMw==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)",
    "path": "src/net.cpp",
    "position": 69,
    "original_position": 69,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`vRecv` doesn't contain also AAD ?",
    "created_at": "2020-04-30T08:22:55Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417839203",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417839203"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417839203"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417839203/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 821,
    "original_line": 821,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417842245",
    "pull_request_review_id": 403241154,
    "id": 417842245,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg0MjI0NQ==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 73,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Even if decryption fails ? Also comment about increasing AAD sequence number is allusive can you precise a unsuccessful decryption still increase sequence number. ",
    "created_at": "2020-04-30T08:27:57Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417842245",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417842245"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417842245"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417842245/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 806,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417845830",
    "pull_request_review_id": 403241154,
    "id": 417845830,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg0NTgzMA==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);",
    "path": "src/net.cpp",
    "position": 83,
    "original_position": 83,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "What if len==0? Or is this case can't be hit due to previous Read logic?",
    "created_at": "2020-04-30T08:33:59Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417845830",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417845830"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417845830"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417845830/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 835,
    "original_line": 835,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417854354",
    "pull_request_review_id": 403241154,
    "id": 417854354,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg1NDM1NA==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= 12 && vRecv.size() >= size_or_shortid) {\n+            // string command\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID\n+        if (!valid_header && size_or_shortid >= 0) {\n+            valid_header = true;\n+            if (!GetCommandFromShortCommandID(size_or_shortid, command_name)) {\n+                // unknown-short-id\n+                //  results in a valid but unknown message (will be skipped)\n+                command_name = \"unknown-\" + ToString(size_or_shortid);\n+            }\n+        }\n+    }\n+    // increase the aad_pos and eventually the sequence number\n+    m_aad_pos += CHACHA20_POLY1305_AEAD_AAD_LEN;\n+    if (m_aad_pos + CHACHA20_POLY1305_AEAD_AAD_LEN > CHACHA20_ROUND_OUTPUT) {\n+        m_aad_pos = 0;\n+        m_aad_seqnr++;\n+    }\n+    // increase the payload sequence number by 1\n+    m_payload_seqnr++;\n+\n+    // decompose a single CNetMessage from the TransportDeserializer\n+    CNetMessage msg(std::move(vRecv)); // result in a message with CDataStream with readpos pointing to the message payload\n+    msg.m_command = command_name;\n+\n+    // store state about valid header, netmagic and checksum\n+    msg.m_valid_header = valid_header; // not relevant for v2, always pass\n+    msg.m_valid_checksum = valid_checksum;",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 127,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think checksum is also not revelant and always true, so comment may be generic for three of them? But generally if this field are always true for v2, a future refactor may just call public methods on messages in `ProcessMessage` like `{Header,Checksum,Netmagic}Valid`.",
    "created_at": "2020-04-30T08:48:35Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417854354",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417854354"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417854354"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417854354/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 865,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417855756",
    "pull_request_review_id": 403241154,
    "id": 417855756,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg1NTc1Ng==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= 12 && vRecv.size() >= size_or_shortid) {\n+            // string command\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID\n+        if (!valid_header && size_or_shortid >= 0) {\n+            valid_header = true;\n+            if (!GetCommandFromShortCommandID(size_or_shortid, command_name)) {\n+                // unknown-short-id\n+                //  results in a valid but unknown message (will be skipped)",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 107,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Maybe it would be better to drop unknown message, or at least as soon as we can to avoid some upstream buffer growing unbounded.",
    "created_at": "2020-04-30T08:50:56Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417855756",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417855756"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417855756"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417855756/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 845,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417856950",
    "pull_request_review_id": 403241154,
    "id": 417856950,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg1Njk1MA==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= 12 && vRecv.size() >= size_or_shortid) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 94,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This line was confusing at first read, precise its size of command we parse or a reference to BIP \"The command field MUST start with a byte that defines the length...\"",
    "created_at": "2020-04-30T08:52:50Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417856950",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417856950"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417856950"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417856950/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 797,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417959916",
    "pull_request_review_id": 403455165,
    "id": 417959916,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk1OTkxNg==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 36,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think we can make the assumptions that messages are processing in order and that the underlaying transport layer takes care of transmission failures. I don't think we need to add error/out-of-sequence detection in out message transport protocol.",
    "created_at": "2020-04-30T12:05:09Z",
    "updated_at": "2021-01-20T09:24:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417959916",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417959916"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417959916"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417959916/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 789,
    "side": "RIGHT",
    "in_reply_to_id": 417833895
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417960845",
    "pull_request_review_id": 403456371,
    "id": 417960845,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk2MDg0NQ==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= 12 && vRecv.size() >= size_or_shortid) {\n+            // string command\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID\n+        if (!valid_header && size_or_shortid >= 0) {\n+            valid_header = true;\n+            if (!GetCommandFromShortCommandID(size_or_shortid, command_name)) {\n+                // unknown-short-id\n+                //  results in a valid but unknown message (will be skipped)",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 107,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think we should tolerate unknown short IDs the same way as we tolerate unknown string commands (which we currently do for future backward compatibility).",
    "created_at": "2020-04-30T12:07:09Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417960845",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417960845"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r417960845"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/417960845/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 845,
    "side": "RIGHT",
    "in_reply_to_id": 417855756
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418113575",
    "pull_request_review_id": 403654504,
    "id": 418113575,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExMzU3NQ==",
    "diff_hunk": "@@ -199,3 +199,127 @@ const std::vector<std::string> &getAllNetMessageTypes()\n {\n     return allNetMessageTypesVec;\n }\n+\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FILTERLOAD) {\n+        return NetMsgType::FILTERLOAD_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETADDR) {\n+        return NetMsgType::GETADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETBLOCKS) {\n+        return NetMsgType::GETBLOCKS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::GETBLOCKTXN) {\n+        return NetMsgType::GETBLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETDATA) {\n+        return NetMsgType::GETDATA_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETHEADERS) {\n+        return NetMsgType::GETHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::HEADERS) {\n+        return NetMsgType::HEADERS_SHORT_ID;\n+    } else if (cmd == NetMsgType::INV) {\n+        return NetMsgType::INV_SHORT_ID;\n+    } else if (cmd == NetMsgType::MEMPOOL) {\n+        return NetMsgType::MEMPOOL_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::MERKLEBLOCK) {\n+        return NetMsgType::MERKLEBLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::NOTFOUND) {\n+        return NetMsgType::NOTFOUND_SHORT_ID;\n+    } else if (cmd == NetMsgType::PING) {\n+        return NetMsgType::PING_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::PONG) {\n+        return NetMsgType::PONG_SHORT_ID;\n+    } else if (cmd == NetMsgType::SENDCMPCT) {\n+        return NetMsgType::SENDCMPCT_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::SENDHEADERS) {\n+        return NetMsgType::SENDHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::TX) {\n+        return NetMsgType::TX_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERACK) {\n+        return NetMsgType::VERACK_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERSION) {\n+        return NetMsgType::VERSION_SHORT_ID;\n+        ;\n+    }\n+    return 0; //no short command\n+}\n+\n+bool GetCommandFromShortCommandID(uint8_t shortID, std::string& cmd)\n+{\n+    if (shortID == NetMsgType::ADDR_SHORT_ID) {",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 73,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> Can you elaborate on the differences? Aren't the compiler differences marginal?\r\n\r\nIt does seem like a switch statement might be a good alternative to the `if...else ifs` here, to make explicit the nature of the operation (testing a single value against a set of scoped enumerations or array of values) and possibly generate better code with a jump table instead of repeatedly checking individual values.\r\n\r\nA translation table could be an alternative as well.",
    "created_at": "2020-04-30T15:53:04Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418113575",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418113575"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418113575"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418113575/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 318,
    "side": "RIGHT",
    "in_reply_to_id": 407265992
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418204408",
    "pull_request_review_id": 403769916,
    "id": 418204408,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIwNDQwOA==",
    "diff_hunk": "@@ -717,6 +781,27 @@ class V1TransportSerializer  : public TransportSerializer {\n     void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) override;\n };\n \n+class V2TransportSerializer : public TransportSerializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for a later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_encrypted = 0; //counter of bytes encrypted with same key\n+    int64_t m_time_last_rekey = 0;\n+    uint256 m_session_id; // the encryption session_id, relevant for rekeying\n+    uint64_t m_payload_seqnr = 0;\n+    uint64_t m_aad_seqnr = 0;\n+    int m_aad_pos = 0;\n+\n+public:\n+    V2TransportSerializer(const CPrivKey& k1, const CPrivKey& k2, const uint256& session_id) : m_aead(new ChaCha20Poly1305AEAD(k1.data(), k1.size(), k2.data(), k2.size())), m_aead_k1(k1), m_aead_k2(k2), m_session_id(session_id)",
    "path": "src/net.h",
    "position": null,
    "original_position": 98,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Agree this would be nice.",
    "created_at": "2020-04-30T18:23:31Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418204408",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418204408"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418204408"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418204408/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 916,
    "side": "RIGHT",
    "in_reply_to_id": 407265779
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418215753",
    "pull_request_review_id": 403769916,
    "id": 418215753,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIxNTc1Mw==",
    "diff_hunk": "@@ -718,6 +720,170 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 60,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think a comment for this conditional branch would be helpful.\r\n```diff\r\n     } else {\r\n+        // Read the message data\r\n         const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\r\n```",
    "created_at": "2020-04-30T18:44:31Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418215753",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418215753"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418215753"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418215753/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 805,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418216979",
    "pull_request_review_id": 403769916,
    "id": 418216979,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIxNjk3OQ==",
    "diff_hunk": "@@ -718,6 +720,170 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 22,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "9f81125 nit: perhaps start with the truthy branch (that reads the message) e.g. `if (m_in_data) {`",
    "created_at": "2020-04-30T18:46:44Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418216979",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418216979"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418216979"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418216979/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 775,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418223280",
    "pull_request_review_id": 403769916,
    "id": 418223280,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODIyMzI4MA==",
    "diff_hunk": "@@ -718,6 +720,170 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 52,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "9f81125 could replace the two `-1` fail values returned in `V2TransportDeserializer::Read` (as well as the two in `V1TransportDeserializer::readHeader`) with a static constant whose name could make their meaning explicit, e.g. `static constexpr int MESSAGE_FAILURE = -1;` or similar",
    "created_at": "2020-04-30T18:58:10Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418223280",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418223280"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418223280"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418223280/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 796,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418312693",
    "pull_request_review_id": 403769916,
    "id": 418312693,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMxMjY5Mw==",
    "diff_hunk": "@@ -216,29 +237,44 @@ extern const char *FEEFILTER;\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *SENDCMPCT;\n+constexpr uint8_t SENDCMPCT_SHORT_ID = 34;\n /**\n  * Contains a CBlockHeaderAndShortTxIDs object - providing a header and\n  * list of \"short txids\".\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *CMPCTBLOCK;\n+constexpr uint8_t CMPCTBLOCK_SHORT_ID = 16;\n /**\n  * Contains a BlockTransactionsRequest\n  * Peer should respond with \"blocktxn\" message.\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *GETBLOCKTXN;\n+constexpr uint8_t GETBLOCKTXN_SHORT_ID = 23;\n /**\n  * Contains a BlockTransactions.\n  * Sent in response to a \"getblocktxn\" message.\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *BLOCKTXN;\n+constexpr uint8_t BLOCKTXN_SHORT_ID = 15;\n };\n \n /* Get a vector of all valid message types (see above) */\n const std::vector<std::string> &getAllNetMessageTypes();\n \n+// Short Command IDs are a low bandwidth representations of a message type\n+// The mapping is a peer to peer agreement\n+\n+// returns the short command ID for a command\n+// returns 0 if no short command ID has been found\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd);\n+\n+// returns the command (string) from a short command ID\n+// returns an empty string if short command ID has not been found\n+bool GetCommandFromShortCommandID(uint8_t shortID, std::string& cmd);",
    "path": "src/protocol.h",
    "position": 23,
    "original_position": 195,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "caa6c58 Could invert the `GetCommandFromShortCommandID` parameter order? This would make it like `read()` and also allow it to have the same first param as `GetShortCommandIDFromCommand`.",
    "created_at": "2020-04-30T21:58:26Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418312693",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418312693"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418312693"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418312693/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 277,
    "original_line": 277,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418316264",
    "pull_request_review_id": 403769916,
    "id": 418316264,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMxNjI2NA==",
    "diff_hunk": "@@ -216,29 +237,44 @@ extern const char *FEEFILTER;\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *SENDCMPCT;\n+constexpr uint8_t SENDCMPCT_SHORT_ID = 34;\n /**\n  * Contains a CBlockHeaderAndShortTxIDs object - providing a header and\n  * list of \"short txids\".\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *CMPCTBLOCK;\n+constexpr uint8_t CMPCTBLOCK_SHORT_ID = 16;\n /**\n  * Contains a BlockTransactionsRequest\n  * Peer should respond with \"blocktxn\" message.\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *GETBLOCKTXN;\n+constexpr uint8_t GETBLOCKTXN_SHORT_ID = 23;\n /**\n  * Contains a BlockTransactions.\n  * Sent in response to a \"getblocktxn\" message.\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *BLOCKTXN;\n+constexpr uint8_t BLOCKTXN_SHORT_ID = 15;\n };\n \n /* Get a vector of all valid message types (see above) */\n const std::vector<std::string> &getAllNetMessageTypes();\n \n+// Short Command IDs are a low bandwidth representations of a message type\n+// The mapping is a peer to peer agreement\n+\n+// returns the short command ID for a command\n+// returns 0 if no short command ID has been found\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd);",
    "path": "src/protocol.h",
    "position": null,
    "original_position": 191,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "caa6c58 can reference instead of copy?\r\n```diff\r\n-uint8_t GetShortCommandIDFromCommand(const std::string cmd);\r\n+uint8_t GetShortCommandIDFromCommand(const std::string& cmd);\r\n```",
    "created_at": "2020-04-30T22:06:56Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418316264",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418316264"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418316264"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418316264/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 272,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418316911",
    "pull_request_review_id": 403769916,
    "id": 418316911,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMxNjkxMQ==",
    "diff_hunk": "@@ -204,3 +204,127 @@ const std::vector<std::string> &getAllNetMessageTypes()\n {\n     return allNetMessageTypesVec;\n }\n+\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd)",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 6,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "caa6c58 can reference instead of copy?\r\n```diff\r\n-uint8_t GetShortCommandIDFromCommand(const std::string cmd)\r\n+uint8_t GetShortCommandIDFromCommand(const std::string& cmd)\r\n```",
    "created_at": "2020-04-30T22:08:32Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418316911",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418316911"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418316911"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418316911/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 209,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418323240",
    "pull_request_review_id": 403769916,
    "id": 418323240,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODMyMzI0MA==",
    "diff_hunk": "@@ -731,6 +897,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars",
    "path": "src/net.cpp",
    "position": 144,
    "original_position": 198,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "9f81125 could replace the int value of `12` here and line 809 above with an explicit `CMD_MAX_CHARS_SIZE` (or similar) int static constant",
    "created_at": "2020-04-30T22:24:35Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418323240",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418323240"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418323240"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418323240/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 896,
    "original_line": 896,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418513786",
    "pull_request_review_id": 404120272,
    "id": 418513786,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUxMzc4Ng==",
    "diff_hunk": "@@ -731,6 +897,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID or (eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow separate buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + CHACHA20_POLY1305_AEAD_TAG_LEN, 0);\n+\n+    // length is only allowed up to 2^23 (bit24 is used for indicating rekey)\n+    bool bit24 = msg.data[2] & (1u << 7);\n+    assert(!bit24);\n+\n+    // check if we should rekey after this message\n+    const int64_t now = GetTime(); //TODO: check how expansive the GetTime call is and if it is avoidable\n+    bool rekey = false;\n+    if (m_bytes_encrypted >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 32 * 1024 : REKEY_LIMIT_BYTES) || now - m_time_last_rekey >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 10 : REKEY_LIMIT_TIME)) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 237,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "e04eddb3 this conditional with 2 nested ternary conditionals on one line is pretty hard to read.\r\n\r\n<details>\r\n<summary>Here are two ideas.</summary>\r\n<p>\r\n\r\n```diff\r\n-    if (m_bytes_encrypted >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 32 * 1024 : REKEY_LIMIT_BYTES) || now - m_time_last_rekey >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 10 : REKEY_LIMIT_TIME)) {\r\n+    bool fast_rekey = gArgs.GetBoolArg(\"-netencryptionfastrekey\", false);\r\n+    if (m_bytes_encrypted >= (fast_rekey ? 32 * 1024 : REKEY_LIMIT_BYTES) || (now - m_time_last_rekey >= (fast_rekey ? 10 : REKEY_LIMIT_TIME))) {\r\n```\r\nor\r\n\r\n```diff\r\n-    if (m_bytes_encrypted >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 32 * 1024 : REKEY_LIMIT_BYTES) || now - m_time_last_rekey >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 10 : REKEY_LIMIT_TIME)) {\r\n+    if (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false)) {\r\n+        if (m_bytes_encrypted >= 32 * 1024 || (now - m_time_last_rekey >= 10)) {\r\n+            rekey = true;\r\n+        }\r\n+    } else {\r\n+        if (m_bytes_encrypted >= REKEY_LIMIT_BYTES || (now - m_time_last_rekey >= REKEY_LIMIT_TIME)) {\r\n+            rekey = true;\r\n+        }\r\n+    }\r\n+    if (rekey) {\r\n         LogPrint(BCLog::NET, \"Rekey limits reached, performing rekey.\\n\");\r\n         msg.data[2] |= (1u << 7);\r\n-        rekey = true;\r\n     }\r\n```\r\n</p>\r\n</details>\r\n\r\nAlso, it would be nice to replace the various magic values with static constexprs that communicate meaning, like you are already doing in this commit for the rekey values in `net.h`.",
    "created_at": "2020-05-01T11:57:30Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418513786",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418513786"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418513786"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418513786/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1022,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418517170",
    "pull_request_review_id": 404120272,
    "id": 418517170,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUxNzE3MA==",
    "diff_hunk": "@@ -718,6 +720,170 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // count bytes we decrypted including MAC tag + AD\n+        m_bytes_decrypted += vRecv.size();\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= 12 && vRecv.size() >= size_or_shortid) {\n+            // string command\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID\n+        if (!valid_header && size_or_shortid >= 0) {\n+            valid_header = true;\n+            if (!GetCommandFromShortCommandID(size_or_shortid, command_name)) {\n+                // unknown-short-id\n+                //  results in a valid but unknown message (will be skipped)\n+                command_name = \"unknown-\" + ToString(size_or_shortid);\n+            }\n+        }\n+    }\n+    // increase the aad_pos and eventually the sequence number\n+    m_aad_pos += CHACHA20_POLY1305_AEAD_AAD_LEN;\n+    if (m_aad_pos + CHACHA20_POLY1305_AEAD_AAD_LEN > CHACHA20_ROUND_OUTPUT) {\n+        m_aad_pos = 0;\n+        m_aad_seqnr++;\n+    }\n+    // increase the payload sequence number by 1\n+    m_payload_seqnr++;\n+\n+    // decompose a single CNetMessage from the TransportDeserializer\n+    CNetMessage msg(std::move(vRecv)); // result in a message with CDataStream with readpos pointing to the message payload\n+    msg.m_command = command_name;\n+\n+    // store state about valid header, netmagic and checksum\n+    msg.m_valid_header = valid_header; // not relevant for v2, always pass\n+    msg.m_valid_checksum = valid_checksum;\n+    msg.m_valid_netmagic = true; // not relevant for v2, always pass\n+\n+    // store command string, payload size, wire message size\n+    msg.m_message_size = msg.m_recv.size();                                                                    //message payload size (excluding command)\n+    msg.m_raw_message_size = CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN; // raw wire size\n+\n+    const int64_t now = GetTime();\n+    if (m_rekey_flag) {\n+        if (!gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) && (m_time_last_rekey + MIN_REKEY_TIME > now)) {\n+            // remote peer was not respecting the mininal rekey time (DoS)\n+            LogPrint(BCLog::NET, \"Invalid rekey (DoS)\\n\");\n+            msg.m_valid_checksum = false;\n+            msg.m_valid_header = false;\n+        } else {\n+            // make sure we rekey at this point, next message is supposed to be encrypted with the new key\n+            CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k1.data(), m_aead_k1.size()).Finalize(m_aead_k1.data());\n+            CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k2.data(), m_aead_k2.size()).Finalize(m_aead_k2.data());\n+\n+            // reset the AEAD context\n+            m_aead.reset(new ChaCha20Poly1305AEAD(m_aead_k1.data(), m_aead_k1.size(), m_aead_k2.data(), m_aead_k2.size()));\n+            LogPrint(BCLog::NET, \"Rekey: new recv keys (%s, %s)\\n\", HexStr(m_aead_k1), HexStr(m_aead_k2));\n+\n+            // reset sequence numbers\n+            m_payload_seqnr = 0;\n+            m_aad_seqnr = 0;\n+            m_aad_pos = 0;\n+            m_bytes_decrypted = 0;",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 166,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "e04eddb suggestion (like your code at line 983 below). It also clarifies that `m_bytes_decrypted` is a counter of bytes decrypted for the same key.\r\n```diff\r\n             m_aad_pos = 0;\r\n-            m_bytes_decrypted = 0;\r\n+\r\n+            // reset rekey counters\r\n             m_time_last_rekey = now;\r\n+            m_bytes_decrypted = 0;\r\n```\r\n\r\nIn general, there is a fair amount of rekey code duplication in this commit but optimising would be premature at this point. ",
    "created_at": "2020-05-01T12:12:19Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418517170",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418517170"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418517170"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418517170/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 945,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418520848",
    "pull_request_review_id": 404120272,
    "id": 418520848,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyMDg0OA==",
    "diff_hunk": "@@ -701,6 +703,69 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS",
    "path": "src/net.h",
    "position": null,
    "original_position": 22,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "e04eddb suggested change\r\n```diff\r\n-static constexpr unsigned int MIN_REKEY_TIME = 10;      // minimal rekey time to avoid DOS\r\n+static constexpr unsigned int MIN_REKEY_TIME = 10;      // minimum rekey time in seconds to avoid DOS\r\n```\r\n",
    "created_at": "2020-05-01T12:26:37Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418520848",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418520848"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418520848"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418520848/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 834,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418521589",
    "pull_request_review_id": 404120272,
    "id": 418521589,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyMTU4OQ==",
    "diff_hunk": "@@ -731,6 +897,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID or (eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow separate buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + CHACHA20_POLY1305_AEAD_TAG_LEN, 0);\n+\n+    // length is only allowed up to 2^23 (bit24 is used for indicating rekey)\n+    bool bit24 = msg.data[2] & (1u << 7);\n+    assert(!bit24);\n+\n+    // check if we should rekey after this message\n+    const int64_t now = GetTime(); //TODO: check how expansive the GetTime call is and if it is avoidable",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 235,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "It seems that `GetTime()` is deprecated, see `util/time.h`\r\n```cpp\r\n/**\r\n * DEPRECATED\r\n * Use either GetSystemTimeInSeconds (not mockable) or GetTime<T> (mockable)\r\n */\r\nint64_t GetTime();\r\n```\r\n",
    "created_at": "2020-05-01T12:29:35Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418521589",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418521589"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418521589"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418521589/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1020,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418525037",
    "pull_request_review_id": 404120272,
    "id": 418525037,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODUyNTAzNw==",
    "diff_hunk": "@@ -320,4 +322,161 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+size_t read_message(std::unique_ptr<TransportDeserializer>& deserializer, const std::vector<unsigned char>& serialized_header, const CSerializedNetMsg& msg)\n+{\n+    size_t read_bytes = 0;\n+    if (serialized_header.size() > 0) read_bytes += deserializer->Read((const char*)serialized_header.data(), serialized_header.size());\n+    //  second: read the encrypted payload (if required)\n+    if (msg.data.size() > 0) read_bytes += deserializer->Read((const char*)msg.data.data(), msg.data.size());\n+    if (msg.data.size() > read_bytes && msg.data.size() - read_bytes > 0) read_bytes += deserializer->Read((const char*)msg.data.data() + read_bytes, msg.data.size() - read_bytes);",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 23,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "e04eddb what is the difference between `msg.data.size() > read_bytes` and `msg.data.size() - read_bytes > 0`? I'm trying to understand why both checks are needed.",
    "created_at": "2020-05-01T12:41:12Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418525037",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418525037"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418525037"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418525037/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 779,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418927974",
    "pull_request_review_id": 404509129,
    "id": 418927974,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkyNzk3NA==",
    "diff_hunk": "@@ -731,6 +897,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length",
    "path": "src/net.cpp",
    "position": 153,
    "original_position": 207,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Ah yes, I always forgot that Bitcoin isn't network-byte order, maybe it could be part of the spec as a nice reminder.",
    "created_at": "2020-05-02T07:57:46Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418927974",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418927974"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418927974"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418927974/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 905,
    "original_line": 905,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418928926",
    "pull_request_review_id": 404509129,
    "id": 418928926,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkyODkyNg==",
    "diff_hunk": "@@ -731,6 +897,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID or (eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow separate buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + CHACHA20_POLY1305_AEAD_TAG_LEN, 0);",
    "path": "src/net.cpp",
    "position": 174,
    "original_position": 228,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I don't know if std::vector::insert would do preventive reallocation, and that's implementation specific, but do resize first with both header_size + tag_len and then insert would be better?",
    "created_at": "2020-05-02T08:08:10Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418928926",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418928926"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418928926"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418928926/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 926,
    "original_line": 926,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418932056",
    "pull_request_review_id": 404509129,
    "id": 418932056,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzMjA1Ng==",
    "diff_hunk": "@@ -320,4 +322,77 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs)",
    "path": "src/test/net_tests.cpp",
    "position": 12,
    "original_position": 17,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e7bed2ed3288e32ccf85c14413859674f463abf4",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think it would be nice to comment what this test aims to verify. AFAICT it checks for round-trip _correctness_, all others cases like non-encrypted packets, extended packets, shorter packets, zeroed-MAC, garbage MAC are they deferred to fuzzer ?",
    "created_at": "2020-05-02T08:41:50Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418932056",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418932056"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418932056"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418932056/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 933,
    "original_line": 933,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418932760",
    "pull_request_review_id": 404509129,
    "id": 418932760,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzMjc2MA==",
    "diff_hunk": "@@ -741,6 +741,15 @@ int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n             return -1;\n         }\n \n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "What do you mean by \"post-this-message\" in this context? Is this coming from RFC 4253?",
    "created_at": "2020-05-02T08:49:49Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418932760",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418932760"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418932760"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418932760/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 816,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418933231",
    "pull_request_review_id": 404509129,
    "id": 418933231,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzMzIzMQ==",
    "diff_hunk": "@@ -741,6 +741,15 @@ int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n             return -1;\n         }\n \n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 9,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Maybe also log `session_id` or anything to tie a rekeying to a given session/peer?",
    "created_at": "2020-05-02T08:54:50Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418933231",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418933231"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418933231"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418933231/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 820,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418933381",
    "pull_request_review_id": 404509129,
    "id": 418933381,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzMzM4MQ==",
    "diff_hunk": "@@ -782,6 +791,9 @@ CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n         // MAC check was successful\n         valid_checksum = true;\n \n+        // count bytes we decrypted including MAC tag + AD",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 20,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "You should precise in BIP that we account only after a successful decryption. Also the accounting data scope on MAC+AEAD.",
    "created_at": "2020-05-02T08:56:32Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418933381",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418933381"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418933381"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418933381/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 797,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418934931",
    "pull_request_review_id": 404509129,
    "id": 418934931,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzNDkzMQ==",
    "diff_hunk": "@@ -703,21 +703,36 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer",
    "path": "src/net.h",
    "position": null,
    "original_position": 10,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "You should precise in BIP that a rekey initiator should be conservative but rekey responder liberal in its window acceptance.",
    "created_at": "2020-05-02T09:14:08Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418934931",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418934931"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418934931"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418934931/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 833,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418936652",
    "pull_request_review_id": 404509129,
    "id": 418936652,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzNjY1Mg==",
    "diff_hunk": "@@ -731,6 +897,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID or (eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow separate buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + CHACHA20_POLY1305_AEAD_TAG_LEN, 0);\n+\n+    // length is only allowed up to 2^23 (bit24 is used for indicating rekey)\n+    bool bit24 = msg.data[2] & (1u << 7);\n+    assert(!bit24);\n+\n+    // check if we should rekey after this message\n+    const int64_t now = GetTime(); //TODO: check how expansive the GetTime call is and if it is avoidable",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 235,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "If you want to avoid a syscall in hot path, I think you can fetch time only X messages, its okay to be a bit late, for time responder only check if rekey initiator is too early.",
    "created_at": "2020-05-02T09:33:40Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418936652",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418936652"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418936652"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418936652/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1020,
    "side": "RIGHT",
    "in_reply_to_id": 418521589
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418937474",
    "pull_request_review_id": 404509129,
    "id": 418937474,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzNzQ3NA==",
    "diff_hunk": "@@ -703,21 +703,36 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h",
    "path": "src/net.h",
    "position": null,
    "original_position": 6,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I don't know about relying on timeclock for rekey. I know it comes from SSH recommendation but it's a client-server architecture, where a connection closing due to clock not being synchronized isn't dramatic. \r\n\r\nI'm worried about some clock manipulation to interfere with outbound connections and start some eclipse escalation. Current timedata (bug) logic seems to prevent any exploitation by third-party peers but I wouldn't add that much another assumption on your local clock. NTP attacks have been studied (http://www.cs.bu.edu/~goldbe/papers/NTPattack.pdf), where targeting bitcoin nodes was explicitly quoted...",
    "created_at": "2020-05-02T09:42:05Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418937474",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418937474"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418937474"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418937474/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 829,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418939510",
    "pull_request_review_id": 404515973,
    "id": 418939510,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODkzOTUxMA==",
    "diff_hunk": "@@ -834,6 +846,37 @@ CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     msg.m_message_size = msg.m_recv.size();                                                                    //message payload size (excluding command)\n     msg.m_raw_message_size = CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN; // raw wire size\n \n+    const int64_t now = GetTime();\n+    if (m_rekey_flag) {\n+        if (!gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) && (m_time_last_rekey + MIN_REKEY_TIME > now)) {\n+            // remote peer was not respecting the mininal rekey time (DoS)\n+            LogPrint(BCLog::NET, \"Invalid rekey (DoS)\\n\");\n+            msg.m_valid_checksum = false;\n+            msg.m_valid_header = false;\n+        } else {\n+            // make sure we rekey at this point, next message is supposed to be encrypted with the new key\n+            CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k1.data(), m_aead_k1.size()).Finalize(m_aead_k1.data());\n+            CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k2.data(), m_aead_k2.size()).Finalize(m_aead_k2.data());\n+\n+            // reset the AEAD context\n+            m_aead.reset(new ChaCha20Poly1305AEAD(m_aead_k1.data(), m_aead_k1.size(), m_aead_k2.data(), m_aead_k2.size()));\n+            LogPrint(BCLog::NET, \"Rekey: new recv keys (%s, %s)\\n\", HexStr(m_aead_k1), HexStr(m_aead_k2));\n+\n+            // reset sequence numbers\n+            m_payload_seqnr = 0;\n+            m_aad_seqnr = 0;\n+            m_aad_pos = 0;\n+            m_bytes_decrypted = 0;\n+            m_time_last_rekey = now;\n+        }\n+    } else if (m_bytes_decrypted > REKEY_ABORT_LIMIT_BYTES || now - m_time_last_rekey > REKEY_ABORT_LIMIT_TIME ||\n+               (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) && m_bytes_decrypted > 64 * 1024)) {\n+        // don't further decrypt and therefore abort connection when counterparty failed to respect rekey limits",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 55,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Where do we abort connection based on invalid checksum and header? It's only checked in `ProcessMessages` but doesn't trigger a connection AFAICT?",
    "created_at": "2020-05-02T10:02:52Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418939510",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418939510"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r418939510"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/418939510/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 950,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419076027",
    "pull_request_review_id": 404599425,
    "id": 419076027,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTA3NjAyNw==",
    "diff_hunk": "@@ -199,3 +199,127 @@ const std::vector<std::string> &getAllNetMessageTypes()\n {\n     return allNetMessageTypesVec;\n }\n+\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FILTERLOAD) {\n+        return NetMsgType::FILTERLOAD_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETADDR) {\n+        return NetMsgType::GETADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETBLOCKS) {\n+        return NetMsgType::GETBLOCKS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::GETBLOCKTXN) {\n+        return NetMsgType::GETBLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETDATA) {\n+        return NetMsgType::GETDATA_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETHEADERS) {\n+        return NetMsgType::GETHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::HEADERS) {\n+        return NetMsgType::HEADERS_SHORT_ID;\n+    } else if (cmd == NetMsgType::INV) {\n+        return NetMsgType::INV_SHORT_ID;\n+    } else if (cmd == NetMsgType::MEMPOOL) {\n+        return NetMsgType::MEMPOOL_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::MERKLEBLOCK) {\n+        return NetMsgType::MERKLEBLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::NOTFOUND) {\n+        return NetMsgType::NOTFOUND_SHORT_ID;\n+    } else if (cmd == NetMsgType::PING) {\n+        return NetMsgType::PING_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::PONG) {\n+        return NetMsgType::PONG_SHORT_ID;\n+    } else if (cmd == NetMsgType::SENDCMPCT) {\n+        return NetMsgType::SENDCMPCT_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::SENDHEADERS) {\n+        return NetMsgType::SENDHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::TX) {\n+        return NetMsgType::TX_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERACK) {\n+        return NetMsgType::VERACK_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERSION) {\n+        return NetMsgType::VERSION_SHORT_ID;\n+        ;\n+    }\n+    return 0; //no short command\n+}\n+\n+bool GetCommandFromShortCommandID(uint8_t shortID, std::string& cmd)\n+{\n+    if (shortID == NetMsgType::ADDR_SHORT_ID) {",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 73,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "elichai",
      "id": 2167860,
      "node_id": "MDQ6VXNlcjIxNjc4NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2167860?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/elichai",
      "html_url": "https://github.com/elichai",
      "followers_url": "https://api.github.com/users/elichai/followers",
      "following_url": "https://api.github.com/users/elichai/following{/other_user}",
      "gists_url": "https://api.github.com/users/elichai/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/elichai/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/elichai/subscriptions",
      "organizations_url": "https://api.github.com/users/elichai/orgs",
      "repos_url": "https://api.github.com/users/elichai/repos",
      "events_url": "https://api.github.com/users/elichai/events{/privacy}",
      "received_events_url": "https://api.github.com/users/elichai/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I agree that a switch statement is easier to read(and see what's missing if we'll have more `NetMsgType` types)",
    "created_at": "2020-05-03T09:33:24Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r419076027",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419076027"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r419076027"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/419076027/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 318,
    "side": "RIGHT",
    "in_reply_to_id": 407265992
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420895865",
    "pull_request_review_id": 406745702,
    "id": 420895865,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg5NTg2NQ==",
    "diff_hunk": "@@ -199,3 +199,127 @@ const std::vector<std::string> &getAllNetMessageTypes()\n {\n     return allNetMessageTypesVec;\n }\n+\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FILTERLOAD) {\n+        return NetMsgType::FILTERLOAD_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETADDR) {\n+        return NetMsgType::GETADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETBLOCKS) {\n+        return NetMsgType::GETBLOCKS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::GETBLOCKTXN) {\n+        return NetMsgType::GETBLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETDATA) {\n+        return NetMsgType::GETDATA_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETHEADERS) {\n+        return NetMsgType::GETHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::HEADERS) {\n+        return NetMsgType::HEADERS_SHORT_ID;\n+    } else if (cmd == NetMsgType::INV) {\n+        return NetMsgType::INV_SHORT_ID;\n+    } else if (cmd == NetMsgType::MEMPOOL) {\n+        return NetMsgType::MEMPOOL_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::MERKLEBLOCK) {\n+        return NetMsgType::MERKLEBLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::NOTFOUND) {\n+        return NetMsgType::NOTFOUND_SHORT_ID;\n+    } else if (cmd == NetMsgType::PING) {\n+        return NetMsgType::PING_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::PONG) {\n+        return NetMsgType::PONG_SHORT_ID;\n+    } else if (cmd == NetMsgType::SENDCMPCT) {\n+        return NetMsgType::SENDCMPCT_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::SENDHEADERS) {\n+        return NetMsgType::SENDHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::TX) {\n+        return NetMsgType::TX_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERACK) {\n+        return NetMsgType::VERACK_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERSION) {\n+        return NetMsgType::VERSION_SHORT_ID;\n+        ;\n+    }\n+    return 0; //no short command\n+}\n+\n+bool GetCommandFromShortCommandID(uint8_t shortID, std::string& cmd)\n+{\n+    if (shortID == NetMsgType::ADDR_SHORT_ID) {",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 73,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Seems to be a matter of taste. I'd like to keep it as is.",
    "created_at": "2020-05-06T15:45:27Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420895865",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420895865"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420895865"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420895865/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 318,
    "side": "RIGHT",
    "in_reply_to_id": 407265992
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420897941",
    "pull_request_review_id": 406748361,
    "id": 420897941,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg5Nzk0MQ==",
    "diff_hunk": "@@ -216,29 +237,44 @@ extern const char *FEEFILTER;\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *SENDCMPCT;\n+constexpr uint8_t SENDCMPCT_SHORT_ID = 34;\n /**\n  * Contains a CBlockHeaderAndShortTxIDs object - providing a header and\n  * list of \"short txids\".\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *CMPCTBLOCK;\n+constexpr uint8_t CMPCTBLOCK_SHORT_ID = 16;\n /**\n  * Contains a BlockTransactionsRequest\n  * Peer should respond with \"blocktxn\" message.\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *GETBLOCKTXN;\n+constexpr uint8_t GETBLOCKTXN_SHORT_ID = 23;\n /**\n  * Contains a BlockTransactions.\n  * Sent in response to a \"getblocktxn\" message.\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *BLOCKTXN;\n+constexpr uint8_t BLOCKTXN_SHORT_ID = 15;\n };\n \n /* Get a vector of all valid message types (see above) */\n const std::vector<std::string> &getAllNetMessageTypes();\n \n+// Short Command IDs are a low bandwidth representations of a message type\n+// The mapping is a peer to peer agreement",
    "path": "src/protocol.h",
    "position": null,
    "original_position": 187,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "caa6c582f415dd7ac2fdd2bafae7c896d4e05239",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This is probably a discussion that belong to the BIP rather to the implementation. I guess there are multiple ways how peers want to agree on a mapping (protocol version, dedicated command exchange, versionstring, port, etc.).",
    "created_at": "2020-05-06T15:48:23Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420897941",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420897941"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420897941"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420897941/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 257,
    "side": "RIGHT",
    "in_reply_to_id": 417797877
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420900793",
    "pull_request_review_id": 406752035,
    "id": 420900793,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwMDc5Mw==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 31,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "BIP discussion. The length is covered by the MAC.",
    "created_at": "2020-05-06T15:52:22Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420900793",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420900793"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420900793"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420900793/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 784,
    "side": "RIGHT",
    "in_reply_to_id": 417829120
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420903105",
    "pull_request_review_id": 406754989,
    "id": 420903105,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwMzEwNQ==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 73,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "What is the problem of increasing the sequence number if decryption fails? We detect it and can respond (disconnecting) on the layer above the transport.",
    "created_at": "2020-05-06T15:55:31Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420903105",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420903105"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420903105"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420903105/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 806,
    "side": "RIGHT",
    "in_reply_to_id": 417842245
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420904274",
    "pull_request_review_id": 406756426,
    "id": 420904274,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwNDI3NA==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);",
    "path": "src/net.cpp",
    "position": 83,
    "original_position": 83,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes. `m_aead->Crypt` would fail. This is an additional assertion to make sure the code below survives changes of the crypto system.",
    "created_at": "2020-05-06T15:56:54Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420904274",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420904274"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420904274"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420904274/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 835,
    "original_line": 835,
    "side": "RIGHT",
    "in_reply_to_id": 417845830
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420905957",
    "pull_request_review_id": 406758586,
    "id": 420905957,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwNTk1Nw==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= 12 && vRecv.size() >= size_or_shortid) {\n+            // string command\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID\n+        if (!valid_header && size_or_shortid >= 0) {\n+            valid_header = true;\n+            if (!GetCommandFromShortCommandID(size_or_shortid, command_name)) {\n+                // unknown-short-id\n+                //  results in a valid but unknown message (will be skipped)\n+                command_name = \"unknown-\" + ToString(size_or_shortid);\n+            }\n+        }\n+    }\n+    // increase the aad_pos and eventually the sequence number\n+    m_aad_pos += CHACHA20_POLY1305_AEAD_AAD_LEN;\n+    if (m_aad_pos + CHACHA20_POLY1305_AEAD_AAD_LEN > CHACHA20_ROUND_OUTPUT) {\n+        m_aad_pos = 0;\n+        m_aad_seqnr++;\n+    }\n+    // increase the payload sequence number by 1\n+    m_payload_seqnr++;\n+\n+    // decompose a single CNetMessage from the TransportDeserializer\n+    CNetMessage msg(std::move(vRecv)); // result in a message with CDataStream with readpos pointing to the message payload\n+    msg.m_command = command_name;\n+\n+    // store state about valid header, netmagic and checksum\n+    msg.m_valid_header = valid_header; // not relevant for v2, always pass\n+    msg.m_valid_checksum = valid_checksum;",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 127,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`msg.m_valid_checksum` is a field we should populate to respect the abstract `TransportDeserializer` class.\r\nIn the v2 case, the `checksum` is the MAC. We set the field whenever the MAC has validated. How to deal with it is a matter of the layer above.",
    "created_at": "2020-05-06T15:59:05Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420905957",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420905957"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420905957"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420905957/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 865,
    "side": "RIGHT",
    "in_reply_to_id": 417854354
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420909099",
    "pull_request_review_id": 406762585,
    "id": 420909099,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwOTA5OQ==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= 12 && vRecv.size() >= size_or_shortid) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 94,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Fair point. Added a comment.",
    "created_at": "2020-05-06T16:03:19Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420909099",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420909099"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420909099"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420909099/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 797,
    "side": "RIGHT",
    "in_reply_to_id": 417856950
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420909232",
    "pull_request_review_id": 406762784,
    "id": 420909232,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwOTIzMg==",
    "diff_hunk": "@@ -701,6 +703,53 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+class V2TransportDeserializer : public TransportDeserializer",
    "path": "src/net.h",
    "position": null,
    "original_position": 15,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Added",
    "created_at": "2020-05-06T16:03:32Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420909232",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420909232"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420909232"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420909232/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 837,
    "side": "RIGHT",
    "in_reply_to_id": 417801470
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420909652",
    "pull_request_review_id": 406763302,
    "id": 420909652,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkwOTY1Mg==",
    "diff_hunk": "@@ -701,6 +703,69 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS\n+\n+class V2TransportDeserializer : public TransportDeserializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_decrypted = 0; // counter of bytes decrypted under the same key\n+    int64_t m_time_last_rekey = 0;\n+    uint256 m_session_id;           // the encryption session_id, relevant for rekeying\n+    uint64_t m_payload_seqnr = 0;   // sequence number for the payload\n+    uint64_t m_aad_seqnr = 0;       // sequence number for the packet length (AD)\n+    int m_aad_pos = 0;              // position in the aad keystream\n+    bool m_in_data = false;         // parsing header (false) or data (true)\n+    uint32_t m_message_size = 0;    // expected message size\n+    CDataStream vRecv;              // received message data\n+    unsigned int m_hdr_pos = 0;     // read pos in header\n+    unsigned int m_data_pos = 0;    // read pos in data\n+    bool m_rekey_flag = false;      // rekey in message detected\n+\n+public:\n+    V2TransportDeserializer(const CPrivKey& k1, const CPrivKey& k2, const uint256& session_id) : m_aead(new ChaCha20Poly1305AEAD(k1.data(), k1.size(), k2.data(), k2.size())), m_aead_k1(k1), m_aead_k2(k2), m_time_last_rekey(GetTime()), m_session_id(session_id), vRecv(SER_NETWORK, INIT_PROTO_VERSION)",
    "path": "src/net.h",
    "position": null,
    "original_position": 44,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "AFAIK clang-format \"approved\" (not changed) this.",
    "created_at": "2020-05-06T16:04:05Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420909652",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420909652"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420909652"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420909652/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 778,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420911232",
    "pull_request_review_id": 406765377,
    "id": 420911232,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkxMTIzMg==",
    "diff_hunk": "@@ -718,6 +720,170 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 22,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I guess this evolved from legacy code with the focus to keep the diff small (V1 deserialiser has the `in_data` boolean). I'd say: lets keep it for consistency (better readability if one compared both deserializers).",
    "created_at": "2020-05-06T16:06:27Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420911232",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420911232"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420911232"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420911232/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 775,
    "side": "RIGHT",
    "in_reply_to_id": 418216979
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420912183",
    "pull_request_review_id": 406766609,
    "id": 420912183,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkxMjE4Mw==",
    "diff_hunk": "@@ -718,6 +720,170 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 60,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Good point. Added.",
    "created_at": "2020-05-06T16:07:52Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420912183",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420912183"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420912183"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420912183/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 805,
    "side": "RIGHT",
    "in_reply_to_id": 418215753
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420926437",
    "pull_request_review_id": 406784634,
    "id": 420926437,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkyNjQzNw==",
    "diff_hunk": "@@ -718,6 +720,170 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 52,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I agree that this would be a nice cleanup. But it should also be done for the V1 deserializer. I think we should do that after this PR since it contains lines not changes otherwise.",
    "created_at": "2020-05-06T16:29:03Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420926437",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420926437"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420926437"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420926437/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 796,
    "side": "RIGHT",
    "in_reply_to_id": 418223280
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420927923",
    "pull_request_review_id": 406786472,
    "id": 420927923,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkyNzkyMw==",
    "diff_hunk": "@@ -216,29 +237,44 @@ extern const char *FEEFILTER;\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *SENDCMPCT;\n+constexpr uint8_t SENDCMPCT_SHORT_ID = 34;\n /**\n  * Contains a CBlockHeaderAndShortTxIDs object - providing a header and\n  * list of \"short txids\".\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *CMPCTBLOCK;\n+constexpr uint8_t CMPCTBLOCK_SHORT_ID = 16;\n /**\n  * Contains a BlockTransactionsRequest\n  * Peer should respond with \"blocktxn\" message.\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *GETBLOCKTXN;\n+constexpr uint8_t GETBLOCKTXN_SHORT_ID = 23;\n /**\n  * Contains a BlockTransactions.\n  * Sent in response to a \"getblocktxn\" message.\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *BLOCKTXN;\n+constexpr uint8_t BLOCKTXN_SHORT_ID = 15;\n };\n \n /* Get a vector of all valid message types (see above) */\n const std::vector<std::string> &getAllNetMessageTypes();\n \n+// Short Command IDs are a low bandwidth representations of a message type\n+// The mapping is a peer to peer agreement\n+\n+// returns the short command ID for a command\n+// returns 0 if no short command ID has been found\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd);",
    "path": "src/protocol.h",
    "position": null,
    "original_position": 191,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Absolutely. Changed now.",
    "created_at": "2020-05-06T16:31:14Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420927923",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420927923"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420927923"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420927923/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 272,
    "side": "RIGHT",
    "in_reply_to_id": 418316264
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420930331",
    "pull_request_review_id": 406789477,
    "id": 420930331,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDkzMDMzMQ==",
    "diff_hunk": "@@ -731,6 +897,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars",
    "path": "src/net.cpp",
    "position": 144,
    "original_position": 198,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Good point. Changed.",
    "created_at": "2020-05-06T16:34:38Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420930331",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420930331"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420930331"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420930331/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 896,
    "original_line": 896,
    "side": "RIGHT",
    "in_reply_to_id": 418323240
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420983720",
    "pull_request_review_id": 406855214,
    "id": 420983720,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk4MzcyMA==",
    "diff_hunk": "@@ -731,6 +897,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID or (eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow separate buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + CHACHA20_POLY1305_AEAD_TAG_LEN, 0);",
    "path": "src/net.cpp",
    "position": 174,
    "original_position": 228,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Can you give me a rational why resize before insert would be better?",
    "created_at": "2020-05-06T17:56:54Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420983720",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420983720"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420983720"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420983720/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 926,
    "original_line": 926,
    "side": "RIGHT",
    "in_reply_to_id": 418928926
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420984895",
    "pull_request_review_id": 406856577,
    "id": 420984895,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk4NDg5NQ==",
    "diff_hunk": "@@ -741,6 +741,15 @@ int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n             return -1;\n         }\n \n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Could be my bad English. What I mean with that comment is that the rekey signals that \"after\" this message (the next message and all following), a new key will be used.",
    "created_at": "2020-05-06T17:58:42Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420984895",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420984895"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420984895"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420984895/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 816,
    "side": "RIGHT",
    "in_reply_to_id": 418932760
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420990022",
    "pull_request_review_id": 406862776,
    "id": 420990022,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5MDAyMg==",
    "diff_hunk": "@@ -782,6 +791,9 @@ CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n         // MAC check was successful\n         valid_checksum = true;\n \n+        // count bytes we decrypted including MAC tag + AD",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 20,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This is a very good point.\r\nI think the BIP is correct about the \"data sent\" (every byte on the wire). But I think the implementation is wrong in the way that it doesn't count messages with invalid headers,... which might be exploitable. I'll work on that.",
    "created_at": "2020-05-06T18:06:52Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420990022",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420990022"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420990022"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420990022/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 797,
    "side": "RIGHT",
    "in_reply_to_id": 418933381
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420990519",
    "pull_request_review_id": 406863406,
    "id": 420990519,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5MDUxOQ==",
    "diff_hunk": "@@ -703,21 +703,36 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer",
    "path": "src/net.h",
    "position": null,
    "original_position": 10,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes. That could help.",
    "created_at": "2020-05-06T18:07:39Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420990519",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420990519"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420990519"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420990519/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 833,
    "side": "RIGHT",
    "in_reply_to_id": 418934931
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420991902",
    "pull_request_review_id": 406865133,
    "id": 420991902,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5MTkwMg==",
    "diff_hunk": "@@ -834,6 +846,37 @@ CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     msg.m_message_size = msg.m_recv.size();                                                                    //message payload size (excluding command)\n     msg.m_raw_message_size = CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN; // raw wire size\n \n+    const int64_t now = GetTime();\n+    if (m_rekey_flag) {\n+        if (!gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) && (m_time_last_rekey + MIN_REKEY_TIME > now)) {\n+            // remote peer was not respecting the mininal rekey time (DoS)\n+            LogPrint(BCLog::NET, \"Invalid rekey (DoS)\\n\");\n+            msg.m_valid_checksum = false;\n+            msg.m_valid_header = false;\n+        } else {\n+            // make sure we rekey at this point, next message is supposed to be encrypted with the new key\n+            CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k1.data(), m_aead_k1.size()).Finalize(m_aead_k1.data());\n+            CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k2.data(), m_aead_k2.size()).Finalize(m_aead_k2.data());\n+\n+            // reset the AEAD context\n+            m_aead.reset(new ChaCha20Poly1305AEAD(m_aead_k1.data(), m_aead_k1.size(), m_aead_k2.data(), m_aead_k2.size()));\n+            LogPrint(BCLog::NET, \"Rekey: new recv keys (%s, %s)\\n\", HexStr(m_aead_k1), HexStr(m_aead_k2));\n+\n+            // reset sequence numbers\n+            m_payload_seqnr = 0;\n+            m_aad_seqnr = 0;\n+            m_aad_pos = 0;\n+            m_bytes_decrypted = 0;\n+            m_time_last_rekey = now;\n+        }\n+    } else if (m_bytes_decrypted > REKEY_ABORT_LIMIT_BYTES || now - m_time_last_rekey > REKEY_ABORT_LIMIT_TIME ||\n+               (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) && m_bytes_decrypted > 64 * 1024)) {\n+        // don't further decrypt and therefore abort connection when counterparty failed to respect rekey limits",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 55,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes. We don't right now as this is currently identical to V1 (where we don't disconnect if a message has an invalid header or an invalid SHA256 checksum).\r\nSee #15206 and #15197.",
    "created_at": "2020-05-06T18:10:07Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420991902",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420991902"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420991902"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420991902/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 950,
    "side": "RIGHT",
    "in_reply_to_id": 418939510
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420992578",
    "pull_request_review_id": 406865939,
    "id": 420992578,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk5MjU3OA==",
    "diff_hunk": "@@ -703,21 +703,36 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h",
    "path": "src/net.h",
    "position": null,
    "original_position": 6,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This is a valid point...\r\nwould you be interested to analyse attack possibilities?\r\nand what would you suggest? Dropping the time based limit?",
    "created_at": "2020-05-06T18:11:14Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420992578",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420992578"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r420992578"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/420992578/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 829,
    "side": "RIGHT",
    "in_reply_to_id": 418937474
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421027923",
    "pull_request_review_id": 406908861,
    "id": 421027923,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAyNzkyMw==",
    "diff_hunk": "@@ -741,6 +741,15 @@ int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n             return -1;\n         }\n \n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "perhaps \"the counterparty can signal a post-message re-key, e.g. after this message a new key will be used, by setting the\"",
    "created_at": "2020-05-06T19:09:43Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421027923",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421027923"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421027923"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421027923/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 816,
    "side": "RIGHT",
    "in_reply_to_id": 418932760
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421962534",
    "pull_request_review_id": 408022623,
    "id": 421962534,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk2MjUzNA==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 36,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I agree it's good for now as an assumption. I think in the future there is valid use-cases where you want to send bitcoin traffic over some non-ordered communication channels like headers-over-radio and still benefit of encryption.",
    "created_at": "2020-05-08T06:22:50Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421962534",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421962534"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421962534"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421962534/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 789,
    "side": "RIGHT",
    "in_reply_to_id": 417833895
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421963177",
    "pull_request_review_id": 408023351,
    "id": 421963177,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk2MzE3Nw==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 73,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Right, decryption failure is fatal, there is no such ban-per-point in this case.",
    "created_at": "2020-05-08T06:24:29Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421963177",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421963177"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421963177"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421963177/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 806,
    "side": "RIGHT",
    "in_reply_to_id": 417842245
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421964401",
    "pull_request_review_id": 408024727,
    "id": 421964401,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk2NDQwMQ==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= 12 && vRecv.size() >= size_or_shortid) {\n+            // string command\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID\n+        if (!valid_header && size_or_shortid >= 0) {\n+            valid_header = true;\n+            if (!GetCommandFromShortCommandID(size_or_shortid, command_name)) {\n+                // unknown-short-id\n+                //  results in a valid but unknown message (will be skipped)",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 107,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Right can we tolerate them, i,e not disconnecting peer and still drop them? We won't be able to process them anyway.",
    "created_at": "2020-05-08T06:27:41Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421964401",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421964401"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421964401"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421964401/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 845,
    "side": "RIGHT",
    "in_reply_to_id": 417855756
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421968517",
    "pull_request_review_id": 408029155,
    "id": 421968517,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk2ODUxNw==",
    "diff_hunk": "@@ -731,6 +897,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= 12);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID or (eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow separate buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + CHACHA20_POLY1305_AEAD_TAG_LEN, 0);",
    "path": "src/net.cpp",
    "position": 174,
    "original_position": 228,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d9081b32a36135c4fe10838cbfc181fb410f7a9a",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "At `std::vector::insert`, if `msg.data` capacity isn't enough an allocation is realized. Then at `std::vector::resize`, if capacity is too short again, a newer allocation is realized and a memcopy processed. You avoid one memory allocator call which may trigger a syscall in worst-case scenario ?",
    "created_at": "2020-05-08T06:37:43Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421968517",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421968517"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421968517"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421968517/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 926,
    "original_line": 926,
    "side": "RIGHT",
    "in_reply_to_id": 418928926
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421969270",
    "pull_request_review_id": 408029978,
    "id": 421969270,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk2OTI3MA==",
    "diff_hunk": "@@ -741,6 +741,15 @@ int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n             return -1;\n         }\n \n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Or perhaps \"the counterparty can signal a re-key, after this message a new key will be used, by setting the\"?",
    "created_at": "2020-05-08T06:39:33Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421969270",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421969270"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421969270"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421969270/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 816,
    "side": "RIGHT",
    "in_reply_to_id": 418932760
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421970415",
    "pull_request_review_id": 408031266,
    "id": 421970415,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk3MDQxNQ==",
    "diff_hunk": "@@ -834,6 +846,37 @@ CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     msg.m_message_size = msg.m_recv.size();                                                                    //message payload size (excluding command)\n     msg.m_raw_message_size = CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN; // raw wire size\n \n+    const int64_t now = GetTime();\n+    if (m_rekey_flag) {\n+        if (!gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) && (m_time_last_rekey + MIN_REKEY_TIME > now)) {\n+            // remote peer was not respecting the mininal rekey time (DoS)\n+            LogPrint(BCLog::NET, \"Invalid rekey (DoS)\\n\");\n+            msg.m_valid_checksum = false;\n+            msg.m_valid_header = false;\n+        } else {\n+            // make sure we rekey at this point, next message is supposed to be encrypted with the new key\n+            CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k1.data(), m_aead_k1.size()).Finalize(m_aead_k1.data());\n+            CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k2.data(), m_aead_k2.size()).Finalize(m_aead_k2.data());\n+\n+            // reset the AEAD context\n+            m_aead.reset(new ChaCha20Poly1305AEAD(m_aead_k1.data(), m_aead_k1.size(), m_aead_k2.data(), m_aead_k2.size()));\n+            LogPrint(BCLog::NET, \"Rekey: new recv keys (%s, %s)\\n\", HexStr(m_aead_k1), HexStr(m_aead_k2));\n+\n+            // reset sequence numbers\n+            m_payload_seqnr = 0;\n+            m_aad_seqnr = 0;\n+            m_aad_pos = 0;\n+            m_bytes_decrypted = 0;\n+            m_time_last_rekey = now;\n+        }\n+    } else if (m_bytes_decrypted > REKEY_ABORT_LIMIT_BYTES || now - m_time_last_rekey > REKEY_ABORT_LIMIT_TIME ||\n+               (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) && m_bytes_decrypted > 64 * 1024)) {\n+        // don't further decrypt and therefore abort connection when counterparty failed to respect rekey limits",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 55,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks, will review them with context.",
    "created_at": "2020-05-08T06:42:25Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421970415",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421970415"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421970415"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421970415/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 950,
    "side": "RIGHT",
    "in_reply_to_id": 418939510
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421977423",
    "pull_request_review_id": 408039451,
    "id": 421977423,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTk3NzQyMw==",
    "diff_hunk": "@@ -703,21 +703,36 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h",
    "path": "src/net.h",
    "position": null,
    "original_position": 6,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes actually time-clock attacks has caught my attention while working on other thing so I'm already investigating this. May I come back to you soon on this and if I don't feel free to ping me ?\r\n\r\nAs a robust fix we can't rely on receiver-side tracking, like requiring we sent at least X bytes before a re-keying, I think there is protocol messages to triggering querying from us. And relying on block tip increase would be bad due to variance...",
    "created_at": "2020-05-08T06:59:24Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421977423",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421977423"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r421977423"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/421977423/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 829,
    "side": "RIGHT",
    "in_reply_to_id": 418937474
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422004967",
    "pull_request_review_id": 408071742,
    "id": 422004967,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjAwNDk2Nw==",
    "diff_hunk": "@@ -703,21 +703,36 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h",
    "path": "src/net.h",
    "position": null,
    "original_position": 6,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e04eddb397d613f4c4c53f2692d7dd74c165f64f",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thinking further, I would keep the timeclock for triggering a re-key but not checking at re-key acceptance. It would obtain the effect aimed, which it is renew key after 1h. A time-clock manipulation that way wouldn't be able to close connections, just triggering re-key ?\r\n\r\nAnd for a malicious connected peer, it would make the DoS-cpu vector the same that an attacker retrying and abandoning session, and we agreed in BIP discussion that's something we have to bear ?",
    "created_at": "2020-05-08T08:02:07Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r422004967",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422004967"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r422004967"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422004967/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 829,
    "side": "RIGHT",
    "in_reply_to_id": 418937474
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422523503",
    "pull_request_review_id": 408669537,
    "id": 422523503,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUyMzUwMw==",
    "diff_hunk": "@@ -718,6 +722,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 124,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "222d5334681c517636c933c9491200fbbabf3c8d",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit/note for follow-up:\r\n```diff\r\n-        // try for short ID in case the first byte is a number larger than 12\r\n+        // try for short ID in case the first byte is a number larger than NET_P2P_V2_CMD_MAX_CHARS_SIZE\r\n```",
    "created_at": "2020-05-09T17:31:42Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r422523503",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422523503"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r422523503"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/422523503/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 840,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424750339",
    "pull_request_review_id": 411323386,
    "id": 424750339,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDc1MDMzOQ==",
    "diff_hunk": "@@ -719,6 +723,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12\n+        if (!valid_header && size_or_shortid >= 0) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 125,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b9468fa767d1daa08924a9fefe5227b2f6688e53",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`size_or_shortid` is `uint8_t`. Since it is unsigned, `size_or_shortid >= 0` will always be true. Should this be `if (!valid_header && size_or_shortid > 0) {`?",
    "created_at": "2020-05-13T21:47:34Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r424750339",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424750339"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r424750339"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424750339/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 839,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424904659",
    "pull_request_review_id": 411505955,
    "id": 424904659,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDkwNDY1OQ==",
    "diff_hunk": "@@ -719,6 +723,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12\n+        if (!valid_header && size_or_shortid >= 0) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 125,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b9468fa767d1daa08924a9fefe5227b2f6688e53",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Not sure. If `size_or_shortid` is `0` (due to a `std::ios_base::failure` or if `vRecv` contain `0`), I'd like to enter this `if` to set `command_name` to `unknown-0`.\r\nOtherwise `command_name` would be unset for a size of `0` (which is somehow a undefined short-id).",
    "created_at": "2020-05-14T06:44:19Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r424904659",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424904659"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r424904659"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/424904659/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 839,
    "side": "RIGHT",
    "in_reply_to_id": 424750339
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425811823",
    "pull_request_review_id": 412662374,
    "id": 425811823,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgxMTgyMw==",
    "diff_hunk": "@@ -719,6 +723,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12\n+        if (!valid_header && size_or_shortid >= 0) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 125,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b9468fa767d1daa08924a9fefe5227b2f6688e53",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Ok, if I understand correctly:\r\n```diff\r\n-    bool valid_header = false;\r\n     std::string command_name;\r\n@@ -812,15 +811,12 @@ CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\r\n         }\r\n         if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\r\n             // first byte is a number between 1 and 12. Must be a string command.\r\n-            valid_header = true;\r\n \r\n             // use direct read since we already read the varlens size uint8_t\r\n             command_name.resize(size_or_shortid);\r\n             vRecv.read(&command_name[0], size_or_shortid);\r\n-        }\r\n-        // try for short ID in case the first byte is a number larger than 12\r\n-        if (!valid_header && size_or_shortid >= 0) {\r\n-            valid_header = true;\r\n+        } else if (size_or_shortid == 0 || size_or_shortid > NET_P2P_V2_CMD_MAX_CHARS_SIZE) {\r\n+            // // try for short ID in case the first byte is a number larger than NET_P2P_V2_CMD_MAX_CHARS_SIZE\r\n             if (!GetCommandFromShortCommandID(size_or_shortid, command_name)) {\r\n@@ -842,7 +838,7 @@ CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\r\n     msg.m_command = command_name;\r\n \r\n     // store state about valid header, netmagic and checksum\r\n-    msg.m_valid_header = valid_header; // not relevant for v2, always pass\r\n+    msg.m_valid_header = true ; // not relevant for v2, always pass\r\n```\r\n",
    "created_at": "2020-05-15T13:45:01Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r425811823",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425811823"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r425811823"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/425811823/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 839,
    "side": "RIGHT",
    "in_reply_to_id": 424750339
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426406735",
    "pull_request_review_id": 413317454,
    "id": 426406735,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQwNjczNQ==",
    "diff_hunk": "@@ -719,6 +723,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12\n+        if (!valid_header && size_or_shortid >= 0) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 125,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b9468fa767d1daa08924a9fefe5227b2f6688e53",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "What if the buffer contains a `0x09` as first bytes (a valid string based command with the size of 9 chars) but those 9 bytes would actually not follow? Wouldn't it become `valid_header=true` in your suggestions? ",
    "created_at": "2020-05-18T07:00:37Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r426406735",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426406735"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r426406735"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426406735/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 839,
    "side": "RIGHT",
    "in_reply_to_id": 424750339
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426701026",
    "pull_request_review_id": 413691857,
    "id": 426701026,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcwMTAyNg==",
    "diff_hunk": "@@ -719,6 +723,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12\n+        if (!valid_header && size_or_shortid >= 0) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 125,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b9468fa767d1daa08924a9fefe5227b2f6688e53",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Unless I'm confused, I think the suggestion above is still correct for the case you describe, assuming you want it to fail both of the conditional checks, and `net_tests` and the `p2p_v2_transport_deserializer` fuzzer both pass. \r\n\r\nIn the current code, it's not clear to me what purpose `valid_header` serves because it always becomes true at the latest by line 823.\r\n\r\nUnrelated, but it looks like short command IDs need to be added for the `GETCFCHECKPT` and `CFCHECKPT` BIP157 message types that were added in f9e00bb25ac and possibly soon for `GETCFHEADERS` and `GETCFFILTERS` as well.\r\n",
    "created_at": "2020-05-18T15:14:35Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r426701026",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426701026"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r426701026"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/426701026/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 839,
    "side": "RIGHT",
    "in_reply_to_id": 424750339
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440650990",
    "pull_request_review_id": 431242124,
    "id": 440650990,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDY1MDk5MA==",
    "diff_hunk": "@@ -11,6 +11,7 @@\n \n static constexpr int CHACHA20_POLY1305_AEAD_KEY_LEN = 32;\n static constexpr int CHACHA20_POLY1305_AEAD_AAD_LEN = 3; /* 3 bytes length */\n+static constexpr int CHACHA20_POLY1305_AEAD_TAG_LEN = 16; /* 16 bytes poly1305 tag */",
    "path": "src/crypto/chacha_poly_aead.h",
    "position": 10,
    "original_position": 4,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "poly1305 tag length of 16 bytes is already defined in https://github.com/bitcoin/bitcoin/blob/1c86ed41483471929840eec09b93d7de3a4aeacf/src/crypto/poly1305.h#L12\r\nIs it necessary to explicitly define it here again? ",
    "created_at": "2020-06-16T07:45:35Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440650990",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440650990"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440650990"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440650990/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 15,
    "original_line": 15,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440878852",
    "pull_request_review_id": 431242124,
    "id": 440878852,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg3ODg1Mg==",
    "diff_hunk": "@@ -725,6 +729,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 86,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "BIP324 removes the Message Magic bytes. Is `CMessageHeader::MessageStartChars` required here? ",
    "created_at": "2020-06-16T14:06:56Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440878852",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440878852"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440878852"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440878852/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 789,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440896136",
    "pull_request_review_id": 431242124,
    "id": 440896136,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5NjEzNg==",
    "diff_hunk": "@@ -725,6 +729,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 97,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Nit: Should be `MAC tag + AAD`? ",
    "created_at": "2020-06-16T14:30:04Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440896136",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440896136"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440896136"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440896136/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 811,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440897035",
    "pull_request_review_id": 431242124,
    "id": 440897035,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDg5NzAzNQ==",
    "diff_hunk": "@@ -725,6 +729,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 92,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Nit: should be `(even if decryption fails)`?",
    "created_at": "2020-06-16T14:31:11Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440897035",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440897035"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440897035"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440897035/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 806,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440956404",
    "pull_request_review_id": 431242124,
    "id": 440956404,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1NjQwNA==",
    "diff_hunk": "@@ -725,6 +729,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.",
    "path": "src/net.cpp",
    "position": 96,
    "original_position": 117,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Nit:\r\n```suggestion\r\n         // first byte is a number between 1 and 12. Must be a string command.\r\n        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\r\n```\r\nPutting the comment above the if statement seems more appropriate like it's done for short id. ",
    "created_at": "2020-06-16T15:47:28Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440956404",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440956404"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440956404"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440956404/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": 847,
    "original_start_line": 819,
    "start_side": "RIGHT",
    "line": 848,
    "original_line": 848,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440958678",
    "pull_request_review_id": 431242124,
    "id": 440958678,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk1ODY3OA==",
    "diff_hunk": "@@ -718,6 +722,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 124,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "222d5334681c517636c933c9491200fbbabf3c8d",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "IMO it feels easier to read if variables values are explicitly specified in comments. I tend to check variable values all the time when reading using the editor functionality. That goes away when it's in a comment.   \r\n\r\nThis is in regard to this  [comment](https://github.com/bitcoin/bitcoin/pull/18242/files#r422523503) in case git doesn't show it in its intended place. ",
    "created_at": "2020-06-16T15:50:30Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440958678",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440958678"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440958678"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440958678/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 840,
    "side": "RIGHT",
    "in_reply_to_id": 422523503
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440967503",
    "pull_request_review_id": 431242124,
    "id": 440967503,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDk2NzUwMw==",
    "diff_hunk": "@@ -725,6 +729,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12\n+        if (!valid_header && size_or_shortid >= 0) {\n+            valid_header = true;\n+            if (!GetCommandFromShortCommandID(size_or_shortid, command_name)) {\n+                // unknown-short-id\n+                //  results in a valid but unknown message (will be skipped)\n+                command_name = \"unknown-\" + ToString(size_or_shortid);\n+            }\n+        }\n+    }\n+    // increase the aad_pos and eventually the sequence number\n+    m_aad_pos += CHACHA20_POLY1305_AEAD_AAD_LEN;\n+    if (m_aad_pos + CHACHA20_POLY1305_AEAD_AAD_LEN > CHACHA20_ROUND_OUTPUT) {\n+        m_aad_pos = 0;\n+        m_aad_seqnr++;\n+    }\n+    // increase the payload sequence number by 1\n+    m_payload_seqnr++;\n+\n+    // decompose a single CNetMessage from the TransportDeserializer\n+    CNetMessage msg(std::move(vRecv)); // result in a message with CDataStream with readpos pointing to the message payload\n+    msg.m_command = command_name;\n+\n+    // store state about valid header, netmagic and checksum\n+    msg.m_valid_header = valid_header; // not relevant for v2, always pass\n+    msg.m_valid_checksum = valid_checksum;\n+    msg.m_valid_netmagic = true; // not relevant for v2, always pass\n+\n+    // if we could successfully decrypt the message, the message no longer contains the \"header\" (AAD & MAC)\n+    // if failed to decrypt \u2013 which we tolerate at this point \u2013 we need to reduce the message size by the length of the AD & MAC",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 153,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Nit: AAD",
    "created_at": "2020-06-16T16:02:44Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440967503",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440967503"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440967503"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/440967503/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 867,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441404966",
    "pull_request_review_id": 431242124,
    "id": 441404966,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwNDk2Ng==",
    "diff_hunk": "@@ -738,6 +909,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= NET_P2P_V2_CMD_MAX_CHARS_SIZE);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)",
    "path": "src/net.cpp",
    "position": 147,
    "original_position": 213,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Nit: AAD",
    "created_at": "2020-06-17T09:19:34Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441404966",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441404966"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441404966"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441404966/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 899,
    "original_line": 899,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441405885",
    "pull_request_review_id": 431242124,
    "id": 441405885,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQwNTg4NQ==",
    "diff_hunk": "@@ -738,6 +909,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= NET_P2P_V2_CMD_MAX_CHARS_SIZE);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 217,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Nit: AAD. \r\nAt this point, I am wondering if it's intentional, if it is then ignore. There are many more, Not commenting the same for the rests. ",
    "created_at": "2020-06-17T09:20:58Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441405885",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441405885"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441405885"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441405885/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 937,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441435792",
    "pull_request_review_id": 431242124,
    "id": 441435792,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQzNTc5Mg==",
    "diff_hunk": "@@ -738,6 +909,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= NET_P2P_V2_CMD_MAX_CHARS_SIZE);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID or (eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow separate buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + CHACHA20_POLY1305_AEAD_TAG_LEN, 0);\n+\n+    // length is only allowed up to 2^23 (bit24 is used for indicating rekey)\n+    bool bit24 = msg.data[2] & (1u << 7);\n+    assert(!bit24);\n+\n+    // check if we should rekey after this message\n+    const int64_t now = GetTime(); //TODO: check how expansive the GetTime call is and if it is avoidable\n+    bool rekey = false;\n+    if (m_bytes_encrypted >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 32 * 1024 : REKEY_LIMIT_BYTES) || now - m_time_last_rekey >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 10 : REKEY_LIMIT_TIME)) {\n+        LogPrint(BCLog::NET, \"Rekey limits reached, performing rekey.\\n\");\n+        msg.data[2] |= (1u << 7);\n+        rekey = true;\n+    }\n+\n+    // encrypt the payload, ignore return code since it can't fail in this case (controlled buffers, don't check the MAC during encrypting)\n+    m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, msg.data.data(), msg.data.size(), msg.data.data(), msg.data.size() - CHACHA20_POLY1305_AEAD_TAG_LEN, true);\n+\n+    // increase the aad_pos and eventually the sequence number\n+    m_aad_pos += CHACHA20_POLY1305_AEAD_AAD_LEN;\n+    if (m_aad_pos + CHACHA20_POLY1305_AEAD_AAD_LEN > CHACHA20_ROUND_OUTPUT) {\n+        m_aad_pos = 0;\n+        m_aad_seqnr++;\n+    }\n+    // increase the payload sequence number by 1\n+    m_payload_seqnr++;\n+\n+    m_bytes_encrypted += msg.data.size(); // count everything, MAC tag + AD\n+\n+    if (rekey) {\n+        // make sure we rekey at this point, next message needs to be encrypted with the new key\n+        CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k1.data(), m_aead_k1.size()).Finalize(m_aead_k1.data());\n+        CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k2.data(), m_aead_k2.size()).Finalize(m_aead_k2.data());\n+\n+        // reset the AEAD context\n+        m_aead.reset(new ChaCha20Poly1305AEAD(m_aead_k1.data(), m_aead_k1.size(), m_aead_k2.data(), m_aead_k2.size()));\n+        LogPrint(BCLog::NET, \"Rekey: new send keys (%s, %s)\\n\", HexStr(m_aead_k1), HexStr(m_aead_k2));\n+\n+        // reset the AEAD context\n+        m_aead.reset(new ChaCha20Poly1305AEAD(m_aead_k1.data(), m_aead_k1.size(), m_aead_k2.data(), m_aead_k2.size()));",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 279,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Why reset again? ",
    "created_at": "2020-06-17T10:09:49Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441435792",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441435792"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441435792"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441435792/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 987,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 999,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441445522",
    "pull_request_review_id": 431242124,
    "id": 441445522,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ0NTUyMg==",
    "diff_hunk": "@@ -738,6 +909,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)",
    "path": "src/net.cpp",
    "position": 137,
    "original_position": 203,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "it seems the `header` is redundant here? ",
    "created_at": "2020-06-17T10:27:36Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441445522",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441445522"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441445522"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441445522/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 889,
    "original_line": 889,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441468386",
    "pull_request_review_id": 431242124,
    "id": 441468386,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2ODM4Ng==",
    "diff_hunk": "@@ -725,6 +729,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12\n+        if (!valid_header && size_or_shortid >= 0) {\n+            valid_header = true;\n+            if (!GetCommandFromShortCommandID(size_or_shortid, command_name)) {\n+                // unknown-short-id\n+                //  results in a valid but unknown message (will be skipped)\n+                command_name = \"unknown-\" + ToString(size_or_shortid);\n+            }\n+        }\n+    }\n+    // increase the aad_pos and eventually the sequence number\n+    m_aad_pos += CHACHA20_POLY1305_AEAD_AAD_LEN;\n+    if (m_aad_pos + CHACHA20_POLY1305_AEAD_AAD_LEN > CHACHA20_ROUND_OUTPUT) {\n+        m_aad_pos = 0;\n+        m_aad_seqnr++;\n+    }\n+    // increase the payload sequence number by 1\n+    m_payload_seqnr++;\n+\n+    // decompose a single CNetMessage from the TransportDeserializer\n+    CNetMessage msg(std::move(vRecv)); // result in a message with CDataStream with readpos pointing to the message payload\n+    msg.m_command = command_name;\n+\n+    // store state about valid header, netmagic and checksum\n+    msg.m_valid_header = valid_header; // not relevant for v2, always pass\n+    msg.m_valid_checksum = valid_checksum;\n+    msg.m_valid_netmagic = true; // not relevant for v2, always pass\n+\n+    // if we could successfully decrypt the message, the message no longer contains the \"header\" (AAD & MAC)\n+    // if failed to decrypt \u2013 which we tolerate at this point \u2013 we need to reduce the message size by the length of the AD & MAC\n+    // to conform to the abstract TransportDeserializer protocol\n+    msg.m_message_size = valid_checksum ? msg.m_recv.size() : (msg.m_recv.size() - CHACHA20_POLY1305_AEAD_AAD_LEN - CHACHA20_POLY1305_AEAD_TAG_LEN);\n+    msg.m_raw_message_size = CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN; // raw wire size\n+\n+    const int64_t now = GetTime();\n+    if (m_rekey_flag) {\n+        if (!gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) && (m_time_last_rekey + MIN_REKEY_TIME > now)) {\n+            // remote peer was not respecting the mininal rekey time (DoS)\n+            LogPrint(BCLog::NET, \"Invalid rekey (DoS)\\n\");\n+            msg.m_valid_checksum = false;\n+            msg.m_valid_header = false;\n+        } else {\n+            // make sure we rekey at this point, next message is supposed to be encrypted with the new key\n+            CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k1.data(), m_aead_k1.size()).Finalize(m_aead_k1.data());\n+            CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k2.data(), m_aead_k2.size()).Finalize(m_aead_k2.data());\n+\n+            // reset the AEAD context\n+            m_aead.reset(new ChaCha20Poly1305AEAD(m_aead_k1.data(), m_aead_k1.size(), m_aead_k2.data(), m_aead_k2.size()));\n+            LogPrint(BCLog::NET, \"Rekey: new recv keys (%s, %s)\\n\", HexStr(m_aead_k1), HexStr(m_aead_k2));\n+\n+            // reset sequence numbers",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 174,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`//reset sequence numbers and key counters`? Or maybe add `//reset key counters` before last two? like done in `prepareForTransport`.",
    "created_at": "2020-06-17T11:13:35Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441468386",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441468386"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441468386"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441468386/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 941,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441475023",
    "pull_request_review_id": 431242124,
    "id": 441475023,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ3NTAyMw==",
    "diff_hunk": "@@ -738,6 +909,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= NET_P2P_V2_CMD_MAX_CHARS_SIZE);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID or (eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow separate buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + CHACHA20_POLY1305_AEAD_TAG_LEN, 0);\n+\n+    // length is only allowed up to 2^23 (bit24 is used for indicating rekey)\n+    bool bit24 = msg.data[2] & (1u << 7);\n+    assert(!bit24);\n+\n+    // check if we should rekey after this message\n+    const int64_t now = GetTime(); //TODO: check how expansive the GetTime call is and if it is avoidable\n+    bool rekey = false;\n+    if (m_bytes_encrypted >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 32 * 1024 : REKEY_LIMIT_BYTES) || now - m_time_last_rekey >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 10 : REKEY_LIMIT_TIME)) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 249,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "As per the comment on `net_tests.cpp` line 380\r\n\r\n>  // Setting the netencryptionfastrekey flag results in using a threshold of 64kb / 10 seconds for requiring a rekey\r\n\r\nHere `m_bytes_encrypted` is checked against 32 kb. Is this intentional? \r\nShould the BIP draft add `netencryptionfastrekey` policy for better reference?\r\nAlso whats the rationale behind fastrekey? ",
    "created_at": "2020-06-17T11:27:44Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441475023",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441475023"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441475023"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441475023/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1022,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441480135",
    "pull_request_review_id": 431242124,
    "id": 441480135,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ4MDEzNQ==",
    "diff_hunk": "@@ -698,6 +700,70 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS\n+\n+// V2TransportDeserializer is a transport deserializer after BIP324\n+class V2TransportDeserializer : public TransportDeserializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_decrypted = 0; // counter of bytes decrypted under the same key\n+    int64_t m_time_last_rekey = 0;",
    "path": "src/net.h",
    "position": null,
    "original_position": 32,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Suggested comment (in the spirit of the rest) `// recorded time when the last rekey happened`",
    "created_at": "2020-06-17T11:38:09Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441480135",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441480135"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441480135"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441480135/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 765,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441481441",
    "pull_request_review_id": 431242124,
    "id": 441481441,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ4MTQ0MQ==",
    "diff_hunk": "@@ -698,6 +700,70 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS\n+\n+// V2TransportDeserializer is a transport deserializer after BIP324\n+class V2TransportDeserializer : public TransportDeserializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_decrypted = 0; // counter of bytes decrypted under the same key\n+    int64_t m_time_last_rekey = 0;\n+    uint256 m_session_id;           // the encryption session_id, relevant for rekeying\n+    uint64_t m_payload_seqnr = 0;   // sequence number for the payload\n+    uint64_t m_aad_seqnr = 0;       // sequence number for the packet length (AD)\n+    int m_aad_pos = 0;              // position in the aad keystream\n+    bool m_in_data = false;         // parsing header (false) or data (true)\n+    uint32_t m_message_size = 0;    // expected message size\n+    CDataStream vRecv;              // received message data\n+    unsigned int m_hdr_pos = 0;     // read pos in header\n+    unsigned int m_data_pos = 0;    // read pos in data\n+    bool m_rekey_flag = false;      // rekey in message detected\n+\n+public:\n+    V2TransportDeserializer(const CPrivKey& k1, const CPrivKey& k2, const uint256& session_id) : m_aead(new ChaCha20Poly1305AEAD(k1.data(), k1.size(), k2.data(), k2.size())), m_aead_k1(k1), m_aead_k2(k2), m_time_last_rekey(GetTime()), m_session_id(session_id), vRecv(SER_NETWORK, INIT_PROTO_VERSION)\n+    {\n+        Reset();\n+    }\n+\n+    void Reset()\n+    {\n+        vRecv.clear();\n+        vRecv.resize(CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        m_in_data = false;\n+        m_hdr_pos = 0;\n+        m_message_size = 0;\n+        m_data_pos = 0;\n+        m_rekey_flag = false;\n+    }\n+    bool Complete() const\n+    {\n+        if (!m_in_data) {\n+            return false;\n+        }\n+        return (m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN == m_data_pos);\n+    }\n+    void SetVersion(int nVersionIn)\n+    {\n+        vRecv.SetVersion(nVersionIn);\n+    }\n+    bool OversizedMessageDetected() const",
    "path": "src/net.h",
    "position": null,
    "original_position": 71,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "We are already checking `m_message_size` against `MAX_SIZE` in `Read`. Here the check is happening against `MAX_PROTOCOL_MESSAGE_LENGTH`.\r\n1. `MAX_SIZE` = 33.5MB,  `MAX_PROTOCOL_MESSAGE_LENGTH` = 4MB. What does these two limits signify? \r\n2. if we are already checking for some size limit in `Read` why have a separate check here? So far  `OversizedMessageDetected` is not used anywhere. Any special plan for its existence? ",
    "created_at": "2020-06-17T11:40:44Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441481441",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441481441"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441481441"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441481441/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 804,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441493342",
    "pull_request_review_id": 431242124,
    "id": 441493342,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5MzM0Mg==",
    "diff_hunk": "@@ -712,6 +778,27 @@ class V1TransportSerializer  : public TransportSerializer {\n     void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) override;\n };\n \n+class V2TransportSerializer : public TransportSerializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for a later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_encrypted = 0; //counter of bytes encrypted with same key\n+    int64_t m_time_last_rekey = 0;\n+    uint256 m_session_id; // the encryption session_id, relevant for rekeying\n+    uint64_t m_payload_seqnr = 0;\n+    uint64_t m_aad_seqnr = 0;\n+    int m_aad_pos = 0;",
    "path": "src/net.h",
    "position": null,
    "original_position": 97,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Comments from `V2TransportDeserializer` can be copied here. ",
    "created_at": "2020-06-17T12:04:16Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441493342",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441493342"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441493342"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441493342/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 790,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 913,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441493700",
    "pull_request_review_id": 431242124,
    "id": 441493700,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5MzcwMA==",
    "diff_hunk": "@@ -712,6 +778,27 @@ class V1TransportSerializer  : public TransportSerializer {\n     void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) override;\n };\n \n+class V2TransportSerializer : public TransportSerializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for a later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_encrypted = 0; //counter of bytes encrypted with same key\n+    int64_t m_time_last_rekey = 0;",
    "path": "src/net.h",
    "position": null,
    "original_position": 93,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Same comment here from `V2TransportDeserializer` can help. ",
    "created_at": "2020-06-17T12:04:59Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441493700",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441493700"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441493700"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441493700/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 833,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441496441",
    "pull_request_review_id": 431242124,
    "id": 441496441,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NjQ0MQ==",
    "diff_hunk": "@@ -241,3 +241,126 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags)\n \n     return str_flags;\n }\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string& cmd)",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "A single comment specifying this is used for V2 messaging protocol as per BIP324 might help here. ",
    "created_at": "2020-06-17T12:10:27Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441496441",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441496441"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441496441"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441496441/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 250,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441502434",
    "pull_request_review_id": 431242124,
    "id": 441502434,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUwMjQzNA==",
    "diff_hunk": "@@ -266,6 +291,17 @@ extern const char* CFCHECKPT;\n /* Get a vector of all valid message types (see above) */\n const std::vector<std::string>& getAllNetMessageTypes();\n \n+// Short Command IDs are a low bandwidth representations of a message type\n+// The mapping is a peer to peer agreement",
    "path": "src/protocol.h",
    "position": null,
    "original_position": 189,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Is the mapping a p2p agreement at this point? It seems hardcoded. Which seems all right to me. Trying to have the mapping process here seems like going out of scope for this PR. Maybe a followup PR or even a BIP should be done? In that light maybe removing this comment here can help, or tagging it by a todo or something else? Can be confusing as its not implemented yet. ",
    "created_at": "2020-06-17T12:21:34Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441502434",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441502434"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441502434"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441502434/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 257,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441542048",
    "pull_request_review_id": 431242124,
    "id": 441542048,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU0MjA0OA==",
    "diff_hunk": "@@ -320,4 +322,161 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+size_t read_message(std::unique_ptr<TransportDeserializer>& deserializer, const std::vector<unsigned char>& serialized_header, const CSerializedNetMsg& msg)\n+{\n+    size_t read_bytes = 0;\n+    if (serialized_header.size() > 0) read_bytes += deserializer->Read((const char*)serialized_header.data(), serialized_header.size());\n+    //  second: read the encrypted payload (if required)\n+    if (msg.data.size() > 0) read_bytes += deserializer->Read((const char*)msg.data.data(), msg.data.size());\n+    if (msg.data.size() > read_bytes && msg.data.size() - read_bytes > 0) read_bytes += deserializer->Read((const char*)msg.data.data() + read_bytes, msg.data.size() - read_bytes);\n+    return read_bytes;\n+}\n+\n+// use 32 bytey keys with all zeros\n+static const CPrivKey k1(32, 0);\n+static const CPrivKey k2(32, 0);\n+static const uint256 session_id;\n+\n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs)\n+{\n+    // construct the serializers\n+    std::unique_ptr<TransportSerializer> serializer;\n+    std::unique_ptr<TransportDeserializer> deserializer;\n+\n+    if (v2) {\n+        serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2, session_id));\n+        deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(k1, k2, session_id));\n+    } else {\n+        serializer = MakeUnique<V1TransportSerializer>(V1TransportSerializer());\n+        deserializer = MakeUnique<V1TransportDeserializer>(V1TransportDeserializer(Params().MessageStart(), SER_NETWORK, INIT_PROTO_VERSION));\n+    }\n+    // run a couple of times through all messages with the same AEAD instance\n+    for (unsigned int i = 0; i < 100; i++) {\n+        for (const CSerializedNetMsg& msg_orig : test_msgs) {\n+            // bypass the copy protection\n+            CSerializedNetMsg msg;\n+            msg.data = msg_orig.data;\n+            msg.command = msg_orig.command;\n+            size_t raw_msg_size = msg.data.size();\n+\n+            std::vector<unsigned char> serialized_header;\n+            serializer->prepareForTransport(msg, serialized_header);",
    "path": "src/test/net_tests.cpp",
    "position": 39,
    "original_position": 55,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "It seems it is intended here that serialized header will be returned into the `serialized_header`? But `prepareForTransport` doesn't assign the serialized header into the `header` arguement. Not sure what is happening here. ",
    "created_at": "2020-06-17T13:25:03Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441542048",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441542048"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441542048"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441542048/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": 959,
    "original_start_line": 362,
    "start_side": "RIGHT",
    "line": 960,
    "original_line": 960,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441549936",
    "pull_request_review_id": 431242124,
    "id": 441549936,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU0OTkzNg==",
    "diff_hunk": "@@ -320,4 +322,161 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+size_t read_message(std::unique_ptr<TransportDeserializer>& deserializer, const std::vector<unsigned char>& serialized_header, const CSerializedNetMsg& msg)\n+{\n+    size_t read_bytes = 0;\n+    if (serialized_header.size() > 0) read_bytes += deserializer->Read((const char*)serialized_header.data(), serialized_header.size());\n+    //  second: read the encrypted payload (if required)\n+    if (msg.data.size() > 0) read_bytes += deserializer->Read((const char*)msg.data.data(), msg.data.size());\n+    if (msg.data.size() > read_bytes && msg.data.size() - read_bytes > 0) read_bytes += deserializer->Read((const char*)msg.data.data() + read_bytes, msg.data.size() - read_bytes);\n+    return read_bytes;\n+}\n+\n+// use 32 bytey keys with all zeros\n+static const CPrivKey k1(32, 0);\n+static const CPrivKey k2(32, 0);\n+static const uint256 session_id;",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 30,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Session IDs are important for rekey calculation. Shouldn't this be initialized to something for better expression of that intent? I can see how a fixed garbage value can work too. Wondering if that was the motivation to keep it uninitialized. ",
    "created_at": "2020-06-17T13:36:07Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441549936",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441549936"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441549936"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441549936/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 786,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441553760",
    "pull_request_review_id": 431242124,
    "id": 441553760,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU1Mzc2MA==",
    "diff_hunk": "@@ -320,4 +322,161 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+size_t read_message(std::unique_ptr<TransportDeserializer>& deserializer, const std::vector<unsigned char>& serialized_header, const CSerializedNetMsg& msg)",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 17,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Why `read_message` needs a `serialized_header`? Cant it just compute the header from `CSerializedNetMsg` like it was done in `prepareForTransport`?",
    "created_at": "2020-06-17T13:41:27Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441553760",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441553760"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441553760"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441553760/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 773,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441573505",
    "pull_request_review_id": 431242124,
    "id": 441573505,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU3MzUwNQ==",
    "diff_hunk": "@@ -320,4 +322,161 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+size_t read_message(std::unique_ptr<TransportDeserializer>& deserializer, const std::vector<unsigned char>& serialized_header, const CSerializedNetMsg& msg)\n+{\n+    size_t read_bytes = 0;\n+    if (serialized_header.size() > 0) read_bytes += deserializer->Read((const char*)serialized_header.data(), serialized_header.size());\n+    //  second: read the encrypted payload (if required)\n+    if (msg.data.size() > 0) read_bytes += deserializer->Read((const char*)msg.data.data(), msg.data.size());\n+    if (msg.data.size() > read_bytes && msg.data.size() - read_bytes > 0) read_bytes += deserializer->Read((const char*)msg.data.data() + read_bytes, msg.data.size() - read_bytes);\n+    return read_bytes;\n+}\n+\n+// use 32 bytey keys with all zeros\n+static const CPrivKey k1(32, 0);\n+static const CPrivKey k2(32, 0);\n+static const uint256 session_id;\n+\n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs)\n+{\n+    // construct the serializers\n+    std::unique_ptr<TransportSerializer> serializer;\n+    std::unique_ptr<TransportDeserializer> deserializer;\n+\n+    if (v2) {\n+        serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2, session_id));\n+        deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(k1, k2, session_id));\n+    } else {\n+        serializer = MakeUnique<V1TransportSerializer>(V1TransportSerializer());\n+        deserializer = MakeUnique<V1TransportDeserializer>(V1TransportDeserializer(Params().MessageStart(), SER_NETWORK, INIT_PROTO_VERSION));\n+    }\n+    // run a couple of times through all messages with the same AEAD instance\n+    for (unsigned int i = 0; i < 100; i++) {\n+        for (const CSerializedNetMsg& msg_orig : test_msgs) {\n+            // bypass the copy protection\n+            CSerializedNetMsg msg;\n+            msg.data = msg_orig.data;\n+            msg.command = msg_orig.command;\n+            size_t raw_msg_size = msg.data.size();\n+\n+            std::vector<unsigned char> serialized_header;\n+            serializer->prepareForTransport(msg, serialized_header);\n+\n+            // read two times\n+            size_t read_bytes = read_message(deserializer, serialized_header, msg);\n+            BOOST_CHECK(deserializer->Complete());\n+            BOOST_CHECK_EQUAL(read_bytes, msg.data.size() + serialized_header.size());\n+            // message must be complete\n+            CNetMessage msg_deser = deserializer->GetMessage(Params().MessageStart(), GetTimeMicros());\n+            BOOST_CHECK_EQUAL(msg_deser.m_command, msg.command);\n+            BOOST_CHECK_EQUAL(raw_msg_size, msg_deser.m_message_size);\n+        }\n+    }\n+}\n+\n+BOOST_AUTO_TEST_CASE(net_v2)\n+{\n+    // make sure we use the fast rekey rules\n+    // Setting the netencryptionfastrekey flag results in using a threshold of 64kb / 10 seconds for requiring a rekey\n+    gArgs.SoftSetBoolArg(\"-netencryptionfastrekey\", true);\n+\n+    // create some messages where we perform serialization and deserialization\n+    std::vector<CSerializedNetMsg> test_msgs;\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK));\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERSION, PROTOCOL_VERSION, (int)NODE_NETWORK, 123, CAddress(CService(), NODE_NONE), CAddress(CService(), NODE_NONE), 123, \"foobar\", 500000, true));\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::PING, 123456));\n+    CDataStream stream(ParseHex(\"020000000001013107ca31e1950a9b44b75ce3e8f30127e4d823ed8add1263a1cc8adcc8e49164000000001716001487835ecf51ea0351ef266d216a7e7a3e74b84b4efeffffff02082268590000000017a9144a94391b99e672b03f56d3f60800ef28bc304c4f8700ca9a3b0000000017a9146d5df9e79f752e3c53fc468db89cafda4f7d00cb87024730440220677de5b11a5617d541ba06a1fa5921ab6b4509f8028b23f18ab8c01c5eb1fcfb02202fe382e6e87653f60ff157aeb3a18fc888736720f27ced546b0b77431edabdb0012102608c772598e9645933a86bcd662a3b939e02fb3e77966c9713db5648d5ba8a0006010000\"), SER_NETWORK, PROTOCOL_VERSION);\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::TX, CTransaction(deserialize, stream)));\n+    std::vector<CInv> vInv;\n+    for (unsigned int i = 0; i < 1000; i++) {\n+        vInv.push_back(CInv(MSG_BLOCK, Params().GenesisBlock().GetHash()));\n+    }\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::INV, vInv));\n+\n+    // add a dummy message\n+    std::string dummy;\n+    for (unsigned int i = 0; i < 100; i++) {\n+        dummy += \"020000000001013107ca31e1950a9b44b75ce3e8f30127e4d823ed8add1263a1cc8adcc8e49164000000001716001487835ecf51ea0351ef266d216a7e7a3e74b84b4efeffffff02082268590000000017a9144a94391b99e672b03f56d3f60800ef28bc304c4f8700ca9a3b0000000017a9146d5df9e79f752e3c53fc468db89cafda4f7d00cb87024730440220677de5b11a5617d541ba06a1fa5921ab6b4509f8028b23f18ab8c01c5eb1fcfb02202fe382e6e87653f60ff157aeb3a18fc888736720f27ced546b0b77431edabdb0012102608c772598e9645933a86bcd662a3b939e02fb3e77966c9713db5648d5ba8a0006010000\";\n+    }\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(\"foobar\", dummy));\n+\n+    message_serialize_deserialize_test(true, test_msgs);\n+    message_serialize_deserialize_test(false, test_msgs);\n+}\n+\n+BOOST_AUTO_TEST_CASE(net_rekey)\n+{\n+    CPrivKey mutable_k1 = k1;\n+    CPrivKey mutable_k2 = k2;\n+    uint256 mutable_session_id = session_id;\n+\n+    CSerializedNetMsg test_msg = CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERSION, PROTOCOL_VERSION, (int)NODE_NETWORK, 123, CAddress(CService(), NODE_NONE), CAddress(CService(), NODE_NONE), 123, \"foobar\", 500000, true);\n+    CSerializedNetMsg test_msg_short = CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK);\n+\n+    // make sure we use the fast rekey rules\n+    std::unique_ptr<TransportSerializer> serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2, session_id));\n+    ;\n+    std::unique_ptr<TransportDeserializer> deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(k1, k2, session_id));\n+\n+    ChaCha20Poly1305AEAD test_decryption_aead(k1.data(), k1.size(), k2.data(), k2.size());\n+\n+    for (unsigned int i = 0; i <= 76; i++) {\n+        // encrypt the message without the fast-rekey rules\n+        gArgs.ForceSetArg(\"-netencryptionfastrekey\", \"0\");\n+        std::vector<unsigned char> serialized_header;\n+        serializer->prepareForTransport(test_msg, serialized_header);\n+\n+        // decrypt the message with the fast rekey-rules\n+        gArgs.ForceSetArg(\"-netencryptionfastrekey\", \"1\");\n+        read_message(deserializer, serialized_header, test_msg);\n+        CNetMessage msg_deser = deserializer->GetMessage(Params().MessageStart(), GetTimeMicros());\n+\n+        // make sure we detect the failed rekey\n+        // the 76. message (32kb) must have violated the fast rekey limits",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 127,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "rajarshimaitra",
      "id": 36541669,
      "node_id": "MDQ6VXNlcjM2NTQxNjY5",
      "avatar_url": "https://avatars.githubusercontent.com/u/36541669?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rajarshimaitra",
      "html_url": "https://github.com/rajarshimaitra",
      "followers_url": "https://api.github.com/users/rajarshimaitra/followers",
      "following_url": "https://api.github.com/users/rajarshimaitra/following{/other_user}",
      "gists_url": "https://api.github.com/users/rajarshimaitra/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rajarshimaitra/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rajarshimaitra/subscriptions",
      "organizations_url": "https://api.github.com/users/rajarshimaitra/orgs",
      "repos_url": "https://api.github.com/users/rajarshimaitra/repos",
      "events_url": "https://api.github.com/users/rajarshimaitra/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rajarshimaitra/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Nit: 76th?",
    "created_at": "2020-06-17T14:07:52Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441573505",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441573505"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441573505"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441573505/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 431,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441707547",
    "pull_request_review_id": 432617187,
    "id": 441707547,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcwNzU0Nw==",
    "diff_hunk": "@@ -712,6 +762,24 @@ class V1TransportSerializer  : public TransportSerializer {\n     void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) override;\n };\n \n+class V2TransportSerializer : public TransportSerializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for a later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_payload_seqnr = 0;\n+    uint64_t m_aad_seqnr = 0;\n+    int m_aad_pos = 0;\n+\n+public:\n+    V2TransportSerializer(const CPrivKey& k1, const CPrivKey& k2) : m_aead(new ChaCha20Poly1305AEAD(k1.data(), k1.size(), k2.data(), k2.size())), m_aead_k1(k1), m_aead_k2(k2)\n+    {\n+    }\n+    // prepare for next message\n+    void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header);",
    "path": "src/net.h",
    "position": null,
    "original_position": 85,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d55f4725c4e5875969fd6010ff67f2021c328025",
    "user": {
      "login": "narula",
      "id": 177646,
      "node_id": "MDQ6VXNlcjE3NzY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/177646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/narula",
      "html_url": "https://github.com/narula",
      "followers_url": "https://api.github.com/users/narula/followers",
      "following_url": "https://api.github.com/users/narula/following{/other_user}",
      "gists_url": "https://api.github.com/users/narula/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/narula/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/narula/subscriptions",
      "organizations_url": "https://api.github.com/users/narula/orgs",
      "repos_url": "https://api.github.com/users/narula/repos",
      "events_url": "https://api.github.com/users/narula/events{/privacy}",
      "received_events_url": "https://api.github.com/users/narula/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Add `override` keyword to be consistent with `V1TransportSerializer` (the same conditions apply here as well, no?)",
    "created_at": "2020-06-17T17:24:55Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441707547",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441707547"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441707547"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441707547/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 844,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441723494",
    "pull_request_review_id": 432637541,
    "id": 441723494,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyMzQ5NA==",
    "diff_hunk": "@@ -719,6 +723,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12\n+        if (!valid_header && size_or_shortid >= 0) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 125,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b9468fa767d1daa08924a9fefe5227b2f6688e53",
    "user": {
      "login": "narula",
      "id": 177646,
      "node_id": "MDQ6VXNlcjE3NzY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/177646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/narula",
      "html_url": "https://github.com/narula",
      "followers_url": "https://api.github.com/users/narula/followers",
      "following_url": "https://api.github.com/users/narula/following{/other_user}",
      "gists_url": "https://api.github.com/users/narula/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/narula/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/narula/subscriptions",
      "organizations_url": "https://api.github.com/users/narula/orgs",
      "repos_url": "https://api.github.com/users/narula/repos",
      "events_url": "https://api.github.com/users/narula/events{/privacy}",
      "received_events_url": "https://api.github.com/users/narula/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Agreed this is a bit confusing, and I'm not exactly sure what you're trying to achieve. `size_or_shortid >= 0` will *always* evaluate to true. `valid_header` will *always* eventually be set to true. Under what circumstances do you think `valid_header` should be false?",
    "created_at": "2020-06-17T17:51:32Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441723494",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441723494"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441723494"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441723494/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 839,
    "side": "RIGHT",
    "in_reply_to_id": 424750339
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441725357",
    "pull_request_review_id": 432639920,
    "id": 441725357,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTcyNTM1Nw==",
    "diff_hunk": "@@ -738,6 +864,58 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= NET_P2P_V2_CMD_MAX_CHARS_SIZE);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);",
    "path": "src/net.cpp",
    "position": 152,
    "original_position": 173,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d55f4725c4e5875969fd6010ff67f2021c328025",
    "user": {
      "login": "narula",
      "id": 177646,
      "node_id": "MDQ6VXNlcjE3NzY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/177646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/narula",
      "html_url": "https://github.com/narula",
      "followers_url": "https://api.github.com/users/narula/followers",
      "following_url": "https://api.github.com/users/narula/following{/other_user}",
      "gists_url": "https://api.github.com/users/narula/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/narula/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/narula/subscriptions",
      "organizations_url": "https://api.github.com/users/narula/orgs",
      "repos_url": "https://api.github.com/users/narula/repos",
      "events_url": "https://api.github.com/users/narula/events{/privacy}",
      "received_events_url": "https://api.github.com/users/narula/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think this should be `header.reserve(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);` and all instances of `serialized_header` should be replaced with `header`.",
    "created_at": "2020-06-17T17:54:33Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441725357",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441725357"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441725357"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441725357/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 904,
    "original_line": 904,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441740223",
    "pull_request_review_id": 432659553,
    "id": 441740223,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc0MDIyMw==",
    "diff_hunk": "@@ -738,6 +864,58 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= NET_P2P_V2_CMD_MAX_CHARS_SIZE);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);",
    "path": "src/net.cpp",
    "position": 152,
    "original_position": 173,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d55f4725c4e5875969fd6010ff67f2021c328025",
    "user": {
      "login": "narula",
      "id": 177646,
      "node_id": "MDQ6VXNlcjE3NzY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/177646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/narula",
      "html_url": "https://github.com/narula",
      "followers_url": "https://api.github.com/users/narula/followers",
      "following_url": "https://api.github.com/users/narula/following{/other_user}",
      "gists_url": "https://api.github.com/users/narula/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/narula/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/narula/subscriptions",
      "organizations_url": "https://api.github.com/users/narula/orgs",
      "repos_url": "https://api.github.com/users/narula/repos",
      "events_url": "https://api.github.com/users/narula/events{/privacy}",
      "received_events_url": "https://api.github.com/users/narula/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Note, after I changed this, the V2 tests fail:\r\n\r\n<details><summary>log</summary>\r\n<p>\r\n\r\n```\r\nneha@mumford:~/src/bitcoin (HEAD detached at e13accd43a)$ src/test/test_bitcoin -t net_tests -l test_suite\r\nRunning 11 test cases...\r\nEntering test module \"Bitcoin Core Test Suite\"\r\ntest/net_tests.cpp(83): Entering test suite \"net_tests\"\r\ntest/net_tests.cpp(85): Entering test case \"cnode_listen_port\"\r\ntest/net_tests.cpp(85): Leaving test case \"cnode_listen_port\"; testing time: 17203us\r\ntest/net_tests.cpp(97): Entering test case \"caddrdb_read\"\r\ntest/net_tests.cpp(97): Leaving test case \"caddrdb_read\"; testing time: 3942us\r\ntest/net_tests.cpp(143): Entering test case \"caddrdb_read_corrupted\"\r\ntest/net_tests.cpp(143): Leaving test case \"caddrdb_read_corrupted\"; testing time: 3158us\r\ntest/net_tests.cpp(173): Entering test case \"cnode_simple_test\"\r\ntest/net_tests.cpp(173): Leaving test case \"cnode_simple_test\"; testing time: 3249us\r\ntest/net_tests.cpp(198): Entering test case \"ipv4_peer_with_ipv6_addrMe_test\"\r\ntest/net_tests.cpp(198): Leaving test case \"ipv4_peer_with_ipv6_addrMe_test\"; testing time: 2877us\r\ntest/net_tests.cpp(236): Entering test case \"LimitedAndReachable_Network\"\r\ntest/net_tests.cpp(236): Leaving test case \"LimitedAndReachable_Network\"; testing time: 2849us\r\ntest/net_tests.cpp(259): Entering test case \"LimitedAndReachable_NetworkCaseUnroutableAndInternal\"\r\ntest/net_tests.cpp(259): Leaving test case \"LimitedAndReachable_NetworkCaseUnroutableAndInternal\"; testing time: 2807us\r\ntest/net_tests.cpp(282): Entering test case \"LimitedAndReachable_CNetAddr\"\r\ntest/net_tests.cpp(282): Leaving test case \"LimitedAndReachable_CNetAddr\"; testing time: 2843us\r\ntest/net_tests.cpp(296): Entering test case \"LocalAddress_BasicLifecycle\"\r\ntest/net_tests.cpp(296): Leaving test case \"LocalAddress_BasicLifecycle\"; testing time: 2845us\r\ntest/net_tests.cpp(310): Entering test case \"PoissonNextSend\"\r\ntest/net_tests.cpp(310): Leaving test case \"PoissonNextSend\"; testing time: 2813us\r\ntest/net_tests.cpp(371): Entering test case \"net_v2\"\r\ntest/net_tests.cpp(361): error: in \"net_tests/net_v2\": check deserializer->Complete() has failed\r\ntest/net_tests.cpp(362): error: in \"net_tests/net_v2\": check read_bytes == msg.data.size() + serialized_header.size() has failed [23 != 24]\r\ntest_bitcoin: net.cpp:783: virtual CNetMessage V2TransportDeserializer::GetMessage(const unsigned char (&)[4], int64_t): Assertion `Complete()' failed.\r\nunknown location(0): fatal error: in \"net_tests/net_v2\": signal: SIGABRT (application abort requested)\r\ntest/net_tests.cpp(362): last checkpoint\r\ntest/net_tests.cpp(371): Leaving test case \"net_v2\"; testing time: 3128us\r\ntest/net_tests.cpp(83): Leaving test suite \"net_tests\"; testing time: 47830us\r\nLeaving test module \"Bitcoin Core Test Suite\"; testing time: 47866us\r\n\r\n*** 3 failures are detected in the test module \"Bitcoin Core Test Suite\"\r\n```\r\n</details>",
    "created_at": "2020-06-17T18:20:15Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441740223",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441740223"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r441740223"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/441740223/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 904,
    "original_line": 904,
    "side": "RIGHT",
    "in_reply_to_id": 441725357
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442254509",
    "pull_request_review_id": 433320887,
    "id": 442254509,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI1NDUwOQ==",
    "diff_hunk": "@@ -241,3 +241,126 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags)\n \n     return str_flags;\n }\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string& cmd)",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I would prefer to return an `Option<uint8_t>` here to make it clearer when there is no short id available for a command (instead of special-casing `0`).",
    "created_at": "2020-06-18T14:08:18Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442254509",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442254509"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442254509"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442254509/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 250,
    "side": "RIGHT",
    "in_reply_to_id": 441496441
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442255349",
    "pull_request_review_id": 433322086,
    "id": 442255349,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI1NTM0OQ==",
    "diff_hunk": "@@ -241,3 +241,126 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags)\n \n     return str_flags;\n }\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string& cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FILTERLOAD) {\n+        return NetMsgType::FILTERLOAD_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETADDR) {\n+        return NetMsgType::GETADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETBLOCKS) {\n+        return NetMsgType::GETBLOCKS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::GETBLOCKTXN) {\n+        return NetMsgType::GETBLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETDATA) {\n+        return NetMsgType::GETDATA_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETHEADERS) {\n+        return NetMsgType::GETHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::HEADERS) {\n+        return NetMsgType::HEADERS_SHORT_ID;\n+    } else if (cmd == NetMsgType::INV) {\n+        return NetMsgType::INV_SHORT_ID;\n+    } else if (cmd == NetMsgType::MEMPOOL) {\n+        return NetMsgType::MEMPOOL_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::MERKLEBLOCK) {\n+        return NetMsgType::MERKLEBLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::NOTFOUND) {\n+        return NetMsgType::NOTFOUND_SHORT_ID;\n+    } else if (cmd == NetMsgType::PING) {\n+        return NetMsgType::PING_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::PONG) {\n+        return NetMsgType::PONG_SHORT_ID;\n+    } else if (cmd == NetMsgType::SENDCMPCT) {\n+        return NetMsgType::SENDCMPCT_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::SENDHEADERS) {\n+        return NetMsgType::SENDHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::TX) {\n+        return NetMsgType::TX_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERACK) {\n+        return NetMsgType::VERACK_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERSION) {\n+        return NetMsgType::VERSION_SHORT_ID;",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 64,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "a2931c174ee9a1dfe2fed0b705cec891f421dc89",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "It'd definitely result in shorter code use a hash table here.",
    "created_at": "2020-06-18T14:09:35Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442255349",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442255349"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442255349"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442255349/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 310,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442255740",
    "pull_request_review_id": 433322633,
    "id": 442255740,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI1NTc0MA==",
    "diff_hunk": "@@ -241,3 +241,126 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags)\n \n     return str_flags;\n }\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string& cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 22,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "a2931c174ee9a1dfe2fed0b705cec891f421dc89",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Why an empty statement here? (some more below)",
    "created_at": "2020-06-18T14:10:07Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442255740",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442255740"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442255740"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442255740/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 268,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442256403",
    "pull_request_review_id": 433323517,
    "id": 442256403,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI1NjQwMw==",
    "diff_hunk": "@@ -199,3 +199,127 @@ const std::vector<std::string> &getAllNetMessageTypes()\n {\n     return allNetMessageTypesVec;\n }\n+\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FILTERLOAD) {\n+        return NetMsgType::FILTERLOAD_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETADDR) {\n+        return NetMsgType::GETADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETBLOCKS) {\n+        return NetMsgType::GETBLOCKS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::GETBLOCKTXN) {\n+        return NetMsgType::GETBLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETDATA) {\n+        return NetMsgType::GETDATA_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETHEADERS) {\n+        return NetMsgType::GETHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::HEADERS) {\n+        return NetMsgType::HEADERS_SHORT_ID;\n+    } else if (cmd == NetMsgType::INV) {\n+        return NetMsgType::INV_SHORT_ID;\n+    } else if (cmd == NetMsgType::MEMPOOL) {\n+        return NetMsgType::MEMPOOL_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::MERKLEBLOCK) {\n+        return NetMsgType::MERKLEBLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::NOTFOUND) {\n+        return NetMsgType::NOTFOUND_SHORT_ID;\n+    } else if (cmd == NetMsgType::PING) {\n+        return NetMsgType::PING_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::PONG) {\n+        return NetMsgType::PONG_SHORT_ID;\n+    } else if (cmd == NetMsgType::SENDCMPCT) {\n+        return NetMsgType::SENDCMPCT_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::SENDHEADERS) {\n+        return NetMsgType::SENDHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::TX) {\n+        return NetMsgType::TX_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERACK) {\n+        return NetMsgType::VERACK_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERSION) {\n+        return NetMsgType::VERSION_SHORT_ID;\n+        ;\n+    }\n+    return 0; //no short command\n+}\n+\n+bool GetCommandFromShortCommandID(uint8_t shortID, std::string& cmd)",
    "path": "src/protocol.cpp",
    "position": 110,
    "original_position": 71,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I see @MarcoFalke's point. A P2P protocol has no commands, just messages and message ids. But yea it's unfortunate that was not caught in the BIP.",
    "created_at": "2020-06-18T14:11:00Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442256403",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442256403"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442256403"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442256403/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 249,
    "original_line": 249,
    "side": "RIGHT",
    "in_reply_to_id": 407741063
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442257870",
    "pull_request_review_id": 433325611,
    "id": 442257870,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI1Nzg3MA==",
    "diff_hunk": "@@ -199,3 +199,127 @@ const std::vector<std::string> &getAllNetMessageTypes()\n {\n     return allNetMessageTypesVec;\n }\n+\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FILTERLOAD) {\n+        return NetMsgType::FILTERLOAD_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETADDR) {\n+        return NetMsgType::GETADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETBLOCKS) {\n+        return NetMsgType::GETBLOCKS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::GETBLOCKTXN) {\n+        return NetMsgType::GETBLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETDATA) {\n+        return NetMsgType::GETDATA_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETHEADERS) {\n+        return NetMsgType::GETHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::HEADERS) {\n+        return NetMsgType::HEADERS_SHORT_ID;\n+    } else if (cmd == NetMsgType::INV) {\n+        return NetMsgType::INV_SHORT_ID;\n+    } else if (cmd == NetMsgType::MEMPOOL) {\n+        return NetMsgType::MEMPOOL_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::MERKLEBLOCK) {\n+        return NetMsgType::MERKLEBLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::NOTFOUND) {\n+        return NetMsgType::NOTFOUND_SHORT_ID;\n+    } else if (cmd == NetMsgType::PING) {\n+        return NetMsgType::PING_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::PONG) {\n+        return NetMsgType::PONG_SHORT_ID;\n+    } else if (cmd == NetMsgType::SENDCMPCT) {\n+        return NetMsgType::SENDCMPCT_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::SENDHEADERS) {\n+        return NetMsgType::SENDHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::TX) {\n+        return NetMsgType::TX_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERACK) {\n+        return NetMsgType::VERACK_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERSION) {\n+        return NetMsgType::VERSION_SHORT_ID;\n+        ;\n+    }\n+    return 0; //no short command\n+}\n+\n+bool GetCommandFromShortCommandID(uint8_t shortID, std::string& cmd)\n+{\n+    if (shortID == NetMsgType::ADDR_SHORT_ID) {",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 73,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "129545bec6288ea4900ffa3284347e1e677bdf6a",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think the advantage of a (hash)table is that it could be built in one central function, making the mapping in both directions, which leaves only one place to update for new message types (and making sure they never go out of sync).",
    "created_at": "2020-06-18T14:13:12Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442257870",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442257870"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442257870"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442257870/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 318,
    "side": "RIGHT",
    "in_reply_to_id": 407265992
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442258785",
    "pull_request_review_id": 433326717,
    "id": 442258785,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI1ODc4NQ==",
    "diff_hunk": "@@ -266,6 +291,17 @@ extern const char* CFCHECKPT;\n /* Get a vector of all valid message types (see above) */\n const std::vector<std::string>& getAllNetMessageTypes();\n \n+// Short Command IDs are a low bandwidth representations of a message type\n+// The mapping is a peer to peer agreement\n+\n+// returns the short command ID for a command",
    "path": "src/protocol.h",
    "position": null,
    "original_position": 191,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "a2931c174ee9a1dfe2fed0b705cec891f421dc89",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Please use doxygen-compatible comments e.g.\r\n```\r\n/** returns the short command ID for a command\u2026\r\n */\r\n```",
    "created_at": "2020-06-18T14:14:21Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442258785",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442258785"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442258785"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442258785/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 259,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442259229",
    "pull_request_review_id": 433327308,
    "id": 442259229,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjI1OTIyOQ==",
    "diff_hunk": "@@ -241,3 +241,126 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags)\n \n     return str_flags;\n }\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string& cmd)",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> A single comment specifying this is used for V2 messaging protocol as per BIP324 might help here.\r\n\r\nThe comment is in the `.h` file, where it belongs for public functions.",
    "created_at": "2020-06-18T14:14:57Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442259229",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442259229"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r442259229"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/442259229/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 250,
    "side": "RIGHT",
    "in_reply_to_id": 441496441
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444278079",
    "pull_request_review_id": 435854061,
    "id": 444278079,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI3ODA3OQ==",
    "diff_hunk": "@@ -266,6 +291,17 @@ extern const char* CFCHECKPT;\n /* Get a vector of all valid message types (see above) */\n const std::vector<std::string>& getAllNetMessageTypes();\n \n+// Short Command IDs are a low bandwidth representations of a message type\n+// The mapping is a peer to peer agreement\n+\n+// returns the short command ID for a command\n+// returns 0 if no short command ID has been found\n+uint8_t GetShortCommandIDFromCommand(const std::string& cmd);\n+\n+// returns the command (string) from a short command ID\n+// returns an empty string if short command ID has not been found\n+bool GetCommandFromShortCommandID(uint8_t shortID, std::string& cmd);",
    "path": "src/protocol.h",
    "position": null,
    "original_position": 197,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "a2931c174ee9a1dfe2fed0b705cec891f421dc89",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I do prefer the current order here because I find it more intuitive to have the input first and then the output. But I think in `GetCommandFromShortCommandID` the input (`shortID`) should be `const` and casing should be fixed to `short_id`. nit: Overall I would prefer a more consistent API between the two functions so that they have the same return type:\r\n\r\n```suggestion\r\n// returns the short command ID for a command (string)\r\n// returns 0 if short command ID was not found\r\nbool GetShortCommandIDFromCommand(const std::string& cmd, uint8_t short_id);\r\n\r\n// returns the command (string) from a short command ID\r\n// returns an empty string if short command ID has not been found\r\nbool GetCommandFromShortCommandID(const uint8_t short_id, std::string& cmd);\r\n```",
    "created_at": "2020-06-23T14:41:08Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r444278079",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444278079"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r444278079"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444278079/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 298,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 277,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444286263",
    "pull_request_review_id": 435854061,
    "id": 444286263,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI4NjI2Mw==",
    "diff_hunk": "@@ -320,4 +322,77 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs)\n+{\n+    // use 32 bytey keys with all zeros\n+    CPrivKey k1(32, 0);\n+    CPrivKey k2(32, 0);\n+\n+    // construct the serializers\n+    std::unique_ptr<TransportSerializer> serializer;\n+    std::unique_ptr<TransportDeserializer> deserializer;\n+\n+    if (v2) {\n+        serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2));\n+        deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(k1, k2));\n+    } else {\n+        serializer = MakeUnique<V1TransportSerializer>(V1TransportSerializer());\n+        deserializer = MakeUnique<V1TransportDeserializer>(V1TransportDeserializer(Params().MessageStart(), SER_NETWORK, INIT_PROTO_VERSION));\n+    }\n+    // run a couple of times through all messages with the same AEAD instance\n+    for (unsigned int i = 0; i < 100; i++) {\n+        for (const CSerializedNetMsg& msg_orig : test_msgs) {\n+            // bypass the copy protection\n+            CSerializedNetMsg msg;\n+            msg.data = msg_orig.data;\n+            msg.command = msg_orig.command;\n+            size_t raw_msg_size = msg.data.size();\n+\n+            std::vector<unsigned char> serialized_header;\n+            serializer->prepareForTransport(msg, serialized_header);\n+\n+            // read two times\n+            //  first: read header\n+            size_t read_bytes = 0;\n+            if (serialized_header.size() > 0) read_bytes += deserializer->Read((const char*)serialized_header.data(), serialized_header.size());\n+            //  second: read the encrypted payload (if required)\n+            if (msg.data.size() > 0) read_bytes += deserializer->Read((const char*)msg.data.data(), msg.data.size());\n+            if (msg.data.size() > read_bytes && msg.data.size() - read_bytes > 0) read_bytes += deserializer->Read((const char*)msg.data.data() + read_bytes, msg.data.size() - read_bytes);\n+            BOOST_CHECK(deserializer->Complete());\n+            BOOST_CHECK_EQUAL(read_bytes, msg.data.size() + serialized_header.size());\n+            // message must be complete\n+            CNetMessage msg_deser = deserializer->GetMessage(Params().MessageStart(), GetTimeMicros());\n+            BOOST_CHECK_EQUAL(msg_deser.m_command, msg.command);\n+            BOOST_CHECK_EQUAL(raw_msg_size, msg_deser.m_message_size);\n+        }\n+    }\n+}\n+\n+BOOST_AUTO_TEST_CASE(net_v2)\n+{\n+    // create some messages where we perform serialization and deserialization\n+    std::vector<CSerializedNetMsg> test_msgs;\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK));\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERSION, PROTOCOL_VERSION, (int)NODE_NETWORK, 123, CAddress(CService(), NODE_NONE), CAddress(CService(), NODE_NONE), 123, \"foobar\", 500000, true));\n+    test_msgs.push_back(CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::PING, 123456));\n+    CDataStream stream(ParseHex(\"020000000001013107ca31e1950a9b44b75ce3e8f30127e4d823ed8add1263a1cc8adcc8e49164000000001716001487835ecf51ea0351ef266d216a7e7a3e74b84b4efeffffff02082268590000000017a9144a94391b99e672b03f56d3f60800ef28bc304c4f8700ca9a3b0000000017a9146d5df9e79f752e3c53fc468db89cafda4f7d00cb87024730440220677de5b11a5617d541ba06a1fa5921ab6b4509f8028b23f18ab8c01c5eb1fcfb02202fe382e6e87653f60ff157aeb3a18fc888736720f27ced546b0b77431edabdb0012102608c772598e9645933a86bcd662a3b939e02fb3e77966c9713db5648d5ba8a0006010000\"), SER_NETWORK, PROTOCOL_VERSION);",
    "path": "src/test/net_tests.cpp",
    "position": 71,
    "original_position": 70,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e13accd43aff22e010c6635e4fde517ab8526efa",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: The dummy message seems to be reused several times, could be a constant.",
    "created_at": "2020-06-23T14:51:34Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r444286263",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444286263"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r444286263"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444286263/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 992,
    "original_line": 992,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444303624",
    "pull_request_review_id": 435854061,
    "id": 444303624,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMwMzYyNA==",
    "diff_hunk": "@@ -698,6 +700,54 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// V2TransportDeserializer is a transport deserializer after BIP324",
    "path": "src/net.h",
    "position": null,
    "original_position": 15,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d55f4725c4e5875969fd6010ff67f2021c328025",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: Should be doxygen comment I think.",
    "created_at": "2020-06-23T15:15:24Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r444303624",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444303624"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r444303624"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444303624/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 757,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444304206",
    "pull_request_review_id": 435854061,
    "id": 444304206,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMwNDIwNg==",
    "diff_hunk": "@@ -712,6 +762,24 @@ class V1TransportSerializer  : public TransportSerializer {\n     void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) override;\n };\n \n+class V2TransportSerializer : public TransportSerializer",
    "path": "src/net.h",
    "position": null,
    "original_position": 70,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d55f4725c4e5875969fd6010ff67f2021c328025",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: Could also add a doxygen comment here.",
    "created_at": "2020-06-23T15:16:09Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r444304206",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444304206"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r444304206"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444304206/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 891,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444311734",
    "pull_request_review_id": 435854061,
    "id": 444311734,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDMxMTczNA==",
    "diff_hunk": "@@ -394,5 +404,79 @@ BOOST_AUTO_TEST_CASE(net_v2)\n     message_serialize_deserialize_test(false, test_msgs);\n }\n \n+BOOST_AUTO_TEST_CASE(net_rekey)\n+{\n+    CPrivKey mutable_k1 = k1;\n+    CPrivKey mutable_k2 = k2;\n+    uint256 mutable_session_id = session_id;\n+\n+    CSerializedNetMsg test_msg = CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERSION, PROTOCOL_VERSION, (int)NODE_NETWORK, 123, CAddress(CService(), NODE_NONE), CAddress(CService(), NODE_NONE), 123, \"foobar\", 500000, true);\n+    CSerializedNetMsg test_msg_short = CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK);\n+\n+    // make sure we use the fast rekey rules\n+    std::unique_ptr<TransportSerializer> serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2, session_id));\n+    ;",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 77,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9ff5cec2cfc52bac2d63ff23b3fd98232682b940",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "remove empty statement",
    "created_at": "2020-06-23T15:26:22Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r444311734",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444311734"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r444311734"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444311734/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 414,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444415469",
    "pull_request_review_id": 435854061,
    "id": 444415469,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQxNTQ2OQ==",
    "diff_hunk": "@@ -320,4 +322,77 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs)\n+{\n+    // use 32 bytey keys with all zeros",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 19,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e13accd43aff22e010c6635e4fde517ab8526efa",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: Would be nice if that typo was fixed.",
    "created_at": "2020-06-23T18:12:34Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r444415469",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444415469"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r444415469"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/444415469/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 327,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469218647",
    "pull_request_review_id": 465865164,
    "id": 469218647,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIxODY0Nw==",
    "diff_hunk": "@@ -11,6 +11,7 @@\n \n static constexpr int CHACHA20_POLY1305_AEAD_KEY_LEN = 32;\n static constexpr int CHACHA20_POLY1305_AEAD_AAD_LEN = 3; /* 3 bytes length */\n+static constexpr int CHACHA20_POLY1305_AEAD_TAG_LEN = 16; /* 16 bytes poly1305 tag */",
    "path": "src/crypto/chacha_poly_aead.h",
    "position": 10,
    "original_position": 4,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I prefer to keep the AEAD contents separate.",
    "created_at": "2020-08-12T12:25:10Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469218647",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469218647"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469218647"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469218647/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 15,
    "original_line": 15,
    "side": "RIGHT",
    "in_reply_to_id": 440650990
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469220779",
    "pull_request_review_id": 465866952,
    "id": 469220779,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyMDc3OQ==",
    "diff_hunk": "@@ -725,6 +729,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 86,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The transport deserializer(s) use an abstract class for the runtime flexibility. The network magic is required for V1. I think it makes no sense to try to get rid of it here as long as V1 is supported.",
    "created_at": "2020-08-12T12:27:49Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469220779",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469220779"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469220779"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469220779/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 789,
    "side": "RIGHT",
    "in_reply_to_id": 440878852
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469223149",
    "pull_request_review_id": 465868831,
    "id": 469223149,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyMzE0OQ==",
    "diff_hunk": "@@ -725,6 +729,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 97,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Fixed.",
    "created_at": "2020-08-12T12:30:29Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469223149",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469223149"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469223149"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469223149/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 811,
    "side": "RIGHT",
    "in_reply_to_id": 440896136
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469223235",
    "pull_request_review_id": 465868901,
    "id": 469223235,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyMzIzNQ==",
    "diff_hunk": "@@ -725,6 +729,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 92,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Fixed.",
    "created_at": "2020-08-12T12:30:34Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469223235",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469223235"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469223235"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469223235/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 806,
    "side": "RIGHT",
    "in_reply_to_id": 440897035
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469225251",
    "pull_request_review_id": 465871171,
    "id": 469225251,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyNTI1MQ==",
    "diff_hunk": "@@ -725,6 +729,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12\n+        if (!valid_header && size_or_shortid >= 0) {\n+            valid_header = true;\n+            if (!GetCommandFromShortCommandID(size_or_shortid, command_name)) {\n+                // unknown-short-id\n+                //  results in a valid but unknown message (will be skipped)\n+                command_name = \"unknown-\" + ToString(size_or_shortid);\n+            }\n+        }\n+    }\n+    // increase the aad_pos and eventually the sequence number\n+    m_aad_pos += CHACHA20_POLY1305_AEAD_AAD_LEN;\n+    if (m_aad_pos + CHACHA20_POLY1305_AEAD_AAD_LEN > CHACHA20_ROUND_OUTPUT) {\n+        m_aad_pos = 0;\n+        m_aad_seqnr++;\n+    }\n+    // increase the payload sequence number by 1\n+    m_payload_seqnr++;\n+\n+    // decompose a single CNetMessage from the TransportDeserializer\n+    CNetMessage msg(std::move(vRecv)); // result in a message with CDataStream with readpos pointing to the message payload\n+    msg.m_command = command_name;\n+\n+    // store state about valid header, netmagic and checksum\n+    msg.m_valid_header = valid_header; // not relevant for v2, always pass\n+    msg.m_valid_checksum = valid_checksum;\n+    msg.m_valid_netmagic = true; // not relevant for v2, always pass\n+\n+    // if we could successfully decrypt the message, the message no longer contains the \"header\" (AAD & MAC)\n+    // if failed to decrypt \u2013 which we tolerate at this point \u2013 we need to reduce the message size by the length of the AD & MAC",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 153,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "fixed",
    "created_at": "2020-08-12T12:33:28Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469225251",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469225251"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469225251"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469225251/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 867,
    "side": "RIGHT",
    "in_reply_to_id": 440967503
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469226209",
    "pull_request_review_id": 465872390,
    "id": 469226209,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyNjIwOQ==",
    "diff_hunk": "@@ -738,6 +909,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= NET_P2P_V2_CMD_MAX_CHARS_SIZE);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID or (eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow separate buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + CHACHA20_POLY1305_AEAD_TAG_LEN, 0);\n+\n+    // length is only allowed up to 2^23 (bit24 is used for indicating rekey)\n+    bool bit24 = msg.data[2] & (1u << 7);\n+    assert(!bit24);\n+\n+    // check if we should rekey after this message\n+    const int64_t now = GetTime(); //TODO: check how expansive the GetTime call is and if it is avoidable\n+    bool rekey = false;\n+    if (m_bytes_encrypted >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 32 * 1024 : REKEY_LIMIT_BYTES) || now - m_time_last_rekey >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 10 : REKEY_LIMIT_TIME)) {\n+        LogPrint(BCLog::NET, \"Rekey limits reached, performing rekey.\\n\");\n+        msg.data[2] |= (1u << 7);\n+        rekey = true;\n+    }\n+\n+    // encrypt the payload, ignore return code since it can't fail in this case (controlled buffers, don't check the MAC during encrypting)\n+    m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, msg.data.data(), msg.data.size(), msg.data.data(), msg.data.size() - CHACHA20_POLY1305_AEAD_TAG_LEN, true);\n+\n+    // increase the aad_pos and eventually the sequence number\n+    m_aad_pos += CHACHA20_POLY1305_AEAD_AAD_LEN;\n+    if (m_aad_pos + CHACHA20_POLY1305_AEAD_AAD_LEN > CHACHA20_ROUND_OUTPUT) {\n+        m_aad_pos = 0;\n+        m_aad_seqnr++;\n+    }\n+    // increase the payload sequence number by 1\n+    m_payload_seqnr++;\n+\n+    m_bytes_encrypted += msg.data.size(); // count everything, MAC tag + AD\n+\n+    if (rekey) {\n+        // make sure we rekey at this point, next message needs to be encrypted with the new key\n+        CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k1.data(), m_aead_k1.size()).Finalize(m_aead_k1.data());\n+        CHash256().Write(m_session_id.begin(), m_session_id.size()).Write(m_aead_k2.data(), m_aead_k2.size()).Finalize(m_aead_k2.data());\n+\n+        // reset the AEAD context\n+        m_aead.reset(new ChaCha20Poly1305AEAD(m_aead_k1.data(), m_aead_k1.size(), m_aead_k2.data(), m_aead_k2.size()));\n+        LogPrint(BCLog::NET, \"Rekey: new send keys (%s, %s)\\n\", HexStr(m_aead_k1), HexStr(m_aead_k2));\n+\n+        // reset the AEAD context\n+        m_aead.reset(new ChaCha20Poly1305AEAD(m_aead_k1.data(), m_aead_k1.size(), m_aead_k2.data(), m_aead_k2.size()));",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 279,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Oops. Rebase issue. Fixed.",
    "created_at": "2020-08-12T12:35:11Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469226209",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469226209"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469226209"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469226209/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 987,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 999,
    "side": "RIGHT",
    "in_reply_to_id": 441435792
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469226989",
    "pull_request_review_id": 465873398,
    "id": 469226989,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyNjk4OQ==",
    "diff_hunk": "@@ -738,6 +909,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)",
    "path": "src/net.cpp",
    "position": 137,
    "original_position": 203,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Same issue as [this](https://github.com/bitcoin/bitcoin/pull/18242#discussion_r440878852). It's required for V1.",
    "created_at": "2020-08-12T12:36:36Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469226989",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469226989"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469226989"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469226989/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 889,
    "original_line": 889,
    "side": "RIGHT",
    "in_reply_to_id": 441445522
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469227995",
    "pull_request_review_id": 465874708,
    "id": 469227995,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyNzk5NQ==",
    "diff_hunk": "@@ -738,6 +909,95 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= NET_P2P_V2_CMD_MAX_CHARS_SIZE);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID or (eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id;\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.command;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow separate buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + CHACHA20_POLY1305_AEAD_TAG_LEN, 0);\n+\n+    // length is only allowed up to 2^23 (bit24 is used for indicating rekey)\n+    bool bit24 = msg.data[2] & (1u << 7);\n+    assert(!bit24);\n+\n+    // check if we should rekey after this message\n+    const int64_t now = GetTime(); //TODO: check how expansive the GetTime call is and if it is avoidable\n+    bool rekey = false;\n+    if (m_bytes_encrypted >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 32 * 1024 : REKEY_LIMIT_BYTES) || now - m_time_last_rekey >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 10 : REKEY_LIMIT_TIME)) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 249,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The fast rekey function is not something that needs to be specified in the BIP. The purpose of it is for pure implementation testability and has nothing to do with the specification.",
    "created_at": "2020-08-12T12:38:26Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469227995",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469227995"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469227995"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469227995/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1022,
    "side": "RIGHT",
    "in_reply_to_id": 441475023
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469228811",
    "pull_request_review_id": 465875765,
    "id": 469228811,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyODgxMQ==",
    "diff_hunk": "@@ -698,6 +700,70 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS\n+\n+// V2TransportDeserializer is a transport deserializer after BIP324\n+class V2TransportDeserializer : public TransportDeserializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_decrypted = 0; // counter of bytes decrypted under the same key\n+    int64_t m_time_last_rekey = 0;",
    "path": "src/net.h",
    "position": null,
    "original_position": 32,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks. Fixed.",
    "created_at": "2020-08-12T12:39:58Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469228811",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469228811"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469228811"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469228811/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 765,
    "side": "RIGHT",
    "in_reply_to_id": 441480135
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469234339",
    "pull_request_review_id": 465883253,
    "id": 469234339,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIzNDMzOQ==",
    "diff_hunk": "@@ -698,6 +700,70 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS\n+\n+// V2TransportDeserializer is a transport deserializer after BIP324\n+class V2TransportDeserializer : public TransportDeserializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_decrypted = 0; // counter of bytes decrypted under the same key\n+    int64_t m_time_last_rekey = 0;\n+    uint256 m_session_id;           // the encryption session_id, relevant for rekeying\n+    uint64_t m_payload_seqnr = 0;   // sequence number for the payload\n+    uint64_t m_aad_seqnr = 0;       // sequence number for the packet length (AD)\n+    int m_aad_pos = 0;              // position in the aad keystream\n+    bool m_in_data = false;         // parsing header (false) or data (true)\n+    uint32_t m_message_size = 0;    // expected message size\n+    CDataStream vRecv;              // received message data\n+    unsigned int m_hdr_pos = 0;     // read pos in header\n+    unsigned int m_data_pos = 0;    // read pos in data\n+    bool m_rekey_flag = false;      // rekey in message detected\n+\n+public:\n+    V2TransportDeserializer(const CPrivKey& k1, const CPrivKey& k2, const uint256& session_id) : m_aead(new ChaCha20Poly1305AEAD(k1.data(), k1.size(), k2.data(), k2.size())), m_aead_k1(k1), m_aead_k2(k2), m_time_last_rekey(GetTime()), m_session_id(session_id), vRecv(SER_NETWORK, INIT_PROTO_VERSION)\n+    {\n+        Reset();\n+    }\n+\n+    void Reset()\n+    {\n+        vRecv.clear();\n+        vRecv.resize(CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        m_in_data = false;\n+        m_hdr_pos = 0;\n+        m_message_size = 0;\n+        m_data_pos = 0;\n+        m_rekey_flag = false;\n+    }\n+    bool Complete() const\n+    {\n+        if (!m_in_data) {\n+            return false;\n+        }\n+        return (m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN == m_data_pos);\n+    }\n+    void SetVersion(int nVersionIn)\n+    {\n+        vRecv.SetVersion(nVersionIn);\n+    }\n+    bool OversizedMessageDetected() const",
    "path": "src/net.h",
    "position": null,
    "original_position": 71,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Good point. I think this got \"rebased-away\". Just removed `OversizedMessageDetected()`.",
    "created_at": "2020-08-12T12:50:14Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469234339",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469234339"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469234339"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469234339/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 804,
    "side": "RIGHT",
    "in_reply_to_id": 441481441
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469240328",
    "pull_request_review_id": 465891125,
    "id": 469240328,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI0MDMyOA==",
    "diff_hunk": "@@ -320,4 +322,161 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+size_t read_message(std::unique_ptr<TransportDeserializer>& deserializer, const std::vector<unsigned char>& serialized_header, const CSerializedNetMsg& msg)\n+{\n+    size_t read_bytes = 0;\n+    if (serialized_header.size() > 0) read_bytes += deserializer->Read((const char*)serialized_header.data(), serialized_header.size());\n+    //  second: read the encrypted payload (if required)\n+    if (msg.data.size() > 0) read_bytes += deserializer->Read((const char*)msg.data.data(), msg.data.size());\n+    if (msg.data.size() > read_bytes && msg.data.size() - read_bytes > 0) read_bytes += deserializer->Read((const char*)msg.data.data() + read_bytes, msg.data.size() - read_bytes);\n+    return read_bytes;\n+}\n+\n+// use 32 bytey keys with all zeros\n+static const CPrivKey k1(32, 0);\n+static const CPrivKey k2(32, 0);\n+static const uint256 session_id;",
    "path": "src/test/net_tests.cpp",
    "position": null,
    "original_position": 30,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "uint256 has a default constructor the sets the memory to all zeros. Should be enough?",
    "created_at": "2020-08-12T12:59:54Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469240328",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469240328"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469240328"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469240328/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 786,
    "side": "RIGHT",
    "in_reply_to_id": 441549936
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469240865",
    "pull_request_review_id": 465891751,
    "id": 469240865,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI0MDg2NQ==",
    "diff_hunk": "@@ -320,4 +322,161 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+size_t read_message(std::unique_ptr<TransportDeserializer>& deserializer, const std::vector<unsigned char>& serialized_header, const CSerializedNetMsg& msg)\n+{\n+    size_t read_bytes = 0;\n+    if (serialized_header.size() > 0) read_bytes += deserializer->Read((const char*)serialized_header.data(), serialized_header.size());\n+    //  second: read the encrypted payload (if required)\n+    if (msg.data.size() > 0) read_bytes += deserializer->Read((const char*)msg.data.data(), msg.data.size());\n+    if (msg.data.size() > read_bytes && msg.data.size() - read_bytes > 0) read_bytes += deserializer->Read((const char*)msg.data.data() + read_bytes, msg.data.size() - read_bytes);\n+    return read_bytes;\n+}\n+\n+// use 32 bytey keys with all zeros\n+static const CPrivKey k1(32, 0);\n+static const CPrivKey k2(32, 0);\n+static const uint256 session_id;\n+\n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs)\n+{\n+    // construct the serializers\n+    std::unique_ptr<TransportSerializer> serializer;\n+    std::unique_ptr<TransportDeserializer> deserializer;\n+\n+    if (v2) {\n+        serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2, session_id));\n+        deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(k1, k2, session_id));\n+    } else {\n+        serializer = MakeUnique<V1TransportSerializer>(V1TransportSerializer());\n+        deserializer = MakeUnique<V1TransportDeserializer>(V1TransportDeserializer(Params().MessageStart(), SER_NETWORK, INIT_PROTO_VERSION));\n+    }\n+    // run a couple of times through all messages with the same AEAD instance\n+    for (unsigned int i = 0; i < 100; i++) {\n+        for (const CSerializedNetMsg& msg_orig : test_msgs) {\n+            // bypass the copy protection\n+            CSerializedNetMsg msg;\n+            msg.data = msg_orig.data;\n+            msg.command = msg_orig.command;\n+            size_t raw_msg_size = msg.data.size();\n+\n+            std::vector<unsigned char> serialized_header;\n+            serializer->prepareForTransport(msg, serialized_header);",
    "path": "src/test/net_tests.cpp",
    "position": 39,
    "original_position": 55,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "7aa91cd136de91d155961da55132684aa6e4befa",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Keep in mind that `prepareForTransport` must have the flexibility to work with other transport types including the V1 transport.",
    "created_at": "2020-08-12T13:00:38Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469240865",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469240865"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469240865"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469240865/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": 959,
    "original_start_line": 362,
    "start_side": "RIGHT",
    "line": 960,
    "original_line": 960,
    "side": "RIGHT",
    "in_reply_to_id": 441542048
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469245175",
    "pull_request_review_id": 465897294,
    "id": 469245175,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI0NTE3NQ==",
    "diff_hunk": "@@ -712,6 +762,24 @@ class V1TransportSerializer  : public TransportSerializer {\n     void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) override;\n };\n \n+class V2TransportSerializer : public TransportSerializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for a later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_payload_seqnr = 0;\n+    uint64_t m_aad_seqnr = 0;\n+    int m_aad_pos = 0;\n+\n+public:\n+    V2TransportSerializer(const CPrivKey& k1, const CPrivKey& k2) : m_aead(new ChaCha20Poly1305AEAD(k1.data(), k1.size(), k2.data(), k2.size())), m_aead_k1(k1), m_aead_k2(k2)\n+    {\n+    }\n+    // prepare for next message\n+    void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header);",
    "path": "src/net.h",
    "position": null,
    "original_position": 85,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d55f4725c4e5875969fd6010ff67f2021c328025",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Right. Thanks. Fixed.",
    "created_at": "2020-08-12T13:07:34Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469245175",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469245175"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469245175"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469245175/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 844,
    "side": "RIGHT",
    "in_reply_to_id": 441707547
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469248481",
    "pull_request_review_id": 465901679,
    "id": 469248481,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI0ODQ4MQ==",
    "diff_hunk": "@@ -738,6 +864,58 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    const uint8_t cmd_short_id = GetShortCommandIDFromCommand(msg.command);\n+    if (cmd_short_id == 0) {\n+        // message command without an assigned short-ID\n+        assert(msg.command.size() <= NET_P2P_V2_CMD_MAX_CHARS_SIZE);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.command, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);",
    "path": "src/net.cpp",
    "position": 152,
    "original_position": 173,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "d55f4725c4e5875969fd6010ff67f2021c328025",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I see your point.\r\nThe pass-by-reference `header` field in `prepareForTransport()` is only used in V1.\r\nIn V2, there is actually no header (well, you could argue that the MAC-tag and the encrypted length is the header but since the MAC is at the end of the message, it makes little sense to try to use that header field).\r\n\r\nTherefor, in V2, the pass-by-reference `header` field is unused and the whole message (including the AAD & MAC) is part of the message data/payload (which I think is conceptual fine).",
    "created_at": "2020-08-12T13:12:45Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469248481",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469248481"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469248481"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469248481/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 904,
    "original_line": 904,
    "side": "RIGHT",
    "in_reply_to_id": 441725357
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469248596",
    "pull_request_review_id": 465901861,
    "id": 469248596,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI0ODU5Ng==",
    "diff_hunk": "@@ -241,3 +241,126 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags)\n \n     return str_flags;\n }\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string& cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FILTERLOAD) {\n+        return NetMsgType::FILTERLOAD_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETADDR) {\n+        return NetMsgType::GETADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETBLOCKS) {\n+        return NetMsgType::GETBLOCKS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::GETBLOCKTXN) {\n+        return NetMsgType::GETBLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETDATA) {\n+        return NetMsgType::GETDATA_SHORT_ID;\n+    } else if (cmd == NetMsgType::GETHEADERS) {\n+        return NetMsgType::GETHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::HEADERS) {\n+        return NetMsgType::HEADERS_SHORT_ID;\n+    } else if (cmd == NetMsgType::INV) {\n+        return NetMsgType::INV_SHORT_ID;\n+    } else if (cmd == NetMsgType::MEMPOOL) {\n+        return NetMsgType::MEMPOOL_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::MERKLEBLOCK) {\n+        return NetMsgType::MERKLEBLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::NOTFOUND) {\n+        return NetMsgType::NOTFOUND_SHORT_ID;\n+    } else if (cmd == NetMsgType::PING) {\n+        return NetMsgType::PING_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::PONG) {\n+        return NetMsgType::PONG_SHORT_ID;\n+    } else if (cmd == NetMsgType::SENDCMPCT) {\n+        return NetMsgType::SENDCMPCT_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::SENDHEADERS) {\n+        return NetMsgType::SENDHEADERS_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::TX) {\n+        return NetMsgType::TX_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERACK) {\n+        return NetMsgType::VERACK_SHORT_ID;\n+    } else if (cmd == NetMsgType::VERSION) {\n+        return NetMsgType::VERSION_SHORT_ID;",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 64,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "a2931c174ee9a1dfe2fed0b705cec891f421dc89",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Switched to a std::map.",
    "created_at": "2020-08-12T13:12:58Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469248596",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469248596"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469248596"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469248596/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 310,
    "side": "RIGHT",
    "in_reply_to_id": 442255349
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469248711",
    "pull_request_review_id": 465902027,
    "id": 469248711,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI0ODcxMQ==",
    "diff_hunk": "@@ -241,3 +241,126 @@ std::vector<std::string> serviceFlagsToStr(uint64_t flags)\n \n     return str_flags;\n }\n+\n+uint8_t GetShortCommandIDFromCommand(const std::string& cmd)\n+{\n+    if (cmd == NetMsgType::ADDR) {\n+        return NetMsgType::ADDR_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCK) {\n+        return NetMsgType::BLOCK_SHORT_ID;\n+    } else if (cmd == NetMsgType::BLOCKTXN) {\n+        return NetMsgType::BLOCKTXN_SHORT_ID;\n+    } else if (cmd == NetMsgType::CMPCTBLOCK) {\n+        return NetMsgType::CMPCTBLOCK_SHORT_ID;\n+        ;\n+    } else if (cmd == NetMsgType::FEEFILTER) {\n+        return NetMsgType::FEEFILTER_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERADD) {\n+        return NetMsgType::FILTERADD_SHORT_ID;\n+    } else if (cmd == NetMsgType::FILTERCLEAR) {\n+        return NetMsgType::FILTERCLEAR_SHORT_ID;\n+        ;",
    "path": "src/protocol.cpp",
    "position": null,
    "original_position": 22,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "a2931c174ee9a1dfe2fed0b705cec891f421dc89",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Rebase issues. Fixed.",
    "created_at": "2020-08-12T13:13:09Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469248711",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469248711"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469248711"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469248711/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 268,
    "side": "RIGHT",
    "in_reply_to_id": 442255740
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469249972",
    "pull_request_review_id": 465903698,
    "id": 469249972,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI0OTk3Mg==",
    "diff_hunk": "@@ -266,6 +291,17 @@ extern const char* CFCHECKPT;\n /* Get a vector of all valid message types (see above) */\n const std::vector<std::string>& getAllNetMessageTypes();\n \n+// Short Command IDs are a low bandwidth representations of a message type\n+// The mapping is a peer to peer agreement\n+\n+// returns the short command ID for a command",
    "path": "src/protocol.h",
    "position": null,
    "original_position": 191,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "a2931c174ee9a1dfe2fed0b705cec891f421dc89",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Fixed.",
    "created_at": "2020-08-12T13:15:04Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469249972",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469249972"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r469249972"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/469249972/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 259,
    "side": "RIGHT",
    "in_reply_to_id": 442258785
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474682022",
    "pull_request_review_id": 472468219,
    "id": 474682022,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY4MjAyMg==",
    "diff_hunk": "@@ -743,6 +745,66 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, std::chrono::microseconds time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS\n+\n+/** V2TransportDeserializer is a transport deserializer after BIP324 */\n+class V2TransportDeserializer : public TransportDeserializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_decrypted = 0; // counter of bytes decrypted under the same key\n+    int64_t m_time_last_rekey = 0;  // recorded time when the last rekey happened\n+    uint256 m_session_id;           // the encryption session_id, relevant for rekeying\n+    uint64_t m_payload_seqnr = 0;   // sequence number for the payload\n+    uint64_t m_aad_seqnr = 0;       // sequence number for the packet length (AD)\n+    int m_aad_pos = 0;              // position in the aad keystream\n+    bool m_in_data = false;         // parsing header (false) or data (true)\n+    uint32_t m_message_size = 0;    // expected message size\n+    CDataStream vRecv;              // received message data\n+    unsigned int m_hdr_pos = 0;     // read pos in header\n+    unsigned int m_data_pos = 0;    // read pos in data\n+    bool m_rekey_flag = false;      // rekey in message detected\n+\n+public:\n+    V2TransportDeserializer(const CPrivKey& k1, const CPrivKey& k2, const uint256& session_id) : m_aead(new ChaCha20Poly1305AEAD(k1.data(), k1.size(), k2.data(), k2.size())), m_aead_k1(k1), m_aead_k2(k2), m_time_last_rekey(GetTime()), m_session_id(session_id), vRecv(SER_NETWORK, INIT_PROTO_VERSION)\n+    {\n+        Reset();\n+    }\n+\n+    void Reset()\n+    {\n+        vRecv.clear();\n+        vRecv.resize(CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        m_in_data = false;\n+        m_hdr_pos = 0;\n+        m_message_size = 0;\n+        m_data_pos = 0;\n+        m_rekey_flag = false;\n+    }\n+    bool Complete() const\n+    {\n+        if (!m_in_data) {\n+            return false;\n+        }\n+        return (m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN == m_data_pos);\n+    }\n+    void SetVersion(int nVersionIn)\n+    {\n+        vRecv.SetVersion(nVersionIn);\n+    }\n+    int Read(const char* pch, unsigned int nBytes);",
    "path": "src/net.h",
    "position": null,
    "original_position": 71,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b1ef92ae52e7df88376dcc63507c50879fa15386",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit 52a2032 \"Add BIP324 v2 transport serializer and deserializer\"\r\n\r\n<details><summary>some suggested changes in <code>src/net.h::V2TransportDeserializer</code></summary><p>\r\n\r\n```diff\r\ndiff --git a/src/net.h b/src/net.h\r\nindex bf909d82d7..ee2f174ad8 100644\r\n--- a/src/net.h\r\n+++ b/src/net.h\r\n@@ -790,19 +790,19 @@ public:\r\n         m_data_pos = 0;\r\n         m_rekey_flag = false;\r\n     }\r\n-    bool Complete() const\r\n+    bool Complete() const override\r\n     {\r\n         if (!m_in_data) {\r\n             return false;\r\n         }\r\n         return (m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN == m_data_pos);\r\n     }\r\n-    void SetVersion(int nVersionIn)\r\n+    void SetVersion(int nVersionIn) override\r\n     {\r\n         vRecv.SetVersion(nVersionIn);\r\n     }\r\n-    int Read(const char* pch, unsigned int nBytes);\r\n-    CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, std::chrono::microseconds time);\r\n+    int Read(const char* pch, unsigned int nBytes) override;\r\n+    CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, std::chrono::microseconds time) override;\r\n };\r\n\r\n /** The TransportSerializer prepares messages for the network transport\r\n```\r\n</p></details>\r\n\r\nto fix these\r\n\r\n<details><summary>gcc/clang compiler warnings/errors</summary><p>\r\n\r\n```\r\nIn file included from init.cpp:29:\r\n./net.h:793:10: error: \u2018virtual bool V2TransportDeserializer::Complete() const\u2019 can be marked override [-Werror=suggest-override]\r\n  793 |     bool Complete() const\r\n      |          ^~~~~~~~\r\n./net.h:800:10: error: \u2018virtual void V2TransportDeserializer::SetVersion(int)\u2019 can be marked override [-Werror=suggest-override]\r\n  800 |     void SetVersion(int nVersionIn)\r\n      |          ^~~~~~~~~~\r\n./net.h:804:9: error: \u2018virtual int V2TransportDeserializer::Read(const char*, unsigned int)\u2019 can be marked override [-Werror=suggest-override]\r\n  804 |     int Read(const char* pch, unsigned int nBytes);\r\n      |         ^~~~\r\n./net.h:805:17: error: \u2018virtual CNetMessage V2TransportDeserializer::GetMessage(const unsigned char (&)[4], std::chrono::microseconds)\u2019 can be marked override [-Werror=suggest-override]\r\n  805 |     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, std::chrono::microseconds time);\r\n      |                 ^~~~~~~~~~\r\ncc1plus: some warnings being treated as errors\r\nmake[2]: *** [Makefile:11597: libbitcoin_server_a-init.o] Error 1\r\nmake[2]: *** Waiting for unfinished jobs....\r\nIn file included from net.cpp:10:\r\n./net.h:793:10: error: \u2018virtual bool V2TransportDeserializer::Complete() const\u2019 can be marked override [-Werror=suggest-override]\r\n  793 |     bool Complete() const\r\n      |          ^~~~~~~~\r\n./net.h:800:10: error: \u2018virtual void V2TransportDeserializer::SetVersion(int)\u2019 can be marked override [-Werror=suggest-override]\r\n  800 |     void SetVersion(int nVersionIn)\r\n      |          ^~~~~~~~~~\r\n./net.h:804:9: error: \u2018virtual int V2TransportDeserializer::Read(const char*, unsigned int)\u2019 can be marked override [-Werror=suggest-override]\r\n  804 |     int Read(const char* pch, unsigned int nBytes);\r\n      |         ^~~~\r\n./net.h:805:17: error: \u2018virtual CNetMessage V2TransportDeserializer::GetMessage(const unsigned char (&)[4], std::chrono::microseconds)\u2019 can be marked override [-Werror=suggest-override]\r\n  805 |     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, std::chrono::microseconds time);\r\n      |                 ^~~~~~~~~~\r\nnet.cpp: In member function \u2018virtual CNetMessage V2TransportDeserializer::GetMessage(const unsigned char (&)[4], std::chrono::microseconds)\u2019:\r\nnet.cpp:839:46: warning: comparison is always true due to limited range of data type [-Wtype-limits]\r\n  839 |         if (!valid_header && size_or_shortid >= 0) {\r\n      |                              ~~~~~~~~~~~~~~~~^~~~\r\ncc1plus: some warnings being treated as errors\r\nmake[2]: *** [Makefile:11653: libbitcoin_server_a-net.o] Error 1\r\nIn file included from ./net_processing.h:10,\r\n                 from net_processing.cpp:6:\r\n./net.h:793:10: error: \u2018virtual bool V2TransportDeserializer::Complete() const\u2019 can be marked override [-Werror=suggest-override]\r\n  793 |     bool Complete() const\r\n      |          ^~~~~~~~\r\n./net.h:800:10: error: \u2018virtual void V2TransportDeserializer::SetVersion(int)\u2019 can be marked override [-Werror=suggest-override]\r\n  800 |     void SetVersion(int nVersionIn)\r\n      |          ^~~~~~~~~~\r\n./net.h:804:9: error: \u2018virtual int V2TransportDeserializer::Read(const char*, unsigned int)\u2019 can be marked override [-Werror=suggest-override]\r\n  804 |     int Read(const char* pch, unsigned int nBytes);\r\n      |         ^~~~\r\n./net.h:805:17: error: \u2018virtual CNetMessage V2TransportDeserializer::GetMessage(const unsigned char (&)[4], std::chrono::microseconds)\u2019 can be marked override [-Werror=suggest-override]\r\n  805 |     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, std::chrono::microseconds time);\r\n      |                 ^~~~~~~~~~\r\ncc1plus: some warnings being treated as errors\r\nmake[2]: *** [Makefile:11667: libbitcoin_server_a-net_processing.o] Error 1\r\nmake[2]: Leaving directory '/home/jon/projects/bitcoin/bitcoin/src'\r\nmake[1]: *** [Makefile:18858: all-recursive] Error 1\r\nmake[1]: Leaving directory '/home/jon/projects/bitcoin/bitcoin/src'\r\nmake: *** [Makefile:790: all-recursive] Error 1\r\n```\r\n</p></details>\r\n\r\nappeased the compiler and moving forward with review",
    "created_at": "2020-08-21T13:02:12Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r474682022",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474682022"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r474682022"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474682022/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 804,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474684477",
    "pull_request_review_id": 472471550,
    "id": 474684477,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDY4NDQ3Nw==",
    "diff_hunk": "@@ -719,6 +723,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12\n+        if (!valid_header && size_or_shortid >= 0) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 125,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b9468fa767d1daa08924a9fefe5227b2f6688e53",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "When rebuilding, the compiler is warning about this now:\r\n```\r\nnet.cpp: In member function \u2018virtual CNetMessage V2TransportDeserializer::GetMessage(const unsigned char (&)[4], std::chrono::microseconds)\u2019:\r\nnet.cpp:839:46: warning: comparison is always true due to limited range of data type [-Wtype-limits]\r\n  839 |         if (!valid_header && size_or_shortid >= 0) {\r\n      |                              ~~~~~~~~~~~~~~~~^~~~\r\n```\r\n",
    "created_at": "2020-08-21T13:07:06Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r474684477",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474684477"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r474684477"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/474684477/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 839,
    "side": "RIGHT",
    "in_reply_to_id": 424750339
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476212704",
    "pull_request_review_id": 472606826,
    "id": 476212704,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIxMjcwNA==",
    "diff_hunk": "@@ -316,4 +318,160 @@ BOOST_AUTO_TEST_CASE(PoissonNextSend)\n     g_mock_deterministic_tests = false;\n }\n \n+size_t read_message(std::unique_ptr<TransportDeserializer>& deserializer, const std::vector<unsigned char>& serialized_header, const CSerializedNetMsg& msg)\n+{\n+    size_t read_bytes = 0;\n+    if (serialized_header.size() > 0) read_bytes += deserializer->Read((const char*)serialized_header.data(), serialized_header.size());\n+    //  second: read the encrypted payload (if required)\n+    if (msg.data.size() > 0) read_bytes += deserializer->Read((const char*)msg.data.data(), msg.data.size());\n+    if (msg.data.size() > read_bytes && msg.data.size() - read_bytes > 0) read_bytes += deserializer->Read((const char*)msg.data.data() + read_bytes, msg.data.size() - read_bytes);\n+    return read_bytes;\n+}\n+\n+// use 32 byte keys with all zeros\n+static const CPrivKey k1(32, 0);\n+static const CPrivKey k2(32, 0);\n+static const uint256 session_id;\n+\n+void message_serialize_deserialize_test(bool v2, const std::vector<CSerializedNetMsg>& test_msgs)\n+{\n+    // construct the serializers\n+    std::unique_ptr<TransportSerializer> serializer;\n+    std::unique_ptr<TransportDeserializer> deserializer;\n+\n+    if (v2) {\n+        serializer = MakeUnique<V2TransportSerializer>(V2TransportSerializer(k1, k2, session_id));\n+        deserializer = MakeUnique<V2TransportDeserializer>(V2TransportDeserializer(k1, k2, session_id));\n+    } else {\n+        serializer = MakeUnique<V1TransportSerializer>(V1TransportSerializer());\n+        deserializer = MakeUnique<V1TransportDeserializer>(V1TransportDeserializer(Params().MessageStart(), SER_NETWORK, INIT_PROTO_VERSION));\n+    }\n+    // run a couple of times through all messages with the same AEAD instance\n+    for (unsigned int i = 0; i < 100; i++) {",
    "path": "src/test/net_tests.cpp",
    "position": 30,
    "original_position": 46,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b1ef92ae52e7df88376dcc63507c50879fa15386",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "7fb32f34 nit, here and lines 387, 394, 418, and 499, prefix increment iterator `++i` preferred",
    "created_at": "2020-08-25T06:43:30Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r476212704",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476212704"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r476212704"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476212704/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 951,
    "original_line": 951,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476217691",
    "pull_request_review_id": 472606826,
    "id": 476217691,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIxNzY5MQ==",
    "diff_hunk": "@@ -736,6 +740,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, std::chrono::microseconds time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if decryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AAD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12\n+        if (!valid_header && size_or_shortid >= 0) {\n+            valid_header = true;\n+            if (!GetCommandFromShortCommandID(size_or_shortid, command_name)) {\n+                // unknown-short-id\n+                //  results in a valid but unknown message (will be skipped)\n+                command_name = \"unknown-\" + ToString(size_or_shortid);\n+            }\n+        }\n+    }\n+    // increase the aad_pos and eventually the sequence number\n+    m_aad_pos += CHACHA20_POLY1305_AEAD_AAD_LEN;\n+    if (m_aad_pos + CHACHA20_POLY1305_AEAD_AAD_LEN > CHACHA20_ROUND_OUTPUT) {\n+        m_aad_pos = 0;\n+        m_aad_seqnr++;\n+    }\n+    // increase the payload sequence number by 1\n+    m_payload_seqnr++;\n+\n+    // decompose a single CNetMessage from the TransportDeserializer\n+    CNetMessage msg(std::move(vRecv)); // result in a message with CDataStream with readpos pointing to the message payload\n+    msg.m_command = command_name;\n+\n+    // store state about valid header, netmagic and checksum\n+    msg.m_valid_header = valid_header; // not relevant for v2, always pass\n+    msg.m_valid_checksum = valid_checksum;\n+    msg.m_valid_netmagic = true; // not relevant for v2, always pass\n+\n+    // if we could successfully decrypt the message, the message no longer contains the \"header\" (AAD & MAC)\n+    // if failed to decrypt \u2013 which we tolerate at this point \u2013 we need to reduce the message size by the length of the AAD & MAC\n+    // to conform to the abstract TransportDeserializer protocol\n+    msg.m_message_size = valid_checksum ? msg.m_recv.size() : (msg.m_recv.size() - CHACHA20_POLY1305_AEAD_AAD_LEN - CHACHA20_POLY1305_AEAD_TAG_LEN);\n+    msg.m_raw_message_size = CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN; // raw wire size\n+\n+    const int64_t now = GetTime();",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 158,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b1ef92ae52e7df88376dcc63507c50879fa15386",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "2bc6e8b here in `GetMessage()`, as well as below, line 967 in `prepareForTransport`, `GetTime()` is deprecated per `util/time.h`:\r\n```cpp\r\n/**\r\n * DEPRECATED\r\n * Use either GetSystemTimeInSeconds (not mockable) or GetTime<T> (mockable)\r\n */\r\nint64_t GetTime();\r\n```\r\n",
    "created_at": "2020-08-25T06:54:44Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r476217691",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476217691"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r476217691"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476217691/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 925,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476221476",
    "pull_request_review_id": 472606826,
    "id": 476221476,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjIyMTQ3Ng==",
    "diff_hunk": "@@ -743,6 +745,66 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, std::chrono::microseconds time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS\n+\n+/** V2TransportDeserializer is a transport deserializer after BIP324 */\n+class V2TransportDeserializer : public TransportDeserializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_decrypted = 0; // counter of bytes decrypted under the same key\n+    int64_t m_time_last_rekey = 0;  // recorded time when the last rekey happened\n+    uint256 m_session_id;           // the encryption session_id, relevant for rekeying",
    "path": "src/net.h",
    "position": null,
    "original_position": 33,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b1ef92ae52e7df88376dcc63507c50879fa15386",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "2bc6e8bc6e9 perhaps set a default value for `m_session_id`",
    "created_at": "2020-08-25T07:02:37Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r476221476",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476221476"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r476221476"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/476221476/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 846,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478349547",
    "pull_request_review_id": 476630320,
    "id": 478349547,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM0OTU0Nw==",
    "diff_hunk": "@@ -743,6 +745,66 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, std::chrono::microseconds time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS\n+\n+/** V2TransportDeserializer is a transport deserializer after BIP324 */\n+class V2TransportDeserializer : public TransportDeserializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_decrypted = 0; // counter of bytes decrypted under the same key\n+    int64_t m_time_last_rekey = 0;  // recorded time when the last rekey happened\n+    uint256 m_session_id;           // the encryption session_id, relevant for rekeying",
    "path": "src/net.h",
    "position": null,
    "original_position": 33,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b1ef92ae52e7df88376dcc63507c50879fa15386",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "AFAIK uint256 has always a default of zero.",
    "created_at": "2020-08-27T11:35:18Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r478349547",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478349547"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r478349547"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478349547/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 846,
    "side": "RIGHT",
    "in_reply_to_id": 476221476
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478366404",
    "pull_request_review_id": 476651620,
    "id": 478366404,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODM2NjQwNA==",
    "diff_hunk": "@@ -719,6 +723,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, int64_t time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if encryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.\n+            valid_header = true;\n+\n+            // use direct read since we already read the varlens size uint8_t\n+            command_name.resize(size_or_shortid);\n+            vRecv.read(&command_name[0], size_or_shortid);\n+        }\n+        // try for short ID in case the first byte is a number larger than 12\n+        if (!valid_header && size_or_shortid >= 0) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 125,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b9468fa767d1daa08924a9fefe5227b2f6688e53",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I just removed the `size_or_shortid >= 0` check (your right,.. it's always true).\r\nThe `(!valid_header)` check is necessary though,... in case `vRecv >> size_or_shortid` failed (can't happen?!) or if it contains a value greater than 12 or if below 12, the remaining buffer doesn't have the expected size.",
    "created_at": "2020-08-27T12:05:02Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r478366404",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478366404"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r478366404"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478366404/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 839,
    "side": "RIGHT",
    "in_reply_to_id": 424750339
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478730164",
    "pull_request_review_id": 477126709,
    "id": 478730164,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODczMDE2NA==",
    "diff_hunk": "@@ -743,6 +745,66 @@ class V1TransportDeserializer final : public TransportDeserializer\n     CNetMessage GetMessage(const CMessageHeader::MessageStartChars& message_start, std::chrono::microseconds time) override;\n };\n \n+// ChaCha20 must never reuse a {key, nonce} for encryption nor may it be\n+// used to encrypt more than 2^70 bytes under the same {key, nonce}\n+// Re-key after 1GB (RFC4253 / SSH recommendation) or after 1h\n+static constexpr unsigned int REKEY_LIMIT_BYTES = (1024 * 1024 * 1024);\n+static constexpr unsigned int REKEY_LIMIT_TIME = 3600;\n+static constexpr unsigned int REKEY_ABORT_LIMIT_BYTES = REKEY_LIMIT_BYTES * 1.1; // abort after ~10% tolerance buffer\n+static constexpr unsigned int REKEY_ABORT_LIMIT_TIME = REKEY_LIMIT_BYTES * 1.1;  // abort after ~10% tolerance buffer\n+static constexpr unsigned int MIN_REKEY_TIME = 10;                               // minimal rekey time to avoid DOS\n+\n+/** V2TransportDeserializer is a transport deserializer after BIP324 */\n+class V2TransportDeserializer : public TransportDeserializer\n+{\n+private:\n+    std::unique_ptr<ChaCha20Poly1305AEAD> m_aead;\n+    CPrivKey m_aead_k1; //keep the keys for later rekeying\n+    CPrivKey m_aead_k2;\n+    uint64_t m_bytes_decrypted = 0; // counter of bytes decrypted under the same key\n+    int64_t m_time_last_rekey = 0;  // recorded time when the last rekey happened\n+    uint256 m_session_id;           // the encryption session_id, relevant for rekeying",
    "path": "src/net.h",
    "position": null,
    "original_position": 33,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "b1ef92ae52e7df88376dcc63507c50879fa15386",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Indeed, you are right; in `uint256.h` the default constructor zeroes it out with \n`memset(data, 0, sizeof(data));`.",
    "created_at": "2020-08-27T22:27:52Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r478730164",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478730164"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r478730164"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/478730164/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 846,
    "side": "RIGHT",
    "in_reply_to_id": 476221476
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485704527",
    "pull_request_review_id": 485132207,
    "id": 485704527,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcwNDUyNw==",
    "diff_hunk": "@@ -751,6 +922,92 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    Optional<uint8_t> cmd_short_id = GetShortCommandIDFromCommand(msg.m_type);\n+    if (!cmd_short_id) {\n+        // message command without an assigned short-ID\n+        assert(msg.m_type.size() <= NET_P2P_V2_CMD_MAX_CHARS_SIZE);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.m_type, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AAD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);",
    "path": "src/net.cpp",
    "position": 152,
    "original_position": 218,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e549e76f244fe4852141fe5331ef694b0b7d560a",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The 4 bytes reservation is optimistically ? Maybe a ternary above to pick up between 1-byte short-ID and ASCII command string ?",
    "created_at": "2020-09-09T15:30:27Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485704527",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485704527"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485704527"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485704527/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 904,
    "original_line": 904,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485708764",
    "pull_request_review_id": 485132207,
    "id": 485708764,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcwODc2NA==",
    "diff_hunk": "@@ -751,6 +922,92 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    Optional<uint8_t> cmd_short_id = GetShortCommandIDFromCommand(msg.m_type);\n+    if (!cmd_short_id) {\n+        // message command without an assigned short-ID\n+        assert(msg.m_type.size() <= NET_P2P_V2_CMD_MAX_CHARS_SIZE);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.m_type, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AAD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID or (eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id.value();\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.m_type;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow separate buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + CHACHA20_POLY1305_AEAD_TAG_LEN, 0);\n+\n+    // length is only allowed up to 2^23 (bit24 is used for indicating rekey)\n+    bool bit24 = msg.data[2] & (1u << 7);\n+    assert(!bit24);\n+\n+    // check if we should rekey after this message\n+    const std::chrono::milliseconds now = GetTime<std::chrono::milliseconds>(); //TODO: check how expansive the GetTime call is and if it is avoidable\n+    bool rekey = false;\n+    if (m_bytes_encrypted >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 32 * 1024 : REKEY_LIMIT_BYTES) || now - m_time_last_rekey >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? REKEY_LIMIT_TIME_TEST : REKEY_LIMIT_TIME)) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 249,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e549e76f244fe4852141fe5331ef694b0b7d560a",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Maybe add a constant for `32 * 1024` as we have for time ? Also do we have a setting prefix for testing only flag like `netencryptionfastrekey` to underscore further it's a test-only flag ?",
    "created_at": "2020-09-09T15:36:31Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485708764",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485708764"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485708764"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485708764/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 971,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485723574",
    "pull_request_review_id": 485132207,
    "id": 485723574,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcyMzU3NA==",
    "diff_hunk": "@@ -798,6 +861,27 @@ class V1TransportSerializer  : public TransportSerializer {\n     void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) override;\n };\n \n+class V2TransportSerializer : public TransportSerializer",
    "path": "src/net.h",
    "position": null,
    "original_position": 83,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e549e76f244fe4852141fe5331ef694b0b7d560a",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: Add reference to BIP324 compliance.",
    "created_at": "2020-09-09T15:57:20Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485723574",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485723574"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485723574"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485723574/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 891,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485724726",
    "pull_request_review_id": 485132207,
    "id": 485724726,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTcyNDcyNg==",
    "diff_hunk": "@@ -251,7 +252,17 @@ extern const char* WTXIDRELAY;\n }; // namespace NetMsgType\n \n /* Get a vector of all valid message types (see above) */\n-const std::vector<std::string>& getAllNetMessageTypes();\n+const std::map<uint8_t, std::string>& getAllNetMessageTypes();\n+\n+/** Short Command IDs are a low bandwidth representations of a message type\n+ *   The mapping is a peer to peer agreement",
    "path": "src/protocol.h",
    "position": 16,
    "original_position": 16,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e549e76f244fe4852141fe5331ef694b0b7d560a",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "\"with a default pre-shared one as provided by BIP324\"?",
    "created_at": "2020-09-09T15:59:02Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485724726",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485724726"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485724726"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485724726/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 270,
    "original_line": 270,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485736126",
    "pull_request_review_id": 485132207,
    "id": 485736126,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTczNjEyNg==",
    "diff_hunk": "@@ -718,6 +720,127 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 36,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9f81125a9e2abc48789d02a42765f7fa0396ce49",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I can't find this requirement in the BIP, not in \"Packet Handling\". Maybe you've already the change just withhold ?",
    "created_at": "2020-09-09T16:11:28Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485736126",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485736126"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485736126"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485736126/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 789,
    "side": "RIGHT",
    "in_reply_to_id": 417833895
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485751513",
    "pull_request_review_id": 485132207,
    "id": 485751513,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc1MTUxMw==",
    "diff_hunk": "@@ -42,6 +43,7 @@\n static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n #endif\n \n+#include <algorithm>",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 12,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e549e76f244fe4852141fe5331ef694b0b7d560a",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I compile without ?",
    "created_at": "2020-09-09T16:28:44Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485751513",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485751513"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485751513"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485751513/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 37,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485754978",
    "pull_request_review_id": 485132207,
    "id": 485754978,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTc1NDk3OA==",
    "diff_hunk": "@@ -738,6 +742,173 @@ CNetMessage V1TransportDeserializer::GetMessage(const CMessageHeader::MessageSta\n     return msg;\n }\n \n+int V2TransportDeserializer::Read(const char* pch, unsigned int bytes)\n+{\n+    if (!m_in_data) {\n+        // copy data to temporary parsing buffer\n+        const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        memcpy(&vRecv[m_hdr_pos], pch, copy_bytes);\n+        m_hdr_pos += copy_bytes;\n+\n+        // if AAD incomplete, exit\n+        if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+            return copy_bytes;\n+        }\n+\n+        // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+        // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+        if (!m_aead->GetLength(&m_message_size, m_aad_seqnr, m_aad_pos, (const uint8_t*)vRecv.data())) {\n+            return -1;\n+        }\n+\n+        // check and unset rekey bit\n+        // the counterparty can signal a post-this-message rekey by setting the\n+        // most significant bit in the (unencrypted) length\n+        m_rekey_flag = static_cast<bool>(m_message_size & (1U << 23));\n+        if (m_rekey_flag) {\n+            LogPrint(BCLog::NET, \"Rekey flag detected\\n\");\n+            m_message_size &= ~(1U << 23);\n+        }\n+\n+        // reject messages larger than MAX_SIZE\n+        if (m_message_size > MAX_SIZE) {\n+            return -1;\n+        }\n+\n+        // switch state to reading message data\n+        m_in_data = true;\n+\n+        return copy_bytes;\n+    } else {\n+        // Read the message data (command, payload & MAC)\n+        const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+        const unsigned int copy_bytes = std::min(remaining, bytes);\n+\n+        // extend buffer, respect previous copied AAD part\n+        if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+            // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+            vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+        }\n+\n+        memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], pch, copy_bytes);\n+        m_data_pos += copy_bytes;\n+\n+        return copy_bytes;\n+    }\n+}\n+\n+CNetMessage V2TransportDeserializer::GetMessage(const CMessageHeader::MessageStartChars& message_start, std::chrono::microseconds time)\n+{\n+    // In v2, vRecv contains the encrypted payload plus the MAC tag (1+bytes serialized message command + ? bytes message payload + 16 byte mac tag)\n+    assert(Complete());\n+\n+    // defensive decoding (MAC check, decryption, command deserialization)\n+    // we'll always return a CNetMessage (even if decryption fails), we always increase the AEAD sequence numbers\n+    bool valid_checksum = false;\n+    bool valid_header = false;\n+    std::string command_name;\n+\n+    // count bytes we decrypted including MAC tag + AAD\n+    m_bytes_decrypted += vRecv.size();\n+\n+    if (m_aead->Crypt(m_payload_seqnr, m_aad_seqnr, m_aad_pos, (unsigned char*)vRecv.data(), vRecv.size(), (const uint8_t*)vRecv.data(), vRecv.size(), false)) {\n+        // MAC check was successful\n+        valid_checksum = true;\n+\n+        // okay, we could decrypt it, now remove packet length and MAC tag\n+        assert(vRecv.size() > CHACHA20_POLY1305_AEAD_AAD_LEN + CHACHA20_POLY1305_AEAD_TAG_LEN);\n+        // CDataStream::erase at the begin will just increase the read pos\n+        vRecv.erase(vRecv.begin(), vRecv.begin() + CHACHA20_POLY1305_AEAD_AAD_LEN);\n+        vRecv.erase(vRecv.end() - CHACHA20_POLY1305_AEAD_TAG_LEN, vRecv.end());\n+\n+        uint8_t size_or_shortid = 0;\n+        try {\n+            vRecv >> size_or_shortid;\n+        } catch (const std::ios_base::failure&) {\n+            LogPrint(BCLog::NET, \"Invalid command name\\n\");\n+        }\n+        if (size_or_shortid > 0 && size_or_shortid <= NET_P2P_V2_CMD_MAX_CHARS_SIZE && vRecv.size() >= size_or_shortid) {\n+            // first byte is a number between 1 and 12. Must be a string command.",
    "path": "src/net.cpp",
    "position": 96,
    "original_position": 117,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e549e76f244fe4852141fe5331ef694b0b7d560a",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Not straightforward to understand IMO. Maybe \"first byte encode the char-length of a string command bounded between 1 to 12\" ?",
    "created_at": "2020-09-09T16:32:44Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485754978",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485754978"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r485754978"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485754978/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 848,
    "original_line": 848,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486191890",
    "pull_request_review_id": 485743701,
    "id": 486191890,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE5MTg5MA==",
    "diff_hunk": "@@ -751,6 +922,92 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    Optional<uint8_t> cmd_short_id = GetShortCommandIDFromCommand(msg.m_type);\n+    if (!cmd_short_id) {\n+        // message command without an assigned short-ID\n+        assert(msg.m_type.size() <= NET_P2P_V2_CMD_MAX_CHARS_SIZE);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.m_type, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AAD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);\n+    // LE serialize the 24bits length\n+    // we do \"manually\" encode this since there is no helper for 24bit serialization\n+    packet_length = htole32(packet_length);\n+    memcpy(serialized_header.data(), &packet_length, 3);\n+\n+    // append the short-ID or (eventually) the varstr of the command\n+    CVectorWriter vector_writer(SER_NETWORK, INIT_PROTO_VERSION, serialized_header, 3);\n+    if (cmd_short_id) {\n+        // append the single byte short ID...\n+        vector_writer << cmd_short_id.value();\n+    } else {\n+        // or the ASCII command string\n+        vector_writer << msg.m_type;\n+    }\n+\n+    // insert header directly into the CSerializedNetMsg data buffer (insert at begin)\n+    // TODO: if we refactor the ChaCha20Poly1350 crypt function to allow separate buffers for\n+    //       the AD, payload and MAC, we could avoid a insert and thus a potential reallocation\n+    msg.data.insert(msg.data.begin(), serialized_header.begin(), serialized_header.end());\n+\n+    // resize the message buffer to make space for the MAC tag\n+    msg.data.resize(msg.data.size() + CHACHA20_POLY1305_AEAD_TAG_LEN, 0);\n+\n+    // length is only allowed up to 2^23 (bit24 is used for indicating rekey)\n+    bool bit24 = msg.data[2] & (1u << 7);\n+    assert(!bit24);\n+\n+    // check if we should rekey after this message\n+    const std::chrono::milliseconds now = GetTime<std::chrono::milliseconds>(); //TODO: check how expansive the GetTime call is and if it is avoidable\n+    bool rekey = false;\n+    if (m_bytes_encrypted >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? 32 * 1024 : REKEY_LIMIT_BYTES) || now - m_time_last_rekey >= (gArgs.GetBoolArg(\"-netencryptionfastrekey\", false) ? REKEY_LIMIT_TIME_TEST : REKEY_LIMIT_TIME)) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 249,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e549e76f244fe4852141fe5331ef694b0b7d560a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I was trying to avoid additional constants for internal test purposes only. Sadly, we don't have a general test-only flag so far.",
    "created_at": "2020-09-10T09:19:54Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r486191890",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486191890"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r486191890"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486191890/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 971,
    "side": "RIGHT",
    "in_reply_to_id": 485708764
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486194276",
    "pull_request_review_id": 485746707,
    "id": 486194276,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE5NDI3Ng==",
    "diff_hunk": "@@ -751,6 +922,92 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n+void V2TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header)\n+{\n+    size_t serialized_command_size = 1; // short-IDs are 1 byte\n+    Optional<uint8_t> cmd_short_id = GetShortCommandIDFromCommand(msg.m_type);\n+    if (!cmd_short_id) {\n+        // message command without an assigned short-ID\n+        assert(msg.m_type.size() <= NET_P2P_V2_CMD_MAX_CHARS_SIZE);\n+        // encode as varstr, max 12 chars\n+        serialized_command_size = ::GetSerializeSize(msg.m_type, PROTOCOL_VERSION);\n+    }\n+    // prepare the packet length that will later be encrypted and part of the MAC (AD)\n+    // the packet length excludes the 16 byte MAC tag\n+    uint32_t packet_length = serialized_command_size + msg.data.size();\n+\n+    // prepare the packet length & message command and reserve 4 bytes (3bytes AAD + 1byte short-ID)\n+    std::vector<unsigned char> serialized_header(CHACHA20_POLY1305_AEAD_AAD_LEN + 1);",
    "path": "src/net.cpp",
    "position": 152,
    "original_position": 218,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e549e76f244fe4852141fe5331ef694b0b7d560a",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Do you mean reserve additional bytes to avoid further buffer re-allocations? I guess 4 bytes will be sufficient for a couple of messages (like `ping`, `sendheaders`, etc.). I would also expect that the internal allocation is larger then 4 bytes anyways. Though I'm not opposed to reserve always a minimum of 64bytes which should find a single inv (most sent message?).",
    "created_at": "2020-09-10T09:23:42Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r486194276",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486194276"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r486194276"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486194276/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 904,
    "original_line": 904,
    "side": "RIGHT",
    "in_reply_to_id": 485704527
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486199951",
    "pull_request_review_id": 485754085,
    "id": 486199951,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE5OTk1MQ==",
    "diff_hunk": "@@ -42,6 +43,7 @@\n static_assert(MINIUPNPC_API_VERSION >= 10, \"miniUPnPc API version >= 10 assumed\");\n #endif\n \n+#include <algorithm>",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 12,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "e549e76f244fe4852141fe5331ef694b0b7d560a",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The added code uses functions from `https://en.cppreference.com/w/cpp/header/algorithm`. Per the developer notes, every `.cpp` and `.h` file should `#include` every header file it directly uses classes, functions or other definitions from, even if those headers are already included indirectly through other headers. ",
    "created_at": "2020-09-10T09:32:45Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r486199951",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486199951"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r486199951"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486199951/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 37,
    "side": "RIGHT",
    "in_reply_to_id": 485751513
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/516582625",
    "pull_request_review_id": 522385645,
    "id": 516582625,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU4MjYyNQ==",
    "diff_hunk": "@@ -758,13 +759,20 @@ test_fuzz_out_point_deserialize_CPPFLAGS = $(AM_CPPFLAGS) $(BITCOIN_INCLUDES) -D\n test_fuzz_out_point_deserialize_CXXFLAGS = $(AM_CXXFLAGS) $(PIE_FLAGS)\n test_fuzz_out_point_deserialize_LDADD = $(FUZZ_SUITE_LD_COMMON)\n test_fuzz_out_point_deserialize_LDFLAGS = $(FUZZ_SUITE_LDFLAGS_COMMON)\n+test_fuzz_out_point_de=serialize_SOURCES = test/fuzz/deserialize.cpp",
    "path": "src/Makefile.test.include",
    "position": null,
    "original_position": 14,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "2580d64c9fa1c32334fcca52bfb62b1c80d80625",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "88f1e620b maybe a typo \r\n```suggestion\r\ntest_fuzz_out_point_deserialize_SOURCES = test/fuzz/deserialize.cpp\r\n```",
    "created_at": "2020-11-03T10:59:48Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r516582625",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/516582625"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r516582625"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/516582625/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 762,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/516587453",
    "pull_request_review_id": 522391917,
    "id": 516587453,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU4NzQ1Mw==",
    "diff_hunk": "@@ -758,13 +759,20 @@ test_fuzz_out_point_deserialize_CPPFLAGS = $(AM_CPPFLAGS) $(BITCOIN_INCLUDES) -D\n test_fuzz_out_point_deserialize_CXXFLAGS = $(AM_CXXFLAGS) $(PIE_FLAGS)\n test_fuzz_out_point_deserialize_LDADD = $(FUZZ_SUITE_LD_COMMON)\n test_fuzz_out_point_deserialize_LDFLAGS = $(FUZZ_SUITE_LDFLAGS_COMMON)\n+test_fuzz_out_point_de=serialize_SOURCES = test/fuzz/deserialize.cpp",
    "path": "src/Makefile.test.include",
    "position": null,
    "original_position": 14,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "2580d64c9fa1c32334fcca52bfb62b1c80d80625",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Indeed. Rebase mistake. Fixed now.",
    "created_at": "2020-11-03T11:08:24Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r516587453",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/516587453"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r516587453"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/516587453/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 762,
    "side": "RIGHT",
    "in_reply_to_id": 516582625
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/516613219",
    "pull_request_review_id": 522425070,
    "id": 516613219,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYxMzIxOQ==",
    "diff_hunk": "@@ -758,13 +759,20 @@ test_fuzz_out_point_deserialize_CPPFLAGS = $(AM_CPPFLAGS) $(BITCOIN_INCLUDES) -D\n test_fuzz_out_point_deserialize_CXXFLAGS = $(AM_CXXFLAGS) $(PIE_FLAGS)\n test_fuzz_out_point_deserialize_LDADD = $(FUZZ_SUITE_LD_COMMON)\n test_fuzz_out_point_deserialize_LDFLAGS = $(FUZZ_SUITE_LDFLAGS_COMMON)\n+test_fuzz_out_point_de=serialize_SOURCES = test/fuzz/deserialize.cpp",
    "path": "src/Makefile.test.include",
    "position": null,
    "original_position": 14,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "2580d64c9fa1c32334fcca52bfb62b1c80d80625",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks. Noting `git range-diff 218fe60 e549e76 76ce46f` here for my re-reviewing. Would be great to get this in soon.",
    "created_at": "2020-11-03T11:56:41Z",
    "updated_at": "2021-01-20T09:24:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r516613219",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/516613219"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r516613219"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/516613219/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 762,
    "side": "RIGHT",
    "in_reply_to_id": 516582625
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592829922",
    "pull_request_review_id": 610359701,
    "id": 592829922,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5MjgyOTkyMg==",
    "diff_hunk": "@@ -17,26 +17,36 @@ void initialize_p2p_transport_deserializer()\n     SelectParams(CBaseChainParams::REGTEST);\n }\n \n-FUZZ_TARGET_INIT(p2p_transport_deserializer, initialize_p2p_transport_deserializer)\n-{\n-    // Construct deserializer, with a dummy NodeId\n-    V1TransportDeserializer deserializer{Params(), (NodeId)0, SER_NETWORK, INIT_PROTO_VERSION};\n-    Span<const uint8_t> msg_bytes{buffer};\n+void test_deserializer(std::unique_ptr<TransportDeserializer>& deserializer, Span<const uint8_t> msg_bytes, const int header_size) {\n+    size_t original_size = msg_bytes.size();\n     while (msg_bytes.size() > 0) {\n-        const int handled = deserializer.Read(msg_bytes);\n+        const int handled = deserializer->Read(msg_bytes);\n         if (handled < 0) {\n             break;\n         }\n-        if (deserializer.Complete()) {\n+        if (deserializer->Complete()) {\n             const std::chrono::microseconds m_time{std::numeric_limits<int64_t>::max()};\n             uint32_t out_err_raw_size{0};\n-            Optional<CNetMessage> result{deserializer.GetMessage(m_time, out_err_raw_size)};\n+            Optional<CNetMessage> result{deserializer->GetMessage(m_time, out_err_raw_size)};\n             if (result) {\n                 assert(result->m_command.size() <= CMessageHeader::COMMAND_SIZE);\n-                assert(result->m_raw_message_size <= buffer.size());\n-                assert(result->m_raw_message_size == CMessageHeader::HEADER_SIZE + result->m_message_size);\n+                assert(result->m_raw_message_size <= original_size);\n+                assert(result->m_raw_message_size == header_size + result->m_message_size);\n                 assert(result->m_time == m_time);\n             }\n         }\n     }\n }\n+FUZZ_TARGET_INIT(p2p_transport_deserializer, initialize_p2p_transport_deserializer)\n+{\n+    // Construct deserializer, with a dummy NodeId\n+    std::unique_ptr<TransportDeserializer> v1_deserializer = MakeUnique<V1TransportDeserializer>(Params(), (NodeId)0, SER_NETWORK, INIT_PROTO_VERSION);",
    "path": "src/test/fuzz/p2p_transport_deserializer.cpp",
    "position": 37,
    "original_position": 37,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "user": {
      "login": "fanquake",
      "id": 863730,
      "node_id": "MDQ6VXNlcjg2MzczMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fanquake",
      "html_url": "https://github.com/fanquake",
      "followers_url": "https://api.github.com/users/fanquake/followers",
      "following_url": "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url": "https://api.github.com/users/fanquake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
      "organizations_url": "https://api.github.com/users/fanquake/orgs",
      "repos_url": "https://api.github.com/users/fanquake/repos",
      "events_url": "https://api.github.com/users/fanquake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fanquake/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Please [use `std::make_unique` in new code](https://github.com/bitcoin/bitcoin/blob/master/src/util/memory.h#L13).",
    "created_at": "2021-03-12T00:38:58Z",
    "updated_at": "2021-03-12T00:38:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r592829922",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592829922"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r592829922"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/592829922/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 43,
    "original_line": 43,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594009430",
    "pull_request_review_id": 611782213,
    "id": 594009430,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDAwOTQzMA==",
    "diff_hunk": "@@ -767,6 +770,165 @@ Optional<CNetMessage> V1TransportDeserializer::GetMessage(const std::chrono::mic\n     return msg;\n }\n \n+int V2TransportDeserializer::readHeader(Span<const uint8_t> msg_bytes) {\n+    // copy data to temporary parsing buffer\n+    const unsigned int remaining = CHACHA20_POLY1305_AEAD_AAD_LEN - m_hdr_pos;\n+    const unsigned int copy_bytes = std::min<unsigned int>(remaining, msg_bytes.size());\n+\n+    memcpy(&vRecv[m_hdr_pos], msg_bytes.data(), copy_bytes);\n+    m_hdr_pos += copy_bytes;\n+\n+    // if AAD incomplete, exit\n+    if (m_hdr_pos < CHACHA20_POLY1305_AEAD_AAD_LEN) {\n+        return copy_bytes;\n+    }\n+\n+    // we got the AAD bytes at this point (3 bytes encrypted packet length)\n+    // we keep the sequence numbers unchanged at this point. Once the message is authenticated and decrypted, we increase the sequence numbers (or the aad_pos)\n+    if (!m_aead->DecryptLength(&m_message_size, (const uint8_t*)vRecv.data())) {\n+        return -1;\n+    }\n+\n+    // reject messages larger than MAX_SIZE\n+    if (m_message_size > MAX_SIZE) {\n+        return -1;\n+    }\n+\n+    // switch state to reading message data\n+    m_in_data = true;\n+\n+    return copy_bytes;\n+}\n+int V2TransportDeserializer::readData(Span<const uint8_t> msg_bytes) {\n+    // Read the message data (command, payload & MAC)\n+    const unsigned int remaining = m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN - m_data_pos;\n+    const unsigned int copy_bytes = std::min<unsigned int>(remaining, msg_bytes.size());\n+\n+    // extend buffer, respect previous copied AAD part\n+    if (vRecv.size() < CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes) {\n+        // Allocate up to 256 KiB ahead, but never more than the total message size (incl. AAD & TAG).\n+        vRecv.resize(std::min(CHACHA20_POLY1305_AEAD_AAD_LEN + m_message_size + CHACHA20_POLY1305_AEAD_TAG_LEN, CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos + copy_bytes + 256 * 1024 + CHACHA20_POLY1305_AEAD_TAG_LEN));\n+    }\n+\n+    memcpy(&vRecv[CHACHA20_POLY1305_AEAD_AAD_LEN + m_data_pos], msg_bytes.data(), copy_bytes);\n+    m_data_pos += copy_bytes;\n+\n+    return copy_bytes;\n+}\n+\n+Optional<CNetMessage> V2TransportDeserializer::GetMessage(std::chrono::microseconds time, uint32_t& out_err_raw_size)",
    "path": "src/net.cpp",
    "position": 67,
    "original_position": 67,
    "commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "original_commit_id": "9e81bc49b1de0e084fdc7baeb48bb39b8550ca89",
    "user": {
      "login": "fanquake",
      "id": 863730,
      "node_id": "MDQ6VXNlcjg2MzczMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fanquake",
      "html_url": "https://github.com/fanquake",
      "followers_url": "https://api.github.com/users/fanquake/followers",
      "following_url": "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url": "https://api.github.com/users/fanquake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
      "organizations_url": "https://api.github.com/users/fanquake/orgs",
      "repos_url": "https://api.github.com/users/fanquake/repos",
      "events_url": "https://api.github.com/users/fanquake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fanquake/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Please [use `std::optional` in new code](https://github.com/bitcoin/bitcoin/blob/master/src/optional.h#L12).",
    "created_at": "2021-03-15T02:18:10Z",
    "updated_at": "2021-03-15T02:18:10Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r594009430",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594009430"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18242#discussion_r594009430"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18242"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/594009430/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 819,
    "original_line": 819,
    "side": "RIGHT"
  }
]