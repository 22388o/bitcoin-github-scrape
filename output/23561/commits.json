[
  {
    "sha": "e5d609619f5e8361df0e479654a49bb0f74e1ed9",
    "node_id": "C_kwDOABII59oAKGU1ZDYwOTYxOWY1ZTgzNjFkZjBlNDc5NjU0YTQ5YmIwZjc0ZTFlZDk",
    "commit": {
      "author": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2021-11-11T19:58:13Z"
      },
      "committer": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2021-11-25T16:43:17Z"
      },
      "message": "Enable ECDH computation on secp256k1 keys",
      "tree": {
        "sha": "bad9a8d411235bd6a1e79bdd2b96af835feb0897",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/bad9a8d411235bd6a1e79bdd2b96af835feb0897"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e5d609619f5e8361df0e479654a49bb0f74e1ed9",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e5d609619f5e8361df0e479654a49bb0f74e1ed9",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e5d609619f5e8361df0e479654a49bb0f74e1ed9",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e5d609619f5e8361df0e479654a49bb0f74e1ed9/comments",
    "author": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "bc03823e26d1bf0cca679ce9330f9c6a58b33faf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bc03823e26d1bf0cca679ce9330f9c6a58b33faf",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/bc03823e26d1bf0cca679ce9330f9c6a58b33faf"
      }
    ],
    "stats": {
      "total": 47,
      "additions": 46,
      "deletions": 1
    },
    "files": [
      {
        "sha": "e7848efcf266a8bc67c3716857b9cf7ae8ecc479",
        "filename": "configure.ac",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e5d609619f5e8361df0e479654a49bb0f74e1ed9/configure.ac",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e5d609619f5e8361df0e479654a49bb0f74e1ed9/configure.ac",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/configure.ac?ref=e5d609619f5e8361df0e479654a49bb0f74e1ed9",
        "patch": "@@ -1869,7 +1869,7 @@ PKGCONFIG_LIBDIR_TEMP=\"$PKG_CONFIG_LIBDIR\"\n unset PKG_CONFIG_LIBDIR\n PKG_CONFIG_LIBDIR=\"$PKGCONFIG_LIBDIR_TEMP\"\n \n-ac_configure_args=\"${ac_configure_args} --disable-shared --with-pic --enable-benchmark=no --enable-module-recovery --enable-module-schnorrsig --enable-experimental --disable-openssl-tests\"\n+ac_configure_args=\"${ac_configure_args} --disable-shared --with-pic --enable-benchmark=no --enable-module-recovery --enable-module-schnorrsig --enable-module-ecdh -enable-experimental --disable-openssl-tests\"\n AC_CONFIG_SUBDIRS([src/secp256k1])\n \n AC_OUTPUT"
      },
      {
        "sha": "414d78399515f3bfdf5cd79de7b07c37b78c5852",
        "filename": "src/key.cpp",
        "status": "modified",
        "additions": 14,
        "deletions": 0,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e5d609619f5e8361df0e479654a49bb0f74e1ed9/src/key.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e5d609619f5e8361df0e479654a49bb0f74e1ed9/src/key.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/key.cpp?ref=e5d609619f5e8361df0e479654a49bb0f74e1ed9",
        "patch": "@@ -11,6 +11,7 @@\n #include <random.h>\n \n #include <secp256k1.h>\n+#include <secp256k1_ecdh.h>\n #include <secp256k1_extrakeys.h>\n #include <secp256k1_recovery.h>\n #include <secp256k1_schnorrsig.h>\n@@ -332,6 +333,19 @@ bool CKey::Derive(CKey& keyChild, ChainCode &ccChild, unsigned int nChild, const\n     return ret;\n }\n \n+bool CKey::ComputeECDHSecret(const CPubKey& pubkey, ECDHSecret& secret) const\n+{\n+    secp256k1_pubkey pubkey_internal;\n+    if (!secp256k1_ec_pubkey_parse(secp256k1_context_sign, &pubkey_internal, pubkey.data(), pubkey.size())) {\n+        return false;\n+    }\n+\n+    secret.resize(ECDH_SECRET_SIZE);\n+    assert(secp256k1_ecdh(secp256k1_context_sign, secret.data(), &pubkey_internal,\n+                          keydata.data(), secp256k1_ecdh_hash_function_default, NULL));\n+    return true;\n+}\n+\n bool CExtKey::Derive(CExtKey &out, unsigned int _nChild) const {\n     out.nDepth = nDepth + 1;\n     CKeyID id = key.GetPubKey().GetID();"
      },
      {
        "sha": "7b44aba1dfe42027feb2343ee659864307134ab8",
        "filename": "src/key.h",
        "status": "modified",
        "additions": 8,
        "deletions": 0,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e5d609619f5e8361df0e479654a49bb0f74e1ed9/src/key.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e5d609619f5e8361df0e479654a49bb0f74e1ed9/src/key.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/key.h?ref=e5d609619f5e8361df0e479654a49bb0f74e1ed9",
        "patch": "@@ -22,6 +22,11 @@\n  */\n typedef std::vector<unsigned char, secure_allocator<unsigned char> > CPrivKey;\n \n+constexpr static int ECDH_SECRET_SIZE = 32;\n+\n+// Used to represent a ECDH secret (ECDH_SECRET_SIZE bytes)\n+using ECDHSecret = std::vector<uint8_t, secure_allocator<uint8_t>>;\n+\n /** An encapsulated private key. */\n class CKey\n {\n@@ -156,6 +161,9 @@ class CKey\n \n     //! Load private key and check that public key matches.\n     bool Load(const CPrivKey& privkey, const CPubKey& vchPubKey, bool fSkipCheck);\n+\n+    // Returns false if an invalid public key is provided\n+    bool ComputeECDHSecret(const CPubKey& pubkey, ECDHSecret& secret) const;\n };\n \n struct CExtKey {"
      },
      {
        "sha": "3846691520a7b82290605854df6e3f0d4ebe1346",
        "filename": "src/test/key_tests.cpp",
        "status": "modified",
        "additions": 23,
        "deletions": 0,
        "changes": 23,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e5d609619f5e8361df0e479654a49bb0f74e1ed9/src/test/key_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e5d609619f5e8361df0e479654a49bb0f74e1ed9/src/test/key_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/key_tests.cpp?ref=e5d609619f5e8361df0e479654a49bb0f74e1ed9",
        "patch": "@@ -344,4 +344,27 @@ BOOST_AUTO_TEST_CASE(bip340_test_vectors)\n     }\n }\n \n+BOOST_AUTO_TEST_CASE(ecdh)\n+{\n+    CKey initiator_key = DecodeSecret(strSecret1);\n+    CKey responder_key = DecodeSecret(strSecret2C);\n+\n+    ECDHSecret initiator_secret, responder_secret;\n+    BOOST_CHECK(initiator_key.ComputeECDHSecret(responder_key.GetPubKey(), initiator_secret));\n+    BOOST_CHECK(responder_key.ComputeECDHSecret(initiator_key.GetPubKey(), responder_secret));\n+    BOOST_CHECK_EQUAL(initiator_secret.size(), ECDH_SECRET_SIZE);\n+    BOOST_CHECK_EQUAL(responder_secret.size(), ECDH_SECRET_SIZE);\n+    BOOST_CHECK_EQUAL(0, memcmp(initiator_secret.data(), responder_secret.data(), ECDH_SECRET_SIZE));\n+    BOOST_CHECK_EQUAL(\"265d994050fcf0c31c948b5e46cb9a5be7f373912d5d2bdf3fcfe053caa6a644\", HexStr(initiator_secret));\n+    BOOST_CHECK_EQUAL(\"265d994050fcf0c31c948b5e46cb9a5be7f373912d5d2bdf3fcfe053caa6a644\", HexStr(responder_secret));\n+\n+    // ECDH computation with invalid pubkey\n+    std::vector<unsigned char> pubkeydata;\n+    auto responder_pubkey = responder_key.GetPubKey();\n+    pubkeydata.insert(pubkeydata.end(), responder_pubkey.begin(), responder_pubkey.end());\n+    pubkeydata[0] = 0xFF;\n+    CPubKey invalid_responder_pubkey(pubkeydata);\n+    BOOST_CHECK(!initiator_key.ComputeECDHSecret(invalid_responder_pubkey, initiator_secret));\n+}\n+\n BOOST_AUTO_TEST_SUITE_END()"
      }
    ]
  },
  {
    "sha": "60f83a2859affab2873780a71622e864c57914d7",
    "node_id": "C_kwDOABII59oAKDYwZjgzYTI4NTlhZmZhYjI4NzM3ODBhNzE2MjJlODY0YzU3OTE0ZDc",
    "commit": {
      "author": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2021-11-17T18:50:57Z"
      },
      "committer": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2021-11-25T16:43:19Z"
      },
      "message": "Bench test for ECDH",
      "tree": {
        "sha": "2b8d982da04ef450a73a629ade64741511930775",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2b8d982da04ef450a73a629ade64741511930775"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/60f83a2859affab2873780a71622e864c57914d7",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/60f83a2859affab2873780a71622e864c57914d7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/60f83a2859affab2873780a71622e864c57914d7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/60f83a2859affab2873780a71622e864c57914d7/comments",
    "author": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e5d609619f5e8361df0e479654a49bb0f74e1ed9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e5d609619f5e8361df0e479654a49bb0f74e1ed9",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e5d609619f5e8361df0e479654a49bb0f74e1ed9"
      }
    ],
    "stats": {
      "total": 31,
      "additions": 31,
      "deletions": 0
    },
    "files": [
      {
        "sha": "66502c7153c438f0985909b8d80eb92f187fc0c3",
        "filename": "src/Makefile.bench.include",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/60f83a2859affab2873780a71622e864c57914d7/src/Makefile.bench.include",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/60f83a2859affab2873780a71622e864c57914d7/src/Makefile.bench.include",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/Makefile.bench.include?ref=60f83a2859affab2873780a71622e864c57914d7",
        "patch": "@@ -22,6 +22,7 @@ bench_bench_bitcoin_SOURCES = \\\n   bench/data.h \\\n   bench/data.cpp \\\n   bench/duplicate_inputs.cpp \\\n+  bench/ecdh.cpp \\\n   bench/examples.cpp \\\n   bench/rollingbloom.cpp \\\n   bench/chacha20.cpp \\"
      },
      {
        "sha": "84b941ba4d0503eb44e4582b8424fdbbf8691edf",
        "filename": "src/bench/ecdh.cpp",
        "status": "added",
        "additions": 30,
        "deletions": 0,
        "changes": 30,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/60f83a2859affab2873780a71622e864c57914d7/src/bench/ecdh.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/60f83a2859affab2873780a71622e864c57914d7/src/bench/ecdh.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bench/ecdh.cpp?ref=60f83a2859affab2873780a71622e864c57914d7",
        "patch": "@@ -0,0 +1,30 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+\n+#include <key.h>\n+#include <pubkey.h>\n+\n+CKey GetRandomKey()\n+{\n+    CKey key;\n+    key.MakeNewKey(true);\n+    return key;\n+}\n+\n+static void ECDH(benchmark::Bench& bench)\n+{\n+    ECC_Start();\n+    auto privkey = GetRandomKey();\n+    auto other_privkey = GetRandomKey();\n+    auto other_pubkey = other_privkey.GetPubKey();\n+    ECDHSecret ecdh_secret;\n+    bench.batch(1).unit(\"ecdh\").run([&] {\n+        privkey.ComputeECDHSecret(other_pubkey, ecdh_secret);\n+    });\n+    ECC_Stop();\n+}\n+\n+BENCHMARK(ECDH);"
      }
    ]
  },
  {
    "sha": "bd576c16ca2ad65b3985e0a86f55729519c80fc4",
    "node_id": "C_kwDOABII59oAKGJkNTc2YzE2Y2EyYWQ2NWIzOTg1ZTBhODZmNTU3Mjk1MTljODBmYzQ",
    "commit": {
      "author": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2021-11-18T19:48:55Z"
      },
      "committer": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2021-11-25T16:43:19Z"
      },
      "message": "Fuzz test for ECDH",
      "tree": {
        "sha": "39ba318e64fd944b8cd6e77f28211e4ffc76c966",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/39ba318e64fd944b8cd6e77f28211e4ffc76c966"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bd576c16ca2ad65b3985e0a86f55729519c80fc4",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bd576c16ca2ad65b3985e0a86f55729519c80fc4",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/bd576c16ca2ad65b3985e0a86f55729519c80fc4",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bd576c16ca2ad65b3985e0a86f55729519c80fc4/comments",
    "author": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "60f83a2859affab2873780a71622e864c57914d7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/60f83a2859affab2873780a71622e864c57914d7",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/60f83a2859affab2873780a71622e864c57914d7"
      }
    ],
    "stats": {
      "total": 32,
      "additions": 32,
      "deletions": 0
    },
    "files": [
      {
        "sha": "1461aa7c56b9708aec5972d938543d345a68f0ee",
        "filename": "src/test/fuzz/key.cpp",
        "status": "modified",
        "additions": 32,
        "deletions": 0,
        "changes": 32,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/bd576c16ca2ad65b3985e0a86f55729519c80fc4/src/test/fuzz/key.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/bd576c16ca2ad65b3985e0a86f55729519c80fc4/src/test/fuzz/key.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/fuzz/key.cpp?ref=bd576c16ca2ad65b3985e0a86f55729519c80fc4",
        "patch": "@@ -16,6 +16,7 @@\n #include <script/signingprovider.h>\n #include <script/standard.h>\n #include <streams.h>\n+#include <test/fuzz/FuzzedDataProvider.h>\n #include <test/fuzz/fuzz.h>\n #include <util/strencodings.h>\n \n@@ -306,3 +307,34 @@ FUZZ_TARGET_INIT(key, initialize_key)\n         }\n     }\n }\n+\n+FUZZ_TARGET_INIT(ecdh, initialize_key)\n+{\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+    auto rnd32 = fuzzed_data_provider.ConsumeBytes<uint8_t>(32);\n+    rnd32.resize(32);\n+    CKey k1;\n+    k1.Set(rnd32.begin(), rnd32.end(), true);\n+\n+    if (!k1.IsValid()) {\n+        return;\n+    }\n+\n+    rnd32 = fuzzed_data_provider.ConsumeBytes<uint8_t>(32);\n+    rnd32.resize(32);\n+    CKey k2;\n+    k2.Set(rnd32.begin(), rnd32.end(), true);\n+\n+    if (!k2.IsValid()) {\n+        return;\n+    }\n+\n+    CPubKey k1_pubkey = k1.GetPubKey();\n+    CPubKey k2_pubkey = k2.GetPubKey();\n+    ECDHSecret ecdh_secret_1, ecdh_secret_2;\n+    assert(k1.ComputeECDHSecret(k2_pubkey, ecdh_secret_1));\n+    assert(k2.ComputeECDHSecret(k1_pubkey, ecdh_secret_2));\n+    assert(ecdh_secret_1.size() == ECDH_SECRET_SIZE);\n+    assert(ecdh_secret_2.size() == ECDH_SECRET_SIZE);\n+    assert(memcmp(ecdh_secret_1.data(), ecdh_secret_2.data(), ECDH_SECRET_SIZE) == 0);\n+}"
      }
    ]
  },
  {
    "sha": "88185dc13bcb992b2bfef95c7bf12f2efca2d07b",
    "node_id": "C_kwDOABII59oAKDg4MTg1ZGMxM2JjYjk5MmIyYmZlZjk1YzdiZjEyZjJlZmNhMmQwN2I",
    "commit": {
      "author": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2021-11-16T19:54:47Z"
      },
      "committer": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2021-11-25T16:43:19Z"
      },
      "message": "HKDF key derivation from ECDH secret for BIP324",
      "tree": {
        "sha": "7505a06623a9534990f770e25baa35b5b9c64a68",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7505a06623a9534990f770e25baa35b5b9c64a68"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/88185dc13bcb992b2bfef95c7bf12f2efca2d07b",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/88185dc13bcb992b2bfef95c7bf12f2efca2d07b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/88185dc13bcb992b2bfef95c7bf12f2efca2d07b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/88185dc13bcb992b2bfef95c7bf12f2efca2d07b/comments",
    "author": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "bd576c16ca2ad65b3985e0a86f55729519c80fc4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bd576c16ca2ad65b3985e0a86f55729519c80fc4",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/bd576c16ca2ad65b3985e0a86f55729519c80fc4"
      }
    ],
    "stats": {
      "total": 115,
      "additions": 115,
      "deletions": 0
    },
    "files": [
      {
        "sha": "61a8c3a35194d5dbed725bcd028ba5f012037628",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 34,
        "deletions": 0,
        "changes": 34,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/88185dc13bcb992b2bfef95c7bf12f2efca2d07b/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/88185dc13bcb992b2bfef95c7bf12f2efca2d07b/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=88185dc13bcb992b2bfef95c7bf12f2efca2d07b",
        "patch": "@@ -14,6 +14,7 @@\n #include <clientversion.h>\n #include <compat.h>\n #include <consensus/consensus.h>\n+#include <crypto/hkdf_sha256_32.h>\n #include <crypto/sha256.h>\n #include <i2p.h>\n #include <net_permissions.h>\n@@ -23,6 +24,7 @@\n #include <protocol.h>\n #include <random.h>\n #include <scheduler.h>\n+#include <support/cleanse.h>\n #include <util/sock.h>\n #include <util/strencodings.h>\n #include <util/syscall_sandbox.h>\n@@ -399,6 +401,38 @@ static CAddress GetBindAddress(SOCKET sock)\n     return addr_bind;\n }\n \n+bool derive_bip324_keys(ECDHSecret&& ecdh_secret, const Span<uint8_t> initiator_hdata, const Span<uint8_t> responder_hdata, BIP324Keys& derived_keys)\n+{\n+    if (ecdh_secret.size() != ECDH_SECRET_SIZE) {\n+        return false;\n+    }\n+\n+    std::string salt{\"bitcoin_v2_shared_secret\"};\n+    salt += std::string{reinterpret_cast<const char*>(initiator_hdata.data()), initiator_hdata.size()};\n+    salt += std::string{reinterpret_cast<const char*>(responder_hdata.data()), responder_hdata.size()};\n+    salt += std::string{reinterpret_cast<const char*>(Params().MessageStart()), CMessageHeader::MESSAGE_START_SIZE};\n+\n+    CHKDF_HMAC_SHA256_L32 hkdf(ecdh_secret.data(), ecdh_secret.size(), salt);\n+\n+    derived_keys.initiator_F.resize(BIP324_KEY_LEN);\n+    hkdf.Expand32(\"initiator_F\", derived_keys.initiator_F.data());\n+\n+    derived_keys.initiator_V.resize(BIP324_KEY_LEN);\n+    hkdf.Expand32(\"initiator_V\", derived_keys.initiator_V.data());\n+\n+    derived_keys.responder_F.resize(BIP324_KEY_LEN);\n+    hkdf.Expand32(\"responder_F\", derived_keys.responder_F.data());\n+\n+    derived_keys.responder_V.resize(BIP324_KEY_LEN);\n+    hkdf.Expand32(\"responder_V\", derived_keys.responder_V.data());\n+\n+    derived_keys.session_id.resize(BIP324_KEY_LEN);\n+    hkdf.Expand32(\"session_id\", derived_keys.session_id.data());\n+\n+    memory_cleanse(ecdh_secret.data(), ecdh_secret.size());\n+    return true;\n+}\n+\n CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure, ConnectionType conn_type)\n {\n     assert(conn_type != ConnectionType::INBOUND);"
      },
      {
        "sha": "73f66292e65a5bb5b7768a4fc43bf672df10a466",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 17,
        "deletions": 0,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/88185dc13bcb992b2bfef95c7bf12f2efca2d07b/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/88185dc13bcb992b2bfef95c7bf12f2efca2d07b/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=88185dc13bcb992b2bfef95c7bf12f2efca2d07b",
        "patch": "@@ -14,6 +14,7 @@\n #include <crypto/siphash.h>\n #include <hash.h>\n #include <i2p.h>\n+#include <key.h>\n #include <net_permissions.h>\n #include <netaddress.h>\n #include <netbase.h>\n@@ -22,6 +23,7 @@\n #include <random.h>\n #include <span.h>\n #include <streams.h>\n+#include <support/allocators/secure.h>\n #include <sync.h>\n #include <threadinterrupt.h>\n #include <uint256.h>\n@@ -389,6 +391,21 @@ class V1TransportSerializer  : public TransportSerializer {\n     void prepareForTransport(CSerializedNetMsg& msg, std::vector<unsigned char>& header) override;\n };\n \n+constexpr size_t BIP324_KEY_LEN = 32;\n+\n+using BIP324Key = std::vector<uint8_t, secure_allocator<uint8_t>>;\n+\n+struct BIP324Keys {\n+    BIP324Key initiator_F;\n+    BIP324Key initiator_V;\n+    BIP324Key responder_F;\n+    BIP324Key responder_V;\n+    BIP324Key session_id;\n+};\n+\n+// Returns false if the ecdh_secret is malformed.\n+bool derive_bip324_keys(ECDHSecret&& ecdh_secret, const Span<uint8_t> initiator_hdata, const Span<uint8_t> responder_hdata, BIP324Keys& derived_keys);\n+\n /** Information about a peer */\n class CNode\n {"
      },
      {
        "sha": "8cdfde097c96d20a4d5abab50a5b7ae8dd90903c",
        "filename": "src/test/net_tests.cpp",
        "status": "modified",
        "additions": 64,
        "deletions": 0,
        "changes": 64,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/88185dc13bcb992b2bfef95c7bf12f2efca2d07b/src/test/net_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/88185dc13bcb992b2bfef95c7bf12f2efca2d07b/src/test/net_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/net_tests.cpp?ref=88185dc13bcb992b2bfef95c7bf12f2efca2d07b",
        "patch": "@@ -5,6 +5,8 @@\n #include <chainparams.h>\n #include <clientversion.h>\n #include <cstdint>\n+#include <key.h>\n+#include <key_io.h>\n #include <net.h>\n #include <netaddress.h>\n #include <netbase.h>\n@@ -704,4 +706,66 @@ BOOST_AUTO_TEST_CASE(LocalAddress_BasicLifecycle)\n     BOOST_CHECK(!IsLocal(addr));\n }\n \n+BOOST_AUTO_TEST_CASE(bip324_derivation_test)\n+{\n+    static const std::string strSecret1 = \"5HxWvvfubhXpYYpS3tJkw6fq9jE9j18THftkZjHHfmFiWtmAbrj\";\n+    static const std::string strSecret2C = \"L3Hq7a8FEQwJkW1M2GNKDW28546Vp5miewcCzSqUD9kCAXrJdS3g\";\n+    static const std::string initiator_hdata = \"2deb41da6887640dda029ae41c9c9958881d0bb8e28f6bb9039ee9b7bb11091d62f4cbe65cc418df7aefd738f4d3e926c66365b4d38eefd0a883be64112f4495\";\n+    static const std::string responder_hdata = \"4c469c70ba242ae0fc98d4eff6258cf19ecab96611c9c736356a4cf11d66edfa4d2970e56744a6d071861a4cbe2730eb7733a38b166e3df73450ef37112dd32f\";\n+\n+    CKey initiator_key = DecodeSecret(strSecret1);\n+    CKey responder_key = DecodeSecret(strSecret2C);\n+\n+    auto initiator_pubkey = initiator_key.GetPubKey();\n+    auto responder_pubkey = responder_key.GetPubKey();\n+\n+    ECDHSecret initiator_secret, responder_secret;\n+    BOOST_CHECK(initiator_key.ComputeECDHSecret(responder_pubkey, initiator_secret));\n+    BOOST_CHECK(responder_key.ComputeECDHSecret(initiator_pubkey, responder_secret));\n+\n+    BOOST_CHECK_EQUAL(ECDH_SECRET_SIZE, initiator_secret.size());\n+    BOOST_CHECK_EQUAL(ECDH_SECRET_SIZE, responder_secret.size());\n+    BOOST_CHECK_EQUAL(0, memcmp(initiator_secret.data(), responder_secret.data(), ECDH_SECRET_SIZE));\n+\n+    auto initiator_hdata_vec = ParseHex(initiator_hdata);\n+    Span<uint8_t> initiator_hdata_span{initiator_hdata_vec.data(), initiator_hdata_vec.size()};\n+\n+    auto responder_hdata_vec = ParseHex(responder_hdata);\n+    Span<uint8_t> responder_hdata_span{responder_hdata_vec.data(), responder_hdata_vec.size()};\n+\n+    BIP324Keys initiator_keys, responder_keys;\n+\n+    BOOST_CHECK(derive_bip324_keys(std::move(initiator_secret), initiator_hdata_span, responder_hdata_span, initiator_keys));\n+    BOOST_CHECK(derive_bip324_keys(std::move(responder_secret), initiator_hdata_span, responder_hdata_span, responder_keys));\n+\n+    // Make sure that the ephemeral ECDH secret is cleansed from memory once the keys are derived.\n+    BOOST_CHECK_EQUAL(\"0000000000000000000000000000000000000000000000000000000000000000\", HexStr(initiator_secret));\n+    BOOST_CHECK_EQUAL(\"0000000000000000000000000000000000000000000000000000000000000000\", HexStr(responder_secret));\n+\n+    BOOST_CHECK_EQUAL(BIP324_KEY_LEN, initiator_keys.initiator_F.size());\n+    BOOST_CHECK_EQUAL(initiator_keys.initiator_F.size(), responder_keys.initiator_F.size());\n+    BOOST_CHECK_EQUAL(0, memcmp(initiator_keys.initiator_F.data(), responder_keys.initiator_F.data(), initiator_keys.initiator_F.size()));\n+    BOOST_CHECK_EQUAL(\"11a84eb7ea351002f4ea981169567fcb6357581ecb4199c947bf294fc30638da\", HexStr(MakeSpan(initiator_keys.initiator_F)));\n+\n+    BOOST_CHECK_EQUAL(BIP324_KEY_LEN, initiator_keys.initiator_V.size());\n+    BOOST_CHECK_EQUAL(initiator_keys.initiator_V.size(), responder_keys.initiator_V.size());\n+    BOOST_CHECK_EQUAL(0, memcmp(initiator_keys.initiator_V.data(), responder_keys.initiator_V.data(), initiator_keys.initiator_V.size()));\n+    BOOST_CHECK_EQUAL(\"b50e74125b810574aa00358392ff47fb992dd8adc47a397d398f8237e6fcb214\", HexStr(MakeSpan(initiator_keys.initiator_V)));\n+\n+    BOOST_CHECK_EQUAL(BIP324_KEY_LEN, initiator_keys.responder_F.size());\n+    BOOST_CHECK_EQUAL(initiator_keys.responder_F.size(), responder_keys.responder_F.size());\n+    BOOST_CHECK_EQUAL(0, memcmp(initiator_keys.responder_F.data(), responder_keys.responder_F.data(), initiator_keys.responder_F.size()));\n+    BOOST_CHECK_EQUAL(\"7ce2b20cc16019223bdbf988d9bc84df970c9dfad94e04d74ac38f536c59178b\", HexStr(MakeSpan(initiator_keys.responder_F)));\n+\n+    BOOST_CHECK_EQUAL(BIP324_KEY_LEN, initiator_keys.responder_V.size());\n+    BOOST_CHECK_EQUAL(initiator_keys.responder_V.size(), responder_keys.responder_V.size());\n+    BOOST_CHECK_EQUAL(0, memcmp(initiator_keys.responder_V.data(), responder_keys.responder_V.data(), initiator_keys.responder_V.size()));\n+    BOOST_CHECK_EQUAL(\"1737955f199515774e8dbfc80107bcd145396b0b2a0a7134e7f5d626dc201d35\", HexStr(MakeSpan(initiator_keys.responder_V)));\n+\n+    BOOST_CHECK_EQUAL(BIP324_KEY_LEN, initiator_keys.session_id.size());\n+    BOOST_CHECK_EQUAL(initiator_keys.session_id.size(), responder_keys.session_id.size());\n+    BOOST_CHECK_EQUAL(0, memcmp(initiator_keys.session_id.data(), responder_keys.session_id.data(), initiator_keys.session_id.size()));\n+    BOOST_CHECK_EQUAL(\"c2af308f4d8a73b03dcd914866a242f7199c42158f6ac3d3c1f9e700ffe1d9a7\", HexStr(MakeSpan(initiator_keys.session_id)));\n+}\n+\n BOOST_AUTO_TEST_SUITE_END()"
      }
    ]
  },
  {
    "sha": "00142e1cf85995c15e1990005240ebc9725773e4",
    "node_id": "C_kwDOABII59oAKDAwMTQyZTFjZjg1OTk1YzE1ZTE5OTAwMDUyNDBlYmM5NzI1NzczZTQ",
    "commit": {
      "author": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2021-11-18T23:28:52Z"
      },
      "committer": {
        "name": "dhruv",
        "email": "856960+dhruv@users.noreply.github.com",
        "date": "2021-11-25T16:43:19Z"
      },
      "message": "Fuzz test for BIP324 key derivation",
      "tree": {
        "sha": "861d57e6ebba2b32aa26af3e8eff5f14fc8df3b6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/861d57e6ebba2b32aa26af3e8eff5f14fc8df3b6"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/00142e1cf85995c15e1990005240ebc9725773e4",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/00142e1cf85995c15e1990005240ebc9725773e4",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/00142e1cf85995c15e1990005240ebc9725773e4",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/00142e1cf85995c15e1990005240ebc9725773e4/comments",
    "author": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "88185dc13bcb992b2bfef95c7bf12f2efca2d07b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/88185dc13bcb992b2bfef95c7bf12f2efca2d07b",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/88185dc13bcb992b2bfef95c7bf12f2efca2d07b"
      }
    ],
    "stats": {
      "total": 33,
      "additions": 33,
      "deletions": 0
    },
    "files": [
      {
        "sha": "78a0647d029de2595690c69d4f63e828fab9c934",
        "filename": "src/test/fuzz/net.cpp",
        "status": "modified",
        "additions": 33,
        "deletions": 0,
        "changes": 33,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/00142e1cf85995c15e1990005240ebc9725773e4/src/test/fuzz/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/00142e1cf85995c15e1990005240ebc9725773e4/src/test/fuzz/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/fuzz/net.cpp?ref=00142e1cf85995c15e1990005240ebc9725773e4",
        "patch": "@@ -4,6 +4,7 @@\n \n #include <chainparams.h>\n #include <chainparamsbase.h>\n+#include <key.h>\n #include <net.h>\n #include <net_permissions.h>\n #include <netaddress.h>\n@@ -87,3 +88,35 @@ FUZZ_TARGET_INIT(net, initialize_net)\n     (void)node.HasPermission(net_permission_flags);\n     (void)node.ConnectedThroughNetwork();\n }\n+\n+void initialize_chainparams()\n+{\n+    SelectParams(CBaseChainParams::REGTEST);\n+}\n+\n+FUZZ_TARGET_INIT(bip324, initialize_chainparams)\n+{\n+    FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n+\n+    ECDHSecret ecdh_secret;\n+    ecdh_secret.resize(ECDH_SECRET_SIZE);\n+    auto ecdh_secret_bytes = fuzzed_data_provider.ConsumeBytes<uint8_t>(ECDH_SECRET_SIZE);\n+    ecdh_secret_bytes.resize(ECDH_SECRET_SIZE);\n+\n+    memcpy(ecdh_secret.data(), ecdh_secret_bytes.data(), ECDH_SECRET_SIZE);\n+\n+    auto initiator_hdata_len = fuzzed_data_provider.ConsumeIntegralInRange(0, 4096);\n+    auto initiator_hdata = fuzzed_data_provider.ConsumeBytes<uint8_t>(initiator_hdata_len);\n+\n+    auto responder_hdata_len = fuzzed_data_provider.ConsumeIntegralInRange(0, 4096);\n+    auto responder_hdata = fuzzed_data_provider.ConsumeBytes<uint8_t>(responder_hdata_len);\n+\n+    BIP324Keys keys;\n+    assert(derive_bip324_keys(std::move(ecdh_secret), initiator_hdata, responder_hdata, keys));\n+    assert(keys.initiator_F.size() == BIP324_KEY_LEN);\n+    assert(keys.initiator_V.size() == BIP324_KEY_LEN);\n+    assert(keys.responder_F.size() == BIP324_KEY_LEN);\n+    assert(keys.responder_V.size() == BIP324_KEY_LEN);\n+    assert(keys.session_id.size() == BIP324_KEY_LEN);\n+    assert(\"0000000000000000000000000000000000000000000000000000000000000000\" == HexStr(ecdh_secret));\n+}"
      }
    ]
  }
]