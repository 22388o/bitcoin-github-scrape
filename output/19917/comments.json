[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688897981",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-688897981",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
    "id": 688897981,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4ODg5Nzk4MQ==",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?u=4a9af998e1a560b3f49c3827f453e1bcbe6a5cfb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-08T14:04:04Z",
    "updated_at": "2020-09-08T14:04:04Z",
    "author_association": "MEMBER",
    "body": "@hebasto this is an example of stuff that I think we can do before moving locks around. The first and second commits refactor `ReattemptInitialBroadcast` to drop unlock/lock in each iteration.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688897981/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688898389",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-688898389",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
    "id": 688898389,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4ODg5ODM4OQ==",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?u=4a9af998e1a560b3f49c3827f453e1bcbe6a5cfb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-08T14:04:35Z",
    "updated_at": "2020-09-08T14:04:35Z",
    "author_association": "MEMBER",
    "body": "@vasild @ryanofsky your comment here would be nice too.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688898389/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688969167",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-688969167",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
    "id": 688969167,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4ODk2OTE2Nw==",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?u=7297e8aaf9188c0cb98bc549a8a02a1dc8d59e4c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-08T15:50:10Z",
    "updated_at": "2020-09-08T15:50:10Z",
    "author_association": "MEMBER",
    "body": "Why draft?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688969167/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688970636",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-688970636",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
    "id": 688970636,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4ODk3MDYzNg==",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?u=4a9af998e1a560b3f49c3827f453e1bcbe6a5cfb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-08T15:52:23Z",
    "updated_at": "2020-09-08T15:52:23Z",
    "author_association": "MEMBER",
    "body": "Yeah I don't mind setting it ready for review, the goal was to show an example rather than adding noise to your PR.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688970636/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688972446",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-688972446",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
    "id": 688972446,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4ODk3MjQ0Ng==",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?u=7297e8aaf9188c0cb98bc549a8a02a1dc8d59e4c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-08T15:55:14Z",
    "updated_at": "2020-09-08T15:55:34Z",
    "author_association": "MEMBER",
    "body": "> Yeah I don't mind setting it ready for review, the goal was to show an example rather than adding noise to your PR.\r\n\r\nI'll be happy to postpone #19872 until this PR is reviewed and merged :)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/688972446/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689040546",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-689040546",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
    "id": 689040546,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4OTA0MDU0Ng==",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?u=7297e8aaf9188c0cb98bc549a8a02a1dc8d59e4c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-08T17:55:30Z",
    "updated_at": "2020-09-08T17:55:30Z",
    "author_association": "MEMBER",
    "body": "Concept ACK.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689040546/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689081363",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-689081363",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
    "id": 689081363,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4OTA4MTM2Mw==",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-08T19:13:43Z",
    "updated_at": "2020-09-08T19:13:43Z",
    "author_association": "CONTRIBUTOR",
    "body": "The changes in `PeerManager::ReattemptInitialBroadcast()` will execute `CTxMemPool::GetUnbroadcastTxs()` and `CTxMemPool::exists()` under `CTxMemPool::cs` whereas previously they were not called under this mutex. Both methods acquire the mutex themselves. So this adds more recursive mutex locks.\r\n\r\nWhat is the purpose of this patch? There is no description and commit messages are a bit scarce, missing answer to \"Why are we doing this?\".",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689081363/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689087764",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-689087764",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
    "id": 689087764,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4OTA4Nzc2NA==",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?u=4a9af998e1a560b3f49c3827f453e1bcbe6a5cfb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-08T19:28:01Z",
    "updated_at": "2020-09-08T19:28:01Z",
    "author_association": "MEMBER",
    "body": "@vasild sure I can detail the intention. See https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485027956.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689087764/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689360687",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-689360687",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
    "id": 689360687,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY4OTM2MDY4Nw==",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?u=7297e8aaf9188c0cb98bc549a8a02a1dc8d59e4c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-09T07:19:42Z",
    "updated_at": "2020-09-09T07:19:42Z",
    "author_association": "MEMBER",
    "body": "@promag To fix TSan errors consider comparing dde441c11a07b9ff72dbcfda896c61adf33ae228 with 049d8c54f4f14996c347d099bbad855c0aa74bb6.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/689360687/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693095452",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-693095452",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
    "id": 693095452,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY5MzA5NTQ1Mg==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-09-16T00:14:12Z",
    "updated_at": "2020-09-16T00:14:12Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--cf906140f33d8803c4a75a2196329ecb-->\n\ud83d\udc19 This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/693095452/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/723435932",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#issuecomment-723435932",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19917",
    "id": 723435932,
    "node_id": "MDEyOklzc3VlQ29tbWVudDcyMzQzNTkzMg==",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?u=4a9af998e1a560b3f49c3827f453e1bcbe6a5cfb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-11-07T11:47:00Z",
    "updated_at": "2020-11-07T11:47:00Z",
    "author_association": "MEMBER",
    "body": "Rebase hell.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/723435932/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485027956",
    "pull_request_review_id": 484280398,
    "id": 485027956,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAyNzk1Ng==",
    "diff_hunk": "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();",
    "path": "src/net_processing.cpp",
    "position": 13,
    "original_position": 13,
    "commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "original_commit_id": "8f4307c975642ab0dfbc76e7165318a6e8791a5f",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This approach is also a small step towards removing the lock from `GetUnbroadcastTxs` and `exists`.",
    "created_at": "2020-09-08T15:54:57Z",
    "updated_at": "2020-09-08T21:06:40Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485027956",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485027956"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485027956"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485027956/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 895,
    "original_line": 895,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485047637",
    "pull_request_review_id": 484305574,
    "id": 485047637,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA0NzYzNw==",
    "diff_hunk": "@@ -889,17 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n     std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n \n+    relay_transactions.reserve(unbroadcast_txids.size());\n     for (const auto& elem : unbroadcast_txids) {\n         // Sanity check: all unbroadcast txns should exist in the mempool\n         if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n-            RelayTransaction(elem.first, elem.second, m_connman);\n+            relay_transactions.push_back(elem);\n         } else {\n             m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n+            RelayTransaction(elem.first, elem.second, m_connman);\n+        }\n+    }",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 23,
    "commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "original_commit_id": "8f30df2002f00b7613e602bc576285974d8f2bcf",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "8f30df2002f00b7613e602bc576285974d8f2bcf\r\nDoes this approach decrease concurrency wrt to `::cs_main` uninterruptible locking?",
    "created_at": "2020-09-08T16:25:42Z",
    "updated_at": "2020-09-08T21:06:40Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485047637",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485047637"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485047637"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485047637/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 904,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 909,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485091674",
    "pull_request_review_id": 484361774,
    "id": 485091674,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA5MTY3NA==",
    "diff_hunk": "@@ -889,17 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n     std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n \n+    relay_transactions.reserve(unbroadcast_txids.size());\n     for (const auto& elem : unbroadcast_txids) {\n         // Sanity check: all unbroadcast txns should exist in the mempool\n         if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n-            RelayTransaction(elem.first, elem.second, m_connman);\n+            relay_transactions.push_back(elem);\n         } else {\n             m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n+            RelayTransaction(elem.first, elem.second, m_connman);\n+        }\n+    }",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 23,
    "commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "original_commit_id": "8f30df2002f00b7613e602bc576285974d8f2bcf",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`RelayTransaction` doesn't hold `cs_main` that long.",
    "created_at": "2020-09-08T17:43:17Z",
    "updated_at": "2020-09-08T21:06:40Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485091674",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485091674"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485091674"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485091674/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 904,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 909,
    "side": "RIGHT",
    "in_reply_to_id": 485047637
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485197268",
    "pull_request_review_id": 484494508,
    "id": 485197268,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTE5NzI2OA==",
    "diff_hunk": "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();",
    "path": "src/net_processing.cpp",
    "position": 13,
    "original_position": 13,
    "commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "original_commit_id": "8f4307c975642ab0dfbc76e7165318a6e8791a5f",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done in fb2dca415f6ac74d79292296831ccc33c485230b and dde441c11a07b9ff72dbcfda896c61adf33ae228.",
    "created_at": "2020-09-08T21:08:48Z",
    "updated_at": "2020-09-08T21:08:49Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485197268",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485197268"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485197268"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485197268/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 895,
    "original_line": 895,
    "side": "RIGHT",
    "in_reply_to_id": 485027956
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485381915",
    "pull_request_review_id": 484713021,
    "id": 485381915,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM4MTkxNQ==",
    "diff_hunk": "@@ -421,7 +421,7 @@ void CTxMemPool::removeUnchecked(txiter it, MemPoolRemovalReason reason)\n     for (const CTxIn& txin : it->GetTx().vin)\n         mapNextTx.erase(txin.prevout);\n \n-    RemoveUnbroadcastTx(hash, true /* add logging because unchecked */ );\n+    WITH_LOCK(cs, RemoveUnbroadcastTx(hash, true /* add logging because unchecked */ ));",
    "path": "src/txmempool.cpp",
    "position": 5,
    "original_position": 5,
    "commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "original_commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "missing `return`?",
    "created_at": "2020-09-09T06:59:49Z",
    "updated_at": "2020-09-09T08:08:20Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485381915",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485381915"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485381915"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485381915/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 424,
    "original_line": 424,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485418310",
    "pull_request_review_id": 484713021,
    "id": 485418310,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQxODMxMA==",
    "diff_hunk": "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n+        relay_transactions.reserve(unbroadcast_txids.size());\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Sanity check: all unbroadcast txns should exist in the mempool\n+            if (m_mempool.exists(elem.first)) {\n+                relay_transactions.push_back(elem);\n+            } else {\n+                m_mempool.RemoveUnbroadcastTx(elem.first, true);\n+            }\n+        }\n+    }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n             RelayTransaction(elem.first, elem.second, m_connman);\n-        } else {\n-            m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n ",
    "path": "src/net_processing.cpp",
    "position": 32,
    "original_position": 32,
    "commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "original_commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This can be simplified to:\r\n\r\n```cpp\r\nvoid PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\r\n{\r\n    for (const auto& elem : WITH_LOCK(m_mempool.cs, return m_mempool.GetUnbroadcastTxs())) {\r\n        LOCK(cs_main);\r\n        RelayTransaction(elem.first, elem.second, m_connman);\r\n    } \r\n\r\n    // Schedule next run for 10-15 minutes in the future.\r\n    ...\r\n}\r\n```\r\n\r\nBecause `m_mempool.exists()` will always return `true` for a tx returned by `m_mempool.GetUnbroadcastTxs()` if we don't release `m_mempool.cs` between the two calls.\r\n\r\nAlso, the tx could be removed after we release `m_mempool.cs` and before we call `RelayTransaction()` and this is ok and is [handled just fine](https://github.com/bitcoin/bitcoin/blob/564e1ab/src/net_processing.cpp#L4429).\r\n\r\ncc @gzhao408",
    "created_at": "2020-09-09T08:06:33Z",
    "updated_at": "2020-09-09T08:08:20Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485418310",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485418310"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485418310"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485418310/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": 890,
    "original_start_line": 890,
    "start_side": "RIGHT",
    "line": 912,
    "original_line": 912,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485422236",
    "pull_request_review_id": 484764315,
    "id": 485422236,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQyMjIzNg==",
    "diff_hunk": "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n+        relay_transactions.reserve(unbroadcast_txids.size());\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Sanity check: all unbroadcast txns should exist in the mempool\n+            if (m_mempool.exists(elem.first)) {\n+                relay_transactions.push_back(elem);\n+            } else {\n+                m_mempool.RemoveUnbroadcastTx(elem.first, true);\n+            }\n+        }\n+    }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n             RelayTransaction(elem.first, elem.second, m_connman);\n-        } else {\n-            m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n ",
    "path": "src/net_processing.cpp",
    "position": 32,
    "original_position": 32,
    "commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "original_commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "But is it really necessary to have `cs_main` lock in each iteration?",
    "created_at": "2020-09-09T08:13:00Z",
    "updated_at": "2020-09-09T08:13:00Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485422236",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485422236"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485422236"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485422236/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": 890,
    "original_start_line": 890,
    "start_side": "RIGHT",
    "line": 912,
    "original_line": 912,
    "side": "RIGHT",
    "in_reply_to_id": 485418310
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485447727",
    "pull_request_review_id": 484796398,
    "id": 485447727,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ0NzcyNw==",
    "diff_hunk": "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n+        relay_transactions.reserve(unbroadcast_txids.size());\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Sanity check: all unbroadcast txns should exist in the mempool\n+            if (m_mempool.exists(elem.first)) {\n+                relay_transactions.push_back(elem);\n+            } else {\n+                m_mempool.RemoveUnbroadcastTx(elem.first, true);\n+            }\n+        }\n+    }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n             RelayTransaction(elem.first, elem.second, m_connman);\n-        } else {\n-            m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n ",
    "path": "src/net_processing.cpp",
    "position": 32,
    "original_position": 32,
    "commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "original_commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Since it was locked in each iteration before this PR, the question should rather be \"If we move `LOCK(cs_main)` before the loop, why would we do that?\"\r\n\r\nThe frequent lock/unlock allows other threads to proceed. I don't see a reason to change it.",
    "created_at": "2020-09-09T08:51:49Z",
    "updated_at": "2020-09-09T08:51:50Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485447727",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485447727"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485447727"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/485447727/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": 890,
    "original_start_line": 890,
    "start_side": "RIGHT",
    "line": 912,
    "original_line": 912,
    "side": "RIGHT",
    "in_reply_to_id": 485418310
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486171314",
    "pull_request_review_id": 485716863,
    "id": 486171314,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjE3MTMxNA==",
    "diff_hunk": "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n+        relay_transactions.reserve(unbroadcast_txids.size());\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Sanity check: all unbroadcast txns should exist in the mempool\n+            if (m_mempool.exists(elem.first)) {\n+                relay_transactions.push_back(elem);\n+            } else {\n+                m_mempool.RemoveUnbroadcastTx(elem.first, true);\n+            }\n+        }\n+    }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n             RelayTransaction(elem.first, elem.second, m_connman);\n-        } else {\n-            m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n ",
    "path": "src/net_processing.cpp",
    "position": 32,
    "original_position": 32,
    "commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "original_commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> The frequent lock/unlock allows other threads to proceed. I don't see a reason to change it.\r\n\r\nAgree (https://github.com/bitcoin/bitcoin/pull/19917#discussion_r485047637).",
    "created_at": "2020-09-10T08:47:10Z",
    "updated_at": "2020-09-10T08:47:10Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r486171314",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486171314"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r486171314"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486171314/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": 890,
    "original_start_line": 890,
    "start_side": "RIGHT",
    "line": 912,
    "original_line": 912,
    "side": "RIGHT",
    "in_reply_to_id": 485418310
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486364727",
    "pull_request_review_id": 485963211,
    "id": 486364727,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM2NDcyNw==",
    "diff_hunk": "@@ -889,15 +889,24 @@ void PeerManager::InitializeNode(CNode *pnode) {\n \n void PeerManager::ReattemptInitialBroadcast(CScheduler& scheduler) const\n {\n-    std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n-\n-    for (const auto& elem : unbroadcast_txids) {\n-        // Sanity check: all unbroadcast txns should exist in the mempool\n-        if (m_mempool.exists(elem.first)) {\n-            LOCK(cs_main);\n+    std::vector<std::pair<uint256, uint256>> relay_transactions;\n+    {\n+        LOCK(m_mempool.cs);\n+        std::map<uint256, uint256> unbroadcast_txids = m_mempool.GetUnbroadcastTxs();\n+        relay_transactions.reserve(unbroadcast_txids.size());\n+        for (const auto& elem : unbroadcast_txids) {\n+            // Sanity check: all unbroadcast txns should exist in the mempool\n+            if (m_mempool.exists(elem.first)) {\n+                relay_transactions.push_back(elem);\n+            } else {\n+                m_mempool.RemoveUnbroadcastTx(elem.first, true);\n+            }\n+        }\n+    }\n+    {\n+        LOCK(cs_main);\n+        for (const auto& elem : relay_transactions) {\n             RelayTransaction(elem.first, elem.second, m_connman);\n-        } else {\n-            m_mempool.RemoveUnbroadcastTx(elem.first, true);\n         }\n     }\n ",
    "path": "src/net_processing.cpp",
    "position": 32,
    "original_position": 32,
    "commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "original_commit_id": "dde441c11a07b9ff72dbcfda896c61adf33ae228",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "@vasild I don't agree with that. Other threads can proceed but the current thread will wait unnecessarily in each iteration for the lock and as such other things will be delayed, not mentioning the mutex overhead. See https://stackoverflow.com/a/3652428.\r\n\r\nIn this case `RelayTransaction` is pretty quick, nothing that can potentially cause a big lock on `cs_main`.",
    "created_at": "2020-09-10T13:57:04Z",
    "updated_at": "2020-09-10T13:57:04Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r486364727",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486364727"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/19917#discussion_r486364727"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19917"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/486364727/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": 890,
    "original_start_line": 890,
    "start_side": "RIGHT",
    "line": 912,
    "original_line": 912,
    "side": "RIGHT",
    "in_reply_to_id": 485418310
  }
]