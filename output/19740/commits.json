[
  {
    "sha": "2d48d7dcfb93eeec36dd6f5cbad289b89ec69324",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyZDQ4ZDdkY2ZiOTNlZWVjMzZkZDZmNWNiYWQyODliODllYzY5MzI0",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-08-17T01:35:23Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-08-17T01:37:27Z"
      },
      "message": "Simplify and fix CWallet::SignTransaction\n\nBackport CWallet::SignTransaction from master which is simpler and not\nbroken.",
      "tree": {
        "sha": "b684167b052b8da1dbd90d6d15b057d72ce65ddd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b684167b052b8da1dbd90d6d15b057d72ce65ddd"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2d48d7dcfb93eeec36dd6f5cbad289b89ec69324",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2d48d7dcfb93eeec36dd6f5cbad289b89ec69324",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/2d48d7dcfb93eeec36dd6f5cbad289b89ec69324",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2d48d7dcfb93eeec36dd6f5cbad289b89ec69324/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "bf0dc356ac4a2bdeda1908af021dea2de0dfb35a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bf0dc356ac4a2bdeda1908af021dea2de0dfb35a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/bf0dc356ac4a2bdeda1908af021dea2de0dfb35a"
      }
    ],
    "stats": {
      "total": 50,
      "additions": 8,
      "deletions": 42
    },
    "files": [
      {
        "sha": "bd2b0145b83621fea99d312b320603df569f66d3",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 42,
        "changes": 50,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2d48d7dcfb93eeec36dd6f5cbad289b89ec69324/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2d48d7dcfb93eeec36dd6f5cbad289b89ec69324/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=2d48d7dcfb93eeec36dd6f5cbad289b89ec69324",
        "patch": "@@ -2474,50 +2474,16 @@ bool CWallet::SignTransaction(CMutableTransaction& tx) const\n \n bool CWallet::SignTransaction(CMutableTransaction& tx, const std::map<COutPoint, Coin>& coins, int sighash, std::map<int, std::string>& input_errors) const\n {\n-    // Sign the tx with ScriptPubKeyMans\n-    // Because each ScriptPubKeyMan can sign more than one input, we need to keep track of each ScriptPubKeyMan that has signed this transaction.\n-    // Each iteration, we may sign more txins than the txin that is specified in that iteration.\n-    // We assume that each input is signed by only one ScriptPubKeyMan.\n-    std::set<uint256> visited_spk_mans;\n-    for (unsigned int i = 0; i < tx.vin.size(); i++) {\n-        // Get the prevout\n-        CTxIn& txin = tx.vin[i];\n-        auto coin = coins.find(txin.prevout);\n-        if (coin == coins.end() || coin->second.IsSpent()) {\n-            input_errors[i] = \"Input not found or already spent\";\n-            continue;\n-        }\n-\n-        // Check if this input is complete\n-        SignatureData sigdata = DataFromTransaction(tx, i, coin->second.out);\n-        if (sigdata.complete) {\n-            continue;\n-        }\n-\n-        // Input needs to be signed, find the right ScriptPubKeyMan\n-        std::set<ScriptPubKeyMan*> spk_mans = GetScriptPubKeyMans(coin->second.out.scriptPubKey, sigdata);\n-        if (spk_mans.size() == 0) {\n-            input_errors[i] = \"Unable to sign input, missing keys\";\n-            continue;\n-        }\n-\n-        for (auto& spk_man : spk_mans) {\n-            // If we've already been signed by this spk_man, skip it\n-            if (visited_spk_mans.count(spk_man->GetID()) > 0) {\n-                continue;\n-            }\n-\n-            // Sign the tx.\n-            // spk_man->SignTransaction will return true if the transaction is complete,\n-            // so we can exit early and return true if that happens.\n-            if (spk_man->SignTransaction(tx, coins, sighash, input_errors)) {\n-                return true;\n-            }\n-\n-            // Add this spk_man to visited_spk_mans so we can skip it later\n-            visited_spk_mans.insert(spk_man->GetID());\n+    // Try to sign with all ScriptPubKeyMans\n+    for (ScriptPubKeyMan* spk_man : GetAllScriptPubKeyMans()) {\n+        // spk_man->SignTransaction will return true if the transaction is complete,\n+        // so we can exit early and return true if that happens\n+        if (spk_man->SignTransaction(tx, coins, sighash, input_errors)) {\n+            return true;\n         }\n     }\n+\n+    // At this point, one input was not fully signed otherwise we would have exited already\n     return false;\n }\n "
      }
    ]
  },
  {
    "sha": "6a326cf66f04948ffe729e5540a69e159a7840ad",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2YTMyNmNmNjZmMDQ5NDhmZmU3MjllNTU0MGE2OWUxNTlhNzg0MGFk",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-12-03T19:43:03Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-12-05T18:50:30Z"
      },
      "message": "tests: Test that a fully signed tx given to signrawtx is unchanged\n\nTests that a fully signed transaction given to\nsignrawtransactionwithwallet is both unchanged and marked as complete.\nThis tests for a regression in 0.20 where the transaction would not be\nmarked as complete.\n\nGithub-Pull: #20562\nRebased-From: 773c42b265fb2212b5cb8785b7226a206d063543",
      "tree": {
        "sha": "83d040b24a70495d20431946855a62d771af8b92",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/83d040b24a70495d20431946855a62d771af8b92"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6a326cf66f04948ffe729e5540a69e159a7840ad",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEFSgSMAeFyWRE0zNNF1ZXMuCOXkEFAl/L1nYACgkQF1ZXMuCO\nXkFUzxAAlMKHKwuYN02FUitS410jXHvpoRUUtNoZgsdpwRZptO6ZV3CoEm4E+zEC\nhlyWH/2Z2idJQw5WUOr/XAp1voVCVogYbF96TdViv8CmzZDFeEnKWdBARt9HRJXN\nhZ7quTBH3+xdQwRFc61KsxLuXq+5mnkGVCw9mNWT6ODIDPf+qrwgyrbtmwHDdz4j\nsId6qzLAnuXmxG1D+0ABEbKfI8eeu+QEA5QblY973XQgAGdsO4mbVWR6T62HhEhu\nDTnVFZk2Ba3WlvioY7QOOKZCKs8uDhFCID3Lm4KAWwp+yYu6sJgBNhem13144El7\nAkWR4f0Q7hqaAWT6iEMQFNI9oYnVOepT8+wkmrsAuRwLE4oQ3N8JrQE3jF63ZxjR\nj/nJ7K5socqorvw5eEVl9ZiBgYzracpXjVlazuMpzaCHu7DzdzFQmQMWPX5k5mOa\n6zZesKuWDUGBFPP1OQDdwiS9MnmokBCYfRSE7u5+wVcgNor/nMwykgT1fy6DFvrK\nxN6XqRdudj+ETpevnpSNqJNw55ZwVad6ItKETcvtLHJQlQpoucJPkG2PGah124Tr\nABiGNgvzL7PwIpxiyL+mIhad/o2U0lnUqdS71T4eCQg4BFNWttIrXkutxJfZVuY+\ngUdteHZ9ip5L4CzAMi5Y2VHx0sB4wy7Tlvoj+dnCYcojfi+W9XI=\n=9xNS\n-----END PGP SIGNATURE-----",
        "payload": "tree 83d040b24a70495d20431946855a62d771af8b92\nparent 2d48d7dcfb93eeec36dd6f5cbad289b89ec69324\nauthor Andrew Chow <achow101-github@achow101.com> 1607024583 -0500\ncommitter Andrew Chow <achow101-github@achow101.com> 1607194230 -0500\n\ntests: Test that a fully signed tx given to signrawtx is unchanged\n\nTests that a fully signed transaction given to\nsignrawtransactionwithwallet is both unchanged and marked as complete.\nThis tests for a regression in 0.20 where the transaction would not be\nmarked as complete.\n\nGithub-Pull: #20562\nRebased-From: 773c42b265fb2212b5cb8785b7226a206d063543\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6a326cf66f04948ffe729e5540a69e159a7840ad",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/6a326cf66f04948ffe729e5540a69e159a7840ad",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6a326cf66f04948ffe729e5540a69e159a7840ad/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "2d48d7dcfb93eeec36dd6f5cbad289b89ec69324",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2d48d7dcfb93eeec36dd6f5cbad289b89ec69324",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/2d48d7dcfb93eeec36dd6f5cbad289b89ec69324"
      }
    ],
    "stats": {
      "total": 14,
      "additions": 14,
      "deletions": 0
    },
    "files": [
      {
        "sha": "d76a29fd9953dec5b5c3e869c0a20c1240dd0155",
        "filename": "test/functional/rpc_signrawtransaction.py",
        "status": "modified",
        "additions": 14,
        "deletions": 0,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6a326cf66f04948ffe729e5540a69e159a7840ad/test/functional/rpc_signrawtransaction.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6a326cf66f04948ffe729e5540a69e159a7840ad/test/functional/rpc_signrawtransaction.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_signrawtransaction.py?ref=6a326cf66f04948ffe729e5540a69e159a7840ad",
        "patch": "@@ -146,6 +146,19 @@ def script_verification_error_test(self):\n         assert_equal(rawTxSigned['errors'][1]['witness'], [\"304402203609e17b84f6a7d30c80bfa610b5b4542f32a8a0d5447a12fb1366d7f01cc44a0220573a954c4518331561406f90300e8f3358f51928d43c212a8caed02de67eebee01\", \"025476c2e83188368da1ff3e292e7acafcdb3566bb0ad253f62fc70f07aeee6357\"])\n         assert not rawTxSigned['errors'][0]['witness']\n \n+    def test_fully_signed_tx(self):\n+        self.log.info(\"Test signing a fully signed transaction does nothing\")\n+        self.nodes[0].walletpassphrase(\"password\", 9999)\n+        self.nodes[0].generate(101)\n+        rawtx = self.nodes[0].createrawtransaction([], [{self.nodes[0].getnewaddress(): 10}])\n+        fundedtx = self.nodes[0].fundrawtransaction(rawtx)\n+        signedtx = self.nodes[0].signrawtransactionwithwallet(fundedtx[\"hex\"])\n+        assert_equal(signedtx[\"complete\"], True)\n+        signedtx2 = self.nodes[0].signrawtransactionwithwallet(signedtx[\"hex\"])\n+        assert_equal(signedtx2[\"complete\"], True)\n+        assert_equal(signedtx[\"hex\"], signedtx2[\"hex\"])\n+        self.nodes[0].walletlock()\n+\n     def witness_script_test(self):\n         # Now test signing transaction to P2SH-P2WSH addresses without wallet\n         # Create a new P2SH-P2WSH 1-of-1 multisig address:\n@@ -212,6 +225,7 @@ def run_test(self):\n         self.script_verification_error_test()\n         self.witness_script_test()\n         self.test_with_lock_outputs()\n+        self.test_fully_signed_tx()\n \n \n if __name__ == '__main__':"
      }
    ]
  }
]