[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/489099020",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-489099020",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
    "id": 489099020,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4OTA5OTAyMA==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-03T13:40:38Z",
    "updated_at": "2021-02-11T23:35:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20827 (During IBD, prune as much as possible until we get close to where we will eventually keep blocks by luke-jr)\n* #20664 (Add scanblocks RPC call by jonasschnelli)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/489099020/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/489707230",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-489707230",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
    "id": 489707230,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4OTcwNzIzMA==",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?u=4a9af998e1a560b3f49c3827f453e1bcbe6a5cfb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-06T17:37:12Z",
    "updated_at": "2019-05-06T17:37:12Z",
    "author_association": "MEMBER",
    "body": "Closes #15867?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/489707230/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/491008776",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-491008776",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
    "id": 491008776,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ5MTAwODc3Ng==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-05-09T18:10:16Z",
    "updated_at": "2019-05-09T18:10:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rebased and fixed reported points.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/491008776/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571854091",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-571854091",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
    "id": 571854091,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU3MTg1NDA5MQ==",
    "user": {
      "login": "Roasbeef",
      "id": 998190,
      "node_id": "MDQ6VXNlcjk5ODE5MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/998190?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Roasbeef",
      "html_url": "https://github.com/Roasbeef",
      "followers_url": "https://api.github.com/users/Roasbeef/followers",
      "following_url": "https://api.github.com/users/Roasbeef/following{/other_user}",
      "gists_url": "https://api.github.com/users/Roasbeef/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Roasbeef/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Roasbeef/subscriptions",
      "organizations_url": "https://api.github.com/users/Roasbeef/orgs",
      "repos_url": "https://api.github.com/users/Roasbeef/repos",
      "events_url": "https://api.github.com/users/Roasbeef/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Roasbeef/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-01-08T01:43:34Z",
    "updated_at": "2020-01-08T01:43:34Z",
    "author_association": "NONE",
    "body": "Any chance this will be revived? This is a blocker for `lnd` to support a pruned `bitcoind` node, as we want to be able to fetch filters from `bitcoind`, then manually fetch blocks ourselves (if `bitcoind` doesn't have them) to scan them for rescans or just normal wallet sync. ",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/571854091/reactions",
      "total_count": 4,
      "+1": 4,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/655605491",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-655605491",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
    "id": 655605491,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1NTYwNTQ5MQ==",
    "user": {
      "login": "prusnak",
      "id": 42201,
      "node_id": "MDQ6VXNlcjQyMjAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/42201?u=24bd00b1856db9374d16f863f8f66fabe0d93341&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prusnak",
      "html_url": "https://github.com/prusnak",
      "followers_url": "https://api.github.com/users/prusnak/followers",
      "following_url": "https://api.github.com/users/prusnak/following{/other_user}",
      "gists_url": "https://api.github.com/users/prusnak/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prusnak/subscriptions",
      "organizations_url": "https://api.github.com/users/prusnak/orgs",
      "repos_url": "https://api.github.com/users/prusnak/repos",
      "events_url": "https://api.github.com/users/prusnak/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prusnak/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-08T15:54:08Z",
    "updated_at": "2020-07-08T15:54:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "This feature increases the value of running a pruned node significantly. +1 for adding this!",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/655605491/reactions",
      "total_count": 3,
      "+1": 3,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/655638171",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-655638171",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
    "id": 655638171,
    "node_id": "MDEyOklzc3VlQ29tbWVudDY1NTYzODE3MQ==",
    "user": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-07-08T16:56:07Z",
    "updated_at": "2020-07-08T16:56:07Z",
    "author_association": "MEMBER",
    "body": "I suspect #19463 could be useful for this",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/655638171/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/742744931",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-742744931",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
    "id": 742744931,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc0Mjc0NDkzMQ==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-10T19:30:51Z",
    "updated_at": "2020-12-16T12:56:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rewrote this PR and tried to fix the reported point by @promag, @MarcoFalke and @luke-jr.\r\nAdded `-fastprune` debug parameter to test pruning more effectively (added a functional-test as well).",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/742744931/reactions",
      "total_count": 4,
      "+1": 4,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769684234",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-769684234",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
    "id": 769684234,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc2OTY4NDIzNA==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-29T09:19:54Z",
    "updated_at": "2021-01-29T09:19:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks @fjahr for the reviews.\r\nAnd I agree that there should be a test for the FlushStateToDisk() changes.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/769684234/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775480470",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-775480470",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
    "id": 775480470,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3NTQ4MDQ3MA==",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?u=9791e96cd4268d48e3517bac41eaf2b1d09759fd&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-08T21:38:29Z",
    "updated_at": "2021-02-08T21:38:29Z",
    "author_association": "MEMBER",
    "body": "Code Review ACK 0280274368e2df7c7832549cd581c710875a6be1\r\n\r\nThis is simpler than I expected it to be.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/775480470/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777355249",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-777355249",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
    "id": 777355249,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3NzM1NTI0OQ==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-11T10:44:49Z",
    "updated_at": "2021-02-11T10:44:49Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks a lot for testing @ryanofsky.\r\nAddressed your points (+rebased)(force pushed).",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/777355249/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779710204",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-779710204",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
    "id": 779710204,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3OTcxMDIwNA==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-16T09:37:52Z",
    "updated_at": "2021-02-16T09:37:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks @ryanofsky and @fjahr! Fixed the reported points. Thanks for a quick retest.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779710204/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/780894327",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#issuecomment-780894327",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/15946",
    "id": 780894327,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc4MDg5NDMyNw==",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?u=348c27f90b6fff8fd72fa27232272651436a2ff0&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-17T22:23:40Z",
    "updated_at": "2021-02-17T22:23:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "Code review ACK 84716b1\r\n\r\nChecked that only changes since last review were small improvements on the functional test and the added parameter to `FindFilesToPrune()`.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/780894327/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281206430",
    "pull_request_review_id": 234006796,
    "id": 281206430,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIwNjQzMA==",
    "diff_hunk": "@@ -66,6 +66,29 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(chainActive, locator);\n     }\n     m_synced = m_best_block_index.load() == chainActive.Tip();\n+\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // it looks like this index is not built yet\n+            // make sure we have all data back to the genesis\n+            const CBlockIndex* block = chainActive.Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {",
    "path": "src/index/base.cpp",
    "position": 10,
    "original_position": 11,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "0d8f7369cd8b51dfb7b3b9b920e4e11f7962faa9",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "0d8f7369cd8b51dfb7b3b9b920e4e11f7962faa9 \r\n\r\nThis doesn't check `status & BLOCK_HAVE_DATA` on the tip, is that intentional?",
    "created_at": "2019-05-06T14:21:58Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281206430",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281206430"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281206430"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281206430/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 74,
    "original_line": 74,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281208250",
    "pull_request_review_id": 234006796,
    "id": 281208250,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIwODI1MA==",
    "diff_hunk": "@@ -70,21 +70,21 @@ bool BaseIndex::Init()\n     if (!m_synced) {\n         bool prune_violation = false;\n         if (!m_best_block_index) {\n-            // it looks like this index is not built yet\n-            // make sure we have all data back to the genesis\n+            // index is not built yet\n+            // make sure we have all block data back to the genesis",
    "path": "src/index/base.cpp",
    "position": 8,
    "original_position": 16,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "d2ab62fede34b7980863617f3669c019ee42d029",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "d2ab62fede34b7980863617f3669c019ee42d029 \r\n\r\nThese comment were added in the previous commit, could fixup these hunks?",
    "created_at": "2019-05-06T14:26:02Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281208250",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281208250"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281208250"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281208250/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 72,
    "original_line": 72,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281209023",
    "pull_request_review_id": 234006796,
    "id": 281209023,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIwOTAyMw==",
    "diff_hunk": "@@ -100,6 +100,8 @@ class BaseIndex : public CValidationInterface\n     /// not block and immediately returns false.\n     bool BlockUntilSyncedToCurrentChain();\n \n+    bool IsSynced();",
    "path": "src/index/base.h",
    "position": null,
    "original_position": 4,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "8bb1ca8a276f5f6fc5af3639c2d58c496b71bf8f",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "8bb1ca8a276f5f6fc5af3639c2d58c496b71bf8f \r\n\r\n`bool IsSyned() const;`. Any reason to not write implementation here?",
    "created_at": "2019-05-06T14:28:01Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281209023",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281209023"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281209023"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281209023/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 103,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281210225",
    "pull_request_review_id": 234006796,
    "id": 281210225,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIxMDIyNQ==",
    "diff_hunk": "@@ -1004,6 +1004,13 @@ static UniValue pruneblockchain(const JSONRPCRequest& request)\n \n     LOCK(cs_main);\n \n+    // reject manual pruning in case if a blockfilterindex is syncing\n+    ForEachBlockFilterIndex([](BlockFilterIndex& index) {",
    "path": "src/rpc/blockchain.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bd11606a95022478e6ef1ccaada1589cff13a327",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "bd11606a95022478e6ef1ccaada1589cff13a327\r\n\r\nCan be checked before locking `cs_main`?",
    "created_at": "2019-05-06T14:30:44Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281210225",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281210225"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281210225"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281210225/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1020,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281210459",
    "pull_request_review_id": 234006796,
    "id": 281210459,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIxMDQ1OQ==",
    "diff_hunk": "@@ -1004,6 +1004,13 @@ static UniValue pruneblockchain(const JSONRPCRequest& request)\n \n     LOCK(cs_main);\n \n+    // reject manual pruning in case if a blockfilterindex is syncing\n+    ForEachBlockFilterIndex([](BlockFilterIndex& index) {\n+        if (!index.IsSynced()) {\n+            throw JSONRPCError(RPC_MISC_ERROR, \"Cannot prune blocks because blockfilterindex is syncing.\");",
    "path": "src/rpc/blockchain.cpp",
    "position": null,
    "original_position": 7,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bd11606a95022478e6ef1ccaada1589cff13a327",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "bd11606a95022478e6ef1ccaada1589cff13a327\r\n\r\nDo you see a way to test this?",
    "created_at": "2019-05-06T14:31:12Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281210459",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281210459"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281210459"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281210459/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1022,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281213644",
    "pull_request_review_id": 234006796,
    "id": 281213644,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIxMzY0NA==",
    "diff_hunk": "@@ -2085,23 +2086,34 @@ bool static FlushStateToDisk(const CChainParams& chainparams, CValidationState &\n     static int64_t nLastFlush = 0;\n     std::set<int> setFilesToPrune;\n     bool full_flush_completed = false;\n+\n+    // we delay pruning when one of the blockfilterindex is syncing\n+    bool delay_pruning = false;\n+    ForEachBlockFilterIndex([&delay_pruning](BlockFilterIndex& index) {\n+        if (!index.IsSynced()) { delay_pruning = true; }",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 16,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bf744288bd58718844841c088c498cd57a8f87d8",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "bf744288bd58718844841c088c498cd57a8f87d8 \r\n\r\nnit, no need for `{}`. Alternative:\r\n```\r\ndelay_pruning |= !index.IsSynced();\r\n```",
    "created_at": "2019-05-06T14:38:02Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281213644",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281213644"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281213644"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281213644/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2093,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281218262",
    "pull_request_review_id": 234006796,
    "id": 281218262,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIxODI2Mg==",
    "diff_hunk": "@@ -11,6 +11,7 @@ export LC_ALL=C\n EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"chainparamsbase -> util/system -> chainparamsbase\"\n     \"index/txindex -> validation -> index/txindex\"\n+    \"index/blockfilterindex -> validation -> index/blockfilterindex\"",
    "path": "test/lint/lint-circular-dependencies.sh",
    "position": 4,
    "original_position": 4,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bf744288bd58718844841c088c498cd57a8f87d8",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "bf744288bd58718844841c088c498cd57a8f87d8\r\n\r\nAn alternative is to add a global `g_delay_pruning` in validation.h which gets updated every time an index `m_synced` is updated.",
    "created_at": "2019-05-06T14:48:22Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281218262",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281218262"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281218262"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281218262/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 14,
    "original_line": 14,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281220802",
    "pull_request_review_id": 234024777,
    "id": 281220802,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIyMDgwMg==",
    "diff_hunk": "@@ -66,6 +66,29 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(chainActive, locator);\n     }\n     m_synced = m_best_block_index.load() == chainActive.Tip();\n+\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // it looks like this index is not built yet\n+            // make sure we have all data back to the genesis\n+            const CBlockIndex* block = chainActive.Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {",
    "path": "src/index/base.cpp",
    "position": 10,
    "original_position": 11,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "0d8f7369cd8b51dfb7b3b9b920e4e11f7962faa9",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I don't think the tip can ever not have data?",
    "created_at": "2019-05-06T14:53:56Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281220802",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281220802"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281220802"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281220802/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 74,
    "original_line": 74,
    "side": "RIGHT",
    "in_reply_to_id": 281206430
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281221080",
    "pull_request_review_id": 234025177,
    "id": 281221080,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MTIyMTA4MA==",
    "diff_hunk": "@@ -11,6 +11,7 @@ export LC_ALL=C\n EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"chainparamsbase -> util/system -> chainparamsbase\"\n     \"index/txindex -> validation -> index/txindex\"\n+    \"index/blockfilterindex -> validation -> index/blockfilterindex\"",
    "path": "test/lint/lint-circular-dependencies.sh",
    "position": 4,
    "original_position": 4,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bf744288bd58718844841c088c498cd57a8f87d8",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Or move the \"load block\" function into a separate \"storage\" module.",
    "created_at": "2019-05-06T14:54:39Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281221080",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281221080"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r281221080"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/281221080/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 14,
    "original_line": 14,
    "side": "RIGHT",
    "in_reply_to_id": 281218262
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282552651",
    "pull_request_review_id": 235678099,
    "id": 282552651,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjU1MjY1MQ==",
    "diff_hunk": "@@ -1004,6 +1004,13 @@ static UniValue pruneblockchain(const JSONRPCRequest& request)\n \n     LOCK(cs_main);\n \n+    // reject manual pruning in case if a blockfilterindex is syncing\n+    ForEachBlockFilterIndex([](BlockFilterIndex& index) {\n+        if (!index.IsSynced()) {\n+            throw JSONRPCError(RPC_MISC_ERROR, \"Cannot prune blocks because blockfilterindex is syncing.\");",
    "path": "src/rpc/blockchain.cpp",
    "position": null,
    "original_position": 7,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bd11606a95022478e6ef1ccaada1589cff13a327",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I'm currently working on making the block-/undo-filesize dynamic which would then allow testing this more reliable.",
    "created_at": "2019-05-09T15:58:25Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282552651",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282552651"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282552651"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282552651/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1022,
    "side": "RIGHT",
    "in_reply_to_id": 281210459
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601175",
    "pull_request_review_id": 235740443,
    "id": 282601175,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjYwMTE3NQ==",
    "diff_hunk": "@@ -11,6 +11,7 @@ export LC_ALL=C\n EXPECTED_CIRCULAR_DEPENDENCIES=(\n     \"chainparamsbase -> util/system -> chainparamsbase\"\n     \"index/txindex -> validation -> index/txindex\"\n+    \"index/blockfilterindex -> validation -> index/blockfilterindex\"",
    "path": "test/lint/lint-circular-dependencies.sh",
    "position": 4,
    "original_position": 4,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bf744288bd58718844841c088c498cd57a8f87d8",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The global `g_delay_pruning` smells fragile. Better not do that.\r\n\r\nI like the \"storage\" module approach which though would be something for another PR.",
    "created_at": "2019-05-09T18:04:33Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282601175",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601175"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282601175"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601175/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 14,
    "original_line": 14,
    "side": "RIGHT",
    "in_reply_to_id": 281218262
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601885",
    "pull_request_review_id": 235741371,
    "id": 282601885,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjYwMTg4NQ==",
    "diff_hunk": "@@ -66,6 +66,29 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(chainActive, locator);\n     }\n     m_synced = m_best_block_index.load() == chainActive.Tip();\n+\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // it looks like this index is not built yet\n+            // make sure we have all data back to the genesis\n+            const CBlockIndex* block = chainActive.Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {",
    "path": "src/index/base.cpp",
    "position": 10,
    "original_position": 11,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "0d8f7369cd8b51dfb7b3b9b920e4e11f7962faa9",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> I don't think the tip can ever not have data? \r\n\r\nJup.",
    "created_at": "2019-05-09T18:06:33Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282601885",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601885"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282601885"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601885/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 74,
    "original_line": 74,
    "side": "RIGHT",
    "in_reply_to_id": 281206430
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601960",
    "pull_request_review_id": 235741478,
    "id": 282601960,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjYwMTk2MA==",
    "diff_hunk": "@@ -100,6 +100,8 @@ class BaseIndex : public CValidationInterface\n     /// not block and immediately returns false.\n     bool BlockUntilSyncedToCurrentChain();\n \n+    bool IsSynced();",
    "path": "src/index/base.h",
    "position": null,
    "original_position": 4,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "8bb1ca8a276f5f6fc5af3639c2d58c496b71bf8f",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Fixed.",
    "created_at": "2019-05-09T18:06:46Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282601960",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601960"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282601960"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282601960/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 103,
    "side": "RIGHT",
    "in_reply_to_id": 281209023
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282602418",
    "pull_request_review_id": 235742086,
    "id": 282602418,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjYwMjQxOA==",
    "diff_hunk": "@@ -1004,6 +1004,13 @@ static UniValue pruneblockchain(const JSONRPCRequest& request)\n \n     LOCK(cs_main);\n \n+    // reject manual pruning in case if a blockfilterindex is syncing\n+    ForEachBlockFilterIndex([](BlockFilterIndex& index) {",
    "path": "src/rpc/blockchain.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bd11606a95022478e6ef1ccaada1589cff13a327",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Fixed.",
    "created_at": "2019-05-09T18:08:04Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282602418",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282602418"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282602418"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282602418/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1020,
    "side": "RIGHT",
    "in_reply_to_id": 281210225
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282602625",
    "pull_request_review_id": 235742381,
    "id": 282602625,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDI4MjYwMjYyNQ==",
    "diff_hunk": "@@ -2085,23 +2086,34 @@ bool static FlushStateToDisk(const CChainParams& chainparams, CValidationState &\n     static int64_t nLastFlush = 0;\n     std::set<int> setFilesToPrune;\n     bool full_flush_completed = false;\n+\n+    // we delay pruning when one of the blockfilterindex is syncing\n+    bool delay_pruning = false;\n+    ForEachBlockFilterIndex([&delay_pruning](BlockFilterIndex& index) {\n+        if (!index.IsSynced()) { delay_pruning = true; }",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 16,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bf744288bd58718844841c088c498cd57a8f87d8",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Rather not do `|= !` for code readability, but removed the extra unnecessary block ",
    "created_at": "2019-05-09T18:08:38Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282602625",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282602625"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r282602625"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/282602625/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2093,
    "side": "RIGHT",
    "in_reply_to_id": 281213644
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315296449",
    "pull_request_review_id": 276668382,
    "id": 315296449,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5NjQ0OQ==",
    "diff_hunk": "@@ -23,7 +23,7 @@ static void FatalError(const char* fmt, const Args&... args)\n     SetMiscWarning(strMessage);\n     LogPrintf(\"*** %s\\n\", strMessage);\n     uiInterface.ThreadSafeMessageBox(\n-        \"Error: A fatal internal error occurred, see debug.log for details\",",
    "path": "src/index/base.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "a205fc52738088d983c22a3e3dcfa900a33e8a43",
    "user": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Aren't we intentionally keeping the message vague here to avoid confusing users?",
    "created_at": "2019-08-19T16:17:53Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315296449",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315296449"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315296449"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315296449/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 26,
    "side": "LEFT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297460",
    "pull_request_review_id": 276668382,
    "id": 315297460,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5NzQ2MA==",
    "diff_hunk": "@@ -66,6 +66,28 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(::ChainActive(), locator);\n     }\n     m_synced = m_best_block_index.load() == ::ChainActive().Tip();\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // index is not built yet\n+            // make sure we have all block data back to the genesis\n+            const CBlockIndex* block = ::ChainActive().Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n+                block = block->pprev;\n+            }\n+            prune_violation = block != ::ChainActive().Genesis();\n+        }\n+        // in case the index has a best block set and is not fully synced\n+        // check if we have the required blocks to continue building the index\n+        else if (!(m_best_block_index.load()->nStatus & BLOCK_HAVE_DATA)) {",
    "path": "src/index/base.cpp",
    "position": null,
    "original_position": 26,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "a205fc52738088d983c22a3e3dcfa900a33e8a43",
    "user": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "IIRC, having the data for block N is not a guarantee we have it for block N+M, since blocks are stored out of order and pruned only as entire files.",
    "created_at": "2019-08-19T16:20:20Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315297460",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297460"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315297460"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297460/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 82,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297746",
    "pull_request_review_id": 276668382,
    "id": 315297746,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5Nzc0Ng==",
    "diff_hunk": "@@ -66,6 +66,28 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(::ChainActive(), locator);\n     }\n     m_synced = m_best_block_index.load() == ::ChainActive().Tip();\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // index is not built yet\n+            // make sure we have all block data back to the genesis\n+            const CBlockIndex* block = ::ChainActive().Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n+                block = block->pprev;\n+            }\n+            prune_violation = block != ::ChainActive().Genesis();\n+        }\n+        // in case the index has a best block set and is not fully synced\n+        // check if we have the required blocks to continue building the index\n+        else if (!(m_best_block_index.load()->nStatus & BLOCK_HAVE_DATA)) {",
    "path": "src/index/base.cpp",
    "position": null,
    "original_position": 26,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "a205fc52738088d983c22a3e3dcfa900a33e8a43",
    "user": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "If `m_best_block_index` is not in the main chain, we may need its parent blocks to undo indexing. This should be checked here too.",
    "created_at": "2019-08-19T16:21:00Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315297746",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297746"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315297746"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297746/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 82,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297976",
    "pull_request_review_id": 276668382,
    "id": 315297976,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5Nzk3Ng==",
    "diff_hunk": "@@ -178,6 +200,10 @@ bool BaseIndex::Rewind(const CBlockIndex* current_tip, const CBlockIndex* new_ti\n     assert(current_tip->GetAncestor(new_tip->nHeight) == new_tip);\n \n     // In the case of a reorg, ensure persisted block locator is not stale.\n+    // Pruning has a minimum of 288 blocks-to-keep and getting the index\n+    // out of sync may be possible but a users fault.\n+    // In case we reorg beyond the pruned depth, ReadBlockFromDisk would\n+    // throw and led to a graceful shutdown",
    "path": "src/index/base.cpp",
    "position": null,
    "original_position": 45,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "a205fc52738088d983c22a3e3dcfa900a33e8a43",
    "user": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "lead*",
    "created_at": "2019-08-19T16:21:34Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315297976",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297976"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315297976"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315297976/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 220,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315298520",
    "pull_request_review_id": 276668382,
    "id": 315298520,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5ODUyMA==",
    "diff_hunk": "@@ -1004,6 +1004,13 @@ static UniValue pruneblockchain(const JSONRPCRequest& request)\n \n     LOCK(cs_main);\n \n+    // reject manual pruning in case if a blockfilterindex is syncing\n+    ForEachBlockFilterIndex([](BlockFilterIndex& index) {\n+        if (!index.IsSynced()) {\n+            throw JSONRPCError(RPC_MISC_ERROR, \"Cannot prune blocks because blockfilterindex is syncing.\");",
    "path": "src/rpc/blockchain.cpp",
    "position": null,
    "original_position": 7,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bd11606a95022478e6ef1ccaada1589cff13a327",
    "user": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Would be nicer to just check if the indexes are beyond the requested prune height...",
    "created_at": "2019-08-19T16:22:52Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315298520",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315298520"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315298520"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315298520/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1022,
    "side": "RIGHT",
    "in_reply_to_id": 281210459
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315298813",
    "pull_request_review_id": 276668382,
    "id": 315298813,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDMxNTI5ODgxMw==",
    "diff_hunk": "@@ -2105,23 +2106,34 @@ bool static FlushStateToDisk(const CChainParams& chainparams, CValidationState &\n     static int64_t nLastFlush = 0;\n     std::set<int> setFilesToPrune;\n     bool full_flush_completed = false;\n+\n+    // we delay pruning when one of the blockfilterindex is syncing\n+    bool delay_pruning = false;\n+    ForEachBlockFilterIndex([&delay_pruning](BlockFilterIndex& index) {\n+        if (!index.IsSynced()) delay_pruning = true;\n+    });",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 17,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "a205fc52738088d983c22a3e3dcfa900a33e8a43",
    "user": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Won't this effectively prevent all pruning until IBD completes? Seems important to prune as soon as all indexes are caught up to the given height...",
    "created_at": "2019-08-19T16:23:38Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315298813",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315298813"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r315298813"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/315298813/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2114,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550900736",
    "pull_request_review_id": 560645487,
    "id": 550900736,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwMDczNg==",
    "diff_hunk": "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks\n+        // pruning is height-based\n+        int index_lowest_blockheight = m_chain.Height();\n+        bool has_blockfilter = false;\n+        ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+            int height = index.GetSummary().best_block_height;\n+            if (height < index_lowest_blockheight) {\n+                height = index_lowest_blockheight;\n+            }\n+            has_blockfilter = false;",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 22,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "2541ca8df55295ac34ab9348742283493e590435",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`has_blockfilter = true;`?",
    "created_at": "2021-01-02T17:08:26Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550900736",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550900736"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550900736"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550900736/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2250,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550901918",
    "pull_request_review_id": 560645487,
    "id": 550901918,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwMTkxOA==",
    "diff_hunk": "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 13,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "2541ca8df55295ac34ab9348742283493e590435",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think this whole block of additions can be moved below line 2255 (`if (fPruneMode...`) because it's only relevant for what is inside there.",
    "created_at": "2021-01-02T17:22:07Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550901918",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550901918"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550901918"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550901918/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2241,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550902448",
    "pull_request_review_id": 560645487,
    "id": 550902448,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwMjQ0OA==",
    "diff_hunk": "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks\n+        // pruning is height-based\n+        int index_lowest_blockheight = m_chain.Height();\n+        bool has_blockfilter = false;\n+        ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+            int height = index.GetSummary().best_block_height;\n+            if (height < index_lowest_blockheight) {\n+                height = index_lowest_blockheight;",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 20,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "2541ca8df55295ac34ab9348742283493e590435",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "should this be `index_lowest_blockheight = height;`?",
    "created_at": "2021-01-02T17:27:46Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550902448",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550902448"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550902448"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550902448/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2248,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550902906",
    "pull_request_review_id": 560645487,
    "id": 550902906,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDkwMjkwNg==",
    "diff_hunk": "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks\n+        // pruning is height-based\n+        int index_lowest_blockheight = m_chain.Height();\n+        bool has_blockfilter = false;\n+        ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+            int height = index.GetSummary().best_block_height;\n+            if (height < index_lowest_blockheight) {\n+                height = index_lowest_blockheight;\n+            }\n+            has_blockfilter = false;\n+        });\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n             if (nManualPruneHeight > 0) {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune (manual)\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPruneManual(setFilesToPrune, nManualPruneHeight, m_chain.Height());\n+                m_blockman.FindFilesToPruneManual(setFilesToPrune, has_blockfilter ? std::max(nManualPruneHeight, index_lowest_blockheight) : nManualPruneHeight, m_chain.Height());",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 32,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "2541ca8df55295ac34ab9348742283493e590435",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Shouldn't this be `std::min()` because the lower height number is the one that let's us prune less? (same below)",
    "created_at": "2021-01-02T17:33:23Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550902906",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550902906"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r550902906"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550902906/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2259,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566674758",
    "pull_request_review_id": 579060882,
    "id": 566674758,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjY3NDc1OA==",
    "diff_hunk": "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 13,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "2541ca8df55295ac34ab9348742283493e590435",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Good point. Will change.",
    "created_at": "2021-01-29T09:06:25Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566674758",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566674758"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566674758"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566674758/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2241,
    "side": "RIGHT",
    "in_reply_to_id": 550901918
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681917",
    "pull_request_review_id": 579070179,
    "id": 566681917,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjY4MTkxNw==",
    "diff_hunk": "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks\n+        // pruning is height-based\n+        int index_lowest_blockheight = m_chain.Height();\n+        bool has_blockfilter = false;\n+        ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+            int height = index.GetSummary().best_block_height;\n+            if (height < index_lowest_blockheight) {\n+                height = index_lowest_blockheight;\n+            }\n+            has_blockfilter = false;\n+        });\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n             if (nManualPruneHeight > 0) {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune (manual)\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPruneManual(setFilesToPrune, nManualPruneHeight, m_chain.Height());\n+                m_blockman.FindFilesToPruneManual(setFilesToPrune, has_blockfilter ? std::max(nManualPruneHeight, index_lowest_blockheight) : nManualPruneHeight, m_chain.Height());",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 32,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "2541ca8df55295ac34ab9348742283493e590435",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Absolutely. Fixed.",
    "created_at": "2021-01-29T09:18:40Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566681917",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681917"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566681917"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681917/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2259,
    "side": "RIGHT",
    "in_reply_to_id": 550902906
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681970",
    "pull_request_review_id": 579070262,
    "id": 566681970,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjY4MTk3MA==",
    "diff_hunk": "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks\n+        // pruning is height-based\n+        int index_lowest_blockheight = m_chain.Height();\n+        bool has_blockfilter = false;\n+        ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+            int height = index.GetSummary().best_block_height;\n+            if (height < index_lowest_blockheight) {\n+                height = index_lowest_blockheight;\n+            }\n+            has_blockfilter = false;",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 22,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "2541ca8df55295ac34ab9348742283493e590435",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks. Fixed.",
    "created_at": "2021-01-29T09:18:47Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566681970",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681970"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566681970"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681970/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2250,
    "side": "RIGHT",
    "in_reply_to_id": 550900736
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681981",
    "pull_request_review_id": 579070281,
    "id": 566681981,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjY4MTk4MQ==",
    "diff_hunk": "@@ -2236,17 +2237,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n+        // make sure we don't prune below the blockfilterindexes bestblocks\n+        // pruning is height-based\n+        int index_lowest_blockheight = m_chain.Height();\n+        bool has_blockfilter = false;\n+        ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+            int height = index.GetSummary().best_block_height;\n+            if (height < index_lowest_blockheight) {\n+                height = index_lowest_blockheight;",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 20,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "2541ca8df55295ac34ab9348742283493e590435",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks. Fixed.",
    "created_at": "2021-01-29T09:18:49Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566681981",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681981"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r566681981"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/566681981/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2248,
    "side": "RIGHT",
    "in_reply_to_id": 550902448
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572397573",
    "pull_request_review_id": 585953872,
    "id": 572397573,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjM5NzU3Mw==",
    "diff_hunk": "@@ -3203,7 +3217,7 @@ static bool FindBlockPos(FlatFilePos &pos, unsigned int nAddSize, unsigned int n\n \n     bool finalize_undo = false;\n     if (!fKnown) {\n-        while (vinfoBlockFile[nFile].nSize + nAddSize >= MAX_BLOCKFILE_SIZE) {\n+        while (vinfoBlockFile[nFile].nSize + nAddSize >= (gArgs.GetBoolArg(\"-fastprune\", false) ? 0x10000 /* 64kb */ : MAX_BLOCKFILE_SIZE)) {",
    "path": "src/validation.cpp",
    "position": 41,
    "original_position": 46,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "0280274368e2df7c7832549cd581c710875a6be1",
    "user": {
      "login": "prusnak",
      "id": 42201,
      "node_id": "MDQ6VXNlcjQyMjAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/42201?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prusnak",
      "html_url": "https://github.com/prusnak",
      "followers_url": "https://api.github.com/users/prusnak/followers",
      "following_url": "https://api.github.com/users/prusnak/following{/other_user}",
      "gists_url": "https://api.github.com/users/prusnak/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prusnak/subscriptions",
      "organizations_url": "https://api.github.com/users/prusnak/orgs",
      "repos_url": "https://api.github.com/users/prusnak/repos",
      "events_url": "https://api.github.com/users/prusnak/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prusnak/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The numeric constant could be extracted into `src/validation.h` (on top of the file where `MAX_BLOCKFILE_SIZE` is defined).",
    "created_at": "2021-02-08T21:48:27Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r572397573",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572397573"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r572397573"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572397573/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3215,
    "original_line": 3215,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572397668",
    "pull_request_review_id": 585953872,
    "id": 572397668,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MjM5NzY2OA==",
    "diff_hunk": "@@ -3986,7 +4000,7 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n \n static FlatFileSeq BlockFileSeq()\n {\n-    return FlatFileSeq(GetBlocksDir(), \"blk\", BLOCKFILE_CHUNK_SIZE);\n+    return FlatFileSeq(GetBlocksDir(), \"blk\", gArgs.GetBoolArg(\"-fastprune\", false) ? 0x4000 /* 16kb */ : BLOCKFILE_CHUNK_SIZE);",
    "path": "src/validation.cpp",
    "position": 68,
    "original_position": 55,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "0280274368e2df7c7832549cd581c710875a6be1",
    "user": {
      "login": "prusnak",
      "id": 42201,
      "node_id": "MDQ6VXNlcjQyMjAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/42201?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/prusnak",
      "html_url": "https://github.com/prusnak",
      "followers_url": "https://api.github.com/users/prusnak/followers",
      "following_url": "https://api.github.com/users/prusnak/following{/other_user}",
      "gists_url": "https://api.github.com/users/prusnak/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/prusnak/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/prusnak/subscriptions",
      "organizations_url": "https://api.github.com/users/prusnak/orgs",
      "repos_url": "https://api.github.com/users/prusnak/repos",
      "events_url": "https://api.github.com/users/prusnak/events{/privacy}",
      "received_events_url": "https://api.github.com/users/prusnak/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The numeric constant could be extracted to top of the file where `BLOCKFILE_CHUNK_SIZE` is defined.",
    "created_at": "2021-02-08T21:48:36Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r572397668",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572397668"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r572397668"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/572397668/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 4007,
    "original_line": 4007,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573368857",
    "pull_request_review_id": 587162834,
    "id": 573368857,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzM2ODg1Nw==",
    "diff_hunk": "@@ -2246,17 +2247,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune below the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int index_lowest_blockheight = m_chain.Height();\n+            bool has_blockfilter = false;\n+            ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+                int height = index.GetSummary().best_block_height;\n+                if (height < index_lowest_blockheight) {\n+                    index_lowest_blockheight = height;\n+                }\n+                has_blockfilter = true;\n+            });",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 26,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bda1c9fc90a704d1962b16fe4242b5637c930b29",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Avoid pruning below the blockfilterindex sync height\" (bda1c9fc90a704d1962b16fe4242b5637c930b29)\r\n\r\nEarlier commit can set best_block_height to 0, while FindFilesToPruneManual is asserting prune height > 0, which seems like it could lead to an unlucky crash.\r\n\r\nAlso, the has_blockfilter variable and conditionals below seem unnecessary, and the logic would work fine if it were just assumed always true.\r\n\r\nAlso, the code duplication in prune calls below also seems not great. I think this could all be more straightforward:\r\n\r\n```c++\r\nint last_prune = m_chain.Height(); // last height we can prune\r\nForEachBlockFilterIndex([&](BlockFilterIndex& index) {\r\n   last_prune = std::max(1, std::min(last_prune, index.GetSummary().block_block_height));\r\n});\r\n\r\nif (nManualPruneHeight > 0) {\r\n    FindFilesToPruneManual(setFilesToPrune, std::min(last_prune, nManualPruneHeight), m_chain.Height());\r\n} else {\r\n    FindFilesToPrune(setFilesToPrune, chainparams.PruneAfterHeight(), last_prune, m_chain.Height());\r\n}\r\n```",
    "created_at": "2021-02-10T01:08:26Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573368857",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573368857"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573368857"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573368857/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 2256,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 2262,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573372325",
    "pull_request_review_id": 587162834,
    "id": 573372325,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzM3MjMyNQ==",
    "diff_hunk": "@@ -65,6 +65,43 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(::ChainActive(), locator);\n     }\n     m_synced = m_best_block_index.load() == ::ChainActive().Tip();\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // index is not built yet\n+            // make sure we have all block data back to the genesis\n+            const CBlockIndex* block = ::ChainActive().Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n+                block = block->pprev;\n+            }\n+            prune_violation = block != ::ChainActive().Genesis();\n+        }\n+        // in case the index has a best block set and is not fully synced\n+        // check if we have the required blocks to continue building the index\n+        else {\n+            const CBlockIndex* block_to_test = m_best_block_index.load();\n+            if (!ChainActive().Contains(m_best_block_index.load())) {\n+                // if the bestblock is not part of the mainchain, find the fork\n+                // and make sure we have all data down to the fork\n+                block_to_test = ::ChainActive().FindFork(m_best_block_index.load());",
    "path": "src/index/base.cpp",
    "position": null,
    "original_position": 22,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "92b4a9cc3eca0897e455e00144a96e88b5c4ea1c",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Allow blockfilter in conjunction with prune\" (92b4a9cc3eca0897e455e00144a96e88b5c4ea1c)\r\n\r\nOn these two lines it's confusing and appears racy for this code to be referring to the shared `m_best_block_index.load()` value when it could be just be using the private `block_to_test` value. Would suggest `s/m_best_block_index.load()/block_to_test/`",
    "created_at": "2021-02-10T01:18:07Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573372325",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573372325"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573372325"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573372325/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 83,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 86,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573373090",
    "pull_request_review_id": 587162834,
    "id": 573373090,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzM3MzA5MA==",
    "diff_hunk": "@@ -65,6 +65,43 @@ bool BaseIndex::Init()\n         m_best_block_index = FindForkInGlobalIndex(::ChainActive(), locator);\n     }\n     m_synced = m_best_block_index.load() == ::ChainActive().Tip();\n+    if (!m_synced) {\n+        bool prune_violation = false;\n+        if (!m_best_block_index) {\n+            // index is not built yet\n+            // make sure we have all block data back to the genesis\n+            const CBlockIndex* block = ::ChainActive().Tip();\n+            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n+                block = block->pprev;\n+            }\n+            prune_violation = block != ::ChainActive().Genesis();\n+        }\n+        // in case the index has a best block set and is not fully synced\n+        // check if we have the required blocks to continue building the index\n+        else {\n+            const CBlockIndex* block_to_test = m_best_block_index.load();\n+            if (!ChainActive().Contains(m_best_block_index.load())) {\n+                // if the bestblock is not part of the mainchain, find the fork\n+                // and make sure we have all data down to the fork\n+                block_to_test = ::ChainActive().FindFork(m_best_block_index.load());\n+            }\n+            const CBlockIndex* block = ::ChainActive().Tip();\n+            prune_violation = true;\n+            // check backwards from the tip if we have all block data until we reach the indexes bestblock\n+            while (block_to_test && block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n+                if (m_best_block_index.load() == block) {",
    "path": "src/index/base.cpp",
    "position": null,
    "original_position": 28,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "92b4a9cc3eca0897e455e00144a96e88b5c4ea1c",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Allow blockfilter in conjunction with prune\" (92b4a9cc3eca0897e455e00144a96e88b5c4ea1c)\r\n\r\nThis seems wrong in the fork case. Should be fixed with  `s/m_best_block_index.load()/block_to_test/` again",
    "created_at": "2021-02-10T01:20:17Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573373090",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573373090"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573373090"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573373090/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 92,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573385944",
    "pull_request_review_id": 587162834,
    "id": 573385944,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzM4NTk0NA==",
    "diff_hunk": "@@ -2246,17 +2247,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune below the blockfilterindexes bestblocks",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 16,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bda1c9fc90a704d1962b16fe4242b5637c930b29",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Avoid pruning below the blockfilterindex sync height\" (bda1c9fc90a704d1962b16fe4242b5637c930b29)\r\n\r\nThis comment and this commit title seem wrong, should `s/below/above/`",
    "created_at": "2021-02-10T01:57:16Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573385944",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573385944"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573385944"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573385944/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2254,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573391858",
    "pull_request_review_id": 587162834,
    "id": 573391858,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzM5MTg1OA==",
    "diff_hunk": "@@ -2246,17 +2247,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune below the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int index_lowest_blockheight = m_chain.Height();\n+            bool has_blockfilter = false;\n+            ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+                int height = index.GetSummary().best_block_height;\n+                if (height < index_lowest_blockheight) {\n+                    index_lowest_blockheight = height;\n+                }\n+                has_blockfilter = true;\n+            });\n+\n             if (nManualPruneHeight > 0) {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune (manual)\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPruneManual(setFilesToPrune, nManualPruneHeight, m_chain.Height());\n+                m_blockman.FindFilesToPruneManual(setFilesToPrune, has_blockfilter ? std::min(nManualPruneHeight, index_lowest_blockheight) : nManualPruneHeight, m_chain.Height());\n             } else {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPrune(setFilesToPrune, chainparams.PruneAfterHeight(), m_chain.Height(), IsInitialBlockDownload());\n+                m_blockman.FindFilesToPrune(setFilesToPrune, has_blockfilter ? std::min(chainparams.PruneAfterHeight(), (uint64_t)index_lowest_blockheight) : chainparams.PruneAfterHeight(), m_chain.Height(), IsInitialBlockDownload());",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 37,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bda1c9fc90a704d1962b16fe4242b5637c930b29",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Avoid pruning below the blockfilterindex sync height\" (bda1c9fc90a704d1962b16fe4242b5637c930b29)\r\n\r\nI don't think just passing a lower `nPruneAfterHeight` argument value is sufficient to avoid pruning here. I think the `index_lowest_blockheight` variable (`last_prune` variable in my previous suggestion) has to be passed as a new argument to `FindFilesToPrune`. If you look at the `FindFilesToPrune` implementation you can see it is not using `nPruneAfterHeight` value at all to compute `nLastBlockWeCanPrune`, which is the value we need to change there.\r\n\r\nIt's also easy to see this code is wrong because it will have no effect at all if index_lowest_blockheight is bigger than chainparams.PruneAfterHeight, which is 100,000.",
    "created_at": "2021-02-10T02:09:03Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573391858",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573391858"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573391858"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/573391858/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2273,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574358480",
    "pull_request_review_id": 588373912,
    "id": 574358480,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDM1ODQ4MA==",
    "diff_hunk": "@@ -2246,17 +2247,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune below the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int index_lowest_blockheight = m_chain.Height();\n+            bool has_blockfilter = false;\n+            ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+                int height = index.GetSummary().best_block_height;\n+                if (height < index_lowest_blockheight) {\n+                    index_lowest_blockheight = height;\n+                }\n+                has_blockfilter = true;\n+            });",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 26,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bda1c9fc90a704d1962b16fe4242b5637c930b29",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Using `last_prune` instead of `m_chain.Height()` will lead to preserve 288 blocks below the artificial tip (`last_prune`) which IMO are not subject to reorg.",
    "created_at": "2021-02-11T09:37:13Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574358480",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574358480"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574358480"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574358480/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 2256,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 2262,
    "side": "RIGHT",
    "in_reply_to_id": 573368857
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574366925",
    "pull_request_review_id": 588384059,
    "id": 574366925,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDM2NjkyNQ==",
    "diff_hunk": "@@ -2246,17 +2247,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune below the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int index_lowest_blockheight = m_chain.Height();\n+            bool has_blockfilter = false;\n+            ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+                int height = index.GetSummary().best_block_height;\n+                if (height < index_lowest_blockheight) {\n+                    index_lowest_blockheight = height;\n+                }\n+                has_blockfilter = true;\n+            });",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 26,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bda1c9fc90a704d1962b16fe4242b5637c930b29",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> Using `last_prune` instead of `m_chain.Height()` will lead to preserve 288 blocks below the artificial tip (`last_prune`) which IMO are not subject to reorg.\r\n\r\nIf you're talking about the non-manual case, the you need to FindFilesToPrune a new parameter, not use the existing one, see https://github.com/bitcoin/bitcoin/pull/15946#discussion_r573391858. Not suggesting preserving below the tip.",
    "created_at": "2021-02-11T09:49:56Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574366925",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574366925"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574366925"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574366925/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 2256,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 2262,
    "side": "RIGHT",
    "in_reply_to_id": 573368857
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574402608",
    "pull_request_review_id": 588428964,
    "id": 574402608,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDQwMjYwOA==",
    "diff_hunk": "@@ -2246,17 +2247,30 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune below the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int index_lowest_blockheight = m_chain.Height();\n+            bool has_blockfilter = false;\n+            ForEachBlockFilterIndex([&index_lowest_blockheight, &has_blockfilter](BlockFilterIndex& index) {\n+                int height = index.GetSummary().best_block_height;\n+                if (height < index_lowest_blockheight) {\n+                    index_lowest_blockheight = height;\n+                }\n+                has_blockfilter = true;\n+            });",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 26,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "bda1c9fc90a704d1962b16fe4242b5637c930b29",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes. You're right. Lets just accept the 288blocks buffer for now (can be changed later if necessary).",
    "created_at": "2021-02-11T10:46:08Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574402608",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574402608"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574402608"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574402608/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 2256,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 2262,
    "side": "RIGHT",
    "in_reply_to_id": 573368857
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574403596",
    "pull_request_review_id": 588430337,
    "id": 574403596,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NDQwMzU5Ng==",
    "diff_hunk": "@@ -3203,7 +3217,7 @@ static bool FindBlockPos(FlatFilePos &pos, unsigned int nAddSize, unsigned int n\n \n     bool finalize_undo = false;\n     if (!fKnown) {\n-        while (vinfoBlockFile[nFile].nSize + nAddSize >= MAX_BLOCKFILE_SIZE) {\n+        while (vinfoBlockFile[nFile].nSize + nAddSize >= (gArgs.GetBoolArg(\"-fastprune\", false) ? 0x10000 /* 64kb */ : MAX_BLOCKFILE_SIZE)) {",
    "path": "src/validation.cpp",
    "position": 41,
    "original_position": 46,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "0280274368e2df7c7832549cd581c710875a6be1",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I thought about it but since its a debug only parameter I rather keep that inline.",
    "created_at": "2021-02-11T10:47:41Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574403596",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574403596"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r574403596"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/574403596/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3215,
    "original_line": 3215,
    "side": "RIGHT",
    "in_reply_to_id": 572397573
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575529707",
    "pull_request_review_id": 589849530,
    "id": 575529707,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTUyOTcwNw==",
    "diff_hunk": "@@ -2249,17 +2250,25 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune above the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int last_prune = m_chain.Height(); // last height we can prune\n+            ForEachBlockFilterIndex([&](BlockFilterIndex& index) {\n+               last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n+            });\n+\n             if (nManualPruneHeight > 0) {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune (manual)\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPruneManual(setFilesToPrune, nManualPruneHeight, m_chain.Height());\n+                m_blockman.FindFilesToPruneManual(setFilesToPrune, std::min(last_prune, nManualPruneHeight), m_chain.Height());\n             } else {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPrune(setFilesToPrune, chainparams.PruneAfterHeight(), m_chain.Height(), IsInitialBlockDownload());\n+                m_blockman.FindFilesToPrune(setFilesToPrune, chainparams.PruneAfterHeight(), last_prune, IsInitialBlockDownload());",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 32,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "14c95089fe9727794c1a6101d5cedaca54292bb7",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Avoid pruning below the blockfilterindex sync height\" (14c95089fe9727794c1a6101d5cedaca54292bb7)\r\n\r\nPretending `last_prune` as the chain height may be safe, because the only side effect is to not prune blocks that could be pruned, but it is confusing, and also creates a difference in behavior between the manual prune case which uses the real height and this case which pretends the min index sync height is the height.\r\n\r\nIf this behavior is going to be kept, there should be an explanatory comment because it looks broken, and not obviously broken in a safe way instead of a dangerous way.\r\n\r\nBut better than adding a comment would be to make the code straightforward: Stop passing `last_prune` as `chain_tip_height`. Instead, continue passing `m_chain.Height()` as `chain_tip_height`, pass `last_prune` as `prune_height`, and assign `nLastBlockWeCanPrune = min(prune_height, chain_tip_height - MIN_BLOCKS_TO_KEEP)` inside `FindFilesToPrune`. This would be more consistent with the logic in `FindFilesToPruneManual`, as well as more efficient, and more obviously correct.",
    "created_at": "2021-02-12T21:30:12Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575529707",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575529707"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575529707"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575529707/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2271,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575840775",
    "pull_request_review_id": 590069277,
    "id": 575840775,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg0MDc3NQ==",
    "diff_hunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test RPC misc output.\"\"\"",
    "path": "test/functional/feature_blockfilterindex_prune.py",
    "position": null,
    "original_position": 5,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "in b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425:\r\n\r\nDescription needs an update.",
    "created_at": "2021-02-14T17:43:09Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575840775",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575840775"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575840775"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575840775/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 5,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575841826",
    "pull_request_review_id": 590069277,
    "id": 575841826,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg0MTgyNg==",
    "diff_hunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test RPC misc output.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_raises_rpc_error,\n+    assert_greater_than,\n+)\n+\n+class FeatureBlockfilterindexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-fastprune\", \"-prune=1\"], [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"]]\n+\n+    def run_test(self):\n+        # test basic pruning compatibility & filter access of pruned blocks\n+        self.log.info(\"check if we can access a blockfilter when pruning is enabled but no actual pruned blocks\")",
    "path": "test/functional/feature_blockfilterindex_prune.py",
    "position": null,
    "original_position": 19,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "in b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425:\r\n\r\nnit: \"...but no blocks are actually pruned\"",
    "created_at": "2021-02-14T17:50:51Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575841826",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575841826"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575841826"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575841826/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 19,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575846927",
    "pull_request_review_id": 590069277,
    "id": 575846927,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NTg0NjkyNw==",
    "diff_hunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test RPC misc output.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_raises_rpc_error,\n+    assert_greater_than,\n+)\n+\n+class FeatureBlockfilterindexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-fastprune\", \"-prune=1\"], [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"]]\n+\n+    def run_test(self):\n+        # test basic pruning compatibility & filter access of pruned blocks\n+        self.log.info(\"check if we can access a blockfilter when pruning is enabled but no actual pruned blocks\")\n+        assert(len(self.nodes[1].getblockfilter(self.nodes[1].getbestblockhash())['filter']) > 0)\n+        self.nodes[1].generate(500)\n+        self.sync_all()\n+        self.log.info(\"prune some blocks\")\n+        pruneheight = self.nodes[1].pruneblockchain(400)\n+        assert(pruneheight != 0)\n+        self.log.info(\"check if we can access the tips blockfilter when we have pruned some blocks\")\n+        assert(len(self.nodes[1].getblockfilter(self.nodes[1].getbestblockhash())['filter']) > 0)\n+        self.log.info(\"check if we can access the blockfilter of a pruned block\")\n+        assert(len(self.nodes[1].getblockfilter(self.nodes[1].getblockhash(2))['filter']) > 0)\n+        self.log.info(\"start node without blockfilterindex\")\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=self.extra_args[0])\n+        self.log.info(\"make sure accessing the blockfilters throws an error\")\n+        assert_raises_rpc_error(-1,\"Index is not enabled for filtertype basic\", self.nodes[1].getblockfilter, self.nodes[1].getblockhash(2))\n+        self.nodes[1].generate(1000)\n+        self.log.info(\"prune below the blockfilterindexes best block while blockfilters are disabled\")\n+        pruneheight_new = self.nodes[1].pruneblockchain(1000)\n+        assert_greater_than(pruneheight_new, pruneheight)\n+        self.stop_node(1)\n+        self.log.info(\"make sure we get an init error when starting the node again with block filters\")\n+        self.nodes[1].assert_start_raises_init_error(extra_args=self.extra_args[1])\n+        self.nodes[1].assert_debug_log([\"basic block filter index best block of the index goes beyond pruned data. Please disable the index or reindex (which will download the whole blockchain again)\"])\n+",
    "path": "test/functional/feature_blockfilterindex_prune.py",
    "position": 47,
    "original_position": 43,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "in b5c243c:\r\n\r\nSuggested addition\r\n\r\n```suggestion\r\n        self.log.info(\"make sure the node starts again with the -reindex arg\")\r\n        reindex_args = self.extra_args[1]\r\n        reindex_args.append(\"-reindex\")\r\n        self.start_node(1, extra_args=reindex_args)\r\n```",
    "created_at": "2021-02-14T18:35:18Z",
    "updated_at": "2021-02-16T09:31:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575846927",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575846927"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r575846927"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/575846927/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 47,
    "original_line": 47,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674356",
    "pull_request_review_id": 591035351,
    "id": 576674356,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjY3NDM1Ng==",
    "diff_hunk": "@@ -2249,17 +2250,25 @@ bool CChainState::FlushStateToDisk(\n     {\n         bool fFlushForPrune = false;\n         bool fDoFullFlush = false;\n+\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState(&m_mempool);\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n+            // make sure we don't prune above the blockfilterindexes bestblocks\n+            // pruning is height-based\n+            int last_prune = m_chain.Height(); // last height we can prune\n+            ForEachBlockFilterIndex([&](BlockFilterIndex& index) {\n+               last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n+            });\n+\n             if (nManualPruneHeight > 0) {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune (manual)\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPruneManual(setFilesToPrune, nManualPruneHeight, m_chain.Height());\n+                m_blockman.FindFilesToPruneManual(setFilesToPrune, std::min(last_prune, nManualPruneHeight), m_chain.Height());\n             } else {\n                 LOG_TIME_MILLIS_WITH_CATEGORY(\"find files to prune\", BCLog::BENCH);\n \n-                m_blockman.FindFilesToPrune(setFilesToPrune, chainparams.PruneAfterHeight(), m_chain.Height(), IsInitialBlockDownload());\n+                m_blockman.FindFilesToPrune(setFilesToPrune, chainparams.PruneAfterHeight(), last_prune, IsInitialBlockDownload());",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 32,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "14c95089fe9727794c1a6101d5cedaca54292bb7",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes. That makes sense. Implemented now as suggested by @ryanofsky.",
    "created_at": "2021-02-16T09:31:38Z",
    "updated_at": "2021-02-16T09:31:39Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674356",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674356"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674356"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674356/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2271,
    "side": "RIGHT",
    "in_reply_to_id": 575529707
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674458",
    "pull_request_review_id": 591035690,
    "id": 576674458,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjY3NDQ1OA==",
    "diff_hunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test RPC misc output.\"\"\"",
    "path": "test/functional/feature_blockfilterindex_prune.py",
    "position": null,
    "original_position": 5,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks for spotting. Fixed.",
    "created_at": "2021-02-16T09:31:47Z",
    "updated_at": "2021-02-16T09:31:48Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674458",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674458"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674458"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674458/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 5,
    "side": "RIGHT",
    "in_reply_to_id": 575840775
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674509",
    "pull_request_review_id": 591035862,
    "id": 576674509,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjY3NDUwOQ==",
    "diff_hunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test RPC misc output.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_raises_rpc_error,\n+    assert_greater_than,\n+)\n+\n+class FeatureBlockfilterindexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-fastprune\", \"-prune=1\"], [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"]]\n+\n+    def run_test(self):\n+        # test basic pruning compatibility & filter access of pruned blocks\n+        self.log.info(\"check if we can access a blockfilter when pruning is enabled but no actual pruned blocks\")",
    "path": "test/functional/feature_blockfilterindex_prune.py",
    "position": null,
    "original_position": 19,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Fixed.",
    "created_at": "2021-02-16T09:31:53Z",
    "updated_at": "2021-02-16T09:31:53Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674509",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674509"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674509"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674509/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 19,
    "side": "RIGHT",
    "in_reply_to_id": 575841826
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674666",
    "pull_request_review_id": 591036380,
    "id": 576674666,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjY3NDY2Ng==",
    "diff_hunk": "@@ -0,0 +1,45 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test RPC misc output.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_raises_rpc_error,\n+    assert_greater_than,\n+)\n+\n+class FeatureBlockfilterindexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.extra_args = [[\"-fastprune\", \"-prune=1\"], [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"]]\n+\n+    def run_test(self):\n+        # test basic pruning compatibility & filter access of pruned blocks\n+        self.log.info(\"check if we can access a blockfilter when pruning is enabled but no actual pruned blocks\")\n+        assert(len(self.nodes[1].getblockfilter(self.nodes[1].getbestblockhash())['filter']) > 0)\n+        self.nodes[1].generate(500)\n+        self.sync_all()\n+        self.log.info(\"prune some blocks\")\n+        pruneheight = self.nodes[1].pruneblockchain(400)\n+        assert(pruneheight != 0)\n+        self.log.info(\"check if we can access the tips blockfilter when we have pruned some blocks\")\n+        assert(len(self.nodes[1].getblockfilter(self.nodes[1].getbestblockhash())['filter']) > 0)\n+        self.log.info(\"check if we can access the blockfilter of a pruned block\")\n+        assert(len(self.nodes[1].getblockfilter(self.nodes[1].getblockhash(2))['filter']) > 0)\n+        self.log.info(\"start node without blockfilterindex\")\n+        self.stop_node(1)\n+        self.start_node(1, extra_args=self.extra_args[0])\n+        self.log.info(\"make sure accessing the blockfilters throws an error\")\n+        assert_raises_rpc_error(-1,\"Index is not enabled for filtertype basic\", self.nodes[1].getblockfilter, self.nodes[1].getblockhash(2))\n+        self.nodes[1].generate(1000)\n+        self.log.info(\"prune below the blockfilterindexes best block while blockfilters are disabled\")\n+        pruneheight_new = self.nodes[1].pruneblockchain(1000)\n+        assert_greater_than(pruneheight_new, pruneheight)\n+        self.stop_node(1)\n+        self.log.info(\"make sure we get an init error when starting the node again with block filters\")\n+        self.nodes[1].assert_start_raises_init_error(extra_args=self.extra_args[1])\n+        self.nodes[1].assert_debug_log([\"basic block filter index best block of the index goes beyond pruned data. Please disable the index or reindex (which will download the whole blockchain again)\"])\n+",
    "path": "test/functional/feature_blockfilterindex_prune.py",
    "position": 47,
    "original_position": 43,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "b5c243cd5202ba17ed20e0ea7c14bb9e11ef2425",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Added that additional test.",
    "created_at": "2021-02-16T09:32:06Z",
    "updated_at": "2021-02-16T09:32:07Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674666",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674666"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r576674666"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/576674666/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 47,
    "original_line": 47,
    "side": "RIGHT",
    "in_reply_to_id": 575846927
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/580924696",
    "pull_request_review_id": 596190423,
    "id": 580924696,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDkyNDY5Ng==",
    "diff_hunk": "@@ -17,6 +17,7 @@\n #include <cuckoocache.h>\n #include <flatfile.h>\n #include <hash.h>\n+#include <index/blockfilterindex.h>",
    "path": "src/validation.cpp",
    "position": 4,
    "original_position": 4,
    "commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "original_commit_id": "84716b134e9afca2fba7731de4af1f22fa1b1518",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Is this making blockfilterindex part of validation code?",
    "created_at": "2021-02-23T10:31:52Z",
    "updated_at": "2021-02-23T10:31:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r580924696",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/580924696"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/15946#discussion_r580924696"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/15946"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/580924696/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 20,
    "original_line": 20,
    "side": "RIGHT"
  }
]