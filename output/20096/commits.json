[
  {
    "sha": "a72d637e911a17c54d4c9b442e21393bc2c82e69",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphNzJkNjM3ZTkxMWExN2M1NGQ0YzliNDQyZTIxMzkzYmMyYzgyZTY5",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-10-06T20:10:51Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-07-01T17:06:48Z"
      },
      "message": "Add SetWalletFlagWithDB",
      "tree": {
        "sha": "d7c1d0edfa9263e648122bfdc0dc77243d292b17",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d7c1d0edfa9263e648122bfdc0dc77243d292b17"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a72d637e911a17c54d4c9b442e21393bc2c82e69",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a72d637e911a17c54d4c9b442e21393bc2c82e69",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a72d637e911a17c54d4c9b442e21393bc2c82e69",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a72d637e911a17c54d4c9b442e21393bc2c82e69/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "a926d6dfd291da5578d8af422bde03fd17456d96",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a926d6dfd291da5578d8af422bde03fd17456d96",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/a926d6dfd291da5578d8af422bde03fd17456d96"
      }
    ],
    "stats": {
      "total": 13,
      "additions": 10,
      "deletions": 3
    },
    "files": [
      {
        "sha": "a4e8e784b1a5688e997adc66902bffbd23db4592",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 3,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a72d637e911a17c54d4c9b442e21393bc2c82e69/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a72d637e911a17c54d4c9b442e21393bc2c82e69/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=a72d637e911a17c54d4c9b442e21393bc2c82e69",
        "patch": "@@ -1379,13 +1379,19 @@ bool CWallet::CanGetAddresses(bool internal) const\n     }\n     return false;\n }\n+void CWallet::SetWalletFlagWithDB(WalletBatch& batch, uint64_t flags)\n+{\n+    AssertLockHeld(cs_wallet);\n+    m_wallet_flags |= flags;\n+    if (!batch.WriteWalletFlags(m_wallet_flags))\n+        throw std::runtime_error(std::string(__func__) + \": writing wallet flags failed\");\n+}\n \n void CWallet::SetWalletFlag(uint64_t flags)\n {\n     LOCK(cs_wallet);\n-    m_wallet_flags |= flags;\n-    if (!WalletBatch(GetDatabase()).WriteWalletFlags(m_wallet_flags))\n-        throw std::runtime_error(std::string(__func__) + \": writing wallet flags failed\");\n+    WalletBatch batch(GetDatabase());\n+    SetWalletFlagWithDB(batch, flags);\n }\n \n void CWallet::UnsetWalletFlag(uint64_t flag)"
      },
      {
        "sha": "d82544b9b3580bcacd68ae74164bd1f05f85ceab",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a72d637e911a17c54d4c9b442e21393bc2c82e69/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a72d637e911a17c54d4c9b442e21393bc2c82e69/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=a72d637e911a17c54d4c9b442e21393bc2c82e69",
        "patch": "@@ -797,6 +797,7 @@ class CWallet final : public WalletStorage, public interfaces::Chain::Notificati\n     void BlockUntilSyncedToCurrentChain() const LOCKS_EXCLUDED(::cs_main) EXCLUSIVE_LOCKS_REQUIRED(!cs_wallet);\n \n     /** set a single wallet flag */\n+    void SetWalletFlagWithDB(WalletBatch& batch, uint64_t flags) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n     void SetWalletFlag(uint64_t flags);\n \n     /** Unsets a single wallet flag */"
      }
    ]
  },
  {
    "sha": "c61037c2b7064a3ad121cc529fbc2cda82b8f23f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjNjEwMzdjMmI3MDY0YTNhZDEyMWNjNTI5ZmJjMmNkYTgyYjhmMjNm",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-10-06T20:11:34Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-07-01T17:07:23Z"
      },
      "message": "Pass in WalletBatch to UpgradeKeyMetadata",
      "tree": {
        "sha": "5a76e51f739aee5af2bd1ce247dde3cac4de3075",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5a76e51f739aee5af2bd1ce247dde3cac4de3075"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c61037c2b7064a3ad121cc529fbc2cda82b8f23f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c61037c2b7064a3ad121cc529fbc2cda82b8f23f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c61037c2b7064a3ad121cc529fbc2cda82b8f23f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c61037c2b7064a3ad121cc529fbc2cda82b8f23f/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "a72d637e911a17c54d4c9b442e21393bc2c82e69",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a72d637e911a17c54d4c9b442e21393bc2c82e69",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/a72d637e911a17c54d4c9b442e21393bc2c82e69"
      }
    ],
    "stats": {
      "total": 21,
      "additions": 11,
      "deletions": 10
    },
    "files": [
      {
        "sha": "eb5132b73c025ca4a2549841f4f300dc14299ead",
        "filename": "src/wallet/scriptpubkeyman.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 3,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c61037c2b7064a3ad121cc529fbc2cda82b8f23f/src/wallet/scriptpubkeyman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c61037c2b7064a3ad121cc529fbc2cda82b8f23f/src/wallet/scriptpubkeyman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.cpp?ref=c61037c2b7064a3ad121cc529fbc2cda82b8f23f",
        "patch": "@@ -386,14 +386,13 @@ void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n     }\n }\n \n-void LegacyScriptPubKeyMan::UpgradeKeyMetadata()\n+void LegacyScriptPubKeyMan::UpgradeKeyMetadata(WalletBatch& batch)\n {\n     LOCK(cs_KeyStore);\n     if (m_storage.IsLocked() || m_storage.IsWalletFlagSet(WALLET_FLAG_KEY_ORIGIN_METADATA)) {\n         return;\n     }\n \n-    std::unique_ptr<WalletBatch> batch = std::make_unique<WalletBatch>(m_storage.GetDatabase());\n     for (auto& meta_pair : mapKeyMetadata) {\n         CKeyMetadata& meta = meta_pair.second;\n         if (!meta.hd_seed_id.IsNull() && !meta.has_key_origin && meta.hdKeypath != \"s\") { // If the hdKeypath is \"s\", that's the seed and it doesn't have a key origin\n@@ -415,7 +414,7 @@ void LegacyScriptPubKeyMan::UpgradeKeyMetadata()\n             // Write meta to wallet\n             CPubKey pubkey;\n             if (GetPubKey(meta_pair.first, pubkey)) {\n-                batch->WriteKeyMetadata(meta, pubkey, true);\n+                batch.WriteKeyMetadata(meta, pubkey, true);\n             }\n         }\n     }"
      },
      {
        "sha": "aaccd2347398d5ba7f31b379754faa7e7a47f175",
        "filename": "src/wallet/scriptpubkeyman.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c61037c2b7064a3ad121cc529fbc2cda82b8f23f/src/wallet/scriptpubkeyman.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c61037c2b7064a3ad121cc529fbc2cda82b8f23f/src/wallet/scriptpubkeyman.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.h?ref=c61037c2b7064a3ad121cc529fbc2cda82b8f23f",
        "patch": "@@ -370,7 +370,7 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n     void MarkUnusedAddresses(const CScript& script) override;\n \n     //! Upgrade stored CKeyMetadata objects to store key origin info as KeyOriginInfo\n-    void UpgradeKeyMetadata();\n+    void UpgradeKeyMetadata(WalletBatch& batch);\n \n     bool IsHDEnabled() const override;\n "
      },
      {
        "sha": "90db8f0cee3b3aa5ab61283cae7392ca31dbac3b",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 4,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c61037c2b7064a3ad121cc529fbc2cda82b8f23f/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c61037c2b7064a3ad121cc529fbc2cda82b8f23f/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=c61037c2b7064a3ad121cc529fbc2cda82b8f23f",
        "patch": "@@ -359,8 +359,9 @@ const CWalletTx* CWallet::GetWalletTx(const uint256& hash) const\n     return &(it->second);\n }\n \n-void CWallet::UpgradeKeyMetadata()\n+void CWallet::UpgradeKeyMetadata(WalletBatch& batch)\n {\n+    AssertLockHeld(cs_wallet);\n     if (IsLocked() || IsWalletFlagSet(WALLET_FLAG_KEY_ORIGIN_METADATA)) {\n         return;\n     }\n@@ -370,8 +371,8 @@ void CWallet::UpgradeKeyMetadata()\n         return;\n     }\n \n-    spk_man->UpgradeKeyMetadata();\n-    SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);\n+    spk_man->UpgradeKeyMetadata(batch);\n+    SetWalletFlagWithDB(batch, WALLET_FLAG_KEY_ORIGIN_METADATA);\n }\n \n void CWallet::UpgradeDescriptorCache()\n@@ -402,7 +403,8 @@ bool CWallet::Unlock(const SecureString& strWalletPassphrase, bool accept_no_key\n                 continue; // try another master key\n             if (Unlock(_vMasterKey, accept_no_keys)) {\n                 // Now that we've unlocked, upgrade the key metadata\n-                UpgradeKeyMetadata();\n+                WalletBatch batch(GetDatabase());\n+                UpgradeKeyMetadata(batch);\n                 // Now that we've unlocked, upgrade the descriptor cache\n                 UpgradeDescriptorCache();\n                 return true;"
      },
      {
        "sha": "dab3575a225f57a5fcbf5da92d55f81a19d99d5a",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c61037c2b7064a3ad121cc529fbc2cda82b8f23f/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c61037c2b7064a3ad121cc529fbc2cda82b8f23f/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=c61037c2b7064a3ad121cc529fbc2cda82b8f23f",
        "patch": "@@ -476,7 +476,7 @@ class CWallet final : public WalletStorage, public interfaces::Chain::Notificati\n     double ScanningProgress() const { return fScanningWallet ? (double) m_scanning_progress : 0; }\n \n     //! Upgrade stored CKeyMetadata objects to store key origin info as KeyOriginInfo\n-    void UpgradeKeyMetadata() EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n+    void UpgradeKeyMetadata(WalletBatch& batch) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n \n     //! Upgrade DescriptorCaches\n     void UpgradeDescriptorCache() EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);"
      },
      {
        "sha": "069cb91684d0fbd10684c9b0142c00e8e6afa761",
        "filename": "src/wallet/walletdb.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c61037c2b7064a3ad121cc529fbc2cda82b8f23f/src/wallet/walletdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c61037c2b7064a3ad121cc529fbc2cda82b8f23f/src/wallet/walletdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.cpp?ref=c61037c2b7064a3ad121cc529fbc2cda82b8f23f",
        "patch": "@@ -885,7 +885,7 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n     // Upgrade all of the wallet keymetadata to have the hd master key id\n     // This operation is not atomic, but if it fails, updated entries are still backwards compatible with older software\n     try {\n-        pwallet->UpgradeKeyMetadata();\n+        pwallet->UpgradeKeyMetadata(*this);\n     } catch (...) {\n         result = DBErrors::CORRUPT;\n     }"
      }
    ]
  },
  {
    "sha": "a15c2ca439a993681ba05286682f3056cfe98175",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphMTVjMmNhNDM5YTk5MzY4MWJhMDUyODY2ODJmMzA1NmNmZTk4MTc1",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-07-01T17:18:14Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-07-01T17:24:10Z"
      },
      "message": "Pass in WalletBatch to UpgradeDescriptorCache",
      "tree": {
        "sha": "aaab5a952a4bbbacf61f89e5f526bc89bc55f26a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/aaab5a952a4bbbacf61f89e5f526bc89bc55f26a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a15c2ca439a993681ba05286682f3056cfe98175",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a15c2ca439a993681ba05286682f3056cfe98175",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a15c2ca439a993681ba05286682f3056cfe98175",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a15c2ca439a993681ba05286682f3056cfe98175/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c61037c2b7064a3ad121cc529fbc2cda82b8f23f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c61037c2b7064a3ad121cc529fbc2cda82b8f23f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c61037c2b7064a3ad121cc529fbc2cda82b8f23f"
      }
    ],
    "stats": {
      "total": 18,
      "additions": 9,
      "deletions": 9
    },
    "files": [
      {
        "sha": "08624fcfc807a56dcb8c4e08a4c3f3a82acc9787",
        "filename": "src/wallet/scriptpubkeyman.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a15c2ca439a993681ba05286682f3056cfe98175/src/wallet/scriptpubkeyman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a15c2ca439a993681ba05286682f3056cfe98175/src/wallet/scriptpubkeyman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.cpp?ref=a15c2ca439a993681ba05286682f3056cfe98175",
        "patch": "@@ -2267,7 +2267,7 @@ bool DescriptorScriptPubKeyMan::GetDescriptorString(std::string& out) const\n     return m_wallet_descriptor.descriptor->ToNormalizedString(provider, out, &m_wallet_descriptor.cache);\n }\n \n-void DescriptorScriptPubKeyMan::UpgradeDescriptorCache()\n+void DescriptorScriptPubKeyMan::UpgradeDescriptorCache(WalletBatch& batch)\n {\n     LOCK(cs_desc_man);\n     if (m_storage.IsLocked() || m_storage.IsWalletFlagSet(WALLET_FLAG_LAST_HARDENED_XPUB_CACHED)) {\n@@ -2291,7 +2291,7 @@ void DescriptorScriptPubKeyMan::UpgradeDescriptorCache()\n \n     // Cache the last hardened xpubs\n     DescriptorCache diff = m_wallet_descriptor.cache.MergeAndDiff(temp_cache);\n-    if (!WalletBatch(m_storage.GetDatabase()).WriteDescriptorCacheItems(GetID(), diff)) {\n+    if (!batch.WriteDescriptorCacheItems(GetID(), diff)) {\n         throw std::runtime_error(std::string(__func__) + \": writing cache items failed\");\n     }\n }"
      },
      {
        "sha": "38238dd9c6859ee5e5bcf41891dac4a1c1f0a20c",
        "filename": "src/wallet/scriptpubkeyman.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a15c2ca439a993681ba05286682f3056cfe98175/src/wallet/scriptpubkeyman.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a15c2ca439a993681ba05286682f3056cfe98175/src/wallet/scriptpubkeyman.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.h?ref=a15c2ca439a993681ba05286682f3056cfe98175",
        "patch": "@@ -623,7 +623,7 @@ class DescriptorScriptPubKeyMan : public ScriptPubKeyMan\n \n     bool GetDescriptorString(std::string& out) const;\n \n-    void UpgradeDescriptorCache();\n+    void UpgradeDescriptorCache(WalletBatch& batch);\n };\n \n #endif // BITCOIN_WALLET_SCRIPTPUBKEYMAN_H"
      },
      {
        "sha": "eb21c1d2f9e7c3868aa7c120943981d7a373f481",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 4,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a15c2ca439a993681ba05286682f3056cfe98175/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a15c2ca439a993681ba05286682f3056cfe98175/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=a15c2ca439a993681ba05286682f3056cfe98175",
        "patch": "@@ -375,17 +375,17 @@ void CWallet::UpgradeKeyMetadata(WalletBatch& batch)\n     SetWalletFlagWithDB(batch, WALLET_FLAG_KEY_ORIGIN_METADATA);\n }\n \n-void CWallet::UpgradeDescriptorCache()\n+void CWallet::UpgradeDescriptorCache(WalletBatch& batch)\n {\n     if (!IsWalletFlagSet(WALLET_FLAG_DESCRIPTORS) || IsLocked() || IsWalletFlagSet(WALLET_FLAG_LAST_HARDENED_XPUB_CACHED)) {\n         return;\n     }\n \n     for (ScriptPubKeyMan* spkm : GetAllScriptPubKeyMans()) {\n         DescriptorScriptPubKeyMan* desc_spkm = dynamic_cast<DescriptorScriptPubKeyMan*>(spkm);\n-        desc_spkm->UpgradeDescriptorCache();\n+        desc_spkm->UpgradeDescriptorCache(batch);\n     }\n-    SetWalletFlag(WALLET_FLAG_LAST_HARDENED_XPUB_CACHED);\n+    SetWalletFlagWithDB(batch, WALLET_FLAG_LAST_HARDENED_XPUB_CACHED);\n }\n \n bool CWallet::Unlock(const SecureString& strWalletPassphrase, bool accept_no_keys)\n@@ -406,7 +406,7 @@ bool CWallet::Unlock(const SecureString& strWalletPassphrase, bool accept_no_key\n                 WalletBatch batch(GetDatabase());\n                 UpgradeKeyMetadata(batch);\n                 // Now that we've unlocked, upgrade the descriptor cache\n-                UpgradeDescriptorCache();\n+                UpgradeDescriptorCache(batch);\n                 return true;\n             }\n         }"
      },
      {
        "sha": "0bde980b3db3082f9ec6a8de7f9daf20ce46276c",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a15c2ca439a993681ba05286682f3056cfe98175/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a15c2ca439a993681ba05286682f3056cfe98175/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=a15c2ca439a993681ba05286682f3056cfe98175",
        "patch": "@@ -479,7 +479,7 @@ class CWallet final : public WalletStorage, public interfaces::Chain::Notificati\n     void UpgradeKeyMetadata(WalletBatch& batch) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n \n     //! Upgrade DescriptorCaches\n-    void UpgradeDescriptorCache() EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n+    void UpgradeDescriptorCache(WalletBatch& batch) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n \n     bool LoadMinVersion(int nVersion) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet) { AssertLockHeld(cs_wallet); nWalletVersion = nVersion; return true; }\n "
      },
      {
        "sha": "cb54af1c8587180b5866f967a1b38439c80e242d",
        "filename": "src/wallet/walletdb.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a15c2ca439a993681ba05286682f3056cfe98175/src/wallet/walletdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a15c2ca439a993681ba05286682f3056cfe98175/src/wallet/walletdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.cpp?ref=a15c2ca439a993681ba05286682f3056cfe98175",
        "patch": "@@ -893,7 +893,7 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n     // Upgrade all of the descriptor caches to cache the last hardened xpub\n     // This operation is not atomic, but if it fails, only new entries are added so it is backwards compatible\n     try {\n-        pwallet->UpgradeDescriptorCache();\n+        pwallet->UpgradeDescriptorCache(*this);\n     } catch (...) {\n         result = DBErrors::CORRUPT;\n     }"
      }
    ]
  },
  {
    "sha": "271e76831246660be8c9e29b56dd2b92e7461237",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyNzFlNzY4MzEyNDY2NjBiZThjOWUyOWI1NmRkMmI5MmU3NDYxMjM3",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-10-06T20:11:51Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-07-01T17:24:10Z"
      },
      "message": "Limit the scope of WalletBatch in NewKeyPool\n\nMake sure the WalletBatch in NewKeyPool writes and destructs before\nTopUp.",
      "tree": {
        "sha": "35497c98505e9552db2babdbc5d05db3d66f9458",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/35497c98505e9552db2babdbc5d05db3d66f9458"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/271e76831246660be8c9e29b56dd2b92e7461237",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/271e76831246660be8c9e29b56dd2b92e7461237",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/271e76831246660be8c9e29b56dd2b92e7461237",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/271e76831246660be8c9e29b56dd2b92e7461237/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "a15c2ca439a993681ba05286682f3056cfe98175",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a15c2ca439a993681ba05286682f3056cfe98175",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/a15c2ca439a993681ba05286682f3056cfe98175"
      }
    ],
    "stats": {
      "total": 24,
      "additions": 13,
      "deletions": 11
    },
    "files": [
      {
        "sha": "fabd00cca7067d408b147bc177ea4b3d182ca65f",
        "filename": "src/wallet/scriptpubkeyman.cpp",
        "status": "modified",
        "additions": 13,
        "deletions": 11,
        "changes": 24,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/271e76831246660be8c9e29b56dd2b92e7461237/src/wallet/scriptpubkeyman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/271e76831246660be8c9e29b56dd2b92e7461237/src/wallet/scriptpubkeyman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.cpp?ref=271e76831246660be8c9e29b56dd2b92e7461237",
        "patch": "@@ -1216,20 +1216,22 @@ bool LegacyScriptPubKeyMan::NewKeyPool()\n     }\n     {\n         LOCK(cs_KeyStore);\n-        WalletBatch batch(m_storage.GetDatabase());\n+        {\n+            WalletBatch batch(m_storage.GetDatabase());\n \n-        for (const int64_t nIndex : setInternalKeyPool) {\n-            batch.ErasePool(nIndex);\n-        }\n-        setInternalKeyPool.clear();\n+            for (const int64_t nIndex : setInternalKeyPool) {\n+                batch.ErasePool(nIndex);\n+            }\n+            setInternalKeyPool.clear();\n \n-        for (const int64_t nIndex : setExternalKeyPool) {\n-            batch.ErasePool(nIndex);\n-        }\n-        setExternalKeyPool.clear();\n+            for (const int64_t nIndex : setExternalKeyPool) {\n+                batch.ErasePool(nIndex);\n+            }\n+            setExternalKeyPool.clear();\n \n-        for (const int64_t nIndex : set_pre_split_keypool) {\n-            batch.ErasePool(nIndex);\n+            for (const int64_t nIndex : set_pre_split_keypool) {\n+                batch.ErasePool(nIndex);\n+            }\n         }\n         set_pre_split_keypool.clear();\n "
      }
    ]
  },
  {
    "sha": "97eff9a4e8c8b3af083fb67bb82f7c345c466bb7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5N2VmZjlhNGU4YzhiM2FmMDgzZmI2N2JiODJmN2MzNDVjNDY2YmI3",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-10-06T20:53:57Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-07-01T17:24:10Z"
      },
      "message": "Have LearnRelatedScripts and LearnAllRelatedScripts take WalletBatch",
      "tree": {
        "sha": "5b513f39aa1d1a7548fd112c7d39407ef3a8d9fc",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5b513f39aa1d1a7548fd112c7d39407ef3a8d9fc"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/97eff9a4e8c8b3af083fb67bb82f7c345c466bb7",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/97eff9a4e8c8b3af083fb67bb82f7c345c466bb7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/97eff9a4e8c8b3af083fb67bb82f7c345c466bb7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/97eff9a4e8c8b3af083fb67bb82f7c345c466bb7/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "271e76831246660be8c9e29b56dd2b92e7461237",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/271e76831246660be8c9e29b56dd2b92e7461237",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/271e76831246660be8c9e29b56dd2b92e7461237"
      }
    ],
    "stats": {
      "total": 19,
      "additions": 10,
      "deletions": 9
    },
    "files": [
      {
        "sha": "7ed9f7cb677588264241abffbbd5ab91b9c53bbf",
        "filename": "src/wallet/scriptpubkeyman.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 7,
        "changes": 15,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/97eff9a4e8c8b3af083fb67bb82f7c345c466bb7/src/wallet/scriptpubkeyman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/97eff9a4e8c8b3af083fb67bb82f7c345c466bb7/src/wallet/scriptpubkeyman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.cpp?ref=97eff9a4e8c8b3af083fb67bb82f7c345c466bb7",
        "patch": "@@ -37,7 +37,8 @@ bool LegacyScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestinat\n         error = _(\"Error: Keypool ran out, please call keypoolrefill first\").translated;\n         return false;\n     }\n-    LearnRelatedScripts(new_key, type);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    LearnRelatedScripts(batch, new_key, type);\n     dest = GetDestinationForKey(new_key, type);\n     return true;\n }\n@@ -1316,7 +1317,7 @@ void LegacyScriptPubKeyMan::KeepDestination(int64_t nIndex, const OutputType& ty\n     CPubKey pubkey;\n     bool have_pk = GetPubKey(m_index_to_reserved_key.at(nIndex), pubkey);\n     assert(have_pk);\n-    LearnRelatedScripts(pubkey, type);\n+    LearnRelatedScripts(batch ,pubkey, type);\n     m_index_to_reserved_key.erase(nIndex);\n     WalletLogPrintf(\"keypool keep %d\\n\", nIndex);\n }\n@@ -1410,22 +1411,22 @@ bool LegacyScriptPubKeyMan::ReserveKeyFromKeyPool(int64_t& nIndex, CKeyPool& key\n     return true;\n }\n \n-void LegacyScriptPubKeyMan::LearnRelatedScripts(const CPubKey& key, OutputType type)\n+void LegacyScriptPubKeyMan::LearnRelatedScripts(WalletBatch& batch, const CPubKey& key, OutputType type)\n {\n     assert(type != OutputType::BECH32M);\n     if (key.IsCompressed() && (type == OutputType::P2SH_SEGWIT || type == OutputType::BECH32)) {\n         CTxDestination witdest = WitnessV0KeyHash(key.GetID());\n         CScript witprog = GetScriptForDestination(witdest);\n         // Make sure the resulting program is solvable.\n         assert(IsSolvable(*this, witprog));\n-        AddCScript(witprog);\n+        AddCScriptWithDB(batch, witprog);\n     }\n }\n \n-void LegacyScriptPubKeyMan::LearnAllRelatedScripts(const CPubKey& key)\n+void LegacyScriptPubKeyMan::LearnAllRelatedScripts(WalletBatch& batch, const CPubKey& key)\n {\n     // OutputType::P2SH_SEGWIT always adds all necessary scripts for all types.\n-    LearnRelatedScripts(key, OutputType::P2SH_SEGWIT);\n+    LearnRelatedScripts(batch, key, OutputType::P2SH_SEGWIT);\n }\n \n void LegacyScriptPubKeyMan::MarkReserveKeysAsUsed(int64_t keypool_id)\n@@ -1445,7 +1446,7 @@ void LegacyScriptPubKeyMan::MarkReserveKeysAsUsed(int64_t keypool_id)\n         if (batch.ReadPool(index, keypool)) { //TODO: This should be unnecessary\n             m_pool_key_to_index.erase(keypool.vchPubKey.GetID());\n         }\n-        LearnAllRelatedScripts(keypool.vchPubKey);\n+        LearnAllRelatedScripts(batch, keypool.vchPubKey);\n         batch.ErasePool(index);\n         WalletLogPrintf(\"keypool index %d removed\\n\", index);\n         it = setKeyPool->erase(it);"
      },
      {
        "sha": "b6083f5c7bee91abb0ac448416df1ac76257a8b5",
        "filename": "src/wallet/scriptpubkeyman.h",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/97eff9a4e8c8b3af083fb67bb82f7c345c466bb7/src/wallet/scriptpubkeyman.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/97eff9a4e8c8b3af083fb67bb82f7c345c466bb7/src/wallet/scriptpubkeyman.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.h?ref=97eff9a4e8c8b3af083fb67bb82f7c345c466bb7",
        "patch": "@@ -483,13 +483,13 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n      * software, as FillableSigningProvider automatically does this implicitly for all\n      * keys now.\n      */\n-    void LearnRelatedScripts(const CPubKey& key, OutputType);\n+    void LearnRelatedScripts(WalletBatch& batch, const CPubKey& key, OutputType);\n \n     /**\n      * Same as LearnRelatedScripts, but when the OutputType is not known (and could\n      * be anything).\n      */\n-    void LearnAllRelatedScripts(const CPubKey& key);\n+    void LearnAllRelatedScripts(WalletBatch& batch, const CPubKey& key);\n \n     /**\n      * Marks all keys in the keypool up to and including reserve_key as used."
      }
    ]
  },
  {
    "sha": "edc201e3ac4bffdbce7eead6ab4f23e606dcaa2d",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplZGMyMDFlM2FjNGJmZmRiY2U3ZWVhZDZhYjRmMjNlNjA2ZGNhYTJk",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-10-06T20:54:19Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-07-01T17:24:10Z"
      },
      "message": "Limit scope of WalletBatch in SetupDescriptorGeneration",
      "tree": {
        "sha": "3db4ba877888a68a0e3dd95e053615629e62bc5f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3db4ba877888a68a0e3dd95e053615629e62bc5f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/edc201e3ac4bffdbce7eead6ab4f23e606dcaa2d",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/edc201e3ac4bffdbce7eead6ab4f23e606dcaa2d",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/edc201e3ac4bffdbce7eead6ab4f23e606dcaa2d",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/edc201e3ac4bffdbce7eead6ab4f23e606dcaa2d/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "97eff9a4e8c8b3af083fb67bb82f7c345c466bb7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/97eff9a4e8c8b3af083fb67bb82f7c345c466bb7",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/97eff9a4e8c8b3af083fb67bb82f7c345c466bb7"
      }
    ],
    "stats": {
      "total": 16,
      "additions": 9,
      "deletions": 7
    },
    "files": [
      {
        "sha": "6005cf56c025d07a6edb23f2c0472190dadabf25",
        "filename": "src/wallet/scriptpubkeyman.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 7,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/edc201e3ac4bffdbce7eead6ab4f23e606dcaa2d/src/wallet/scriptpubkeyman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/edc201e3ac4bffdbce7eead6ab4f23e606dcaa2d/src/wallet/scriptpubkeyman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.cpp?ref=edc201e3ac4bffdbce7eead6ab4f23e606dcaa2d",
        "patch": "@@ -1935,18 +1935,20 @@ bool DescriptorScriptPubKeyMan::SetupDescriptorGeneration(const CExtKey& master_\n     m_wallet_descriptor = w_desc;\n \n     // Store the master private key, and descriptor\n-    WalletBatch batch(m_storage.GetDatabase());\n-    if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n-        throw std::runtime_error(std::string(__func__) + \": writing descriptor master private key failed\");\n-    }\n-    if (!batch.WriteDescriptor(GetID(), m_wallet_descriptor)) {\n-        throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+    {\n+        WalletBatch batch(m_storage.GetDatabase());\n+        if (!AddDescriptorKeyWithDB(batch, master_key.key, master_key.key.GetPubKey())) {\n+            throw std::runtime_error(std::string(__func__) + \": writing descriptor master private key failed\");\n+        }\n+        if (!batch.WriteDescriptor(GetID(), m_wallet_descriptor)) {\n+            throw std::runtime_error(std::string(__func__) + \": writing descriptor failed\");\n+        }\n+        m_storage.UnsetBlankWalletFlag(batch);\n     }\n \n     // TopUp\n     TopUp();\n \n-    m_storage.UnsetBlankWalletFlag(batch);\n     return true;\n }\n "
      }
    ]
  },
  {
    "sha": "59b2162ea345ed13162d671d90a22e73fba3d629",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1OWIyMTYyZWEzNDVlZDEzMTYyZDY3MWQ5MGEyMmU3M2ZiYTNkNjI5",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-10-06T21:28:28Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-07-01T17:24:10Z"
      },
      "message": "Add RemoveWatchOnlyWithDB",
      "tree": {
        "sha": "bcdfa8a95cbf8ae8b0d093caac2ce9226bd5e4a8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/bcdfa8a95cbf8ae8b0d093caac2ce9226bd5e4a8"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/59b2162ea345ed13162d671d90a22e73fba3d629",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/59b2162ea345ed13162d671d90a22e73fba3d629",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/59b2162ea345ed13162d671d90a22e73fba3d629",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/59b2162ea345ed13162d671d90a22e73fba3d629/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "edc201e3ac4bffdbce7eead6ab4f23e606dcaa2d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/edc201e3ac4bffdbce7eead6ab4f23e606dcaa2d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/edc201e3ac4bffdbce7eead6ab4f23e606dcaa2d"
      }
    ],
    "stats": {
      "total": 13,
      "additions": 10,
      "deletions": 3
    },
    "files": [
      {
        "sha": "bbaa60e7d3660e27adf95baebc84ff6349bd0c28",
        "filename": "src/wallet/scriptpubkeyman.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 3,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/59b2162ea345ed13162d671d90a22e73fba3d629/src/wallet/scriptpubkeyman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/59b2162ea345ed13162d671d90a22e73fba3d629/src/wallet/scriptpubkeyman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.cpp?ref=59b2162ea345ed13162d671d90a22e73fba3d629",
        "patch": "@@ -736,11 +736,11 @@ bool LegacyScriptPubKeyMan::AddKeyPubKeyWithDB(WalletBatch& batch, const CKey& s\n     CScript script;\n     script = GetScriptForDestination(PKHash(pubkey));\n     if (HaveWatchOnly(script)) {\n-        RemoveWatchOnly(script);\n+        RemoveWatchOnlyWithDB(batch, script);\n     }\n     script = GetScriptForRawPubKey(pubkey);\n     if (HaveWatchOnly(script)) {\n-        RemoveWatchOnly(script);\n+        RemoveWatchOnlyWithDB(batch, script);\n     }\n \n     if (!m_storage.HasEncryptionKeys()) {\n@@ -862,6 +862,12 @@ static bool ExtractPubKey(const CScript &dest, CPubKey& pubKeyOut)\n }\n \n bool LegacyScriptPubKeyMan::RemoveWatchOnly(const CScript &dest)\n+{\n+    WalletBatch batch(m_storage.GetDatabase());\n+    return RemoveWatchOnlyWithDB(batch, dest);\n+}\n+\n+bool LegacyScriptPubKeyMan::RemoveWatchOnlyWithDB(WalletBatch& batch, const CScript &dest)\n {\n     {\n         LOCK(cs_KeyStore);\n@@ -876,7 +882,7 @@ bool LegacyScriptPubKeyMan::RemoveWatchOnly(const CScript &dest)\n \n     if (!HaveWatchOnly())\n         NotifyWatchonlyChanged(false);\n-    if (!WalletBatch(m_storage.GetDatabase()).EraseWatchOnly(dest))\n+    if (!batch.EraseWatchOnly(dest))\n         return false;\n \n     return true;"
      },
      {
        "sha": "c8718fb609768bebdc2e617c4d128f511aac16db",
        "filename": "src/wallet/scriptpubkeyman.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/59b2162ea345ed13162d671d90a22e73fba3d629/src/wallet/scriptpubkeyman.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/59b2162ea345ed13162d671d90a22e73fba3d629/src/wallet/scriptpubkeyman.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.h?ref=59b2162ea345ed13162d671d90a22e73fba3d629",
        "patch": "@@ -440,6 +440,7 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n     bool HaveWatchOnly() const;\n     //! Remove a watch only script from the keystore\n     bool RemoveWatchOnly(const CScript &dest);\n+    bool RemoveWatchOnlyWithDB(WalletBatch& batch, const CScript &dest);\n     bool AddWatchOnly(const CScript& dest, int64_t nCreateTime) EXCLUSIVE_LOCKS_REQUIRED(cs_KeyStore);\n \n     //! Fetches a pubkey from mapWatchKeys if it exists there"
      }
    ]
  },
  {
    "sha": "9a9a5dbfcb53026739e0d2f40b781021d036e373",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5YTlhNWRiZmNiNTMwMjY3MzllMGQyZjQwYjc4MTAyMWQwMzZlMzcz",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-10-06T21:47:50Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-07-01T17:24:10Z"
      },
      "message": "Enforce that only one BerkeleyBatch exists at a time",
      "tree": {
        "sha": "7ef809064f65bb4d548005a012615af56f2d7dca",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7ef809064f65bb4d548005a012615af56f2d7dca"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9a9a5dbfcb53026739e0d2f40b781021d036e373",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9a9a5dbfcb53026739e0d2f40b781021d036e373",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/9a9a5dbfcb53026739e0d2f40b781021d036e373",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9a9a5dbfcb53026739e0d2f40b781021d036e373/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "59b2162ea345ed13162d671d90a22e73fba3d629",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/59b2162ea345ed13162d671d90a22e73fba3d629",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/59b2162ea345ed13162d671d90a22e73fba3d629"
      }
    ],
    "stats": {
      "total": 1,
      "additions": 1,
      "deletions": 0
    },
    "files": [
      {
        "sha": "293136409263bab2d15b8edda9e194e29f01b144",
        "filename": "src/wallet/bdb.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9a9a5dbfcb53026739e0d2f40b781021d036e373/src/wallet/bdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9a9a5dbfcb53026739e0d2f40b781021d036e373/src/wallet/bdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/bdb.cpp?ref=9a9a5dbfcb53026739e0d2f40b781021d036e373",
        "patch": "@@ -808,6 +808,7 @@ void BerkeleyDatabase::AddRef()\n     } else {\n         m_refcount++;\n     }\n+    assert(m_refcount <= 1);\n }\n \n void BerkeleyDatabase::RemoveRef()"
      }
    ]
  },
  {
    "sha": "a4e761a5d10b1aea2d95495f496e3cdeceb249f6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphNGU3NjFhNWQxMGIxYWVhMmQ5NTQ5NWY0OTZlM2NkZWNlYjI0OWY2",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-10-06T22:04:35Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-07-01T17:24:10Z"
      },
      "message": "Remove AddRef and RemoveRef from WalletDatabase",
      "tree": {
        "sha": "54e1f4bdc7573bac4f0fe552faaecf20b94779c1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/54e1f4bdc7573bac4f0fe552faaecf20b94779c1"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a4e761a5d10b1aea2d95495f496e3cdeceb249f6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a4e761a5d10b1aea2d95495f496e3cdeceb249f6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a4e761a5d10b1aea2d95495f496e3cdeceb249f6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a4e761a5d10b1aea2d95495f496e3cdeceb249f6/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "9a9a5dbfcb53026739e0d2f40b781021d036e373",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9a9a5dbfcb53026739e0d2f40b781021d036e373",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/9a9a5dbfcb53026739e0d2f40b781021d036e373"
      }
    ],
    "stats": {
      "total": 19,
      "additions": 4,
      "deletions": 15
    },
    "files": [
      {
        "sha": "6d50d4d8e2a4b934b85f573ff55bcbfd72e05ded",
        "filename": "src/wallet/bdb.h",
        "status": "modified",
        "additions": 4,
        "deletions": 2,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a4e761a5d10b1aea2d95495f496e3cdeceb249f6/src/wallet/bdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a4e761a5d10b1aea2d95495f496e3cdeceb249f6/src/wallet/bdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/bdb.h?ref=a4e761a5d10b1aea2d95495f496e3cdeceb249f6",
        "patch": "@@ -113,10 +113,12 @@ class BerkeleyDatabase : public WalletDatabase\n      */\n     bool Rewrite(const char* pszSkip=nullptr) override;\n \n+    //! Counts the number of active database users to be sure that the database is not closed while someone is using it\n+    std::atomic<int> m_refcount{0};\n     /** Indicate the a new database user has began using the database. */\n-    void AddRef() override;\n+    void AddRef();\n     /** Indicate that database user has stopped using the database and that it could be flushed or closed. */\n-    void RemoveRef() override;\n+    void RemoveRef();\n \n     /** Back up the entire database to a file.\n      */"
      },
      {
        "sha": "f0e410d5f3bba1a85b562864ea389dc8e635ff9e",
        "filename": "src/wallet/db.h",
        "status": "modified",
        "additions": 0,
        "deletions": 9,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a4e761a5d10b1aea2d95495f496e3cdeceb249f6/src/wallet/db.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a4e761a5d10b1aea2d95495f496e3cdeceb249f6/src/wallet/db.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/db.h?ref=a4e761a5d10b1aea2d95495f496e3cdeceb249f6",
        "patch": "@@ -110,13 +110,6 @@ class WalletDatabase\n     /** Open the database if it is not already opened. */\n     virtual void Open() = 0;\n \n-    //! Counts the number of active database users to be sure that the database is not closed while someone is using it\n-    std::atomic<int> m_refcount{0};\n-    /** Indicate the a new database user has began using the database. Increments m_refcount */\n-    virtual void AddRef() = 0;\n-    /** Indicate that database user has stopped using the database and that it could be flushed or closed. Decrement m_refcount */\n-    virtual void RemoveRef() = 0;\n-\n     /** Rewrite the entire database on disk, with the exception of key pszSkip if non-zero\n      */\n     virtual bool Rewrite(const char* pszSkip=nullptr) = 0;\n@@ -181,8 +174,6 @@ class DummyDatabase : public WalletDatabase\n {\n public:\n     void Open() override {};\n-    void AddRef() override {}\n-    void RemoveRef() override {}\n     bool Rewrite(const char* pszSkip=nullptr) override { return true; }\n     bool Backup(const std::string& strDest) const override { return true; }\n     void Close() override {}"
      },
      {
        "sha": "ed098cf528b6090ddf94b9218b2a797d1bd73439",
        "filename": "src/wallet/sqlite.h",
        "status": "modified",
        "additions": 0,
        "deletions": 4,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a4e761a5d10b1aea2d95495f496e3cdeceb249f6/src/wallet/sqlite.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a4e761a5d10b1aea2d95495f496e3cdeceb249f6/src/wallet/sqlite.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/sqlite.h?ref=a4e761a5d10b1aea2d95495f496e3cdeceb249f6",
        "patch": "@@ -79,10 +79,6 @@ class SQLiteDatabase : public WalletDatabase\n     /** Close the database */\n     void Close() override;\n \n-    /* These functions are unused */\n-    void AddRef() override { assert(false); }\n-    void RemoveRef() override { assert(false); }\n-\n     /** Rewrite the entire database on disk */\n     bool Rewrite(const char* skip = nullptr) override;\n "
      }
    ]
  }
]