[
  {
    "sha": "24cad6353921e81f3701b527745e46b80d441e8a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyNGNhZDYzNTM5MjFlODFmMzcwMWI1Mjc3NDVlNDZiODBkNDQxZThh",
    "commit": {
      "author": {
        "name": "Vasil Dimov",
        "email": "vd@FreeBSD.org",
        "date": "2021-07-16T16:06:07Z"
      },
      "committer": {
        "name": "Vasil Dimov",
        "email": "vd@FreeBSD.org",
        "date": "2021-07-16T16:27:28Z"
      },
      "message": "addrman: reset I2P ports in all \"new\" buckets\n\nIn `CAddrMan::ResetI2PPorts()`, if an I2P address is found in two or\nmore \"new\" buckets, our first encounter of it would change the port to\n0 and re-position it within that \"new\" bucket. The `CAddrInfo` object is\nshared between all occurrences of an address in all \"new\" buckets. So\nsubsequent encounters of that address will see the `CAddrInfo` already\nwith port 0 and will skip re-positioning.\n\nTo fix that, check and re-position if necessary even for I2P entries\nwith port 0.\n\nFixes https://github.com/bitcoin/bitcoin/issues/22470",
      "tree": {
        "sha": "14cbd30ad0764d7dd5b091aef85fbc38154fa7da",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/14cbd30ad0764d7dd5b091aef85fbc38154fa7da"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/24cad6353921e81f3701b527745e46b80d441e8a",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQQzBAABCAAdFiEE5k2NRWFNsHVF2czBVN8G9ktVy78FAmDxs3YACgkQVN8G9ktV\ny7/WfB//UOT0kTa5bLQ8iC/V2OpO56+gzP57s6MwOmKMwUvJaCWbha8NlJ1m75N3\nKsi5vpOa6uAyt8ZLwFbnqo1K1neoVZWTfNINwfnJ5Sj9wEGJdze21mMAIOrbIwzB\nG1QuCJEf6ZqDUQvPfERcmVn2H6835Lhf0U0gROUCrop+eNCOcnwZY8TJRiL/+Gyw\ndIBwPUAyg4vTKJrCLP3Uc05U/7jUb//+6jIUCvGf/sUaZ0n4cd1ZS9NrrvGZMQIa\nH3aIsLgo33V00pwLNhoOdo0v0aV0VCsXmIX/ftNMDRUeyY228qZ+qdnqSfYC6SfG\neO9w8YWVi3YRiVsY+skin2onHfowIu8HDYs41tGSGqZwQVA4VUm0Nsaezpxevxra\naNUEWI59JM0jkg6lgY5AkNiztWhd4mZxv5gYlOgKooFJiWStasedp8PNRR6t88MV\nbv5gyvS888x5/fbQiGz/itG9c51u94xojrYG12E1C6RP2ee0rPKzKgs13eCf6hBB\n/SjbTkSL3fC4aUcYe6iVBfAO56kO/E+OcjxZbfDhZmSKF4vFCN22truG+6mxaYZ3\nx+t6OqiNf6FcoAdLCfBOpaEwKDxLfPtT5n0J7vPjkDaNa8fNvcMXnx9coyo2r6J/\nxYPDP9xAI3SmLPZ+IEKUVi0QSnVQXG89WxaLKSPzKf1ZoSf2396ESIjU5SOJyteI\nnRF/HjGagVxN7S5XPjM/ugIVR448XCK4ydAbXFkbQyExHZJMhsq0Zzrm/+iEX9Q5\n16FlyfLFA1sxvhbWxT7T206jAl/QGB3zsTsfwaMxK7C3UQei0V5tJVf121UJOKfd\niMs8PTW0ikYtjh0smAecsApbk39oYXCWzTu+WZ5WLvvPau1UZ1ZFxEvX6i0W2Gov\n1xDiZvCnOht2rLXkp26atb4f8aLfMR8wwPuU1ByUaxh0UccYTcmoxR943rnm8qGv\n0K8nC+DFXWPwWPthxZhEK1Jq0HDz3637xJvZRJNQNE5I1tibxu0rqeMlsSbECrkK\nPU88ffxZKuIpulpeFSJQdPtaBcgkaYcYY4CbUVHFW5ipO9iyntShk0WAB6cxokce\nhHrNNS69o+HTm3bw0gwJ6AnwucDXj5CbIHCKp7qUWuVpefY+yZq3yV15zpFrfnVN\ne8wNXejXvSvh03a2j2AeQoCVFSUwFXsdZCHDtKc6RrAp60DjiD2mHzgmUiFhTg7A\nJp5IDDcLsUiEmJkIbYdkWVlGIXbT4kHCwLEIBdA/iv++VEtCIk0tbxUXh0ssqgzA\nPRf96YG4ZoB3SJCRKdDtcKr1SeW5ZGYapNnvw8e/0wAzUgW25qHgeykulEPFWU7n\nkosGmDY+FmNhnSN5aJWz15UL6cQFmw==\n=Fm6O\n-----END PGP SIGNATURE-----",
        "payload": "tree 14cbd30ad0764d7dd5b091aef85fbc38154fa7da\nparent f8b20fd35b0eb42d28afb302a070e5d9bc21a99f\nauthor Vasil Dimov <vd@FreeBSD.org> 1626451567 +0200\ncommitter Vasil Dimov <vd@FreeBSD.org> 1626452848 +0200\n\naddrman: reset I2P ports in all \"new\" buckets\n\nIn `CAddrMan::ResetI2PPorts()`, if an I2P address is found in two or\nmore \"new\" buckets, our first encounter of it would change the port to\n0 and re-position it within that \"new\" bucket. The `CAddrInfo` object is\nshared between all occurrences of an address in all \"new\" buckets. So\nsubsequent encounters of that address will see the `CAddrInfo` already\nwith port 0 and will skip re-positioning.\n\nTo fix that, check and re-position if necessary even for I2P entries\nwith port 0.\n\nFixes https://github.com/bitcoin/bitcoin/issues/22470\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/24cad6353921e81f3701b527745e46b80d441e8a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/24cad6353921e81f3701b527745e46b80d441e8a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/24cad6353921e81f3701b527745e46b80d441e8a/comments",
    "author": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f8b20fd35b0eb42d28afb302a070e5d9bc21a99f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f8b20fd35b0eb42d28afb302a070e5d9bc21a99f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f8b20fd35b0eb42d28afb302a070e5d9bc21a99f"
      }
    ],
    "stats": {
      "total": 27,
      "additions": 24,
      "deletions": 3
    },
    "files": [
      {
        "sha": "14bb22329ac74b8bf41bc5d89ccc2961f5cabbc9",
        "filename": "src/addrman.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/24cad6353921e81f3701b527745e46b80d441e8a/src/addrman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/24cad6353921e81f3701b527745e46b80d441e8a/src/addrman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/addrman.cpp?ref=24cad6353921e81f3701b527745e46b80d441e8a",
        "patch": "@@ -746,7 +746,7 @@ void CAddrMan::ResetI2PPorts()\n                 return;\n             }\n             auto& addr_info = it->second;\n-            if (!addr_info.IsI2P() || addr_info.GetPort() == I2P_SAM31_PORT) {\n+            if (!addr_info.IsI2P()) {\n                 continue;\n             }\n "
      },
      {
        "sha": "d0e29702060d77a754ba37a4a3c42a65c4212fb8",
        "filename": "src/test/addrman_tests.cpp",
        "status": "modified",
        "additions": 23,
        "deletions": 2,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/24cad6353921e81f3701b527745e46b80d441e8a/src/test/addrman_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/24cad6353921e81f3701b527745e46b80d441e8a/src/test/addrman_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/addrman_tests.cpp?ref=24cad6353921e81f3701b527745e46b80d441e8a",
        "patch": "@@ -1000,6 +1000,13 @@ BOOST_AUTO_TEST_CASE(reset_i2p_ports)\n         NODE_NONE,\n         good_time};\n \n+    // Will be located in 2 new buckets (due to coming from 2 different sources).\n+    // Has its port changed, repositioned in the 2 new buckets and afterwards we make it \"tried\".\n+    const CAddress i2p_new5{\n+        ResolveService(\"zsxwyo6qcn3chqzwxnseusqgsnuw3maqnztkiypyfxtya4snkoka.b32.i2p\", port),\n+        NODE_NONE,\n+        good_time};\n+\n     // Remains unchanged.\n     const CAddress ipv4_new{ResolveService(\"1.2.3.4\", port), NODE_NONE, good_time};\n \n@@ -1040,6 +1047,10 @@ BOOST_AUTO_TEST_CASE(reset_i2p_ports)\n     addrman1.Add(i2p_new2, source);\n     addrman1.Add(i2p_new3, source);\n     addrman1.Add(i2p_new4, source);\n+    addrman1.Add(i2p_new5, source);\n+    CAddress i2p_new5_updated_time{i2p_new5};\n+    ++i2p_new5_updated_time.nTime;\n+    addrman1.Add(i2p_new5_updated_time, ResolveIP(\"1.2.3.4\"));\n     addrman1.Add(ipv4_new, source);\n \n     addrman1.Add(i2p_tried1, source);\n@@ -1060,7 +1071,7 @@ BOOST_AUTO_TEST_CASE(reset_i2p_ports)\n     const size_t max_pct{0};\n \n     auto addresses = addrman2.GetAddr(max_addresses, max_pct, NET_I2P);\n-    BOOST_REQUIRE_EQUAL(addresses.size(), 7UL);\n+    BOOST_REQUIRE_EQUAL(addresses.size(), 8UL);\n     std::sort(addresses.begin(), addresses.end()); // Just some deterministic order.\n     BOOST_CHECK_EQUAL(addresses[0].ToStringIP(), i2p_new4.ToStringIP());\n     BOOST_CHECK_EQUAL(addresses[0].GetPort(), I2P_SAM31_PORT);\n@@ -1074,8 +1085,18 @@ BOOST_AUTO_TEST_CASE(reset_i2p_ports)\n     BOOST_CHECK_EQUAL(addresses[4].GetPort(), I2P_SAM31_PORT);\n     BOOST_CHECK_EQUAL(addresses[5].ToStringIP(), i2p_tried2.ToStringIP());\n     BOOST_CHECK_EQUAL(addresses[5].GetPort(), I2P_SAM31_PORT);\n-    BOOST_CHECK_EQUAL(addresses[6].ToStringIP(), i2p_new1.ToStringIP());\n+    BOOST_CHECK_EQUAL(addresses[6].ToStringIP(), i2p_new5.ToStringIP());\n     BOOST_CHECK_EQUAL(addresses[6].GetPort(), I2P_SAM31_PORT);\n+    BOOST_CHECK_EQUAL(addresses[7].ToStringIP(), i2p_new1.ToStringIP());\n+    BOOST_CHECK_EQUAL(addresses[7].GetPort(), I2P_SAM31_PORT);\n+\n+    const CAddress i2p_new5_changed_port{\n+        ResolveService(\"zsxwyo6qcn3chqzwxnseusqgsnuw3maqnztkiypyfxtya4snkoka.b32.i2p\",\n+                       I2P_SAM31_PORT),\n+        NODE_NONE,\n+        good_time};\n+    // Crashes due to https://github.com/bitcoin/bitcoin/issues/22470\n+    addrman2.Good(i2p_new5_changed_port);\n \n     addresses = addrman2.GetAddr(max_addresses, max_pct, NET_IPV4);\n     BOOST_REQUIRE_EQUAL(addresses.size(), 2UL);"
      }
    ]
  }
]