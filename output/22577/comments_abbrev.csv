LarryRuane,2021-07-28 22:33:41,"The easiest way to reproduce this problem is to apply this patch, and then start `bitcoind` normally. This delays the main thread from loading the block index for 60 seconds.\n```diff\n--- a/src/init.cpp\n+++ b/src/init.cpp\n@@ -1343,6 +1343,7 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n         bilingual_str strLoadError;\n \n         uiInterface.In",https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-888664132,888664132,
DrahtBot,2021-07-29 03:33:47,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#20295](https://github.com/bitcoin/bitcoin/pull/20295) (rpc: getblockfrompeer by Sjors)\n\nIf you consider this pull requ",https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-888774167,888774167,
Crypt-iQ,2021-07-29 18:01:22,I have also received this failure when running the functional tests under ASAN in parallel.,https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-889348674,889348674,
MarcoFalke,2021-07-30 09:34:49,Wouldn't it make more sense to delay scheduling until later? Identical to how Connman does it?,https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-889769312,889769312,
LarryRuane,2021-07-30 22:42:10,"@MarcoFalke\n> Wouldn't it make more sense to delay scheduling until later? Identical to how Connman does it?\n\nGood idea, thanks! After more investigation, I think the root problem is that the peer manager's background tasks are started from `PeerManagerImpl()` constructor. The new version separates the starting of these background tasks from the constructor. It's done from a new method, `Sta",https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-890223175,890223175,
tryphe,2021-07-31 01:23:03,"Can we reproduce the crash with the new commit, or should it never occur now? I expected to see some removed code. Cheers.",https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-890271631,890271631,
LarryRuane,2021-07-31 02:40:29,You can reproduce the crash by running master plus the [patch](https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-888664132). This PR branch (either the first version or the current version) plus the patch should not reproduce the crash.\n\nThe reason there's no removed code (removing the first version) is because I did a force-push.,https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-890279856,890279856,
MarcoFalke,2021-07-31 06:11:19,cr ACK 703b1e612a4bd4521e20ae21eb8fb7c19f4ef942,https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-890298433,890298433,
tryphe,2021-08-02 05:12:53,"tested ACK 703b1e612a4bd4521e20ae21eb8fb7c19f4ef942\n\nApproach ACK, prefer over the original changes conceptually. I find myself asking whether replacing a pointer check(https://github.com/bitcoin/bitcoin/commit/c0f913de644bf5516bcfae0cc8a87c449ba80596) with a whole new async task is worth it. Code-wise I think this adds a little abstraction, but it seems like the right direction, however.\n\",https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-890721436,890721436,
LarryRuane,2021-08-02 17:54:26,"@tryphe\n> ... a whole new async task ...\n\nIt's not a new async task; all this PR does is move where the two peer-related async tasks are started to a later time during system initialization.\n\n> Downside: can't insert a wrench in this code to duplicate the original bad behavior ...\n\nI'm unclear on what you mean, and same with your earlier comment:\n\n> ... I'm wondering if there's a",https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-891218240,891218240,
0xB10C,2021-08-02 21:45:47,"ACK 703b1e612a4bd4521e20ae21eb8fb7c19f4ef942\n\nTested that master crashes with the patch from https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-888664132 and that 703b1e612a4bd4521e20ae21eb8fb7c19f4ef942 does not crash anymore.",https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-891355420,891355420,
MarcoFalke,2021-08-03 07:42:56,">     ... I'm wondering if there's a creative way to reproduce it against the new commit ...\n\nIt should be possible to reproduce again by moving the `node.peerman->StartScheduledTasks(*node.scheduler);` to right after the make_unique.",https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-891615490,891615490,
LarryRuane,2021-08-04 14:51:12,"@tryphe, Marco's comment helped me understand what you're asking for. You're looking for a patch to apply to the latest code that will cause the failure. \n<details>\n  <summary>Here's the patch that Marco suggested that should reproduce the problem (apply to this PR)</summary>\n  \n```diff\n--- a/src/init.cpp\n+++ b/src/init.cpp\n@@ -1181,6 +1181,7 @@ bool AppInitMain(NodeContext& node, in",https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-892724230,892724230,
DrahtBot,2021-08-04 15:42:20,"<!--cf906140f33d8803c4a75a2196329ecb-->\nüêô This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a ""draft"".</sub>",https://github.com/bitcoin/bitcoin/pull/22577#issuecomment-892765442,892765442,
tryphe,2021-07-31 03:34:00,"Nit: `CTxMemPool& pool,` can be moved to the line above to fill in the extra space that has been created.\n\nThere are four other lines in the commit that could use the same spacing fix:\nnet_processing.cpp:1401\nnet_processing.cpp:1408\nnet_processing.h:41\ntest/util/setup_common.cpp:201\n\nIt doesn't really matter too much but could save a future nit PR, although makes this code review s",https://github.com/bitcoin/bitcoin/pull/22577#discussion_r680299071,680299071,src/net_processing.cpp
LarryRuane,2021-08-02 01:45:00,"Thank you, I thought about doing that but decided it would be better to minimize the diff. Also, `clang-format-diff.py` didn't suggest doing that.",https://github.com/bitcoin/bitcoin/pull/22577#discussion_r680604671,680604671,src/net_processing.cpp
