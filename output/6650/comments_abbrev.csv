sipa,2015-09-08T00:10:45Z,"Concept ACK, this looks pretty good already.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-138394775,138394775,
gmaxwell,2015-09-08T00:17:52Z,"Concept and approach ACK.  Obviously this will need a fair amount of testing. (In particular we should get an AV afflicted system and confirm this fixes it).\n\nI think it should be on by default. The people who need this won't know they need it, anyone who doesn't need it will quickly figure it out.  (Do other people have opinions?)\n\nI'm not even sure if we should support turning it off?  It's ",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-138395911,138395911,
sipa,2015-09-08T00:20:55Z,"@gmaxwell The only argument against supporting unobfuscated is 1) it would need upgrading code (but I think that's pretty simple, though supporting stop/restart in the middle is not trivial) 2) it would break backward compatibility.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-138396050,138396050,
jamesob,2015-09-08T00:22:58Z,"@gmaxwell I agree that having the obfuscation enabled is a sane (and safe) default, but is it acceptable for that `runtime_error` to be thrown on upgrade for everyone with an existing chainstate? Seems harsh. Is it desirable to find a more gentle way of doing the migration?\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-138396152,138396152,
luke-jr,2015-09-08T00:28:51Z,This is why supporting mixed obfuscated/unobfuscated is nice: no slow upgrade process. :)\n,https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-138396647,138396647,
jamesob,2015-09-08T01:23:40Z,"@luke-jr I do think the mixed migration is a better option if we're going to enforce this (or even make it the default behavior). Will implement if @gmaxwell, @laanwj agree.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-138402569,138402569,
jgarzik,2015-09-08T02:30:42Z,As noted in https://github.com/bitcoin/bitcoin/issues/6613#issuecomment-138409602 a mix of cleartext and obfu-text does not actually fix the problem seem in the field for active users.\n\nUsers reporting this problem will still see the problem after upgrading to a release with this feature.\n,https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-138412438,138412438,
jamesob,2015-09-08T04:27:56Z,I've integrated @gmaxwell's suggestion and I think it's looking much better.\n,https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-138426908,138426908,
jamesob,2015-09-08T07:06:12Z,"`CLevelDBBatch` needs a good refactoring at some point... unless there's something I'm not seeing, it should probably be absorbed into `CLevelDBWrapper`.That may be out of scope for this PR, though.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-138457038,138457038,
jamesob,2015-09-08T07:08:05Z,"Now that I think about it, the `Batch` refactoring may be more contained than I thought. Anyone have qualms with me doing it in this PR?\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-138457334,138457334,
jamesob,2015-09-09T04:16:00Z,"Okay, I think this is in a good place. Obfuscation now happens automatically whenever the chainstate is initialized (either via `-reindex` or otherwise). The degenerate key that we use (`""\000\000...""`) _isn't_ persisted, but it's specified during class construction in the case that we can't do real obfuscate due to existing data.\n\nIMO this is ready to go, modulo the addition of a few unittests.",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-138775813,138775813,
jamesob,2015-09-10T08:02:47Z,"OK, unittests here are done. If anyone would like to see additional testcases, let me know, but I think I've covered the two important cases: \n1. No existing `chainstate/` data (obfuscation)\n2. Existing data (no-op obfuscation)\n\nIt'd be great if we could get some testers who are affected by anti-virus software (@KyrosKrane ?) trying out this changeset.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139157253,139157253,
KyrosKrane,2015-09-12T08:27:12Z,"I'd be more than happy to test, but I'm new to testing with Bitcoin off Github. Do I need to download and compile from source?\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139740150,139740150,
fanquake,2015-09-12T08:55:40Z,"@KyrosKrane if your comfortable with, and are able to compile from source then the github-merge script in /contrib/devtools is an easy way to test pull requests. Once you've cloned the repo, cd in to the directory and run\n\n```\ncontrib/devtools/github-merge.sh 6650\n```\n\nThat will pull in the code changes from this pull request, and you can then compile as normal.\n\nOtherwise, @jonasschnelli ",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139741331,139741331,
jonasschnelli,2015-09-12T10:31:48Z,https://builds.jonasschnelli.ch/pulls/6650/\n,https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139747611,139747611,
KyrosKrane,2015-09-12T12:49:07Z,Thanks for the build; that will make this much faster for me. :)\n\nHere's what I've done so far.\n\n1) Backed up my existing bitcoin config directory.\n2) Backed up my existing bitcoin exe files.\n3) Downloaded the test build from @jonasschnelli 's site\n4) Deleted everything in my config dir other than the basic config file (just has my connection info and settings)\n5) Replaced the exes in my P,https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139757965,139757965,
jamesob,2015-09-12T18:48:00Z,"@KyrosKrane that sounds great, thanks for your help.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139809267,139809267,
MarcoFalke,2015-09-12T18:59:11Z,"@KyrosKrane If you have the time, could you also test with the ""infected"" data directory, verify that by just running the current bitcoin core version does not fix the AV alert?\nAfterward, you could check if a `-reindex` fixes the AV problem on the ""infected"" data directory.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139809783,139809783,
KyrosKrane,2015-09-12T19:32:47Z,"You read my mind. :)  That's exactly what I'm going to do when this current run ends. It will probably be tomorrow, though; the re-download is taking longer than I thought, even though my other node is locally connected.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139811565,139811565,
KyrosKrane,2015-09-13T17:08:58Z,"OK, update for today. The re-download completed overnight. No antivirus alerts.  I manually scanned the bitcoin data dir. No alerts. This is as expected.\n\nNext, I stopped bitcoin-qt.exe and renamed the data directory.  I copied my original (unobfuscated) blocks and chainstate folders, and the bitcoin.conf file from my backup into the now-empty data directory. I tested it by scanning that freshly",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139896123,139896123,
MarcoFalke,2015-09-13T17:12:30Z,"Do you know if your AV ""fixed"" the ""infected"" data directory back when it originally happened?\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139896280,139896280,
KyrosKrane,2015-09-13T17:19:27Z,"Well, it certainly broke bitcoin-qt and caused it to crash. It wouldn't restart afterwards until I did a -reindex, which promptly broke a second time. Then I wised up and added the exclusion to my antivirus, and a second -reindex worked.  I'll try doing a reindex in a bit; I want to start bitcoin-qt normally first and see if it will read the (unobfuscated) files correctly.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139896791,139896791,
KyrosKrane,2015-09-13T17:45:36Z,"bitcoin-qt happily opened with the unobfuscated files. I tested with an old wallet file I had, and it quickly rescanned the blockchain and updated the balance. (I now have three satoshis more than this morning, yay me!)  Next, I exited bitcoin-qt, opened a command prompt, and ran bitcoin-qt.exe -reindex. This errored out. I repeated, in case this was a one time thing, and it gave me the same error",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139899108,139899108,
jamesob,2015-09-13T18:09:47Z,"@KyrosKrane can you check your log file for anything that might indicate\nwhat went wrong, e.g. a stacktrace?\n\nOn Sunday, September 13, 2015, KyrosKrane notifications@github.com wrote:\n\n> bitcoin-qt happily opened with the unobfuscated files. I tested with an\n> old wallet file I had, and it quickly rescanned the blockchain and updated\n> the balance. (I now have three satoshis more than this ",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139900590,139900590,
KyrosKrane,2015-09-13T18:22:58Z,"I'm slowing down in my old age ... I should have thought of that.  Debug.log file below.\n\n```\n2015-09-13 17:36:27 Bitcoin version v0.11.99.0-f1803c1 (2015-09-12 12:01:31 +0200)\n2015-09-13 17:36:27 AppInit2: parameter interaction: -connect set -> setting -dnsseed=0\n2015-09-13 17:36:27 GUI: ""registerShutdownBlockReason: Successfully registered: Bitcoin Core didn't yet exit safely...""\n2015-09-1",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-139901256,139901256,
jamesob,2015-09-15T01:23:00Z,@KyrosKrane sorry it's taken me a bit to respond; I finally have some time to sit down and take a look. I'm going to add a testcase that simulates a `-reindex` at the `CLevelDBWrapper` layer to see if that will reproduce this failure for me locally.\n\nThanks again for putting in the work to test this.\n,https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-140247024,140247024,
jamesob,2015-09-17T04:39:22Z,"@KyrosKrane dang, can't reproduce with a unittest. Any chance that running with the `-debug` flag yields any more information? e.g. `bitcoind -reindex -debug`? If not, I'll have to try to reproduce on my end with a full dataset. As a side-note, I wonder why the behavior you're seeing isn't reflected in `qa/rpc-tests/reindex.py`...\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-140968821,140968821,
KyrosKrane,2015-09-18T09:13:09Z,"OK, now this is weird. I ran `bitcoin-qt.exe -reindex -debug`, and it worked like a champ. It took almost as long as re-downloading the entire blockchain again; I had to leave it running overnight. But it didn't give any errors and it seems to have completed successfully.  The debug.log file is a whopping 335MB uncompressed, so I'm not going to post that unless someone really needs it.\n\nI'm goin",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-141389319,141389319,
KyrosKrane,2015-09-18T10:52:34Z,"OK, I've tested this twice now. With my original, unobfuscated data directory, if I do `bitcoin-qt.exe -reindex -debug`, it will work successfully.  If I only do `bitcoin-qt.exe -reindex`, it fails with the error I posted above.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-141416946,141416946,
jamesob,2015-09-21T02:34:21Z,@KyrosKrane very odd... the presence of the `-debug` flag doesn't materially affect the reindexing one way or the other on my platform (ubuntu 14.04). Wondering if there's anything in this changeset that would explain `-debug` showing different behavior on a windows system.\n,https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-141862233,141862233,
KyrosKrane,2015-09-21T21:31:46Z,Thanks both for the clarifications!\n,https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-142114448,142114448,
laanwj,2015-09-29T13:36:34Z,Looks good to me apart from the mentioned small things. Will start testing this.\n,https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144060415,144060415,
laanwj,2015-09-30T16:21:45Z,"BTW; seems to work great. I have encountered no problems while testing this, either with an old chainstate or after a reindex (also tested with pruning).\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144465971,144465971,
laanwj,2015-10-01T08:10:29Z,"ACK after squash.\n\nI do think we need to mention this concisely in release_notes.md: \n- a database built on 0.12+ cannot be used with older versions, but downgrading an existing install is not a problem\n- third-party tools that parse the UTXO database (I don't know of any, I have https://github.com/laanwj/blockdb-troubleshoot but that only reads the block db) have to be updated\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144651344,144651344,
paveljanik,2015-10-01T08:17:18Z,"We should also describe, how to continue having unobfuscated database...\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144652562,144652562,
dexX7,2015-10-01T09:59:21Z,"Given that there were several issues with using `std::string` so far, I'm wondering, whether something else may be used instead, such as `std::vector<unsigned char>`, to prevent potential pitfalls altogether?\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144683323,144683323,
jamesob,2015-10-01T14:48:25Z,"@paveljanik any new chainstate databases (including those built via `-reindex`) will be obfuscated; it's not optional. See discussion above.\n\n@dexX7 I think that's a great suggestion, and I've been inclined to try something like that. @laanwj are you in favor of making `obfuscate_key` a `std::vector<unsigned char>` in lieu of a `std::string`? I think it'll make things much less awkward.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144750370,144750370,
sipa,2015-10-01T14:51:33Z,@jamesob I'm in favor of turning it into a `std::vector<unsigned char>`. No reason why it would be a string.\n,https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144751128,144751128,
jamesob,2015-10-01T15:17:14Z,"`obfuscate_key` is now a `vector<unsigned char>`, which feels much better. If no one else has any outstanding issues, I'll squash.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144759821,144759821,
laanwj,2015-10-01T15:37:40Z,"making it a `std::vector<unsigned char>` (or equivalently, `std::vector<uint8_t>`) is a great idea, it avoids the initializer issue completely\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144765119,144765119,
jamesob,2015-10-01T15:57:03Z,Squashed.\n,https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144770971,144770971,
dexX7,2015-10-01T17:27:26Z,"I tested the obfuscation in regtest mode, and started with unobfuscated 0.10 DBs.\n\nIt works mostly as expected, though I faced a few potential issues:\n- the block index database isn't obfuscated (probably not needed?)\n- client hung/froze after the first reindexing (this was not reproducible)\n- after that, the DBs were corrupted, potentially due to the freeze + forced shutdown (also not reprod",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144793673,144793673,
jamesob,2015-10-01T18:52:09Z,"@dexX7 thanks for the detailed notes; very helpful.\n\n> the block index database isn't obfuscated (probably not needed?)\n\nYeah this is by design, and per discussion in the issue thread.\n\n> not not reproducible\n\nIs that a typo, or do you actually mean they were reproducible issues?\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144815218,144815218,
dexX7,2015-10-01T19:00:56Z,"Sorry, this was probably a bit confusing! :)\n\nI noticed each issue only once, and unfortunally (or fortunally? hehe) I was not able to reproduce them. All subsequent attempts went fine, and I successfully disabled and enabled the `-txindex` multiple times. I also reindexed more than once unobfuscated 0.10 based databases with the patched client.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144817359,144817359,
jamesob,2015-10-01T19:09:23Z,"May be similar to what @KyrosKrane was reporting earlier, though I have to admit I'm mostly stumped. I thought it may have something to do with `Read`ing `obfuscate_key`s that haven't been written out to leveldb (in the case of the block index db), but after looking at the code I really doubt that's the case. If anyone has guesses for likely trouble spots, I'm glad to push more changes.\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-144819257,144819257,
CodeShark,2015-10-04T06:52:56Z,utACK\n,https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-145323365,145323365,
laanwj,2015-10-06T15:42:40Z,I went over the code a few times and cannot find any changes that would cause it to hang or get in an infinite loop.\nAlso haven't been able to reproduce any such behavior.\nSo I'm just going ahead and merge this.\n,https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-145905055,145905055,
MarcoFalke,2015-10-07T15:57:27Z,"> @KyrosKrane [https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-141416946]: OK, I've tested this twice now. With my original, unobfuscated data directory, if I do bitcoin-qt.exe -reindex -debug, it will work successfully. If I only do bitcoin-qt.exe -reindex, it fails with the error I posted above.\n\nCan you still reproduce with bitcoin/master? Maybe this should go into a new issue then.",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-146243031,146243031,
KyrosKrane,2015-10-07T19:28:21Z,"@MarcoFalke I used the test build from here: \n\nhttps://bitcoin.jonasschnelli.ch/nightlybuilds/2015-10-07/\nFile name bitcoin-0.11.99-win64.zip\n\nThe behavior has now changed. -reindex still crashes as before, but now so does -reindex -debug. This is new.\n\nJust to make sure this isn't because of some error in my process, I want to document how I got to this point. I started with my normal prod",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-146303168,146303168,
KyrosKrane,2015-10-10T09:20:16Z,"I'm throwing up the file into my Dropbox now, if anyone wants it.  This is my bitcoin data directory, with minimal changes (wallet removed, conf file modified to change my RPC username and password). It's about 33GB, so it may take a bit of time to finish uploading. You can download it here.\n\nhttps://www.dropbox.com/s/k4zfs7f6qmevvbu/Bitcoin%20backup%202015-10.7z?dl=0\n",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-147068079,147068079,
dexX7,2015-10-15T14:22:01Z,"I really appreciate your effort, @KyrosKrane! Unfortunally, and to be honest, I'm not sure where to go from here. I saw DB corruption once too, while testing this PR, but I'm not able to reproduce it.\n\nSince you mentioned `-reindex` causes the crashes, I'm wondering, whether this is also the case with a version without obfuscation? As far as I can see the [nightly build from 2015-10-06](https://",https://github.com/bitcoin/bitcoin/pull/6650#issuecomment-148400346,148400346,
sipa,2015-09-08T00:02:52Z,"Use GetBoolArg, so it enables the -no prefix etc.\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r38882806,38882806,src/txdb.cpp
pstratem,2015-09-08T04:02:11Z,"This should be std::string(&buff[0], &buff[8]);\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r38889104,38889104,src/leveldbwrapper.cpp
dcousens,2015-09-08T05:00:32Z,Does this have to be allocated?\n,https://github.com/bitcoin/bitcoin/pull/6650#discussion_r38890603,38890603,src/leveldbwrapper.h
jamesob,2015-09-08T05:19:13Z,"Is there an alternative? apologies, I'm a C++ beginner :)\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r38891096,38891096,src/leveldbwrapper.h
pstratem,2015-09-08T05:25:54Z,You can drop the conditional.\n,https://github.com/bitcoin/bitcoin/pull/6650#discussion_r38891258,38891258,src/leveldbwrapper.h
pstratem,2015-09-08T05:26:21Z,And the default.\n,https://github.com/bitcoin/bitcoin/pull/6650#discussion_r38891279,38891279,src/leveldbwrapper.h
jamesob,2015-09-08T05:45:09Z,"I initially did that, but this is called from contexts where `obfuscate_key` isn't in scope and hasn't been defined, namely `CBlockTreeDB::WriteTxIndex`. Now that I'm looking at it, there're some missing parameterizations of `obfuscate_key` (e.g. [here](https://github.com/jamesob/bitcoin/blob/obfuscate_chainstate/src/txdb.cpp#L36)). \n\nIt isn't immediately obvious to me how to convey `db.obfuscat",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r38891798,38891798,src/leveldbwrapper.h
dexX7,2015-09-08T20:22:13Z,Hmm.. `obfuscate_key` is not necessarily printable. Maybe it would be better to log a hexified version of the key?\n,https://github.com/bitcoin/bitcoin/pull/6650#discussion_r38974893,38974893,src/leveldbwrapper.cpp
dexX7,2015-09-08T20:37:42Z,"As far as I can see it's not guaranteed that `batch` is deleted, namely if `WriteBatch -> HandleError -> throw`.\n\nHow about using something like [boost::scoped_ptr](http://www.boost.org/doc/libs/1_55_0/libs/smart_ptr/scoped_ptr.htm) to avoid the manual cleanup altogether?\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r38976840,38976840,src/leveldbwrapper.h
jamesob,2015-09-08T20:40:08Z,"Sounds good to me, though honestly I'm hoping to obviate the heap allocations entirely by absorbing `CLevelDBBatch` into `CLevelDBWrapper`... this is pending an okay from @sipa @gmaxwell. \n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r38977135,38977135,src/leveldbwrapper.h
jamesob,2015-09-09T04:11:00Z,"Yeah, looks like this [only comes allocated](https://github.com/google/leveldb/blob/master/include/leveldb/table.h#L48).\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r39005763,39005763,src/leveldbwrapper.h
dcousens,2015-09-09T06:23:10Z,Thanks for clearing that up @jamesob \n,https://github.com/bitcoin/bitcoin/pull/6650#discussion_r39010572,39010572,src/leveldbwrapper.h
dexX7,2015-09-09T22:24:18Z,"Is there any other case where `unobfuscate == false`, except in the [constructor](https://github.com/bitcoin/bitcoin/pull/6650/files#diff-77251d49f77d3e19d7d7ca887cd65e07R76)? If not, you might get away without it (and the condition in [L140](https://github.com/bitcoin/bitcoin/pull/6650/files#diff-0785f0fd15c21eecd3eee494a531d37fR140)), because `obfuscate_key` is still blank during the [read of th",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r39104776,39104776,src/leveldbwrapper.h
jamesob,2015-09-09T23:12:37Z,"Ah yep, you're totally right. Initially I rationalized this by telling myself this param would be convenient for tests, but looks like there's no real need for it now. Will push a fix.\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r39108601,39108601,src/leveldbwrapper.h
KyrosKrane,2015-09-21T20:01:30Z,"Sorry, I'm a C++ beginner here, but I have a question about the second parameter on this string constructor call. I think (based on constuctor 5 in [this link](http://www.cplusplus.com/reference/string/string/string/)) it should just be OBFUSCATE_KEY_NUM_BYTES. Right now, you're passing in the address of the first and last bytes of the buffer you created, rather than the address of the buffer and ",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40018273,40018273,src/leveldbwrapper.cpp
jamesob,2015-09-21T20:52:49Z,"@KyrosKrane being a C++ newbie myself, I screwed this up the first time around; @pstratem [gave me some guidance](https://github.com/bitcoin/bitcoin/pull/6650#discussion_r38889104) on the proper incantation... though upon reading the docs again, I very much agree that what you're saying _looks_ correct, so I gave it a shot. Unfortunately, the compiler spat back a\n\n```\nleveldbwrapper.cpp:122:57:",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40024293,40024293,src/leveldbwrapper.cpp
dexX7,2015-09-21T21:08:08Z,"It's 7, a range constructor. Note that the second argument points to the position after the last element in the range. Pointers can be used like iterators, and it should be fine.\n\nhttps://ideone.com/tBWxwM\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40026212,40026212,src/leveldbwrapper.cpp
laanwj,2015-09-29T13:23:42Z,"This message is too vague. `""Wrote new database obfuscation key for %s: %s"", path.string(), ObfuscateKeyHex()` maybe?\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40669844,40669844,src/leveldbwrapper.cpp
laanwj,2015-09-29T13:24:44Z,Code style nit: { on next line for function declaration\n(also for the other new functions)\n,https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40669968,40669968,src/leveldbwrapper.cpp
laanwj,2015-09-29T13:25:00Z,Looks fine to me.\n,https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40669996,40669996,src/leveldbwrapper.cpp
laanwj,2015-09-29T13:26:56Z,"Please use a `boost::scoped_ptr<leveldb::Iterator>` here, like in `txdb.cpp`, to automatically free the iterator when it goes out of scope.\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40670186,40670186,src/leveldbwrapper.h
laanwj,2015-09-29T13:29:24Z,"I'd make this signature `const std::string& GetObfuscateKey() const`\n- Otherwise it looks like an action: Obfuscate the key!\n- As this returns a field of the object, we can avoid a copy by returning a const reference\n\nEdit: oops, const-correctness\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40670466,40670466,src/leveldbwrapper.h
laanwj,2015-09-29T13:31:22Z,"Same here: make it GetObfuscateKeyHex(). Also don't re-implement the hex logic here, but use `HexStr(...)`.\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40670720,40670720,src/leveldbwrapper.h
laanwj,2015-09-29T13:35:19Z,"Please also log the obfuscation key if it did exist yet, or is all-zeros: this will help troubleshooting, for example when people have problems with their virusscanner and block database files we can see if obfuscation is being used.\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40671196,40671196,src/leveldbwrapper.cpp
laanwj,2015-09-29T14:09:35Z,I'd put the implementation of these functions in leveldbwrapper.cpp instead of the header file (unless there's a reason I'm overlooking)\n,https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40675384,40675384,src/leveldbwrapper.h
jamesob,2015-09-29T16:02:10Z,"I implemented these in the header to maintain consistency with much of the rest of `CLevelDBWrapper`, which is also defined here. I'll move what's below over to the `.cpp` file, but we should probably think about moving the rest of it out of the header at some point.\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40691462,40691462,src/leveldbwrapper.h
jamesob,2015-09-29T16:03:08Z,"Ah, thanks. I was looking for an existing implementation of that... :)\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40691568,40691568,src/leveldbwrapper.h
laanwj,2015-09-29T18:04:26Z,"To save a `%` operation for every byte (which is essentially a division!) and add a sanity check for empty key, I suggest:\n\n``` c++\n    void Xor(const std::string& key)\n    {\n        assert(key.size() > 0);\n        for (size_type i = 0, j = 0; i != size(); i++) {\n            vch[i] ^= key[j++];\n            if (j == key.size())\n                j = 0;\n        }\n    }\n```\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40706110,40706110,src/streams.h
laanwj,2015-09-29T18:06:27Z,"As this is task-specific ideally we wouldn't have this operation on `CDataStream` itself, but as a function that manipulates a CDataStream.\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40706362,40706362,src/streams.h
jamesob,2015-09-30T04:51:23Z,"Really good suggestion, will integrate. Two questions:\n- won't a `key` that is `""\000...""` have `.size() == 0`? should we just return early if that's the case instead of blowing up with an `assert`?\n- I put this in `CDataStream` because, basically, it has to mutate `vch`. That's a protected member variable, so a method `Xor` became. Is there an alternate way to do this that you'd prefer?\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40758238,40758238,src/streams.h
laanwj,2015-09-30T07:01:03Z,"a string containing zeros is entirely different from a zero-length string.\nThe assertion would be triggered by Xor(""""), which is clearly undefined.\n(an empty string would be repeated infinite times to cover the buffer?)\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40763655,40763655,src/streams.h
jamesob,2015-09-30T07:16:28Z,"I think you misunderstand... we use a string consisting entirely of null-terminators (`\000`) as a default obfuscation key. Given https://coderpad.io/2GF6EKCD , the default obfuscation key would cause your code above to raise an assertion error. I went with an early return to avoid this.\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40764502,40764502,src/streams.h
laanwj,2015-09-30T07:29:03Z,"std::string doesn't use 'NULL terminators', they are 8-bit-clean.\n\nAlso NULL-terminated strings don't matter here at all: you should do obfuscation with a sequence of bytes.\n\nThe length of [0,0,0,0,0,0,0,0] is 8 bytes just as well as [255,255,255,255,255,255,255,255] is. If not, that's a bug. \n\ne.g. if your obfuscation key is [1,0,1,2,3,4,5,6], you don't want to loop just ones.\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40765192,40765192,src/streams.h
laanwj,2015-09-30T07:34:19Z,"The problem is that you use eg. std::string(""\000\000\000"").\nIf you do that, C++ will use strlen() to determine the length, which looks for 0 characters.\nPass in a length explicitly.\n\nSo do either:\n\n```\nstd::string(3, '\000');  // Create a string with three 0 bytes\n```\n\nOr\n\n```\nstatic const char data[] = {0,0,0};\nstd::string(data, data+sizeof(data));\n```\n\n...\n\nDon't use the NUL-",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40765510,40765510,src/streams.h
jamesob,2015-09-30T15:23:34Z,"Ah, I see now. Thanks for typing up the examples on coderpad. This is more of my C++ inexperience coming out :).\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40807856,40807856,src/streams.h
jamesob,2015-09-30T15:26:50Z,Do you think it still makes sense to do an early exit if the value of the `key` amounts to a char array of 0s and thus will result in a noop for the xor?\n,https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40808350,40808350,src/streams.h
laanwj,2015-09-30T16:18:47Z,"> Do you think it still makes sense to do an early exit if the value of the `key` amounts to a char array of 0s and thus will result in a noop for the xor?\n\nWell I really don't mind in this case.\nIn general, if something is always a coding bug, and could result in dangerous situations if left unchecked, it needs to be asserted.\nBut having Xor("""") as a no-op seems reasonable to me too.\n",https://github.com/bitcoin/bitcoin/pull/6650#discussion_r40815448,40815448,src/streams.h
KyrosKrane,2015-10-02T12:19:22Z,Is this comment still correct? I don't see this parameter referenced anywhere.\n,https://github.com/bitcoin/bitcoin/pull/6650#discussion_r41015354,41015354,src/leveldbwrapper.h
jamesob,2015-10-05T23:34:53Z,Good catch; will remove.\n,https://github.com/bitcoin/bitcoin/pull/6650#discussion_r41211300,41211300,src/leveldbwrapper.h
jamesob,2015-10-06T14:51:23Z,Fixed; thanks!\n,https://github.com/bitcoin/bitcoin/pull/6650#discussion_r41274154,41274154,src/leveldbwrapper.h
