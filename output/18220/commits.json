[
  {
    "sha": "64a44dc25c92dbc8a46d6e070c497ee92860b260",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2NGE0NGRjMjVjOTJkYmM4YTQ2ZDZlMDcwYzQ5N2VlOTI4NjBiMjYw",
    "commit": {
      "author": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2020-02-28T15:57:18Z"
      },
      "committer": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2020-02-28T15:57:18Z"
      },
      "message": "[psbt] AnalyzePSBT: set next to FINALIZER when all inputs need finalizing\n\nPreviously the next step would be SIGNER if all of the inputs had FINALIZER as their next step.",
      "tree": {
        "sha": "cfa12593d9a853ca01308a6da4330ce8a08e9848",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cfa12593d9a853ca01308a6da4330ce8a08e9848"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/64a44dc25c92dbc8a46d6e070c497ee92860b260",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7ZvfetalXiMuhFJCV/+b28wwEAkFAl5ZOGAACgkQV/+b28ww\nEAly0g/+N6A4c5N5pSlPNFyRALYS8jkhPkxMXSPEcTQiuhYg9bNHInlk+5yTWrzO\n7ih3E/hJsK6t5ewZZYmbPDgyEJkenchCz2pEffnOKVWz/gn7Z5nw6OwEIkjMjCw3\nkI7TZr+lfqS03d6/44u+x8SwnnEnl53TYFywc84x4lQSWdIDX91y+dFuBjamEgUE\nlax87epKDHNKB4fhU/Q5cgiLk/DNWRYTHiTjBllo9O7jcdctEHFqx/Q/XP4bQwrL\nmLaD8iqqjL6G7bIocA3pzLIFlsnSUNXNEV4X9Vm9wXCISjTSvMGLxLdENyX7QvKC\n3WyNfSqBUn2QrvmJmLiSqvYkroSxeLYyJurre3Tn5iiyKiGJTlF0MUnxDs0oWWOz\nlAicuFgiDEJdZuMAL0IP4G8M4zq4Tni+iheKR6lfiy/NvRkQAdUfJDXbfiJkMuZe\nqG6+6xP9yyb1Ji9JEnTIA0AGl3ZtlfvpL59r3GTWBWqFIEaPFx4FODmoQ5s60siw\nM+bfYHJSjjFpIZ9UCYaFgYm8R0z16BKyz6ytz1RFH4c7SzRhIpoMg0HUI7J5n1kR\n8/lM7cwZsKkhC3Qg0R6/30Itc66WjDQos+vZ3v1YIXD4KJx2x3sXLSRC/FvhTVul\neP+G6nTJ40wUl835AcxTChfRDdVgyfTt6FcSAwrtiPwoliGDlVw=\n=wRjc\n-----END PGP SIGNATURE-----",
        "payload": "tree cfa12593d9a853ca01308a6da4330ce8a08e9848\nparent eae48ec84c4deacfe92139d07ee80e51136cb766\nauthor Sjors Provoost <sjors@sprovoost.nl> 1582905438 +0100\ncommitter Sjors Provoost <sjors@sprovoost.nl> 1582905438 +0100\n\n[psbt] AnalyzePSBT: set next to FINALIZER when all inputs need finalizing\n\nPreviously the next step would be SIGNER if all of the inputs had FINALIZER as their next step.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/64a44dc25c92dbc8a46d6e070c497ee92860b260",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/64a44dc25c92dbc8a46d6e070c497ee92860b260",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/64a44dc25c92dbc8a46d6e070c497ee92860b260/comments",
    "author": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url": "https://api.github.com/users/Sjors/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url": "https://api.github.com/users/Sjors/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "eae48ec84c4deacfe92139d07ee80e51136cb766",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/eae48ec84c4deacfe92139d07ee80e51136cb766",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/eae48ec84c4deacfe92139d07ee80e51136cb766"
      }
    ],
    "stats": {
      "total": 17,
      "additions": 11,
      "deletions": 6
    },
    "files": [
      {
        "sha": "0f4320bedc79246b6fb869bf98b74e12644dba84",
        "filename": "src/node/psbt.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 6,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/64a44dc25c92dbc8a46d6e070c497ee92860b260/src/node/psbt.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/64a44dc25c92dbc8a46d6e070c497ee92860b260/src/node/psbt.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/node/psbt.cpp?ref=64a44dc25c92dbc8a46d6e070c497ee92860b260",
        "patch": "@@ -20,7 +20,7 @@ PSBTAnalysis AnalyzePSBT(PartiallySignedTransaction psbtx)\n     bool calc_fee = true;\n     bool all_final = true;\n     bool only_missing_sigs = true;\n-    bool only_missing_final = false;\n+    bool only_missing_final = true;\n     CAmount in_amt = 0;\n \n     result.inputs.resize(psbtx.tx->vin.size());\n@@ -47,6 +47,7 @@ PSBTAnalysis AnalyzePSBT(PartiallySignedTransaction psbtx)\n             input_analysis.is_final = false;\n             input_analysis.next = PSBTRole::UPDATER;\n             calc_fee = false;\n+            only_missing_final = false;\n         }\n \n         if (!utxo.IsNull() && utxo.scriptPubKey.IsUnspendable()) {\n@@ -77,8 +78,8 @@ PSBTAnalysis AnalyzePSBT(PartiallySignedTransaction psbtx)\n                     only_missing_sigs = false;\n                     input_analysis.next = PSBTRole::UPDATER;\n                 }\n+                only_missing_final = false;\n             } else {\n-                only_missing_final = true;\n                 input_analysis.next = PSBTRole::FINALIZER;\n             }\n         } else if (!utxo.IsNull()){\n@@ -139,12 +140,12 @@ PSBTAnalysis AnalyzePSBT(PartiallySignedTransaction psbtx)\n             result.estimated_feerate = feerate;\n         }\n \n-        if (only_missing_sigs) {\n-            result.next = PSBTRole::SIGNER;\n+        if (all_final) {\n+            result.next = PSBTRole::EXTRACTOR;\n         } else if (only_missing_final) {\n             result.next = PSBTRole::FINALIZER;\n-        } else if (all_final) {\n-            result.next = PSBTRole::EXTRACTOR;\n+        } else if (only_missing_sigs) {\n+            result.next = PSBTRole::SIGNER;\n         } else {\n             result.next = PSBTRole::UPDATER;\n         }"
      },
      {
        "sha": "fc54a4a8ad02dbfc183c43525e563d8d15b9bcda",
        "filename": "test/functional/rpc_psbt.py",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/64a44dc25c92dbc8a46d6e070c497ee92860b260/test/functional/rpc_psbt.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/64a44dc25c92dbc8a46d6e070c497ee92860b260/test/functional/rpc_psbt.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_psbt.py?ref=64a44dc25c92dbc8a46d6e070c497ee92860b260",
        "patch": "@@ -427,6 +427,10 @@ def test_psbt_input_keys(psbt_input, keys):\n         analyzed = self.nodes[0].analyzepsbt(signed)\n         assert analyzed['inputs'][0]['has_utxo'] and analyzed['inputs'][0]['is_final'] and analyzed['next'] == 'extractor'\n \n+        self.log.info(\"PSBT with signed, but not finalized, inputs should have Finalizer as next\")\n+        analysis = self.nodes[0].analyzepsbt('cHNidP8BAHECAAAAAZYezcxdnbXoQCmrD79t/LzDgtUo9ERqixk8wgioAobrAAAAAAD9////AlDDAAAAAAAAFgAUy/UxxZuzZswcmFnN/E9DGSiHLUsuGPUFAAAAABYAFLsH5o0R38wXx+X2cCosTMCZnQ4baAAAAAABAR8A4fUFAAAAABYAFOBI2h5thf3+Lflb2LGCsVSZwsltIgIC/i4dtVARCRWtROG0HHoGcaVklzJUcwo5homgGkSNAnJHMEQCIGx7zKcMIGr7cEES9BR4Kdt/pzPTK3fKWcGyCJXb7MVnAiALOBgqlMH4GbC1HDh/HmylmO54fyEy4lKde7/BT/PWxwEBAwQBAAAAIgYC/i4dtVARCRWtROG0HHoGcaVklzJUcwo5homgGkSNAnIYDwVpQ1QAAIABAACAAAAAgAAAAAAAAAAAAAAiAgL+CIiB59NSCssOJRGiMYQK1chahgAaaJpIXE41Cyir+xgPBWlDVAAAgAEAAIAAAACAAQAAAAAAAAAA')\n+        assert_equal(analysis['next'], 'finalizer')\n+\n         self.log.info(\"PSBT spending unspendable outputs should have error message and Creator as next\")\n         analysis = self.nodes[0].analyzepsbt('cHNidP8BAJoCAAAAAljoeiG1ba8MI76OcHBFbDNvfLqlyHV5JPVFiHuyq911AAAAAAD/////g40EJ9DsZQpoqka7CwmK6kQiwHGyyng1Kgd5WdB86h0BAAAAAP////8CcKrwCAAAAAAWAEHYXCtx0AYLCcmIauuBXlCZHdoSTQDh9QUAAAAAFv8/wADXYP/7//////8JxOh0LR2HAI8AAAAAAAEBIADC6wsAAAAAF2oUt/X69ELjeX2nTof+fZ10l+OyAokDAQcJAwEHEAABAACAAAEBIADC6wsAAAAAF2oUt/X69ELjeX2nTof+fZ10l+OyAokDAQcJAwEHENkMak8AAAAA')\n         assert_equal(analysis['next'], 'creator')"
      }
    ]
  }
]