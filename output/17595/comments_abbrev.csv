laanwj,2019-11-26 10:47:09,Thanks for working on this! Another step towards Guix builds.,https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-558572917,558572917,
fanquake,2020-01-24 05:37:41,"Looks good.\n\nI've just completed a Guix time-machine build, I modified the changes here to only build the `x86_64-w64-mingw32` target, and the binaries are working fine in a Windows VM üëç.\n\n```bash\nenv PATH=""/root/.config/guix/current/bin${PATH:+:}$PATH"" guix describe\n  guix 44e70de\n    repository URL: https://git.savannah.gnu.org/git/guix.git\n    branch: master\n    commit: 44e70d",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-577998443,577998443,
DrahtBot,2020-01-28 02:48:54,<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.,https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-579054839,579054839,
fanquake,2020-01-28 09:23:07,"@dongcarl Could you rebase this on master and fixup any shellcheck complaints:\n```bash\nIn contrib/guix/guix-build.sh line 25:\n\nfor host in ${HOSTS=i686-linux-gnu x86_64-linux-gnu arm-linux-gnueabihf aarch64-linux-gnu riscv64-linux-gnu x86_64-w64-mingw32}; do\n\n            ^-- SC2153: Possible misspelling: HOSTS may not be assigned, but HOST is.\nFor more information:\n  https://www.sh",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-579153463,579153463,
fanquake,2020-01-30 00:38:36,Can you also address the [follow up comment from #17933](https://github.com/bitcoin/bitcoin/pull/17933#discussion_r372120580).,https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-580030602,580030602,
dongcarl,2020-01-31 14:55:10,"Fixed up shellcheck complaints and addressed followup. Thanks for the reminders!\n\nYou can limit to building just mingw binaries like this btw:\n`env HOSTS=x86_64-w64-mingw32 ./contrib/guix/guix-build.sh`\n\nHere are my results (probably not reproducible, but let's triage here!):\n```\n$ git rev-parse HEAD\n20e9e0bf0af4d168e703d1a569d0d573b3ce22f4\n\n$ find output/ -type f -print0 | sor",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-580766017,580766017,
laanwj,2020-02-05 14:41:01,"Do we know what section / symbols these non-determinism differences are in? The first one (in the PE header) is probably the checksum. The second one is unclear to me, it doesn't look like assembly code but a 32-bit number.\n\nMaybe a literal timestamp? Yes, this works out, these are little-endian UNIX timestamps:\n```patch\nbitcoin-qt.exe\n\n-9f37355e    Sat Feb  1 09:32:31 2020\n+4b3f355e",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-582439305,582439305,
dongcarl,2020-02-05 16:59:57,"> The first one (in the PE header) is probably the checksum.\n\nYeah I believe it's the checksum... Assuming that the checksum is of the whole file and not just of the header, perhaps fixing the timestamp will fix this checksum too?\n\n> Maybe a literal timestamp? Yes, this works out, these are little-endian UNIX timestamps:\n\nYay thanks! I was hoping we could avoid `libfaketime` like we di",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-582507014,582507014,
fanquake,2020-02-06 01:44:05,"I've just completed two more builds, adding `-Wl,--no-insert-timestamp` to the LDFLAGS, and am no longer seeing any differences in the `bitcoin-0.19.99-win64.zip` files (excluding directory metadata). i.e `diffoscope --exclude-directory-metadata build_1_output/bitcoin-0.19.99 build_2_output/bitcoin-0.19.99`. All the binaries in `bin/` match.\n\nI'm still seeing a diff for `output/bitcoin-0.19.99",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-582696467,582696467,
dongcarl,2020-02-10 16:41:40,@fanquake I can reproduce this non-reproducibility on my workstation... Will investigate.,https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-584214871,584214871,
dongcarl,2020-02-14 03:56:44,":crossed_fingers: \n```sh\n$ git rev-parse HEAD\nf38dfc7ae0a1489d33ae0b6ea7c49a3e34836adf\n\n$ find output/ -type f -print0 | sort -z | xargs -r0 sha256sum\nacbe8d606d7d47da5ab874e72e6b195fd8d3137bdc2f97745995342222064f5c  output/bitcoin-0.19.99-win64-debug.zip\n9846a7e86db931a600d88ccd17c137cedac7ccb171469a8b50007e0f6139e94f  output/bitcoin-0.19.99-win64-setup-unsigned.exe\n45201ef9571e98",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-586086248,586086248,
dongcarl,2020-02-14 04:36:13,"Rebased over master :crossed_fingers: \n\n```sh\n$ git rev-parse HEAD\na7765f371e78d85f23bca43f475c5a1a4e32afb2\n\n$ find output/ -type f -print0 | sort -z | xargs -r0 sha256sum\n67cbc94d04718f7b81444d142a1c47040801aa7412feec956897adc2123113ea  output/bitcoin-0.19.99-win64-debug.zip\n6658d3823a299a8d63765162b3c0b18be8ae7bd950c6f564e26662f104428426  output/bitcoin-0.19.99-win64-setup-unsign",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-586094003,586094003,
fanquake,2020-02-16 09:06:25,"Ran a couple builds, they are deterministic, but aren't currently matching your hashes:\n```bash\nguix describe\n  guix 4530fe8\n    repository URL: https://git.savannah.gnu.org/git/guix.git\n    branch: master\n    commit: 4530fe8ecca456fcc7226914502ad452c33ce27b\n\ngit rev-parse HEAD\na7765f371e78d85f23bca43f475c5a1a4e32afb2\n\nfind output/ -type f -print0 | sort -z | xargs -r0 sha256",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-586683750,586683750,
dongcarl,2020-02-17 14:44:49,"@fanquake Weird. Here are mine: https://send.firefox.com/download/e27a2a3a463ee70e/#q-3dDZ59pzrrvFhryIgmZw\n\nIf you get a chance to upload yours, I'd be happy to take a look!",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-587026790,587026790,
fanquake,2020-02-18 05:39:51,"@dongcarl sure: https://send.firefox.com/download/8ee9cd6f49500764/#Y2OZ_HIDHRp3mu0Zm6B1Lg.\nsha256sum is `b2b4cc78b1b3caad00b7ada013c23a986c957eb054fe7e9420e04b85e59ae051`.\n\n```bash\nguix describe\n  guix a02ca03\n    repository URL: https://git.savannah.gnu.org/git/guix.git\n    branch: master\n    commit: a02ca03318faa77ab5ef06f4b7a3beed0c7db029\n\ngit rev-parse HEAD\na7765f371e78d",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-587287952,587287952,
dongcarl,2020-03-09 21:59:53,"Okay some more insights... I'm trying to track down where the difference may be propagating from... And diffed the `distsrc-x86_64-w64-mingw32/src/.libs/libbitcoinconsensus-0.dll` of two different build runs... Here's what I got: https://send.firefox.com/download/381b244913161e90/#c8Ds0IR1ZkehT9u28LJ2Hg\n\nI couldn't make sense of the beginning of that diff, but I went to the very end and saw so",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-596800004,596800004,
laanwj,2020-03-12 12:44:10,"No, no idea what could cause linker symbols to be ordered differently in different builds. The only thing I can think of is the use of wildcards combined with non-deterministic directory ordering. Causing things to be processed in a different order. \n(are the intermediate `.a` archives deterministic?)\n\nWe had some problems in the past with Qt tools using a (non-deterministic) hash table, but",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-598165108,598165108,
fanquake,2020-03-13 03:33:19,"@dongcarl @laanwj \n\nI think I might have the solution to the symbol ordering issue. Seems like we can use (some variant of) the `-Wl,--sort-common=descending` and `-Wl,--sort-section=name""` linker flags.\n\nI've run subsequent builds of this branch with the following patch applied:\n```diff\ndiff --git a/contrib/guix/libexec/build.sh b/contrib/guix/libexec/build.sh\nindex ffbe332e7..831ef",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-598532028,598532028,
dongcarl,2020-03-13 04:11:21,"Here's what I have for 069e108ec0c6a99a360c36d9be4a8ffd5de76d47:\n```\n$ find output/ -type f -print0 | sort -z | xargs -r0 sha256sum\ncf63177dbd8af939df84fdcc318d3f5440df307fcb8a98a61fe43ff4512bacaf  output/bitcoin-0.19.99-win64-debug.zip\n38cfbfd5fdd8dbae89bba98b176737f1d732d1b320f7474e84bb8a6b6dfada3c  output/bitcoin-0.19.99-win64-setup-unsigned.exe\ndc547bca3ef9b5ca82b34d9437636a4b6b59a8f",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-598538956,598538956,
fanquake,2020-03-13 05:21:19,"> Here's what I have for 069e108:\n\nLooks like we're still not getting matches (apart from docs etc). I've uploaded my `installed` dir [here](https://send.firefox.com/download/5cb9041dbb7a3248/#ryu11ttpTLYiFg1Z_hEF5A):\n```bash\nfind output/ -type f -print0 | sort -z | xargs -r0 sha256sum\nb58e6a6929cbe3c05383888267b999ba7f9cb3cd8a1d36bcefee0d074202d374  output/bitcoin-0.19.99-win-unsigned.t",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-598554891,598554891,
dongcarl,2020-03-26 05:38:08,"I think I've got it.\n\nThe main problem that we found in the end was that `libtool` prior to [`74c8993c`](https://git.savannah.gnu.org/cgit/libtool.git/commit/?id=74c8993c178a1386ea5e2363a01d919738402f30) (first included in version 2.2.7**b**) did not sort `find` output. This meant that when we built our cross-compiling gcc, which has its release tarball bootstrapped with libtool 2.2.7**a**, we",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-604239956,604239956,
fanquake,2020-03-26 06:50:05,"üò¢ \n\n```bash\nenv PATH=""/root/.config/guix/current/bin${PATH:+:}$PATH"" guix describe\n  guix 730a4b1\n    repository URL: https://git.savannah.gnu.org/git/guix.git\n    branch: master\n    commit: 730a4b10fa49d821e0a89af59485cecf8616cd50\n\ngit rev-parse HEAD\n203a4057eddf17a1fafc6f884248ac5a8f7941e8\n\nfind distsrc-x86_64-w64-mingw32/installed/ -type f -print0 | sort -z | xargs -r0 s",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-604260693,604260693,
fanquake,2020-03-27 00:38:31,"@dongcarl latest build is available here: https://send.firefox.com/download/8f8073d79fe4ef8d/#MfIdTWlcd_m27kOxgtLX5w.\n\n`c4ff8ef8b6469e33a1e74b76bd8a997a76675877ed9fdf2a1ac0201414771205 installed.zip`",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-604756488,604756488,
fanquake,2020-03-28 03:25:51,"@dongcarl [`distsrc-x86_64-w64-mingw32`](https://send.firefox.com/download/36c0dd0433f5dae0/#QFxhqI_2fbSbWMf58kuHPA) and [`output`](https://send.firefox.com/download/9ef917e8c5b0277a/#aLlg2vLK7VZEPjGRwGmyHw) dirs are up.\n\n```bash\ne127fd7bebebe671f5eea4b0e9bb5f3194a0bf4a3fdef4bc72cab0c33edc480a  distsrc-x86_64-w64-mingw32.zip\n905200fb2c12013f60bae012e6c9c112c510aa5d2708a89a7b514cfe5228c83d ",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-605387808,605387808,
MarcoFalke,2020-03-30 23:58:44,skimmed ACK 203a4057eddf17a1fafc6f884248ac5a8f7941e8,https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-606314293,606314293,
MarcoFalke,2020-03-31 02:57:40,"It appears that guix can not run in podman? Has anyone tried this?\n\n```\n# guix install hello --no-substitutes --max-jobs=1\naccepted connection from pid 4194, user root\nguix install: warning: Consider running 'guix pull' followed by\n'guix package -u' to get up-to-date packages and security updates.\n\nguix install: error: cloning builder process: Operation not permitted\n\n\n# guix",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-606368849,606368849,
dongcarl,2020-03-31 05:26:23,"@MarcoFalke I think `sysctl kernel.unprivileged_userns_clone=1` should fix it, if that's not allowed, you might need to run `guix-daemon` as a privileged podman. Happy to take a look at scripts/files to make this work!",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-606407804,606407804,
dongcarl,2020-04-07 23:33:19,"Rebased to include the #18358 merge. It's a lot of commits, but it preserves the history, which I know some reviewers like. Let me know if people want things squashed instead, and I'd be happy to oblige.\n\nA few commit messages that would give more context on the last bit of investigation/upstreaming done for this PR:\n\n```\ncommit 93439a71eda49fb69f1e82966a23a946733aa6fa\nAuthor: Carl Don",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-610670515,610670515,
dongcarl,2020-04-07 23:38:40,"Also, here are my hashes for a35e3235891d35daa167116cc70340140e883f06:\n```\n$ find distsrc-x86_64-w64-mingw32/installed/ -type f -print0 | env LC_ALL=C sort -z | xargs -r0 sha256sum\n7ab680cf4cf431319c90e9fb0e4abeba5fd4cb7a3a33302d7eeedc6c0bc220b6  distsrc-x86_64-w64-mingw32/installed/bitcoin-0.19.99/bin/bitcoin-cli.exe\nc1026cb9fd0a0826eb9baadafaada7cc391bd217ff6a0f11987ac86da32b8c48  distsr",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-610672013,610672013,
fanquake,2020-04-08 02:05:21,"Hashes still look good at a35e3235891d35daa167116cc70340140e883f06:\n\n```bash\nbash-5.0# git rev-parse HEAD\na35e3235891d35daa167116cc70340140e883f06\n\nbash-5.0# env PATH=""/root/.config/guix/current/bin${PATH:+:}$PATH"" guix describe\n  guix 0eb799e\n    repository URL: https://git.savannah.gnu.org/git/guix.git\n    branch: master\n    commit: 0eb799e6696202316b7e5062ba21bff9ece7a789\n",https://github.com/bitcoin/bitcoin/pull/17595#issuecomment-610710668,610710668,
fanquake,2020-03-28 07:57:04,nit: s/overriable/overridable,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r399633815,399633815,contrib/guix/guix-build.sh
fanquake,2020-03-28 08:00:47,"Maybe add `deploy dirs` here as well, as we've now got `windeploy` and will have something for macOS.",https://github.com/bitcoin/bitcoin/pull/17595#discussion_r399634135,399634135,contrib/guix/guix-build.sh
fanquake,2020-03-28 08:02:20,nit: s/irrepreducibility/irreproducibility,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r399634240,399634240,contrib/guix/guix-build.sh
fanquake,2020-03-28 08:06:24,Should we also be setting `MINGW_HAS_SECURE_API` for regular builds? I remember you talking about this potentially fixing an issue you were seeing. Can you remember what that was?,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r399634592,399634592,contrib/guix/libexec/build.sh
fanquake,2020-03-28 08:08:58,I added dylib checking for PE binaries in #18395. Can we add the relevant case and `make -C src check-symbols` call here too?,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r399634850,399634850,contrib/guix/libexec/build.sh
fanquake,2020-03-28 08:12:27,Do / should  we be setting `--owner` and `--group` in any of these `tar` calls? I assume we aren't setting `--mtime` explicitly because we're in the container?,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r399635064,399635064,contrib/guix/libexec/build.sh
fanquake,2020-03-28 08:20:28,"Can you explain the usage of `--zero-terminated` with `sort`? I see you're only using it in the linux case here, but are using it in the mingw case below. Is this something we can just pass all the time? If not, could this cause reproducibility issues if we forget it  in future?\n\nI couldn't see it in the man page for `tar`, but I could find it for [`sed`](https://www.gnu.org/software/sed/manua",https://github.com/bitcoin/bitcoin/pull/17595#discussion_r399635724,399635724,contrib/guix/libexec/build.sh
fanquake,2020-03-28 08:22:30,Could mention that you can ensure this is working by checking that we aren't linked against `libssp.so`. Although symbol-check will be taking care of this as well.,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r399635851,399635851,contrib/guix/manifest.scm
fanquake,2020-03-28 08:24:28,üëç [`SetDateSave`](https://nsis.sourceforge.io/Reference/SetDateSave). I think adding the debugging info below is fine as well.,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r399636022,399636022,share/setup.nsi.in
TheCharlatan,2020-03-29 00:57:33,"My build currently fails on this step with `cp: cannot stat '/bitcoin/distsrc-x86_64-linux-gnu/doc/README.md': No such file or directory`. I don't think the README is actually moved to the doc directory, or am I missing something? At least I cannot see a step for it to be copied in the top level `Makefile.am`, unlike for `README_windows.txt` which is listed.",https://github.com/bitcoin/bitcoin/pull/17595#discussion_r399728721,399728721,contrib/guix/libexec/build.sh
dongcarl,2020-03-30 18:08:03,"Pre-https://github.com/mirror/mingw-w64/commit/3bef7c2206bb6f9552ea7e61315c4bf7af3aa6c9 (first included in mingw-w64 v7.0.0), we had to either `-DMINGW_HAS_SECURE_API=1` or specify `--enable-secure-api` at configure time. Debian [does the latter](https://salsa.debian.org/mingw-w64-team/mingw-w64/-/blob/debian/6.0.0-4/debian/rules#L101).\n\nSo I think I'll bump to mingw-w64 v7.0.0 in this PR, I w",https://github.com/bitcoin/bitcoin/pull/17595#discussion_r400391939,400391939,contrib/guix/libexec/build.sh
dongcarl,2020-03-30 18:24:12,"Yes! The reason for this difference is that `tar` has a `--null` flag while `zip` does not.\n\nThe reason for using `-print0`, `--zero-terminated`, and `--null` is out of an abundance of caution: a newline character is a valid character in filenames, but `\0` is not. However, I guess this is defeated by the fact that `zip` doesn't have any options that support this. Perhaps a better thing is to ",https://github.com/bitcoin/bitcoin/pull/17595#discussion_r400401662,400401662,contrib/guix/libexec/build.sh
MarcoFalke,2020-03-30 23:40:17,"in commit 5f8a2f43ff3becd329da9c9b303fb4322ad71a08:\n\nCan this be set after LC_ALL=C to make travis pass?",https://github.com/bitcoin/bitcoin/pull/17595#discussion_r400558565,400558565,contrib/guix/libexec/build.sh
dongcarl,2020-03-31 00:09:09,Fixed in 83974615af3ce6b4b687974619a68bfd96aa7620,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r400567482,400567482,contrib/guix/guix-build.sh
dongcarl,2020-03-31 00:09:14,Fixed in 83974615af3ce6b4b687974619a68bfd96aa7620,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r400567517,400567517,contrib/guix/guix-build.sh
dongcarl,2020-03-31 00:09:37,Fixed in 7828f65b7c8fe269c407b90bb3ff9e90f8f1d3dc,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r400567622,400567622,contrib/guix/guix-build.sh
dongcarl,2020-03-31 00:10:10,Fixed in e63cb74749aa3b82c04fc9dacd963d3de00784b9,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r400567773,400567773,contrib/guix/libexec/build.sh
dongcarl,2020-03-31 00:10:18,Fixed in e63cb74749aa3b82c04fc9dacd963d3de00784b9,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r400567814,400567814,contrib/guix/manifest.scm
dongcarl,2020-03-31 00:11:33,"I'm setting `TAR_OPTIONS` at the beginning of the file, which gets passed to `tar` calls. I remember there being a back-and-forth w/re `TAR_OPTIONS` vs not. Will look at it again...",https://github.com/bitcoin/bitcoin/pull/17595#discussion_r400568182,400568182,contrib/guix/libexec/build.sh
dongcarl,2020-03-31 00:12:30,"True! You're right. I think this is a result of #18331, which I'm seeing if I can fix with #18478",https://github.com/bitcoin/bitcoin/pull/17595#discussion_r400568435,400568435,contrib/guix/libexec/build.sh
MarcoFalke,2020-03-31 00:40:26,Why can't this copy from the source dir and not from the dist dir. E.g. `cp /bitcoin/doc/README.md ...`?,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r400576369,400576369,contrib/guix/libexec/build.sh
dongcarl,2020-04-01 01:53:41,Context: waiting to rebase over #18358 once we figure out the best solution there. I've tested with cherry-picking existing solutions in that PR and the build seems to work.,https://github.com/bitcoin/bitcoin/pull/17595#discussion_r401312121,401312121,contrib/guix/libexec/build.sh
