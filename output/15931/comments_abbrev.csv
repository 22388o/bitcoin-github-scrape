DrahtBot,2019-05-01 18:27:35,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17369](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17369.html) (Refactor: Move encryption code between KeyM",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-488368727,488368727,
fanquake,2019-06-19 01:30:44,"Added to the ""Chasing Concept ACK"" board. @ryanofsky maybe you could give an initial Concept/Approach ACK/NACK ?",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-503370626,503370626,
ariard,2019-06-19 03:15:39,"Yes would be awesome to get a Concept ACK on the approach followed but if it's not the best one, I'm eager to rework the PR in depth! Going to rebase/fix tests failure soon",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-503389407,503389407,
ariard,2019-07-09 02:24:55,"Answered back to @ryanofsky comments on 1458ded, I'm on cleaning last Travis failures",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-509461542,509461542,
jnewbery,2019-07-23 18:26:16,I've done a quick code review. The main thing that I'd like to see changed is merging the `CMerkleTx` and `CWalletTx` classes now that `CMerkleTx` is accessing wallet data (see discussion here: http://www.erisian.com.au/bitcoin-core-dev/log-2019-07-23.html#l-322),https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-514327967,514327967,
jnewbery,2019-07-23 18:28:12,"(excellent work, by the way. Great to see some of these locked_chain instances being cleaned up)",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-514328665,514328665,
ariard,2019-07-24 20:03:48,"Addressed @jnewbery comments on a53586c, except https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306961660 where I'm still thinking on it",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-514779211,514779211,
jnewbery,2019-07-31 12:07:45,https://github.com/bitcoin/bitcoin/pull/16451 is merged. You should be able to rebase this and remove one of the commits.,https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-516820571,516820571,
ariard,2019-08-06 05:19:50,Rebased without CMerkleTx relative commit,https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-518504999,518504999,
jnewbery,2019-08-06 15:29:28,"I suggest you reverse the order of the first two commits:\n\n1. have one commit that _only_ updates the signature of `BlockDiscconected` in the validation interface.\n2. the second commit adds `m_last_block_processed_height` and uses the `pindex` in `BlockConnected`/`BlockDisconnected` to set the height.\n\nHaving one way for setting `m_last_block_processed_height` in the first commit which i",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-518720861,518720861,
Sjors,2019-08-06 15:39:18,"Concept ACK on reducing reliance on `locked_chain`. It seems worth adding `m_block_height`.  \n\nI might be more clear to swap the first two (?) commits, thereby introducing `m_last_block_processed_height` without the `+= 1` stuff.\n\nGetting a bunch of warnings on macOS along these lines:\n\n```\nIn file included from wallet/ismine.cpp:12:\n./wallet/wallet.h:846:5: warning: declaration do",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-518725058,518725058,
ariard,2019-08-07 05:56:57,"Thanks for review @Sjors, \n\nI inverted the 2 top commits at 71a053c to ease review.\n\nAbout `m_block_height` in `CWalletTx`, caching in block height in-memory let us with 2 options at serialization : \n* serialize in-memory member too, deserialize it at wallet loading\n* query `getBlockHeight` by passing `hashBlock`at `LoadToWallet` called by `ReadKeyValue`\n\nI tried also to implement ",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-518951928,518951928,
jnewbery,2019-08-07 12:55:11,"> Changing wallet serialization makes this PR more complicated to understand and test, and is something that can complicate wallet design going forward by increasing the number of data formats we have to think about staying compatible with.\n\nNote that `mapValue` can be used to change `WalletTx` serialization in a backwards-compatible way. It's a key-value store that anything can be written to/",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519083686,519083686,
ryanofsky,2019-08-07 13:34:53,"> @ryanofsky - how can we be sure that if we add a getBlockHeight() call for every tx in the wallet, we won't introduce a performance regression for very large wallets?\n\nI don't think we can be sure without measuring. I would say if there is a performance regression, I think it would be better to handle in a followup PR that's only changing the serialization and avoiding getBlockHeight() calls",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519099417,519099417,
ryanofsky,2019-08-07 14:00:08,"To be sure, if there is reason to think changing serialization will soup up the wallet, please don't let me stand in the way. My reaction isn't ""please don't do this"", just ""why wouldn't you want to mess with this if you didn't have to?""",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519110546,519110546,
ariard,2019-08-07 14:23:48,"Loading large wallets after initialization will need to lock cs_main to deserialize their txn, which maybe a performance regression. Removing chain lock in the wallet would make it better but still be a hit.\n\nBut agree, this PR is already big enough, I will change for 2nd option, and let's talk about safe serialization in another one, if needed and after more thoughts.",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519120238,519120238,
ariard,2019-08-07 18:43:58,"@ryanofsky in fact I just realized we may have to take 1st option, `bitcoin-wallet` binary load a wallet and can't get its chain interface..\n\nDo you see a 3rd option beyond the 2 I've mentioned ?",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519221758,519221758,
ryanofsky,2019-08-07 19:26:06,"> @ryanofsky in fact I just realized we may have to take 1st option, `bitcoin-wallet` binary load a wallet and can't get its chain interface..\n> \n> Do you see a 3rd option beyond the 2 I've mentioned ?\n\nJust skip this if interfaces::Chain* pointer is null. Bitcoin-wallet won't do anything that requires knowing the block height of transactions in the wallet.",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519236266,519236266,
Sjors,2019-08-08 09:03:05,"> Just skip this if interfaces::Chain* pointer is null.\n\nThat makes sense, though maybe make that more explicit?",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519434221,519434221,
ariard,2019-08-08 17:05:37,"Yes, I've beefed up comments on this, tell me it's enough (see in `CWallet::Verify` and `CWallet::LoadWallet`)\n\nThe query-chain-to-know-height approach makes compatibility not an issue, and doesn't block us to go forward with tx height serialization later . A caveat, right now, it has to lock chain for the whole deserialization period to preserve lock order. This inefficiency should go away wh",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519605528,519605528,
ariard,2019-08-08 17:38:13,"Hmm annotated `GetDepthInMainChain` with a `NO_THREAD_SAFETY_ANALYSIS` right now to avoid member access into incomplete type (same as `GetConflicts` and `GetAvailableCredit`). If anyone has an idea how to resolve them smoothly, I will  take it.",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519617268,519617268,
jnewbery,2019-08-09 15:18:57,I've added a `GetDepthInMainChain()` call back into `SubmitMemoryPoolAndRelay()` in #16557. I think we probably want to get that log fix in first and rebase this PR on top of that (with the _Remove locked_chain from GetDepthInMainChain and its callers_ commit updated to remove _locked_chain_ from `SubmitMemoryPoolAndRelay()`),https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-519958907,519958907,
ariard,2019-08-20 15:23:52,"Updated at f766fe4, including @promag and @jkczyz feedbacks.",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-523065514,523065514,
ariard,2019-08-20 19:37:54,"Rebased at 7427cbf, due to silent build failures not reported by merge conflict detection.",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-523163963,523163963,
dergigi,2019-08-21 14:03:41,"Tried to compile commit 7427cbf to prepare for the PR review club, and I'm getting an error when running `make`:\n\n```\n  CXX      qt/test/test_bitcoin_qt-wallettests.o\nqt/test/wallettests.cpp: In function ‘void {anonymous}::TestGUI()’:\nqt/test/wallettests.cpp:145:17: error: ‘using element_type = class CWallet’ {aka ‘class CWallet’} has no member named ‘SetLastBlockProcessedHeight’; did yo",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-523471522,523471522,
ariard,2019-08-21 14:17:12,"@dergigi sorry for that, skipped qt test build when I replied promag comment yesterday, shouldn't have. Updated at 15100ee with fix",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-523477200,523477200,
ryanofsky,2019-10-10 18:13:53,I was looking over this again and think it's a really nice change. It'd be good to rebase now that #16624 is merged. It would also help with #16426 which depends on this PR.,https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-540707584,540707584,
ariard,2019-10-14 06:08:58,"Thanks for the push @ryanofsky, and sorry for the delay for following-up on this PR. Also added nits leftover from #16624 \n\nI spent a bit more time thinking how we handle conflicts and found that Confirmation status isn't correct for children of conflicted txn, if conflicting tx get removed we unconfirm well the parent conflicted tx but not its child. Test here : https://github.com/ariard/bitc",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-541514108,541514108,
ariard,2019-10-23 15:40:48,"Thanks for review @ryanofsky, rebased and addressed your comment at 089189e\n\n> IIUC this is current behavior, independent of the PR?\n\nAFAIK, we don't have logic to undo conflicts on child txn so it was already even there before #16624. ",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-545505919,545505919,
ariard,2019-10-24 19:15:33,"Thanks @ryanofsky , addressed most of your comments, specially https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338169478a and adding commit d0c4ce6 to wrap all confirmations values directly in BlockConnected/BlockDisconnected.\n\nRebased at 75c276e",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-546062625,546062625,
laanwj,2019-10-25 12:52:06,Concept ACK. I like the direction of this.,https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-546341167,546341167,
jonatack,2019-10-31 17:01:43,"Code review in progress. Built b2c68eb3cdc851d4d1a3bb6a8a64397907e22618, ran tests, running bitcoind w/logging for a few hours.",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-548472707,548472707,
ryanofsky,2019-11-05 17:55:41,"This has had a decent amount of code review but only one code review ack.\n\nIf previous reviewers want to take another look and add ACKs, it would be very helpful. The PR is smaller and simpler than it was originally, and most of the changes (especially in the last few commits) are actually trivial. A lot of improvments can build on this PR to make the wallet more asynchronous, clean up rescann",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-549939666,549939666,
promag,2019-11-05 21:39:44,"Sure Russell, I'll review.",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-550033276,550033276,
ariard,2019-11-06 17:54:25,"Updated at 36b68de :\n* move `block_height` to _Add block_height field in struct Confirmation_\n* modify `Confirmation` constructor and add comments to avoid ambiguity in place where it's called\n* rearrange `Confirmation` constructor comment\n* fix nit wording on `Confirmation` comment\n* add guard clause for `importprunedfunds` as [suggested](https://github.com/bitcoin/bitcoin/pull/15931#di",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-550426449,550426449,
jkczyz,2019-11-06 22:09:18,utACK 769ff05,https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-550523375,550523375,
jnewbery,2019-11-06 23:11:07,"@jkczyz you've ACKed an intermediate commit (github annoyingly orders commits in date order, not commit order). Did you mean to ACK the final commit in this branch (36b68de5b2938722911db900ca299f7008780d01).",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-550543414,550543414,
jkczyz,2019-11-07 00:11:17,"> @jkczyz you've ACKed an intermediate commit (github annoyingly orders commits in date order, not commit order). Did you mean to ACK the final commit in this branch ([36b68de](https://github.com/bitcoin/bitcoin/commit/36b68de5b2938722911db900ca299f7008780d01)).\n\nutACK 36b68de\n\nRight! The PR interface was showing a different order from the branch.",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-550559554,550559554,
ariard,2019-11-07 16:43:31,Can someome relaunch AppVeyor ? It got a linker error on bech32_tests.obj,https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-551162795,551162795,
jonatack,2019-11-07 16:50:42,"> Can someome relaunch AppVeyor ? It got a linker error on bech32_tests.obj\n\nAppveyor is an unrelated pending issue from https://github.com/bitcoin/bitcoin/pull/17357 affecting all other PRs that iiuc should be fixed by https://github.com/bitcoin/bitcoin/pull/17384.",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-551165891,551165891,
meshcollider,2019-11-08 10:20:22,"Looks good, thanks for keeping this maintained ariard. I agree with most of promag's comments but they aren't worth holding up merge for.\n\nutACK 36b68de5b2938722911db900ca299f7008780d01\n\n",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-551524362,551524362,
MarcoFalke,2019-11-12 23:07:25,"It looks like this might have sped up all WalletBalance micro benchmarks:\n\nhttps://codespeed.bitcoinperf.com/timeline/?exe=3%2C4%2C2%2C1%2C5&base=1%2B23&ben=micro.clang.WalletBalanceDirty&env=1&revs=10&equid=off&quarts=on&extr=on",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-553159016,553159016,
shesek,2019-11-19 22:56:37,"It appears like @MarcoFalke's link always displays the last 10 days, which already don't include the performance gains (which happened on Nov 8). I couldn't find a way to link to a specific date range in codespeed, so for future reference for people bumping into this thread, here's [a screenshot](https://user-images.githubusercontent.com/877904/69193689-fdf0b300-0b2f-11ea-9d1d-5ab40ef5cf00.png) in",https://github.com/bitcoin/bitcoin/pull/15931#issuecomment-555754713,555754713,
ryanofsky,2019-06-19 17:38:25,"In commit ""Add m_last_block_processed_height field in CWallet"" (0284c72ab07362150fd26c86966ea7c7bc6cfed5)\n\nWould be good to initialize this to -1 here for safety (and also for documentation, to be clear that this can be -1).\n\nWould also be good to add GUARDED_BY(cs_wallet) annotation.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295421954,295421954,src/wallet/wallet.h
ryanofsky,2019-06-19 17:59:05,"In commit ""Use CWallet::m_last_block_processed_height in GetDepthInMainChain"" (233ae92f2d51333f158810d85d13cf63a1144e6b)\n\nCan we use -1 instead of 0 for this to be consistent with nIndex? Also would be good to note  here that when a transaction is conflicted, `hashBlock` and `block_height` refer to the earliest block with a conflicting transaction instead of the block containing the transactio",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295430761,295430761,src/wallet/wallet.h
ryanofsky,2019-06-19 18:06:42,"In commit ""Use CWallet::m_last_block_processed_height in GetDepthInMainChain"" (233ae92f2d51333f158810d85d13cf63a1144e6b)\n\nIsn't this going to break existing serialization of transactions in the wallet? I think it'd be best not to change the serialized representation and just make this a memory-only field that gets filled when the wallet is loaded.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295434058,295434058,src/wallet/wallet.h
ryanofsky,2019-06-19 18:53:20,"In commit ""Add m_block_height field in CMerkleTx"" (8a1975586d3cc7f98961581859fd146a632bbd34)\n\nThis logic is getting hard to follow with three repetitive if(hashBlock...) blocks. Now that this is unconditionally updating hashBlock, I think the new logic is equivalent to the following and can be simplified:\n\n```c++\nassert(!wtxIn.isAbandoned()); // Incoming transactions should never have sp",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295463739,295463739,src/wallet/wallet.cpp
ryanofsky,2019-06-19 19:06:25,"In commit ""Add m_block_height field in CMerkleTx"" (8a1975586d3cc7f98961581859fd146a632bbd34)\n\nIt looks like a remaining place where m_block_height is still unset is in [`importprunedfunds`](https://github.com/bitcoin/bitcoin/blob/8a1975586d3cc7f98961581859fd146a632bbd34/src/wallet/rpcdump.cpp#L425-L426). It would probably be good to change that code to call `wtx.SetMerkleBranch` instead of set",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295476638,295476638,src/wallet/wallet.cpp
ryanofsky,2019-06-19 19:17:00,"In commit ""Add m_block_height field in CMerkleTx"" (8a1975586d3cc7f98961581859fd146a632bbd34)\n\nThere's no particular reason for keeping this height value, is there? I think it'd be cleaner to always represent abandoned transactions with block hash=ABANDON_HASH, block height=-1, index=-1 than to awkwardly make block hash and block height point different places.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295482350,295482350,src/wallet/wallet.cpp
ryanofsky,2019-06-19 19:28:03,"In commit ""Add m_block_height field in CMerkleTx"" (8a1975586d3cc7f98961581859fd146a632bbd34)\n\nThis comment seems out of date since position information is saved regardless. Would just drop it.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295486339,295486339,src/wallet/wallet.cpp
ryanofsky,2019-06-19 19:31:41,"In commit ""Add m_block_height field in CMerkleTx"" (8a1975586d3cc7f98961581859fd146a632bbd34)\n\nI don't think this additional text belongs here since it is really commenting on the code calling this function, and not explaining what is happening right here. Would just drop this comment.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295487658,295487658,src/wallet/wallet.cpp
ryanofsky,2019-06-19 19:46:28,"In commit ""Add m_block_height field in CMerkleTx"" (8a1975586d3cc7f98961581859fd146a632bbd34)\n\nNot really related to this PR, but I'm surprised this code is treating `vtxConflicted` transactions as if they are in the mempool and not marking them as conflicted with `nIndex` set to -1, and block hash and height pointing to the conflicting block. Maybe add a TODO here that we could explicitly mark",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295493094,295493094,src/wallet/wallet.cpp
ryanofsky,2019-06-19 19:53:19,"In commit ""Restrain waitForNotificationsIfNewBlocksConnected  check to strict tip to avoid race condition"" (6b7962a650def5629eb2f897b6ace79a684c0cf0)\n\nThis commit seems to be doing two unrelated things: dropping the BlockUntilSyncedToCurrentChain call here and also changing the BlockUntilSyncedToCurrentChain implementation. Would suggest splitting this into two separate commits if possible.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295495763,295495763,src/wallet/wallet.cpp
ryanofsky,2019-06-19 19:54:26,"In commit ""Restrain waitForNotificationsIfNewBlocksConnected  check to strict tip to avoid race condition"" (6b7962a650def5629eb2f897b6ace79a684c0cf0)\n\nWould suggest renaming `waitForNotificationsIfNewBlocksConnected` to `waitForNotificationsIfTipChanged` to accurately describe the new behavior.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295496246,295496246,src/interfaces/chain.h
ryanofsky,2019-06-19 20:08:34,"In commit ""Use CWallet::m_last_block_processed_height in GetDepthInMainChain"" (233ae92f2d51333f158810d85d13cf63a1144e6b)\n\nCan we `assert(m_block_height > 0)` after this point? I'm afraid of another bug like the `importprunedfunds` one mentioned earlier leaving m_block_height unset and this function returning bogus values.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295501695,295501695,src/wallet/wallet.cpp
ryanofsky,2019-06-19 20:17:54,"In commit ""Use CWallet::m_last_block_processed_height in GetDepthInMainChain"" (233ae92f2d51333f158810d85d13cf63a1144e6b)\n\nThis looks right but is the logic is kind of obscure. Maybe you could add an explanatory comment like ""If nIndex is -1 and the block hash is set, it means the transaction is conflicted, and that m_block_height will be set to the height of the earliest conflicting block, so ",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295505197,295505197,src/wallet/wallet.cpp
ryanofsky,2019-06-19 20:25:30,"In commit ""Add m_last_block_processed_height field in CWallet"" (0284c72ab07362150fd26c86966ea7c7bc6cfed5)\n\nCan this `assert(m_last_block_processed_height >= 0)`? This would catch usage errors if there are calls to this function before the wallet is initialized.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295508382,295508382,src/wallet/wallet.h
ariard,2019-07-09 01:52:58,"Hmmm filled at startup using ```getBlockHeight```, given we already have ```hashBlock``` ? Do you envision the wallet to always query chain state to succeed its startup ?",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301367213,301367213,src/wallet/wallet.h
ariard,2019-07-09 01:54:08,"Updated ```AddToWallet```, hope it's clearer ",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301367411,301367411,src/wallet/wallet.cpp
ariard,2019-07-09 01:58:59,"Oooops, I forgot this one. I've added a call to ```SetMerkleBranch``` in ```importprunedfunds``` but had to change its argument to hask for transaction height too. Seems to me similar to the serialization issue, do we want wallet to ask chain the state of its stored transactions every time, even it should be able to infer it from the blocks already connected ?",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301368195,301368195,src/wallet/wallet.cpp
ariard,2019-07-09 02:00:16,Should be dropped on 1458ded,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301368385,301368385,src/wallet/wallet.cpp
ariard,2019-07-09 02:00:51,"Should be dropped on 1458ded\n",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301368491,301368491,src/wallet/wallet.cpp
ariard,2019-07-09 02:06:23,"Done, see 9c07c16",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301369291,301369291,src/interfaces/chain.h
ariard,2019-07-09 02:11:34,Splitted between 8a16c67 and 9c07c16,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301370162,301370162,src/wallet/wallet.cpp
ariard,2019-07-09 02:12:49,Commented and updated logic as suggested on 573ca36,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301370461,301370461,src/wallet/wallet.cpp
ariard,2019-07-09 02:13:42,Check should be there in b1ae297,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301370602,301370602,src/wallet/wallet.h
ariard,2019-07-09 02:15:58,"Hmmm, I introduced  ```assert(m_block_height >= -1)``` as we may GetDepthInMainChain on fresh transactions, their ```hashBlock``` being unset, their depth should appear as zero.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301370949,301370949,src/wallet/wallet.cpp
ariard,2019-07-09 02:20:32,"Okay, I did a second round with the following model in head  (state, triplet<hashBlock, nIndex, block_height>) : NEW<{}, -1, -1>, UNCONFIRMED<{}, 0, 0>, CONFIRMED<block_hash, posInBlock, block_height>, ABANDON<ABANDON_HASH, -1, -1>, CONFLICTED<hashBlock, -1, conflicting_height>.\nDo you have one similar, should we noted it somewhere ?",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301371748,301371748,src/wallet/wallet.cpp
ariard,2019-07-09 02:23:12,"Ok, updated on 6289909, maybe I should refine it in its own commit?",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301372154,301372154,src/wallet/wallet.cpp
ariard,2019-07-16 03:18:25,"Note : I've seen one Travis failure on feature_reindex.py due to the assert. I wasn't able to reproduce it on my local dev env, I think it's caused by Travis really slow setup, but that's not great, what's your take on it ?",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r303713964,303713964,src/wallet/wallet.h
jnewbery,2019-07-23 16:05:21,This line is introduced in a too-early commit (_Add m_last_block_processed_height field in CWallet_) where the member variable _m_block_height_ doesn't yet exist. The _Add m_last_block_processed_height field in CWallet_ commit doesn't build because the variable is not declared.,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306404822,306404822,src/wallet/wallet.cpp
jnewbery,2019-07-23 16:24:46,"Is this required? the txoutproof includes a block header, which could be used to look up the height in the chain.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306413990,306413990,src/wallet/rpcdump.cpp
jnewbery,2019-07-23 16:38:09,No need to move this function declaration.,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306420045,306420045,src/wallet/wallet.h
jnewbery,2019-07-23 17:28:34,Can these three lines be replaced by a call to `wtx.SetMerkleBranch()`?,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306441436,306441436,src/wallet/test/wallet_tests.cpp
jnewbery,2019-07-23 17:44:28,"In _Move CWallet ptr from CWalletTx to CMerkleTx_: is there any point in keeping the `CMerkleTx`/`CWalletTx` division after this? `CMerkleTx` is _only_ used as a base class for _CWalletTx_. It's been around since the first git commit, and I expect Satoshi thought `CMerkleTx` could be useful outside the wallet, but now that it's adding a pointer to the CWallet, it seems redundant to have it as a se",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306448468,306448468,src/wallet/wallet.h
jnewbery,2019-07-23 18:09:53,"The comment says `An block_height == 0` in commit _Add m_block_height field in CMerkleTx_ and then changes to `A block_height == -1` in _Use CWallet::m_last_block_processed_height in GetDepthInMainChain_.\n\nIt would be better to not change this in the course of the PR and just set it to `A block_height == -1` in the first PR.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306459728,306459728,src/wallet/wallet.h
jnewbery,2019-07-23 18:24:52,"This height accounting in the wallet scares me slightly. I think that prior to this change, the wallet tolerates any bug in the node that sends duplicate `BlockConnected()` or `BlockDisconnected()` calls over the CValidationInterface. After this change, a duplicate `BlockConnected` notification could cause the wallet to get into a very bad inconsistent state.\n\nIs it possible to update the CVal",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306466421,306466421,src/wallet/wallet.cpp
ariard,2019-07-24 18:28:54,"Ooops, bad rebase sorry, should be corrected",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306958014,306958014,src/wallet/wallet.cpp
ariard,2019-07-24 18:36:57,"Hmmm well we could use `getBlockHeight` again in this function but I didn't want because was planning to remove this Chain method after we move ScanForWalletTransactions and its logic on the node side.\n\nMaybe that a bit premature, but IMO this RPC should come with all proofs + height without us having to query the chain..",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306961660,306961660,src/wallet/rpcdump.cpp
ariard,2019-07-24 18:48:59,"See #16451, thanks for going forwad on it :)",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306967081,306967081,src/wallet/wallet.h
ariard,2019-07-24 20:01:34,"You're right, it's far better to rely on message content than counting the message in itself.\nTo do, I've extended BlockDisconnected, for BlockConnected we have CBlockIndex it was just masked between Notification and CWallet",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r306995955,306995955,src/wallet/wallet.cpp
jnewbery,2019-07-24 20:30:23,"I don't like this change for a couple of reasons:\n\n- it's a breaking change for clients, so they'll need to reimplement their code\n- the RPC doesn't do any checking on the `height` value passed, so it's possible to get the wallet into some inconsistent state by passing a bad `height` value.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r307006966,307006966,src/wallet/rpcdump.cpp
jnewbery,2019-08-06 15:19:15,I'm not sure if this macro does anything?,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r311123565,311123565,src/wallet/wallet.h
jnewbery,2019-08-06 15:19:32,Please don't fixup style from surrounding code. It makes the diff less clean.,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r311123704,311123704,src/wallet/wallet.h
ariard,2019-08-07 05:04:47,"Thanks, I misused some linter scripts I think\n\n(in fact syntax _variable_ {-1} GUARDED_BY(lock) failed on some compilers compare to _variable_ GUARDED_BY(lock) =  -1) ",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r311369642,311369642,src/wallet/wallet.h
ryanofsky,2019-08-07 07:39:32,"It's fine to use CBlockIndex pointers in CValidationInterface methods, but Chain::Notification methods should just pass `int height` parameters. Using CBlockIndex here exposes node internals to the wallet and  makes #10102 less efficient because CBlockIndex data would have to be serialized and sent across a socket.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r311408799,311408799,src/interfaces/chain.h
jnewbery,2019-08-09 16:02:44,nit: place this new data member immediately next to `m_last_block_processed`. The comment for both need to emphasize that this block hash/height is for the **node's** tip and doesn't indicate that the wallet has scanned up to this hash/height.,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312547306,312547306,src/wallet/wallet.h
jnewbery,2019-08-09 17:01:00,I don't think this new assert is right. A user might 'abandon' a transaction and it later be relayed or confirmed in a block.,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312568142,312568142,src/wallet/wallet.cpp
jnewbery,2019-08-09 17:07:52,nit: add comment on why a chain might not be available. I think this is only the case in the wallettool.,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312570526,312570526,src/wallet/wallet.cpp
jnewbery,2019-08-09 17:24:17,"I don'd understand why you've removed this conditional (I think it's because you want to set the tx's block height to 0 (https://github.com/bitcoin/bitcoin/pull/15931#discussion_r301371748), but I don't understand why you want to do that).\n\nIn general, I think it'd be easier if `hashBlock`, `nIndex` and `m_block_height` were added to a struct along with an `tx_state` enum which could take `UNC",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312576506,312576506,src/wallet/wallet.cpp
jnewbery,2019-08-09 19:03:11,"I think an alternative would be to reset the `hashBlock`, `nIndex` and `m_block_height` for all transactions matching the block hash when a `BlockDisconnected` is received. That would involve iterating through all of the wallet txs to check their `hashBlock`s. Re-orgs are supposed to be pretty rare, so I think that's ok. Thoughts?",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312611972,312611972,src/wallet/wallet.cpp
jnewbery,2019-08-09 19:09:14,"I don't understand why this has to be removed. Can you add some more detail to the commit log?\n\n(I think the current commit log ""Scheduler thread servicing chain state is stopped before wallet unloading and can't be useful"" isn't right. `ReleaseWallet()` is the delete expression for the CWallet shared_ptr, and so is called for example when the wallet is unloaded during runtime.)",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312613808,312613808,src/wallet/wallet.cpp
jnewbery,2019-08-09 19:38:10,I think this is a change in behaviour. The was previously (current tip height) - (height of block with conflicting tx). This is now just (height of block with conflicting tx).,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r312622408,312622408,src/wallet/wallet.cpp
ariard,2019-08-12 17:19:13,"Yes, had a comment about it, it doesn't imply that the wallet has seen all blocks since genesis up until `m_last_block_processed_height`",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r313034668,313034668,src/wallet/wallet.h
ariard,2019-08-12 17:58:40,"After reading again about how to use abandontransaction, I think you're right, tx might be not in a block or not in your mempool so you can flag is as abandoned. But after this, it can still being included as part of other peers mempools. Removed it, was suggested here initially https://github.com/bitcoin/bitcoin/pull/15931#discussion_r295463739",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r313052247,313052247,src/wallet/wallet.cpp
ariard,2019-08-12 18:09:09,"Okay, this point is already mentioned in commit message, `Verify` and `LoadWallet` but added also on this place.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r313056664,313056664,src/wallet/wallet.cpp
ariard,2019-08-12 18:31:37,"Thanks for this one, in fact after thinking of it, that would be a bug if you have multiple conflicting txn, you would pick up the one with the highest height instead of the highest depth so not the most conflicting one..",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r313066785,313066785,src/wallet/wallet.cpp
ariard,2019-08-15 21:36:29,"Gone this way, see https://github.com/bitcoin/bitcoin/pull/16624",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314509181,314509181,src/wallet/wallet.cpp
ariard,2019-08-15 21:41:53,"Yes I've thought about while working on the rescan logic. I've introduced a `Rewind` callback in the `Chain::Notifications`, it should call a wallet method to zeroed out cleanly tx `hashBlock`, `nIndex` and `m_block_height`. I've proposed to introduce in this future-PR, this one is already wide enough.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314510848,314510848,src/wallet/wallet.cpp
ariard,2019-08-15 21:59:12,"I've run tests again, can't remember but I had a test staling some point which was solved by this, I think I may have introduce a height error at some point which would false `waitForNotificationsIfTipChanged` and later corrected it without realizing it would fix this. Drop this commit.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314516068,314516068,src/wallet/wallet.cpp
promag,2019-08-15 22:01:48,"3a04cd6776f7f1ec86cad20de90c9fbb24655536\n\nnit, could drop `&` from 1st argument, it was discussed elsewhere that smart pointers and iterators should be used as value.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314516784,314516784,src/validationinterface.h
promag,2019-08-15 22:05:32,"3d32a691d2df4c73a39a64a5d331c29b5eb94213\n\nIs this a bugfix?",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314517774,314517774,src/wallet/wallet.cpp
promag,2019-08-15 22:18:58,"3d32a691d2df4c73a39a64a5d331c29b5eb94213\n\nWhy isn't this named `SetLastBlockProcessedHeight`?\n\nAnyway I think the variable should be `m_chain_tip_height`. Also, I think now `m_last_block_processed` should be improved, like:\n```cpp\n    uint256 m_chain_tip_hash GUARDED_BY(cs_wallet);\n    int m_chain_tip_height GUARDED_BY(cs_wallet){-1};\n```\nand both should be set at once.\n",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r314521199,314521199,src/wallet/wallet.h
ariard,2019-08-19 14:31:48,"Agree for the name of method and set at once, but not sure for variables. I think it would be confusing, as intent of this PR is to let the wallet have its own view of what chain tip is after processing block from validation interface. So real chain tip and the wallet one may diverge.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315242405,315242405,src/wallet/wallet.h
promag,2019-08-19 14:40:06,Yeah these would be from the wallet POV.,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315246890,315246890,src/wallet/wallet.h
ariard,2019-08-19 14:46:40,"Yes it was a bugfix compare to a53586c at least, it became obvious only after switching to query the chain based on block hash at wallet loading!",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315250728,315250728,src/wallet/wallet.cpp
jkczyz,2019-08-19 16:06:36,"If I'm reading @jnewbery's comment correctly, part of the documentation for `m_last_block_processed` and `m_last_block_processed_height` can be shared.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315291853,315291853,src/wallet/wallet.h
jkczyz,2019-08-19 16:12:20,"Would it be possible to set `m_last_block_processed_height` when setting `m_last_block_processed` below? Or does the intermediary calls rely on the value of either?\n\nSimilarly for `CWallet::BlockDisconnected`.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315294228,315294228,src/wallet/wallet.cpp
jkczyz,2019-08-19 18:05:17,"Nits:\n\n1. Consider rewording for succinctness and clarity: Height of block against which tx is linked via a merkle branch.\n2. End each sentence with a period as they tend to blend when reading the comment.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315340601,315340601,src/wallet/wallet.h
jkczyz,2019-08-19 18:23:01,"Instead of initializing an `Optional<int>` then conditionally assigning it based on the result of `hasChain()`, could you instead define something like `chainHeight()` to return an `Optional<int>`? This would hide the chain logic from `LoadToWallet()`.\n\nIf not, consider directly assigning `0` to `wtxIn.m_block_height` and conditionally updating it based on `hasChain()`. The addition of `Option",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315347964,315347964,src/wallet/wallet.cpp
jnewbery,2019-08-19 21:54:39,Please don't do this. Trying to 'fix' surrounding code in a PR makes the diff bigger and more confusing for reviewers.,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315428979,315428979,src/validationinterface.h
ariard,2019-08-20 14:53:31,"I don't want to add new method in Chain interface, but yes 2nd suggested alternative avoid the `MakeOptional` which is good, updated\n            ",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315736818,315736818,src/wallet/wallet.cpp
ariard,2019-08-20 15:06:55,Updated comments,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315744374,315744374,src/wallet/wallet.h
ariard,2019-08-20 15:13:14,"Yes it has to be before, but IIRC not the m_last_block_processed assignment. Moved it near to m_last_block_processed_height.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r315747855,315747855,src/wallet/wallet.cpp
ryanofsky,2019-10-16 18:39:41,"In commit ""Add block_height field in struct Confirmation"" (6593366d385e1c299a675af58ddd2138b3bd01e5)\n\nWhat's the reason for the `&& !block_height check`? Is it to handle the case where a transaction was reorged out while online and then reconfirmed while offline? It seems like like nIndex will still incorrectly be 0 in this case, though the block height and hash will remain set. Not sure the 0",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r335645716,335645716,src/wallet/wallet.cpp
ryanofsky,2019-10-16 19:01:42,"In commit ""Add block_height field in struct Confirmation"" (6593366d385e1c299a675af58ddd2138b3bd01e5)\n\nNew method seems unused",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r335655545,335655545,src/wallet/wallet.h
ryanofsky,2019-10-16 19:12:43,"In commit ""Restrain waitForNotificationsIfNewBlocksConnected check to strict tip"" (25f7a78b952f172457b75b7fa2dc889215e0703b)\n\nCan the commit message say what motivated this change or what it has to do with the other changes in the PR? It mentions changing RPCs to not indicate reorged transactions are confirmed, but this seems like preexisting behavior not related to the PR.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r335660016,335660016,src/interfaces/chain.cpp
ryanofsky,2019-10-16 19:23:10,"In commit ""Use CWallet::m_last_block_processed_height in GetDepthInMainChain"" (901fa3a3a5fdac52ec6df69acb744abd99a6cb99)\n\nCan this return be eliminated? It seems risky to silently return incorrect information about a transaction if there was an iinitialization error at an earlier point in the code. It might be better to assert.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r335664441,335664441,src/wallet/wallet.cpp
ryanofsky,2019-10-16 19:35:36,"In commit ""Use CWallet::m_last_block_processed_height in GetDepthInMainChain"" (901fa3a3a5fdac52ec6df69acb744abd99a6cb99)\n\nThis TODO is fine and no need to change things here, but I think GetDepthInMainChain and related methods should probably be standalone utility functions or `CWallet` methods instead of `CWalletTx` members. I guess other ways to support adding the lock annotation would be to",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r335669691,335669691,src/wallet/wallet.h
ariard,2019-10-23 15:34:40,"Updated the comment, which was saying the inverse of what was done in code, if tx was confirmed (or conflicted by another confirmed tx) and a reorg happens we should reset tx status to unconfirmed. The case where a transaction was reorged out while online and then reconfirmed while offline is covered by the rescan logic of wallet creation IMO. Reason for the `&& !block_height` is to check that we ",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338123599,338123599,src/wallet/wallet.cpp
ariard,2019-10-23 15:34:51,Removed,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338123703,338123703,src/wallet/wallet.h
ariard,2019-10-23 15:38:08,"Updated commit message, due to the switch to height tracking based on callbacks, if we don't wait for the whole callbacks queue being drawn because the last block hash processed by the wallet may be a descendant of the current tip, we may miss to process BlockDisconnected and so get tx deptch inconsistencies. ",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338125519,338125519,src/interfaces/chain.cpp
ariard,2019-10-23 15:38:21,Switch to asserting.,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338125648,338125648,src/wallet/wallet.cpp
ariard,2019-10-23 15:39:52,"Ok, I think will let it as it is for now and will try to pass a `CWallet&` argment in a future PR scoped only on this.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338126522,338126522,src/wallet/wallet.h
ryanofsky,2019-10-23 16:26:24,"In commit ""Pass block height in Chain::BlockConnected/Chain::BlockDisconnected"" (82c591ea35ac918147ca66444ae608b8385abd7c)\n\nWould it be more correct to pass the block height here instead of 0?",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338150753,338150753,src/wallet/test/wallet_tests.cpp
ryanofsky,2019-10-23 16:38:20,"In commit ""Add block_height field in struct Confirmation"" (de8fe7d717042823f2aa429be2a260904a10b42e)\n\nPerhaps something for a followup PR, but I wonder if some getBlockHeight calls can be removed now and replaced with block_height accesses:\n\nhttps://github.com/bitcoin/bitcoin/blob/089189ef99effe79bb2b71b9248f8aa419079b9a/src/interfaces/wallet.cpp#L66\nhttps://github.com/bitcoin/bitcoin/bl",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338156719,338156719,src/wallet/wallet.h
ryanofsky,2019-10-23 16:49:05,"In commit ""Add block_height field in struct Confirmation"" (de8fe7d717042823f2aa429be2a260904a10b42e)\n\nI think this comment should explicitly mention what you said about ""The case where a transaction was reorged out while online and then reconfirmed while offline is covered by the rescan logic,"" or at least mention generally that these transaction statuses aren't final and will be patched up by",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338161904,338161904,src/wallet/wallet.cpp
ryanofsky,2019-10-23 16:49:42,"In commit ""Add block_height field in struct Confirmation"" (de8fe7d717042823f2aa429be2a260904a10b42e)\n\ns/being shutdown/was shutdown/ for clarity",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338162196,338162196,src/wallet/wallet.cpp
ryanofsky,2019-10-23 17:05:04,"In commit ""Add block_height field in struct Confirmation"" (de8fe7d717042823f2aa429be2a260904a10b42e)\n\nMakes sense! I think logic would be less confusing it we got rid of the repeated height checks, though. Would suggest\n\n```c++\nOptional<int> block_height = locked_chain->getBlockHeight(wtxIn.m_confirm.hashBlock);\nif (block_height) {\n    // Update cached block height variable since it ",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338169478,338169478,src/wallet/wallet.cpp
ryanofsky,2019-10-23 20:57:35,"In commit ""Add block_height field in struct Confirmation"" (de8fe7d717042823f2aa429be2a260904a10b42e)\n\nNote: this is one of the previous PR cleanups mentioned in the commit description: https://github.com/bitcoin/bitcoin/pull/16624#discussion_r321331630",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338274948,338274948,src/wallet/wallet.cpp
ryanofsky,2019-10-23 21:06:11,"In commit ""Pass block height in Chain::BlockConnected/Chain::BlockDisconnected"" (82c591ea35ac918147ca66444ae608b8385abd7c)\n\nOrder of arguments here is wrong. Block height come before position in block.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338278567,338278567,src/wallet/wallet.cpp
ryanofsky,2019-10-23 21:14:27,"In commit ""Add block_height field in struct Confirmation"" (de8fe7d717042823f2aa429be2a260904a10b42e)\n\nCould you move the block_height argument after block_hash to be consistent with `SyncTransaction` argument order and `Confirmation` struct order?\n\nAlternately, it possible, it would be really nice to combine the 4 status/hash/height/index arguments into a single CWalletTx::Confirmation str",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338282044,338282044,src/wallet/wallet.h
ryanofsky,2019-10-23 21:15:10,"In commit ""Add block_height field in struct Confirmation"" (de8fe7d717042823f2aa429be2a260904a10b42e)\n\nCould you move the block_height argument after block_hash to be consistent with `SyncTransaction` argument order and `Confirmation` struct order?",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338282320,338282320,src/wallet/wallet.h
ryanofsky,2019-10-23 21:24:00,"In commit ""Add block_height field in struct Confirmation"" (de8fe7d717042823f2aa429be2a260904a10b42e)\n\nThis seems harmless, but it's unclear why it's part of this commit. Is this line meant to added to another commit where the block_height is actually used? Also, I don't see where -1 would be set or allowed for this.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338285914,338285914,src/wallet/wallet.cpp
ryanofsky,2019-10-23 21:28:43,"In commit ""Add block_height field in struct Confirmation"" (de8fe7d717042823f2aa429be2a260904a10b42e)\n\nMaybe replace ""hasn't confirmed yet"" with ""is unconfirmed or abandoned"" to be more specific and include mention of the abandoned state.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338287777,338287777,src/wallet/wallet.h
ryanofsky,2019-10-23 21:30:05,"In commit ""Add block_height field in struct Confirmation"" (de8fe7d717042823f2aa429be2a260904a10b42e)\n\nNote: this is another cleanup from the previous pr.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338288319,338288319,src/wallet/wallet.h
ryanofsky,2019-10-23 21:39:22,"In commit ""Add m_last_block_processed_height field in CWallet"" (9161f0bf0321e90e0aaeeafc58c5ea6f97ebb1e2):\n\nWould `assert(m_last_block_processed_height >= 0)` to make sure we're past initialization and don't wind up with crazy depth values.\n",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338291892,338291892,src/wallet/wallet.h
ryanofsky,2019-10-23 21:43:59,"In commit ""Add block_height field in struct Confirmation"" (de8fe7d717042823f2aa429be2a260904a10b42e)\n\nCan you replace m_last_block_processed_height with height on this line? It's slightly worrying to depend on the wallet member if it might get updated for some reason, and also better to be more consistent with previous `block_hash` argument.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338293551,338293551,src/wallet/wallet.cpp
ariard,2019-10-24 19:10:13,"I let it be, need thoughts maybe to retrieve more as same time",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338744823,338744823,src/wallet/wallet.h
ariard,2019-10-24 19:12:04,"Added commit d0c4ce6 : Replace CWalletTx:SetConf by Confirmation initialization list, should make things less error-prone.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338745557,338745557,src/wallet/wallet.cpp
ariard,2019-10-24 19:12:24,See d0c4ce6,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338745681,338745681,src/wallet/wallet.h
ariard,2019-10-24 19:13:22,"Removed, was there to be sure block_height was initialized in a previous version, now it has to be with `Confirmation` default initialization",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338746058,338746058,src/wallet/wallet.cpp
ariard,2019-10-24 19:13:37,Done,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338746153,338746153,src/wallet/wallet.h
ryanofsky,2019-10-24 21:06:20,"In commit ""Replace CWalletTx::SetConf by Confirmation initialization list"" (d0c4ce686ba388b9fefff2b153358e33a042ee80)\n\nNot important, but might want to avoid creating named variable with:\n\n```\nwtx.m_confirm = CWalletTx::Confirmation{CWalletTx::Status::CONFIRMED, merkleBlock.header.GetHash(), txnIndex};\n```\n\nSimilarly with all the other temporary `confirm` variables below.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338791804,338791804,src/wallet/rpcdump.cpp
ryanofsky,2019-10-24 21:08:36,"In commit ""Replace CWalletTx::SetConf by Confirmation initialization list"" (d0c4ce686ba388b9fefff2b153358e33a042ee80)\n\nNot a big deal, but probably better to pass with reference type `const CWalletTx::Confirmation&` to avoid copies when this is called. Similarly for other functions taking confirm arguments.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r338792689,338792689,src/wallet/wallet.cpp
ryanofsky,2019-11-05 18:08:57,Note for future followup: I believe we could call [`IsFinalTx`](https://github.com/bitcoin/bitcoin/blob/50591f6ec61b802cf4193cdbefcc85ad75716e8d/src/consensus/tx_verify.cpp#L17-L28) instead of [`checkFinalTx`](https://github.com/bitcoin/bitcoin/blob/50591f6ec61b802cf4193cdbefcc85ad75716e8d/src/validation.cpp#L189-L219) so `locked_chain` argument no longer needs to be passed to `CWalletTx::IsTruste,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r342715246,342715246,src/wallet/wallet.cpp
ryanofsky,2019-11-05 20:32:52,"In commit ""Remove locked_chain from GetDepthInMainChain and its callers"" (dd3cb3804126abdba8684cb965d2e1dc3766b3fd)\n\nAppears to be a mistake during rebase: lost abs() call",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r342783384,342783384,src/wallet/rpcwallet.cpp
ariard,2019-11-05 20:44:05,"Thanks to spot it, was introducted in 436ad43, corrected rebase mistake!",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r342787764,342787764,src/wallet/rpcwallet.cpp
jkczyz,2019-11-05 22:03:43,"This code would benefit if organized using a guard clause.\n\n```c++\nif (merkleBlock.txn.ExtractMatches(vMatch, vIndex) != merkleBlock.header.hashMerkleRoot) {\n    throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, ""Something wrong with merkleblock"");\n}\n\nauto locked_chain = pwallet->chain().lock();\nOptional<int> height = locked_chain->getBlockHeight(merkleBlock.header.GetHash());\nif (h",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r342821318,342821318,src/wallet/rpcdump.cpp
jnewbery,2019-11-05 22:12:51,"It looks like you add this member one commit too early (_Replace CWalletTx::SetConf by Confirmation initialization list_ instead of _Add block_height field in struct Confirmation_), which means that all of the `Confirmation` objects in that commit are setting height incorrectly. Not sure if that would break anything with git bisect. Can you rearranage those commits?",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r342824980,342824980,src/wallet/wallet.h
jnewbery,2019-11-05 22:15:17,"nit (not worth fixing here, but good to keep in mind for future PRs): these very long (>120 char) lines make looking at diffs quite difficult. Both this comment block and the `Confirmation` constructor could be line-wrapped.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r342825965,342825965,src/wallet/wallet.h
jnewbery,2019-11-05 22:16:17,"nit: ""This triplet is whole 0"" doesn't sound right. ""All three are set to 0"" would be more natural.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r342826446,342826446,src/wallet/wallet.h
jnewbery,2019-11-05 22:22:12,"I'm not a big fan of these default arguments, especially since the last two are both `int`s. It's too easy to accidentally call the constructor with the wrong number of arguments and set `block_height` when you meant to set `nIndex` (as this branch does in an intermediate commit)",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r342828677,342828677,src/wallet/wallet.h
jkczyz,2019-11-05 22:45:47,Can these fields be `const` now?,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r342837263,342837263,src/wallet/wallet.h
jkczyz,2019-11-05 22:47:22,The documentation needs to be updated for this new field.,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r342837797,342837797,src/wallet/wallet.h
ariard,2019-11-06 17:55:13,"Rearrange members initialization order and add comments, tell me if you have a better measure.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343240886,343240886,src/wallet/wallet.h
ariard,2019-11-06 17:55:57,I think we can't due to setting them with method like `setAbandoned`?,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343241228,343241228,src/wallet/wallet.h
ariard,2019-11-06 17:57:00,Shouldn't be an issue anymore as `block_height` has been switched to the right commit.,https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343241730,343241730,src/wallet/wallet.h
jnewbery,2019-11-06 19:03:47,"very minor nit: using `b` for height and `h` for hash is a little confusing. Using a few extra characters and calling these `status_in`, `height_in`, `hash_in` and `index_in` would make this clearer.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343272517,343272517,src/wallet/wallet.h
jkczyz,2019-11-06 22:08:48,"Ah, you're right. Could be better to assign a new object within `setAbandoned` instead, but feel free to leave as it is. Looks like there are other places where these are directly assigned.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343354412,343354412,src/wallet/wallet.h
promag,2019-11-06 23:31:00,"5aacc3eff15b9b5bdc951f1e274f00d581f63bce\n\n> Yes it has to be before\n\nCould leave a comment explaining why?\n\n> Moved it near to m_last_block_processed_height.\n\nWhy? If there's no reason to change then I'd it keep where it was.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343383028,343383028,src/wallet/wallet.cpp
promag,2019-11-06 23:35:07,"5aacc3eff15b9b5bdc951f1e274f00d581f63bce\n\nnit, use default member initialize `{-1}` instead of `= -1`.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343384187,343384187,src/wallet/wallet.h
promag,2019-11-06 23:39:16,"5aacc3eff15b9b5bdc951f1e274f00d581f63bce\n\nUse `const uint256& block_hash`?",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343385419,343385419,src/wallet/wallet.h
promag,2019-11-06 23:44:38,"5aacc3eff15b9b5bdc951f1e274f00d581f63bce\n\nWhy not just lock `::cs_main` if you don't even use the interface?",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343386868,343386868,src/qt/test/wallettests.cpp
promag,2019-11-06 23:47:24,"10b4729e33f76092bd8cfa06d1a5e0a066436f76\n\nnit, just `pindex`? Otherwise use snake case. Same in the header.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343387639,343387639,src/zmq/zmqnotificationinterface.cpp
promag,2019-11-06 23:59:56,"9700fcb47feca9d78e005b8d18b41148c8f6b25f\n\nYou can also drop `Confirmation` constructor and do\n```cpp\nwtx.m_confirm = {CWalletTx::Status::CONFIRMED, merkleBlock.header.GetHash(), int(txnIndex)};\n```\nand\n```cpp\n    SyncTransaction(ptx, {CWalletTx::Status::UNCONFIRMED, /* hash = */ {}, /* index = */ 0);\n```",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343390851,343390851,src/wallet/rpcdump.cpp
promag,2019-11-07 00:19:14,"0ff03871add000f8b4d8f82aeb168eed2fc9dc5f\n\nI don't think commit message is correct:\n```\nAvoid to lock chain to query state thanks to tracking last block\nheight in CWallet.\n```\nShould say something like?\n```\nUse wallet's last block height instead of the locked chain, which\nwill allow removing the chain lock.\n```",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343395865,343395865,src/wallet/wallet.cpp
promag,2019-11-07 00:23:13,"36b68de5b2938722911db900ca299f7008780d01\n\nWhat's the problem with `-(m_last_block_processed_height - conflicting_height + 1)`?",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343396904,343396904,src/wallet/wallet.cpp
ariard,2019-11-07 16:37:24,"Method `chain` here is the way to use the `interfaces::chain`, I think it doesn't matter that much here to use the `Node` or `Chain` one.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343752221,343752221,src/qt/test/wallettests.cpp
ariard,2019-11-07 16:38:53,"That's a better wording, I will use it if I have to rebase.",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r343753048,343753048,src/wallet/wallet.cpp
ryanofsky,2020-01-27 22:14:22,"In commit ""Use CWallet::m_last_block_processed_height in GetDepthInMainChain"" (0ff03871add000f8b4d8f82aeb168eed2fc9dc5f)\n\n@ariard It seems like this line is written assuming that `GetLastBlockHeight()` is always `>= m_confirm.block_height`, but if I add asserts here:\n\n```c++\nassert(m_confirm.block_height >= 0);\nassert(m_confirm.block_height <= pwallet->GetLastBlockHeight());\n```\n\",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r371512762,371512762,src/wallet/wallet.cpp
ryanofsky,2021-01-08 19:30:07,"In commit ""Use CWallet::m_last_block_processed_height in GetDepthInMainChain"" ([0ff0387](https://github.com/bitcoin/bitcoin/commit/0ff03871add000f8b4d8f82aeb168eed2fc9dc5f))\n\nDropping the `getBlockDepth` call here introduces a bug because `getBlockDepth` had a safety check to return 0 if there was a reorg and hashBlock is no longer in the active chain, while the new code will just return a gar",https://github.com/bitcoin/bitcoin/pull/15931#discussion_r554147619,554147619,src/wallet/wallet.cpp
