luke-jr,2016-07-18T19:55:11Z,"This solves a different concern than #8364. Concept ACK, but without the removal of bytespersigop.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233439506,233439506,
sipa,2016-07-18T19:57:06Z,"@luke-jr It was always my assumption that the bytespersigop default was chosen to be equal to MAX_SIZE / MAX_SIGOPS. The fact that it isn't (20, instead of 50) means that someone can pay only 40% of the price for a full block's worth of space, and fill it up with small-size high-sigops transactions.\n\nI see no reason why the number would ever be other than 50, so I'm removing the parameter.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233440012,233440012,
gmaxwell,2016-07-18T20:02:47Z,Concept ACK.\n,https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233441526,233441526,
sdaftuar,2016-07-18T21:12:47Z,"Concept ACK, but to be clear I don't think we should merge a policy change like this for 0.13.  As it applies to all transactions, and in particular not just the ones being rejected under the current `-bytespersigop` policy, we should give users more notice on the proposed change.  (In the worst case, some transactions that are relayed under current policy of 20 bytes per sigop could conceivably s",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233460584,233460584,
gmaxwell,2016-07-18T21:51:47Z,I think it could be temporarily adjusted to only impact transactions currently precluded by the bytes per sigop policy. Would that make it more attractive for a more immediate deployment?\n,https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233470204,233470204,
sipa,2016-07-18T23:33:30Z,"Reworked the patch.\n\nIt no longer removes -bytespersigop (as that constitutes a policy change we shouldn't be introducing this late in the release process), and does not kill the cost caching in mining. As a result, the existing tests also remain valuable.\n\nThis is hopefully less controversial, fewer code changes, and more efficient.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233490221,233490221,
luke-jr,2016-07-18T23:42:52Z,The changes do not address my concern. bytespersigop is not about miner fee optimisation.\n,https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233491683,233491683,
sipa,2016-07-18T23:52:04Z,"@luke-jr I'm sorry to have misunderstood the original intent of the #7081 then, but that's the only thing it does in my opinion.\n\nThe code we had before #7081 produces nonsensical blocks when high-sigop low-size transactions are present in the mempool, resulting in lower fees than a miner could claim, and reduced transaction capacity on the network for a low cost to the attacker. Our code was br",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233493089,233493089,
luke-jr,2016-07-18T23:59:37Z,"If there are not 20 bytes per (properly counted; ie, with the fix in #8364) sigop, then the transaction is clearly misusing the sigop for spam and/or attack. The goal of bytespersigop is to prevent such transactions from being mined or relayed at all.\n\nI'm fine with miner optimisation as in this PR, but it's a separate matter.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233494292,233494292,
sipa,2016-07-19T00:04:22Z,"@luke-jr I tend to agree there, but that's a policy change that should be addressed by something like #5231 after public discussion.\n\nThis PR is a bug fix for the unintentional effect of making some formerly standard transactions nonacceptable. That's not something that should happen without discussion. Furthermore, this does not make anything worse: the spam you were trying to prevent in #7081 ",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233495014,233495014,
luke-jr,2016-07-19T00:12:13Z,"#5231 is a policy change, sure, but I'm not talking about blocking that spam. bytespersigop (as it stands today, and also when fixed by #8364) blocks a different category of spam.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233496040,233496040,
sipa,2016-07-19T00:13:30Z,"#7081 and #8364 do not block any spam. They just force attackers to also bloat the size of the transactions to bypass the check, and pay a higher fee.\n\nThis PR lets them still pay the higher fee, but removes the need to bloat.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233496206,233496206,
luke-jr,2016-07-19T00:28:19Z,"They don't force attackers to do anything. They block the spam, which may lead attackers to consider bloating the size, waiting for (or running) a miner that doesn't have such a policy, or perhaps just not attacking. Just asking for a higher fee sends the message that it's acceptable behaviour and should be expected to be reliable.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233498369,233498369,
sipa,2016-07-19T00:30:18Z,"@luke-jr With #8364 they don't even need to pay a higher fee. Use 1-of-1 multisig, and you get a factor 20 reduction in fee.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233498646,233498646,
luke-jr,2016-07-19T00:45:59Z,"@sipa #8364 fixes a bug. Nothing more. Like I said, I'm happy to have this concept merged _in addition_ to the (fixed) existing behaviour.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233500779,233500779,
sipa,2016-07-19T00:53:11Z,"Oh, you mean reject based on accurate sigoos, but charge based on consensus sigops? That sounds fine, but I think the extra filtering compared to just this PR remains easily bypassable, so I don't like the extra complexity.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233501725,233501725,
dexX7,2016-07-19T09:17:57Z,"> They just force attackers to also bloat the size of the transactions to bypass the check.\n\nWhile I don't consider them as attacker, counterparty-lib and omnicore both create bare-multisig transactions in some rare cases, and as temorary fix to get around the limit introduced by #7081, transactions are indeed bloated.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233576273,233576273,
sipa,2016-07-19T10:35:17Z,Rebased.\n\nI think we should include this (with or without #8364) to get #8079 fixed in 0.13.\n,https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233594016,233594016,
sdaftuar,2016-07-19T11:00:46Z,"Concept ack new approach, will review and test later today.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233599148,233599148,
sdaftuar,2016-07-19T15:48:02Z,"One nit, apart from the one I left already: I think it would be nice if in AcceptToMemoryPoolWorker, we had a debugging print to indicate when a transaction was being processed using a higher effective size, as sigops are not something we always have a record of when debugging.\n\nCode review ACK apart from those two nits, will test.\n\nOne thing I noticed is that if we were to increase the bytesP",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233676294,233676294,
luke-jr,2016-07-19T17:56:27Z,"#8364 fixes #8079, and should be included in 0.13. The current code here merely removes bytespersigop and replaces it with something entirely different. I don't care if the new miner policy code concept here is added to 0.13 or not, but it's not related to #8079 IMO.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233714059,233714059,
sipa,2016-07-19T18:03:45Z,"#8364 technically fixes the problem, but introduces an actually exploitable\nbug for miners and the network (cheap attack that results in low-fee\nnearly-empty blocks). It should not be included on its own.\n\nCombined with this PR that problem disappears, but I don't see the\nadvantage over just this PR (which also fixes the bug, and in addition does\nnot incentivize bloating transactions to bypa",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233716170,233716170,
sdaftuar,2016-07-19T18:25:06Z,"Tested ACK.\n\nI agree with @sipa -- there is no need for #8364, we should merge this instead.  If users are bloating their transactions to get around a policy limit, we should take that as a sign that the policy limit is poorly designed.\n\nAfter this is merged, we should document in the release notes the changed policy as well as the changed RPC output (the raw transaction rpc's are returning an",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233722419,233722419,
luke-jr,2016-07-19T19:44:24Z,"@sdaftuar Please understand the issues before taking a position. The bloating is in response to the OP_RETURN limit, which is entirely unrelated to either this or bytespersigop. @sipa is speculating that _attackers_ (not users) might bloat abusive transactions to get around the anti-spam limit of bytespersigop.\n\nbytespersigop is a spam filter. This PR is an economic fee rate adjustment. Two enti",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233743884,233743884,
sdaftuar,2016-07-19T19:58:44Z,"> and as temorary fix to get around the limit introduced by #7081, transactions are indeed bloated.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233747646,233747646,
dexX7,2016-07-19T20:18:47Z,"> The bloating is in response to the OP_RETURN limit, which is entirely unrelated to either this or bytespersigop.\n\nActually, while counterparty-lib and omnicore use bare-multisig scripts to transport data that doesn't fit into OP_RETURN scripts, both projects started to bloat transactions to get around the sigops limit, so the bloating is indeed the response to #7081. And just FYI: Counterparty",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233752962,233752962,
luke-jr,2016-07-19T20:34:53Z,"That's not multisig, it's data abusively encoded as multisig. For Bitcoin to have any chance of succeeding, it must be stopped, not accommodated.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233757232,233757232,
f139975,2016-07-19T22:11:24Z,"ACK ab942c15bd3854650afa810d7c22d7fd30d346c1\n\nThis is a very clever solution. Will close #8364, once this one is merged.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233782299,233782299,
wizkid057,2016-07-19T23:43:33Z,"I'm against any sort of spam in reaching the blockchain.  As a miner and a pool operator I have to object to mining anything that could encourage attackers or spammers in any way.  This behavior appears to encourage spammers and has the appearance of condoning their behavior.  While I agree that some tweaking could be done to allow more legitimate transactions with more sigops through normally, re",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233799314,233799314,
dexX7,2016-07-20T00:03:19Z,"If you want to discourage the use of bare-multisig, then please start the process to revive #5231, which was closed back then due to it's controversy. Seemingly neither the submitter of #7081, nor it's reviewers, were aware of the side effect #8079. Arguing against this pull request, or #8364, based on the opinion that the side effect is actually nice to have seems wrong to me, as this just shows ",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233802397,233802397,
luke-jr,2016-07-20T00:24:29Z,@dexX7 You are the only one here I see talking about bare multisig.\n,https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233805498,233805498,
luke-jr,2016-07-20T00:32:25Z,"To help clarify things, the four different topics:\n- OP_RETURN data carrier: debatably-legit use cases exist (Counterparty); currently limited to 80 bytes per tx, allegedly ""forcing"" some ""use cases"" to resort to abusing bare multisig\n- bare multisig: legit use cases exist, no known legit use in practice (?), often abused for spam and attacks (policy filtered by default in #5231)\n- bare multisi",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233806638,233806638,
petertodd,2016-07-20T02:42:10Z,Concept ACK\n,https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-233823692,233823692,
morcos,2016-07-20T20:20:10Z,"Concept ACK.  \nI actually think we should make the ""policy change"" of changing this back to 50 bytes per sigop and removing the option entirely.  It's not really about getting your transaction relayed but about having miners construct more optimal blocks.  It seems silly to me to have the mining code be purposefully less good just because users aren't expecting miners to have more intelligent alg",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-234069562,234069562,
morcos,2016-07-21T14:56:31Z,"@sdaftuar points out to me that under normal conditions, you will mine more optimal blocks with 20 bytes per sig op (or even no limit) than with 50.  So I withdraw my recommendation to change it 50, I think leaving it at 20 and making it configurable (as in this pull) is ideal.\n",https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-234279888,234279888,
jtimon,2016-07-23T13:35:59Z,fast review ack\n,https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-234718544,234718544,
dcousens,2016-07-23T15:49:26Z,concept && utACK ab942c1\n,https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-234725109,234725109,
MarcoFalke,2016-10-03T08:52:23Z,This was backported in #8438\n,https://github.com/bitcoin/bitcoin/pull/8365#issuecomment-251056628,251056628,
sdaftuar,2016-07-18T20:50:39Z,"Rather than lose the caching of the cost, how about we just change GetTxSize() to return the max of these two quantities?  This way we have access to the actual cost so we can write smarter code in the future, while I believe GetTxSize() is already used everywhere (but we should confirm) for feerate calculations, included size/feerate of ancestors and descendants, both in the mempool and in the mi",https://github.com/bitcoin/bitcoin/pull/8365#discussion_r71226700,71226700,src/txmempool.cpp
sdaftuar,2016-07-19T15:38:31Z,"nit: Could you add a comment to these functions, indicating the role of sigops here?\n",https://github.com/bitcoin/bitcoin/pull/8365#discussion_r71364090,71364090,src/policy/policy.h
