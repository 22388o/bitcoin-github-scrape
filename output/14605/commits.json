[
  {
    "sha": "7cc2b9f6786f9bc33853220551eed33ca6b7b7b2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3Y2MyYjlmNjc4NmY5YmMzMzg1MzIyMDU1MWVlZDMzY2E2YjdiN2Iy",
    "commit": {
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-10-04T22:25:34Z"
      },
      "committer": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2019-01-16T16:04:05Z"
      },
      "message": "net: Break disconnecting out of Ban()\n\nThese are separate events which need to be carried out by separate subsystems.\n\nThis also cleans up some whitespace and tabs in qt to avoid getting flagged by\nthe linter.\n\nCurrent behavior is preserved.",
      "tree": {
        "sha": "93ed4cf7b37c8994fefc4fb31eac75acea9f7329",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/93ed4cf7b37c8994fefc4fb31eac75acea9f7329"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/comments",
    "author": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f71c2ea6620a262dd97ba01bdd3dfb3e619cb8cb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f71c2ea6620a262dd97ba01bdd3dfb3e619cb8cb",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f71c2ea6620a262dd97ba01bdd3dfb3e619cb8cb"
      }
    ],
    "stats": {
      "total": 80,
      "additions": 55,
      "deletions": 25
    },
    "files": [
      {
        "sha": "09460ec43ec8d2a3f7c6178ccd7b701cfb9293b8",
        "filename": "src/interfaces/node.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 0,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/interfaces/node.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/interfaces/node.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/interfaces/node.cpp?ref=7cc2b9f6786f9bc33853220551eed33ca6b7b7b2",
        "patch": "@@ -144,6 +144,13 @@ class NodeImpl : public Node\n         }\n         return false;\n     }\n+    bool disconnect(const CNetAddr& net_addr) override\n+    {\n+        if (g_connman) {\n+            return g_connman->DisconnectNode(net_addr);\n+        }\n+        return false;\n+    }\n     bool disconnect(NodeId id) override\n     {\n         if (g_connman) {"
      },
      {
        "sha": "6aa8ce0797f4c81c12f966df05211876e62c8454",
        "filename": "src/interfaces/node.h",
        "status": "modified",
        "additions": 4,
        "deletions": 1,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/interfaces/node.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/interfaces/node.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/interfaces/node.h?ref=7cc2b9f6786f9bc33853220551eed33ca6b7b7b2",
        "patch": "@@ -113,7 +113,10 @@ class Node\n     //! Unban node.\n     virtual bool unban(const CSubNet& ip) = 0;\n \n-    //! Disconnect node.\n+    //! Disconnect node by address.\n+    virtual bool disconnect(const CNetAddr& net_addr) = 0;\n+\n+    //! Disconnect node by id.\n     virtual bool disconnect(NodeId id) = 0;\n \n     //! Get total bytes recv."
      },
      {
        "sha": "6f0d76ccf5d01f1fd929ee73e0dba93fcd8c48b1",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 19,
        "deletions": 7,
        "changes": 26,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=7cc2b9f6786f9bc33853220551eed33ca6b7b7b2",
        "patch": "@@ -554,13 +554,6 @@ void CConnman::Ban(const CSubNet& subNet, const BanReason &banReason, int64_t ba\n     }\n     if(clientInterface)\n         clientInterface->BannedListChanged();\n-    {\n-        LOCK(cs_vNodes);\n-        for (CNode* pnode : vNodes) {\n-            if (subNet.Match(static_cast<CNetAddr>(pnode->addr)))\n-                pnode->fDisconnect = true;\n-        }\n-    }\n     if(banReason == BanReasonManuallyAdded)\n         DumpBanlist(); //store banlist to disk immediately if user requested ban\n }\n@@ -2643,6 +2636,25 @@ bool CConnman::DisconnectNode(const std::string& strNode)\n     }\n     return false;\n }\n+\n+bool CConnman::DisconnectNode(const CSubNet& subnet)\n+{\n+    bool disconnected = false;\n+    LOCK(cs_vNodes);\n+    for (CNode* pnode : vNodes) {\n+        if (subnet.Match(pnode->addr)) {\n+            pnode->fDisconnect = true;\n+            disconnected = true;\n+        }\n+    }\n+    return disconnected;\n+}\n+\n+bool CConnman::DisconnectNode(const CNetAddr& addr)\n+{\n+    return DisconnectNode(CSubNet(addr));\n+}\n+\n bool CConnman::DisconnectNode(NodeId id)\n {\n     LOCK(cs_vNodes);"
      },
      {
        "sha": "c13af50ec44b2b1c4f4b62b44050d575c0296658",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=7cc2b9f6786f9bc33853220551eed33ca6b7b7b2",
        "patch": "@@ -282,6 +282,8 @@ class CConnman\n     size_t GetNodeCount(NumConnections num);\n     void GetNodeStats(std::vector<CNodeStats>& vstats);\n     bool DisconnectNode(const std::string& node);\n+    bool DisconnectNode(const CSubNet& subnet);\n+    bool DisconnectNode(const CNetAddr& addr);\n     bool DisconnectNode(NodeId id);\n \n     ServiceFlags GetLocalServices() const;"
      },
      {
        "sha": "56cd52ed21a042a9eb15b2c915aff6658706bdfa",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 7,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=7cc2b9f6786f9bc33853220551eed33ca6b7b7b2",
        "patch": "@@ -2961,14 +2961,14 @@ static bool SendRejectsAndCheckIfBanned(CNode* pnode, CConnman* connman, bool en\n             LogPrintf(\"Warning: not punishing whitelisted peer %s!\\n\", pnode->addr.ToString());\n         else if (pnode->m_manual_connection)\n             LogPrintf(\"Warning: not punishing manually-connected peer %s!\\n\", pnode->addr.ToString());\n-        else {\n+        else if (pnode->addr.IsLocal()) {\n+            // Disconnect but don't ban _this_ local node\n+            LogPrintf(\"Warning: disconnecting but not banning local peer %s!\\n\", pnode->addr.ToString());\n             pnode->fDisconnect = true;\n-            if (pnode->addr.IsLocal())\n-                LogPrintf(\"Warning: not banning local peer %s!\\n\", pnode->addr.ToString());\n-            else\n-            {\n-                connman->Ban(pnode->addr, BanReasonNodeMisbehaving);\n-            }\n+        } else {\n+            // Disconnect and ban all nodes sharing the address\n+            connman->Ban(pnode->addr, BanReasonNodeMisbehaving);\n+            connman->DisconnectNode(pnode->addr);\n         }\n         return true;\n     }"
      },
      {
        "sha": "2989e1e9e557bd7013722d6b6fcdd4f830594951",
        "filename": "src/qt/rpcconsole.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 9,
        "changes": 18,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/qt/rpcconsole.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/qt/rpcconsole.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/rpcconsole.cpp?ref=7cc2b9f6786f9bc33853220551eed33ca6b7b7b2",
        "patch": "@@ -1216,16 +1216,16 @@ void RPCConsole::banSelectedNode(int bantime)\n         // Get currently selected peer address\n         NodeId id = nodes.at(i).data().toLongLong();\n \n-\t// Get currently selected peer address\n-\tint detailNodeRow = clientModel->getPeerTableModel()->getRowByNodeId(id);\n-\tif(detailNodeRow < 0)\n-\t    return;\n-\n-\t// Find possible nodes, ban it and clear the selected node\n-\tconst CNodeCombinedStats *stats = clientModel->getPeerTableModel()->getNodeStats(detailNodeRow);\n-\tif(stats) {\n+        // Get currently selected peer address\n+        int detailNodeRow = clientModel->getPeerTableModel()->getRowByNodeId(id);\n+        if (detailNodeRow < 0) return;\n+\n+        // Find possible nodes, ban it and clear the selected node\n+        const CNodeCombinedStats *stats = clientModel->getPeerTableModel()->getNodeStats(detailNodeRow);\n+        if (stats) {\n             m_node.ban(stats->nodeStats.addr, BanReasonManuallyAdded, bantime);\n-\t}\n+            m_node.disconnect(stats->nodeStats.addr);\n+        }\n     }\n     clearSelectedNode();\n     clientModel->getBanTableModel()->refresh();"
      },
      {
        "sha": "59bc8e809182d3c8c719cf3e52368dbff9daecc4",
        "filename": "src/rpc/net.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 1,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/rpc/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2/src/rpc/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/net.cpp?ref=7cc2b9f6786f9bc33853220551eed33ca6b7b7b2",
        "patch": "@@ -565,7 +565,13 @@ static UniValue setban(const JSONRPCRequest& request)\n         if (request.params[3].isTrue())\n             absolute = true;\n \n-        isSubnet ? g_connman->Ban(subNet, BanReasonManuallyAdded, banTime, absolute) : g_connman->Ban(netAddr, BanReasonManuallyAdded, banTime, absolute);\n+        if (isSubnet) {\n+            g_connman->Ban(subNet, BanReasonManuallyAdded, banTime, absolute);\n+            g_connman->DisconnectNode(subNet);\n+        } else {\n+            g_connman->Ban(netAddr, BanReasonManuallyAdded, banTime, absolute);\n+            g_connman->DisconnectNode(netAddr);\n+        }\n     }\n     else if(strCommand == \"remove\")\n     {"
      }
    ]
  },
  {
    "sha": "136bd7926c72659dd277a7b795ea17f72e523338",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxMzZiZDc5MjZjNzI2NTlkZDI3N2E3Yjc5NWVhMTdmNzJlNTIzMzM4",
    "commit": {
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-10-05T15:52:50Z"
      },
      "committer": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2019-01-16T16:04:14Z"
      },
      "message": "tests: remove member connman/peerLogic in TestingSetup",
      "tree": {
        "sha": "9387c6863e6b07a8c8883187b001f7e473cd97bc",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9387c6863e6b07a8c8883187b001f7e473cd97bc"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/136bd7926c72659dd277a7b795ea17f72e523338",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/136bd7926c72659dd277a7b795ea17f72e523338",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/136bd7926c72659dd277a7b795ea17f72e523338",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/136bd7926c72659dd277a7b795ea17f72e523338/comments",
    "author": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "7cc2b9f6786f9bc33853220551eed33ca6b7b7b2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/7cc2b9f6786f9bc33853220551eed33ca6b7b7b2"
      }
    ],
    "stats": {
      "total": 62,
      "additions": 33,
      "deletions": 29
    },
    "files": [
      {
        "sha": "911ba5d9aad47e2faf40d5df9a4778c897dbfe1f",
        "filename": "src/test/denialofservice_tests.cpp",
        "status": "modified",
        "additions": 33,
        "deletions": 5,
        "changes": 38,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/136bd7926c72659dd277a7b795ea17f72e523338/src/test/denialofservice_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/136bd7926c72659dd277a7b795ea17f72e523338/src/test/denialofservice_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/denialofservice_tests.cpp?ref=136bd7926c72659dd277a7b795ea17f72e523338",
        "patch": "@@ -20,6 +20,23 @@\n \n #include <boost/test/unit_test.hpp>\n \n+struct CConnmanTest : public CConnman {\n+    using CConnman::CConnman;\n+    void AddNode(CNode& node)\n+    {\n+        LOCK(cs_vNodes);\n+        vNodes.push_back(&node);\n+    }\n+    void ClearNodes()\n+    {\n+        LOCK(cs_vNodes);\n+        for (CNode* node : vNodes) {\n+            delete node;\n+        }\n+        vNodes.clear();\n+    }\n+};\n+\n // Tests these internal-to-net_processing.cpp methods:\n extern bool AddOrphanTx(const CTransactionRef& tx, NodeId peer);\n extern void EraseOrphansFor(NodeId peer);\n@@ -57,6 +74,8 @@ BOOST_FIXTURE_TEST_SUITE(denialofservice_tests, TestingSetup)\n // work.\n BOOST_AUTO_TEST_CASE(outbound_slow_chain_eviction)\n {\n+    auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n+    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), scheduler, false);\n \n     // Mock an outbound peer\n     CAddress addr1(ip(0xa0b0c001), NODE_NONE);\n@@ -109,7 +128,7 @@ BOOST_AUTO_TEST_CASE(outbound_slow_chain_eviction)\n     peerLogic->FinalizeNode(dummyNode1.GetId(), dummy);\n }\n \n-static void AddRandomOutboundPeer(std::vector<CNode *> &vNodes, PeerLogicValidation &peerLogic)\n+static void AddRandomOutboundPeer(std::vector<CNode *> &vNodes, PeerLogicValidation &peerLogic, CConnmanTest* connman)\n {\n     CAddress addr(ip(g_insecure_rand_ctx.randbits(32)), NODE_NONE);\n     vNodes.emplace_back(new CNode(id++, ServiceFlags(NODE_NETWORK|NODE_WITNESS), 0, INVALID_SOCKET, addr, 0, 0, CAddress(), \"\", /*fInboundIn=*/ false));\n@@ -120,11 +139,14 @@ static void AddRandomOutboundPeer(std::vector<CNode *> &vNodes, PeerLogicValidat\n     node.nVersion = 1;\n     node.fSuccessfullyConnected = true;\n \n-    CConnmanTest::AddNode(node);\n+    connman->AddNode(node);\n }\n \n BOOST_AUTO_TEST_CASE(stale_tip_peer_management)\n {\n+    auto connman = MakeUnique<CConnmanTest>(0x1337, 0x1337);\n+    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), scheduler, false);\n+\n     const Consensus::Params& consensusParams = Params().GetConsensus();\n     constexpr int nMaxOutbound = 8;\n     CConnman::Options options;\n@@ -137,7 +159,7 @@ BOOST_AUTO_TEST_CASE(stale_tip_peer_management)\n \n     // Mock some outbound peers\n     for (int i=0; i<nMaxOutbound; ++i) {\n-        AddRandomOutboundPeer(vNodes, *peerLogic);\n+        AddRandomOutboundPeer(vNodes, *peerLogic, connman.get());\n     }\n \n     peerLogic->CheckForStaleTipAndEvictPeers(consensusParams);\n@@ -162,7 +184,7 @@ BOOST_AUTO_TEST_CASE(stale_tip_peer_management)\n     // If we add one more peer, something should get marked for eviction\n     // on the next check (since we're mocking the time to be in the future, the\n     // required time connected check should be satisfied).\n-    AddRandomOutboundPeer(vNodes, *peerLogic);\n+    AddRandomOutboundPeer(vNodes, *peerLogic, connman.get());\n \n     peerLogic->CheckForStaleTipAndEvictPeers(consensusParams);\n     for (int i=0; i<nMaxOutbound; ++i) {\n@@ -189,11 +211,13 @@ BOOST_AUTO_TEST_CASE(stale_tip_peer_management)\n         peerLogic->FinalizeNode(node->GetId(), dummy);\n     }\n \n-    CConnmanTest::ClearNodes();\n+    connman->ClearNodes();\n }\n \n BOOST_AUTO_TEST_CASE(DoS_banning)\n {\n+    auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n+    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), scheduler, false);\n \n     connman->ClearBanned();\n     CAddress addr1(ip(0xa0b0c001), NODE_NONE);\n@@ -246,6 +270,8 @@ BOOST_AUTO_TEST_CASE(DoS_banning)\n \n BOOST_AUTO_TEST_CASE(DoS_banscore)\n {\n+    auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n+    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), scheduler, false);\n \n     connman->ClearBanned();\n     gArgs.ForceSetArg(\"-banscore\", \"111\"); // because 11 is my favorite number\n@@ -290,6 +316,8 @@ BOOST_AUTO_TEST_CASE(DoS_banscore)\n \n BOOST_AUTO_TEST_CASE(DoS_bantime)\n {\n+    auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n+    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), scheduler, false);\n \n     connman->ClearBanned();\n     int64_t nStartTime = GetTime();"
      },
      {
        "sha": "a988a58111287472556d110661f76ff603450bb8",
        "filename": "src/test/test_bitcoin.cpp",
        "status": "modified",
        "additions": 0,
        "deletions": 18,
        "changes": 18,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/136bd7926c72659dd277a7b795ea17f72e523338/src/test/test_bitcoin.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/136bd7926c72659dd277a7b795ea17f72e523338/src/test/test_bitcoin.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/test_bitcoin.cpp?ref=136bd7926c72659dd277a7b795ea17f72e523338",
        "patch": "@@ -24,21 +24,6 @@ const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n \n FastRandomContext g_insecure_rand_ctx;\n \n-void CConnmanTest::AddNode(CNode& node)\n-{\n-    LOCK(g_connman->cs_vNodes);\n-    g_connman->vNodes.push_back(&node);\n-}\n-\n-void CConnmanTest::ClearNodes()\n-{\n-    LOCK(g_connman->cs_vNodes);\n-    for (const CNode* node : g_connman->vNodes) {\n-        delete node;\n-    }\n-    g_connman->vNodes.clear();\n-}\n-\n std::ostream& operator<<(std::ostream& os, const uint256& num)\n {\n     os << num.ToString();\n@@ -109,8 +94,6 @@ TestingSetup::TestingSetup(const std::string& chainName) : BasicTestingSetup(cha\n         for (int i=0; i < nScriptCheckThreads-1; i++)\n             threadGroup.create_thread(&ThreadScriptCheck);\n         g_connman = MakeUnique<CConnman>(0x1337, 0x1337); // Deterministic randomness for tests.\n-        connman = g_connman.get();\n-        peerLogic.reset(new PeerLogicValidation(connman, scheduler, /*enable_bip61=*/true));\n }\n \n TestingSetup::~TestingSetup()\n@@ -120,7 +103,6 @@ TestingSetup::~TestingSetup()\n     GetMainSignals().FlushBackgroundCallbacks();\n     GetMainSignals().UnregisterBackgroundSignalScheduler();\n     g_connman.reset();\n-    peerLogic.reset();\n     UnloadBlockIndex();\n     pcoinsTip.reset();\n     pcoinsdbview.reset();"
      },
      {
        "sha": "71520232ac6f203fb7701f1c3eb35b9c560ec6ac",
        "filename": "src/test/test_bitcoin.h",
        "status": "modified",
        "additions": 0,
        "deletions": 6,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/136bd7926c72659dd277a7b795ea17f72e523338/src/test/test_bitcoin.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/136bd7926c72659dd277a7b795ea17f72e523338/src/test/test_bitcoin.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/test_bitcoin.h?ref=136bd7926c72659dd277a7b795ea17f72e523338",
        "patch": "@@ -68,17 +68,11 @@ struct BasicTestingSetup {\n  */\n class CConnman;\n class CNode;\n-struct CConnmanTest {\n-    static void AddNode(CNode& node);\n-    static void ClearNodes();\n-};\n \n class PeerLogicValidation;\n struct TestingSetup : public BasicTestingSetup {\n     boost::thread_group threadGroup;\n-    CConnman* connman;\n     CScheduler scheduler;\n-    std::unique_ptr<PeerLogicValidation> peerLogic;\n \n     explicit TestingSetup(const std::string& chainName = CBaseChainParams::MAIN);\n     ~TestingSetup();"
      }
    ]
  },
  {
    "sha": "83c1ea2e5e66b8a83072e3d5ad6a4ced406eb1ba",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4M2MxZWEyZTVlNjZiOGE4MzA3MmUzZDVhZDZhNGNlZDQwNmViMWJh",
    "commit": {
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-10-05T16:46:54Z"
      },
      "committer": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2019-01-16T18:54:18Z"
      },
      "message": "net: split up addresses/ban dumps in preparation for moving them",
      "tree": {
        "sha": "97bb5ccc517aa543e278be31a6fb1254efce63cd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/97bb5ccc517aa543e278be31a6fb1254efce63cd"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/83c1ea2e5e66b8a83072e3d5ad6a4ced406eb1ba",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/83c1ea2e5e66b8a83072e3d5ad6a4ced406eb1ba",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/83c1ea2e5e66b8a83072e3d5ad6a4ced406eb1ba",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/83c1ea2e5e66b8a83072e3d5ad6a4ced406eb1ba/comments",
    "author": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "136bd7926c72659dd277a7b795ea17f72e523338",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/136bd7926c72659dd277a7b795ea17f72e523338",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/136bd7926c72659dd277a7b795ea17f72e523338"
      }
    ],
    "stats": {
      "total": 19,
      "additions": 9,
      "deletions": 10
    },
    "files": [
      {
        "sha": "993efc3db960bbb756be74d6ed96538cbbabced9",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 10,
        "changes": 19,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/83c1ea2e5e66b8a83072e3d5ad6a4ced406eb1ba/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/83c1ea2e5e66b8a83072e3d5ad6a4ced406eb1ba/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=83c1ea2e5e66b8a83072e3d5ad6a4ced406eb1ba",
        "patch": "@@ -41,8 +41,11 @@\n \n #include <math.h>\n \n-// Dump addresses to peers.dat and banlist.dat every 15 minutes (900s)\n-#define DUMP_ADDRESSES_INTERVAL 900\n+// Dump addresses to peers.dat every 15 minutes (900s)\n+static constexpr int DUMP_PEERS_INTERVAL = 15 * 60;\n+\n+// Dump addresses to banlist.dat every 15 minutes (900s)\n+static constexpr int DUMP_BANS_INTERVAL = 60 * 15;\n \n // We add a random period time (0 to 1 seconds) to feeler connections to prevent synchronization.\n #define FEELER_SLEEP_WINDOW 1\n@@ -1768,12 +1771,6 @@ void CConnman::DumpAddresses()\n            addrman.size(), GetTimeMillis() - nStart);\n }\n \n-void CConnman::DumpData()\n-{\n-    DumpAddresses();\n-    DumpBanlist();\n-}\n-\n void CConnman::ProcessOneShot()\n {\n     std::string strDest;\n@@ -2450,7 +2447,8 @@ bool CConnman::Start(CScheduler& scheduler, const Options& connOptions)\n     threadMessageHandler = std::thread(&TraceThread<std::function<void()> >, \"msghand\", std::function<void()>(std::bind(&CConnman::ThreadMessageHandler, this)));\n \n     // Dump network addresses\n-    scheduler.scheduleEvery(std::bind(&CConnman::DumpData, this), DUMP_ADDRESSES_INTERVAL * 1000);\n+    scheduler.scheduleEvery(std::bind(&CConnman::DumpAddresses, this), DUMP_PEERS_INTERVAL * 1000);\n+    scheduler.scheduleEvery(std::bind(&CConnman::DumpBanlist, this), DUMP_BANS_INTERVAL * 1000);\n \n     return true;\n }\n@@ -2509,7 +2507,8 @@ void CConnman::Stop()\n \n     if (fAddressesInitialized)\n     {\n-        DumpData();\n+        DumpAddresses();\n+        DumpBanlist();\n         fAddressesInitialized = false;\n     }\n "
      }
    ]
  },
  {
    "sha": "4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0YzBkOTYxZWIwZDc4MjVhMWU2ZjgzODlkN2Y1NTQ1MTE0ZWUxOGM2",
    "commit": {
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-10-05T17:10:58Z"
      },
      "committer": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2019-01-16T18:54:18Z"
      },
      "message": "banman: create and split out banman\n\nSome say he has always been.",
      "tree": {
        "sha": "9d5058c91632293540636bb540818539b216676f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9d5058c91632293540636bb540818539b216676f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/comments",
    "author": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "83c1ea2e5e66b8a83072e3d5ad6a4ced406eb1ba",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/83c1ea2e5e66b8a83072e3d5ad6a4ced406eb1ba",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/83c1ea2e5e66b8a83072e3d5ad6a4ced406eb1ba"
      }
    ],
    "stats": {
      "total": 297,
      "additions": 172,
      "deletions": 125
    },
    "files": [
      {
        "sha": "86b39c34eaecf545f495d517686a347c96bb177c",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 14,
        "deletions": 3,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
        "patch": "@@ -73,8 +73,12 @@ static const bool DEFAULT_PROXYRANDOMIZE = true;\n static const bool DEFAULT_REST_ENABLE = false;\n static const bool DEFAULT_STOPAFTERBLOCKIMPORT = false;\n \n+// Dump addresses to banlist.dat every 15 minutes (900s)\n+static constexpr int DUMP_BANS_INTERVAL = 60 * 15;\n+\n std::unique_ptr<CConnman> g_connman;\n std::unique_ptr<PeerLogicValidation> peerLogic;\n+std::unique_ptr<BanMan> g_banman;\n \n #ifdef WIN32\n // Win32 LevelDB doesn't use filedescriptors, and the ones used for\n@@ -199,6 +203,7 @@ void Shutdown(InitInterfaces& interfaces)\n     // destruct and reset all to nullptr.\n     peerLogic.reset();\n     g_connman.reset();\n+    g_banman.reset();\n     g_txindex.reset();\n \n     if (g_is_mempool_loaded && gArgs.GetArg(\"-persistmempool\", DEFAULT_PERSIST_MEMPOOL)) {\n@@ -1290,11 +1295,12 @@ bool AppInitMain(InitInterfaces& interfaces)\n     // is not yet setup and may end up being set up twice if we\n     // need to reindex later.\n \n+    assert(!g_banman);\n+    g_banman = MakeUnique<BanMan>(&uiInterface);\n     assert(!g_connman);\n     g_connman = std::unique_ptr<CConnman>(new CConnman(GetRand(std::numeric_limits<uint64_t>::max()), GetRand(std::numeric_limits<uint64_t>::max())));\n-    CConnman& connman = *g_connman;\n \n-    peerLogic.reset(new PeerLogicValidation(&connman, scheduler, gArgs.GetBoolArg(\"-enablebip61\", DEFAULT_ENABLE_BIP61)));\n+    peerLogic.reset(new PeerLogicValidation(g_connman.get(), g_banman.get(), scheduler, gArgs.GetBoolArg(\"-enablebip61\", DEFAULT_ENABLE_BIP61)));\n     RegisterValidationInterface(peerLogic.get());\n \n     // sanitize comments per BIP-0014, format user agent and check total size\n@@ -1704,6 +1710,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n     connOptions.nMaxFeeler = 1;\n     connOptions.nBestHeight = chain_active_height;\n     connOptions.uiInterface = &uiInterface;\n+    connOptions.m_banman = g_banman.get();\n     connOptions.m_msgproc = peerLogic.get();\n     connOptions.nSendBufferMaxSize = 1000*gArgs.GetArg(\"-maxsendbuffer\", DEFAULT_MAXSENDBUFFER);\n     connOptions.nReceiveFloodSize = 1000*gArgs.GetArg(\"-maxreceivebuffer\", DEFAULT_MAXRECEIVEBUFFER);\n@@ -1749,7 +1756,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n             connOptions.m_specified_outgoing = connect;\n         }\n     }\n-    if (!connman.Start(scheduler, connOptions)) {\n+    if (!g_connman->Start(scheduler, connOptions)) {\n         return false;\n     }\n \n@@ -1762,5 +1769,9 @@ bool AppInitMain(InitInterfaces& interfaces)\n         client->start(scheduler);\n     }\n \n+    scheduler.scheduleEvery([]{\n+        g_banman->DumpBanlist();\n+    }, DUMP_BANS_INTERVAL * 1000);\n+\n     return true;\n }"
      },
      {
        "sha": "c535b29315b5f1c128644d0fcf4ae5addb4e6ba6",
        "filename": "src/interfaces/node.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 6,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/interfaces/node.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/interfaces/node.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/interfaces/node.cpp?ref=4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
        "patch": "@@ -122,24 +122,24 @@ class NodeImpl : public Node\n     }\n     bool getBanned(banmap_t& banmap) override\n     {\n-        if (g_connman) {\n-            g_connman->GetBanned(banmap);\n+        if (g_banman) {\n+            g_banman->GetBanned(banmap);\n             return true;\n         }\n         return false;\n     }\n     bool ban(const CNetAddr& net_addr, BanReason reason, int64_t ban_time_offset) override\n     {\n-        if (g_connman) {\n-            g_connman->Ban(net_addr, reason, ban_time_offset);\n+        if (g_banman) {\n+            g_banman->Ban(net_addr, reason, ban_time_offset);\n             return true;\n         }\n         return false;\n     }\n     bool unban(const CSubNet& ip) override\n     {\n-        if (g_connman) {\n-            g_connman->Unban(ip);\n+        if (g_banman) {\n+            g_banman->Unban(ip);\n             return true;\n         }\n         return false;"
      },
      {
        "sha": "5479130320d000f93bc1e73faea8c636302c9941",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 43,
        "deletions": 38,
        "changes": 81,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
        "patch": "@@ -44,9 +44,6 @@\n // Dump addresses to peers.dat every 15 minutes (900s)\n static constexpr int DUMP_PEERS_INTERVAL = 15 * 60;\n \n-// Dump addresses to banlist.dat every 15 minutes (900s)\n-static constexpr int DUMP_BANS_INTERVAL = 60 * 15;\n-\n // We add a random period time (0 to 1 seconds) to feeler connections to prevent synchronization.\n #define FEELER_SLEEP_WINDOW 1\n \n@@ -460,7 +457,7 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n     return pnode;\n }\n \n-void CConnman::DumpBanlist()\n+void BanMan::DumpBanlist()\n {\n     SweepBanned(); // clean unused entries (if bantime has expired)\n \n@@ -491,7 +488,7 @@ void CNode::CloseSocketDisconnect()\n     }\n }\n \n-void CConnman::ClearBanned()\n+void BanMan::ClearBanned()\n {\n     {\n         LOCK(cs_setBanned);\n@@ -503,7 +500,7 @@ void CConnman::ClearBanned()\n         clientInterface->BannedListChanged();\n }\n \n-bool CConnman::IsBanned(CNetAddr ip)\n+bool BanMan::IsBanned(CNetAddr ip)\n {\n     LOCK(cs_setBanned);\n     for (const auto& it : setBanned) {\n@@ -517,7 +514,7 @@ bool CConnman::IsBanned(CNetAddr ip)\n     return false;\n }\n \n-bool CConnman::IsBanned(CSubNet subnet)\n+bool BanMan::IsBanned(CSubNet subnet)\n {\n     LOCK(cs_setBanned);\n     banmap_t::iterator i = setBanned.find(subnet);\n@@ -531,12 +528,12 @@ bool CConnman::IsBanned(CSubNet subnet)\n     return false;\n }\n \n-void CConnman::Ban(const CNetAddr& addr, const BanReason &banReason, int64_t bantimeoffset, bool sinceUnixEpoch) {\n+void BanMan::Ban(const CNetAddr& addr, const BanReason &banReason, int64_t bantimeoffset, bool sinceUnixEpoch) {\n     CSubNet subNet(addr);\n     Ban(subNet, banReason, bantimeoffset, sinceUnixEpoch);\n }\n \n-void CConnman::Ban(const CSubNet& subNet, const BanReason &banReason, int64_t bantimeoffset, bool sinceUnixEpoch) {\n+void BanMan::Ban(const CSubNet& subNet, const BanReason &banReason, int64_t bantimeoffset, bool sinceUnixEpoch) {\n     CBanEntry banEntry(GetTime());\n     banEntry.banReason = banReason;\n     if (bantimeoffset <= 0)\n@@ -561,12 +558,12 @@ void CConnman::Ban(const CSubNet& subNet, const BanReason &banReason, int64_t ba\n         DumpBanlist(); //store banlist to disk immediately if user requested ban\n }\n \n-bool CConnman::Unban(const CNetAddr &addr) {\n+bool BanMan::Unban(const CNetAddr &addr) {\n     CSubNet subNet(addr);\n     return Unban(subNet);\n }\n \n-bool CConnman::Unban(const CSubNet &subNet) {\n+bool BanMan::Unban(const CSubNet &subNet) {\n     {\n         LOCK(cs_setBanned);\n         if (!setBanned.erase(subNet))\n@@ -579,22 +576,22 @@ bool CConnman::Unban(const CSubNet &subNet) {\n     return true;\n }\n \n-void CConnman::GetBanned(banmap_t &banMap)\n+void BanMan::GetBanned(banmap_t &banMap)\n {\n     LOCK(cs_setBanned);\n     // Sweep the banlist so expired bans are not returned\n     SweepBanned();\n     banMap = setBanned; //create a thread safe copy\n }\n \n-void CConnman::SetBanned(const banmap_t &banMap)\n+void BanMan::SetBanned(const banmap_t &banMap)\n {\n     LOCK(cs_setBanned);\n     setBanned = banMap;\n     setBannedIsDirty = true;\n }\n \n-void CConnman::SweepBanned()\n+void BanMan::SweepBanned()\n {\n     int64_t now = GetTime();\n     bool notifyUI = false;\n@@ -622,13 +619,13 @@ void CConnman::SweepBanned()\n     }\n }\n \n-bool CConnman::BannedSetIsDirty()\n+bool BanMan::BannedSetIsDirty()\n {\n     LOCK(cs_setBanned);\n     return setBannedIsDirty;\n }\n \n-void CConnman::SetBannedSetDirty(bool dirty)\n+void BanMan::SetBannedSetDirty(bool dirty)\n {\n     LOCK(cs_setBanned); //reuse setBanned lock for the isDirty flag\n     setBannedIsDirty = dirty;\n@@ -1103,7 +1100,7 @@ void CConnman::AcceptConnection(const ListenSocket& hListenSocket) {\n     // on all platforms.  Set it again here just to be sure.\n     SetSocketNoDelay(hSocket);\n \n-    if (IsBanned(addr) && !whitelisted)\n+    if (m_banman && m_banman->IsBanned(addr) && !whitelisted)\n     {\n         LogPrint(BCLog::NET, \"connection from %s dropped (banned)\\n\", addr.ToString());\n         CloseSocket(hSocket);\n@@ -2075,7 +2072,7 @@ void CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFai\n     }\n     if (!pszDest) {\n         if (IsLocal(addrConnect) ||\n-            FindNode(static_cast<CNetAddr>(addrConnect)) || IsBanned(addrConnect) ||\n+            FindNode(static_cast<CNetAddr>(addrConnect)) || (m_banman && m_banman->IsBanned(addrConnect)) ||\n             FindNode(addrConnect.ToStringIPPort()))\n             return;\n     } else if (FindNode(std::string(pszDest)))\n@@ -2376,24 +2373,6 @@ bool CConnman::Start(CScheduler& scheduler, const Options& connOptions)\n             DumpAddresses();\n         }\n     }\n-    if (clientInterface)\n-        clientInterface->InitMessage(_(\"Loading banlist...\"));\n-    // Load addresses from banlist.dat\n-    nStart = GetTimeMillis();\n-    CBanDB bandb;\n-    banmap_t banmap;\n-    if (bandb.Read(banmap)) {\n-        SetBanned(banmap); // thread save setter\n-        SetBannedSetDirty(false); // no need to write down, just read data\n-        SweepBanned(); // sweep out unused entries\n-\n-        LogPrint(BCLog::NET, \"Loaded %d banned node ips/subnets from banlist.dat  %dms\\n\",\n-            banmap.size(), GetTimeMillis() - nStart);\n-    } else {\n-        LogPrintf(\"Invalid or missing banlist.dat; recreating\\n\");\n-        SetBannedSetDirty(true); // force write\n-        DumpBanlist();\n-    }\n \n     uiInterface.InitMessage(_(\"Starting network threads...\"));\n \n@@ -2448,11 +2427,38 @@ bool CConnman::Start(CScheduler& scheduler, const Options& connOptions)\n \n     // Dump network addresses\n     scheduler.scheduleEvery(std::bind(&CConnman::DumpAddresses, this), DUMP_PEERS_INTERVAL * 1000);\n-    scheduler.scheduleEvery(std::bind(&CConnman::DumpBanlist, this), DUMP_BANS_INTERVAL * 1000);\n \n     return true;\n }\n \n+BanMan::BanMan(CClientUIInterface* client_interface) : clientInterface(client_interface)\n+{\n+    if (clientInterface) clientInterface->InitMessage(_(\"Loading banlist...\"));\n+    // Load addresses from banlist.dat\n+\n+    int64_t nStart = GetTimeMillis();\n+    setBannedIsDirty = false;\n+    CBanDB bandb;\n+    banmap_t banmap;\n+    if (bandb.Read(banmap)) {\n+        SetBanned(banmap); // thread save setter\n+        SetBannedSetDirty(false); // no need to write down, just read data\n+        SweepBanned(); // sweep out unused entries\n+\n+        LogPrint(BCLog::NET, \"Loaded %d banned node ips/subnets from banlist.dat  %dms\\n\",\n+            banmap.size(), GetTimeMillis() - nStart);\n+    } else {\n+        LogPrintf(\"Invalid or missing banlist.dat; recreating\\n\");\n+        SetBannedSetDirty(true); // force write\n+        DumpBanlist();\n+    }\n+}\n+\n+BanMan::~BanMan()\n+{\n+    DumpBanlist();\n+}\n+\n class CNetCleanup\n {\n public:\n@@ -2508,7 +2514,6 @@ void CConnman::Stop()\n     if (fAddressesInitialized)\n     {\n         DumpAddresses();\n-        DumpBanlist();\n         fAddressesInitialized = false;\n     }\n "
      },
      {
        "sha": "020e600b2cc5fde6853c9ef657924314d5a2862c",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 49,
        "deletions": 36,
        "changes": 85,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
        "patch": "@@ -86,7 +86,7 @@ static const size_t DEFAULT_MAXRECEIVEBUFFER = 5 * 1000;\n static const size_t DEFAULT_MAXSENDBUFFER    = 1 * 1000;\n \n // NOTE: When adjusting this, update rpcnet:setban's help (\"24h\")\n-static const unsigned int DEFAULT_MISBEHAVING_BANTIME = 60 * 60 * 24;  // Default 24-hour ban\n+static constexpr unsigned int DEFAULT_MISBEHAVING_BANTIME = 60 * 60 * 24;  // Default 24-hour ban\n \n typedef int64_t NodeId;\n \n@@ -114,6 +114,50 @@ struct CSerializedNetMsg\n     std::string command;\n };\n \n+\n+class BanMan\n+{\n+public:\n+    // Denial-of-service detection/prevention\n+    // The idea is to detect peers that are behaving\n+    // badly and disconnect/ban them, but do it in a\n+    // one-coding-mistake-won't-shatter-the-entire-network\n+    // way.\n+    // IMPORTANT:  There should be nothing I can give a\n+    // node that it will forward on that will make that\n+    // node's peers drop it. If there is, an attacker\n+    // can isolate a node and/or try to split the network.\n+    // Dropping a node for sending stuff that is invalid\n+    // now but might be valid in a later version is also\n+    // dangerous, because it can cause a network split\n+    // between nodes running old code and nodes running\n+    // new code.\n+    ~BanMan();\n+    BanMan(CClientUIInterface* client_interface);\n+    void Ban(const CNetAddr& netAddr, const BanReason& reason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n+    void Ban(const CSubNet& subNet, const BanReason& reason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n+    void ClearBanned(); // needed for unit testing\n+    bool IsBanned(CNetAddr ip);\n+    bool IsBanned(CSubNet subnet);\n+    bool Unban(const CNetAddr &ip);\n+    bool Unban(const CSubNet &ip);\n+    void GetBanned(banmap_t &banmap);\n+    void DumpBanlist();\n+\n+private:\n+    void SetBanned(const banmap_t &banmap);\n+    bool BannedSetIsDirty();\n+    //!set the \"dirty\" flag for the banlist\n+    void SetBannedSetDirty(bool dirty=true);\n+    //!clean unused entries (if bantime has expired)\n+    void SweepBanned();\n+\n+    banmap_t setBanned;\n+    CCriticalSection cs_setBanned;\n+    bool setBannedIsDirty;\n+    CClientUIInterface* clientInterface = nullptr;\n+};\n+\n class NetEventsInterface;\n class CConnman\n {\n@@ -136,6 +180,7 @@ class CConnman\n         int nBestHeight = 0;\n         CClientUIInterface* uiInterface = nullptr;\n         NetEventsInterface* m_msgproc = nullptr;\n+        BanMan* m_banman = nullptr;\n         unsigned int nSendBufferMaxSize = 0;\n         unsigned int nReceiveFloodSize = 0;\n         uint64_t nMaxOutboundTimeframe = 0;\n@@ -158,6 +203,7 @@ class CConnman\n         nMaxFeeler = connOptions.nMaxFeeler;\n         nBestHeight = connOptions.nBestHeight;\n         clientInterface = connOptions.uiInterface;\n+        m_banman = connOptions.m_banman;\n         m_msgproc = connOptions.m_msgproc;\n         nSendBufferMaxSize = connOptions.nSendBufferMaxSize;\n         nReceiveFloodSize = connOptions.nReceiveFloodSize;\n@@ -238,30 +284,6 @@ class CConnman\n     void AddNewAddresses(const std::vector<CAddress>& vAddr, const CAddress& addrFrom, int64_t nTimePenalty = 0);\n     std::vector<CAddress> GetAddresses();\n \n-    // Denial-of-service detection/prevention\n-    // The idea is to detect peers that are behaving\n-    // badly and disconnect/ban them, but do it in a\n-    // one-coding-mistake-won't-shatter-the-entire-network\n-    // way.\n-    // IMPORTANT:  There should be nothing I can give a\n-    // node that it will forward on that will make that\n-    // node's peers drop it. If there is, an attacker\n-    // can isolate a node and/or try to split the network.\n-    // Dropping a node for sending stuff that is invalid\n-    // now but might be valid in a later version is also\n-    // dangerous, because it can cause a network split\n-    // between nodes running old code and nodes running\n-    // new code.\n-    void Ban(const CNetAddr& netAddr, const BanReason& reason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n-    void Ban(const CSubNet& subNet, const BanReason& reason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n-    void ClearBanned(); // needed for unit testing\n-    bool IsBanned(CNetAddr ip);\n-    bool IsBanned(CSubNet subnet);\n-    bool Unban(const CNetAddr &ip);\n-    bool Unban(const CSubNet &ip);\n-    void GetBanned(banmap_t &banmap);\n-    void SetBanned(const banmap_t &banmap);\n-\n     // This allows temporarily exceeding nMaxOutbound, with the goal of finding\n     // a peer that is better than all our current peers.\n     void SetTryNewOutboundPeer(bool flag);\n@@ -370,15 +392,7 @@ class CConnman\n     NodeId GetNewNodeId();\n \n     size_t SocketSendData(CNode *pnode) const;\n-    //!check is the banlist has unwritten changes\n-    bool BannedSetIsDirty();\n-    //!set the \"dirty\" flag for the banlist\n-    void SetBannedSetDirty(bool dirty=true);\n-    //!clean unused entries (if bantime has expired)\n-    void SweepBanned();\n     void DumpAddresses();\n-    void DumpData();\n-    void DumpBanlist();\n \n     // Network stats\n     void RecordBytesRecv(uint64_t bytes);\n@@ -411,9 +425,6 @@ class CConnman\n \n     std::vector<ListenSocket> vhListenSocket;\n     std::atomic<bool> fNetworkActive{true};\n-    banmap_t setBanned GUARDED_BY(cs_setBanned);\n-    CCriticalSection cs_setBanned;\n-    bool setBannedIsDirty GUARDED_BY(cs_setBanned){false};\n     bool fAddressesInitialized{false};\n     CAddrMan addrman;\n     std::deque<std::string> vOneShots GUARDED_BY(cs_vOneShots);\n@@ -439,6 +450,7 @@ class CConnman\n     std::atomic<int> nBestHeight;\n     CClientUIInterface* clientInterface;\n     NetEventsInterface* m_msgproc;\n+    BanMan* m_banman;\n \n     /** SipHasher seeds for deterministic randomness */\n     const uint64_t nSeed0, nSeed1;\n@@ -468,6 +480,7 @@ class CConnman\n     friend struct CConnmanTest;\n };\n extern std::unique_ptr<CConnman> g_connman;\n+extern std::unique_ptr<BanMan> g_banman;\n void Discover();\n void StartMapPort();\n void InterruptMapPort();"
      },
      {
        "sha": "6dd6368f741fc36fa0d9b40d8a094a6e3d344723",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 8,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
        "patch": "@@ -841,9 +841,8 @@ static bool BlockRequestAllowed(const CBlockIndex* pindex, const Consensus::Para\n         (GetBlockProofEquivalentTime(*pindexBestHeader, *pindex, *pindexBestHeader, consensusParams) < STALE_RELAY_AGE_LIMIT);\n }\n \n-PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, CScheduler &scheduler, bool enable_bip61)\n-    : connman(connmanIn), m_stale_tip_check_time(0), m_enable_bip61(enable_bip61) {\n-\n+PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CScheduler &scheduler, bool enable_bip61)\n+    : connman(connmanIn), m_banman(banman), m_stale_tip_check_time(0), m_enable_bip61(enable_bip61) {\n     // Initialize global variables that cannot be constructed at startup.\n     recentRejects.reset(new CRollingBloomFilter(120000, 0.000001));\n \n@@ -2943,7 +2942,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     return true;\n }\n \n-static bool SendRejectsAndCheckIfBanned(CNode* pnode, CConnman* connman, bool enable_bip61) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+bool PeerLogicValidation::SendRejectsAndCheckIfBanned(CNode* pnode, bool enable_bip61) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n {\n     AssertLockHeld(cs_main);\n     CNodeState &state = *State(pnode->GetId());\n@@ -2967,7 +2966,9 @@ static bool SendRejectsAndCheckIfBanned(CNode* pnode, CConnman* connman, bool en\n             pnode->fDisconnect = true;\n         } else {\n             // Disconnect and ban all nodes sharing the address\n-            connman->Ban(pnode->addr, BanReasonNodeMisbehaving);\n+            if (m_banman) {\n+                m_banman->Ban(pnode->addr, BanReasonNodeMisbehaving);\n+            }\n             connman->DisconnectNode(pnode->addr);\n         }\n         return true;\n@@ -3092,7 +3093,7 @@ bool PeerLogicValidation::ProcessMessages(CNode* pfrom, std::atomic<bool>& inter\n     }\n \n     LOCK(cs_main);\n-    SendRejectsAndCheckIfBanned(pfrom, connman, m_enable_bip61);\n+    SendRejectsAndCheckIfBanned(pfrom, m_enable_bip61);\n \n     return fMoreWork;\n }\n@@ -3293,8 +3294,7 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n         if (!lockMain)\n             return true;\n \n-        if (SendRejectsAndCheckIfBanned(pto, connman, m_enable_bip61))\n-            return true;\n+        if (SendRejectsAndCheckIfBanned(pto, m_enable_bip61)) return true;\n         CNodeState &state = *State(pto->GetId());\n \n         // Address refresh broadcast"
      },
      {
        "sha": "39c22d71188862f4c8755a9134c8487e9690d8f0",
        "filename": "src/net_processing.h",
        "status": "modified",
        "additions": 3,
        "deletions": 1,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/net_processing.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/net_processing.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.h?ref=4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
        "patch": "@@ -23,9 +23,11 @@ static constexpr bool DEFAULT_ENABLE_BIP61{false};\n class PeerLogicValidation final : public CValidationInterface, public NetEventsInterface {\n private:\n     CConnman* const connman;\n+    BanMan* const m_banman;\n \n+    bool SendRejectsAndCheckIfBanned(CNode* pnode, bool enable_bip61) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n public:\n-    explicit PeerLogicValidation(CConnman* connman, CScheduler &scheduler, bool enable_bip61);\n+    PeerLogicValidation(CConnman* connman, BanMan* banman, CScheduler &scheduler, bool enable_bip61);\n \n     /**\n      * Overridden from CValidationInterface."
      },
      {
        "sha": "19561c4fc7e51fa9981d8978e3ce725413f25184",
        "filename": "src/rpc/net.cpp",
        "status": "modified",
        "additions": 23,
        "deletions": 14,
        "changes": 37,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/rpc/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/rpc/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/net.cpp?ref=4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
        "patch": "@@ -531,8 +531,9 @@ static UniValue setban(const JSONRPCRequest& request)\n                             + HelpExampleCli(\"setban\", \"\\\"192.168.0.0/24\\\" \\\"add\\\"\")\n                             + HelpExampleRpc(\"setban\", \"\\\"192.168.0.6\\\", \\\"add\\\", 86400\")\n                             );\n-    if(!g_connman)\n-        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n+    if (!g_banman) {\n+        throw JSONRPCError(RPC_DATABASE_ERROR, \"Error: Ban database not loaded\");\n+    }\n \n     CSubNet subNet;\n     CNetAddr netAddr;\n@@ -554,8 +555,9 @@ static UniValue setban(const JSONRPCRequest& request)\n \n     if (strCommand == \"add\")\n     {\n-        if (isSubnet ? g_connman->IsBanned(subNet) : g_connman->IsBanned(netAddr))\n+        if (isSubnet ? g_banman->IsBanned(subNet) : g_banman->IsBanned(netAddr)) {\n             throw JSONRPCError(RPC_CLIENT_NODE_ALREADY_ADDED, \"Error: IP/Subnet already banned\");\n+        }\n \n         int64_t banTime = 0; //use standard bantime if not specified\n         if (!request.params[2].isNull())\n@@ -566,17 +568,22 @@ static UniValue setban(const JSONRPCRequest& request)\n             absolute = true;\n \n         if (isSubnet) {\n-            g_connman->Ban(subNet, BanReasonManuallyAdded, banTime, absolute);\n-            g_connman->DisconnectNode(subNet);\n+            g_banman->Ban(subNet, BanReasonManuallyAdded, banTime, absolute);\n+            if (g_connman) {\n+                g_connman->DisconnectNode(subNet);\n+            }\n         } else {\n-            g_connman->Ban(netAddr, BanReasonManuallyAdded, banTime, absolute);\n-            g_connman->DisconnectNode(netAddr);\n+            g_banman->Ban(netAddr, BanReasonManuallyAdded, banTime, absolute);\n+            if (g_connman) {\n+                g_connman->DisconnectNode(netAddr);\n+            }\n         }\n     }\n     else if(strCommand == \"remove\")\n     {\n-        if (!( isSubnet ? g_connman->Unban(subNet) : g_connman->Unban(netAddr) ))\n+        if (!( isSubnet ? g_banman->Unban(subNet) : g_banman->Unban(netAddr) )) {\n             throw JSONRPCError(RPC_CLIENT_INVALID_IP_OR_SUBNET, \"Error: Unban failed. Requested address/subnet was not previously banned.\");\n+        }\n     }\n     return NullUniValue;\n }\n@@ -593,11 +600,12 @@ static UniValue listbanned(const JSONRPCRequest& request)\n                             + HelpExampleRpc(\"listbanned\", \"\")\n                             );\n \n-    if(!g_connman)\n-        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n+    if(!g_banman) {\n+        throw JSONRPCError(RPC_DATABASE_ERROR, \"Error: Ban database not loaded\");\n+    }\n \n     banmap_t banMap;\n-    g_connman->GetBanned(banMap);\n+    g_banman->GetBanned(banMap);\n \n     UniValue bannedAddresses(UniValue::VARR);\n     for (const auto& entry : banMap)\n@@ -626,10 +634,11 @@ static UniValue clearbanned(const JSONRPCRequest& request)\n                             + HelpExampleCli(\"clearbanned\", \"\")\n                             + HelpExampleRpc(\"clearbanned\", \"\")\n                             );\n-    if(!g_connman)\n-        throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Peer-to-peer functionality missing or disabled\");\n+    if (!g_banman) {\n+        throw JSONRPCError(RPC_DATABASE_ERROR, \"Error: Ban database not loaded\");\n+    }\n \n-    g_connman->ClearBanned();\n+    g_banman->ClearBanned();\n \n     return NullUniValue;\n }"
      },
      {
        "sha": "9776ea223d46126870019d1996e5b2f4af7b72c7",
        "filename": "src/test/denialofservice_tests.cpp",
        "status": "modified",
        "additions": 22,
        "deletions": 19,
        "changes": 41,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/test/denialofservice_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/test/denialofservice_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/denialofservice_tests.cpp?ref=4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
        "patch": "@@ -75,7 +75,7 @@ BOOST_FIXTURE_TEST_SUITE(denialofservice_tests, TestingSetup)\n BOOST_AUTO_TEST_CASE(outbound_slow_chain_eviction)\n {\n     auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n-    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), scheduler, false);\n+    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), nullptr, scheduler, false);\n \n     // Mock an outbound peer\n     CAddress addr1(ip(0xa0b0c001), NODE_NONE);\n@@ -145,7 +145,7 @@ static void AddRandomOutboundPeer(std::vector<CNode *> &vNodes, PeerLogicValidat\n BOOST_AUTO_TEST_CASE(stale_tip_peer_management)\n {\n     auto connman = MakeUnique<CConnmanTest>(0x1337, 0x1337);\n-    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), scheduler, false);\n+    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), nullptr, scheduler, false);\n \n     const Consensus::Params& consensusParams = Params().GetConsensus();\n     constexpr int nMaxOutbound = 8;\n@@ -216,10 +216,11 @@ BOOST_AUTO_TEST_CASE(stale_tip_peer_management)\n \n BOOST_AUTO_TEST_CASE(DoS_banning)\n {\n+    auto banman = MakeUnique<BanMan>(nullptr);\n     auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n-    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), scheduler, false);\n+    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), banman.get(), scheduler, false);\n \n-    connman->ClearBanned();\n+    banman->ClearBanned();\n     CAddress addr1(ip(0xa0b0c001), NODE_NONE);\n     CNode dummyNode1(id++, NODE_NETWORK, 0, INVALID_SOCKET, addr1, 0, 0, CAddress(), \"\", true);\n     dummyNode1.SetSendVersion(PROTOCOL_VERSION);\n@@ -234,8 +235,8 @@ BOOST_AUTO_TEST_CASE(DoS_banning)\n         LOCK2(cs_main, dummyNode1.cs_sendProcessing);\n         BOOST_CHECK(peerLogic->SendMessages(&dummyNode1));\n     }\n-    BOOST_CHECK(connman->IsBanned(addr1));\n-    BOOST_CHECK(!connman->IsBanned(ip(0xa0b0c001|0x0000ff00))); // Different IP, not banned\n+    BOOST_CHECK(banman->IsBanned(addr1));\n+    BOOST_CHECK(!banman->IsBanned(ip(0xa0b0c001|0x0000ff00))); // Different IP, not banned\n \n     CAddress addr2(ip(0xa0b0c002), NODE_NONE);\n     CNode dummyNode2(id++, NODE_NETWORK, 0, INVALID_SOCKET, addr2, 1, 1, CAddress(), \"\", true);\n@@ -251,8 +252,8 @@ BOOST_AUTO_TEST_CASE(DoS_banning)\n         LOCK2(cs_main, dummyNode2.cs_sendProcessing);\n         BOOST_CHECK(peerLogic->SendMessages(&dummyNode2));\n     }\n-    BOOST_CHECK(!connman->IsBanned(addr2)); // 2 not banned yet...\n-    BOOST_CHECK(connman->IsBanned(addr1));  // ... but 1 still should be\n+    BOOST_CHECK(!banman->IsBanned(addr2)); // 2 not banned yet...\n+    BOOST_CHECK(banman->IsBanned(addr1));  // ... but 1 still should be\n     {\n         LOCK(cs_main);\n         Misbehaving(dummyNode2.GetId(), 50);\n@@ -261,7 +262,7 @@ BOOST_AUTO_TEST_CASE(DoS_banning)\n         LOCK2(cs_main, dummyNode2.cs_sendProcessing);\n         BOOST_CHECK(peerLogic->SendMessages(&dummyNode2));\n     }\n-    BOOST_CHECK(connman->IsBanned(addr2));\n+    BOOST_CHECK(banman->IsBanned(addr2));\n \n     bool dummy;\n     peerLogic->FinalizeNode(dummyNode1.GetId(), dummy);\n@@ -270,10 +271,11 @@ BOOST_AUTO_TEST_CASE(DoS_banning)\n \n BOOST_AUTO_TEST_CASE(DoS_banscore)\n {\n+    auto banman = MakeUnique<BanMan>(nullptr);\n     auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n-    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), scheduler, false);\n+    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), banman.get(), scheduler, false);\n \n-    connman->ClearBanned();\n+    banman->ClearBanned();\n     gArgs.ForceSetArg(\"-banscore\", \"111\"); // because 11 is my favorite number\n     CAddress addr1(ip(0xa0b0c001), NODE_NONE);\n     CNode dummyNode1(id++, NODE_NETWORK, 0, INVALID_SOCKET, addr1, 3, 1, CAddress(), \"\", true);\n@@ -289,7 +291,7 @@ BOOST_AUTO_TEST_CASE(DoS_banscore)\n         LOCK2(cs_main, dummyNode1.cs_sendProcessing);\n         BOOST_CHECK(peerLogic->SendMessages(&dummyNode1));\n     }\n-    BOOST_CHECK(!connman->IsBanned(addr1));\n+    BOOST_CHECK(!banman->IsBanned(addr1));\n     {\n         LOCK(cs_main);\n         Misbehaving(dummyNode1.GetId(), 10);\n@@ -298,7 +300,7 @@ BOOST_AUTO_TEST_CASE(DoS_banscore)\n         LOCK2(cs_main, dummyNode1.cs_sendProcessing);\n         BOOST_CHECK(peerLogic->SendMessages(&dummyNode1));\n     }\n-    BOOST_CHECK(!connman->IsBanned(addr1));\n+    BOOST_CHECK(!banman->IsBanned(addr1));\n     {\n         LOCK(cs_main);\n         Misbehaving(dummyNode1.GetId(), 1);\n@@ -307,7 +309,7 @@ BOOST_AUTO_TEST_CASE(DoS_banscore)\n         LOCK2(cs_main, dummyNode1.cs_sendProcessing);\n         BOOST_CHECK(peerLogic->SendMessages(&dummyNode1));\n     }\n-    BOOST_CHECK(connman->IsBanned(addr1));\n+    BOOST_CHECK(banman->IsBanned(addr1));\n     gArgs.ForceSetArg(\"-banscore\", std::to_string(DEFAULT_BANSCORE_THRESHOLD));\n \n     bool dummy;\n@@ -316,10 +318,11 @@ BOOST_AUTO_TEST_CASE(DoS_banscore)\n \n BOOST_AUTO_TEST_CASE(DoS_bantime)\n {\n+    auto banman = MakeUnique<BanMan>(nullptr);\n     auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n-    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), scheduler, false);\n+    auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), banman.get(), scheduler, false);\n \n-    connman->ClearBanned();\n+    banman->ClearBanned();\n     int64_t nStartTime = GetTime();\n     SetMockTime(nStartTime); // Overrides future calls to GetTime()\n \n@@ -338,13 +341,13 @@ BOOST_AUTO_TEST_CASE(DoS_bantime)\n         LOCK2(cs_main, dummyNode.cs_sendProcessing);\n         BOOST_CHECK(peerLogic->SendMessages(&dummyNode));\n     }\n-    BOOST_CHECK(connman->IsBanned(addr));\n+    BOOST_CHECK(banman->IsBanned(addr));\n \n     SetMockTime(nStartTime+60*60);\n-    BOOST_CHECK(connman->IsBanned(addr));\n+    BOOST_CHECK(banman->IsBanned(addr));\n \n     SetMockTime(nStartTime+60*60*24+1);\n-    BOOST_CHECK(!connman->IsBanned(addr));\n+    BOOST_CHECK(!banman->IsBanned(addr));\n \n     bool dummy;\n     peerLogic->FinalizeNode(dummyNode.GetId(), dummy);"
      },
      {
        "sha": "6d1f70f9a19c04b9f90fc7647373a3e8adb55242",
        "filename": "src/test/test_bitcoin.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/test/test_bitcoin.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/test/test_bitcoin.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/test_bitcoin.cpp?ref=4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
        "patch": "@@ -93,6 +93,8 @@ TestingSetup::TestingSetup(const std::string& chainName) : BasicTestingSetup(cha\n         nScriptCheckThreads = 3;\n         for (int i=0; i < nScriptCheckThreads-1; i++)\n             threadGroup.create_thread(&ThreadScriptCheck);\n+\n+        g_banman = MakeUnique<BanMan>(nullptr);\n         g_connman = MakeUnique<CConnman>(0x1337, 0x1337); // Deterministic randomness for tests.\n }\n \n@@ -103,6 +105,7 @@ TestingSetup::~TestingSetup()\n     GetMainSignals().FlushBackgroundCallbacks();\n     GetMainSignals().UnregisterBackgroundSignalScheduler();\n     g_connman.reset();\n+    g_banman.reset();\n     UnloadBlockIndex();\n     pcoinsTip.reset();\n     pcoinsdbview.reset();"
      },
      {
        "sha": "caa35c0efc25d8329464301e79a528959ad83c8e",
        "filename": "src/test/test_bitcoin_main.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/test/test_bitcoin_main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6/src/test/test_bitcoin_main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/test_bitcoin_main.cpp?ref=4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
        "patch": "@@ -11,6 +11,7 @@\n #include <boost/test/unit_test.hpp>\n \n std::unique_ptr<CConnman> g_connman;\n+std::unique_ptr<BanMan> g_banman;\n \n [[noreturn]] void Shutdown(void* parg)\n {"
      }
    ]
  },
  {
    "sha": "2e56702ecedd83c4b7cb8de9de5c437c8c08e645",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyZTU2NzAyZWNlZGQ4M2M0YjdjYjhkZTlkZTVjNDM3YzhjMDhlNjQ1",
    "commit": {
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-10-05T17:35:20Z"
      },
      "committer": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2019-01-16T18:54:18Z"
      },
      "message": "banman: pass the banfile path in\n\nThere's no need to hard-code the path here. Passing it in means that there are\nno ordering concerns wrt establishing the datadir.",
      "tree": {
        "sha": "8ceb655d5556a7b97a6362d1940e5b8ae0a307e0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8ceb655d5556a7b97a6362d1940e5b8ae0a307e0"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2e56702ecedd83c4b7cb8de9de5c437c8c08e645",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2e56702ecedd83c4b7cb8de9de5c437c8c08e645",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/2e56702ecedd83c4b7cb8de9de5c437c8c08e645",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/comments",
    "author": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/4c0d961eb0d7825a1e6f8389d7f5545114ee18c6"
      }
    ],
    "stats": {
      "total": 33,
      "additions": 15,
      "deletions": 18
    },
    "files": [
      {
        "sha": "c6083f5554be16a8b55f36a2a5b140114dfe41e0",
        "filename": "src/addrdb.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 4,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/addrdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/addrdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/addrdb.cpp?ref=2e56702ecedd83c4b7cb8de9de5c437c8c08e645",
        "patch": "@@ -105,19 +105,18 @@ bool DeserializeFileDB(const fs::path& path, Data& data)\n \n }\n \n-CBanDB::CBanDB()\n+CBanDB::CBanDB(fs::path ban_list_path) : m_ban_list_path(std::move(ban_list_path))\n {\n-    pathBanlist = GetDataDir() / \"banlist.dat\";\n }\n \n bool CBanDB::Write(const banmap_t& banSet)\n {\n-    return SerializeFileDB(\"banlist\", pathBanlist, banSet);\n+    return SerializeFileDB(\"banlist\", m_ban_list_path, banSet);\n }\n \n bool CBanDB::Read(banmap_t& banSet)\n {\n-    return DeserializeFileDB(pathBanlist, banSet);\n+    return DeserializeFileDB(m_ban_list_path, banSet);\n }\n \n CAddrDB::CAddrDB()"
      },
      {
        "sha": "88da31a6fc3ca50f0f089486a2abeaab1b95eff5",
        "filename": "src/addrdb.h",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/addrdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/addrdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/addrdb.h?ref=2e56702ecedd83c4b7cb8de9de5c437c8c08e645",
        "patch": "@@ -92,9 +92,9 @@ class CAddrDB\n class CBanDB\n {\n private:\n-    fs::path pathBanlist;\n+    const fs::path m_ban_list_path;\n public:\n-    CBanDB();\n+    explicit CBanDB(fs::path ban_list_path);\n     bool Write(const banmap_t& banSet);\n     bool Read(banmap_t& banSet);\n };"
      },
      {
        "sha": "ded157d49e229996c907c5fad214c807574c5e4b",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=2e56702ecedd83c4b7cb8de9de5c437c8c08e645",
        "patch": "@@ -1296,7 +1296,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n     // need to reindex later.\n \n     assert(!g_banman);\n-    g_banman = MakeUnique<BanMan>(&uiInterface);\n+    g_banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", &uiInterface);\n     assert(!g_connman);\n     g_connman = std::unique_ptr<CConnman>(new CConnman(GetRand(std::numeric_limits<uint64_t>::max()), GetRand(std::numeric_limits<uint64_t>::max())));\n "
      },
      {
        "sha": "fd74c58292a5c30a547737116eae49688d7b499d",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 6,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=2e56702ecedd83c4b7cb8de9de5c437c8c08e645",
        "patch": "@@ -466,10 +466,9 @@ void BanMan::DumpBanlist()\n \n     int64_t nStart = GetTimeMillis();\n \n-    CBanDB bandb;\n     banmap_t banmap;\n     GetBanned(banmap);\n-    if (bandb.Write(banmap)) {\n+    if (m_ban_db.Write(banmap)) {\n         SetBannedSetDirty(false);\n     }\n \n@@ -2431,16 +2430,14 @@ bool CConnman::Start(CScheduler& scheduler, const Options& connOptions)\n     return true;\n }\n \n-BanMan::BanMan(CClientUIInterface* client_interface) : clientInterface(client_interface)\n+BanMan::BanMan(fs::path ban_file, CClientUIInterface* client_interface) : clientInterface(client_interface), m_ban_db(std::move(ban_file))\n {\n     if (clientInterface) clientInterface->InitMessage(_(\"Loading banlist...\"));\n-    // Load addresses from banlist.dat\n \n     int64_t nStart = GetTimeMillis();\n     setBannedIsDirty = false;\n-    CBanDB bandb;\n     banmap_t banmap;\n-    if (bandb.Read(banmap)) {\n+    if (m_ban_db.Read(banmap)) {\n         SetBanned(banmap); // thread save setter\n         SetBannedSetDirty(false); // no need to write down, just read data\n         SweepBanned(); // sweep out unused entries"
      },
      {
        "sha": "5e6fc14b389ec4bd338ec23f7b268556a62d42a4",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=2e56702ecedd83c4b7cb8de9de5c437c8c08e645",
        "patch": "@@ -133,7 +133,7 @@ class BanMan\n     // between nodes running old code and nodes running\n     // new code.\n     ~BanMan();\n-    BanMan(CClientUIInterface* client_interface);\n+    BanMan(fs::path ban_file, CClientUIInterface* client_interface);\n     void Ban(const CNetAddr& netAddr, const BanReason& reason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n     void Ban(const CSubNet& subNet, const BanReason& reason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n     void ClearBanned(); // needed for unit testing\n@@ -156,6 +156,7 @@ class BanMan\n     CCriticalSection cs_setBanned;\n     bool setBannedIsDirty;\n     CClientUIInterface* clientInterface = nullptr;\n+    CBanDB m_ban_db;\n };\n \n class NetEventsInterface;"
      },
      {
        "sha": "4a88613a892f13b0744bcda9760002b058c6947c",
        "filename": "src/test/denialofservice_tests.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/test/denialofservice_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/test/denialofservice_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/denialofservice_tests.cpp?ref=2e56702ecedd83c4b7cb8de9de5c437c8c08e645",
        "patch": "@@ -216,7 +216,7 @@ BOOST_AUTO_TEST_CASE(stale_tip_peer_management)\n \n BOOST_AUTO_TEST_CASE(DoS_banning)\n {\n-    auto banman = MakeUnique<BanMan>(nullptr);\n+    auto banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", nullptr);\n     auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n     auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), banman.get(), scheduler, false);\n \n@@ -271,7 +271,7 @@ BOOST_AUTO_TEST_CASE(DoS_banning)\n \n BOOST_AUTO_TEST_CASE(DoS_banscore)\n {\n-    auto banman = MakeUnique<BanMan>(nullptr);\n+    auto banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", nullptr);\n     auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n     auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), banman.get(), scheduler, false);\n \n@@ -318,7 +318,7 @@ BOOST_AUTO_TEST_CASE(DoS_banscore)\n \n BOOST_AUTO_TEST_CASE(DoS_bantime)\n {\n-    auto banman = MakeUnique<BanMan>(nullptr);\n+    auto banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", nullptr);\n     auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n     auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), banman.get(), scheduler, false);\n "
      },
      {
        "sha": "7bce74b46b000d115981a1c07573042b922987d4",
        "filename": "src/test/test_bitcoin.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/test/test_bitcoin.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2e56702ecedd83c4b7cb8de9de5c437c8c08e645/src/test/test_bitcoin.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/test_bitcoin.cpp?ref=2e56702ecedd83c4b7cb8de9de5c437c8c08e645",
        "patch": "@@ -94,7 +94,7 @@ TestingSetup::TestingSetup(const std::string& chainName) : BasicTestingSetup(cha\n         for (int i=0; i < nScriptCheckThreads-1; i++)\n             threadGroup.create_thread(&ThreadScriptCheck);\n \n-        g_banman = MakeUnique<BanMan>(nullptr);\n+        g_banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", nullptr);\n         g_connman = MakeUnique<CConnman>(0x1337, 0x1337); // Deterministic randomness for tests.\n }\n "
      }
    ]
  },
  {
    "sha": "d0469b2e9386a7a4b268cb9725347e7517acace6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkMDQ2OWIyZTkzODZhN2E0YjI2OGNiOTcyNTM0N2U3NTE3YWNhY2U2",
    "commit": {
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-10-05T17:41:45Z"
      },
      "committer": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2019-01-16T18:54:18Z"
      },
      "message": "banman: pass in default ban time as a parameter\n\nRemoves the dependency on arg parsing.",
      "tree": {
        "sha": "77e13e31bd2204de782afafe03c1e71203392c71",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/77e13e31bd2204de782afafe03c1e71203392c71"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d0469b2e9386a7a4b268cb9725347e7517acace6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d0469b2e9386a7a4b268cb9725347e7517acace6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/d0469b2e9386a7a4b268cb9725347e7517acace6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d0469b2e9386a7a4b268cb9725347e7517acace6/comments",
    "author": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "2e56702ecedd83c4b7cb8de9de5c437c8c08e645",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2e56702ecedd83c4b7cb8de9de5c437c8c08e645",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/2e56702ecedd83c4b7cb8de9de5c437c8c08e645"
      }
    ],
    "stats": {
      "total": 17,
      "additions": 9,
      "deletions": 8
    },
    "files": [
      {
        "sha": "0f59dfbef5282ec8d01472724af89b76b755b162",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d0469b2e9386a7a4b268cb9725347e7517acace6/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d0469b2e9386a7a4b268cb9725347e7517acace6/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=d0469b2e9386a7a4b268cb9725347e7517acace6",
        "patch": "@@ -1296,7 +1296,7 @@ bool AppInitMain(InitInterfaces& interfaces)\n     // need to reindex later.\n \n     assert(!g_banman);\n-    g_banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", &uiInterface);\n+    g_banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", &uiInterface, gArgs.GetArg(\"-bantime\", DEFAULT_MISBEHAVING_BANTIME));\n     assert(!g_connman);\n     g_connman = std::unique_ptr<CConnman>(new CConnman(GetRand(std::numeric_limits<uint64_t>::max()), GetRand(std::numeric_limits<uint64_t>::max())));\n "
      },
      {
        "sha": "f6491bc8dbc66f5dc4f2cdc1556dde0ce5d3b3ea",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d0469b2e9386a7a4b268cb9725347e7517acace6/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d0469b2e9386a7a4b268cb9725347e7517acace6/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=d0469b2e9386a7a4b268cb9725347e7517acace6",
        "patch": "@@ -537,7 +537,7 @@ void BanMan::Ban(const CSubNet& subNet, const BanReason &banReason, int64_t bant\n     banEntry.banReason = banReason;\n     if (bantimeoffset <= 0)\n     {\n-        bantimeoffset = gArgs.GetArg(\"-bantime\", DEFAULT_MISBEHAVING_BANTIME);\n+        bantimeoffset = m_default_ban_time;\n         sinceUnixEpoch = false;\n     }\n     banEntry.nBanUntil = (sinceUnixEpoch ? 0 : GetTime() )+bantimeoffset;\n@@ -2430,7 +2430,7 @@ bool CConnman::Start(CScheduler& scheduler, const Options& connOptions)\n     return true;\n }\n \n-BanMan::BanMan(fs::path ban_file, CClientUIInterface* client_interface) : clientInterface(client_interface), m_ban_db(std::move(ban_file))\n+BanMan::BanMan(fs::path ban_file, CClientUIInterface* client_interface, int64_t default_ban_time) : clientInterface(client_interface), m_ban_db(std::move(ban_file)), m_default_ban_time(default_ban_time)\n {\n     if (clientInterface) clientInterface->InitMessage(_(\"Loading banlist...\"));\n "
      },
      {
        "sha": "a6a536d68ae2b231898cc4ac0b9bc5fc1466cd43",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d0469b2e9386a7a4b268cb9725347e7517acace6/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d0469b2e9386a7a4b268cb9725347e7517acace6/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=d0469b2e9386a7a4b268cb9725347e7517acace6",
        "patch": "@@ -133,7 +133,7 @@ class BanMan\n     // between nodes running old code and nodes running\n     // new code.\n     ~BanMan();\n-    BanMan(fs::path ban_file, CClientUIInterface* client_interface);\n+    BanMan(fs::path ban_file, CClientUIInterface* client_interface, int64_t default_ban_time);\n     void Ban(const CNetAddr& netAddr, const BanReason& reason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n     void Ban(const CSubNet& subNet, const BanReason& reason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n     void ClearBanned(); // needed for unit testing\n@@ -157,6 +157,7 @@ class BanMan\n     bool setBannedIsDirty;\n     CClientUIInterface* clientInterface = nullptr;\n     CBanDB m_ban_db;\n+    int64_t m_default_ban_time;\n };\n \n class NetEventsInterface;"
      },
      {
        "sha": "29bb34bddca33438fac59c5766f22adf813bc73e",
        "filename": "src/test/denialofservice_tests.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d0469b2e9386a7a4b268cb9725347e7517acace6/src/test/denialofservice_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d0469b2e9386a7a4b268cb9725347e7517acace6/src/test/denialofservice_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/denialofservice_tests.cpp?ref=d0469b2e9386a7a4b268cb9725347e7517acace6",
        "patch": "@@ -216,7 +216,7 @@ BOOST_AUTO_TEST_CASE(stale_tip_peer_management)\n \n BOOST_AUTO_TEST_CASE(DoS_banning)\n {\n-    auto banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", nullptr);\n+    auto banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", nullptr, DEFAULT_MISBEHAVING_BANTIME);\n     auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n     auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), banman.get(), scheduler, false);\n \n@@ -271,7 +271,7 @@ BOOST_AUTO_TEST_CASE(DoS_banning)\n \n BOOST_AUTO_TEST_CASE(DoS_banscore)\n {\n-    auto banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", nullptr);\n+    auto banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", nullptr, DEFAULT_MISBEHAVING_BANTIME);\n     auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n     auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), banman.get(), scheduler, false);\n \n@@ -318,7 +318,7 @@ BOOST_AUTO_TEST_CASE(DoS_banscore)\n \n BOOST_AUTO_TEST_CASE(DoS_bantime)\n {\n-    auto banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", nullptr);\n+    auto banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", nullptr, DEFAULT_MISBEHAVING_BANTIME);\n     auto connman = MakeUnique<CConnman>(0x1337, 0x1337);\n     auto peerLogic = MakeUnique<PeerLogicValidation>(connman.get(), banman.get(), scheduler, false);\n "
      },
      {
        "sha": "75bd8db67eb7fec310bcc703f86e565d6820479f",
        "filename": "src/test/test_bitcoin.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d0469b2e9386a7a4b268cb9725347e7517acace6/src/test/test_bitcoin.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d0469b2e9386a7a4b268cb9725347e7517acace6/src/test/test_bitcoin.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/test_bitcoin.cpp?ref=d0469b2e9386a7a4b268cb9725347e7517acace6",
        "patch": "@@ -94,7 +94,7 @@ TestingSetup::TestingSetup(const std::string& chainName) : BasicTestingSetup(cha\n         for (int i=0; i < nScriptCheckThreads-1; i++)\n             threadGroup.create_thread(&ThreadScriptCheck);\n \n-        g_banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", nullptr);\n+        g_banman = MakeUnique<BanMan>(GetDataDir() / \"banlist.dat\", nullptr, DEFAULT_MISBEHAVING_BANTIME);\n         g_connman = MakeUnique<CConnman>(0x1337, 0x1337); // Deterministic randomness for tests.\n }\n "
      }
    ]
  },
  {
    "sha": "af3503d903b1a608cd212e2d74b274103199078c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphZjM1MDNkOTAzYjFhNjA4Y2QyMTJlMmQ3NGIyNzQxMDMxOTkwNzhj",
    "commit": {
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-10-05T20:40:43Z"
      },
      "committer": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2019-01-16T18:54:18Z"
      },
      "message": "net: move BanMan to its own files",
      "tree": {
        "sha": "14c60eea45f0f1ed6ccde5241be58922102524ec",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/14c60eea45f0f1ed6ccde5241be58922102524ec"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/af3503d903b1a608cd212e2d74b274103199078c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/af3503d903b1a608cd212e2d74b274103199078c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/af3503d903b1a608cd212e2d74b274103199078c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/af3503d903b1a608cd212e2d74b274103199078c/comments",
    "author": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "d0469b2e9386a7a4b268cb9725347e7517acace6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d0469b2e9386a7a4b268cb9725347e7517acace6",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/d0469b2e9386a7a4b268cb9725347e7517acace6"
      }
    ],
    "stats": {
      "total": 513,
      "additions": 276,
      "deletions": 237
    },
    "files": [
      {
        "sha": "4b07f06c95f68561e896b071af9c804a6f420a91",
        "filename": "src/Makefile.am",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/af3503d903b1a608cd212e2d74b274103199078c/src/Makefile.am",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/af3503d903b1a608cd212e2d74b274103199078c/src/Makefile.am",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/Makefile.am?ref=af3503d903b1a608cd212e2d74b274103199078c",
        "patch": "@@ -96,6 +96,7 @@ BITCOIN_CORE_H = \\\n   addrdb.h \\\n   addrman.h \\\n   attributes.h \\\n+  banman.h \\\n   base58.h \\\n   bech32.h \\\n   bloom.h \\\n@@ -225,6 +226,7 @@ libbitcoin_server_a_CXXFLAGS = $(AM_CXXFLAGS) $(PIE_FLAGS)\n libbitcoin_server_a_SOURCES = \\\n   addrdb.cpp \\\n   addrman.cpp \\\n+  banman.cpp \\\n   bloom.cpp \\\n   blockencodings.cpp \\\n   blockfilter.cpp \\"
      },
      {
        "sha": "59cfe263184a492d8cf95283478145aeee3e473c",
        "filename": "src/banman.cpp",
        "status": "added",
        "additions": 195,
        "deletions": 0,
        "changes": 195,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/af3503d903b1a608cd212e2d74b274103199078c/src/banman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/af3503d903b1a608cd212e2d74b274103199078c/src/banman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/banman.cpp?ref=af3503d903b1a608cd212e2d74b274103199078c",
        "patch": "@@ -0,0 +1,195 @@\n+// Copyright (c) 2009-2010 Satoshi Nakamoto\n+// Copyright (c) 2009-2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <banman.h>\n+\n+#include <netaddress.h>\n+#include <ui_interface.h>\n+#include <util/system.h>\n+#include <util/time.h>\n+\n+\n+BanMan::BanMan(fs::path ban_file, CClientUIInterface* client_interface, int64_t default_ban_time)\n+    : clientInterface(client_interface), m_ban_db(std::move(ban_file)), m_default_ban_time(default_ban_time)\n+{\n+    if (clientInterface) clientInterface->InitMessage(_(\"Loading banlist...\"));\n+\n+    int64_t nStart = GetTimeMillis();\n+    setBannedIsDirty = false;\n+    banmap_t banmap;\n+    if (m_ban_db.Read(banmap)) {\n+        SetBanned(banmap);        // thread save setter\n+        SetBannedSetDirty(false); // no need to write down, just read data\n+        SweepBanned();            // sweep out unused entries\n+\n+        LogPrint(BCLog::NET, \"Loaded %d banned node ips/subnets from banlist.dat  %dms\\n\",\n+            banmap.size(), GetTimeMillis() - nStart);\n+    } else {\n+        LogPrintf(\"Invalid or missing banlist.dat; recreating\\n\");\n+        SetBannedSetDirty(true); // force write\n+        DumpBanlist();\n+    }\n+}\n+\n+BanMan::~BanMan()\n+{\n+    DumpBanlist();\n+}\n+\n+void BanMan::DumpBanlist()\n+{\n+    SweepBanned(); // clean unused entries (if bantime has expired)\n+\n+    if (!BannedSetIsDirty()) return;\n+\n+    int64_t nStart = GetTimeMillis();\n+\n+    banmap_t banmap;\n+    GetBanned(banmap);\n+    if (m_ban_db.Write(banmap)) {\n+        SetBannedSetDirty(false);\n+    }\n+\n+    LogPrint(BCLog::NET, \"Flushed %d banned node ips/subnets to banlist.dat  %dms\\n\",\n+        banmap.size(), GetTimeMillis() - nStart);\n+}\n+\n+void BanMan::ClearBanned()\n+{\n+    {\n+        LOCK(cs_setBanned);\n+        setBanned.clear();\n+        setBannedIsDirty = true;\n+    }\n+    DumpBanlist(); //store banlist to disk\n+    if (clientInterface) clientInterface->BannedListChanged();\n+}\n+\n+bool BanMan::IsBanned(CNetAddr netAddr)\n+{\n+    LOCK(cs_setBanned);\n+    for (const auto& it : setBanned) {\n+        CSubNet subNet = it.first;\n+        CBanEntry banEntry = it.second;\n+\n+        if (subNet.Match(netAddr) && GetTime() < banEntry.nBanUntil) {\n+            return true;\n+        }\n+    }\n+    return false;\n+}\n+\n+bool BanMan::IsBanned(CSubNet subNet)\n+{\n+    LOCK(cs_setBanned);\n+    banmap_t::iterator i = setBanned.find(subNet);\n+    if (i != setBanned.end()) {\n+        CBanEntry banEntry = (*i).second;\n+        if (GetTime() < banEntry.nBanUntil) {\n+            return true;\n+        }\n+    }\n+    return false;\n+}\n+\n+void BanMan::Ban(const CNetAddr& netAddr, const BanReason& banReason, int64_t bantimeoffset, bool sinceUnixEpoch)\n+{\n+    CSubNet subNet(netAddr);\n+    Ban(subNet, banReason, bantimeoffset, sinceUnixEpoch);\n+}\n+\n+void BanMan::Ban(const CSubNet& subNet, const BanReason& banReason, int64_t bantimeoffset, bool sinceUnixEpoch)\n+{\n+    CBanEntry banEntry(GetTime());\n+    banEntry.banReason = banReason;\n+    if (bantimeoffset <= 0) {\n+        bantimeoffset = m_default_ban_time;\n+        sinceUnixEpoch = false;\n+    }\n+    banEntry.nBanUntil = (sinceUnixEpoch ? 0 : GetTime()) + bantimeoffset;\n+\n+    {\n+        LOCK(cs_setBanned);\n+        if (setBanned[subNet].nBanUntil < banEntry.nBanUntil) {\n+            setBanned[subNet] = banEntry;\n+            setBannedIsDirty = true;\n+        } else\n+            return;\n+    }\n+    if (clientInterface) clientInterface->BannedListChanged();\n+\n+    //store banlist to disk immediately if user requested ban\n+    if (banReason == BanReasonManuallyAdded) DumpBanlist();\n+}\n+\n+bool BanMan::Unban(const CNetAddr& netAddr)\n+{\n+    CSubNet subNet(netAddr);\n+    return Unban(subNet);\n+}\n+\n+bool BanMan::Unban(const CSubNet& subNet)\n+{\n+    {\n+        LOCK(cs_setBanned);\n+        if (setBanned.erase(subNet) == 0) return false;\n+        setBannedIsDirty = true;\n+    }\n+    if (clientInterface) clientInterface->BannedListChanged();\n+    DumpBanlist(); //store banlist to disk immediately\n+    return true;\n+}\n+\n+void BanMan::GetBanned(banmap_t& banMap)\n+{\n+    LOCK(cs_setBanned);\n+    // Sweep the banlist so expired bans are not returned\n+    SweepBanned();\n+    banMap = setBanned; //create a thread safe copy\n+}\n+\n+void BanMan::SetBanned(const banmap_t& banMap)\n+{\n+    LOCK(cs_setBanned);\n+    setBanned = banMap;\n+    setBannedIsDirty = true;\n+}\n+\n+void BanMan::SweepBanned()\n+{\n+    int64_t now = GetTime();\n+    bool notifyUI = false;\n+    {\n+        LOCK(cs_setBanned);\n+        banmap_t::iterator it = setBanned.begin();\n+        while (it != setBanned.end()) {\n+            CSubNet subNet = (*it).first;\n+            CBanEntry banEntry = (*it).second;\n+            if (now > banEntry.nBanUntil) {\n+                setBanned.erase(it++);\n+                setBannedIsDirty = true;\n+                notifyUI = true;\n+                LogPrint(BCLog::NET, \"%s: Removed banned node ip/subnet from banlist.dat: %s\\n\", __func__, subNet.ToString());\n+            } else\n+                ++it;\n+        }\n+    }\n+    // update UI\n+    if (notifyUI && clientInterface) {\n+        clientInterface->BannedListChanged();\n+    }\n+}\n+\n+bool BanMan::BannedSetIsDirty()\n+{\n+    LOCK(cs_setBanned);\n+    return setBannedIsDirty;\n+}\n+\n+void BanMan::SetBannedSetDirty(bool dirty)\n+{\n+    LOCK(cs_setBanned); //reuse setBanned lock for the setBannedIsDirty flag\n+    setBannedIsDirty = dirty;\n+}"
      },
      {
        "sha": "898ae8519708f182a7c7280dd17863d28e52a0a0",
        "filename": "src/banman.h",
        "status": "added",
        "additions": 69,
        "deletions": 0,
        "changes": 69,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/af3503d903b1a608cd212e2d74b274103199078c/src/banman.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/af3503d903b1a608cd212e2d74b274103199078c/src/banman.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/banman.h?ref=af3503d903b1a608cd212e2d74b274103199078c",
        "patch": "@@ -0,0 +1,69 @@\n+// Copyright (c) 2009-2010 Satoshi Nakamoto\n+// Copyright (c) 2009-2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#ifndef BITCOIN_BANMAN_H\n+#define BITCOIN_BANMAN_H\n+\n+#include <cstdint>\n+#include <memory>\n+\n+#include <addrdb.h>\n+#include <fs.h>\n+#include <sync.h>\n+\n+// NOTE: When adjusting this, update rpcnet:setban's help (\"24h\")\n+static constexpr unsigned int DEFAULT_MISBEHAVING_BANTIME = 60 * 60 * 24; // Default 24-hour ban\n+\n+class CClientUIInterface;\n+class CNetAddr;\n+class CSubNet;\n+\n+// Denial-of-service detection/prevention\n+// The idea is to detect peers that are behaving\n+// badly and disconnect/ban them, but do it in a\n+// one-coding-mistake-won't-shatter-the-entire-network\n+// way.\n+// IMPORTANT:  There should be nothing I can give a\n+// node that it will forward on that will make that\n+// node's peers drop it. If there is, an attacker\n+// can isolate a node and/or try to split the network.\n+// Dropping a node for sending stuff that is invalid\n+// now but might be valid in a later version is also\n+// dangerous, because it can cause a network split\n+// between nodes running old code and nodes running\n+// new code.\n+\n+class BanMan\n+{\n+public:\n+    ~BanMan();\n+    BanMan(fs::path ban_file, CClientUIInterface* client_interface, int64_t default_ban_time);\n+    void Ban(const CNetAddr& netAddr, const BanReason& banReason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n+    void Ban(const CSubNet& subNet, const BanReason& banReason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n+    void ClearBanned(); // needed for unit testing\n+    bool IsBanned(CNetAddr netAddr);\n+    bool IsBanned(CSubNet subNet);\n+    bool Unban(const CNetAddr& netAddr);\n+    bool Unban(const CSubNet& subNet);\n+    void GetBanned(banmap_t& banMap);\n+    void DumpBanlist();\n+\n+private:\n+    void SetBanned(const banmap_t& banMap);\n+    bool BannedSetIsDirty();\n+    //!set the \"dirty\" flag for the banlist\n+    void SetBannedSetDirty(bool dirty = true);\n+    //!clean unused entries (if bantime has expired)\n+    void SweepBanned();\n+\n+    banmap_t setBanned;\n+    CCriticalSection cs_setBanned;\n+    bool setBannedIsDirty;\n+    CClientUIInterface* clientInterface = nullptr;\n+    CBanDB m_ban_db;\n+    int64_t m_default_ban_time;\n+};\n+\n+extern std::unique_ptr<BanMan> g_banman;\n+#endif"
      },
      {
        "sha": "77d0505610d3338f7b941390d4b3ea902d7a5920",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/af3503d903b1a608cd212e2d74b274103199078c/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/af3503d903b1a608cd212e2d74b274103199078c/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=af3503d903b1a608cd212e2d74b274103199078c",
        "patch": "@@ -11,6 +11,7 @@\n \n #include <addrman.h>\n #include <amount.h>\n+#include <banman.h>\n #include <chain.h>\n #include <chainparams.h>\n #include <checkpoints.h>"
      },
      {
        "sha": "c574f960e614e67dfead56496cdb2e5d897b6d1a",
        "filename": "src/interfaces/node.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/af3503d903b1a608cd212e2d74b274103199078c/src/interfaces/node.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/af3503d903b1a608cd212e2d74b274103199078c/src/interfaces/node.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/interfaces/node.cpp?ref=af3503d903b1a608cd212e2d74b274103199078c",
        "patch": "@@ -6,6 +6,7 @@\n \n #include <addrdb.h>\n #include <amount.h>\n+#include <banman.h>\n #include <chain.h>\n #include <chainparams.h>\n #include <init.h>"
      },
      {
        "sha": "54c2d78338528f940cba3dc04de1137df0f50444",
        "filename": "src/interfaces/node.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/af3503d903b1a608cd212e2d74b274103199078c/src/interfaces/node.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/af3503d903b1a608cd212e2d74b274103199078c/src/interfaces/node.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/interfaces/node.h?ref=af3503d903b1a608cd212e2d74b274103199078c",
        "patch": "@@ -18,6 +18,7 @@\n #include <tuple>\n #include <vector>\n \n+class BanMan;\n class CCoinControl;\n class CFeeRate;\n class CNodeStats;"
      },
      {
        "sha": "0490ccd6db54e4b6bc48fea3c8f36c4077c27e3b",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 189,
        "changes": 190,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/af3503d903b1a608cd212e2d74b274103199078c/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/af3503d903b1a608cd212e2d74b274103199078c/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=af3503d903b1a608cd212e2d74b274103199078c",
        "patch": "@@ -9,6 +9,7 @@\n \n #include <net.h>\n \n+#include <banman.h>\n #include <chainparams.h>\n #include <clientversion.h>\n #include <consensus/consensus.h>\n@@ -457,25 +458,6 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n     return pnode;\n }\n \n-void BanMan::DumpBanlist()\n-{\n-    SweepBanned(); // clean unused entries (if bantime has expired)\n-\n-    if (!BannedSetIsDirty())\n-        return;\n-\n-    int64_t nStart = GetTimeMillis();\n-\n-    banmap_t banmap;\n-    GetBanned(banmap);\n-    if (m_ban_db.Write(banmap)) {\n-        SetBannedSetDirty(false);\n-    }\n-\n-    LogPrint(BCLog::NET, \"Flushed %d banned node ips/subnets to banlist.dat  %dms\\n\",\n-        banmap.size(), GetTimeMillis() - nStart);\n-}\n-\n void CNode::CloseSocketDisconnect()\n {\n     fDisconnect = true;\n@@ -487,150 +469,6 @@ void CNode::CloseSocketDisconnect()\n     }\n }\n \n-void BanMan::ClearBanned()\n-{\n-    {\n-        LOCK(cs_setBanned);\n-        setBanned.clear();\n-        setBannedIsDirty = true;\n-    }\n-    DumpBanlist(); //store banlist to disk\n-    if(clientInterface)\n-        clientInterface->BannedListChanged();\n-}\n-\n-bool BanMan::IsBanned(CNetAddr ip)\n-{\n-    LOCK(cs_setBanned);\n-    for (const auto& it : setBanned) {\n-        CSubNet subNet = it.first;\n-        CBanEntry banEntry = it.second;\n-\n-        if (subNet.Match(ip) && GetTime() < banEntry.nBanUntil) {\n-            return true;\n-        }\n-    }\n-    return false;\n-}\n-\n-bool BanMan::IsBanned(CSubNet subnet)\n-{\n-    LOCK(cs_setBanned);\n-    banmap_t::iterator i = setBanned.find(subnet);\n-    if (i != setBanned.end())\n-    {\n-        CBanEntry banEntry = (*i).second;\n-        if (GetTime() < banEntry.nBanUntil) {\n-            return true;\n-        }\n-    }\n-    return false;\n-}\n-\n-void BanMan::Ban(const CNetAddr& addr, const BanReason &banReason, int64_t bantimeoffset, bool sinceUnixEpoch) {\n-    CSubNet subNet(addr);\n-    Ban(subNet, banReason, bantimeoffset, sinceUnixEpoch);\n-}\n-\n-void BanMan::Ban(const CSubNet& subNet, const BanReason &banReason, int64_t bantimeoffset, bool sinceUnixEpoch) {\n-    CBanEntry banEntry(GetTime());\n-    banEntry.banReason = banReason;\n-    if (bantimeoffset <= 0)\n-    {\n-        bantimeoffset = m_default_ban_time;\n-        sinceUnixEpoch = false;\n-    }\n-    banEntry.nBanUntil = (sinceUnixEpoch ? 0 : GetTime() )+bantimeoffset;\n-\n-    {\n-        LOCK(cs_setBanned);\n-        if (setBanned[subNet].nBanUntil < banEntry.nBanUntil) {\n-            setBanned[subNet] = banEntry;\n-            setBannedIsDirty = true;\n-        }\n-        else\n-            return;\n-    }\n-    if(clientInterface)\n-        clientInterface->BannedListChanged();\n-    if(banReason == BanReasonManuallyAdded)\n-        DumpBanlist(); //store banlist to disk immediately if user requested ban\n-}\n-\n-bool BanMan::Unban(const CNetAddr &addr) {\n-    CSubNet subNet(addr);\n-    return Unban(subNet);\n-}\n-\n-bool BanMan::Unban(const CSubNet &subNet) {\n-    {\n-        LOCK(cs_setBanned);\n-        if (!setBanned.erase(subNet))\n-            return false;\n-        setBannedIsDirty = true;\n-    }\n-    if(clientInterface)\n-        clientInterface->BannedListChanged();\n-    DumpBanlist(); //store banlist to disk immediately\n-    return true;\n-}\n-\n-void BanMan::GetBanned(banmap_t &banMap)\n-{\n-    LOCK(cs_setBanned);\n-    // Sweep the banlist so expired bans are not returned\n-    SweepBanned();\n-    banMap = setBanned; //create a thread safe copy\n-}\n-\n-void BanMan::SetBanned(const banmap_t &banMap)\n-{\n-    LOCK(cs_setBanned);\n-    setBanned = banMap;\n-    setBannedIsDirty = true;\n-}\n-\n-void BanMan::SweepBanned()\n-{\n-    int64_t now = GetTime();\n-    bool notifyUI = false;\n-    {\n-        LOCK(cs_setBanned);\n-        banmap_t::iterator it = setBanned.begin();\n-        while(it != setBanned.end())\n-        {\n-            CSubNet subNet = (*it).first;\n-            CBanEntry banEntry = (*it).second;\n-            if(now > banEntry.nBanUntil)\n-            {\n-                setBanned.erase(it++);\n-                setBannedIsDirty = true;\n-                notifyUI = true;\n-                LogPrint(BCLog::NET, \"%s: Removed banned node ip/subnet from banlist.dat: %s\\n\", __func__, subNet.ToString());\n-            }\n-            else\n-                ++it;\n-        }\n-    }\n-    // update UI\n-    if(notifyUI && clientInterface) {\n-        clientInterface->BannedListChanged();\n-    }\n-}\n-\n-bool BanMan::BannedSetIsDirty()\n-{\n-    LOCK(cs_setBanned);\n-    return setBannedIsDirty;\n-}\n-\n-void BanMan::SetBannedSetDirty(bool dirty)\n-{\n-    LOCK(cs_setBanned); //reuse setBanned lock for the isDirty flag\n-    setBannedIsDirty = dirty;\n-}\n-\n-\n bool CConnman::IsWhitelistedRange(const CNetAddr &addr) {\n     for (const CSubNet& subnet : vWhitelistedRange) {\n         if (subnet.Match(addr))\n@@ -2430,32 +2268,6 @@ bool CConnman::Start(CScheduler& scheduler, const Options& connOptions)\n     return true;\n }\n \n-BanMan::BanMan(fs::path ban_file, CClientUIInterface* client_interface, int64_t default_ban_time) : clientInterface(client_interface), m_ban_db(std::move(ban_file)), m_default_ban_time(default_ban_time)\n-{\n-    if (clientInterface) clientInterface->InitMessage(_(\"Loading banlist...\"));\n-\n-    int64_t nStart = GetTimeMillis();\n-    setBannedIsDirty = false;\n-    banmap_t banmap;\n-    if (m_ban_db.Read(banmap)) {\n-        SetBanned(banmap); // thread save setter\n-        SetBannedSetDirty(false); // no need to write down, just read data\n-        SweepBanned(); // sweep out unused entries\n-\n-        LogPrint(BCLog::NET, \"Loaded %d banned node ips/subnets from banlist.dat  %dms\\n\",\n-            banmap.size(), GetTimeMillis() - nStart);\n-    } else {\n-        LogPrintf(\"Invalid or missing banlist.dat; recreating\\n\");\n-        SetBannedSetDirty(true); // force write\n-        DumpBanlist();\n-    }\n-}\n-\n-BanMan::~BanMan()\n-{\n-    DumpBanlist();\n-}\n-\n class CNetCleanup\n {\n public:"
      },
      {
        "sha": "3606b4d7bafdf73a9ca073c292d65394e89c46b2",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 1,
        "deletions": 48,
        "changes": 49,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/af3503d903b1a608cd212e2d74b274103199078c/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/af3503d903b1a608cd212e2d74b274103199078c/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=af3503d903b1a608cd212e2d74b274103199078c",
        "patch": "@@ -37,6 +37,7 @@\n \n class CScheduler;\n class CNode;\n+class BanMan;\n \n /** Time between pings automatically sent out for latency probing and keepalive (in seconds). */\n static const int PING_INTERVAL = 2 * 60;\n@@ -85,9 +86,6 @@ static const bool DEFAULT_FORCEDNSSEED = false;\n static const size_t DEFAULT_MAXRECEIVEBUFFER = 5 * 1000;\n static const size_t DEFAULT_MAXSENDBUFFER    = 1 * 1000;\n \n-// NOTE: When adjusting this, update rpcnet:setban's help (\"24h\")\n-static constexpr unsigned int DEFAULT_MISBEHAVING_BANTIME = 60 * 60 * 24;  // Default 24-hour ban\n-\n typedef int64_t NodeId;\n \n struct AddedNodeInfo\n@@ -115,51 +113,6 @@ struct CSerializedNetMsg\n };\n \n \n-class BanMan\n-{\n-public:\n-    // Denial-of-service detection/prevention\n-    // The idea is to detect peers that are behaving\n-    // badly and disconnect/ban them, but do it in a\n-    // one-coding-mistake-won't-shatter-the-entire-network\n-    // way.\n-    // IMPORTANT:  There should be nothing I can give a\n-    // node that it will forward on that will make that\n-    // node's peers drop it. If there is, an attacker\n-    // can isolate a node and/or try to split the network.\n-    // Dropping a node for sending stuff that is invalid\n-    // now but might be valid in a later version is also\n-    // dangerous, because it can cause a network split\n-    // between nodes running old code and nodes running\n-    // new code.\n-    ~BanMan();\n-    BanMan(fs::path ban_file, CClientUIInterface* client_interface, int64_t default_ban_time);\n-    void Ban(const CNetAddr& netAddr, const BanReason& reason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n-    void Ban(const CSubNet& subNet, const BanReason& reason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n-    void ClearBanned(); // needed for unit testing\n-    bool IsBanned(CNetAddr ip);\n-    bool IsBanned(CSubNet subnet);\n-    bool Unban(const CNetAddr &ip);\n-    bool Unban(const CSubNet &ip);\n-    void GetBanned(banmap_t &banmap);\n-    void DumpBanlist();\n-\n-private:\n-    void SetBanned(const banmap_t &banmap);\n-    bool BannedSetIsDirty();\n-    //!set the \"dirty\" flag for the banlist\n-    void SetBannedSetDirty(bool dirty=true);\n-    //!clean unused entries (if bantime has expired)\n-    void SweepBanned();\n-\n-    banmap_t setBanned;\n-    CCriticalSection cs_setBanned;\n-    bool setBannedIsDirty;\n-    CClientUIInterface* clientInterface = nullptr;\n-    CBanDB m_ban_db;\n-    int64_t m_default_ban_time;\n-};\n-\n class NetEventsInterface;\n class CConnman\n {"
      },
      {
        "sha": "62b7d4e9668def68d00aa832c3e99fa66b9d764f",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/af3503d903b1a608cd212e2d74b274103199078c/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/af3503d903b1a608cd212e2d74b274103199078c/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=af3503d903b1a608cd212e2d74b274103199078c",
        "patch": "@@ -6,6 +6,7 @@\n #include <net_processing.h>\n \n #include <addrman.h>\n+#include <banman.h>\n #include <arith_uint256.h>\n #include <blockencodings.h>\n #include <chainparams.h>"
      },
      {
        "sha": "7994d3b125a8ce885ea0a70fe77b8980e5734a76",
        "filename": "src/rpc/net.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/af3503d903b1a608cd212e2d74b274103199078c/src/rpc/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/af3503d903b1a608cd212e2d74b274103199078c/src/rpc/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/net.cpp?ref=af3503d903b1a608cd212e2d74b274103199078c",
        "patch": "@@ -4,6 +4,7 @@\n \n #include <rpc/server.h>\n \n+#include <banman.h>\n #include <chainparams.h>\n #include <clientversion.h>\n #include <core_io.h>"
      },
      {
        "sha": "e5d62a3ab2ca0974d030923fc1f54b8ca7d4d100",
        "filename": "src/test/denialofservice_tests.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/af3503d903b1a608cd212e2d74b274103199078c/src/test/denialofservice_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/af3503d903b1a608cd212e2d74b274103199078c/src/test/denialofservice_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/denialofservice_tests.cpp?ref=af3503d903b1a608cd212e2d74b274103199078c",
        "patch": "@@ -4,6 +4,7 @@\n \n // Unit tests for denial-of-service detection/prevention code\n \n+#include <banman.h>\n #include <chainparams.h>\n #include <keystore.h>\n #include <net.h>"
      },
      {
        "sha": "ad7fa017109a7764a7a00e049890bc40522652de",
        "filename": "src/test/test_bitcoin.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/af3503d903b1a608cd212e2d74b274103199078c/src/test/test_bitcoin.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/af3503d903b1a608cd212e2d74b274103199078c/src/test/test_bitcoin.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/test_bitcoin.cpp?ref=af3503d903b1a608cd212e2d74b274103199078c",
        "patch": "@@ -4,6 +4,7 @@\n \n #include <test/test_bitcoin.h>\n \n+#include <banman.h>\n #include <chainparams.h>\n #include <consensus/consensus.h>\n #include <consensus/params.h>"
      },
      {
        "sha": "46b63b93b4a700092d25be55023e6c81c6f97ef8",
        "filename": "src/test/test_bitcoin_main.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/af3503d903b1a608cd212e2d74b274103199078c/src/test/test_bitcoin_main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/af3503d903b1a608cd212e2d74b274103199078c/src/test/test_bitcoin_main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/test_bitcoin_main.cpp?ref=af3503d903b1a608cd212e2d74b274103199078c",
        "patch": "@@ -4,6 +4,7 @@\n \n #define BOOST_TEST_MODULE Bitcoin Test Suite\n \n+#include <banman.h>\n #include <net.h>\n \n #include <memory>"
      }
    ]
  },
  {
    "sha": "84fc3fbd0304a7d6e660bf783c84bed2dd415141",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4NGZjM2ZiZDAzMDRhN2Q2ZTY2MGJmNzgzYzg0YmVkMmRkNDE1MTQx",
    "commit": {
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-10-05T21:04:14Z"
      },
      "committer": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2019-01-16T18:54:18Z"
      },
      "message": "scripted-diff: batch-rename BanMan members\n\n-BEGIN VERIFY SCRIPT-\nsed -i \"s/clientInterface/m_client_interface/g\" src/banman.h src/banman.cpp\nsed -i \"s/setBannedIsDirty/m_is_dirty/g\" src/banman.h src/banman.cpp\nsed -i \"s/cs_setBanned/m_cs_banned/g\" src/banman.h src/banman.cpp\nsed -i \"s/setBanned/m_banned/g\" src/banman.h src/banman.cpp\n-END VERIFY SCRIPT-",
      "tree": {
        "sha": "513bf05d76a930f193407dc1a62d526506ef3f2b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/513bf05d76a930f193407dc1a62d526506ef3f2b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/84fc3fbd0304a7d6e660bf783c84bed2dd415141",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/84fc3fbd0304a7d6e660bf783c84bed2dd415141",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/84fc3fbd0304a7d6e660bf783c84bed2dd415141",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/84fc3fbd0304a7d6e660bf783c84bed2dd415141/comments",
    "author": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "af3503d903b1a608cd212e2d74b274103199078c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/af3503d903b1a608cd212e2d74b274103199078c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/af3503d903b1a608cd212e2d74b274103199078c"
      }
    ],
    "stats": {
      "total": 82,
      "additions": 41,
      "deletions": 41
    },
    "files": [
      {
        "sha": "dc16aab2824c1fa8494a54e77ab1bb34b09b5d25",
        "filename": "src/banman.cpp",
        "status": "modified",
        "additions": 37,
        "deletions": 37,
        "changes": 74,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/84fc3fbd0304a7d6e660bf783c84bed2dd415141/src/banman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/84fc3fbd0304a7d6e660bf783c84bed2dd415141/src/banman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/banman.cpp?ref=84fc3fbd0304a7d6e660bf783c84bed2dd415141",
        "patch": "@@ -12,12 +12,12 @@\n \n \n BanMan::BanMan(fs::path ban_file, CClientUIInterface* client_interface, int64_t default_ban_time)\n-    : clientInterface(client_interface), m_ban_db(std::move(ban_file)), m_default_ban_time(default_ban_time)\n+    : m_client_interface(client_interface), m_ban_db(std::move(ban_file)), m_default_ban_time(default_ban_time)\n {\n-    if (clientInterface) clientInterface->InitMessage(_(\"Loading banlist...\"));\n+    if (m_client_interface) m_client_interface->InitMessage(_(\"Loading banlist...\"));\n \n     int64_t nStart = GetTimeMillis();\n-    setBannedIsDirty = false;\n+    m_is_dirty = false;\n     banmap_t banmap;\n     if (m_ban_db.Read(banmap)) {\n         SetBanned(banmap);        // thread save setter\n@@ -59,18 +59,18 @@ void BanMan::DumpBanlist()\n void BanMan::ClearBanned()\n {\n     {\n-        LOCK(cs_setBanned);\n-        setBanned.clear();\n-        setBannedIsDirty = true;\n+        LOCK(m_cs_banned);\n+        m_banned.clear();\n+        m_is_dirty = true;\n     }\n     DumpBanlist(); //store banlist to disk\n-    if (clientInterface) clientInterface->BannedListChanged();\n+    if (m_client_interface) m_client_interface->BannedListChanged();\n }\n \n bool BanMan::IsBanned(CNetAddr netAddr)\n {\n-    LOCK(cs_setBanned);\n-    for (const auto& it : setBanned) {\n+    LOCK(m_cs_banned);\n+    for (const auto& it : m_banned) {\n         CSubNet subNet = it.first;\n         CBanEntry banEntry = it.second;\n \n@@ -83,9 +83,9 @@ bool BanMan::IsBanned(CNetAddr netAddr)\n \n bool BanMan::IsBanned(CSubNet subNet)\n {\n-    LOCK(cs_setBanned);\n-    banmap_t::iterator i = setBanned.find(subNet);\n-    if (i != setBanned.end()) {\n+    LOCK(m_cs_banned);\n+    banmap_t::iterator i = m_banned.find(subNet);\n+    if (i != m_banned.end()) {\n         CBanEntry banEntry = (*i).second;\n         if (GetTime() < banEntry.nBanUntil) {\n             return true;\n@@ -111,14 +111,14 @@ void BanMan::Ban(const CSubNet& subNet, const BanReason& banReason, int64_t bant\n     banEntry.nBanUntil = (sinceUnixEpoch ? 0 : GetTime()) + bantimeoffset;\n \n     {\n-        LOCK(cs_setBanned);\n-        if (setBanned[subNet].nBanUntil < banEntry.nBanUntil) {\n-            setBanned[subNet] = banEntry;\n-            setBannedIsDirty = true;\n+        LOCK(m_cs_banned);\n+        if (m_banned[subNet].nBanUntil < banEntry.nBanUntil) {\n+            m_banned[subNet] = banEntry;\n+            m_is_dirty = true;\n         } else\n             return;\n     }\n-    if (clientInterface) clientInterface->BannedListChanged();\n+    if (m_client_interface) m_client_interface->BannedListChanged();\n \n     //store banlist to disk immediately if user requested ban\n     if (banReason == BanReasonManuallyAdded) DumpBanlist();\n@@ -133,63 +133,63 @@ bool BanMan::Unban(const CNetAddr& netAddr)\n bool BanMan::Unban(const CSubNet& subNet)\n {\n     {\n-        LOCK(cs_setBanned);\n-        if (setBanned.erase(subNet) == 0) return false;\n-        setBannedIsDirty = true;\n+        LOCK(m_cs_banned);\n+        if (m_banned.erase(subNet) == 0) return false;\n+        m_is_dirty = true;\n     }\n-    if (clientInterface) clientInterface->BannedListChanged();\n+    if (m_client_interface) m_client_interface->BannedListChanged();\n     DumpBanlist(); //store banlist to disk immediately\n     return true;\n }\n \n void BanMan::GetBanned(banmap_t& banMap)\n {\n-    LOCK(cs_setBanned);\n+    LOCK(m_cs_banned);\n     // Sweep the banlist so expired bans are not returned\n     SweepBanned();\n-    banMap = setBanned; //create a thread safe copy\n+    banMap = m_banned; //create a thread safe copy\n }\n \n void BanMan::SetBanned(const banmap_t& banMap)\n {\n-    LOCK(cs_setBanned);\n-    setBanned = banMap;\n-    setBannedIsDirty = true;\n+    LOCK(m_cs_banned);\n+    m_banned = banMap;\n+    m_is_dirty = true;\n }\n \n void BanMan::SweepBanned()\n {\n     int64_t now = GetTime();\n     bool notifyUI = false;\n     {\n-        LOCK(cs_setBanned);\n-        banmap_t::iterator it = setBanned.begin();\n-        while (it != setBanned.end()) {\n+        LOCK(m_cs_banned);\n+        banmap_t::iterator it = m_banned.begin();\n+        while (it != m_banned.end()) {\n             CSubNet subNet = (*it).first;\n             CBanEntry banEntry = (*it).second;\n             if (now > banEntry.nBanUntil) {\n-                setBanned.erase(it++);\n-                setBannedIsDirty = true;\n+                m_banned.erase(it++);\n+                m_is_dirty = true;\n                 notifyUI = true;\n                 LogPrint(BCLog::NET, \"%s: Removed banned node ip/subnet from banlist.dat: %s\\n\", __func__, subNet.ToString());\n             } else\n                 ++it;\n         }\n     }\n     // update UI\n-    if (notifyUI && clientInterface) {\n-        clientInterface->BannedListChanged();\n+    if (notifyUI && m_client_interface) {\n+        m_client_interface->BannedListChanged();\n     }\n }\n \n bool BanMan::BannedSetIsDirty()\n {\n-    LOCK(cs_setBanned);\n-    return setBannedIsDirty;\n+    LOCK(m_cs_banned);\n+    return m_is_dirty;\n }\n \n void BanMan::SetBannedSetDirty(bool dirty)\n {\n-    LOCK(cs_setBanned); //reuse setBanned lock for the setBannedIsDirty flag\n-    setBannedIsDirty = dirty;\n+    LOCK(m_cs_banned); //reuse m_banned lock for the m_is_dirty flag\n+    m_is_dirty = dirty;\n }"
      },
      {
        "sha": "9339717158db6f4b52320f77afd081615ad7aed7",
        "filename": "src/banman.h",
        "status": "modified",
        "additions": 4,
        "deletions": 4,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/84fc3fbd0304a7d6e660bf783c84bed2dd415141/src/banman.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/84fc3fbd0304a7d6e660bf783c84bed2dd415141/src/banman.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/banman.h?ref=84fc3fbd0304a7d6e660bf783c84bed2dd415141",
        "patch": "@@ -57,10 +57,10 @@ class BanMan\n     //!clean unused entries (if bantime has expired)\n     void SweepBanned();\n \n-    banmap_t setBanned;\n-    CCriticalSection cs_setBanned;\n-    bool setBannedIsDirty;\n-    CClientUIInterface* clientInterface = nullptr;\n+    banmap_t m_banned;\n+    CCriticalSection m_cs_banned;\n+    bool m_is_dirty;\n+    CClientUIInterface* m_client_interface = nullptr;\n     CBanDB m_ban_db;\n     int64_t m_default_ban_time;\n };"
      }
    ]
  },
  {
    "sha": "daae598feb034f2f56e0b00ecfb4854d693d3641",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkYWFlNTk4ZmViMDM0ZjJmNTZlMGIwMGVjZmI0ODU0ZDY5M2QzNjQx",
    "commit": {
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-10-06T20:56:56Z"
      },
      "committer": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2019-01-16T18:54:18Z"
      },
      "message": "banman: add thread annotations and mark members const where possible\n\nAlso remove misleading comment. ClearBanned is used by rpc as well.",
      "tree": {
        "sha": "6c1e9cb8ddcca970d712c467d23a7db3b3e6e029",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6c1e9cb8ddcca970d712c467d23a7db3b3e6e029"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/daae598feb034f2f56e0b00ecfb4854d693d3641",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/daae598feb034f2f56e0b00ecfb4854d693d3641",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/daae598feb034f2f56e0b00ecfb4854d693d3641",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/daae598feb034f2f56e0b00ecfb4854d693d3641/comments",
    "author": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "84fc3fbd0304a7d6e660bf783c84bed2dd415141",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/84fc3fbd0304a7d6e660bf783c84bed2dd415141",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/84fc3fbd0304a7d6e660bf783c84bed2dd415141"
      }
    ],
    "stats": {
      "total": 8,
      "additions": 4,
      "deletions": 4
    },
    "files": [
      {
        "sha": "61200dbe96481085de889e81b82a06d7ac21c36e",
        "filename": "src/banman.h",
        "status": "modified",
        "additions": 4,
        "deletions": 4,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/daae598feb034f2f56e0b00ecfb4854d693d3641/src/banman.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/daae598feb034f2f56e0b00ecfb4854d693d3641/src/banman.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/banman.h?ref=daae598feb034f2f56e0b00ecfb4854d693d3641",
        "patch": "@@ -41,7 +41,7 @@ class BanMan\n     BanMan(fs::path ban_file, CClientUIInterface* client_interface, int64_t default_ban_time);\n     void Ban(const CNetAddr& netAddr, const BanReason& banReason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n     void Ban(const CSubNet& subNet, const BanReason& banReason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n-    void ClearBanned(); // needed for unit testing\n+    void ClearBanned();\n     bool IsBanned(CNetAddr netAddr);\n     bool IsBanned(CSubNet subNet);\n     bool Unban(const CNetAddr& netAddr);\n@@ -57,12 +57,12 @@ class BanMan\n     //!clean unused entries (if bantime has expired)\n     void SweepBanned();\n \n-    banmap_t m_banned;\n     CCriticalSection m_cs_banned;\n-    bool m_is_dirty;\n+    banmap_t m_banned GUARDED_BY(m_cs_banned);\n+    bool m_is_dirty GUARDED_BY(m_cs_banned);\n     CClientUIInterface* m_client_interface = nullptr;\n     CBanDB m_ban_db;\n-    int64_t m_default_ban_time;\n+    const int64_t m_default_ban_time;\n };\n \n extern std::unique_ptr<BanMan> g_banman;"
      }
    ]
  },
  {
    "sha": "1ffa4ce27d4ea6c1067d8984455df97994c7713e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxZmZhNGNlMjdkNGVhNmMxMDY3ZDg5ODQ0NTVkZjk3OTk0Yzc3MTNl",
    "commit": {
      "author": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2018-10-31T04:13:13Z"
      },
      "committer": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2019-01-16T18:54:18Z"
      },
      "message": "banman: reformulate nBanUtil calculation\n\nAvoid reassigning parameters.",
      "tree": {
        "sha": "803808d1bc193d25b7955b40a8e989b5c32455d9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/803808d1bc193d25b7955b40a8e989b5c32455d9"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1ffa4ce27d4ea6c1067d8984455df97994c7713e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1ffa4ce27d4ea6c1067d8984455df97994c7713e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1ffa4ce27d4ea6c1067d8984455df97994c7713e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1ffa4ce27d4ea6c1067d8984455df97994c7713e/comments",
    "author": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "daae598feb034f2f56e0b00ecfb4854d693d3641",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/daae598feb034f2f56e0b00ecfb4854d693d3641",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/daae598feb034f2f56e0b00ecfb4854d693d3641"
      }
    ],
    "stats": {
      "total": 9,
      "additions": 6,
      "deletions": 3
    },
    "files": [
      {
        "sha": "19c8e375235eed686716e6be7ca78a5784d675fc",
        "filename": "src/banman.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 3,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1ffa4ce27d4ea6c1067d8984455df97994c7713e/src/banman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1ffa4ce27d4ea6c1067d8984455df97994c7713e/src/banman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/banman.cpp?ref=1ffa4ce27d4ea6c1067d8984455df97994c7713e",
        "patch": "@@ -104,11 +104,14 @@ void BanMan::Ban(const CSubNet& subNet, const BanReason& banReason, int64_t bant\n {\n     CBanEntry banEntry(GetTime());\n     banEntry.banReason = banReason;\n+\n+    int64_t normalized_bantimeoffset = bantimeoffset;\n+    bool normalized_sinceUnixEpoch = sinceUnixEpoch;\n     if (bantimeoffset <= 0) {\n-        bantimeoffset = m_default_ban_time;\n-        sinceUnixEpoch = false;\n+        normalized_bantimeoffset = m_default_ban_time;\n+        normalized_sinceUnixEpoch = false;\n     }\n-    banEntry.nBanUntil = (sinceUnixEpoch ? 0 : GetTime()) + bantimeoffset;\n+    banEntry.nBanUntil = (normalized_sinceUnixEpoch ? 0 : GetTime()) + normalized_bantimeoffset;\n \n     {\n         LOCK(m_cs_banned);"
      }
    ]
  },
  {
    "sha": "c2e04d37f3841d109c1fe60693f9622e2836cc29",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjMmUwNGQzN2YzODQxZDEwOWMxZmU2MDY5M2Y5NjIyZTI4MzZjYzI5",
    "commit": {
      "author": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2019-01-03T13:26:10Z"
      },
      "committer": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2019-01-16T18:54:18Z"
      },
      "message": "banman: Add, use CBanEntry ctor that takes ban reason",
      "tree": {
        "sha": "3c47144e669133047f96c5df6b61acf997d6e178",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3c47144e669133047f96c5df6b61acf997d6e178"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c2e04d37f3841d109c1fe60693f9622e2836cc29",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c2e04d37f3841d109c1fe60693f9622e2836cc29",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c2e04d37f3841d109c1fe60693f9622e2836cc29",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c2e04d37f3841d109c1fe60693f9622e2836cc29/comments",
    "author": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1ffa4ce27d4ea6c1067d8984455df97994c7713e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1ffa4ce27d4ea6c1067d8984455df97994c7713e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1ffa4ce27d4ea6c1067d8984455df97994c7713e"
      }
    ],
    "stats": {
      "total": 8,
      "additions": 6,
      "deletions": 2
    },
    "files": [
      {
        "sha": "290b63dd1288d908d366fc1f30fbf87f5ebef7a2",
        "filename": "src/addrdb.h",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c2e04d37f3841d109c1fe60693f9622e2836cc29/src/addrdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c2e04d37f3841d109c1fe60693f9622e2836cc29/src/addrdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/addrdb.h?ref=c2e04d37f3841d109c1fe60693f9622e2836cc29",
        "patch": "@@ -43,6 +43,11 @@ class CBanEntry\n         nCreateTime = nCreateTimeIn;\n     }\n \n+    explicit CBanEntry(int64_t n_create_time_in, BanReason ban_reason_in) : CBanEntry(n_create_time_in)\n+    {\n+        banReason = ban_reason_in;\n+    }\n+\n     ADD_SERIALIZE_METHODS;\n \n     template <typename Stream, typename Operation>"
      },
      {
        "sha": "56cbe941c68d0ba7492adeb78fadda62293afcd8",
        "filename": "src/banman.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 2,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c2e04d37f3841d109c1fe60693f9622e2836cc29/src/banman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c2e04d37f3841d109c1fe60693f9622e2836cc29/src/banman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/banman.cpp?ref=c2e04d37f3841d109c1fe60693f9622e2836cc29",
        "patch": "@@ -102,8 +102,7 @@ void BanMan::Ban(const CNetAddr& netAddr, const BanReason& banReason, int64_t ba\n \n void BanMan::Ban(const CSubNet& subNet, const BanReason& banReason, int64_t bantimeoffset, bool sinceUnixEpoch)\n {\n-    CBanEntry banEntry(GetTime());\n-    banEntry.banReason = banReason;\n+    CBanEntry banEntry(GetTime(), banReason);\n \n     int64_t normalized_bantimeoffset = bantimeoffset;\n     bool normalized_sinceUnixEpoch = sinceUnixEpoch;"
      }
    ]
  },
  {
    "sha": "18185b57c32d0a43afeca4c125b9352c692923e9",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxODE4NWI1N2MzMmQwYTQzYWZlY2E0YzEyNWI5MzUyYzY5MjkyM2U5",
    "commit": {
      "author": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2018-10-31T04:33:27Z"
      },
      "committer": {
        "name": "Carl Dong",
        "email": "accounts@carldong.me",
        "date": "2019-01-16T18:54:18Z"
      },
      "message": "scripted-diff: batch-recase BanMan variables\n\n-BEGIN VERIFY SCRIPT-\nsed -i \"s/banMap/banmap/g\" src/banman.h src/banman.cpp\nsed -i \"s/netAddr/net_addr/g\" src/banman.h src/banman.cpp\nsed -i \"s/sinceUnixEpoch/since_unix_epoch/g\" src/banman.h src/banman.cpp\nsed -i \"s/bantimeoffset/ban_time_offset/g\" src/banman.h src/banman.cpp\nsed -i \"s/subNet/sub_net/g\" src/banman.h src/banman.cpp\nsed -i \"s/banReason/ban_reason/g\" src/banman.h src/banman.cpp\nsed -i \"s/notifyUI/notify_ui/g\" src/banman.h src/banman.cpp\nsed -i \"s/banEntry/ban_entry/g\" src/banman.h src/banman.cpp\nsed -i \"s/nStart/n_start/g\" src/banman.h src/banman.cpp\n-END VERIFY SCRIPT-",
      "tree": {
        "sha": "a8db1dd53d7fc5a5e1d5963bab0ff0c9fecc35bd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a8db1dd53d7fc5a5e1d5963bab0ff0c9fecc35bd"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/18185b57c32d0a43afeca4c125b9352c692923e9",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/18185b57c32d0a43afeca4c125b9352c692923e9",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/18185b57c32d0a43afeca4c125b9352c692923e9",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/18185b57c32d0a43afeca4c125b9352c692923e9/comments",
    "author": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dongcarl",
      "id": 3445290,
      "node_id": "MDQ6VXNlcjM0NDUyOTA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3445290?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dongcarl",
      "html_url": "https://github.com/dongcarl",
      "followers_url": "https://api.github.com/users/dongcarl/followers",
      "following_url": "https://api.github.com/users/dongcarl/following{/other_user}",
      "gists_url": "https://api.github.com/users/dongcarl/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dongcarl/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dongcarl/subscriptions",
      "organizations_url": "https://api.github.com/users/dongcarl/orgs",
      "repos_url": "https://api.github.com/users/dongcarl/repos",
      "events_url": "https://api.github.com/users/dongcarl/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dongcarl/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c2e04d37f3841d109c1fe60693f9622e2836cc29",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c2e04d37f3841d109c1fe60693f9622e2836cc29",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c2e04d37f3841d109c1fe60693f9622e2836cc29"
      }
    ],
    "stats": {
      "total": 100,
      "additions": 50,
      "deletions": 50
    },
    "files": [
      {
        "sha": "9933c829c5700a25886263e3a6ad88bbe53cb841",
        "filename": "src/banman.cpp",
        "status": "modified",
        "additions": 42,
        "deletions": 42,
        "changes": 84,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/18185b57c32d0a43afeca4c125b9352c692923e9/src/banman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/18185b57c32d0a43afeca4c125b9352c692923e9/src/banman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/banman.cpp?ref=18185b57c32d0a43afeca4c125b9352c692923e9",
        "patch": "@@ -16,7 +16,7 @@ BanMan::BanMan(fs::path ban_file, CClientUIInterface* client_interface, int64_t\n {\n     if (m_client_interface) m_client_interface->InitMessage(_(\"Loading banlist...\"));\n \n-    int64_t nStart = GetTimeMillis();\n+    int64_t n_start = GetTimeMillis();\n     m_is_dirty = false;\n     banmap_t banmap;\n     if (m_ban_db.Read(banmap)) {\n@@ -25,7 +25,7 @@ BanMan::BanMan(fs::path ban_file, CClientUIInterface* client_interface, int64_t\n         SweepBanned();            // sweep out unused entries\n \n         LogPrint(BCLog::NET, \"Loaded %d banned node ips/subnets from banlist.dat  %dms\\n\",\n-            banmap.size(), GetTimeMillis() - nStart);\n+            banmap.size(), GetTimeMillis() - n_start);\n     } else {\n         LogPrintf(\"Invalid or missing banlist.dat; recreating\\n\");\n         SetBannedSetDirty(true); // force write\n@@ -44,7 +44,7 @@ void BanMan::DumpBanlist()\n \n     if (!BannedSetIsDirty()) return;\n \n-    int64_t nStart = GetTimeMillis();\n+    int64_t n_start = GetTimeMillis();\n \n     banmap_t banmap;\n     GetBanned(banmap);\n@@ -53,7 +53,7 @@ void BanMan::DumpBanlist()\n     }\n \n     LogPrint(BCLog::NET, \"Flushed %d banned node ips/subnets to banlist.dat  %dms\\n\",\n-        banmap.size(), GetTimeMillis() - nStart);\n+        banmap.size(), GetTimeMillis() - n_start);\n }\n \n void BanMan::ClearBanned()\n@@ -67,119 +67,119 @@ void BanMan::ClearBanned()\n     if (m_client_interface) m_client_interface->BannedListChanged();\n }\n \n-bool BanMan::IsBanned(CNetAddr netAddr)\n+bool BanMan::IsBanned(CNetAddr net_addr)\n {\n     LOCK(m_cs_banned);\n     for (const auto& it : m_banned) {\n-        CSubNet subNet = it.first;\n-        CBanEntry banEntry = it.second;\n+        CSubNet sub_net = it.first;\n+        CBanEntry ban_entry = it.second;\n \n-        if (subNet.Match(netAddr) && GetTime() < banEntry.nBanUntil) {\n+        if (sub_net.Match(net_addr) && GetTime() < ban_entry.nBanUntil) {\n             return true;\n         }\n     }\n     return false;\n }\n \n-bool BanMan::IsBanned(CSubNet subNet)\n+bool BanMan::IsBanned(CSubNet sub_net)\n {\n     LOCK(m_cs_banned);\n-    banmap_t::iterator i = m_banned.find(subNet);\n+    banmap_t::iterator i = m_banned.find(sub_net);\n     if (i != m_banned.end()) {\n-        CBanEntry banEntry = (*i).second;\n-        if (GetTime() < banEntry.nBanUntil) {\n+        CBanEntry ban_entry = (*i).second;\n+        if (GetTime() < ban_entry.nBanUntil) {\n             return true;\n         }\n     }\n     return false;\n }\n \n-void BanMan::Ban(const CNetAddr& netAddr, const BanReason& banReason, int64_t bantimeoffset, bool sinceUnixEpoch)\n+void BanMan::Ban(const CNetAddr& net_addr, const BanReason& ban_reason, int64_t ban_time_offset, bool since_unix_epoch)\n {\n-    CSubNet subNet(netAddr);\n-    Ban(subNet, banReason, bantimeoffset, sinceUnixEpoch);\n+    CSubNet sub_net(net_addr);\n+    Ban(sub_net, ban_reason, ban_time_offset, since_unix_epoch);\n }\n \n-void BanMan::Ban(const CSubNet& subNet, const BanReason& banReason, int64_t bantimeoffset, bool sinceUnixEpoch)\n+void BanMan::Ban(const CSubNet& sub_net, const BanReason& ban_reason, int64_t ban_time_offset, bool since_unix_epoch)\n {\n-    CBanEntry banEntry(GetTime(), banReason);\n+    CBanEntry ban_entry(GetTime(), ban_reason);\n \n-    int64_t normalized_bantimeoffset = bantimeoffset;\n-    bool normalized_sinceUnixEpoch = sinceUnixEpoch;\n-    if (bantimeoffset <= 0) {\n-        normalized_bantimeoffset = m_default_ban_time;\n-        normalized_sinceUnixEpoch = false;\n+    int64_t normalized_ban_time_offset = ban_time_offset;\n+    bool normalized_since_unix_epoch = since_unix_epoch;\n+    if (ban_time_offset <= 0) {\n+        normalized_ban_time_offset = m_default_ban_time;\n+        normalized_since_unix_epoch = false;\n     }\n-    banEntry.nBanUntil = (normalized_sinceUnixEpoch ? 0 : GetTime()) + normalized_bantimeoffset;\n+    ban_entry.nBanUntil = (normalized_since_unix_epoch ? 0 : GetTime()) + normalized_ban_time_offset;\n \n     {\n         LOCK(m_cs_banned);\n-        if (m_banned[subNet].nBanUntil < banEntry.nBanUntil) {\n-            m_banned[subNet] = banEntry;\n+        if (m_banned[sub_net].nBanUntil < ban_entry.nBanUntil) {\n+            m_banned[sub_net] = ban_entry;\n             m_is_dirty = true;\n         } else\n             return;\n     }\n     if (m_client_interface) m_client_interface->BannedListChanged();\n \n     //store banlist to disk immediately if user requested ban\n-    if (banReason == BanReasonManuallyAdded) DumpBanlist();\n+    if (ban_reason == BanReasonManuallyAdded) DumpBanlist();\n }\n \n-bool BanMan::Unban(const CNetAddr& netAddr)\n+bool BanMan::Unban(const CNetAddr& net_addr)\n {\n-    CSubNet subNet(netAddr);\n-    return Unban(subNet);\n+    CSubNet sub_net(net_addr);\n+    return Unban(sub_net);\n }\n \n-bool BanMan::Unban(const CSubNet& subNet)\n+bool BanMan::Unban(const CSubNet& sub_net)\n {\n     {\n         LOCK(m_cs_banned);\n-        if (m_banned.erase(subNet) == 0) return false;\n+        if (m_banned.erase(sub_net) == 0) return false;\n         m_is_dirty = true;\n     }\n     if (m_client_interface) m_client_interface->BannedListChanged();\n     DumpBanlist(); //store banlist to disk immediately\n     return true;\n }\n \n-void BanMan::GetBanned(banmap_t& banMap)\n+void BanMan::GetBanned(banmap_t& banmap)\n {\n     LOCK(m_cs_banned);\n     // Sweep the banlist so expired bans are not returned\n     SweepBanned();\n-    banMap = m_banned; //create a thread safe copy\n+    banmap = m_banned; //create a thread safe copy\n }\n \n-void BanMan::SetBanned(const banmap_t& banMap)\n+void BanMan::SetBanned(const banmap_t& banmap)\n {\n     LOCK(m_cs_banned);\n-    m_banned = banMap;\n+    m_banned = banmap;\n     m_is_dirty = true;\n }\n \n void BanMan::SweepBanned()\n {\n     int64_t now = GetTime();\n-    bool notifyUI = false;\n+    bool notify_ui = false;\n     {\n         LOCK(m_cs_banned);\n         banmap_t::iterator it = m_banned.begin();\n         while (it != m_banned.end()) {\n-            CSubNet subNet = (*it).first;\n-            CBanEntry banEntry = (*it).second;\n-            if (now > banEntry.nBanUntil) {\n+            CSubNet sub_net = (*it).first;\n+            CBanEntry ban_entry = (*it).second;\n+            if (now > ban_entry.nBanUntil) {\n                 m_banned.erase(it++);\n                 m_is_dirty = true;\n-                notifyUI = true;\n-                LogPrint(BCLog::NET, \"%s: Removed banned node ip/subnet from banlist.dat: %s\\n\", __func__, subNet.ToString());\n+                notify_ui = true;\n+                LogPrint(BCLog::NET, \"%s: Removed banned node ip/subnet from banlist.dat: %s\\n\", __func__, sub_net.ToString());\n             } else\n                 ++it;\n         }\n     }\n     // update UI\n-    if (notifyUI && m_client_interface) {\n+    if (notify_ui && m_client_interface) {\n         m_client_interface->BannedListChanged();\n     }\n }"
      },
      {
        "sha": "69f62be3689fdbe557864f845fc266924911c104",
        "filename": "src/banman.h",
        "status": "modified",
        "additions": 8,
        "deletions": 8,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/18185b57c32d0a43afeca4c125b9352c692923e9/src/banman.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/18185b57c32d0a43afeca4c125b9352c692923e9/src/banman.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/banman.h?ref=18185b57c32d0a43afeca4c125b9352c692923e9",
        "patch": "@@ -39,18 +39,18 @@ class BanMan\n public:\n     ~BanMan();\n     BanMan(fs::path ban_file, CClientUIInterface* client_interface, int64_t default_ban_time);\n-    void Ban(const CNetAddr& netAddr, const BanReason& banReason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n-    void Ban(const CSubNet& subNet, const BanReason& banReason, int64_t bantimeoffset = 0, bool sinceUnixEpoch = false);\n+    void Ban(const CNetAddr& net_addr, const BanReason& ban_reason, int64_t ban_time_offset = 0, bool since_unix_epoch = false);\n+    void Ban(const CSubNet& sub_net, const BanReason& ban_reason, int64_t ban_time_offset = 0, bool since_unix_epoch = false);\n     void ClearBanned();\n-    bool IsBanned(CNetAddr netAddr);\n-    bool IsBanned(CSubNet subNet);\n-    bool Unban(const CNetAddr& netAddr);\n-    bool Unban(const CSubNet& subNet);\n-    void GetBanned(banmap_t& banMap);\n+    bool IsBanned(CNetAddr net_addr);\n+    bool IsBanned(CSubNet sub_net);\n+    bool Unban(const CNetAddr& net_addr);\n+    bool Unban(const CSubNet& sub_net);\n+    void GetBanned(banmap_t& banmap);\n     void DumpBanlist();\n \n private:\n-    void SetBanned(const banmap_t& banMap);\n+    void SetBanned(const banmap_t& banmap);\n     bool BannedSetIsDirty();\n     //!set the \"dirty\" flag for the banlist\n     void SetBannedSetDirty(bool dirty = true);"
      }
    ]
  }
]