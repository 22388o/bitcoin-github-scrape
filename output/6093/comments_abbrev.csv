laanwj,2015-05-01T12:15:39Z,"Good catch. I already fixed this once before, people really shouldn't be touching this 'magic' code. Maybe add a comment referring to the issue.\n",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98120925,98120925,
laanwj,2015-05-01T12:21:10Z,"This will likely bring back issue #3136 (solved by #5877). You should imbue _some_ locale on WIN32, I'm not sure which one, but indeed `C` is wrong.\nMaybe the result of `std::locale("""")`? what does boost lazily initialize it to?\n",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98122033,98122033,
jonasschnelli,2015-05-01T13:03:24Z,Right. This is not the right approach.\nWas trying to go down the rabbit hole of win/unicode handling...\nCan't find a solution. It seems that it could also be a compiler wchar issue.\nIt looks like that the default locale is `C`?\n\nI could also guess that it might be connected to https://github.com/bitcoin/bitcoin/blob/master/src/util.cpp#L672 `SHGetSpecialFolderPathA`. The A stands for ANSI. Th,https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98128744,98128744,
laanwj,2015-05-01T13:48:33Z,"In windows the file system locale depends on the user locale. I think it only works if boost uses the same locale as windows. But I'm not sure anymore how this was determined. I got it to work once, hence it worked in 0.10...\n(using the W\* functions is out of the question unless you use them _everywhere_ and that'd involve a lot of platform specific code as well as widechar to UTF-8 conversion)\",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98138377,98138377,
dexX7,2015-05-01T13:54:00Z,"@jonasschnelli: using the ""C"" locale to imbue `boost::filesystem::path` indeed triggers the failure on Windows in this context.\n\nThere is more than one problem tackled by `SetupEnvironment()`:\n1. On POSIX systems, messed up environment settings can cause a failure ([Python test](https://gist.github.com/dexX7/ab3f7411a9040e96d55c)).\n2. During the deinitialization, an internal facet pointer of `",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98139231,98139231,
laanwj,2015-05-01T15:47:59Z,"Arguably the new problem is worse, as it prevents people from running the client at all with some characters in their data directories, instead of a rare shutdown race. What about:\n\n``` c++\n    std::locale loc(""C"");\n    // On most POSIX systems (e.g. Linux, but not BSD) the environment's locale\n    // may be invalid, in which case the ""C"" locale is used as fallback.\n    try {\n        loc = ",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98162584,98162584,
jonasschnelli,2015-05-01T16:33:30Z,"@laanwj i tried you proposed code and it does not fix the problem. Maybe it would be worth to revert #5877 and find a proper solution.\n\nWhat really surprises me: At least since 0.9.2 (didn't try further down), bitcoind and Bitcoin-Qt does not run with a datadir-path containing special Chinese or other Asian chars (Windows only).\n",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98173470,98173470,
dexX7,2015-05-01T17:45:21Z,"boost::filesystem::path::imbue() returns the ""previously used locale"", which should be the ""right one"", if called in a pristine environment, or to put it another way: if imbue() wouldn't be called at all, then this appears to be the one fs::path would use.\n\nIn the following patch, a dummy locale is used to extract the internal locale, to use it explicitly, which seems to be a preferable choice, ",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98185779,98185779,
theuni,2015-05-01T20:23:47Z,"I think that's a bit circuitous. It works, but not for obvious reasons.\n\nThe returned loc from boost is the classic locale plus custom boost facet for windows. Otherwise, you could just replace the first call with std::locale().\n\nThe below is greatly simplified and I think it does what we want. Note that std::locale::global("""") does not work as intended on windows, presumably because we're sta",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98225181,98225181,
dexX7,2015-05-01T21:30:44Z,"@theuni: when building on Ubuntu 14.04, with `HOST=x86_64-w64-mingw32`, and the dependency packages provided via `depends`, I had to wrap `setenv` with `#if !defined(WIN32) ...`, because it would otherwise cause a build error.\n\nBack on Windows 8.1 x64, when [using bitcoin-qt.exe](https://gist.github.com/dexX7/7394a947b29c7d84c710#file-results_bitcoin-qt-log), the tricky paths, such as `..\Å“` and",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98242672,98242672,
jonasschnelli,2015-05-02T08:45:02Z,"Updated this PR with @theunis solution (fixed: added a `#if !defined(WIN32)` for `setenv()`).\nBuilt through gitian: https://builds.jonasschnelli.ch/pulls/6093/\n\nWon't run on win7 with a username containing Chinese chars (as it was with 0.9.3, 0.10.0, probably it was always like this).\n**But won't also run on win7 with a username containing Russian chars (where 0.9.3 and 0.10.0 was running okay",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98333186,98333186,
theuni,2015-05-02T14:43:18Z,"Ok, I've done more debugging here.\ntl;dr: After poking some more with even more variables, I think @dexX7's change is the right one.\n\n@jonasschnelli It works fine for me with a Chinese username. Turns out there's another variable: selected system ""Format"" in system location settings. Looks like that's what influences the default locale at runtime rather than the system locale.\n\nSome testing u",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98367514,98367514,
dexX7,2015-05-02T16:14:42Z,"@theuni: my idea was basically to get access and capture the whole following block, which uses different facets, depending on the OS and build: [boost-1.55.0/src/path.cpp#L792-L873](https://github.com/boostorg/filesystem/blob/boost-1.55.0/src/path.cpp#L792-L873), and then use it to properly ""initialize"" Boost path by the main thread with the correct locale, after taking care of bad environment set",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98374385,98374385,
sipa,2015-05-02T16:16:45Z,Can't we all just agree to go back to EBCDIC?\n,https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98374467,98374467,
laanwj,2015-05-04T08:49:04Z,"I preferred [PETSCII](https://en.wikipedia.org/wiki/PETSCII) :)\n\nQuestion: at least for the 0.10 branch, can you code this so that it doesn't affect behavior on non-Windows? I'd hate to release a 'fix' then break the Linux issue again, where an invalid locale prevents the application from starting.\n\n> Using @dexX7's trick, Chinese username with English Format does work. This is because of boos",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98639063,98639063,
jonasschnelli,2015-05-04T12:10:30Z,"Updated to make use of @dexX7 solution (https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98185779).\nI think this is okay for 0.11.\n\nIf there are no complains, i'll open a PR for the 0.10 branch with the same solution but only touching Win32 behavior (some ifdefs).\n",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98689436,98689436,
theuni,2015-05-04T13:58:30Z,"@dexX7 Thanks for sticking with this and explaining the issue well. It looks like it took me a little while to figure out exactly what you already had, I just had to work through it myself for it to make sense. Nice detective work!\n\n@laanwj Agreed on making it windows only for 0.10, and on adding comments.\n\nAdditionally, we're depending on internal boost workings here that may change in the fu",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98713996,98713996,
dexX7,2015-05-04T15:52:08Z,"> @laanwj: Question: at least for the 0.10 branch, can you code this so that it doesn't affect behavior on non-Windows? \n\nIs this the case? [Travis is happy](https://travis-ci.org/dexX7/bitcoin/builds/60885645) with the change applied on top of 0.10.1, and the bad-environment test passes as well. It does not bring back #3136, and at least to my understanding, it should restore the behavior of pr",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98763242,98763242,
theuni,2015-05-04T16:10:33Z,"@dexX7 If the test throws during initialization, then it will fail anyway, no? I don't see how that's a problem as it still indicates an error.\n",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-98768564,98768564,
jonasschnelli,2015-05-10T08:12:28Z,I lost track of this PR.\nHow we proceed here? @theuni @dexX7? Is this ready?\n\nMy tests still tell me that there are problems with special char datadir on windows (as it always was the case). Maybe this PR should concentrate on fixing #6078 without reintroducing #3136 (solved by #5877).\nThere will still be cases where bitcoind/qt won't start up. As example: if you use a Chinese username on a en,https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-100600384,100600384,
dexX7,2015-05-10T09:30:08Z,"> @jonasschnelli: As example: if you use a Chinese username on a english windows.\n\nIt's the best solution I've found, though this is still very unfortunate. As far as I can see, it restores the behavior of 0.9.3, without reintroducing #3136.\n",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-100612712,100612712,
jonasschnelli,2015-05-10T09:38:33Z,Okay. Then i think this is merge ready and should probably get a ACK/NACK from @theuni.\n@laanwj: Should we backport this (as it is) to 0.10 or should i create a PR where it only touches win32 codeflow?\n,https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-100614636,100614636,
laanwj,2015-05-10T12:27:44Z,Cherry-picked to 0.10 as 424ae66 (the change is now subtle enough that no  special path for WIN32 is necessary)\n,https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-100633314,100633314,
theuni,2015-05-10T17:00:23Z,post-merge ACK.\n,https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-100668510,100668510,
dexX7,2015-05-10T17:20:39Z,@laanwj: the current 0.10 tip doesn't include the changes of this PR?\n\nEdit: now I see it. :)\n,https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-100671037,100671037,
mart2038,2015-05-29T20:33:15Z,"post-merge comments. Kudos to you guys for sticking with a win32 issue, but... Why?  'They' say that coding for *nix is too human resource hungry due to intra-distribution incompatibilities... hmmmmm, Oooookay, if 'they' say so.\n\n@sipa @laanwj  EBCDIC, PETSCII You must have been rich!   ""When I were a lad"" (olde [Englysh](https://en.wikipedia.org/wiki/Jasper_Heywood#Works) comedy) we programmed ",https://github.com/bitcoin/bitcoin/pull/6093#issuecomment-106928012,106928012,
laanwj,2015-05-04T08:52:55Z,"Please correct instead of remove the comments. Esoteric knowledge about locales is needed to understand this on reading, heck, _we_ will have forgotten about the rationale for this in a few months.\n",https://github.com/bitcoin/bitcoin/pull/6093#discussion_r29572542,29572542,src/util.cpp
laanwj,2015-05-08T15:16:44Z,Duplicated comment :)\n,https://github.com/bitcoin/bitcoin/pull/6093#discussion_r29948062,29948062,src/util.cpp
jonasschnelli,2015-05-10T08:07:01Z,Fixed.\n,https://github.com/bitcoin/bitcoin/pull/6093#discussion_r29999839,29999839,src/util.cpp
