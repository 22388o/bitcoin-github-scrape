[
  {
    "sha": "47162673c79c757a9c038c4ddc41fb3022223bde",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0NzE2MjY3M2M3OWM3NTdhOWMwMzhjNGRkYzQxZmIzMDIyMjIzYmRl",
    "commit": {
      "author": {
        "name": "Wladimir J. van der Laan",
        "email": "laanwj@gmail.com",
        "date": "2015-07-01T15:38:15Z"
      },
      "committer": {
        "name": "Wladimir J. van der Laan",
        "email": "laanwj@gmail.com",
        "date": "2015-07-01T16:01:16Z"
      },
      "message": "Use real number of cores for default -par, ignore virtual cores\n\nTo determine the default for `-par`, the number of script verification\nthreads, use [boost::thread::physical_concurrency()](http://www.boost.org/doc/libs/1_58_0/doc/html/thread/thread_management.html#thread.thread_management.thread.physical_concurrency)\nwhich counts only physical cores, not virtual cores.\n\nVirtual cores are roughly a set of cached registers to avoid context\nswitches while threading, they cannot actually perform work, so spawning\na verification thread for them could even reduce efficiency and will put\nundue load on the system.\n\nShould fix issue #6358, as well as some other reported system overload\nissues, especially on Intel processors.\n\nThe function was only introduced in boost 1.56, so provide a utility\nfunction `GetNumCores` to fall back for older Boost versions.",
      "tree": {
        "sha": "eb472ad23b918630102983ba5ca776e8bb3c7016",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/eb472ad23b918630102983ba5ca776e8bb3c7016"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/47162673c79c757a9c038c4ddc41fb3022223bde",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/47162673c79c757a9c038c4ddc41fb3022223bde",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/47162673c79c757a9c038c4ddc41fb3022223bde",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/47162673c79c757a9c038c4ddc41fb3022223bde/comments",
    "author": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "da77a6f7611f71443914e1c71df1e52468cf507d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/da77a6f7611f71443914e1c71df1e52468cf507d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/da77a6f7611f71443914e1c71df1e52468cf507d"
      }
    ],
    "stats": {
      "total": 25,
      "additions": 21,
      "deletions": 4
    },
    "files": [
      {
        "sha": "de239df6b898800edf956911c174814e044660bc",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/47162673c79c757a9c038c4ddc41fb3022223bde/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/47162673c79c757a9c038c4ddc41fb3022223bde/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=47162673c79c757a9c038c4ddc41fb3022223bde",
        "patch": "@@ -283,7 +283,7 @@ std::string HelpMessage(HelpMessageMode mode)\n     strUsage += HelpMessageOpt(\"-loadblock=<file>\", _(\"Imports blocks from external blk000??.dat file\") + \" \" + _(\"on startup\"));\n     strUsage += HelpMessageOpt(\"-maxorphantx=<n>\", strprintf(_(\"Keep at most <n> unconnectable transactions in memory (default: %u)\"), DEFAULT_MAX_ORPHAN_TRANSACTIONS));\n     strUsage += HelpMessageOpt(\"-par=<n>\", strprintf(_(\"Set the number of script verification threads (%u to %d, 0 = auto, <0 = leave that many cores free, default: %d)\"),\n-        -(int)boost::thread::hardware_concurrency(), MAX_SCRIPTCHECK_THREADS, DEFAULT_SCRIPTCHECK_THREADS));\n+        -GetNumCores(), MAX_SCRIPTCHECK_THREADS, DEFAULT_SCRIPTCHECK_THREADS));\n #ifndef WIN32\n     strUsage += HelpMessageOpt(\"-pid=<file>\", strprintf(_(\"Specify pid file (default: %s)\"), \"bitcoind.pid\"));\n #endif\n@@ -774,7 +774,7 @@ bool AppInit2(boost::thread_group& threadGroup, CScheduler& scheduler)\n     // -par=0 means autodetect, but nScriptCheckThreads==0 means no concurrency\n     nScriptCheckThreads = GetArg(\"-par\", DEFAULT_SCRIPTCHECK_THREADS);\n     if (nScriptCheckThreads <= 0)\n-        nScriptCheckThreads += boost::thread::hardware_concurrency();\n+        nScriptCheckThreads += GetNumCores();\n     if (nScriptCheckThreads <= 1)\n         nScriptCheckThreads = 0;\n     else if (nScriptCheckThreads > MAX_SCRIPTCHECK_THREADS)"
      },
      {
        "sha": "57af2981ddf2a1aa3f89e8b4e5f10694655ff588",
        "filename": "src/miner.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/47162673c79c757a9c038c4ddc41fb3022223bde/src/miner.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/47162673c79c757a9c038c4ddc41fb3022223bde/src/miner.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/miner.cpp?ref=47162673c79c757a9c038c4ddc41fb3022223bde",
        "patch": "@@ -560,7 +560,7 @@ void GenerateBitcoins(bool fGenerate, CWallet* pwallet, int nThreads)\n         if (Params().DefaultMinerThreads())\n             nThreads = Params().DefaultMinerThreads();\n         else\n-            nThreads = boost::thread::hardware_concurrency();\n+            nThreads = GetNumCores();\n     }\n \n     if (minerThreads != NULL)"
      },
      {
        "sha": "87c727335eb83d902b5291e0bb26dd9abf3a939d",
        "filename": "src/qt/optionsdialog.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/47162673c79c757a9c038c4ddc41fb3022223bde/src/qt/optionsdialog.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/47162673c79c757a9c038c4ddc41fb3022223bde/src/qt/optionsdialog.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/optionsdialog.cpp?ref=47162673c79c757a9c038c4ddc41fb3022223bde",
        "patch": "@@ -42,7 +42,7 @@ OptionsDialog::OptionsDialog(QWidget *parent, bool enableWallet) :\n     /* Main elements init */\n     ui->databaseCache->setMinimum(nMinDbCache);\n     ui->databaseCache->setMaximum(nMaxDbCache);\n-    ui->threadsScriptVerif->setMinimum(-(int)boost::thread::hardware_concurrency());\n+    ui->threadsScriptVerif->setMinimum(-GetNumCores());\n     ui->threadsScriptVerif->setMaximum(MAX_SCRIPTCHECK_THREADS);\n \n     /* Network elements init */"
      },
      {
        "sha": "bb7df23205db3ca14705935ef9a7d373b55a855b",
        "filename": "src/util.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 0,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/47162673c79c757a9c038c4ddc41fb3022223bde/src/util.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/47162673c79c757a9c038c4ddc41fb3022223bde/src/util.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util.cpp?ref=47162673c79c757a9c038c4ddc41fb3022223bde",
        "patch": "@@ -756,3 +756,13 @@ void SetThreadPriority(int nPriority)\n #endif // PRIO_THREAD\n #endif // WIN32\n }\n+\n+int GetNumCores()\n+{\n+#if BOOST_VERSION >= 105600\n+    return boost::thread::physical_concurrency();\n+#else // Must fall back to hardware_concurrency, which unfortunately counts virtual cores\n+    return boost::thread::hardware_concurrency();\n+#endif\n+}\n+"
      },
      {
        "sha": "6019e25015147887c5c55cc7a3890acb88aa1de9",
        "filename": "src/util.h",
        "status": "modified",
        "additions": 7,
        "deletions": 0,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/47162673c79c757a9c038c4ddc41fb3022223bde/src/util.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/47162673c79c757a9c038c4ddc41fb3022223bde/src/util.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util.h?ref=47162673c79c757a9c038c4ddc41fb3022223bde",
        "patch": "@@ -199,6 +199,13 @@ std::string HelpMessageGroup(const std::string& message);\n  */\n std::string HelpMessageOpt(const std::string& option, const std::string& message);\n \n+/**\n+ * Return the number of physical cores available on the current system.\n+ * @note This does not count virtual cores, such as those provided by HyperThreading\n+ * when boost is newer than 1.56.\n+ */\n+int GetNumCores();\n+\n void SetThreadPriority(int nPriority);\n void RenameThread(const char* name);\n "
      }
    ]
  }
]