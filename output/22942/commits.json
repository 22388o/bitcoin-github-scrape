[
  {
    "sha": "0000dca6f0e4dda212bf8adf555b68f2c7464ff8",
    "node_id": "C_kwDOABII59oAKDAwMDBkY2E2ZjBlNGRkYTIxMmJmOGFkZjU1NWI2OGYyYzc0NjRmZjg",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2021-09-10T15:54:38Z"
      },
      "committer": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2021-09-22T08:39:08Z"
      },
      "message": "fuzz: Cleanup muhash fuzz target\n\nCan be reviewed with -W --ignore-all-space\n\nFixes:\n* Calling ConsumeRandomLengthByteVector 4 times, when 2 is enough.\n* Slow execution speed: Finalize is expensive because it invokes\n  division. Speed up the target by calling Finalize() at most twice per\n  fuzz input.",
      "tree": {
        "sha": "fff624c02304c8c3bb18be10d286a06b2b56626f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/fff624c02304c8c3bb18be10d286a06b2b56626f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0000dca6f0e4dda212bf8adf555b68f2c7464ff8",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unknown_key",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\npUgONQv/f788n1tgTcr8CPTvLlaYdzVoqzH9TpyGGwLxP+B7mDwBcC+tmbfuc16Q\n9Ae4AfG9SOLaRMZY3NuWN4uHFJylwaJC4KyL8m3o9eYNDUBnUZi2KmBBVeghxos0\nkGfs2XdRuuqsZm1208V7ilVm5afUPB0cTD+PDU64PXBaTrQPUcSjKF7Yfdt61waX\nP+MwrgLQMndc9ok06MWIqasxuNy5K1itRzVxoqC53Yyeg8GfgMky3RzwHZl7iTpB\nICbnKvVRWlsKGrsoJsUwFNVBZmN0vX/LaRmqOMwxKnBa6ZEqfL7Rp4oxWmT7lJPc\nQ4sO8Q93oe1W5Nh7xgK1SVVo6fIKDFM+wlgj18TJPaS7xJukGYmRrYYsEGtnwLis\nN2v2H+0efqt5HGqSaKp3GmpDiGcVemux3PNzi0axmMQZP9fpmUugzq+5pLl5lUDR\n7VXA5vWVci3pWWBaZaBbYYksY4+i97Stoew9gWb8usD3kiV1TCTvvoNYcMBL/j5I\nEuVs2WVe\n=rmHa\n-----END PGP SIGNATURE-----",
        "payload": "tree fff624c02304c8c3bb18be10d286a06b2b56626f\nparent 053a5fc7d912d597cd6dc7376b479420d1eae1c0\nauthor MarcoFalke <falke.marco@gmail.com> 1631289278 +0200\ncommitter MarcoFalke <falke.marco@gmail.com> 1632299948 +0200\n\nfuzz: Cleanup muhash fuzz target\n\nCan be reviewed with -W --ignore-all-space\n\nFixes:\n* Calling ConsumeRandomLengthByteVector 4 times, when 2 is enough.\n* Slow execution speed: Finalize is expensive because it invokes\n  division. Speed up the target by calling Finalize() at most twice per\n  fuzz input.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0000dca6f0e4dda212bf8adf555b68f2c7464ff8",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/0000dca6f0e4dda212bf8adf555b68f2c7464ff8",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0000dca6f0e4dda212bf8adf555b68f2c7464ff8/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "053a5fc7d912d597cd6dc7376b479420d1eae1c0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/053a5fc7d912d597cd6dc7376b479420d1eae1c0",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/053a5fc7d912d597cd6dc7376b479420d1eae1c0"
      }
    ],
    "stats": {
      "total": 73,
      "additions": 34,
      "deletions": 39
    },
    "files": [
      {
        "sha": "8304e6fdb87e933253058c81bb0d181072dd81ae",
        "filename": "src/test/fuzz/muhash.cpp",
        "status": "modified",
        "additions": 34,
        "deletions": 39,
        "changes": 73,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0000dca6f0e4dda212bf8adf555b68f2c7464ff8/src/test/fuzz/muhash.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0000dca6f0e4dda212bf8adf555b68f2c7464ff8/src/test/fuzz/muhash.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/fuzz/muhash.cpp?ref=0000dca6f0e4dda212bf8adf555b68f2c7464ff8",
        "patch": "@@ -12,52 +12,47 @@\n FUZZ_TARGET(muhash)\n {\n     FuzzedDataProvider fuzzed_data_provider{buffer.data(), buffer.size()};\n-    std::vector<uint8_t> data = ConsumeRandomLengthByteVector(fuzzed_data_provider);\n-    std::vector<uint8_t> data2 = ConsumeRandomLengthByteVector(fuzzed_data_provider);\n-    if (data.empty()) {\n-        data.resize(fuzzed_data_provider.ConsumeIntegralInRange<size_t>(1, 4096), fuzzed_data_provider.ConsumeIntegral<uint8_t>());\n-    }\n-    if (data2.empty()) {\n-        data2.resize(fuzzed_data_provider.ConsumeIntegralInRange<size_t>(1, 4096), fuzzed_data_provider.ConsumeIntegral<uint8_t>());\n-    }\n-\n-    data = ConsumeRandomLengthByteVector(fuzzed_data_provider);\n-    data2 = ConsumeRandomLengthByteVector(fuzzed_data_provider);\n+    std::vector<uint8_t> data{ConsumeRandomLengthByteVector(fuzzed_data_provider)};\n+    std::vector<uint8_t> data2{ConsumeRandomLengthByteVector(fuzzed_data_provider)};\n \n     MuHash3072 muhash;\n \n-    // Test that MuHash result is consistent independent of order of operations\n     muhash.Insert(data);\n     muhash.Insert(data2);\n \n+    const std::string initial_state_hash{\"dd5ad2a105c2d29495f577245c357409002329b9f4d6182c0af3dc2f462555c8\"};\n     uint256 out;\n-    muhash.Finalize(out);\n-\n-    muhash = MuHash3072();\n-    muhash.Insert(data2);\n-    muhash.Insert(data);\n-\n     uint256 out2;\n-    muhash.Finalize(out2);\n-\n+    CallOneOf(\n+        fuzzed_data_provider,\n+        [&] {\n+            // Test that MuHash result is consistent independent of order of operations\n+            muhash.Finalize(out);\n+\n+            muhash = MuHash3072();\n+            muhash.Insert(data2);\n+            muhash.Insert(data);\n+            muhash.Finalize(out2);\n+        },\n+        [&] {\n+            // Test that multiplication with the initial state never changes the finalized result\n+            muhash.Finalize(out);\n+            MuHash3072 muhash3;\n+            muhash3 *= muhash;\n+            muhash3.Finalize(out2);\n+        },\n+        [&] {\n+            // Test that dividing a MuHash by itself brings it back to it's initial state\n+            muhash /= muhash;\n+            muhash.Finalize(out);\n+            out2 = uint256S(initial_state_hash);\n+        },\n+        [&] {\n+            // Test that removing all added elements brings the object back to it's initial state\n+            muhash.Remove(data);\n+            muhash.Remove(data2);\n+            muhash.Finalize(out);\n+            out2 = uint256S(initial_state_hash);\n+        });\n     assert(out == out2);\n-    MuHash3072 muhash3;\n-    muhash3 *= muhash;\n-    uint256 out3;\n-    muhash3.Finalize(out3);\n-    assert(out == out3);\n-\n-    // Test that removing all added elements brings the object back to it's initial state\n-    muhash /= muhash;\n-    muhash.Finalize(out);\n-\n-    MuHash3072 muhash2;\n-    muhash2.Finalize(out2);\n-\n-    assert(out == out2);\n-\n-    muhash3.Remove(data);\n-    muhash3.Remove(data2);\n-    muhash3.Finalize(out3);\n-    assert(out == out3);\n }"
      }
    ]
  }
]