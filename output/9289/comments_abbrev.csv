laanwj,2016-12-06T12:24:00Z,Concept ACK,https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-265137401,265137401,
sipa,2016-12-06T19:35:25Z,Would it make sense to introduce a utility function like MilliSleep which takes a reference to a condition variable and an atomic flag? The pattern that replaces the MilliSleep calls is pretty complicated and repeats several times.,https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-265249618,265249618,
fanquake,2016-12-07T10:57:56Z,Concept ACK,https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-265417999,265417999,
theuni,2016-12-08T14:05:22Z,"@sipa Sure, will do.",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-265747217,265747217,
theuni,2016-12-09T01:07:07Z,"@sipa done. I'm not sure if it's generic enough to add to utiltime, happy to move it back to net if that makes more sense.\n\nAlso fixed up the TODO that I was mistaken about.",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-265904134,265904134,
theuni,2016-12-16T00:51:44Z,"Just noticed that this PR would've broken interruptible proxy recvs, so I pushed a commit to fix that. The proxy code will soon be dumped anyway, so I'm ok with the hackish global there for now.\n\nAlso squashed down the header fix while I was at it.",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-267488595,267488595,
JeremyRubin,2016-12-21T06:51:09Z,"@TheBlueMatt I think you might be confused as to how the atomic flags are used in this code. They're used in ""clear triggered mode"", so there is no need to reset them after every check. The other usage (""test_and_set triggered mode"") would introduce race conditions when the checking thread clears the flag as a concurrent interrupt could be cleared.",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268450262,268450262,
TheBlueMatt,2016-12-21T08:50:26Z,"@JeremyRubin I see how they're used, am only commenting on the likelihood of this pattern introducing future bugs. Eg someone uses break instead of return and then a loop gets moved around, making the thread no longer exit.\n\nOn December 20, 2016 10:51:14 PM PST, Jeremy Rubin <notifications@github.com> wrote:\n>@TheBlueMatt I think you might be confused as to how the atomic flags\n>are used in th",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268469097,268469097,
JeremyRubin,2016-12-21T19:19:24Z,"@TheBlueMatt ok I was responding to ""atomic_flags and resetting them to dont-wake every time you check them."", not sure what you meant by that if not my earlier interpretation.\n\nI agree with you on the semantics being off if your worry is future code breaking it. We should either make it throw an Interruption, or call std::terminate. Changing it to an atomic_bool will not have any effect on re",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268614837,268614837,
TheBlueMatt,2016-12-21T19:41:19Z,@JeremyRubin well my note was that if you use an atomic_bool instead of a flag (which means you can check without resetting the state to the dont-exit-now state) then even if there is a bug the worst that happens is you will exit the thread at the next check.,https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268619821,268619821,
TheBlueMatt,2016-12-21T20:06:50Z,"@JeremyRubin sadly I'm not sure about the execution propagation from within condition_variable...cppreference seems to indicate it was cleaned up in C++14, but its unclear if its guaranteed to propagation from the predicate or if it just ""may"".",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268625684,268625684,
JeremyRubin,2016-12-21T20:59:59Z,"Thanks for clarifying the kind of bug you were imagining, I had a different type of bug in mind (there being no code flow which can cause a termination, rather than being catchable on the next iteration).\n\nYou're absolutely right on the ""may"" for exceptions thrown from wait_for.  Semantics should be fixed now (moved InterruptibleSleep into interruption_point and made the throwing external to w",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268638123,268638123,
TheBlueMatt,2016-12-21T21:28:06Z,"@JeremyRubin ehh, I mean yes regaring wrappers, no regarding exceptions - I think its generally accepted that using exceptions in C++ is bad, and I'm not sure we want to add any more uses than we already have.",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268644797,268644797,
theuni,2016-12-22T02:43:56Z,"@JeremyRubin and @TheBlueMatt Thanks for having a look.\n\nAfter a debate (probably more than necessary), and running it by a third party, I think I'll concede and just use an atomic bool instead. The convincing argument was that a bool allows us to deviate from the current ""got an interrupt, bail from thread!"", and lets us do quick on-thread teardown post-interruption. It will need to stay in c",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268704281,268704281,
theuni,2016-12-22T07:19:55Z,"@TheBlueMatt I pushed up a new attempt to  https://github.com/theuni/bitcoin/commits/connman-threads-redo. I think you'll like that much better.\n\nI need to split a few non-obvious things into different commits, but mind having a quick look at the concept?\n\nI borrowed @JeremyRubin's wrapper idea but implemented it a bit differently: https://github.com/theuni/bitcoin/commit/7b4d8f608cca17fba",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268735467,268735467,
TheBlueMatt,2016-12-22T18:17:01Z,"@theuni Yup, really like that version.",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268858517,268858517,
theuni,2016-12-22T23:51:08Z,"Socket handler moved up just so that there's a consistent start/stop order.\n\nThanks for pointing out the MilliSleep, definitely not intentional!",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268916125,268916125,
TheBlueMatt,2016-12-23T00:04:55Z,"Yes, I guess my conception is different - if we make it a generic wrapper for condition variables then moving sleep into it would make sense. I thought some about what that would mean for net_processing, but missed that you'd need to expose the lock (exposing interrupt seems otherwise reasonable to me).\n\nNo longer convinced which one is nicer, up to you.\n\nOn December 22, 2016 3:48:21 PM PST, C",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268917829,268917829,
TheBlueMatt,2016-12-23T00:19:16Z,"Actually, I'm not sure you need to expose the lock, you just need to take the lock on the notifying thread prior to the notify but after setting the wakeup condition.\n\nIf you want to try it this way, I'd say you'd want to have two wakeup conditions, a wake-up and an interrupt condition, and just expose the various operations that you need. Not sure it's worth it, but I think that would be the cl",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268919416,268919416,
theuni,2016-12-23T01:02:42Z,"That would require the wakeup condition to be atomic, no?",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268923628,268923628,
TheBlueMatt,2016-12-23T02:16:38Z,"Yes, I believe that implies the wakeup condition must be atomic, but it can be release/acquire since a mutex unlock implies a full memory barrier.\n\nIn the other case that I proposed (doing it with two atomics - one for wake-up and one for interruption all hidden inside the object they would both be atomic and you'd want ClearWakeupState() and Wake() functions).\n\nOn December 22, 2016 5:02:46 PM",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-268930136,268930136,
theuni,2016-12-24T01:49:10Z,@TheBlueMatt Pushed a round of changes after last night's IRC discussion. I hope we can compromise on this approach.,https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-269063437,269063437,
TheBlueMatt,2016-12-24T02:05:03Z,"Looks good, will do a more thourough review when you add threadinterrupt.cpp to git :)",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-269063960,269063960,
theuni,2016-12-24T04:00:02Z,grr.. added.,https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-269067788,269067788,
TheBlueMatt,2016-12-24T18:39:26Z,"utACK 992bbc01a0d33fdf47a55336f82825f43ad29522\nYou can remove the boost/thread.hpp include in netbase now, I believe.",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-269095615,269095615,
theuni,2016-12-26T19:22:29Z,"Updated and squashed. The diff from 992bbc0 can be seen here: https://gist.github.com/theuni/32409c39e045cd3f2a6d6e4316d228ec.\n\nThe only things changed in the squash (can be seen in the diff above):\n- Rename interruptSocks5 to avoid a symbol with same-name-different-case (and make it static while we're at it)\n- Initialize the atomics in DoS_tests\n\nOne commit was added on top to cleanup",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-269236168,269236168,
theuni,2016-12-27T22:15:04Z,"@sipa reordered and fixed the ""if(""s. I didn't rebase for now to avoid invalidating @TheBlueMatt's review.",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-269390335,269390335,
theuni,2016-12-29T19:44:31Z,rebased at @TheBlueMatt's request.,https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-269682780,269682780,
theuni,2016-12-30T19:32:55Z,"Pushed a commit for @sipa's nits. I've been running my dev branches on top of this for several days, killing bitcoind in all kinds of rude ways while debugging, and it has continued to shutdown reliably.",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-269812676,269812676,
theuni,2016-12-30T20:20:11Z,"@sipa I figured you'd have more nits :)\n\nWent ahead and squashed.",https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-269817476,269817476,
sipa,2017-01-03T21:55:00Z,Needs rebase.,https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-270236046,270236046,
theuni,2017-01-04T00:06:50Z,Done.,https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-270261333,270261333,
laanwj,2017-01-04T11:20:59Z,lightly-tested ACK 67ee4ec,https://github.com/bitcoin/bitcoin/pull/9289#issuecomment-270349514,270349514,
TheBlueMatt,2016-12-22T23:34:10Z,"Generally, I think it might make sense to just rename this ""InterruptibleSleeper"" and have it own the mutex and condition_variable. Then you dont have to have its owner own memory it points to and should still be able to keep +/- the same API.",https://github.com/bitcoin/bitcoin/pull/9289#discussion_r93713812,93713812,src/threadinterrupt.h
TheBlueMatt,2016-12-22T23:35:30Z,"Can we just move this into a member function of the class?\n\nAlso, does it need to be a template? I think if you set Duration to something that the various durations can be converted into it should do so intelligently. Would mean less stuff to compile in headers.",https://github.com/bitcoin/bitcoin/pull/9289#discussion_r93713941,93713941,src/threadinterrupt.h
TheBlueMatt,2016-12-22T23:36:08Z,"Please no new implementations-in-headers. I know its mostly single-line stuff but we're fighting to reduce compile-time memory usage, so every little bit helps. :)",https://github.com/bitcoin/bitcoin/pull/9289#discussion_r93713996,93713996,src/threadinterrupt.h
theuni,2016-12-22T23:45:19Z,"Sometimes you'll want a real interruptible condvar, though. See https://github.com/theuni/bitcoin/commit/da68e3cf5832878fbb1951eb1eeb01d8cd22d1e1#diff-9a82240fe7dfe86564178691cc57f2f1R1887.\n\nThe alternative would be to add wait_for/wait_until/notify_one/notify_all to CThreadInterrupt, then just forward them to the condvar. But for that, you'd still need to expose the mutex.",https://github.com/bitcoin/bitcoin/pull/9289#discussion_r93714848,93714848,src/threadinterrupt.h
theuni,2016-12-22T23:46:27Z,Sure. Though some of these need to be inlined. I figured someone would yell if I added a .cpp with 2 functions :p,https://github.com/bitcoin/bitcoin/pull/9289#discussion_r93714949,93714949,src/threadinterrupt.h
theuni,2016-12-22T23:48:17Z,"This started out as a member function, but interrupt.sleep_for() felt awkward conceptually.\n\nWe can probably just force this to milliseconds. If we need microsecond precision later, we can just add another function.",https://github.com/bitcoin/bitcoin/pull/9289#discussion_r93715113,93715113,src/threadinterrupt.h
theuni,2016-12-22T23:53:23Z,I suppose this could be rigged up with a separate condvar/mutex and some additional manual isinterruped checks.,https://github.com/bitcoin/bitcoin/pull/9289#discussion_r93715557,93715557,src/threadinterrupt.h
gmaxwell,2016-12-24T22:34:32Z,Do we really want symbols that differ only in case?,https://github.com/bitcoin/bitcoin/pull/9289#discussion_r93822030,93822030,src/netbase.cpp
theuni,2016-12-25T05:21:39Z,"Ah yes, probably unwise. Will change the atomic.",https://github.com/bitcoin/bitcoin/pull/9289#discussion_r93824187,93824187,src/netbase.cpp
sipa,2016-12-27T16:51:29Z,Style nit (in many places): space after `if`.,https://github.com/bitcoin/bitcoin/pull/9289#discussion_r93949474,93949474,src/net_processing.cpp
sipa,2016-12-29T19:53:18Z,Satoshi did not write this... as far as I know at least? Nor was it written in 2009.,https://github.com/bitcoin/bitcoin/pull/9289#discussion_r94173760,94173760,src/threadinterrupt.cpp
sipa,2016-12-30T13:32:49Z,"It seems that `mutexMsgProc` is only used for locking `flagInterruptMsgProc` and waiting, making it very similar to `CThreadInterrupt`. If you'd add a `wake()` method to that class, which breaks from sleeps, but doesn't set the interrupt point, wouldn't you be able to replace the explicit mutex/flag/condvar with a CThreadInterrupt>",https://github.com/bitcoin/bitcoin/pull/9289#discussion_r94227634,94227634,src/net.cpp
sipa,2016-12-30T13:34:53Z,Leftover debug statement?,https://github.com/bitcoin/bitcoin/pull/9289#discussion_r94227749,94227749,src/net.cpp
theuni,2016-12-30T18:50:23Z,"I tried to make CThreadInterrupt do this at first (see some of the back+forth with @TheBlueMatt) above. Your suggestion works fine here, I think, but it's not generic due to the lack of accounting for wake conditions. I think it could be done by having wait_until accept an optional predicate, which would be used internally as ""while !internal_wake && !pred()"".\n\nThe compromise was to only use i",https://github.com/bitcoin/bitcoin/pull/9289#discussion_r94249745,94249745,src/net.cpp
theuni,2016-12-30T18:50:39Z,Caught me!,https://github.com/bitcoin/bitcoin/pull/9289#discussion_r94249763,94249763,src/threadinterrupt.cpp
theuni,2016-12-30T18:50:48Z,Will remove.,https://github.com/bitcoin/bitcoin/pull/9289#discussion_r94249773,94249773,src/net.cpp
theuni,2016-12-30T18:53:15Z,"Whoops, that's right, that didn't work because it would force the internal mutex to be exposed so the caller could actually set the wake condition.",https://github.com/bitcoin/bitcoin/pull/9289#discussion_r94249944,94249944,src/net.cpp
sipa,2016-12-30T19:24:27Z,"Ok, I see. Let's think about generalizing this later. No need to hold this PR up.",https://github.com/bitcoin/bitcoin/pull/9289#discussion_r94252014,94252014,src/net.cpp
