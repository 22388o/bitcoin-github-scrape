jnewbery,2020-07-28 09:24:29,"Thank you @MarcoFalke @promag @jonatack @dongcarl @ariard @theuni @fjahr @hebasto @troygiorshev for reviewing the prerequisite PRs! This is the first PR in the cs_main_split sequence where we start getting benefit by reducing cs_main scope in net processing. It also introduces the new structure and locking model, so it's the PR that requires the most conceptual/approach review in the sequence. If ",https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-664914956,664914956,
DrahtBot,2020-07-28 17:04:52,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19791 ([net processing] Move Misbehaving() to PeerManager by jnewbery)\n* #19723 (Ignore unknown messages before VERACK b",https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-665160859,665160859,
jnewbery,2020-07-29 08:34:57,"> Is the plan to lock every member of Peer behind its own mutex? Why not give each Peer its own mutex instead?\n\nCurrently the plan is to have related members behind a single mutex, eg all tx relay fields behind the same mutex. The main reason is that that model maps most closely to what exists already (look at the various locks inside CNode). Once everything has moved to `Peer` then it should ",https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-665521734,665521734,
jnewbery,2020-07-29 13:48:06,"> clang-format complains a bit on each commit.\n\nok, I've taken clang-format's suggestions, except one that joins an initializer list onto the same line as the function and parameter list (which makes a really long line), and one which would break the scripted-diff linter.",https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-665675090,665675090,
jonatack,2020-07-30 06:55:46,@jnewbery it looks like there is an incomplete rebase-in-progress in the last commit 123bba3b03a6b0f9d791758cb5dfc2e5468bf193; will review on next push.,https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666167075,666167075,
jnewbery,2020-07-30 08:23:33,@jonatack oops. Fixed. Thanks!,https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666221786,666221786,
jnewbery,2020-07-30 11:41:22,Thanks for the review @jonatack and @MarcoFalke . All your latest review comments are addressed.,https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666315046,666315046,
troygiorshev,2020-07-30 12:11:55,reACK 951093884be4b6e48d2850dfc667c298f85afe9c,https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666327255,666327255,
laanwj,2020-07-30 14:49:49,"Code review ACK 8e35bf59062b3a823182588e0bf809b3367c2be0\n~~951093884be4b6e48d2850dfc667c298f85afe9c~~\n\n@theuni As you made the `CNode` and `CNodeState` separation originally can you take a look here please.",https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666418841,666418841,
jonatack,2020-07-30 15:23:52,re-ACK 951093884be4b6e48d2850dfc667c298f85afe9c per `git diff afe3604 9510938`,https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666452034,666452034,
fjahr,2020-07-30 19:46:55,"Code review ACK 951093884be4b6e48d2850dfc667c298f85afe9c\n\nStill testing a bit but everything looks good!",https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666643073,666643073,
jnewbery,2020-07-30 20:04:42,"Note for maintainers: please don't merge this yet. It has 4 ACKs, but going down this path is quite an important design decision. I'd like @theuni, @sipa or @sdaftuar to weight in before we move forward.",https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-666655471,666655471,
jnewbery,2020-08-06 20:49:46,"Thanks for the review @sdaftuar!\n\n> I'm not strongly wedded to the design decisions here though, it's not obvious to me that going down this road of having fine-grain, per-peer locks really adds anything, compared to (say) having just one lock for a whole Peer object (which maybe is even held the whole time you're using it, for simplicity).\n\nI'm not strongly wedded to it either. My reason ",https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-670185002,670185002,
jnewbery,2020-08-12 09:54:40,Rebased (https://github.com/bitcoin/bitcoin/compare/8fe28ceb126dd3206f04f426aef8d067f538ec3f..3c56d2385e195d3de587df95f64ce97fc727b1a3),https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-672775226,672775226,
jnewbery,2020-08-12 10:27:37,Thanks everyone for review. I've rebased and addressed all comments from @sdaftuar and @theuni . This is ready for re-review.,https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-672790288,672790288,
jnewbery,2020-08-13 11:04:16,@troygiorshev @laanwj @fjahr @jonatack this PR is now rebased and updated to address @sdaftuar and @theuni review comments. Do you mind re-ACKing?,https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-673412324,673412324,
troygiorshev,2020-08-13 18:06:32,"reACK 8e35bf59062b3a823182588e0bf809b3367c2be0 via `git range-diff master 9510938 8e35bf5`\n\nOnly minor changes.\n\nAnd, because I don't think I've seen it yet, ACK on the name of `g_peer_mutex`.  I like the `mutex` suffix better than the `cs` prefix, leaving the prefix open to only `g`, `m`, or nothing.",https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-673629145,673629145,
promag,2020-08-15 14:57:02,Concept ACK.,https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-674408122,674408122,
theuni,2020-08-27 16:52:09,"ACK 8e35bf59062b3a823182588e0bf809b3367c2be0.\n\nI think my [comment](https://github.com/bitcoin/bitcoin/pull/19607#discussion_r470173964) here is important for reviewers to keep in mind here and for future work on ```Peer```, but I don't see any issues introduced as part of this PR.",https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-682068150,682068150,
sipa,2020-08-28 18:16:10,Concept ACK.\n\n,https://github.com/bitcoin/bitcoin/pull/19607#issuecomment-683025972,683025972,
MarcoFalke,2020-07-28 15:12:42,"```suggestion\n    const NodeId m_id;\n```\n\nin commit d60a16bb3f58fcb9422c277256b3c3a31cab3b2f\n\nAny reason to not make this const? Having this mutable would violate the assumption that the id is unique per peer.",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461660871,461660871,src/net_processing.cpp
MarcoFalke,2020-07-28 15:13:51,"nit in commit d60a16bb3f58fcb9422c277256b3c3a31cab3b2f\n```suggestion\n * the refcount drops to zero.\n```\n\nFinalizeNode only decreases the refcount by one. It can still be larger than one (as long as someone is holding a PeerRef, e.g. `getpeerinfo` or similar)",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461661767,461661767,src/net_processing.cpp
MarcoFalke,2020-07-28 15:17:32,"\nnit in same commit:\n\nCan be written with one less line ;)\n\n```suggestion\n    if (it != g_peer_map.end()) return it->second;\n    return {}; // ( or return nullptr; )\n```",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461664437,461664437,src/net_processing.cpp
troygiorshev,2020-07-28 16:00:34,"This may be a rare case where a ternary makes things clearer.\n```suggestion\n    return (it != g_peer_map.end()) ? it->second : nullptr;\n```",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461695156,461695156,src/net_processing.cpp
troygiorshev,2020-07-28 20:33:02,"ACK on the removal of the unused `CNodeState.name`, however it's kinda hidden here and makes the misbehaving moves in 53a2978b5ea27852f7bfab337ccec83feee4e72e harder to follow.  Maybe it should be done in its own commit?",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461860798,461860798,src/net_processing.cpp
troygiorshev,2020-07-28 20:37:00,nit: `GetPeer` is already in the codebase as `CService::GetPeer`.  Suggest `GetPeerRef` instead,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461862887,461862887,src/net_processing.cpp
troygiorshev,2020-07-28 20:52:05,s/stucture/structure/,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r461871291,461871291,src/net_processing.cpp
MarcoFalke,2020-07-29 04:36:54,"in commit d60a16b\n\nIs there any reason to make this a global? This map gets populated in `PeerLogicValidation::InitializeNode`, which is called by connman. `PeerLogicValidation` keeps a pointer to this connman, so it would seem natural to me that it also keeps track of the peer map, e.g. in a (private) member.",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462032894,462032894,src/net_processing.cpp
jnewbery,2020-07-29 07:54:07,"This was mostly just following the convention of net_processing having its data stored in globals. I've had a look at what would be involved in moving `g_peer_map` and `GetPeer()` to be members of `PeerLogicValidation`. The main problem is that in future commits I want to be able to call `GetPeer()` from functions all across net_processing, and many of those aren't member functions of PLV. That me",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462108444,462108444,src/net_processing.cpp
jnewbery,2020-07-29 08:06:22,You're right. This should be const. Fixed,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462115462,462115462,src/net_processing.cpp
jnewbery,2020-07-29 08:06:29,Fixed,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462115511,462115511,src/net_processing.cpp
jnewbery,2020-07-29 08:06:43,Done with Troy's ternary. Thanks!,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462115635,462115635,src/net_processing.cpp
jnewbery,2020-07-29 08:10:19,"It absolutely should. When I wrote the original branch, I moved `name` to `Peer` as well, but since then, I removed all uses of `name` in #19472 and #19583 but failed to remove it as a member. I've now separated its removal into a separate commit.",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462117635,462117635,src/net_processing.cpp
jnewbery,2020-07-29 08:15:35,"ok, changed to `GetPeerRef()`",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462120803,462120803,src/net_processing.cpp
jnewbery,2020-07-29 08:15:41,Fixed,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462120869,462120869,src/net_processing.cpp
MarcoFalke,2020-07-30 07:50:22,"dumb style nit in commit 730ad2ee4026ab47daf6c35e8dd4d5a665a5442e:\n\nColon goes on next line to avoid clang-format complaint:\n\n```diff\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\nindex e64215c7d5..ca36daabf6 100644\n--- a/src/net_processing.cpp\n+++ b/src/net_processing.cpp\n@@ -422,8 +422,8 @@ struct CNodeState {\n     //! Whether this peer relays txs via wtxid\n ",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462813973,462813973,src/net_processing.cpp
jonatack,2020-07-30 10:12:07,"337528b ISTM this type is an `int64_t` defined in net.h; should we initialize a default here for safety, like for the other members `m_misbehavior_score{0}` and `m_should_discourage{false}` added in 36ac41a  (edit: similar to net.h:L415 `std::atomic<NodeId> nLastNodeId{0};`)",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462894529,462894529,src/net_processing.cpp
jonatack,2020-07-30 10:16:54,"36ac41a seems safer to initialize `misbehavior` with a value, even if set ATM a few lines further down",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462897076,462897076,src/net_processing.cpp
jonatack,2020-07-30 10:22:02,36ac41a should we add an `if (peer == nullptr) return false;` check here as well,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462899594,462899594,src/net_processing.cpp
jonatack,2020-07-30 10:28:09,"36ac41a\n\n- perhaps this line inside the inner block (beginning with the following line), like the three cases above\n\n- should we add an `if (peer == nullptr) return false;` check here as well?",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462902684,462902684,src/net_processing.cpp
jonatack,2020-07-30 10:30:57,"337528b not sure here, `s/insert/emplace/` to construct rather than copy?",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462904094,462904094,src/net_processing.cpp
jnewbery,2020-07-30 11:15:00,"Sure. This gets set in the initializer list of the only ctor, but there's no harm in adding this.",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462924953,462924953,src/net_processing.cpp
jnewbery,2020-07-30 11:21:58,"ok, I've changed this to `emplace_hint` since the new peers are always added to the end of the map (same as for CNodeStates in mapNodeState)",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462928140,462928140,src/net_processing.cpp
jnewbery,2020-07-30 11:26:47,ok. Done.,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462930470,462930470,src/net_processing.cpp
jnewbery,2020-07-30 11:27:20,"I've added an assert, like for CNodeState. The Peer object should always exist when we try to remove the peer.",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462930737,462930737,src/net_processing.cpp
MarcoFalke,2020-07-30 11:29:04,"It is impossible to not initialize a const member, so I'd prefer to keep it as is, but not strong opinion",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462931580,462931580,src/net_processing.cpp
MarcoFalke,2020-07-30 11:30:01,A reference to the node exists (`CNode& pnode`) so it should be impossible for the peer ref to be deleted already,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462932043,462932043,src/net_processing.cpp
jnewbery,2020-07-30 11:30:56,ah! Thank you!,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462932478,462932478,src/net_processing.cpp
jnewbery,2020-07-30 11:35:47,"> perhaps this line inside the block like the three cases above\n\nI don't think this is required. The block is to limit the scope of the lock. Putting the `peer` variable in there is fine, but I don't think it's consistent with project style.\n\nThe block in `GetNodeStateStats()` was left over from a previous iteration of this branch. I've removed it. The block in `FinalizeNode()` is to force",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462934690,462934690,src/net_processing.cpp
jonatack,2020-07-30 12:32:15,"Interesting, TIL thanks, and there were only two `emplace_hint` statements in the codebase, one of which is in the same function. From https://en.cppreference.com/w/cpp/container/map/emplace_hint it looks like a good choice for lower complexity and better perf in this case. ",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r462962065,462962065,src/net_processing.cpp
ariard,2020-07-30 23:38:46,"Have you considered std::atomic ? It has API to read/add atomically and it might there fit as we don't control flow on union of both values. I guess it's a bit faster than library mutex, but surely not worthy the complexity, maybe for next moved values.",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r463328886,463328886,src/net_processing.cpp
ariard,2020-07-30 23:40:22,Banned or discouraged ? I thought we banned the former to avoid people being discouraged to understand this logic.,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r463329398,463329398,src/net_processing.cpp
jnewbery,2020-08-06 17:12:08,I think it's easier to reason about having both misbehavior fields (`m_misbehavior_score` and `m_should_discourage`) under the same mutex since they're so closely related.,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466560976,466560976,src/net_processing.cpp
jnewbery,2020-08-06 17:14:58,Thanks. This was a bad rebase. Now fixed.,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466562495,466562495,src/net_processing.cpp
sdaftuar,2020-08-06 18:33:47,"I think that if you agree it makes sense to put it in PLV, then now is probably the best time to do it, unless there's something that would break if you did?  In which case I'd say deferring until we do a bigger PLV cleanup would make sense too.",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466608735,466608735,src/net_processing.cpp
sdaftuar,2020-08-06 18:39:06,"I wonder if the `~CNetProcessing` destructor should be cleaning up this global map, if this isn't moved into PLV?  It looks like we don't clean up `mapNodeState` there, but that seems like an oversight -- unless there's some good reason I'm missing?",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466611577,466611577,src/net_processing.cpp
sdaftuar,2020-08-06 18:49:46,"So even apart from not using `cs_main`, there's another design change happening here in how we use these objects, when compared with `CNodeState` -- no lock on the map is maintained in order to have a shared_ptr to the peer object.\n\nThat means that our code needs to be able to handle having the entry in the map erased out from under it, correct?  That might be worth mentioning somewhere as a d",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466617186,466617186,src/net_processing.cpp
sdaftuar,2020-08-06 18:51:47,ACK spelling change,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466618266,466618266,src/net_processing.cpp
sdaftuar,2020-08-06 18:56:05,This is a mouthful; would it be reasonable to add accessor functions to the `Peer` class that handle the lock acquisitions themselves?,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466620612,466620612,src/net_processing.cpp
jnewbery,2020-08-06 20:39:33,"If I can get buy-in here from everyone else to move a bunch of the static functions from net_processing into PLV, then I'm very happy to move `g_peer_map` into PLV and move those functions as needed in future PRs.",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466673202,466673202,src/net_processing.cpp
jnewbery,2020-08-06 20:41:11,"Yes, that's possible. Do you think the comment on the map needs expanding? It currently says ""Once a shared pointer reference is taken, the lock may be released. Individual fields are protected by their own locks.""",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466673988,466673988,src/net_processing.cpp
jnewbery,2020-08-06 20:50:15,🇺🇸 ,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466678546,466678546,src/net_processing.cpp
jnewbery,2020-08-06 20:58:49,"For functions that access multiple fields under the same lock, we'll need to hold the lock externally to the struct anyway (see `Misbehaving()` for example, which accesses both `m_misbehavior_score` and `m_should_discourage` while holding `m_misbehavior_score`). So I could add setters/getters which handle the locking, but the locks would still need to be public and it wouldn't help with encapsulat",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466682760,466682760,src/net_processing.cpp
troygiorshev,2020-08-06 22:08:05,"I'm fond of WITH_LOCK.  Especially if we're going the way of many individual locks, it's much quicker this way to see what's locking what.\n\nThis does give me flashbacks to Java though... `Button button = new Button(""button"");`",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r466712303,466712303,src/net_processing.cpp
theuni,2020-08-07 14:05:42,"+1 on this. No preference whether it happens here or in a follow-up, but I agree PLV is a better home.",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r467062266,467062266,src/net_processing.cpp
theuni,2020-08-07 14:17:13,"@sdaftuar This was my high-level feedback as well. I strongly prefer encapsulation as it's really really hard to screw up encapsulated locking, but it's a burden when multiple operations could otherwise be handled with a single lock. But as this work/PR is intended to break up locking that has grown unwieldy, I can see why @jnewbery went for this approach.\n\nAlso, just in terms of evolution of ",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r467069263,467069263,src/net_processing.cpp
theuni,2020-08-07 14:21:29,"This is mostly a question for future stuff that gets moved in but... What if the refcount is more than 1 here? Do we continue tearing it down?\n\nAs a contrived (bad) example: what if someone bumps the misbehavior score after it's been evaluated here?",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r467071878,467071878,src/net_processing.cpp
theuni,2020-08-07 14:33:00,"Should this and ```mapNodeState.erase(nodeid)``` happen at the same time, under the same cs_main lock?\n\nWhat are the consequences of them being out of sync? (Still reachable by ```State()``` but not by ```GetPeerRef()```)",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r467079107,467079107,src/net_processing.cpp
jnewbery,2020-08-12 09:46:29,"I started trying to do this, but it's an enormous change. `Misbehaving()` fetches the `PeerRef`, and `Misbehaving()` is called all over net_processing. Let's defer this change to its own PR (probably a series of PRs since it touches almost all of the functions in net_processing.",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469139698,469139698,src/net_processing.cpp
jnewbery,2020-08-12 09:53:37,"It seems like there are two different points here:\n\n- ""This is a mouthful"" (@sdaftuar) seems like a stylistic comment. I actually like the fact that the WITH_LOCK macro is explicit about the lock it's taking.\n- ""I strongly prefer encapsulation as it's really really hard to screw up encapsulated locking"" (@theuni) is a comment about locking design. Cory, correct me if I'm wrong, but I think y",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469143729,469143729,src/net_processing.cpp
jnewbery,2020-08-12 10:06:00,"> I wonder if the ~CNetProcessing destructor should be cleaning up this global map, if this isn't moved into PLV? It looks like we don't clean up mapNodeState there, but that seems like an oversight -- unless there's some good reason I'm missing?\n\nAll nodes are cleaned up by `CConnman` during the Shutdown sequence (`Shutdown()` in init.cpp calls `CConnman.StopNodes()`, which calls `FinalizeNod",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469150403,469150403,src/net_processing.cpp
jnewbery,2020-08-12 10:21:42,"We'll remove the `Peer` shared ptr from `g_peer_map`, but we don't destruct the object until the refcount drops to 0. Your contrived example is fine. There would have to be another thread currently in `Misbehaving()` holding a shared ptr to the `Peer` object. We'd remove it from the map, the other thread would increment the misbehaving score, and then the `Peer` object would be destructed when tha",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469158507,469158507,src/net_processing.cpp
jnewbery,2020-08-12 10:26:51,"No bad consequences, but I've moved the Peer cleanup underneath the cs_main lock anyway to make this simpler to think about.",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469161161,469161161,src/net_processing.cpp
theuni,2020-08-12 13:32:37,"My primary concern is that 5 years from now someone changes some code that interacts with a Peer and forgets to grab a lock. With encapsulated locking, that _can't_ happen.\n\nBut I'm now satisfied that even without the encapsulation, we have safeguards to prevent that.",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r469261911,469261911,src/net_processing.cpp
theuni,2020-08-13 18:51:34,"My point here was that calls to ```Misbehaving()``` might go unobserved, because the score may have already been evaluated before the other thread bumped it. This is not possible in with the current behavior because of cs_main: once we're in ```FinalizeNode```, we're guaranteed that no other thread is accessing it (unless they've cached the ```CNodeState*```, which would be a bug).\n\nObviously ",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r470173964,470173964,src/net_processing.cpp
jnewbery,2020-08-24 17:18:52,"@MarcoFalke @theuni @sdaftuar - I've made a branch that puts peer_map inside PeerLogicValidation here: https://github.com/jnewbery/bitcoin/tree/2020-08-peer-plv2. It builds on top of (merged) #19704 and (open) #19791. Let me know what you think. If that 19791 gets merged first, I'll switch this PR to use that branch. If not, I'm happy to do the follow-up work to move g_peer_map into PeerLogicValid",https://github.com/bitcoin/bitcoin/pull/19607#discussion_r475771780,475771780,src/net_processing.cpp
jnewbery,2020-08-28 15:41:50,Thanks @theuni. This is a very good point. I'll add a comment about not relying on this being the final state of `Peer` in a future commit.,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r479385813,479385813,src/net_processing.cpp
jnewbery,2020-09-07 17:18:20,PR: #19910,https://github.com/bitcoin/bitcoin/pull/19607#discussion_r484527708,484527708,src/net_processing.cpp
