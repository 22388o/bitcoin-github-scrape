[
  {
    "sha": "8854ebbec6ca12ce03c02ee31625e78886b1a48d",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4ODU0ZWJiZWM2Y2ExMmNlMDNjMDJlZTMxNjI1ZTc4ODg2YjFhNDhk",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-05-21T14:23:25Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-05-21T14:31:03Z"
      },
      "message": "mempool: Update estimator if verification progress > 90%",
      "tree": {
        "sha": "a744403d01fbf904561687b2e39fdddd6a8359ab",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a744403d01fbf904561687b2e39fdddd6a8359ab"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8854ebbec6ca12ce03c02ee31625e78886b1a48d",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8854ebbec6ca12ce03c02ee31625e78886b1a48d",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/8854ebbec6ca12ce03c02ee31625e78886b1a48d",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8854ebbec6ca12ce03c02ee31625e78886b1a48d/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "3001cc61cf11e016c403ce83c9cbcfd3efcbcfd9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3001cc61cf11e016c403ce83c9cbcfd3efcbcfd9",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/3001cc61cf11e016c403ce83c9cbcfd3efcbcfd9"
      }
    ],
    "stats": {
      "total": 8,
      "additions": 4,
      "deletions": 4
    },
    "files": [
      {
        "sha": "1d185c406a255303623b9a85a34907eb897e0411",
        "filename": "src/txmempool.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8854ebbec6ca12ce03c02ee31625e78886b1a48d/src/txmempool.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8854ebbec6ca12ce03c02ee31625e78886b1a48d/src/txmempool.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txmempool.cpp?ref=8854ebbec6ca12ce03c02ee31625e78886b1a48d",
        "patch": "@@ -547,7 +547,7 @@ void CTxMemPool::removeConflicts(const CTransaction &tx)\n /**\n  * Called when a block is connected. Removes from mempool and updates the miner fee estimator.\n  */\n-void CTxMemPool::removeForBlock(const std::vector<CTransactionRef>& vtx, unsigned int nBlockHeight)\n+void CTxMemPool::removeForBlock(const std::vector<CTransactionRef>& vtx, unsigned int nBlockHeight, bool update_estimator)\n {\n     LOCK(cs);\n     std::vector<const CTxMemPoolEntry*> entries;\n@@ -560,7 +560,7 @@ void CTxMemPool::removeForBlock(const std::vector<CTransactionRef>& vtx, unsigne\n             entries.push_back(&*i);\n     }\n     // Before the txs in the new block have been removed from the mempool, update policy estimates\n-    if (minerPolicyEstimator) {minerPolicyEstimator->processBlock(nBlockHeight, entries);}\n+    if (update_estimator && minerPolicyEstimator) {minerPolicyEstimator->processBlock(nBlockHeight, entries);}\n     for (const auto& tx : vtx)\n     {\n         txiter it = mapTx.find(tx->GetHash());"
      },
      {
        "sha": "15ac47c8dca53c04d32d238d6b221d79cf95f12b",
        "filename": "src/txmempool.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8854ebbec6ca12ce03c02ee31625e78886b1a48d/src/txmempool.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8854ebbec6ca12ce03c02ee31625e78886b1a48d/src/txmempool.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txmempool.h?ref=8854ebbec6ca12ce03c02ee31625e78886b1a48d",
        "patch": "@@ -585,7 +585,7 @@ class CTxMemPool\n     void removeRecursive(const CTransaction &tx, MemPoolRemovalReason reason = MemPoolRemovalReason::UNKNOWN);\n     void removeForReorg(const CCoinsViewCache *pcoins, unsigned int nMemPoolHeight, int flags) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n     void removeConflicts(const CTransaction &tx) EXCLUSIVE_LOCKS_REQUIRED(cs);\n-    void removeForBlock(const std::vector<CTransactionRef>& vtx, unsigned int nBlockHeight);\n+    void removeForBlock(const std::vector<CTransactionRef>& vtx, unsigned int nBlockHeight, bool update_estimator = true);\n \n     void clear();\n     void _clear() EXCLUSIVE_LOCKS_REQUIRED(cs); //lock free"
      },
      {
        "sha": "ffeeeb206161a1530ec3ac46f0f083a99876f3fc",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8854ebbec6ca12ce03c02ee31625e78886b1a48d/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8854ebbec6ca12ce03c02ee31625e78886b1a48d/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=8854ebbec6ca12ce03c02ee31625e78886b1a48d",
        "patch": "@@ -2459,7 +2459,7 @@ bool CChainState::ConnectTip(CValidationState& state, const CChainParams& chainp\n     int64_t nTime5 = GetTimeMicros(); nTimeChainState += nTime5 - nTime4;\n     LogPrint(BCLog::BENCH, \"  - Writing chainstate: %.2fms [%.2fs (%.2fms/blk)]\\n\", (nTime5 - nTime4) * MILLI, nTimeChainState * MICRO, nTimeChainState * MILLI / nBlocksTotal);\n     // Remove conflicting transactions from the mempool.;\n-    mempool.removeForBlock(blockConnecting.vtx, pindexNew->nHeight);\n+    mempool.removeForBlock(blockConnecting.vtx, pindexNew->nHeight, GuessVerificationProgress(chainparams.TxData(), pindexNew) > 0.9);\n     disconnectpool.removeForBlock(blockConnecting.vtx);\n     // Update m_chain & related variables.\n     m_chain.SetTip(pindexNew);"
      }
    ]
  },
  {
    "sha": "e6343d866d46edf296f41e6c4d1038c0f9a00c5f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplNjM0M2Q4NjZkNDZlZGYyOTZmNDFlNmM0ZDEwMzhjMGY5YTAwYzVm",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-05-21T16:58:21Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-05-21T22:11:26Z"
      },
      "message": "fixup: Only update fee estimator if block age is up to 2 days",
      "tree": {
        "sha": "c68bab45129c6fbe7a91d176b379aeabd9e0ea11",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c68bab45129c6fbe7a91d176b379aeabd9e0ea11"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e6343d866d46edf296f41e6c4d1038c0f9a00c5f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e6343d866d46edf296f41e6c4d1038c0f9a00c5f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e6343d866d46edf296f41e6c4d1038c0f9a00c5f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e6343d866d46edf296f41e6c4d1038c0f9a00c5f/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "8854ebbec6ca12ce03c02ee31625e78886b1a48d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8854ebbec6ca12ce03c02ee31625e78886b1a48d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/8854ebbec6ca12ce03c02ee31625e78886b1a48d"
      }
    ],
    "stats": {
      "total": 9,
      "additions": 8,
      "deletions": 1
    },
    "files": [
      {
        "sha": "79a733bdf8a2fd7de71188eb8d0e15df9e42d795",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 1,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e6343d866d46edf296f41e6c4d1038c0f9a00c5f/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e6343d866d46edf296f41e6c4d1038c0f9a00c5f/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=e6343d866d46edf296f41e6c4d1038c0f9a00c5f",
        "patch": "@@ -476,6 +476,11 @@ static bool IsCurrentForFeeEstimation() EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n     return true;\n }\n \n+static bool IsSuitableForEstimator(const CBlockIndex* block_index)\n+{\n+    return block_index->GetBlockTime() > GetTime() - MAX_FEE_ESTIMATOR_BLOCK_AGE;\n+}\n+\n /* Make mempool consistent after a reorg, by re-adding or recursively erasing\n  * disconnected block transactions from the mempool, and also removing any\n  * other transactions from the mempool that are no longer valid given the new\n@@ -2459,7 +2464,7 @@ bool CChainState::ConnectTip(CValidationState& state, const CChainParams& chainp\n     int64_t nTime5 = GetTimeMicros(); nTimeChainState += nTime5 - nTime4;\n     LogPrint(BCLog::BENCH, \"  - Writing chainstate: %.2fms [%.2fs (%.2fms/blk)]\\n\", (nTime5 - nTime4) * MILLI, nTimeChainState * MICRO, nTimeChainState * MILLI / nBlocksTotal);\n     // Remove conflicting transactions from the mempool.;\n-    mempool.removeForBlock(blockConnecting.vtx, pindexNew->nHeight, GuessVerificationProgress(chainparams.TxData(), pindexNew) > 0.9);\n+    mempool.removeForBlock(blockConnecting.vtx, pindexNew->nHeight, IsSuitableForEstimator(pindexNew));\n     disconnectpool.removeForBlock(blockConnecting.vtx);\n     // Update m_chain & related variables.\n     m_chain.SetTip(pindexNew);"
      },
      {
        "sha": "40793102ae8c74b0a7d4d35cfecc26347c24e77e",
        "filename": "src/validation.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e6343d866d46edf296f41e6c4d1038c0f9a00c5f/src/validation.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e6343d866d46edf296f41e6c4d1038c0f9a00c5f/src/validation.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.h?ref=e6343d866d46edf296f41e6c4d1038c0f9a00c5f",
        "patch": "@@ -107,6 +107,8 @@ static const int64_t BLOCK_DOWNLOAD_TIMEOUT_PER_PEER = 500000;\n static const int64_t DEFAULT_MAX_TIP_AGE = 24 * 60 * 60;\n /** Maximum age of our tip in seconds for us to be considered current for fee estimation */\n static const int64_t MAX_FEE_ESTIMATION_TIP_AGE = 3 * 60 * 60;\n+/** Maximum block age in seconds for us to be considered suitable for fee estimator */\n+static const int64_t MAX_FEE_ESTIMATOR_BLOCK_AGE = 48 * 60 * 60;\n \n static const bool DEFAULT_CHECKPOINTS_ENABLED = true;\n static const bool DEFAULT_TXINDEX = false;"
      }
    ]
  }
]