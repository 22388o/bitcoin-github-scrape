[
  {
    "sha": "25c54b3d79a7ac4299f74adee3503da3aa572797",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyNWM1NGIzZDc5YTdhYzQyOTlmNzRhZGVlMzUwM2RhM2FhNTcyNzk3",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2016-08-28T07:17:41Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2016-08-29T08:03:57Z"
      },
      "message": "Display version message before disconnection criteria (no functional changes)",
      "tree": {
        "sha": "2de4f0769f348e3c83d8dd249f7295380b342e4d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2de4f0769f348e3c83d8dd249f7295380b342e4d"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/25c54b3d79a7ac4299f74adee3503da3aa572797",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/25c54b3d79a7ac4299f74adee3503da3aa572797",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/25c54b3d79a7ac4299f74adee3503da3aa572797",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/25c54b3d79a7ac4299f74adee3503da3aa572797/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "a5bb6387f751e630c329f34cac2d38bffa8ff9cf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a5bb6387f751e630c329f34cac2d38bffa8ff9cf",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/a5bb6387f751e630c329f34cac2d38bffa8ff9cf"
      }
    ],
    "stats": {
      "total": 56,
      "additions": 28,
      "deletions": 28
    },
    "files": [
      {
        "sha": "514e832c9b774c1cc1321a5673f193b71da9ed17",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 28,
        "deletions": 28,
        "changes": 56,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/25c54b3d79a7ac4299f74adee3503da3aa572797/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/25c54b3d79a7ac4299f74adee3503da3aa572797/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=25c54b3d79a7ac4299f74adee3503da3aa572797",
        "patch": "@@ -4931,25 +4931,6 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         {\n             addrman.SetServices(pfrom->addr, pfrom->nServices);\n         }\n-        if (pfrom->nServicesExpected & ~pfrom->nServices)\n-        {\n-            LogPrint(\"net\", \"peer=%d does not offer the expected services (%08x offered, %08x expected); disconnecting\\n\", pfrom->id, pfrom->nServices, pfrom->nServicesExpected);\n-            pfrom->PushMessage(NetMsgType::REJECT, strCommand, REJECT_NONSTANDARD,\n-                               strprintf(\"Expected to offer services %08x\", pfrom->nServicesExpected));\n-            pfrom->fDisconnect = true;\n-            return false;\n-        }\n-\n-        if (pfrom->nVersion < MIN_PEER_PROTO_VERSION)\n-        {\n-            // disconnect from peers older than this proto version\n-            LogPrintf(\"peer=%d using obsolete version %i; disconnecting\\n\", pfrom->id, pfrom->nVersion);\n-            pfrom->PushMessage(NetMsgType::REJECT, strCommand, REJECT_OBSOLETE,\n-                               strprintf(\"Version must be %d or greater\", MIN_PEER_PROTO_VERSION));\n-            pfrom->fDisconnect = true;\n-            return false;\n-        }\n-\n         if (pfrom->nVersion == 10300)\n             pfrom->nVersion = 300;\n         if (!vRecv.empty())\n@@ -4977,6 +4958,34 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             return true;\n         }\n \n+        string remoteAddr;\n+        if (fLogIPs)\n+            remoteAddr = \", peeraddr=\" + pfrom->addr.ToString();\n+\n+        LogPrintf(\"receive version message: %s: version %d, blocks=%d, us=%s, peer=%d%s\\n\",\n+                  pfrom->cleanSubVer, pfrom->nVersion,\n+                  pfrom->nStartingHeight, addrMe.ToString(), pfrom->id,\n+                  remoteAddr);\n+\n+        if (pfrom->nServicesExpected & ~pfrom->nServices)\n+        {\n+            LogPrint(\"net\", \"peer=%d does not offer the expected services (%08x offered, %08x expected); disconnecting\\n\", pfrom->id, pfrom->nServices, pfrom->nServicesExpected);\n+            pfrom->PushMessage(NetMsgType::REJECT, strCommand, REJECT_NONSTANDARD,\n+                               strprintf(\"Expected to offer services %08x\", pfrom->nServicesExpected));\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+\n+        if (pfrom->nVersion < MIN_PEER_PROTO_VERSION)\n+        {\n+            // disconnect from peers older than this proto version\n+            LogPrintf(\"peer=%d using obsolete version %i; disconnecting\\n\", pfrom->id, pfrom->nVersion);\n+            pfrom->PushMessage(NetMsgType::REJECT, strCommand, REJECT_OBSOLETE,\n+                               strprintf(\"Version must be %d or greater\", MIN_PEER_PROTO_VERSION));\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+\n         pfrom->addrLocal = addrMe;\n         if (pfrom->fInbound && addrMe.IsRoutable())\n         {\n@@ -5039,15 +5048,6 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n         pfrom->fSuccessfullyConnected = true;\n \n-        string remoteAddr;\n-        if (fLogIPs)\n-            remoteAddr = \", peeraddr=\" + pfrom->addr.ToString();\n-\n-        LogPrintf(\"receive version message: %s: version %d, blocks=%d, us=%s, peer=%d%s\\n\",\n-                  pfrom->cleanSubVer, pfrom->nVersion,\n-                  pfrom->nStartingHeight, addrMe.ToString(), pfrom->id,\n-                  remoteAddr);\n-\n         int64_t nTimeOffset = nTime - GetTime();\n         pfrom->nTimeOffset = nTimeOffset;\n         AddTimeData(pfrom->addr, nTimeOffset);"
      }
    ]
  },
  {
    "sha": "817c19c6cb3c27e2d33db17be06af3e60dc0fc71",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4MTdjMTljNmNiM2MyN2UyZDMzZGIxN2JlMDZhZjNlNjBkYzBmYzcx",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2016-08-28T08:02:03Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2016-08-29T08:03:57Z"
      },
      "message": "nServicesExpected now represents Services Expected rather than a subset.",
      "tree": {
        "sha": "a82f6586e667985f83653d29b17c9e312f80c04f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a82f6586e667985f83653d29b17c9e312f80c04f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/817c19c6cb3c27e2d33db17be06af3e60dc0fc71",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/817c19c6cb3c27e2d33db17be06af3e60dc0fc71",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/817c19c6cb3c27e2d33db17be06af3e60dc0fc71",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/817c19c6cb3c27e2d33db17be06af3e60dc0fc71/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "25c54b3d79a7ac4299f74adee3503da3aa572797",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/25c54b3d79a7ac4299f74adee3503da3aa572797",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/25c54b3d79a7ac4299f74adee3503da3aa572797"
      }
    ],
    "stats": {
      "total": 19,
      "additions": 11,
      "deletions": 8
    },
    "files": [
      {
        "sha": "950b2a4d3fa40c97399543f1f6893a965be50d33",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 7,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/817c19c6cb3c27e2d33db17be06af3e60dc0fc71/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/817c19c6cb3c27e2d33db17be06af3e60dc0fc71/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=817c19c6cb3c27e2d33db17be06af3e60dc0fc71",
        "patch": "@@ -4967,13 +4967,16 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                   pfrom->nStartingHeight, addrMe.ToString(), pfrom->id,\n                   remoteAddr);\n \n-        if (pfrom->nServicesExpected & ~pfrom->nServices)\n-        {\n-            LogPrint(\"net\", \"peer=%d does not offer the expected services (%08x offered, %08x expected); disconnecting\\n\", pfrom->id, pfrom->nServices, pfrom->nServicesExpected);\n-            pfrom->PushMessage(NetMsgType::REJECT, strCommand, REJECT_NONSTANDARD,\n-                               strprintf(\"Expected to offer services %08x\", pfrom->nServicesExpected));\n-            pfrom->fDisconnect = true;\n-            return false;\n+        if (pfrom->nServicesExpected != pfrom->nServices) {\n+            LogPrint(\"net\", \"peer=%d does not offer the expected services (%08x offered, %08x expected)\", pfrom->id, pfrom->nServices, pfrom->nServicesExpected);\n+            if (pfrom->nServicesExpected & nRelevantServices & ~pfrom->nServices) {\n+                LogPrint(\"net\", \"; disconnecting\\n\");\n+                pfrom->PushMessage(NetMsgType::REJECT, strCommand, REJECT_NONSTANDARD,\n+                                   strprintf(\"Expected to offer services %08x\", pfrom->nServicesExpected));\n+                pfrom->fDisconnect = true;\n+                return false;\n+            } else\n+                LogPrint(\"net\", \"\\n\");\n         }\n \n         if (pfrom->nVersion < MIN_PEER_PROTO_VERSION)"
      },
      {
        "sha": "8b48f9d32bd26e9b186580fbbe9221f480aac4e3",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/817c19c6cb3c27e2d33db17be06af3e60dc0fc71/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/817c19c6cb3c27e2d33db17be06af3e60dc0fc71/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=817c19c6cb3c27e2d33db17be06af3e60dc0fc71",
        "patch": "@@ -446,7 +446,7 @@ CNode* ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure\n             vNodes.push_back(pnode);\n         }\n \n-        pnode->nServicesExpected = ServiceFlags(addrConnect.nServices & nRelevantServices);\n+        pnode->nServicesExpected = ServiceFlags(addrConnect.nServices);\n         pnode->nTimeConnected = GetTime();\n \n         return pnode;"
      }
    ]
  }
]