[
  {
    "sha": "6055b9101bc91647fb80c7ed86fcff90e3e6dedf",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2MDU1YjkxMDFiYzkxNjQ3ZmI4MGM3ZWQ4NmZjZmY5MGUzZTZkZWRm",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-07-20T12:34:16Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-10-15T20:34:20Z"
      },
      "message": "Allow SendMessages to run partially without cs_main\n\nSendMessages() tries to acquire a cs_main lock now, but this isn't nessecary\nfor much of its functionality. Move those parts out of the locked section,\nso they can always be performed, and we hold cs_main for a shorter time.",
      "tree": {
        "sha": "b77370a39843e583cbfe513e196883a1df9b5e3f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b77370a39843e583cbfe513e196883a1df9b5e3f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6055b9101bc91647fb80c7ed86fcff90e3e6dedf",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6055b9101bc91647fb80c7ed86fcff90e3e6dedf",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/6055b9101bc91647fb80c7ed86fcff90e3e6dedf",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6055b9101bc91647fb80c7ed86fcff90e3e6dedf/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "38d15d8b427904a936a4fb4b8ac390bd637e1638",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/38d15d8b427904a936a4fb4b8ac390bd637e1638",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/38d15d8b427904a936a4fb4b8ac390bd637e1638"
      }
    ],
    "stats": {
      "total": 34,
      "additions": 18,
      "deletions": 16
    },
    "files": [
      {
        "sha": "0c31655fe9a08c04e460d6a466d39c6918d98bfe",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 18,
        "deletions": 16,
        "changes": 34,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6055b9101bc91647fb80c7ed86fcff90e3e6dedf/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6055b9101bc91647fb80c7ed86fcff90e3e6dedf/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=6055b9101bc91647fb80c7ed86fcff90e3e6dedf",
        "patch": "@@ -4134,8 +4134,7 @@ bool ProcessMessages(CNode* pfrom)\n \n bool SendMessages(CNode* pto, bool fSendTrickle)\n {\n-    TRY_LOCK(cs_main, lockMain);\n-    if (lockMain) {\n+    {\n         // Don't send anything until we get their version message\n         if (pto->nVersion == 0)\n             return true;\n@@ -4170,20 +4169,6 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n             }\n         }\n \n-        // Start block sync\n-        if (pto->fStartSync && !fImporting && !fReindex) {\n-            pto->fStartSync = false;\n-            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n-        }\n-\n-        // Resend wallet transactions that haven't gotten in a block yet\n-        // Except during reindex, importing and IBD, when old wallet\n-        // transactions become unconfirmed and spams other nodes.\n-        if (!fReindex && !fImporting && !IsInitialBlockDownload())\n-        {\n-            ResendWalletTransactions();\n-        }\n-\n         // Address refresh broadcast\n         static int64 nLastRebroadcast;\n         if (!IsInitialBlockDownload() && (GetTime() - nLastRebroadcast > 24 * 60 * 60))\n@@ -4234,6 +4219,23 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n                 pto->PushMessage(\"addr\", vAddr);\n         }\n \n+        TRY_LOCK(cs_main, lockMain);\n+        if (!lockMain)\n+            return true;\n+\n+        // Start block sync\n+        if (pto->fStartSync && !fImporting && !fReindex) {\n+            pto->fStartSync = false;\n+            PushGetBlocks(pto, chainActive.Tip(), uint256(0));\n+        }\n+\n+        // Resend wallet transactions that haven't gotten in a block yet\n+        // Except during reindex, importing and IBD, when old wallet\n+        // transactions become unconfirmed and spams other nodes.\n+        if (!fReindex && !fImporting && !IsInitialBlockDownload())\n+        {\n+            ResendWalletTransactions();\n+        }\n \n         //\n         // Message: inventory"
      }
    ]
  },
  {
    "sha": "49d754d91522f5eceec7b6a6aef2e027009a7b67",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0OWQ3NTRkOTE1MjJmNWVjZWVjN2I2YTZhZWYyZTAyNzAwOWE3YjY3",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-07-25T00:25:25Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-10-15T20:34:25Z"
      },
      "message": "Run node deletions outside of cs_vNodes",
      "tree": {
        "sha": "8bf28ef0162b5c0e69725465cc3c92d1e1048fe5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8bf28ef0162b5c0e69725465cc3c92d1e1048fe5"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/49d754d91522f5eceec7b6a6aef2e027009a7b67",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/49d754d91522f5eceec7b6a6aef2e027009a7b67",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/49d754d91522f5eceec7b6a6aef2e027009a7b67",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/49d754d91522f5eceec7b6a6aef2e027009a7b67/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6055b9101bc91647fb80c7ed86fcff90e3e6dedf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6055b9101bc91647fb80c7ed86fcff90e3e6dedf",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6055b9101bc91647fb80c7ed86fcff90e3e6dedf"
      }
    ],
    "stats": {
      "total": 3,
      "additions": 2,
      "deletions": 1
    },
    "files": [
      {
        "sha": "e8baa8b383ee666e6101a9520224bf84f12e6a15",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/49d754d91522f5eceec7b6a6aef2e027009a7b67/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/49d754d91522f5eceec7b6a6aef2e027009a7b67/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=49d754d91522f5eceec7b6a6aef2e027009a7b67",
        "patch": "@@ -801,7 +801,8 @@ void ThreadSocketHandler()\n                     vNodesDisconnected.push_back(pnode);\n                 }\n             }\n-\n+        }\n+        {\n             // Delete disconnected nodes\n             list<CNode*> vNodesDisconnectedCopy = vNodesDisconnected;\n             BOOST_FOREACH(CNode* pnode, vNodesDisconnectedCopy)"
      }
    ]
  },
  {
    "sha": "7d38af3c493f9ea24c722ec2e6d3c51f4e851364",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3ZDM4YWYzYzQ5M2Y5ZWEyNGM3MjJlYzJlNmQzYzUxZjRlODUxMzY0",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-07-25T00:34:42Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-10-15T20:34:25Z"
      },
      "message": "Push down cs_main locking in ProcessMessage",
      "tree": {
        "sha": "d77ceb6b56ef3cd5ad9720fff44f5c0191187389",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d77ceb6b56ef3cd5ad9720fff44f5c0191187389"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7d38af3c493f9ea24c722ec2e6d3c51f4e851364",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7d38af3c493f9ea24c722ec2e6d3c51f4e851364",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/7d38af3c493f9ea24c722ec2e6d3c51f4e851364",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7d38af3c493f9ea24c722ec2e6d3c51f4e851364/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "49d754d91522f5eceec7b6a6aef2e027009a7b67",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/49d754d91522f5eceec7b6a6aef2e027009a7b67",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/49d754d91522f5eceec7b6a6aef2e027009a7b67"
      }
    ],
    "stats": {
      "total": 23,
      "additions": 18,
      "deletions": 5
    },
    "files": [
      {
        "sha": "f2e6b67f8a8fc91cf2e7c5ebdfd8afcd57dea8dd",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 18,
        "deletions": 5,
        "changes": 23,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7d38af3c493f9ea24c722ec2e6d3c51f4e851364/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7d38af3c493f9ea24c722ec2e6d3c51f4e851364/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=7d38af3c493f9ea24c722ec2e6d3c51f4e851364",
        "patch": "@@ -3278,6 +3278,8 @@ void static ProcessGetData(CNode* pfrom)\n \n     vector<CInv> vNotFound;\n \n+    LOCK(cs_main);\n+\n     while (it != pfrom->vRecvGetData.end()) {\n         // Don't bother if send buffer is too full to respond anyway\n         if (pfrom->nSendSize >= SendBufferSize())\n@@ -3450,7 +3452,6 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n \n         pfrom->fClient = !(pfrom->nServices & NODE_NETWORK);\n \n-        AddTimeData(pfrom->addr, nTime);\n \n         // Change version\n         pfrom->PushMessage(\"verack\");\n@@ -3492,6 +3493,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n \n         LogPrintf(\"receive version message: version %d, blocks=%d, us=%s, them=%s, peer=%s\\n\", pfrom->nVersion, pfrom->nStartingHeight, addrMe.ToString().c_str(), addrFrom.ToString().c_str(), pfrom->addr.ToString().c_str());\n \n+        LOCK(cs_main);\n+        AddTimeData(pfrom->addr, nTime);\n         cPeerBlockCounts.input(pfrom->nStartingHeight);\n     }\n \n@@ -3595,6 +3598,9 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n                 break;\n             }\n         }\n+\n+        LOCK(cs_main);\n+\n         for (unsigned int nInv = 0; nInv < vInv.size(); nInv++)\n         {\n             const CInv &inv = vInv[nInv];\n@@ -3652,6 +3658,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n         uint256 hashStop;\n         vRecv >> locator >> hashStop;\n \n+        LOCK(cs_main);\n+\n         // Find the last block the caller has in the main chain\n         CBlockIndex* pindex = locator.GetBlockIndex();\n \n@@ -3686,6 +3694,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n         uint256 hashStop;\n         vRecv >> locator >> hashStop;\n \n+        LOCK(cs_main);\n+\n         CBlockIndex* pindex = NULL;\n         if (locator.IsNull())\n         {\n@@ -3728,6 +3738,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n         CInv inv(MSG_TX, tx.GetHash());\n         pfrom->AddInventoryKnown(inv);\n \n+        LOCK(cs_main);\n+\n         bool fMissingInputs = false;\n         CValidationState state;\n         if (mempool.accept(state, tx, true, &fMissingInputs))\n@@ -3802,6 +3814,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n         CInv inv(MSG_BLOCK, block.GetHash());\n         pfrom->AddInventoryKnown(inv);\n \n+        LOCK(cs_main);\n+\n         CValidationState state;\n         if (ProcessBlock(state, pfrom, &block))\n             mapAlreadyAskedFor.erase(inv);\n@@ -3823,6 +3837,8 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv)\n \n     else if (strCommand == \"mempool\")\n     {\n+        LOCK(cs_main);\n+\n         std::vector<uint256> vtxid;\n         LOCK2(mempool.cs, pfrom->cs_filter);\n         mempool.queryHashes(vtxid);\n@@ -4088,10 +4104,7 @@ bool ProcessMessages(CNode* pfrom)\n         bool fRet = false;\n         try\n         {\n-            {\n-                LOCK(cs_main);\n-                fRet = ProcessMessage(pfrom, strCommand, vRecv);\n-            }\n+            fRet = ProcessMessage(pfrom, strCommand, vRecv);\n             boost::this_thread::interruption_point();\n         }\n         catch (std::ios_base::failure& e)"
      }
    ]
  }
]