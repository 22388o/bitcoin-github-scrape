Krellan,2013-08-25T01:39:52Z,We've been having a fine discussion here: https://bitcointalk.org/index.php?topic=279652.0\n,https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23220118,23220118,
jgarzik,2013-08-25T02:28:30Z,"Seems like an awful lot of code for one simple feature...  no technical objection but... meh.   I would rather a simple hook system (boost signals?) that delivers a pong response, to anyone who pre-registers a pong handler for nonce X.  That would keep most of the code more in the RPC side of things.\n",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23220591,23220591,
Krellan,2013-08-25T09:40:46Z,"Thanks for the feedback.  It did end up being more code than I thought it would.  Reason is, there's 3 different protocol variations to contend with (no nonce, zero nonce, matching nonce).  Also, there was no pong receiver at all, so had to add that as well.\n\nI added a good amount of debug text in ""if (fDebug) ..."" blocks, which is rather verbose.  I'm surprised there's no dprintf() or similar m",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23224822,23224822,
sipa,2013-08-25T14:40:01Z,"ACK. \n\nIt's perhaps slightly over-complicated (rate-limiting user-requested pings?), but it's otherwise pretty much how I'd have suggested implementing it.\n\nOne nit: the ping RPC command could be a separate commit from the rest of the logic, but I don't feel strongly about this.\n",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23228769,23228769,
sipa,2013-08-25T14:41:17Z,"@jgarzik Agree that a hook-mechanism for dealing with incoming commands is probably the future, but we don't do that right now for other messages, and it's unreasonable to demand that in a pullreq like this.\n",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23228789,23228789,
Krellan,2013-08-26T00:51:13Z,"Thanks for the feedback.\n\nI will remove the ratelimit for user-requested outbound pings, since you're right, that does seem rather overcomplicated.\n\nAlso, good catch on indentation, I didn't see that.  Darn editor :)\n\nIt is strange to see a ping with a valid nonce be replied to with a pong with a nonce of 0.  However, this is very common on the wire, I have noticed.  I looked through the his",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23239127,23239127,
Krellan,2013-08-26T06:31:55Z,"I updated the commit.\n\nGot rid of the idea of rate-limiting user-requested RPC pings, that simplifies a chunk of code.\n\nCleaned up indentation.\n\nThe ""pingtime"" field shows only completed pings.  I took the liberty of adding a second field, ""pingwait"", that will only appear during the time a ping is in flight.  It will show you how long we have been waiting for that ping to complete.  This gi",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23245689,23245689,
gavinandresen,2013-08-26T07:13:16Z,"Why reinvent '/sbin/ping' ?  Why not just a little shell script that calls getpeerinfo, then uses the system ping to determine ping times?\n\nI'm a less-code-is-better kinda guy.\n",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23246945,23246945,
sipa,2013-08-26T07:23:34Z,"@gavinandresen There are many factors that affect Bitcoin P2P latency which you wouldn't notice through network-level ping (application throttling, peer having an overloaded receive queue, peer being DoS'ed, implementation problems...), and it will not work for every type of connection (incoming peers that are firewalled, or onion peers for example).\n\nAdditionally, having ping statistics inside ",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23247313,23247313,
Krellan,2013-08-26T07:44:54Z,"Thanks sipa, very well said.  That's the key reasons to have a ping at the Bitcoin layer, not just at the OS networking layer.\n",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23248106,23248106,
Krellan,2013-08-28T07:44:51Z,"I have put the ping/pong handlers in main.cpp on a diet.  Removed the printf statements, they have proved their usefulness during testing, but don't need to be in there permanently.\n",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23396736,23396736,
gmaxwell,2013-08-28T08:03:48Z,"> future heuristics when picking peers to sync/download from.\n\nAlso for picking peers to keep/discard when our connection slots are full: Low latency is something that a sibyl attacker can't just fake— he actually has to get close to you—, so it makes sense to full to reserve some slots for the lowest latency, apparently healthy peers.\n",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23397555,23397555,
Krellan,2013-08-28T23:51:28Z,"Thanks.  As talked about on IRC the other night, I restored some code that was in the before, to drop pong messages if they are received with a nonce of zero.  I am unsure what clients are sending these.  Their version string comes across as ""0.8.99"" but I haven't found any version history that would ever send a pong (not a ping!) with a nonce of zero.\n\nWhile running it overnight, I noticed yet ",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23457819,23457819,
mikehearn,2013-08-30T16:57:57Z,What are the subVers of the bad clients?\n,https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23575074,23575074,
Krellan,2013-08-31T06:20:57Z,"Investigating that now.  Frustratingly, it isn't happening anymore with my current set of peers that I'm connected to.\n",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23601453,23601453,
Krellan,2013-09-01T19:12:38Z,"Made some changes.\n\n1) Added more instrumentation to catch all of the anomalies that we've seen so far, in the pong handler.  Instead of previous bloat, they are all now unified into a single printf statement.\n\n2) Incoming pong message size is now checked.  Unfortunately, I did not find any more peers who were giving me those empty-payload pong messages, but if they show up again, they will be",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23631057,23631057,
Krellan,2013-09-04T08:53:23Z,Tested against latest top of tree and patch still applies cleanly.\n,https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-23774758,23774758,
Krellan,2013-09-07T22:02:18Z,Rebased the branch to catch up to latest master.\n,https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-24010723,24010723,
sipa,2013-09-23T23:19:32Z,ACK\n,https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-24963496,24963496,
sipa,2013-09-29T14:11:00Z,"@jgarzik @gavinandresen @gmaxwell Any further comments? I'd like this merged, to be able to add some automatic latency measurement on top.\n",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-25320951,25320951,
gavinandresen,2013-09-30T22:16:01Z,"s/printf(/LogPrint(""net""/ and I'm OK with merging.\n",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-25411179,25411179,
Krellan,2013-10-01T00:37:48Z,Great idea to use LogPrint instead.  Made that one-line change.  Also rebased it against the latest master.\n,https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-25418235,25418235,
Krellan,2013-10-04T08:24:27Z,"Fixed the merge.  The ""ping"" command doesn't require access to the wallet, of course, so the new column is false for it.\n",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-25683054,25683054,
BitcoinPullTester,2013-10-04T10:25:56Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/971bb3e901aad5d4f04a651e3e2a75161d3a4e2a for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/cu",https://github.com/bitcoin/bitcoin/pull/2937#issuecomment-25689615,25689615,
sipa,2013-08-25T14:08:11Z,"I think this should only be accepted if the negotiated protocol version (pnode->nVersion, AFAIK) is below BIP0031_VERSION (60000).\n\nEDIT: Wait, pong itself was only added in BIP0031.Which clients do reply with a 0 nonce? That sounds buggy...\n",https://github.com/bitcoin/bitcoin/pull/2937#discussion_r5968428,5968428,src/main.cpp
sipa,2013-08-25T14:35:33Z,Indentation.\n,https://github.com/bitcoin/bitcoin/pull/2937#discussion_r5968477,5968477,src/net.h
sipa,2013-09-29T14:08:32Z,"This will have to become a LogPrint(""net"", ...) I guess.\n",https://github.com/bitcoin/bitcoin/pull/2937#discussion_r6647269,6647269,src/main.cpp
