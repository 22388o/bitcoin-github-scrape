[
  {
    "sha": "1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxZTdkY2ZmZGVlN2Q3MWVjYWQ3YmRiM2M0ZGQyYjE3N2JhYWU2ZmU2",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2019-09-07T18:09:21Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2019-09-07T18:09:21Z"
      },
      "message": "Default to 2 additional blocks-only connections over Tor\n\nThis adds the 2 tor-only blocks-only outbound connections to the\nnew 2 blocks-only outbound connections we added recently. This is a\nnaive fix for the issue where we fail to attempt any outbound Tor\nconnections when our regular network is being censored, but should\nalso stand on its own.",
      "tree": {
        "sha": "79404a611c8b0af8150f43d166621d599eaf64ca",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/79404a611c8b0af8150f43d166621d599eaf64ca"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "189c19e012427a0068fc51b9fcb1428dc28aa681",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/189c19e012427a0068fc51b9fcb1428dc28aa681",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/189c19e012427a0068fc51b9fcb1428dc28aa681"
      }
    ],
    "stats": {
      "total": 27,
      "additions": 16,
      "deletions": 11
    },
    "files": [
      {
        "sha": "1441985df222e880c6d8e2872097312f516d2982",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 1,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6",
        "patch": "@@ -1761,7 +1761,11 @@ bool AppInitMain(InitInterfaces& interfaces)\n     connOptions.nLocalServices = nLocalServices;\n     connOptions.nMaxConnections = nMaxConnections;\n     connOptions.m_max_outbound_full_relay = std::min(MAX_OUTBOUND_FULL_RELAY_CONNECTIONS, connOptions.nMaxConnections);\n-    connOptions.m_max_outbound_block_relay = std::min(MAX_BLOCKS_ONLY_CONNECTIONS, connOptions.nMaxConnections-connOptions.m_max_outbound_full_relay);\n+    if (IsReachable(NET_ONION) && (IsReachable(NET_IPV4) || IsReachable(NET_IPV6))) {\n+        connOptions.m_max_outbound_block_relay = std::min(MAX_BLOCKS_ONLY_CONNECTIONS + MAX_EXTRA_TOR_BLOCKS_ONLY_CONNECTIONS, connOptions.nMaxConnections-connOptions.m_max_outbound_full_relay);\n+    } else {\n+        connOptions.m_max_outbound_block_relay = std::min(MAX_BLOCKS_ONLY_CONNECTIONS, connOptions.nMaxConnections-connOptions.m_max_outbound_full_relay);\n+    }\n     connOptions.nMaxAddnode = MAX_ADDNODE_CONNECTIONS;\n     connOptions.nMaxFeeler = 1;\n     connOptions.nBestHeight = chain_active_height;"
      },
      {
        "sha": "4c1e381e4d6bbf206f1eed94448e17aed27d908f",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 10,
        "changes": 19,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6",
        "patch": "@@ -1773,6 +1773,14 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n \n         addrman.ResolveCollisions();\n \n+        // Open this connection as block-relay-only if we're already at our\n+        // full-relay capacity, but not yet at our block-relay peer limit.\n+        // (It should not be possible for fFeeler to be set if we're not\n+        // also at our block-relay peer limit, but check against that as\n+        // well for sanity.)\n+        bool block_relay_only = nOutboundBlockRelay < m_max_outbound_block_relay && !fFeeler && nOutboundFullRelay >= m_max_outbound_full_relay;\n+        bool block_relay_tor_only = block_relay_only && nOutboundBlockRelay >= MAX_BLOCKS_ONLY_CONNECTIONS;\n+\n         int64_t nANow = GetAdjustedTime();\n         int nTries = 0;\n         while (!interruptNet)\n@@ -1801,7 +1809,7 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n             if (nTries > 100)\n                 break;\n \n-            if (!IsReachable(addr))\n+            if (!IsReachable(addr) || (block_relay_tor_only && addr.GetNetwork() != NET_ONION))\n                 continue;\n \n             // only consider very recently tried nodes after 30 failed attempts\n@@ -1826,22 +1834,13 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n         }\n \n         if (addrConnect.IsValid()) {\n-\n             if (fFeeler) {\n                 // Add small amount of random noise before connection to avoid synchronization.\n                 int randsleep = GetRandInt(FEELER_SLEEP_WINDOW * 1000);\n                 if (!interruptNet.sleep_for(std::chrono::milliseconds(randsleep)))\n                     return;\n                 LogPrint(BCLog::NET, \"Making feeler connection to %s\\n\", addrConnect.ToString());\n             }\n-\n-            // Open this connection as block-relay-only if we're already at our\n-            // full-relay capacity, but not yet at our block-relay peer limit.\n-            // (It should not be possible for fFeeler to be set if we're not\n-            // also at our block-relay peer limit, but check against that as\n-            // well for sanity.)\n-            bool block_relay_only = nOutboundBlockRelay < m_max_outbound_block_relay && !fFeeler && nOutboundFullRelay >= m_max_outbound_full_relay;\n-\n             OpenNetworkConnection(addrConnect, (int)setConnected.size() >= std::min(nMaxConnections - 1, 2), &grant, nullptr, false, fFeeler, false, block_relay_only);\n         }\n     }"
      },
      {
        "sha": "433abff9923793b30026dbe837a7ebd40bfa2192",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6",
        "patch": "@@ -67,6 +67,8 @@ static const int MAX_OUTBOUND_FULL_RELAY_CONNECTIONS = 8;\n static const int MAX_ADDNODE_CONNECTIONS = 8;\n /** Maximum number of block-relay-only outgoing connections */\n static const int MAX_BLOCKS_ONLY_CONNECTIONS = 2;\n+/** Maximum number of block-relay-only outgoing connections made only to Tor nodes */\n+static const int MAX_EXTRA_TOR_BLOCKS_ONLY_CONNECTIONS = 2;\n /** -listen default */\n static const bool DEFAULT_LISTEN = true;\n /** -upnp default */"
      }
    ]
  },
  {
    "sha": "5a195bb387bab9230ed953dca25890570500e783",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1YTE5NWJiMzg3YmFiOTIzMGVkOTUzZGNhMjU4OTA1NzA1MDBlNzgz",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2019-09-07T18:13:02Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2019-09-07T18:13:02Z"
      },
      "message": "Bump default max connections to 150 from 125.\n\nThis should more than compensate for the recent increase in default\noutbound connections, but also should help Tor-listening nodes not\nget overwhelmed due to the relative fewer number of them.",
      "tree": {
        "sha": "0f6d9a261358e51fe1322aceab7abc10c13059fb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0f6d9a261358e51fe1322aceab7abc10c13059fb"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5a195bb387bab9230ed953dca25890570500e783",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5a195bb387bab9230ed953dca25890570500e783",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/5a195bb387bab9230ed953dca25890570500e783",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5a195bb387bab9230ed953dca25890570500e783/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1e7dcffdee7d71ecad7bdb3c4dd2b177baae6fe6"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 1,
      "deletions": 1
    },
    "files": [
      {
        "sha": "9ac67f7d6657868c7f9b91c0193c1410d8221033",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5a195bb387bab9230ed953dca25890570500e783/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5a195bb387bab9230ed953dca25890570500e783/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=5a195bb387bab9230ed953dca25890570500e783",
        "patch": "@@ -78,7 +78,7 @@ static const bool DEFAULT_UPNP = USE_UPNP;\n static const bool DEFAULT_UPNP = false;\n #endif\n /** The maximum number of peer connections to maintain. */\n-static const unsigned int DEFAULT_MAX_PEER_CONNECTIONS = 125;\n+static const unsigned int DEFAULT_MAX_PEER_CONNECTIONS = 150;\n /** The default for -maxuploadtarget. 0 = Unlimited */\n static const uint64_t DEFAULT_MAX_UPLOAD_TARGET = 0;\n /** The default timeframe for -maxuploadtarget. 1 day. */"
      }
    ]
  }
]