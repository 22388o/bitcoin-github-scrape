laanwj,2014-06-17T14:37:51Z,"IMHO we should get rid of myclosesocket and the crazy construction in compat.h and make it a pure compatibility wrapper (**only** defined on unix), without extra functionality and checks.\nRedefining an existing API function with unexpected behavior in the guise of a compatibility wrapper is just too crazy.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-46315397,46315397,
Diapolo,2014-06-17T18:42:40Z,"@laanwj I reworked our closesocket() to only be active on Non-Windows OSes, Windows now uses the pure API call.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-46348124,46348124,
laanwj,2014-06-18T13:16:29Z,The hard part now will be checking all existing closesocket() calls and determining if they should be followed by `hSocket = INVALID_SOCKET`.\n,https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-46433579,46433579,
Diapolo,2014-06-18T13:19:32Z,"If you mind looking at #3461 and we can get that merged, it would remove quite a few of them ;). Also the closesocket() during network init for listen sockets should be easy, which is also true for socks5(). Not sure if there are that many left then...\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-46433899,46433899,
laanwj,2014-06-21T10:37:18Z,"Hmm, thinking further about this, another way would be to define a CSocket class with move semantics (and a method `Close()`, at least, to force closing), and use that instead of passing raw file handles around.\nThis could avoid socket leaks completely by using RAII.\nIt's somewhat more complex and involved, but as we have to change every call site of closesocket() anyway it may be something to t",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-46750127,46750127,
sipa,2014-06-21T20:25:50Z,I like the idea of a RAII wrapper for sockets.\n,https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-46763862,46763862,
Diapolo,2014-06-22T01:08:12Z,"@sipa @laanwj I started implementing CSocket, can you give me some feedback and help to see if I'm on the right track please :). See: https://github.com/Diapolo/bitcoin/commit/1c5873e0ba4cc466c11e5a0dbc779d78b5662075\n\nEdit: The new class is currently only used for listening sockets to show the current implementation state.\nEdit 2: Also it seems that code is currently not working ^^... seems to ",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-46769435,46769435,
Diapolo,2014-06-22T11:23:44Z,"@laanwj @sipa Alright, I was able to fix the problems from last night. During BOOST_FOREACH processing existing sockets were copied/used and got closed by the destructor after the loop ^^. This is now fixed by a new flag `fCloseOnDestruct` in the CSocket class. I need some initial feedback now :).\n\nCommit is at: https://github.com/Diapolo/bitcoin/commit/079dab40b8e2d88786d2fd0bef9025afa5719b9d\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-46778519,46778519,
Diapolo,2014-06-22T12:58:25Z,"I'm going for some incremental pulls that are included here, see #4388 for the first one.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-46780503,46780503,
Diapolo,2014-06-24T07:21:06Z,"Did anyone take a look at the RAII class yet? I don't want to continue, if it's bugged or it's implementation is not correct.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-46939311,46939311,
jgarzik,2014-06-26T14:35:44Z,"If we are going to have an RAII CSocket, we might as well add classes Connection, SocketServer, IOEngine.\n\nThen we can ditch boost::asio for the RPC server, and use that instead.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-47233441,47233441,
laanwj,2014-06-26T14:48:03Z,"@diapolo No, haven't got around to it.\n\n@jgarzik I disagree we should be spending time writing and maintaining our own asynchronous I/O library. It's not like we're innovating anything here. If we want to ditch boost::asio we should switch to something which is well-known to be robust and high-performance like libevent (or derivatives). \n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-47235024,47235024,
jgarzik,2014-06-26T14:53:13Z,"If we don't want our own async I/O lib, then adding RAII CSocket is moving in the wrong direction.  boost::asio already has portable socket classes and much much more.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-47235736,47235736,
laanwj,2014-06-26T15:07:45Z,Well - in principle I agree that using the same network library everywhere would be a good thing. But  I know at least @gmaxwell doesn't like boost::asio and doesn't want to switch the P2P code to it.\n\nSo at some point we have to make a decision about what async networking library to use. Not necessarily now.\n\nThe point here was to get rid of the strange compat.h behavior - a compatibility wra,https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-47237754,47237754,
Diapolo,2014-07-01T08:11:44Z,"@laanwj Thinking about `always call closesocket() before printing any text (ensure consistent usage in the code)`... closesocket() can fail, which would likely interact with our `LogPrint()`... so I guess it's a good idea to first log and close the socket afterwards... but then everywhere in our code.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-47628580,47628580,
laanwj,2014-07-01T08:16:52Z,"@Diapolo Well in cases where the purpose of the Logprintf is to log the error it should definitely be logged before the close, otherwise it will log the status of the close(). In other cases it doesn't matter what you do first.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-47629025,47629025,
Diapolo,2014-07-01T08:23:23Z,"@laanwj Right, it's only relevant, when a call to `NetworkErrorString()` is used for the logging.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-47629610,47629610,
Diapolo,2014-07-15T15:52:09Z,Did anyone look at the RAII wrapper yet or is this considered unhelpful in the end?\nEdit: I know this needs a rebase now...\n,https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-49052521,49052521,
laanwj,2014-07-16T09:38:00Z,"@Diapolo I've looked at it and it looks okay, but as @jgarzik says it may be too much if we intend to move to some other async networking library for P2P. Although it is clearly the way forward - from another async networking library we'd expect nothing less - right now it may brings subtle new bugs that have to be debugged. So I prefer the more trivial change in #4504 for now.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-49142227,49142227,
Diapolo,2014-07-16T10:34:53Z,"@laanwj Rebased and updated to include changes for node whitelisting. I'm not sure #4504 is an alternative, as it's ""just"" refactoring.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-49148042,49148042,
Diapolo,2014-07-21T12:58:11Z,"@laanwj I reworked and rethought this, there is no need to try to emulate WIN32 `closesocket()` behaviour for non-WIN32, as `close()` gives error `EBADF - fd isn't a valid open file descriptor.`, which we typedef as `WSAENOTSOCK` in compat.h anyway ;). So they behave the same already.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-49601813,49601813,
jgarzik,2014-07-21T13:01:05Z,CSocket seems to add never-used methods and flags.\n,https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-49602083,49602083,
Diapolo,2014-07-21T13:11:11Z,"@jgarzik Right, the ones who are unused are `void SetCloseOnDestruct(bool fFlag);` and `void SetWhitelisted(bool fFlag);` and I mentioned that in a comment in the source. Also CSocket is currently ONLY used for listen sockets, because I didn't want to change the whole source, before anyone gave some feedback to my implementation.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-49603037,49603037,
BitcoinPullTester,2014-07-21T13:31:22Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4348_684bec2f41d0963fe24cf55cd397b962a25529cf/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-te",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-49605160,49605160,
kazcw,2014-07-21T17:17:29Z,"The move semantics seem important. Right now you can copy or assign a socket and have two sockets using the same handle; then if one goes out of scope or is `Close()`ed the other will have its underlying socket closed without `CloseSocket` setting `hSocket` to `INVALID_SOCKET`, so it still returns `IsValid()==true`. With cloning disallowed, `fCloseOnDestruct` shouldn't be necessary.\n\nPutting the",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-49635992,49635992,
Diapolo,2014-07-25T15:48:11Z,@kazcw I guess I need some more help to implement what you suggest about disallow cloning. Makes sense that no CSocket should have the same handle. How can this be achieved?\n,https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-50167510,50167510,
kazcw,2014-07-25T17:12:13Z,"To prevent copying, you can declare a private copy constructor with no implementation.\n\nvhListenSocket would need to be a vector of pointers.\n",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-50177806,50177806,
laanwj,2014-08-04T15:40:25Z,"As said before, I deem the RAII changes too risky for what it would bring and am not going to merge it, sorry. \n\nThis would make sense as part of a change that wraps all networking behavior in proper classes, but if we make such a high-impact change to networking we should consider switching to an existing high-performance async networking library instead of mucking about with our own.\n\nSometh",https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-51076850,51076850,
Diapolo,2014-08-05T11:42:57Z,@laanwj I created #4636 as these changes seem uncontroversial.\n,https://github.com/bitcoin/bitcoin/pull/4348#issuecomment-51185913,51185913,
laanwj,2014-06-17T14:18:43Z,"Don't remove this check! hSocket can be INVALID_SOCKET if there is currently no connection open, in which case no closing needs to be done either.\n",https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13860879,13860879,src/net.cpp
laanwj,2014-06-17T14:19:02Z,"This hSocket = INVALID_SOCKET is used to mark the connection as closed, don't remove it.\n",https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13860904,13860904,src/net.cpp
Diapolo,2014-06-17T14:20:32Z,`closesocket(hSocket);` does exactly that...\n,https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13861029,13861029,src/net.cpp
Diapolo,2014-06-17T14:22:34Z,"That check could then perhaps be rewritten to?\n\n<pre>\nif (closesocket(hSocket) != WSAENOTSOCK)\n    LogPrint(""net"", ""disconnecting node %s\n"", addrName);\n</pre>\n",https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13861143,13861143,src/net.cpp
laanwj,2014-06-17T14:24:49Z,"Again, keep this check. hSocket can be INVALID_SOCKET, in which case closesocket should not be called on it.\n",https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13861296,13861296,src/net.h
laanwj,2014-06-17T14:26:41Z,"Good catch, this was a potential (one-time) socket leak.\n",https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13861419,13861419,src/net.cpp
laanwj,2014-06-17T14:29:25Z,WTF?!? closesocket(x) changes the value of x? That's terribly unexpected. I don't like that at all.\n,https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13861597,13861597,src/net.cpp
Diapolo,2014-06-17T14:29:44Z,"See my comment above, that check IS done in `closesocket(hSocket);` we did a redefinition of that function and added some nice checks to it (IMHO).\n",https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13861616,13861616,src/net.h
laanwj,2014-06-17T14:31:13Z,"That would work. But I like the previous, explicit check better. It's just more clear ""close the socket when we're connected"" versus ""try closing and log a message if it fails"".\n",https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13861698,13861698,src/net.cpp
Diapolo,2014-06-17T14:32:27Z,"If you like or not, that IS the case for all calls to the function currently... we use closesocket() as a wrapper for the os specific ones and added some things. What would you suggest doing? IMHO it's a lot of duplication if we want to check everytime if a socket has state INVALID_SOCKET before calling our closesocket() function, no?\n",https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13861798,13861798,src/net.cpp
laanwj,2014-06-17T14:50:05Z,I prefer a bit of duplication over a closesocket() call that does something else than the WIN32 API specifies.\n,https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13863036,13863036,src/net.cpp
Diapolo,2014-06-17T14:53:17Z,"I'm convinced, but AFAIK there are only the 2 lines in CNode that check for INVALID_SOCKET before closing, is this still correct after cleaning up closesocket() (which I'll gladly do)?\n",https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13863290,13863290,src/net.cpp
laanwj,2014-06-17T16:22:48Z,"I think the goal should be to make closesocket() emulate the WIN32 closesocket on Linux, and don't redefine it when WIN32 at all. As we don't define the function on WIN32 anymore we can rename the function from `myclosesocket` to `closesocket`.\n\nAccording to http://msdn.microsoft.com/en-us/library/windows/desktop/ms737582%28v=vs.85%29.aspx this behavior is to return WSAENOTSOCK when an invalid s",https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13869399,13869399,src/net.cpp
laanwj,2014-06-18T13:14:10Z,"this can be just `SOCKET hSocket` now like a normal parameter, no need for it to be a reference anymore :)\n",https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13913578,13913578,src/compat.h
Diapolo,2014-06-18T13:20:10Z,Isn't a reference better because we then use no extra copy?\n,https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13913832,13913832,src/compat.h
laanwj,2014-06-18T13:30:17Z,For large types such as structures and objects that can be true (but then we'd use a _const_ reference). For small types like integers and handles it's only overhead. On 64-bit architectures a pointer to an integer is larger than the integer itself.\n,https://github.com/bitcoin/bitcoin/pull/4348#discussion_r13914267,13914267,src/compat.h
Diapolo,2014-06-22T01:09:44Z,Understood and will be changed :).\n,https://github.com/bitcoin/bitcoin/pull/4348#discussion_r14052505,14052505,src/compat.h
Diapolo,2014-07-21T12:54:52Z,@laanwj As you add this check in `CloseSocket()` this should be fine now :).\n,https://github.com/bitcoin/bitcoin/pull/4348#discussion_r15166680,15166680,src/net.h
