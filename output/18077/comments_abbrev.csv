DrahtBot,2020-02-05 23:18:08,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #20864 (net: Move SocketSendData lock annotation to header by MarcoFalke)\n* #20744 ([POC] Use std::filesystem. Remove Boo",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-582659603,582659603,
laanwj,2020-02-06 11:22:12,Thanks for picking this up again. I hope we manage to do this this time.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-582859339,582859339,
luke-jr,2020-02-06 18:16:15,Concept ACK,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-583039181,583039181,
hebasto,2020-02-07 20:53:20,It is ready for reviewing now.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-583606396,583606396,
hebasto,2020-02-07 21:49:43,"Updated 4ff5349a3172d02fceb976bf4989996c88f86680 -> cf94431e8f4bfd6636998a17e2355feb2c5c3d58 ([pr18077.03](https://github.com/hebasto/bitcoin/commits/pr18077.03) -> [pr18077.04](https://github.com/hebasto/bitcoin/commits/pr18077.04), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.03..pr18077.04)):\n\nadded `libnatpmp` package to macOS 10.14 native Travis build.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-583630233,583630233,
hebasto,2020-02-08 08:17:25,"Updated cf94431e8f4bfd6636998a17e2355feb2c5c3d58 -> 88248a44241c8e3922a80729ce4a9a178ef2dbea ([pr18077.04](https://github.com/hebasto/bitcoin/commits/pr18077.04) -> [pr18077.05](https://github.com/hebasto/bitcoin/commits/pr18077.05), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.04..pr18077.05)):\n\nadded:\n- changes to docs\n- release notes",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-583715048,583715048,
hebasto,2020-02-10 17:20:14,Rebased after #17398 and #18081 have been merged.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584234105,584234105,
dongcarl,2020-02-10 19:26:14,"Concept ACK, will test on my home router.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584307307,584307307,
Sjors,2020-02-11 17:57:03,"Concept ACK. Lightly tested configure / build on macOS.\n\nUnfortunately I'm behind a IPv6 DS-Lite router, I can't test the IPv4 port forward. Perhaps `-7` could be replaced by something more readable.\n\n```\n2020-02-11T17:48:27Z natpmp thread start\n2020-02-11T17:48:27Z Bound to [::]:8333\n2020-02-11T17:48:27Z Bound to 0.0.0.0:8333\n2020-02-11T17:48:27Z init message: Loading P2P addresse",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584768149,584768149,
hebasto,2020-02-11 19:11:03,"@Sjors \n\nThank you for your review and testing.\n\n> I looked up the error code, and it's what I would expect given my setup:\n> \n> ```\n> /* NATPMP_ERR_NOGATEWAYSUPPORT : the gateway does not support NAT-PMP */\n> #define NATPMP_ERR_NOGATEWAYSUPPORT (-7)\n> ```\n\nAgree.\nBut in this initial PR I intentionally do not provide user-friendly error messages in order to keep `ThreadNatp",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-584801614,584801614,
hebasto,2020-02-16 15:59:47,"Updated c7e90ca40ad9b7c66f3429b792435e9279ceca6b -> dc228d6db8d2e9406d6d6e0eb04e37940b1ffb82 ([pr18077.06](https://github.com/hebasto/bitcoin/commits/pr18077.06) -> [pr18077.07](https://github.com/hebasto/bitcoin/commits/pr18077.07), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.06..pr18077.07)):\n\nChanges:\n- added a user-friendly error message for the `NATPMP_ERR_NOGATEWAYSUPP",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-586722575,586722575,
luke-jr,2020-02-17 02:13:44,"The logic here still seems broken. Again, consider that users may migrate between different routers each with NAT-PMP or UPnP support. So there should be a common thread main that *at each refresh* (which ideally should trigger when network availability changes, but that can be another PR) checks for which protocol to use and does the right thing.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-586789305,586789305,
hebasto,2020-02-17 06:28:14,"@luke-jr \n> The logic here still seems broken. Again, consider that users may migrate between different routers each with NAT-PMP or UPnP support. So there should be a common thread main that _at each refresh_ (which ideally should trigger when network availability changes, but that can be another PR) checks for which protocol to use and does the right thing.\n\n`ThreadAnyAvailable()` does alm",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-586837309,586837309,
luke-jr,2020-02-17 14:23:34,"Yes, re-reading it, you're right, it does. I saw the loops in the per-protocol functions and missed the outer one.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-587017420,587017420,
hebasto,2020-02-17 16:55:48,"Updated dc228d6db8d2e9406d6d6e0eb04e37940b1ffb82 -> 2d5d98ce0aa07401c6771731f4e27634629f197c ([pr18077.07](https://github.com/hebasto/bitcoin/commits/pr18077.07) -> [pr18077.08](https://github.com/hebasto/bitcoin/commits/pr18077.08), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.07..pr18077.08)):\n\nChanges:\n- addressed @luke-jr's [comment](https://github.com/bitcoin/bitcoin/pul",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-587082936,587082936,
hebasto,2020-02-18 22:01:10,"Updated 2d5d98ce0aa07401c6771731f4e27634629f197c -> ccb4a7ea18c38914f084b7c070303d020adad326 ([pr18077.08](https://github.com/hebasto/bitcoin/commits/pr18077.08) -> [pr18077.09](https://github.com/hebasto/bitcoin/commits/pr18077.09), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.08..pr18077.09)):\n\n- fixed a [bug](https://github.com/bitcoin/bitcoin/pull/18077#discussion_r38035296",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-587924741,587924741,
dongcarl,2020-02-18 23:11:08,"Hi all, did some testing on ccb4a7ea18c38914f084b7c070303d020adad326. What I did:\n\n1. Installed natpmpd on my OpenBSD gateway router\n2. Started `natpmpd`, added relevant `pf.conf` line, reloaded `pf`\n3. Configure and compile `bitcoind` with `--without-miniupnpc --disable-bench --disable-wallet --without-gui --with-natpmp`\n4. Start `bitcoind` with `-natpmp`\n5. Saw the following lines:\",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-587950934,587950934,
luke-jr,2020-02-19 00:19:20,"If NAT-PMP allows ignoring the suggested port, then we probably should handle that by advertising the correct port for the external IP in addrman.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-587970728,587970728,
hebasto,2020-02-19 09:29:07,"@dongcarl \nThank you for testing this PR with [`natpmpd`](https://github.com/bodgit/natpmpd) on OpenBSD (I've tested with [`miniupnpd`](https://github.com/miniupnp/miniupnp/tree/master/miniupnpd) on OpenWrt).\n\n> I believe this is because `natpmpd` ignores our ""Suggested External Port"", which is perfectly valid, and we should probably account for that possibility.\n\nCorrect. From `natpmpd`",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-588121365,588121365,
hebasto,2020-02-19 20:05:31,"Updated ccb4a7ea18c38914f084b7c070303d020adad326 -> 03e2733be1772ef69caf34e84c7b400f64a8ea9f ([pr18077.09](https://github.com/hebasto/bitcoin/commits/pr18077.09) -> [pr18077.10](https://github.com/hebasto/bitcoin/commits/pr18077.10), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.09..pr18077.10)):\n\n- aligned with RFC 6886\n\n@dongcarl @luke-jr \nThank you for your reviews. All",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-588422681,588422681,
luke-jr,2020-02-19 21:37:16,"I suggest putting the variable renames in a separate commit for easier review.\n\nAlso, since NAT-PMP apparently maps random ports often, I think we should prefer UPnP...",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-588484002,588484002,
hebasto,2020-02-20 07:56:53,"@luke-jr \n> I suggest putting the variable renames in a separate commit for easier review.\n\nThere is a dedicated commit ""refactor: Rename UPnP stuff"" (a2de373a96dc1b9f5374eb70d605dcaf49f9b244).\nWhat variable rename did I miss to put it to?",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-588713300,588713300,
hebasto,2020-02-20 23:21:05,"Updated 03e2733be1772ef69caf34e84c7b400f64a8ea9f -> dd3229e7af8563c69d26955c4207f73ae1d3bc94 ([pr18077.10](https://github.com/hebasto/bitcoin/commits/pr18077.10) -> [pr18077.11](https://github.com/hebasto/bitcoin/commits/pr18077.11), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.10..pr18077.11)):\n\n- fixed CI issues\n- the NAT-PMP checkbox added to the GUI (this simplifies testi",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589405068,589405068,
hebasto,2020-02-20 23:42:08,"@luke-jr \n> Also, since NAT-PMP apparently maps random ports often, I think we should prefer UPnP...\n\nDoes this behavior of NAT-PMP gateways hurt the entire p2p network?\n\nOTOH, NAT-PMP seems more secure than UPnP (for example, one could compare numbers of CVEs for each protocol).",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589416424,589416424,
luke-jr,2020-02-20 23:52:35,">Does this behavior of NAT-PMP gateways hurt the entire p2p network?\n\nDNS seeds can't provide port numbers, so using anything other than 8333 reduces the list of nodes we can advertise. Currently, mine (which is IIRC more restrictive than others) has 3090 eligible nodes, so it's not a big deal, but it'd be nicer to have a wider selection available than a narrower selection.\n\n> OTOH, NAT-PM",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589428754,589428754,
luke-jr,2020-02-21 19:01:56,"Re NAT-PMP preference: Also, with the port number changing every startup, it will be hard for peers to reconnect or meaningfully pass on addr messages for you...\n\nI think cd7a0f689c5 should get split up. It's too hard to follow what it's doing.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589789757,589789757,
hebasto,2020-02-22 08:43:17,"> Re NAT-PMP preference: Also, with the port number changing every startup, it will be hard for peers to reconnect or meaningfully pass on addr messages for you...\n\nOnly [`natpmpd`](https://github.com/bodgit/natpmpd) on OpenBSD will change external port number on every startup.\n[`miniupnpd`](https://github.com/miniupnp/miniupnp/tree/master/miniupnpd) assigns suggested one, i.e. 8333.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589933497,589933497,
luke-jr,2020-02-22 16:00:11,"Yes, but UPnP is reliably using the same/requested port if it works.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589969568,589969568,
hebasto,2020-02-23 01:00:57,"Updated dd3229e7af8563c69d26955c4207f73ae1d3bc94 -> d9ecda8fa0ebce5b6da972691b19f4425164ae43 ([pr18077.11](https://github.com/hebasto/bitcoin/commits/pr18077.11) -> [pr18077.12](https://github.com/hebasto/bitcoin/commits/pr18077.12), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.11..pr18077.12)):\n\n- UPnP is prioritized (as @luke-jr suggested)\n- a note about possible random ext",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-590014625,590014625,
hebasto,2020-02-25 17:27:57,"Updated d9ecda8fa0ebce5b6da972691b19f4425164ae43 -> 405e85c61a6690ff2f7159c51715fdbafcbf2b1e ([pr18077.12](https://github.com/hebasto/bitcoin/commits/pr18077.12) -> [pr18077.13](https://github.com/hebasto/bitcoin/commits/pr18077.13), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.12..pr18077.13)):\n\n- `StartThread()` renamed to `StartThreadMapPort()` (as @luke-jr [suggested)](http",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-590977043,590977043,
hebasto,2020-02-26 07:45:59,"Updated 405e85c61a6690ff2f7159c51715fdbafcbf2b1e -> 4e7b9f03b8a3dd02bc9831e77905a8022770c846 ([pr18077.13](https://github.com/hebasto/bitcoin/commits/pr18077.13) -> [pr18077.14](https://github.com/hebasto/bitcoin/commits/pr18077.14), [compare](https://github.com/hebasto/bitcoin/compare/pr18077.13..pr18077.14)):\n\n- corrected copyright years as @sipa [suggested](https://github.com/bitcoin/bitcoi",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-591285675,591285675,
hebasto,2020-03-03 15:29:40,Rebased after #17399 has been merged.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-594010099,594010099,
hebasto,2020-03-11 16:12:13,Rebased due to the conflict with merged #18264.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-597724976,597724976,
hebasto,2020-03-28 18:50:18,Rebased 4be5c3c72d98b616367d1aa3de22702e6f9f81ee -> 1bf61f0557637b5bedd670a4fba7bb11bf42ac6a due to the conflicts with #18134 and #18438.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-605503139,605503139,
hebasto,2020-04-11 13:13:16,Rebased 1bf61f0557637b5bedd670a4fba7bb11bf42ac6a -> 607144bab1aecb8b970e17aeb145d62175d58c4c ([pr18077.17](https://github.com/hebasto/bitcoin/commits/pr18077.17) -> [pr18077.18](https://github.com/hebasto/bitcoin/commits/pr18077.18)) due to the conflicts with #18514 and #16367.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-612418519,612418519,
hebasto,2020-04-11 14:43:35,Rebased 607144bab1aecb8b970e17aeb145d62175d58c4c -> a388fae1dca9b4983bc95d50d07503aae527f29e ([pr18077.18](https://github.com/hebasto/bitcoin/commits/pr18077.18) -> [pr18077.19](https://github.com/hebasto/bitcoin/commits/pr18077.19)) due to the conflict with #18588.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-612436848,612436848,
hebasto,2020-04-16 16:51:20,Rebased a388fae1dca9b4983bc95d50d07503aae527f29e -> 95e943cb1855dca3ed5fb4fd98b357515d1a3646 ([pr18077.19](https://github.com/hebasto/bitcoin/commits/pr18077.19) -> [pr18077.20](https://github.com/hebasto/bitcoin/commits/pr18077.20)) due to the conflict with #18571.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-614770003,614770003,
hebasto,2020-04-20 19:10:31,Rebased 95e943cb1855dca3ed5fb4fd98b357515d1a3646 -> f4a4643712eca819a5b7ed0a143216e06125d1a9 ([pr18077.20](https://github.com/hebasto/bitcoin/commits/pr18077.20) -> [pr18077.21](https://github.com/hebasto/bitcoin/commits/pr18077.21)) due to the conflicts with #18676 and #18705.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-616752414,616752414,
tryphe,2020-05-17 04:28:26,"tACK f4a4643712eca819a5b7ed0a143216e06125d1a9 on Debian 9\n\n```\n2020-05-17T04:14:52Z NAT-PMP: Port mapping successful. External address = [redacted]:8333\n2020-05-17T04:22:05Z NAT-PMP: Port mapping removed successfully.\n```\n\nThe port is accessible externally without any other forwarding rules.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-629741483,629741483,
hebasto,2020-05-19 16:24:10,Rebased f4a4643712eca819a5b7ed0a143216e06125d1a9 -> 2f7a01708482ad9f8fede1d7b7a9d59901370aa1 ([pr18077.21](https://github.com/hebasto/bitcoin/commits/pr18077.21) -> [pr18077.22](https://github.com/hebasto/bitcoin/commits/pr18077.22)) due to the conflict with #19008.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-630930056,630930056,
hebasto,2020-05-22 05:33:43,Rebased 2f7a01708482ad9f8fede1d7b7a9d59901370aa1 -> f0cf6523c9fb4c3bb0bc64af72cdcadfa7747748 ([pr18077.22](https://github.com/hebasto/bitcoin/commits/pr18077.22) -> [pr18077.23](https://github.com/hebasto/bitcoin/commits/pr18077.23)) due to the conflict with #18677.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-632491960,632491960,
hebasto,2020-05-22 11:38:54,Rebased f0cf6523c9fb4c3bb0bc64af72cdcadfa7747748 -> 1b006d618d02eac38bd434937d6d5c42084992bf ([pr18077.23](https://github.com/hebasto/bitcoin/commits/pr18077.23) -> [pr18077.24](https://github.com/hebasto/bitcoin/commits/pr18077.24)) due to the conflict with #19014.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-632647985,632647985,
hebasto,2020-06-04 07:09:16,Rebased 1b006d618d02eac38bd434937d6d5c42084992bf -> 0692bed243adb8d4f3aa8192e9d1952d1de4a2ad ([pr18077.24](https://github.com/hebasto/bitcoin/commits/pr18077.24) -> [pr18077.25](https://github.com/hebasto/bitcoin/commits/pr18077.25)) due to the conflict with #19041.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-638649592,638649592,
hebasto,2020-06-08 15:06:35,Rebased 0692bed243adb8d4f3aa8192e9d1952d1de4a2ad -> 5a29078b373f5ffecb452317a1bd6fb165b08b42 ([pr18077.25](https://github.com/hebasto/bitcoin/commits/pr18077.25) -> [pr18077.26](https://github.com/hebasto/bitcoin/commits/pr18077.26)) due to the conflict with #19180.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-640688912,640688912,
hebasto,2020-06-20 08:01:49,Rebased 5a29078b373f5ffecb452317a1bd6fb165b08b42 -> 570c1060058d7f52286107df217b66d28d0b1f91 ([pr18077.26](https://github.com/hebasto/bitcoin/commits/pr18077.26) -> [pr18077.27](https://github.com/hebasto/bitcoin/commits/pr18077.27)) due to the conflict with #19267.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-646960469,646960469,
hebasto,2020-07-03 07:16:58,Rebased 570c1060058d7f52286107df217b66d28d0b1f91 -> a660ecc26e691ed9b931d6fe27c26899ef66be64 ([pr18077.27](https://github.com/hebasto/bitcoin/commits/pr18077.27) -> [pr18077.28](https://github.com/hebasto/bitcoin/commits/pr18077.28)) due to the conflict with #19331.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-653393228,653393228,
hebasto,2020-07-05 09:06:20,"Rebased a660ecc26e691ed9b931d6fe27c26899ef66be64 -> d4a143ae233fc5fd0cb3c08ce7c388434d256574 ([pr18077.28](https://github.com/hebasto/bitcoin/commits/pr18077.28) -> [pr18077.29](https://github.com/hebasto/bitcoin/commits/pr18077.29),  [diff](https://github.com/hebasto/bitcoin/compare/pr18077.28..pr18077.29)):\n\n- fixed dependency `libnatpmp` build with the custom `CC` variable.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-653861394,653861394,
hebasto,2020-07-10 07:55:51,Rebased d4a143ae233fc5fd0cb3c08ce7c388434d256574 -> b61233d7ab4afe6cd7875b178e923fab59f0534a ([pr18077.29](https://github.com/hebasto/bitcoin/commits/pr18077.29) -> [pr18077.30](https://github.com/hebasto/bitcoin/commits/pr18077.30)) due to the conflicts with #19191 and #19314.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-656540518,656540518,
hebasto,2020-07-14 08:17:47,Rebased b61233d7ab4afe6cd7875b178e923fab59f0534a -> 1c4bfdb46d48fed6c3f43bbdd7973069cdd21baf ([pr18077.30](https://github.com/hebasto/bitcoin/commits/pr18077.30) -> [pr18077.31](https://github.com/hebasto/bitcoin/commits/pr18077.31)) due to the conflict with #19495.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-658041248,658041248,
hebasto,2020-07-16 18:42:43,Rebased 1c4bfdb46d48fed6c3f43bbdd7973069cdd21baf -> 155d87877c11a32abe1ed91799776691b5977a31 ([pr18077.31](https://github.com/hebasto/bitcoin/commits/pr18077.31) -> [pr18077.32](https://github.com/hebasto/bitcoin/commits/pr18077.32)) due to the conflict with #17919.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-659598396,659598396,
hebasto,2020-07-31 12:14:16,Rebased 155d87877c11a32abe1ed91799776691b5977a31 -> 88b1f0357c332bc67fa20450dda9f77fa449576e ([pr18077.32](https://github.com/hebasto/bitcoin/commits/pr18077.32) -> [pr18077.33](https://github.com/hebasto/bitcoin/commits/pr18077.33)) due to the conflict with #19561.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-667089839,667089839,
hebasto,2020-08-08 07:19:53,Rebased 88b1f0357c332bc67fa20450dda9f77fa449576e -> 225f512438f4391f6af255f851131358e3c466a2 ([pr18077.33](https://github.com/hebasto/bitcoin/commits/pr18077.33) -> [pr18077.34](https://github.com/hebasto/bitcoin/commits/pr18077.34)) due to the conflict with #19098.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-670837706,670837706,
adamjonas,2020-08-10 14:02:08,"For those looking to review or revisit:\n\n(All pre-rebase)\nThere are concept ACKs from: luke-jr, dongcarl, Sjors, Sipa\na tACK from tryphe\nwith no NACKs or blocking issues",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-671373132,671373132,
dongcarl,2020-08-20 19:11:10,"Tested 225f512438f4391f6af255f851131358e3c466a2, works:\n```\n2020-08-20T19:07:08Z NAT-PMP: Port mapping successful. External address = <redacted>\n```\n\n---\n\nDid not read code yet",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-677847589,677847589,
hebasto,2020-08-26 09:13:31,Rebased 225f512438f4391f6af255f851131358e3c466a2 -> 22cbf4eefaa7333a3e2bf94fbf4d3e7b4bf379cb ([pr18077.34](https://github.com/hebasto/bitcoin/commits/pr18077.34) -> [pr18077.35](https://github.com/hebasto/bitcoin/commits/pr18077.35)) due to the conflict with #19779.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-680760631,680760631,
hebasto,2020-08-26 17:01:18,Rebased 22cbf4eefaa7333a3e2bf94fbf4d3e7b4bf379cb -> 2b6bd32e915d13928577b038c18194ac4024fc10 ([pr18077.35](https://github.com/hebasto/bitcoin/commits/pr18077.35) -> [pr18077.36](https://github.com/hebasto/bitcoin/commits/pr18077.36)) due to the conflict with https://github.com/bitcoin-core/gui/pull/35.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-681005079,681005079,
hebasto,2020-09-15 14:34:20,Rebased 2b6bd32e915d13928577b038c18194ac4024fc10 -> 62601a5a158b8c3710fde7cac8aadaa71a72f110 ([pr18077.36](https://github.com/hebasto/bitcoin/commits/pr18077.36) -> [pr18077.37](https://github.com/hebasto/bitcoin/commits/pr18077.37)) due to the conflict with #19558.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-692756420,692756420,
jonatack,2020-09-17 10:09:46,Concept ACK,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-694135151,694135151,
gmaxwell,2020-10-12 19:03:23,"I performed basic functional testing against this branch (but not master with this applied due to rebase hell) against http://www.nongnu.org/natpmp/.\n\nI don't really like the natpmp default being set by configure. I see the UPNP is currently handled that way, but I think that is an artefact of the fact that UPNP is disabled for implementation specific security reasons. Otherwise, no other bitc",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-707294191,707294191,
hebasto,2020-10-13 05:47:36,Rebased 62601a5a158b8c3710fde7cac8aadaa71a72f110 -> 44a697619d3fc3d9311c3d099cae04b21de071f3 ([pr18077.37](https://github.com/hebasto/bitcoin/commits/pr18077.37) -> [pr18077.38](https://github.com/hebasto/bitcoin/commits/pr18077.38)) due to the conflict with #19998.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-707504201,707504201,
gmaxwell,2020-10-15 09:41:40,"ultra minor nit, ignore if you like:  I didn't like that the logs calls it ""NAT-PMP"" but the configuration option is natpmp, so I had to go read the code to figure out what I should be looking for. I'd prefer to see logs say ""natpmp"" for optimum greppability.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-709047605,709047605,
hebasto,2020-10-15 10:26:12,"Rebased 44a697619d3fc3d9311c3d099cae04b21de071f3 -> 81a791d88d68e64968e52d8ff6ec20879bd5fad1 ([pr18077.38](https://github.com/hebasto/bitcoin/commits/pr18077.38) -> [pr18077.39](https://github.com/hebasto/bitcoin/commits/pr18077.39)) due to the conflict with #19077, and addressed @gmaxwell's [comment](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-709047605): \n> ultra minor nit, igno",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-709111256,709111256,
gmaxwell,2020-10-15 21:54:06,Still works. Looks good to me.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-709610568,709610568,
jamesob,2020-10-19 16:52:02,Concept ACK - reviewing this shortly,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-712296249,712296249,
hebasto,2020-10-22 18:37:39,"Updated 81a791d88d68e64968e52d8ff6ec20879bd5fad1 -> cb4060686155c011cbece84fd551dfa000277d51 ([pr18077.39](https://github.com/hebasto/bitcoin/commits/pr18077.39) -> [pr18077.40](https://github.com/hebasto/bitcoin/commits/pr18077.40), [diff](https://github.com/hebasto/bitcoin/compare/pr18077.39..pr18077.40)).\n\nAddressed @jamesob's comments:\n-  https://github.com/bitcoin/bitcoin/pull/18077#dis",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-714683741,714683741,
hebasto,2020-10-23 08:19:05,"Updated cb4060686155c011cbece84fd551dfa000277d51 -> bddfeade1e7740f04002f6d88e6e9840ed985bea ([pr18077.40](https://github.com/hebasto/bitcoin/commits/pr18077.40) -> [pr18077.41](https://github.com/hebasto/bitcoin/commits/pr18077.41), [diff](https://github.com/hebasto/bitcoin/compare/pr18077.40..pr18077.41)): https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510714033",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-715155281,715155281,
hebasto,2020-10-27 10:27:07,Rebased bddfeade1e7740f04002f6d88e6e9840ed985bea -> 5fd127243f452827dab3b4f4f47b6e96816fdfb8 ([pr18077.41](https://github.com/hebasto/bitcoin/commits/pr18077.41) -> [pr18077.42](https://github.com/hebasto/bitcoin/commits/pr18077.42)) due to the conflict with #19124.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-717142998,717142998,
hebasto,2020-10-29 14:58:46,Rebased 5fd127243f452827dab3b4f4f47b6e96816fdfb8 -> 90d9547f135ef0ffc00dd790072c3ae307f053ad ([pr18077.42](https://github.com/hebasto/bitcoin/commits/pr18077.42) -> [pr18077.43](https://github.com/hebasto/bitcoin/commits/pr18077.43)) due to the conflict with #20156.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-718810195,718810195,
hebasto,2020-10-30 17:38:39,"Updated 90d9547f135ef0ffc00dd790072c3ae307f053ad -> 29fb5708ca04da9ca0c25c1b801887354eb714bc ([pr18077.43](https://github.com/hebasto/bitcoin/commits/pr18077.43) -> [pr18077.44](https://github.com/hebasto/bitcoin/commits/pr18077.44), [diff](https://github.com/hebasto/bitcoin/compare/pr18077.43..pr18077.44)):\n\n- addressed @dongcarl's [comment](https://github.com/bitcoin/bitcoin/pull/18077#discu",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-719697155,719697155,
hebasto,2020-12-07 11:02:28,"Rebased 29fb5708ca04da9ca0c25c1b801887354eb714bc -> 3c26d53f538442363834178a45bc8b459b5b334d ([pr18077.44](https://github.com/hebasto/bitcoin/commits/pr18077.44) -> [pr18077.45](https://github.com/hebasto/bitcoin/commits/pr18077.45)) due to the conflicts with #20202, #20494 and the recent CI changes.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-739845253,739845253,
hebasto,2020-12-10 18:30:04,Rebased 3c26d53f538442363834178a45bc8b459b5b334d -> cc68169e72c5b28fe53466a86eeac9fd214cd0d1 ([pr18077.45](https://github.com/hebasto/bitcoin/commits/pr18077.45) -> [pr18077.46](https://github.com/hebasto/bitcoin/commits/pr18077.46)) due to the conflict with #20527.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-742709774,742709774,
hebasto,2020-12-15 18:29:09,Rebased cc68169e72c5b28fe53466a86eeac9fd214cd0d1 -> 93ff21a929ba3036d6cd5d822f300cf036ff939f ([pr18077.46](https://github.com/hebasto/bitcoin/commits/pr18077.46) -> [pr18077.47](https://github.com/hebasto/bitcoin/commits/pr18077.47)) due to the conflict with https://github.com/bitcoin-core/gui/pull/115.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-745479342,745479342,
LarryRuane,2020-12-16 20:44:34,"In case any of this is helpful... I wanted to try running this, I'm running Ubuntu 18.04 as a Virtualbox guest on a Windows 10 host running at home (Xfinity-Comcast, nothing unusual), I checked out branch `pr18077.47`, ran\n```\n$ sudo apt install libminiupnpc-dev libnatpmp-dev\n(... successful)\n$ ./autogen.sh && ./configure --disable-wallet --without-miniupnpc --enable-natpmp-default && make",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-746986174,746986174,
hebasto,2020-12-17 09:32:10,"@LarryRuane \n\nThanks for testing!\n\n> I don't know how to change my gateway to support NAT-PMP (I'd appreciate any help).\n\nYour gateway s/w manual (if available) could help. My TP-Link Archer C6  does not have NAT-PMP support with stock s/w, so I've flashed the OpenWrt on it.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-747323211,747323211,
laanwj,2020-12-17 13:10:10,"Looked over the overall changes, they look reasonable to me.\nWill test.",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-747429639,747429639,
laanwj,2020-12-17 15:14:51,"It works !\n\n- On Ubuntu 20.04 I installed the `libnatpmp-dev` package, re-ran configure, it was detected correctly and enabled\n- I run bitcoind with `-natpmp -regtest`\n\nI see the following in my log\n```\n2020-12-17T15:06:10Z natpmp: Port mapping successful. External address = x.x.x.x:18444\n```\nMy router's admin interface show the redirect:\n```\nProtocol | External Port | Client",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-747500131,747500131,
hebasto,2020-12-18 23:03:12,"Updated 93ff21a929ba3036d6cd5d822f300cf036ff939f -> 890e59c64d62fd39778ede620a70fe6bc60d9993 ([pr18077.47](https://github.com/hebasto/bitcoin/commits/pr18077.47) -> [pr18077.48](https://github.com/hebasto/bitcoin/commits/pr18077.48)):\n\n- rebased due to the conflict with #20681\n- addressed the recent @laanwj's comments\n- used C++14 chrono literal",https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-748361576,748361576,
hebasto,2021-01-07 16:25:47,Rebased 890e59c64d62fd39778ede620a70fe6bc60d9993 -> a191e23b8e7f0e19fc0359825eb7ca0d47966fa9 ([pr18077.48](https://github.com/hebasto/bitcoin/commits/pr18077.48) -> [pr18077.49](https://github.com/hebasto/bitcoin/commits/pr18077.49)) due to the conflict with #20864.,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-756222455,756222455,
laanwj,2021-01-07 18:39:41,Tested and code review ACK a191e23b8e7f0e19fc0359825eb7ca0d47966fa9,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-756303002,756303002,
luke-jr,2020-02-06 18:06:53,This will break building with both NAT-PMP and UPnP support...,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r375996088,375996088,src/mapport.cpp
hebasto,2020-02-06 18:14:29,"> This will break building with both NAT-PMP and UPnP support...\n\nYes, I'm aware of that. This PR in its current state is intended for NAT-PMP functionality tests and concept (N)ACKs.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r375999662,375999662,src/mapport.cpp
luke-jr,2020-02-12 02:12:13,Won't this overwrite the `g_mapport_thread` set above if both are enabled?,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378006285,378006285,src/mapport.cpp
hebasto,2020-02-12 07:10:35,"I believe that the both port mapping protocols shouldn't be enabled simultaneously:\nhttps://github.com/bitcoin/bitcoin/blob/c7e90ca40ad9b7c66f3429b792435e9279ceca6b/src/init.cpp#L1781-L1786",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378072197,378072197,src/mapport.cpp
luke-jr,2020-02-12 12:05:22,It should be possible to enable both.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378210260,378210260,src/mapport.cpp
Sjors,2020-02-12 12:26:31,"If both are enabled, would you try to open de port with NAT_PMP first and if that fails UPNP?",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378219481,378219481,src/mapport.cpp
hebasto,2020-02-12 12:31:52,"> It should be possible to enable both.\n\nDo you mean that a router could do port mapping using both NAT-PMP and UPnP simultaneously? What is the reason for that?",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378221757,378221757,src/mapport.cpp
Sjors,2020-02-12 12:43:39,"I wouldn't use them simultaneously, but one fails it makes sense to try the other. Though I believe our long plan is to remove UPnP, if NAT-PMP does the job.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378227115,378227115,src/mapport.cpp
hebasto,2020-02-12 13:01:00,"> I wouldn't use them simultaneously, but one fails it makes sense to try the other.\n\nGood suggestion for a followup.\n\n> Though I believe our long plan is to remove UPnP, if NAT-PMP does the job.\n\nNot all routers with stock software have NAT-PMP port mapping feature.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378235158,378235158,src/mapport.cpp
luke-jr,2020-02-12 13:04:21,"Users who don't know what their router supports should be able to just flip both on. And laptops might very well migrate between different routers using each protocol.\n\nAgree with @hebasto that NAT-PMP can't be a complete substitute for UPnP since routers might not support both.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r378236713,378236713,src/mapport.cpp
hebasto,2020-02-16 16:00:20,Addressed in the latest push.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r379913637,379913637,src/mapport.cpp
luke-jr,2020-02-17 02:09:25,Prefer to leave this alone (and use `%s` in the new options),https://github.com/bitcoin/bitcoin/pull/18077#discussion_r379960033,379960033,src/init.cpp
hebasto,2020-02-17 06:25:09,Agree. It will be fixed.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380002423,380002423,src/init.cpp
hebasto,2020-02-17 16:56:03,Done.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380289414,380289414,src/init.cpp
luke-jr,2020-02-17 20:16:34,"Suggest just making this `StartMapPort(bool use_upnp, bool use_natpmp)`",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380352723,380352723,src/init.cpp
luke-jr,2020-02-17 20:17:38,This logic won't work if the thread is already running...,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380352965,380352965,src/qt/optionsmodel.cpp
luke-jr,2020-02-17 20:54:31,`%s` > `%u`,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380362646,380362646,src/init.cpp
luke-jr,2020-02-17 21:26:59,Or better yet: Just check gArgs inside StartMapPort...,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380371070,380371070,src/init.cpp
hebasto,2020-02-18 08:42:29,Going to fix it.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380525759,380525759,src/qt/optionsmodel.cpp
hebasto,2020-02-18 08:46:44,"> `%s` > `%u`\n\nWhat is the rationale? We already use the `%u` specifier for unsigned integers in `tfm::format()`.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380527819,380527819,src/init.cpp
hebasto,2020-02-18 22:01:34,Fixed in the latest push.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380961736,380961736,src/qt/optionsmodel.cpp
hebasto,2020-02-18 22:01:57,Reworked in the latest push.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r380961933,380961933,src/init.cpp
luke-jr,2020-02-19 00:08:21,"`%s` doesn't care what type the value is.\n\nYou can use the same format string above, with a value of `""1 when listening and no -proxy""`",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381008856,381008856,src/init.cpp
hebasto,2020-02-19 20:05:53,Done in the latest push.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381514731,381514731,src/init.cpp
luke-jr,2020-02-19 21:26:25,"This logic breaks the ""command line overrides GUI options"" stuff above (see `addOverriddenOption`)...\n\nNot really sure what the best solution here is.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381553831,381553831,src/qt/optionsmodel.cpp
luke-jr,2020-02-19 21:33:54,"This won't work if we used to have both protocols enabled, are currently using UPnP, but want to disable UPnP.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381557545,381557545,src/mapport.cpp
luke-jr,2020-02-19 21:35:05,Won't this cause the thread to shut down?,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381558152,381558152,src/mapport.cpp
luke-jr,2020-02-19 21:36:08,I don't see the logic here to handle being assigned a different port number.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381558659,381558659,src/mapport.cpp
hebasto,2020-02-20 07:49:34,The logic to handle being assigned a different external port number by the gateway uses the `g_mapport_external_port` variable.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381830792,381830792,src/mapport.cpp
hebasto,2020-02-20 10:21:34,The separate issue #18184 has been submitted.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r381908006,381908006,src/qt/optionsmodel.cpp
hebasto,2020-02-20 23:24:10,Fixed in the latest [push](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-589405068).,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382315043,382315043,src/mapport.cpp
hebasto,2020-02-20 23:29:52,"Sure it works.\nThe log excerpt for the mentioned case:\n```\n2020-02-20T23:26:30Z [mapport] UPNP_DeletePortMapping() returned: 0\n2020-02-20T23:26:30Z [mapport] AddLocal(95.164.65.194:18333,3)\n2020-02-20T23:26:30Z [mapport] NAT-PMP: Port mapping successful. External address = 95.164.65.194:18333\n\n```",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382316994,382316994,src/mapport.cpp
luke-jr,2020-02-20 23:55:02,Why would it? You'd return early here without making the change...,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382325993,382325993,src/mapport.cpp
hebasto,2020-02-20 23:59:05,"If both protocols were enabled, `g_mapport_target_proto != MapPortProto::NONE`",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382327259,382327259,src/mapport.cpp
luke-jr,2020-02-21 03:13:33,The conditional here is `(g_mapport_target_proto & g_mapport_current_proto)`,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382377105,382377105,src/mapport.cpp
hebasto,2020-02-21 12:06:51,"```C++\nvoid StartMapPort(bool use_natpmp, bool use_upnp)\n{\n    // Both protocols are enabled, so\n    // g_mapport_target_proto == MapPortProto::NAT_PMP | MapPortProto::UPNP\n    //\n    // UPnP is currently using, so\n    // g_mapport_current_proto == MapPortProto::UPNP\n    //\n    // A user disables UPnP then passed arguments are:\n    // use_natpmp == true, use_upnp = false\n\n ",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382547566,382547566,src/mapport.cpp
luke-jr,2020-02-21 13:07:25,Got it. I was confusing it with (target & new_target),https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382571364,382571364,src/mapport.cpp
luke-jr,2020-02-21 18:58:20,"This should be reset outside of the protocol-specific functions, or else we could end up with a race.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382750749,382750749,src/mapport.cpp
luke-jr,2020-02-21 18:59:02,"This will exit if it get the interrupt, causing target changes to shut off port mapping entirely.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382751074,382751074,src/mapport.cpp
hebasto,2020-02-22 10:51:02,"If the protocol switch is initiated by a user, the `g_mapport_interrupt()` call will end the internal protocol-specific loop in the `ThreadNatpmp()` or in the `ThreadUpnp()`, `ok == true` and `g_mapport_interrupt.sleep_for(PORT_MAPPING_RETRY_PERIOD)` will not call at all.\n\nIf the protocol switch is initiated by a protocol failure, `ok == false` and `g_mapport_interrupt.sleep_for(PORT_MAPPING_R",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382904239,382904239,src/mapport.cpp
hebasto,2020-02-23 01:08:27,"@luke-jr \n> This should be reset outside of the protocol-specific functions, or else we could end up with a race.\n\nLooking into the `CThreadInterrupt` class implementation I couldn't see possibilities for a race.\n\nWhat did I miss?",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382954341,382954341,src/mapport.cpp
luke-jr,2020-02-23 02:11:59,This name is way too vague...,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382957249,382957249,src/mapport.cpp
luke-jr,2020-02-23 02:14:54,`enum class`,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382957368,382957368,src/mapport.h
luke-jr,2020-02-23 03:09:27,Are we sure the settings are changed *before* the signal? Or could it be in parallel and therefore a race?,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r382959771,382959771,src/qt/optionsdialog.cpp
luke-jr,2020-02-23 20:14:40,Pretty sure `a?b:c` requires `b` and `c` to have the same type.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383034794,383034794,src/init.cpp
luke-jr,2020-02-23 20:18:07,Pretty sure `a?b:c` requires `b` and `c` to have the same type.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383035036,383035036,src/init.cpp
hebasto,2020-02-24 20:23:07,"> This name is way too vague...\n\nYeah... I'm not good at choosing English names, and will appreciate your suggestion.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383494027,383494027,src/mapport.cpp
hebasto,2020-02-24 20:29:09,"It will require to define bitwise operators which are used here:\nhttps://github.com/bitcoin/bitcoin/blob/d9ecda8fa0ebce5b6da972691b19f4425164ae43/src/mapport.cpp#L297-L304\n\nMaybe in follow-up?",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383496750,383496750,src/mapport.h
luke-jr,2020-02-24 20:32:51,StartThreadMapPort maybe,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383498346,383498346,src/mapport.cpp
luke-jr,2020-02-24 23:15:27,I wish there was a C++ standard QFlags...,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383571052,383571052,src/mapport.h
hebasto,2020-02-25 13:51:23,"> Are we sure the settings are changed _before_ the signal? Or could it be in parallel and therefore a race?\n\nYes, we are. Please consider the following slot:\nhttps://github.com/bitcoin/bitcoin/blob/d9ecda8fa0ebce5b6da972691b19f4425164ae43/src/qt/optionsdialog.cpp#L284-L289\n\nAll changes are submitted to the model in the `mapper->submit()` call _before_ the `QDialog::accepted()` signal is",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r383889887,383889887,src/qt/optionsdialog.cpp
hebasto,2020-02-25 17:30:00,Fixed.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384020701,384020701,src/init.cpp
hebasto,2020-02-25 17:30:24,Fixed.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384020937,384020937,src/init.cpp
hebasto,2020-02-25 17:30:44,Done.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384021154,384021154,src/mapport.cpp
sipa,2020-02-26 00:17:15,"In commit ""refactor: Move port mapping code to own files""\n\nNit: when you're copying/moving code, retain the copyright years of the original code.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384206803,384206803,src/mapport.cpp
sipa,2020-02-26 00:17:59,"In commit ""net: Keep trying to use UPnP when -upnp=1""\n\nThis is confusingly named when it isn't actually a thread on its own anymore.\n",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384207039,384207039,src/mapport.cpp
hebasto,2020-02-26 07:22:56,"The UPnP support code has been added in 2011 (see #133).\nIs it correct to retain pre-2011 copyright years?\n\nCould it be ""2011-2020"" in new files?",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384310915,384310915,src/mapport.cpp
hebasto,2020-02-26 07:46:46,See the latest [push](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-591285675).,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384318840,384318840,src/mapport.cpp
hebasto,2020-02-26 07:47:09,[Renamed](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-591285675).,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r384318974,384318974,src/mapport.cpp
luke-jr,2020-08-20 21:26:06,"Neither should prevail - one should be attempted before the other, but both should work.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r474281799,474281799,doc/release-notes-18077.md
jamesob,2020-10-20 15:01:58,"Verified this locally.\n```\n% curl -O https://miniupnp.tuxfamily.org/files/libnatpmp-20150609.tar.gz\n% sha256sum libnatpmp-20150609.tar.gz\ne1aa9c4c4219bc06943d6b2130f664daee213fb262fcb94dd355815b8f4536b0  libnatpmp-20150609.tar.gz\n```",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508586206,508586206,depends/packages/libnatpmp.mk
jamesob,2020-10-20 20:33:47,"https://github.com/bitcoin/bitcoin/pull/18077/commits/035a41ca371675d0cb0fbfa8177553ec19068663\n\nVerified this is move-only from here on down.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508821208,508821208,src/mapport.cpp
jamesob,2020-10-20 20:36:45,"https://github.com/bitcoin/bitcoin/pull/18077/commits/035a41ca371675d0cb0fbfa8177553ec19068663\n\nSo this was just unnecessary in the first place?",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508822897,508822897,src/net.h
jamesob,2020-10-20 20:43:19,"(Note on https://github.com/bitcoin/bitcoin/pull/18077/commits/5b6af780967c428ec38fa18ae68a193d2d036f57 as a whole)\n\nI certainly don't have qualms with this change but it seems orthogonal to NAT-PMP per se. Is it necessary for NAT-PMP somehow? Just curious.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508826548,508826548,src/mapport.cpp
jamesob,2020-10-20 20:48:14,"https://github.com/bitcoin/bitcoin/pull/18077/commits/ea445ad4bc5b4d2904cbe234a627700a6d22d32e\n\nNote: simultaneous use of either NAT-PMP or upnp enabled in a later commit.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508829278,508829278,src/mapport.cpp
jamesob,2020-10-20 20:49:17,"(Note on https://github.com/bitcoin/bitcoin/pull/18077/commits/1bf23f291d7c053538245f1a7f6f7699daf4a3b9 as a whole:) could be a scripteddiff AFAICT, but not a huge deal.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508829874,508829874,src/mapport.cpp
jamesob,2020-10-20 21:00:04,"https://github.com/bitcoin/bitcoin/pull/18077/commits/f6bd717f3f44f2a167ce2e548df1132789d0ea98\n\nHm, I see we're explicitly setting this in `NetpmpMapping` but then it goes unused. No big deal, just curious.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508835955,508835955,src/mapport.cpp
jamesob,2020-10-20 21:06:31,Nit: linebreak would be nice.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508839477,508839477,src/init.cpp
jamesob,2020-10-20 21:10:58,Nit: not s/false/USE_NATPMP ?,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r508841927,508841927,src/qt/optionsdialog.cpp
hebasto,2020-10-22 17:05:44,Yes. I've submitted a dedicated #20221.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510322172,510322172,src/net.h
hebasto,2020-10-22 17:17:38,"The _""net: Keep trying to use UPnP when -upnp=1""_ commit (5b6af780967c428ec38fa18ae68a193d2d036f57) is a prerequisite for the _""net: Add NAT-PMP to port mapping loop""_ commit (c329ae5b6834e8dae6d178bc84321c7dc6e3c6fc).\nBoth commits make possible to switch port forwarding method at runtime.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510329265,510329265,src/mapport.cpp
hebasto,2020-10-22 17:31:11,"As an in-out parameter, `external_ip_discovered` is used here https://github.com/bitcoin/bitcoin/blob/81a791d88d68e64968e52d8ff6ec20879bd5fad1/src/mapport.cpp#L104-L107 to prevent consecutive `AddLocal` calls. ",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510337604,510337604,src/mapport.cpp
hebasto,2020-10-22 17:43:04,It won't compile if `USE_NATPMP` is undefined. Did I understand you correctly?,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510344800,510344800,src/qt/optionsdialog.cpp
jamesob,2020-10-22 17:47:59,Oh my mistake; I read that as ifdef.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510347832,510347832,src/qt/optionsdialog.cpp
hebasto,2020-10-22 18:38:13,Thanks! [Updated](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-714683741).,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510376824,510376824,src/mapport.cpp
hebasto,2020-10-22 18:38:40,[Updated](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-714683741).,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510377046,510377046,src/init.cpp
hebasto,2020-10-23 08:17:07,Reverted back as a linebreak breaks `test/lint/check-doc.py` linter: https://travis-ci.org/github/bitcoin/bitcoin/jobs/738110074,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r510714033,510714033,src/init.cpp
jamesob,2020-10-26 15:58:13,"Oh I see, thanks.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r512074064,512074064,src/mapport.cpp
dongcarl,2020-10-30 17:20:45,"Perhaps I'm reading the code wrong, but it seems like ""If both UPnP and NAT-PMP are enabled, a successful allocation from UPnP prevails over one from NAT-PMP"" is a more accurate description here?\n\nI'm thinking about the case where both UPnP and NAT-PMP are enabled, but the gateway box is not responding to UPnP, in that case, a NAT-PMP allocation would still be accepted, right?",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515256116,515256116,doc/release-notes-18077.md
hebasto,2020-10-30 17:39:37,"> Perhaps I'm reading the code wrong, but it seems like ""If both UPnP and NAT-PMP are enabled, a successful allocation from UPnP prevails over one from NAT-PMP"" is a more accurate description here?\n\nThanks! It remained from the initial version of the PR :)\n[Updated](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-719697155).",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515271554,515271554,doc/release-notes-18077.md
hebasto,2020-10-30 17:41:50,"> I'm thinking about the case where both UPnP and NAT-PMP are enabled, but the gateway box is not responding to UPnP, in that case, a NAT-PMP allocation would still be accepted, right\n\nThe `do` loop introduced in the c01073db04e94a8d67f29de3daead0e2574b1c26 commit is responsible for that.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515272813,515272813,doc/release-notes-18077.md
luke-jr,2020-10-30 22:51:58,Couldn't this be true if the user is impossibly fast?,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515414822,515414822,src/mapport.cpp
hebasto,2020-10-30 23:59:17,Simultaneously? ,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r515428173,515428173,doc/release-notes-18077.md
hebasto,2020-12-07 15:44:36,I don't think so due to the `CThreadInterrupt` class implementation.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r537609030,537609030,src/mapport.cpp
laanwj,2020-12-17 13:11:45,"Why is NATPMP ""low priority""? I think NATPMP is the preferred protocol? (for one, it's simpler so less prone to exploitation)",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545078633,545078633,src/mapport.cpp
hebasto,2020-12-17 13:15:17,https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-588484002 by @luke-jr ,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545080902,545080902,src/mapport.cpp
laanwj,2020-12-17 13:16:27,"FWIW, I disagree. I think we should prefer NATPMP and phase out UPnP in the longer run when it has proven to be stable.\n(of course, if a lot of issues actually come up it's different, but I wouldn't do this based on one comment)",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545081619,545081619,src/mapport.cpp
laanwj,2020-12-17 15:32:13,I think we can avoid this platform dependent include dance by including `<compat.h>`.,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545181363,545181363,src/mapport.cpp
laanwj,2020-12-17 15:49:32,Spurious newline?,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545195115,545195115,src/mapport.cpp
laanwj,2020-12-17 15:53:45,"```suggestion\n        if (r != 0) FreeUPNPUrls(&urls);\n```",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545198538,545198538,src/mapport.cpp
laanwj,2020-12-17 15:55:06,"Oh, this is a move-only part, ok.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545199678,545199678,src/mapport.cpp
laanwj,2020-12-17 17:31:28,I guess at some point in the future we could replace this thread (which does nothing but waiting and periodically run stuff) with scheduler runnables instead? (not in this PR),https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545270674,545270674,src/mapport.cpp
vasild,2020-12-18 09:11:16,"@luke-jr, what do you mean by ""maps random ports often""? Some implementation of natpmp has bugs? Can you give an example?\n\nMaybe just remove this comment ""// Low priority protocol."" -- it is unclear what is meant by it and is missing in other places where `#ifdef USE_NATPMP` is used.",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r545689768,545689768,src/mapport.cpp
hebasto,2020-12-18 22:04:39,"@vasild \n> @luke-jr, what do you mean by ""maps random ports often""? Some implementation of natpmp has bugs? Can you give an example?\n\nSome NAT-PMP daemon implementations do randomize an external port. For example, see https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-588121365 and http://bodgitandscarper.co.uk/natpmpd/:\n> The external TCP or UDP port assigned to the client is alwa",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r546112557,546112557,src/mapport.cpp
hebasto,2020-12-18 23:04:16,Thanks! [Updated](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-748361576).,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r546135778,546135778,src/mapport.cpp
hebasto,2020-12-18 23:04:28,[Updated](https://github.com/bitcoin/bitcoin/pull/18077#issuecomment-748361576).,https://github.com/bitcoin/bitcoin/pull/18077#discussion_r546135940,546135940,src/mapport.cpp
vasild,2020-12-21 08:52:55,"@hebasto, Thanks for the clarification! IMO the nat-pmp implementation overriding the desired external port is fine as long as we advertise the overriden one instead of the desired one (I guess we do). That should also be expected as it is allowed by the RFC.\n\nI guess something like that happens with UPnP too if the desired port is already used?",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r546581515,546581515,src/mapport.cpp
hebasto,2020-12-25 09:37:09,"> IMO the nat-pmp implementation overriding the desired external port is fine as long as we advertise the overriden one instead of the desired one (I guess we do).\n\nYes, we do:\nhttps://github.com/bitcoin/bitcoin/blob/890e59c64d62fd39778ede620a70fe6bc60d9993/src/mapport.cpp#L97-L102\n\n> I guess something like that happens with UPnP too if the desired port is already used?\n\nhttps://gith",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r548844201,548844201,src/mapport.cpp
ryanofsky,2021-01-19 18:09:43,"In commit ""gui: Apply port mapping changes on dialog exit"" (58e8364dcdc4e57b0caac09f8402e6535301de9b)\n\n@hebasto It seems like this commit has a bug and will incorrectly overwrite command line and config file `-upnp` and `-natpmp` options. I think this might have happened before, but previously only if these settings were changed, now if the dialog is just opened and closed.\n\nWould you have",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r560381734,560381734,src/qt/optionsdialog.cpp
hebasto,2021-01-30 07:20:00,"@ryanofsky\n\nYou are right.\n\n> It seems like this commit has a bug and will incorrectly overwrite command line and config file `-upnp` and `-natpmp` options.\n\nThe concerns about user-friendly and correct behavior were raised in #18184. Now users are able to switch `-upnp` and `-natpmp` on/off on-the-fly via the GUI. Should we drop this feature?\n\n> I think this might have happened be",https://github.com/bitcoin/bitcoin/pull/18077#discussion_r567211003,567211003,src/qt/optionsdialog.cpp
