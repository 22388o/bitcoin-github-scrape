[
  {
    "sha": "b7016ea241398a678c64739ae1730ee5566f85ee",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiNzAxNmVhMjQxMzk4YTY3OGM2NDczOWFlMTczMGVlNTU2NmY4NWVl",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-12-12T07:45:08Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-12-16T23:18:29Z"
      },
      "message": "Work around codesign_allocate differences\n\nThe tool codesign_allocate compiled from native_cctools (based on\nApple's published source code) and the codesign_allocate shipped by\nApple in its Xcode command line tools behave differently when it comes\nto rounding to a page size for a field named \"vmsize\". The open source\none rounds to 0x1000 while the binary rounds to 0x2000. This can result\nin a situation where a valid signature is made, but when we attach it\no the unsigned binary during Gitian builds, a different binary comes\nout that fails the signature validation.\n\nTo work around this, we rely on the behavior that codesign_allocate does\nnot reduce \"vmsize\", only increases it. At the end of the Gitian build\nstep when we have created the unsigned binary, we use codesign_allocate\nto allocate a large amount of space at the end of the file for the code\nsignature. This will set \"vmsize\" to something fairly high.\n\nThen during signing, Apple's codesign tool will call codesign_allocate\nand reallocate space for the signature. However this only effects the\nreal size of the binary, not the \"vmsize\". So our larger \"vmsize\"\nremains, using the rounding of the native_cctools version of\ncodesign_allocate. Thus we can ensure that \"vmsize\" remains the same\nthroughout the signing process and then the subsequent attaching.",
      "tree": {
        "sha": "88c4cb4ba9b1396a64f0aa06c6fa8b4cd97d7cb6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/88c4cb4ba9b1396a64f0aa06c6fa8b4cd97d7cb6"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b7016ea241398a678c64739ae1730ee5566f85ee",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b7016ea241398a678c64739ae1730ee5566f85ee",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b7016ea241398a678c64739ae1730ee5566f85ee",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b7016ea241398a678c64739ae1730ee5566f85ee/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1811e488d53b82825e3523f6f0cdb97f635f03a7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1811e488d53b82825e3523f6f0cdb97f635f03a7",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1811e488d53b82825e3523f6f0cdb97f635f03a7"
      }
    ],
    "stats": {
      "total": 26,
      "additions": 26,
      "deletions": 0
    },
    "files": [
      {
        "sha": "35e58b94db2544e3359eede49309c87745a30c0a",
        "filename": "contrib/gitian-descriptors/gitian-osx.yml",
        "status": "modified",
        "additions": 26,
        "deletions": 0,
        "changes": 26,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b7016ea241398a678c64739ae1730ee5566f85ee/contrib/gitian-descriptors/gitian-osx.yml",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b7016ea241398a678c64739ae1730ee5566f85ee/contrib/gitian-descriptors/gitian-osx.yml",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/contrib/gitian-descriptors/gitian-osx.yml?ref=b7016ea241398a678c64739ae1730ee5566f85ee",
        "patch": "@@ -115,6 +115,7 @@ script: |\n   git archive --prefix=\"${DISTNAME}/\" --output=\"$GIT_ARCHIVE\" HEAD\n \n   ORIGPATH=\"$PATH\"\n+  CODESIGN_ALLOCATE=\"${BASEPREFIX}/${i}/native/bin/${i}-codesign_allocate\"\n   # Extract the git archive into a dir for each host and build\n   for i in ${HOSTS}; do\n     export PATH=${BASEPREFIX}/${i}/native/bin:${ORIGPATH}\n@@ -133,6 +134,31 @@ script: |\n \n     make osx_volname\n     make deploydir\n+\n+    # Hack to work around differences in the behavior of native_cctools' codesign_allocate and Apple distributed codesign and codesign_allocate.\n+    # Specifically, the signature is created by appending it to the end of the binary and then updating the size for the section __LINKEDIT\n+    # The \"vmsize\" attribute of this section is rounded to 0x1000, 0x2000, or 0x4000 depending on the architecture. For some reason, this also happens\n+    # to differ between what we can build ourselves in native_cctools (which uses Apple's published source code) and what Apple distributes\n+    # as \"Xcode command line tools\". It appears that the Apple distributed tool rounds to 0x2000.\n+    #\n+    # Fortunately codesign_allocate will not reduce the \"vmsize\" attribute, and when the signature is appended, the difference in actual size and\n+    # \"vmsize\" will not be present in the final binary.\n+    #\n+    # Thus we can workaround this by calculating an overestimate of what the signature will be and then using codesign_allocate to preallocate\n+    # space for the code signature. Because the same codesign_allocate is used in this step, the rounding problem will not be present.\n+    # Since the space allocated for the signature should be larger than actually needed, the signing step will not reduce \"vmsize\" so we\n+    # won't have any problems there.\n+    #\n+    # From inspecting previous releases' code signatures, we find that the code signature primarily consists of SHA256 hashes of 4096 byte chunk\n+    # of the unsigned binary. There are a few other hashes of something. Then the signature itself, which is ~9kb. Then ~10kb of additional overhead.\n+    # We can thus produce an overestimate as follows: (((unsigned_size / 4096) + 1) * 32) + 51200. This gives us an expected number of SHA256 hashes\n+    # and how large they will be. By adding 50kb, we can include the signature, overhead, and still have room if Apple decides to cram more stuff\n+    # into the code signature.\n+    BINARY_RESULT=\"dist/Bitcoin-Qt.app/Contents/MacOS/Bitcoin-Qt\"\n+    UNSIGNED_SIZE=$(stat -c %s ${BINARY_RESULT})\n+    SIG_SIZE_EST=$(((((UNSIGNED_SIZE / 4096) + 1) * 32) + 51200))\n+    ${CODESIGN_ALLOCATE} -i ${BINARY_RESULT} -a x86_64 ${SIG_SIZE_EST} -o ${BINARY_RESULT}\n+\n     mkdir -p unsigned-app-${i}\n     cp osx_volname unsigned-app-${i}/\n     cp contrib/macdeploy/detached-sig-apply.sh unsigned-app-${i}"
      }
    ]
  },
  {
    "sha": "159d203017b66bc7ae158bf2d3318264332cd5ae",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxNTlkMjAzMDE3YjY2YmM3YWUxNThiZjJkMzMxODI2NDMzMmNkNWFl",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-12-13T21:03:30Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2020-12-16T23:19:01Z"
      },
      "message": "gitian: Apply a bogus signature to the binary that the codesigner signs",
      "tree": {
        "sha": "174bf2d94b16861a2415c776ae98ab16d239183b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/174bf2d94b16861a2415c776ae98ab16d239183b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/159d203017b66bc7ae158bf2d3318264332cd5ae",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/159d203017b66bc7ae158bf2d3318264332cd5ae",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/159d203017b66bc7ae158bf2d3318264332cd5ae",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/159d203017b66bc7ae158bf2d3318264332cd5ae/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b7016ea241398a678c64739ae1730ee5566f85ee",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b7016ea241398a678c64739ae1730ee5566f85ee",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b7016ea241398a678c64739ae1730ee5566f85ee"
      }
    ],
    "stats": {
      "total": 10,
      "additions": 10,
      "deletions": 0
    },
    "files": [
      {
        "sha": "be9679546e387155e71120ee35f61e79b0308a1f",
        "filename": "contrib/gitian-descriptors/gitian-osx.yml",
        "status": "modified",
        "additions": 10,
        "deletions": 0,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/159d203017b66bc7ae158bf2d3318264332cd5ae/contrib/gitian-descriptors/gitian-osx.yml",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/159d203017b66bc7ae158bf2d3318264332cd5ae/contrib/gitian-descriptors/gitian-osx.yml",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/contrib/gitian-descriptors/gitian-osx.yml?ref=159d203017b66bc7ae158bf2d3318264332cd5ae",
        "patch": "@@ -116,6 +116,7 @@ script: |\n \n   ORIGPATH=\"$PATH\"\n   CODESIGN_ALLOCATE=\"${BASEPREFIX}/${i}/native/bin/${i}-codesign_allocate\"\n+  PAGESTUFF=\"${BASEPREFIX}/${i}/native/bin/${i}-pagestuff\"\n   # Extract the git archive into a dir for each host and build\n   for i in ${HOSTS}; do\n     export PATH=${BASEPREFIX}/${i}/native/bin:${ORIGPATH}\n@@ -159,6 +160,15 @@ script: |\n     SIG_SIZE_EST=$(((((UNSIGNED_SIZE / 4096) + 1) * 32) + 51200))\n     ${CODESIGN_ALLOCATE} -i ${BINARY_RESULT} -a x86_64 ${SIG_SIZE_EST} -o ${BINARY_RESULT}\n \n+    # codesign_allocate appends 0's, and this causes codesign to error because it is expecting a properly formatted signature.\n+    # To avoid this problem, we attach a bogus signature. This signature was valid for some version, but it doesn't matter because it is invalid\n+    # for this version.\n+    BOGUS_SIG=\"contrib/macdeploy/a.sig\"\n+    BOGUS_SIG_SIZE=$(stat -c %s ${BOGUS_SIG})\n+    ${CODESIGN_ALLOCATE} -i \"${BINARY_RESULT}\" -a x86_64 ${BOGUS_SIG_SIZE} -o \"${BINARY_RESULT}\"\n+    OFFSET=$(${PAGESTUFF} \"${BINARY_RESULT}\" -p | tail -2 | grep offset | sed 's/[^0-9]*//g')\n+    dd if=\"${BOGUS_SIG}\" of=\"${BINARY_RESULT}\" bs=1 seek=${OFFSET} count=${BOGUS_SIG_SIZE} 2>/dev/null\n+\n     mkdir -p unsigned-app-${i}\n     cp osx_volname unsigned-app-${i}/\n     cp contrib/macdeploy/detached-sig-apply.sh unsigned-app-${i}"
      },
      {
        "sha": "5ad31fc47f75f57b8f96101be42f6f420b6d2805",
        "filename": "contrib/macdeploy/a.sig",
        "status": "added",
        "additions": 0,
        "deletions": 0,
        "changes": 0,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/159d203017b66bc7ae158bf2d3318264332cd5ae/contrib/macdeploy/a.sig",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/159d203017b66bc7ae158bf2d3318264332cd5ae/contrib/macdeploy/a.sig",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/contrib/macdeploy/a.sig?ref=159d203017b66bc7ae158bf2d3318264332cd5ae"
      }
    ]
  }
]