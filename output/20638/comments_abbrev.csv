achow101,2020-12-12 16:59:13,"Needs backport to all branches that we plan on making further releases from.\n\nWe also need to verify that after doing the code signing that the behavior is what we expect, so @jonasschnelli will need to make a code signature for this PR.",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-743783927,743783927,
laanwj,2020-12-12 17:22:09,"Concept ACK, thanks for investigating this weird problem.",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-743786830,743786830,
achow101,2020-12-12 18:02:37,"MacOS Gitian build of 73d1a541147e72b07ce0e6c3a23ca6e94f74c3ce\n\n```\nbf682a0e960d153a6c862ad4af4f7fce584df3139ee74ecfd6c864ea91bf5c63  bitcoin-73d1a541147e-osx-unsigned.dmg\n836a13543e82062074400b7ef82d4e62ffc16a4f030c3e89e500e6164dca58ab  bitcoin-73d1a541147e-osx-unsigned.tar.gz\n87ba11ddf0fe08c531afd50ba2e638b1d74a857fcbf3f9a2a1dac1c2c515881e  bitcoin-73d1a541147e-osx64.tar.gz\ne6ee88e76",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-743793161,743793161,
jonasschnelli,2020-12-12 18:53:21,"Concept ACK\nThanks @achow101 and @sipa for investigating this cumbersome issue.\n\nWill do a gitian build (+ manual code signatures) asap.",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-743799702,743799702,
DrahtBot,2020-12-12 19:18:19,<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.,https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-743803042,743803042,
achow101,2020-12-12 19:21:12,"I've mostly worked out why the code signature is so big. The signature is primarily composed of hashes of 4096 byte pages of the unsigned binary. Then there is ~8kb of signature, and another ~10kb of overhead that I'm not quite sure. But given this, we can get a more accurate estimate of the actual size of the code signature.\n\nWith that in mind, I've dropped the commit that does `--pagesize 0`",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-743803381,743803381,
achow101,2020-12-12 19:32:02,"MacOS Gitian build for ef0ea90\n\n```\ne0f51c79af8598f8b99ed2341a476d97b846d2d556d375c3d93a163c77b6118a  bitcoin-ef0ea90d3e81-osx-unsigned.dmg\n017b20d59ef2c2594606dd0c3c1de11ab36c56b5cc34c2add1c78fc8db698b56  bitcoin-ef0ea90d3e81-osx-unsigned.tar.gz\n98560f5bef1938303a1f55448ba087f76ec7f35205ae64fec0efd129188fd8e1  bitcoin-ef0ea90d3e81-osx64.tar.gz\n8bd279c7439e19d783e70f2cf425c40b3306b97b9",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-743804757,743804757,
jonatack,2020-12-12 19:41:30,Approach ACK. Nice work.,https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-743805893,743805893,
decryp2kanon,2020-12-13 15:57:35,Concept ACK ðŸ’–,https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-744028347,744028347,
sipa,2020-12-13 19:00:55,utACK 6753b74195d80a75b3bceef459d767906bea8e7d,https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-744052709,744052709,
achow101,2020-12-14 00:16:34,"Apparently doing `codesign_allocate` before the actual code signing causes `codesign` to fail. This is because the tool detects that there is supposed to be a signature there. It then attempts to parse the signature and verify it. However because it is just 0's, it fails to do this and errors. To work around this issue, after doing `codesign_allocate`, we can apply a bogus signature. Since we pass",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-744095297,744095297,
jonasschnelli,2020-12-14 08:11:33,"Tested ACK 7f9d623e0210ff539455b0d8dd70b31f14231b8b\nbuilt this in gitian an got:\n```shell\nc587da1413ef8f942b4fb90bd077c93b883cfdcaf86c1965ba63ba83eabd0601  bitcoin-7f9d623e0210-osx-unsigned.dmg\n3fcfd6cf91018a0afeefec43bc226eb61eed5d2cd41aa7880be3700abf8555cd  bitcoin-7f9d623e0210-osx-unsigned.tar.gz\n2b01414c875ac85e79dbb5df4eff863db29e99be8a0eec43fb1e9940298b4d3f  bitcoin-7f9d623e0210-os",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-744260530,744260530,
jonasschnelli,2020-12-14 08:12:01,I think this solution is less fragile than #20644.,https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-744260847,744260847,
sipa,2020-12-14 08:16:09,"@jonasschnelli Maybe, and I'm happy with either. But in the end both solutions are attempts to appease/mimick `codesign`s behavior, and changes in it could break either solution.",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-744263346,744263346,
DrahtBot,2020-12-14 08:43:41,<!--a722867cd34abeea1fadc8d60700f111-->\n### Gitian builds\n\n| File | commit ade38b6ee8f91e441507c0ee7ffe6ca020748991<br>(master) | commit 0c9b41f025f54d8b37c6f459bafa8eb030b5ef6a<br>(master and this pull) |\n|--|--|--|\n| *-aarch64-linux-gnu-debug.tar.gz | [`c3a964aaa2ba9589...`](https://drahtbot.space/gitian/bitcoin/bitcoin/ade38b6ee8f91e441507c0ee7ffe6ca020748991/bitcoin-ade38b6ee8f9-aarch64-l,https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-744279775,744279775,
jonasschnelli,2020-12-14 08:44:32,@sipa: agree. Both solutions are workarounds. I'd like to file a bug at apple and see how they react which might lead to an longterm solution.,https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-744280284,744280284,
Sjors,2020-12-14 15:10:56,"MacOS Gitian build of 7f9d623e0210ff539455b0d8dd70b31f14231b8b:\n\n```\n494ccf46f66a57bf93bafd5308cadb1a56ee0fe152bb7f378ce9eea2b63b7354  bitcoin-7f9d623e0210-osx-unsigned.dmg\n2110b65d5223980121602ed4cb0e50558278877148ee59d445a56bd2542014d7  bitcoin-7f9d623e0210-osx-unsigned.tar.gz\n3cfedace3c8d0553450db723aed2f5c3d0a5870b3f5b95e735314232a3fea32e  bitcoin-7f9d623e0210-osx64.tar.gz\na017e7c2",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-744504911,744504911,
fanquake,2020-12-16 13:17:15,Concept ACK,https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-746272118,746272118,
Sjors,2020-12-17 13:12:16,"MacOS Gitian build of 159d203 (after nuking cache):\n\n```\nf3a02590e3223fa9a02989530b427e148e886302bbcf6a2368955c06aca42434  bitcoin-159d203017b6-osx-unsigned.dmg\n33a91c9555828e454ce4127a64685fa4020a688de645e7b9303d2644d1ce2d67  bitcoin-159d203017b6-osx-unsigned.tar.gz\n99a41ee9468b474d24c1f7cc0273a0d07efabd232cf8fa9b6f788a8df8518a88  bitcoin-159d203017b6-osx64.tar.gz\n2c31464f5b2c4a41b846",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-747430705,747430705,
sipa,2020-12-17 19:41:49,"utACK 159d203017b66bc7ae158bf2d3318264332cd5ae. I reviewed the code and the approach matches our understanding of what went wrong.\n\nIt's a pretty hacky solution and who knows what requirements the Apple codesigner will have in the future. But in the short term, based on reports of it being tested by others, it appears to work.",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-747658058,747658058,
laanwj,2020-12-18 12:00:56,"On IRC it was decided decided in favor of #20644 because it looks like it more closely mimics the change that Apple made in the binary-only upstream. There was some worry that it might have by-effects for other tools used in production of the macos binary, so if it turns out that rc4 has other issues we could revert it and still go for this (slightly harder to grasp, but more targeted) solution fo",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-748048537,748048537,
achow101,2020-12-21 22:24:47,Closing for now. Will reopen if needed.,https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-749231432,749231432,
Emzy,2020-12-23 13:33:39,"I was able to run even the wrongly signed binary v0.21.0rc3 from the .dmg after setting an extended attribute via:\n```\nsudo xattr -rd com.apple.quarantine /Applications/Bitcoin-Qt.app\n```",https://github.com/bitcoin/bitcoin/pull/20638#issuecomment-750302627,750302627,
laanwj,2020-12-12 17:10:58,"an aside but 500k is crazy large for a cryptographic signature, i only know some of the quantum-hard signature algorithms produce such large signatures, is it known what algorithm they're using?",https://github.com/bitcoin/bitcoin/pull/20638#discussion_r541673242,541673242,contrib/gitian-descriptors/gitian-osx.yml
sipa,2020-12-12 17:31:44,"I assume it's just because without --pagesize 0, it splits the binary into pages, and signs every page separately. If a page is 4 kB by default (I don't know what the default is), it's not too surprising to get a huge result.\n\nWith --pagesize 0 the signature is just 20 kB. I believe it has still that size because ""resources"" that are embedded in the binary are still signed separately.",https://github.com/bitcoin/bitcoin/pull/20638#discussion_r541684017,541684017,contrib/gitian-descriptors/gitian-osx.yml
achow101,2020-12-12 18:00:57,"I believe it's RSA. The reason the signature is so big is because it's actually multiple signatures. By default, the binary is signed in page sized chunks with each piece getting its own signature. Or at least I think that's what the code is doing.",https://github.com/bitcoin/bitcoin/pull/20638#discussion_r541697807,541697807,contrib/gitian-descriptors/gitian-osx.yml
laanwj,2020-12-12 18:06:17,"thanks!\nyes 20kB isn't that surprising to me for RSA+metadata, and if it signs every page separately that definitely explains things",https://github.com/bitcoin/bitcoin/pull/20638#discussion_r541699717,541699717,contrib/gitian-descriptors/gitian-osx.yml
sipa,2020-12-12 19:20:36,This line seems outdated now.,https://github.com/bitcoin/bitcoin/pull/20638#discussion_r541743305,541743305,contrib/gitian-descriptors/gitian-osx.yml
achow101,2020-12-12 19:21:48,Which part?,https://github.com/bitcoin/bitcoin/pull/20638#discussion_r541743953,541743953,contrib/gitian-descriptors/gitian-osx.yml
sipa,2020-12-12 19:22:59,It's not way larger overestimate anymore.,https://github.com/bitcoin/bitcoin/pull/20638#discussion_r541744643,541744643,contrib/gitian-descriptors/gitian-osx.yml
achow101,2020-12-12 19:25:23,Fixed,https://github.com/bitcoin/bitcoin/pull/20638#discussion_r541746112,541746112,contrib/gitian-descriptors/gitian-osx.yml
MarcoFalke,2020-12-13 06:22:02,"```\nIn gitian-osx.yml line 122:\n\n  UNSIGNED_SIZE=`stat -c %s ${BINARY_RESULT}`\n\n                ^---------------------------^ SC2006: Use $(...) notation instead of legacy backticked `...`.\n\nDid you mean: \n\n  UNSIGNED_SIZE=$(stat -c %s ${BINARY_RESULT})\n\nIn gitian-osx.yml line 123:\n\n  SIG_SIZE_EST=$(((((${UNSIGNED_SIZE} / 4096) + 1) * 32) + 50000))\n\n                  ",https://github.com/bitcoin/bitcoin/pull/20638#discussion_r541856915,541856915,contrib/gitian-descriptors/gitian-osx.yml
achow101,2020-12-13 06:28:39,Fixed.,https://github.com/bitcoin/bitcoin/pull/20638#discussion_r541857842,541857842,contrib/gitian-descriptors/gitian-osx.yml
