[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/955533025",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#issuecomment-955533025",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23397",
    "id": 955533025,
    "node_id": "IC_kwDOABII58449Ebh",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?u=7297e8aaf9188c0cb98bc549a8a02a1dc8d59e4c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-30T17:30:44Z",
    "updated_at": "2021-10-30T17:30:44Z",
    "author_association": "MEMBER",
    "body": "cc @ajtowns @theuni @martinus @jonatack",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/955533025/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/956267838",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#issuecomment-956267838",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23397",
    "id": 956267838,
    "node_id": "IC_kwDOABII5844_30-",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-01T14:11:16Z",
    "updated_at": "2021-11-01T14:11:16Z",
    "author_association": "MEMBER",
    "body": "@hebasto do you expect there are significant performance implications for this change? Should I benchmark?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/956267838/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/956280061",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#issuecomment-956280061",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23397",
    "id": 956280061,
    "node_id": "IC_kwDOABII5844_6z9",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?u=7297e8aaf9188c0cb98bc549a8a02a1dc8d59e4c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-01T14:25:24Z",
    "updated_at": "2021-11-01T14:25:24Z",
    "author_association": "MEMBER",
    "body": "@jamesob\r\n> @hebasto do you expect there are significant performance implications for this change?\r\n\r\nNot sure about \"significant\" :)\r\n\r\n> Should I benchmark?\r\n\r\nI'll appreciate it! Also I have a plan to improve `CCheckQueue` performance further (not here, of course).\r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/956280061/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/956337186",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#issuecomment-956337186",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23397",
    "id": 956337186,
    "node_id": "IC_kwDOABII5845AIwi",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?u=7999a16349f0df0fb273fffa18e5a955c9d3f11c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-01T15:33:35Z",
    "updated_at": "2021-11-01T15:33:35Z",
    "author_association": "MEMBER",
    "body": "Concept ACK, but left some nits.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/956337186/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/956502379",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#issuecomment-956502379",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23397",
    "id": 956502379,
    "node_id": "IC_kwDOABII5845AxFr",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?u=8cdd8653982252593843d7369ecfebe432b89768&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-01T18:59:18Z",
    "updated_at": "2021-11-01T18:59:18Z",
    "author_association": "CONTRIBUTOR",
    "body": "would love to see some thorough testing on this. I could be misremembering, but check cross platform that there's no reason to continue to hold the lock. IIRC there was some sort of edge condition (maybe in window?) around a notify being able to be missed or something, but the details are like 5-6 years out of my cache :)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/956502379/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/958782982",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#issuecomment-958782982",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23397",
    "id": 958782982,
    "node_id": "IC_kwDOABII5845Jd4G",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?u=7297e8aaf9188c0cb98bc549a8a02a1dc8d59e4c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-03T09:36:11Z",
    "updated_at": "2021-11-03T09:36:11Z",
    "author_association": "MEMBER",
    "body": "@sipa @martinus @vasild\r\n\r\nThank you for your reviews and your suggestions!\r\n\r\nUpdated 5bcfd70a3b0e008d7a80e37a29fe90887a0f8c66 -> 459e208276a4d1457d37bf41c977e62caf05456d ([pr23397.01](https://github.com/hebasto/bitcoin/commits/pr23397.01) -> [pr23397.02](https://github.com/hebasto/bitcoin/commits/pr23397.02), [diff](https://github.com/hebasto/bitcoin/compare/pr23397.01..pr23397.02)):\r\n\r\n- addressed all of the comments",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/958782982/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/958997095",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#issuecomment-958997095",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23397",
    "id": 958997095,
    "node_id": "IC_kwDOABII5845KSJn",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-03T12:44:25Z",
    "updated_at": "2021-11-03T12:44:25Z",
    "author_association": "MEMBER",
    "body": "ACKish - I haven't reviewed the code, but it works for the benchmarks and so I guess in some sense I've tested it. As expected, no big diff in performance.\r\n\r\n\r\n\r\n### #23397 vs. $mergebase (absolute)\r\n|                  bench name                   |  x  |           #23397           |         $mergebase         |\r\n|-----------------------------------------------|----:|----------------------------|----------------------------|\r\n| ibd.local.range.500000.540000.total_secs      |   2 | 4826.3510 (\u00b1 0.4951)       | 4831.4970 (\u00b1 6.8399)       |\r\n| ibd.local.range.500000.540000.peak_rss_KiB    |   2 | 6410470.0000 (\u00b1 1750.0000) | 6406678.0000 (\u00b1 2714.0000) |\r\n| ibd.local.range.500000.540000.cpu_kernel_secs |   2 | 345.3800 (\u00b1 3.1200)        | 348.2850 (\u00b1 0.8050)        |\r\n| ibd.local.range.500000.540000.cpu_user_secs   |   2 | 30102.6800 (\u00b1 5.2600)      | 30086.9150 (\u00b1 24.1150)     |\r\n\r\n\r\n### #23397 vs. $mergebase (relative)\r\n|                  bench name                   |  x  | #23397 | $mergebase |\r\n|-----------------------------------------------|----:|-------:|-----------:|\r\n| ibd.local.range.500000.540000.total_secs      |   2 |  1.000 |      1.001 |\r\n| ibd.local.range.500000.540000.peak_rss_KiB    |   2 |  1.001 |      1.000 |\r\n| ibd.local.range.500000.540000.cpu_kernel_secs |   2 |  1.000 |      1.008 |\r\n| ibd.local.range.500000.540000.cpu_user_secs   |   2 |  1.001 |      1.000 |",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/958997095/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/959754739",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#issuecomment-959754739",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23397",
    "id": 959754739,
    "node_id": "IC_kwDOABII5845NLHz",
    "user": {
      "login": "martinus",
      "id": 14386,
      "node_id": "MDQ6VXNlcjE0Mzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/14386?u=da89313ed4793f9594c09c23513f49aa4dc1c141&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/martinus",
      "html_url": "https://github.com/martinus",
      "followers_url": "https://api.github.com/users/martinus/followers",
      "following_url": "https://api.github.com/users/martinus/following{/other_user}",
      "gists_url": "https://api.github.com/users/martinus/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/martinus/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
      "organizations_url": "https://api.github.com/users/martinus/orgs",
      "repos_url": "https://api.github.com/users/martinus/repos",
      "events_url": "https://api.github.com/users/martinus/events{/privacy}",
      "received_events_url": "https://api.github.com/users/martinus/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-03T17:23:34Z",
    "updated_at": "2021-11-03T17:23:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "ACK 459e208, codereview and tested. I first thought this introduced a segfault in `psbt_wallet_tests/psbt_updater_test` because that test failed for me, but thats a different issue fixed in #23403.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/959754739/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740305376",
    "pull_request_review_id": 794342805,
    "id": 740305376,
    "node_id": "PRRC_kwDOABII584sICng",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 8,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`unsigned int` is typically smaller than the size of a vector. Use `size_t` or `std::vector<T>::size_type` perhaps?\r\n\r\nI very much doubt we'll ever have more than 4 billion checks queued up, but it also seems simpler to make the type can just account for everything.",
    "created_at": "2021-11-01T15:31:42Z",
    "updated_at": "2021-11-01T15:32:23Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740305376",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740305376"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740305376"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740305376/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 170,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740306424",
    "pull_request_review_id": 794344135,
    "id": 740306424,
    "node_id": "PRRC_kwDOABII584sIC34",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;\n+        {\n+            LOCK(m_mutex);\n+            for (T& check : vChecks) {\n+                queue.push_back(T());\n+                check.swap(queue.back());\n+            }\n+            num_of_new_checks = vChecks.size();\n+            nTodo += num_of_new_checks;\n         }\n-        nTodo += vChecks.size();\n-        if (vChecks.size() == 1)\n+\n+        if (num_of_new_checks == 1)\n             m_worker_cv.notify_one();\n-        else if (vChecks.size() > 1)\n+        else if (num_of_new_checks > 1)",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 24,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "If you're touching this code, make it follow style? (no indentation without brances).",
    "created_at": "2021-11-01T15:32:51Z",
    "updated_at": "2021-11-01T15:32:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740306424",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740306424"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740306424"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740306424/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 183,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740321362",
    "pull_request_review_id": 794364748,
    "id": 740321362,
    "node_id": "PRRC_kwDOABII584sIGhS",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;\n+        {\n+            LOCK(m_mutex);\n+            for (T& check : vChecks) {\n+                queue.push_back(T());\n+                check.swap(queue.back());\n+            }\n+            num_of_new_checks = vChecks.size();\n+            nTodo += num_of_new_checks;\n         }\n-        nTodo += vChecks.size();\n-        if (vChecks.size() == 1)\n+\n+        if (num_of_new_checks == 1)\n             m_worker_cv.notify_one();\n-        else if (vChecks.size() > 1)\n+        else if (num_of_new_checks > 1)",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 24,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Style is fixed in the second commit. Or do you want me to follow style here?",
    "created_at": "2021-11-01T15:51:09Z",
    "updated_at": "2021-11-01T15:51:09Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740321362",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740321362"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740321362"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740321362/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 183,
    "side": "RIGHT",
    "in_reply_to_id": 740306424
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740325089",
    "pull_request_review_id": 794369884,
    "id": 740325089,
    "node_id": "PRRC_kwDOABII584sIHbh",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 8,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I've chosen `unsinged int` due to https://github.com/bitcoin/bitcoin/blob/5adc5c02800f00d1e6e8812a2b0559b1800e82e9/src/checkqueue.h#L60\r\n\r\nMaybe use `size_t` for `nTodo` as well?",
    "created_at": "2021-11-01T15:54:56Z",
    "updated_at": "2021-11-01T15:54:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740325089",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740325089"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740325089"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740325089/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 170,
    "side": "RIGHT",
    "in_reply_to_id": 740305376
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740366532",
    "pull_request_review_id": 794426408,
    "id": 740366532,
    "node_id": "PRRC_kwDOABII584sIRjE",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 8,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Ah, I see, that makes sense. I think changing to size_t everywhere can be done in a separate PR, if desires.",
    "created_at": "2021-11-01T16:49:01Z",
    "updated_at": "2021-11-01T16:49:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740366532",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740366532"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740366532"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740366532/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 170,
    "side": "RIGHT",
    "in_reply_to_id": 740305376
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740407348",
    "pull_request_review_id": 794481514,
    "id": 740407348,
    "node_id": "PRRC_kwDOABII584sIbg0",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;\n+        {\n+            LOCK(m_mutex);\n+            for (T& check : vChecks) {\n+                queue.push_back(T());\n+                check.swap(queue.back());\n+            }\n+            num_of_new_checks = vChecks.size();\n+            nTodo += num_of_new_checks;\n         }\n-        nTodo += vChecks.size();\n-        if (vChecks.size() == 1)\n+\n+        if (num_of_new_checks == 1)\n             m_worker_cv.notify_one();\n-        else if (vChecks.size() > 1)\n+        else if (num_of_new_checks > 1)",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 24,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Oh, that's fine.",
    "created_at": "2021-11-01T17:45:56Z",
    "updated_at": "2021-11-01T17:45:56Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740407348",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740407348"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740407348"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740407348/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 183,
    "side": "RIGHT",
    "in_reply_to_id": 740306424
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740433358",
    "pull_request_review_id": 794516634,
    "id": 740433358,
    "node_id": "PRRC_kwDOABII584sIh3O",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;\n+        {\n+            LOCK(m_mutex);\n+            for (T& check : vChecks) {\n+                queue.push_back(T());\n+                check.swap(queue.back());\n+            }\n+            num_of_new_checks = vChecks.size();",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 15,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "martinus",
      "id": 14386,
      "node_id": "MDQ6VXNlcjE0Mzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/martinus",
      "html_url": "https://github.com/martinus",
      "followers_url": "https://api.github.com/users/martinus/followers",
      "following_url": "https://api.github.com/users/martinus/following{/other_user}",
      "gists_url": "https://api.github.com/users/martinus/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/martinus/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
      "organizations_url": "https://api.github.com/users/martinus/orgs",
      "repos_url": "https://api.github.com/users/martinus/repos",
      "events_url": "https://api.github.com/users/martinus/events{/privacy}",
      "received_events_url": "https://api.github.com/users/martinus/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: I think you could also write `const auto num_of_new_checks = vChecks.size();` above, saves one line of code in the lock and doesn't keep an uninitialized variable around for a few lines.",
    "created_at": "2021-11-01T18:24:45Z",
    "updated_at": "2021-11-01T18:34:29Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740433358",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740433358"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740433358"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740433358/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 177,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740433985",
    "pull_request_review_id": 794516634,
    "id": 740433985,
    "node_id": "PRRC_kwDOABII584sIiBB",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;\n+        {\n+            LOCK(m_mutex);\n+            for (T& check : vChecks) {\n+                queue.push_back(T());",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 12,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "martinus",
      "id": 14386,
      "node_id": "MDQ6VXNlcjE0Mzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/martinus",
      "html_url": "https://github.com/martinus",
      "followers_url": "https://api.github.com/users/martinus/followers",
      "following_url": "https://api.github.com/users/martinus/following{/other_user}",
      "gists_url": "https://api.github.com/users/martinus/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/martinus/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
      "organizations_url": "https://api.github.com/users/martinus/orgs",
      "repos_url": "https://api.github.com/users/martinus/repos",
      "events_url": "https://api.github.com/users/martinus/events{/privacy}",
      "received_events_url": "https://api.github.com/users/martinus/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: maybe not part of this PR, but using `queue.emplace_back()` instead `queue.push_back(T())` would save one move/copy constructor and one destructor because the object could be directly constructed in the queue",
    "created_at": "2021-11-01T18:25:42Z",
    "updated_at": "2021-11-01T18:34:29Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740433985",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740433985"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740433985"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740433985/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 174,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740454221",
    "pull_request_review_id": 794545507,
    "id": 740454221,
    "node_id": "PRRC_kwDOABII584sIm9N",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 8,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "the max number of checks is IIRC something slightly above 100k",
    "created_at": "2021-11-01T18:56:23Z",
    "updated_at": "2021-11-01T18:56:23Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740454221",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740454221"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740454221"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740454221/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 170,
    "side": "RIGHT",
    "in_reply_to_id": 740305376
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740461509",
    "pull_request_review_id": 794555829,
    "id": 740461509,
    "node_id": "PRRC_kwDOABII584sIovF",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;\n+        {\n+            LOCK(m_mutex);\n+            for (T& check : vChecks) {\n+                queue.push_back(T());\n+                check.swap(queue.back());\n+            }\n+            num_of_new_checks = vChecks.size();",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 15,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Actually none of that is necessary. `vChecks` doesn't change size during the adding loop. The old `vChecks.size()` based checks can be kept.",
    "created_at": "2021-11-01T19:09:07Z",
    "updated_at": "2021-11-01T19:09:08Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740461509",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740461509"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740461509"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740461509/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 177,
    "side": "RIGHT",
    "in_reply_to_id": 740433358
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740519896",
    "pull_request_review_id": 794634686,
    "id": 740519896,
    "node_id": "PRRC_kwDOABII584sI2_Y",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;\n+        {\n+            LOCK(m_mutex);\n+            for (T& check : vChecks) {\n+                queue.push_back(T());\n+                check.swap(queue.back());\n+            }\n+            num_of_new_checks = vChecks.size();",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 15,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": ">  `vChecks` doesn't change size during the adding loop.\r\n\r\nCorrect. But `vChecks` is passed in `CCheckQueue::Add` by a non-const reference, and that makes possible its modification by a concurrent thread between leaving a critical section and checking `num_of_new_checks == 1`.\r\n\r\nAlthough, the only caller is located in `CChainState::ConnectBlock` which is guarded by the `cs_main` mutex. Therefore,  you are right.\r\n\r\n> The old `vChecks.size()` based checks can be kept.\r\n\r\nYes, it will work. But while looking into `CCheckQueue::Add` code, it is not obvious that `vChecks.size()` is constant in multi-threading environment. I think that adding a local variable makes code more readable and robust considering any possible changes at the caller site(s) in the future.\r\n\r\nOTOH, it seems all could look clearer if we pass `vChecks` as an rvalue reference using move semantics. What do you think?",
    "created_at": "2021-11-01T20:48:06Z",
    "updated_at": "2021-11-01T20:48:06Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740519896",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740519896"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r740519896"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740519896/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 177,
    "side": "RIGHT",
    "in_reply_to_id": 740433358
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741207782",
    "pull_request_review_id": 795583134,
    "id": 741207782,
    "node_id": "PRRC_kwDOABII584sLe7m",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;\n+        {\n+            LOCK(m_mutex);\n+            for (T& check : vChecks) {\n+                queue.push_back(T());",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 12,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "What about `queue.push_back(std::move(check))`?",
    "created_at": "2021-11-02T15:36:41Z",
    "updated_at": "2021-11-02T15:36:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741207782",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741207782"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741207782"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741207782/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 174,
    "side": "RIGHT",
    "in_reply_to_id": 740433985
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741224832",
    "pull_request_review_id": 795601161,
    "id": 741224832,
    "node_id": "PRRC_kwDOABII584sLjGA",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;\n+        {\n+            LOCK(m_mutex);\n+            for (T& check : vChecks) {\n+                queue.push_back(T());\n+                check.swap(queue.back());\n+            }\n+            num_of_new_checks = vChecks.size();",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 15,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I would never think that a reference argument could be changed by another thread while the function is executing. I hope we don't do that anywhere in the code. Because how would the function avoid races? Which mutex protects the argument? That would require something like (it does not compile, of course):\r\n\r\n```cpp\r\nvoid func(T& arg GUARDED_BY(some_mutex), ...)\r\n{\r\n    ...\r\n    LOCK(some_mutex);\r\n    access arg;\r\n    ...\r\n```\r\n\r\nSo, I think it is safe to assume that `vChecks` will not change while `Add()` is executing. Indeed the only caller passes in a local variable that is not visible by other threads (and then throws it away, so the \"swap\" is actually a \"move\").\r\n\r\n> ... it seems all could look clearer if we pass vChecks as an rvalue reference using move semantics ...\r\n\r\nYes :) and `std::move()` each element from `vChecks` into `queue`. It is unnecessary to first create a default-constructed object only to swap it with another and throw it away. This is what `std::move()` is for.",
    "created_at": "2021-11-02T15:50:10Z",
    "updated_at": "2021-11-02T15:50:11Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741224832",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741224832"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741224832"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741224832/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 177,
    "side": "RIGHT",
    "in_reply_to_id": 740433358
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741232993",
    "pull_request_review_id": 795609528,
    "id": 741232993,
    "node_id": "PRRC_kwDOABII584sLlFh",
    "diff_hunk": "@@ -167,16 +167,26 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        if (vChecks.empty()) {",
    "path": "src/checkqueue.h",
    "position": 8,
    "original_position": 8,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "5bcfd70a3b0e008d7a80e37a29fe90887a0f8c66",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The code below assumes `vChecks` may be modified by another thread while this is executing (it cannot actually). I guess either remove that assumption or move this access to `vChecks` under `m_mutex` (if that mutex it supposed to protect `vChecks`!?).\r\n\r\nIt is a race to call `std::vector::empty()` while modifying it concurrently.",
    "created_at": "2021-11-02T15:56:17Z",
    "updated_at": "2021-11-02T15:56:49Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741232993",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741232993"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741232993"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741232993/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 170,
    "original_line": 170,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741247135",
    "pull_request_review_id": 795623542,
    "id": 741247135,
    "node_id": "PRRC_kwDOABII584sLoif",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;\n+        {\n+            LOCK(m_mutex);\n+            for (T& check : vChecks) {\n+                queue.push_back(T());\n+                check.swap(queue.back());\n+            }\n+            num_of_new_checks = vChecks.size();",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 15,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "@hebasto That's not how `const` works in C++. The lack thereof means *you* (the called function in this case) are allowed to modify the argument; it says nothing at all about whether another thread might be modifying the same variable. Even if the argument was `const`, nothing prevents another thread from holding a mutable reference to the same object.\r\n\r\nThat said, passing an argument (const or not) to a function while it is being modified by other threads would be completely non-idiomatic, dangerous code. It is possible, and sometimes necessary of course, but at least you'd expect the passed object to have internal mutexes or other synchronization mechanisms to protect its state in that case; not something the callee should deal with. Virtually every STL function will exhibit undefined behavior if you pass it references to arguments that are being modified concurrently. Outside of very exceptional cases that should raise big red flags, you can very much assume that arguments passed to a function are under exclusive control of that function for the duration of its execution.",
    "created_at": "2021-11-02T16:06:47Z",
    "updated_at": "2021-11-02T16:06:47Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741247135",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741247135"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741247135"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741247135/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 177,
    "side": "RIGHT",
    "in_reply_to_id": 740433358
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741260491",
    "pull_request_review_id": 795641874,
    "id": 741260491,
    "node_id": "PRRC_kwDOABII584sLrzL",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;\n+        {\n+            LOCK(m_mutex);\n+            for (T& check : vChecks) {\n+                queue.push_back(T());",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 12,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "martinus",
      "id": 14386,
      "node_id": "MDQ6VXNlcjE0Mzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/martinus",
      "html_url": "https://github.com/martinus",
      "followers_url": "https://api.github.com/users/martinus/followers",
      "following_url": "https://api.github.com/users/martinus/following{/other_user}",
      "gists_url": "https://api.github.com/users/martinus/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/martinus/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
      "organizations_url": "https://api.github.com/users/martinus/orgs",
      "repos_url": "https://api.github.com/users/martinus/repos",
      "events_url": "https://api.github.com/users/martinus/events{/privacy}",
      "received_events_url": "https://api.github.com/users/martinus/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I tried that once but then tests fail, I think for the types used here `std::swap` is implemented but a move constructor isn't. I didn't have a closer look why that fails.\r\n\r\nI think the nicest c++ solution would be to replace the whole loop with\r\n\r\n```cpp\r\nqueue.insert(queue.end(), std::make_move_iterator(vChecks.begin()), std::make_move_iterator(vChecks.end()));\r\n```\r\n\r\nBut this too requires properly implementing move constructor.",
    "created_at": "2021-11-02T16:21:05Z",
    "updated_at": "2021-11-02T16:21:23Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741260491",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741260491"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741260491"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741260491/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 174,
    "side": "RIGHT",
    "in_reply_to_id": 740433985
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741274241",
    "pull_request_review_id": 795660911,
    "id": 741274241,
    "node_id": "PRRC_kwDOABII584sLvKB",
    "diff_hunk": "@@ -167,15 +167,20 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        unsigned int num_of_new_checks;\n+        {\n+            LOCK(m_mutex);\n+            for (T& check : vChecks) {\n+                queue.push_back(T());\n+                check.swap(queue.back());\n+            }\n+            num_of_new_checks = vChecks.size();",
    "path": "src/checkqueue.h",
    "position": null,
    "original_position": 15,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "0e4169972203d9cde0f1c86cb6084ab9c2db41e2",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "@sipa Thanks for your detailed explanation.\r\n\r\nGoing to address all of the comments.",
    "created_at": "2021-11-02T16:36:19Z",
    "updated_at": "2021-11-02T16:36:20Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741274241",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741274241"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741274241"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741274241/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 177,
    "side": "RIGHT",
    "in_reply_to_id": 740433358
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741276311",
    "pull_request_review_id": 795663889,
    "id": 741276311,
    "node_id": "PRRC_kwDOABII584sLvqX",
    "diff_hunk": "@@ -167,16 +167,26 @@ class CCheckQueue\n     //! Add a batch of checks to the queue\n     void Add(std::vector<T>& vChecks)\n     {\n-        LOCK(m_mutex);\n-        for (T& check : vChecks) {\n-            queue.push_back(T());\n-            check.swap(queue.back());\n+        if (vChecks.empty()) {",
    "path": "src/checkqueue.h",
    "position": 8,
    "original_position": 8,
    "commit_id": "459e208276a4d1457d37bf41c977e62caf05456d",
    "original_commit_id": "5bcfd70a3b0e008d7a80e37a29fe90887a0f8c66",
    "user": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "You are right.\r\n\r\n> I guess either remove that assumption or move this access to `vChecks` under `m_mutex` (if that mutex it supposed to protect `vChecks`!?).\r\n\r\nThe former will go.",
    "created_at": "2021-11-02T16:38:42Z",
    "updated_at": "2021-11-02T16:38:42Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741276311",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741276311"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23397#discussion_r741276311"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23397"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741276311/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 170,
    "original_line": 170,
    "side": "RIGHT",
    "in_reply_to_id": 741232993
  }
]