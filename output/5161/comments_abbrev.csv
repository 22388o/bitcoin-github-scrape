gmaxwell,2014-10-28T22:08:26Z,"I've tested this (and variations of it) for a while and I'm happy with it. I think its reasonably simple now and avoids moving much of anything around.\n\nThe testing I performed was two fold, I ran an instrumented copy that logged its announcements and saw it making both types of announcements.\n\nI also ran a node behind nat (with a port forward) which hasn't had bitcoin running on it recently w",https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-60840573,60840573,
TheBlueMatt,2014-10-29T06:13:37Z,"Can we change the help text on -discover to say something like ""Do not rumor your address except as provided by -localip""? (and, more broadly, do we really want a flag for this? It is some strange depend-on-my-peer-not-rumoring-my-address benchmark, when we really should just use fListen?)\n",https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-60878774,60878774,
gmaxwell,2014-10-29T07:21:58Z,"> Can we change the help text on -discover to say something like ""Do not rumor your address except as provided by -localip""? (and, more broadly, do we really want a flag for this? It is some strange depend-on-my-peer-not-rumoring-my-address benchmark, when we really should just use fListen?)\n\nConsider, when you're listening to torHS you want listen=1 but you certantly don't want discovery of any",https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-60883023,60883023,
ghost,2014-10-29T08:09:59Z,"> I think there is some clown out there who is addr messaging for everyone who connects to him\n\nThere's a number of clients on the network that do absolutely stupid things with the IP address in the handshake and addr messages. One piece of software returns `::1` for everything, another returns a `0.0.0.0`, another makes up random IP addresses for their peers. I don't know what software they are",https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-60886639,60886639,
gmaxwell,2014-10-29T08:16:41Z,"Yea, this patch doesn't assume the peers are non-evil, much less assuming they aren't conventionally broken.  \n",https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-60887226,60887226,
gmaxwell,2014-10-29T20:34:49Z,@TheBlueMatt see updates\n,https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-60999829,60999829,
spinza,2014-10-30T13:16:26Z,Does this pull request also resolve issue https://github.com/bitcoin/bitcoin/issues/48 ?\n,https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-61089105,61089105,
gmaxwell,2014-10-30T17:34:15Z,@spinza the substance of #48 was mostly solved by the prior heartbeating changes. But this will improve the loss of inbound connections after your IP changes.\n,https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-61134335,61134335,
gmaxwell,2014-11-04T18:51:22Z,@luke-jr updated\n,https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-61692994,61692994,
luke-jr,2014-11-04T20:21:03Z,"```\n-----BEGIN PGP SIGNED MESSAGE-----\nHash: SHA256\n\nACK commit 5fd28b94e57d14f81bc63717c99e3e7ca7316b75 : Looked over the code, without fully understanding the logic behind it, and tested that the correct external IP does get advertised properly in an IPv4-only behind-NAT-without-UPnP scenario.\n-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v2\n\niQQcBAEBCAAGBQJUWTUnAAoJEL0ClCQh9IifY1wf/R8eYE",https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-61707412,61707412,
laanwj,2014-11-05T10:25:15Z,"```\n-----BEGIN PGP SIGNED MESSAGE-----\nHash: SHA512\n\nTested ACK 5fd28b94e57d14f81bc63717c99e3e7ca7316b75\nI've tested w/ a host behind NAT, upnp=0, discover=1, it advertizes the right IP\nAlso tested with discover=0 and no externalip, no advertizing of local addresses happens (as expected)\nReviewed the code and the logic makes sense to me\n-----BEGIN PGP SIGNATURE-----\nVersion: GnuPG v1\n\ni",https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-61787009,61787009,
gmaxwell,2014-11-07T16:45:24Z,Does anyone feel this is waiting on anything else?\n,https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-62173258,62173258,
sipa,2014-11-07T17:34:44Z,"utACK, with a few nits.\n",https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-62182327,62182327,
gmaxwell,2014-11-07T20:15:15Z,"@sipa  adjusted except for the nLastRebroadcast.  I think you were misreading it there. Can you confirm?\n\nOn the disabling it when using a non-default port, any of the other ACKers have an opinion?  I think it could go either way. Avoiding running it seemed more conservative to me, but there are cases where if we require the default port it would fail to discover an address that would be useful.",https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-62205211,62205211,
laanwj,2014-11-11T06:31:52Z,"@gmaxwell I'd say it's still useful to be able to discover external IP changes even if not using the default port. Throughout the code, bitcoind assumes that it knows the port where it's listening on.\n\nThe edge case here would be a) behind NAT b) manually forwarded port c) external port is different from internal port. But in that case `bitcoind` has no way of discovering what the external port ",https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-62507903,62507903,
gmaxwell,2014-11-11T09:10:46Z,"@laanwj Okay, great. (I did change it so that it doesn't require the default port anymore).\n",https://github.com/bitcoin/bitcoin/pull/5161#issuecomment-62520318,62520318,
TheBlueMatt,2014-10-29T06:14:03Z,"Because of this we only clear setAddrKnown when we're listening, which I dont think was intended?\n",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19521528,19521528,src/main.cpp
TheBlueMatt,2014-10-29T06:21:07Z,After this youve cleared the nServices and nTime fields set by GetLocalAddress.\n,https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19521643,19521643,src/main.cpp
TheBlueMatt,2014-10-29T06:21:15Z,After this youve cleared the nServices and nTime fields set by GetLocalAddress.\n,https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19521645,19521645,src/net.cpp
gmaxwell,2014-10-29T06:49:35Z,"gah. good catch. I added that at the last minute ""oh why bother taking the vnodes lock when we're not going to do anything with it.""\n",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19522135,19522135,src/main.cpp
kanzure,2014-10-29T21:50:38Z,"Does AdvertizeLocal still qualify for the previous comment (""used when scores of local addresses may have changed"")?\n",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19574924,19574924,src/net.cpp
gmaxwell,2014-10-29T22:16:19Z,"Only indirectly. Previously it invoked readvertisement more frequently, potentially triggered by external events. With this change we only advertise on connect and on a timer... if the scores change it'll influence what we advertise, but no longer directly triggers it.\n",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19576345,19576345,src/net.cpp
luke-jr,2014-11-04T14:04:43Z,I don't think this rationale fits. Proxies aren't always for privacy. More importantly: is there a reason not to default discover to false always?\n,https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19803608,19803608,src/init.cpp
luke-jr,2014-11-04T14:12:07Z,"How about using addr.SetIP(pfrom->addrLocal); here, rather than re-setting nServices/nTime below? (this seems more future-proof if CAddress adds new stuff ever)\n",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19803935,19803935,src/main.cpp
luke-jr,2014-11-04T14:14:08Z,This would be clearer to just say if (!vNodes.empty())\n,https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19804034,19804034,src/main.cpp
luke-jr,2014-11-04T14:15:53Z,Is advertise intentionally misspelled?\n,https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19804117,19804117,src/net.cpp
gmaxwell,2014-11-04T18:21:33Z,"If proxy is set complex things are happening with your networking and discovery is much more likely not useful.\n\nDefaulting to discover false would break listening for every host behind NAT by default, precisely those users who are least likely to set things right.\n\nAvoiding it when proxy is set helps minimize unwanted surprises without gratitious breakage (afer all, we already disabling liste",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19823321,19823321,src/init.cpp
gmaxwell,2014-11-04T18:24:54Z,It's not misspelled. advertize is EN_US and that was the name previously.\n,https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19823564,19823564,src/net.cpp
gmaxwell,2014-11-04T18:46:22Z,"Hm. Originally I'd had more complex logic; skipping it if it didn't successfully broadcast but that interacted poorly with Addrknown clearing, okay, fair enough it can indeed be simplified now.\n",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19825117,19825117,src/main.cpp
gmaxwell,2014-11-04T18:50:59Z,"This cuts both ways, e.g. extra fields you didn't want kept. But I agree thats better, changed.\n",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19825459,19825459,src/main.cpp
luke-jr,2014-11-04T18:58:52Z,"Weird, I've never seen it spelled with a 'z' even in EN_US, but it appears Google agrees.\n",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r19826071,19826071,src/net.cpp
sipa,2014-11-07T17:29:59Z,Why would the address a peer tells us be not good if we're running on a non-standard port?\n,https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20024028,20024028,src/net.cpp
sipa,2014-11-07T17:30:37Z,This probably runs much more than needed. Would it make sense to move it into the above if block?\n,https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20024063,20024063,src/main.cpp
sipa,2014-11-07T17:31:48Z,Use LOCAL_NONE constant instead?\n,https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20024145,20024145,src/net.cpp
sipa,2014-11-07T17:33:36Z,Coding style nit: a few more spaces please? (I actually misread the > as a -> initially)\n,https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20024250,20024250,src/net.cpp
gmaxwell,2014-11-07T19:42:10Z,"The peer can't tell us anything about the port we're listning on, (E.g. you connect out to some peer and they see the source _port_ as some random number).... we're already behind address translation. Seemed more conservative to skip in this case.\n",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20032191,20032191,src/net.cpp
gmaxwell,2014-11-07T19:49:58Z,"The prior if is always true except the first time through, we do actually want this to fire the first time through. I think? the test that keeps it from running all the time is two blocks up (on the line with the initialblockdownload check).\n",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20032690,20032690,src/main.cpp
laanwj,2014-11-08T13:23:25Z,"After this change do we ever advertize our Tor hidden service address? I've added logging to my test node that listens both on Tor and plainnet, both external addresses appear as SeenLocal\n\n```\n2014-11-08 12:56:48 SeenLocal: xx.xx.xx.xx:8333\n2014-11-08 12:57:05 SeenLocal: xxx.onion:8333\n```\n\nHowever, it always advertizes the IPv4 address\n\n```\n2014-11-08 09:15:21 AdvertizeLocal: advertizi",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20051653,20051653,src/net.cpp
sipa,2014-11-08T13:54:41Z,ok\n,https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20051775,20051775,src/main.cpp
gmaxwell,2014-11-08T18:21:49Z,"The resason you're seen-localing it is becasue peers who already know it are connecting inbound to you.  Since outbound HS peers can never seen your HS address it can't be discovered, and must be configured with externalips.\n",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20053219,20053219,src/net.cpp
laanwj,2014-11-10T15:34:31Z,"OK - so when providing externalips, it will advertise the HS address?\n",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20088383,20088383,src/net.cpp
gmaxwell,2014-11-10T17:12:51Z,"Yes; for two reasons: one is because externalips disables discover, the other is because if you enable discover it still mosty uses the traditional address source (what it would have used if discover were distabled) if it has one that it thinks is routable.\n",https://github.com/bitcoin/bitcoin/pull/5161#discussion_r20096085,20096085,src/net.cpp
