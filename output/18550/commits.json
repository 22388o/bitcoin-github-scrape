[
  {
    "sha": "704772d5b0d271f04b8d6729024af11d68a20998",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3MDQ3NzJkNWIwZDI3MWYwNGI4ZDY3MjkwMjRhZjExZDY4YTIwOTk4",
    "commit": {
      "author": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-04-06T21:46:28Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-04-07T11:31:35Z"
      },
      "message": "Wallet: Refactor SetAddressBookWithDB to be clearer (no behaviour changes)",
      "tree": {
        "sha": "1924f5df39aeeffa706587e5f435a747cb52606c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1924f5df39aeeffa706587e5f435a747cb52606c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/704772d5b0d271f04b8d6729024af11d68a20998",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/704772d5b0d271f04b8d6729024af11d68a20998",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/704772d5b0d271f04b8d6729024af11d68a20998",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/704772d5b0d271f04b8d6729024af11d68a20998/comments",
    "author": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "63dad673487d3623f9076721d2a1924263272eb9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/63dad673487d3623f9076721d2a1924263272eb9",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/63dad673487d3623f9076721d2a1924263272eb9"
      }
    ],
    "stats": {
      "total": 15,
      "additions": 12,
      "deletions": 3
    },
    "files": [
      {
        "sha": "bb952f4ed3c7db362264ddf9a45a4a8b477dfa93",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 12,
        "deletions": 3,
        "changes": 15,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/704772d5b0d271f04b8d6729024af11d68a20998/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/704772d5b0d271f04b8d6729024af11d68a20998/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=704772d5b0d271f04b8d6729024af11d68a20998",
        "patch": "@@ -3198,10 +3198,19 @@ bool CWallet::SetAddressBookWithDB(WalletBatch& batch, const CTxDestination& add\n     {\n         LOCK(cs_wallet);\n         std::map<CTxDestination, CAddressBookData>::iterator mi = m_address_book.find(address);\n-        fUpdated = (mi != m_address_book.end() && !mi->second.IsChange());\n-        m_address_book[address].SetLabel(strName);\n+        if (mi == m_address_book.end()) {\n+            // Entirely new address book entry\n+            mi = m_address_book.emplace(address, CAddressBookData()).first;\n+        } else if (mi->second.IsChange()) {\n+            // Transforming change to non-change\n+            // Nothing special to do here\n+        } else {\n+            // Simply modifying label/purpose of existing normal address book entry\n+            fUpdated = true;\n+        }\n+        mi->second.SetLabel(strName);\n         if (!strPurpose.empty()) /* update purpose only if requested */\n-            m_address_book[address].purpose = strPurpose;\n+            mi->second.purpose = strPurpose;\n     }\n     NotifyAddressBookChanged(this, address, strName, IsMine(address) != ISMINE_NO,\n                              strPurpose, (fUpdated ? CT_UPDATED : CT_NEW) );"
      }
    ]
  },
  {
    "sha": "7050d5ecfca199d0afb90c72e58f737d9fbb64f2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3MDUwZDVlY2ZjYTE5OWQwYWZiOTBjNzJlNThmNzM3ZDlmYmI2NGYy",
    "commit": {
      "author": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-04-06T22:00:31Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-04-07T11:31:35Z"
      },
      "message": "Wallet: Refactor SetAddressBookWithDB to only encode the address string once",
      "tree": {
        "sha": "9f187a50a72aa7366ead4e045e696e2f6c38d9a8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9f187a50a72aa7366ead4e045e696e2f6c38d9a8"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7050d5ecfca199d0afb90c72e58f737d9fbb64f2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7050d5ecfca199d0afb90c72e58f737d9fbb64f2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/7050d5ecfca199d0afb90c72e58f737d9fbb64f2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7050d5ecfca199d0afb90c72e58f737d9fbb64f2/comments",
    "author": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "704772d5b0d271f04b8d6729024af11d68a20998",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/704772d5b0d271f04b8d6729024af11d68a20998",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/704772d5b0d271f04b8d6729024af11d68a20998"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 3,
      "deletions": 2
    },
    "files": [
      {
        "sha": "222c895d849afc0b2e1b77f352be6270e0c40194",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 2,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7050d5ecfca199d0afb90c72e58f737d9fbb64f2/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7050d5ecfca199d0afb90c72e58f737d9fbb64f2/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=7050d5ecfca199d0afb90c72e58f737d9fbb64f2",
        "patch": "@@ -3195,6 +3195,7 @@ DBErrors CWallet::ZapWalletTx(std::vector<CWalletTx>& vWtx)\n bool CWallet::SetAddressBookWithDB(WalletBatch& batch, const CTxDestination& address, const std::string& strName, const std::string& strPurpose)\n {\n     bool fUpdated = false;\n+    const std::string strAddress = EncodeDestination(address);\n     {\n         LOCK(cs_wallet);\n         std::map<CTxDestination, CAddressBookData>::iterator mi = m_address_book.find(address);\n@@ -3214,9 +3215,9 @@ bool CWallet::SetAddressBookWithDB(WalletBatch& batch, const CTxDestination& add\n     }\n     NotifyAddressBookChanged(this, address, strName, IsMine(address) != ISMINE_NO,\n                              strPurpose, (fUpdated ? CT_UPDATED : CT_NEW) );\n-    if (!strPurpose.empty() && !batch.WritePurpose(EncodeDestination(address), strPurpose))\n+    if (!strPurpose.empty() && !batch.WritePurpose(strAddress, strPurpose))\n         return false;\n-    return batch.WriteName(EncodeDestination(address), strName);\n+    return batch.WriteName(strAddress, strName);\n }\n \n bool CWallet::SetAddressBook(const CTxDestination& address, const std::string& strName, const std::string& strPurpose)"
      }
    ]
  },
  {
    "sha": "ea487a39c8f4d1b7b99b567cd8442f911f7e3869",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplYTQ4N2EzOWM4ZjRkMWI3Yjk5YjU2N2NkODQ0MmY5MTFmN2UzODY5",
    "commit": {
      "author": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-04-06T22:19:29Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-04-07T11:31:35Z"
      },
      "message": "Wallet: Keep change destdata in new \"changedata\" key to hide it from old versions",
      "tree": {
        "sha": "49d19223b25e67fb6b6faf702463e2d40f33fc08",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/49d19223b25e67fb6b6faf702463e2d40f33fc08"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ea487a39c8f4d1b7b99b567cd8442f911f7e3869",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ea487a39c8f4d1b7b99b567cd8442f911f7e3869",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ea487a39c8f4d1b7b99b567cd8442f911f7e3869",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ea487a39c8f4d1b7b99b567cd8442f911f7e3869/comments",
    "author": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "7050d5ecfca199d0afb90c72e58f737d9fbb64f2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7050d5ecfca199d0afb90c72e58f737d9fbb64f2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/7050d5ecfca199d0afb90c72e58f737d9fbb64f2"
      }
    ],
    "stats": {
      "total": 20,
      "additions": 13,
      "deletions": 7
    },
    "files": [
      {
        "sha": "66d4720926c60fe36ca791a0e22bbc1772657c33",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 2,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ea487a39c8f4d1b7b99b567cd8442f911f7e3869/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ea487a39c8f4d1b7b99b567cd8442f911f7e3869/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=ea487a39c8f4d1b7b99b567cd8442f911f7e3869",
        "patch": "@@ -3204,7 +3204,11 @@ bool CWallet::SetAddressBookWithDB(WalletBatch& batch, const CTxDestination& add\n             mi = m_address_book.emplace(address, CAddressBookData()).first;\n         } else if (mi->second.IsChange()) {\n             // Transforming change to non-change\n-            // Nothing special to do here\n+            // Move any changedata to destdata, so older versions see it\n+            for (const auto& item : mi->second.destdata) {\n+                batch.EraseDestData(strAddress, item.first);\n+                batch.WriteDestData(strAddress, item.first, item.second, /* is_change */ false);\n+            }\n         } else {\n             // Simply modifying label/purpose of existing normal address book entry\n             fUpdated = true;\n@@ -3687,7 +3691,7 @@ bool CWallet::AddDestData(WalletBatch& batch, const CTxDestination &dest, const\n         return false;\n \n     m_address_book[dest].destdata.insert(std::make_pair(key, value));\n-    return batch.WriteDestData(EncodeDestination(dest), key, value);\n+    return batch.WriteDestData(EncodeDestination(dest), key, value, m_address_book[dest].IsChange());\n }\n \n bool CWallet::EraseDestData(WalletBatch& batch, const CTxDestination &dest, const std::string &key)"
      },
      {
        "sha": "73d677e8ed2f350789881e9ed9a65a41ef21501f",
        "filename": "src/wallet/walletdb.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 4,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ea487a39c8f4d1b7b99b567cd8442f911f7e3869/src/wallet/walletdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ea487a39c8f4d1b7b99b567cd8442f911f7e3869/src/wallet/walletdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.cpp?ref=ea487a39c8f4d1b7b99b567cd8442f911f7e3869",
        "patch": "@@ -23,6 +23,7 @@ namespace DBKeys {\n const std::string ACENTRY{\"acentry\"};\n const std::string BESTBLOCK_NOMERKLE{\"bestblock_nomerkle\"};\n const std::string BESTBLOCK{\"bestblock\"};\n+const std::string CHANGEDATA{\"changedata\"};\n const std::string CRYPTED_KEY{\"ckey\"};\n const std::string CSCRIPT{\"cscript\"};\n const std::string DEFAULTKEY{\"defaultkey\"};\n@@ -384,7 +385,7 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             }\n         } else if (strType == DBKeys::ORDERPOSNEXT) {\n             ssValue >> pwallet->nOrderPosNext;\n-        } else if (strType == DBKeys::DESTDATA) {\n+        } else if (strType == DBKeys::DESTDATA || strType == DBKeys::CHANGEDATA) {\n             std::string strAddress, strKey, strValue;\n             ssKey >> strAddress;\n             ssKey >> strKey;\n@@ -740,14 +741,15 @@ bool WalletBatch::VerifyDatabaseFile(const fs::path& wallet_path, std::vector<st\n     return BerkeleyBatch::VerifyDatabaseFile(wallet_path, warnings, errorStr, WalletBatch::Recover);\n }\n \n-bool WalletBatch::WriteDestData(const std::string &address, const std::string &key, const std::string &value)\n+bool WalletBatch::WriteDestData(const std::string &address, const std::string &key, const std::string &value, const bool is_change)\n {\n-    return WriteIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(address, key)), value);\n+    return WriteIC(std::make_pair(is_change ? DBKeys::CHANGEDATA : DBKeys::DESTDATA, std::make_pair(address, key)), value);\n }\n \n bool WalletBatch::EraseDestData(const std::string &address, const std::string &key)\n {\n-    return EraseIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(address, key)));\n+    return EraseIC(std::make_pair(DBKeys::DESTDATA, std::make_pair(address, key)))\n+        && EraseIC(std::make_pair(DBKeys::CHANGEDATA, std::make_pair(address, key)));\n }\n \n "
      },
      {
        "sha": "0574e659afbabe52adea0f8d4fce4212b8de6c40",
        "filename": "src/wallet/walletdb.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ea487a39c8f4d1b7b99b567cd8442f911f7e3869/src/wallet/walletdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ea487a39c8f4d1b7b99b567cd8442f911f7e3869/src/wallet/walletdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.h?ref=ea487a39c8f4d1b7b99b567cd8442f911f7e3869",
        "patch": "@@ -241,7 +241,7 @@ class WalletBatch\n     bool WriteMinVersion(int nVersion);\n \n     /// Write destination data key,value tuple to database\n-    bool WriteDestData(const std::string &address, const std::string &key, const std::string &value);\n+    bool WriteDestData(const std::string &address, const std::string &key, const std::string &value, bool is_change);\n     /// Erase destination data tuple from wallet database\n     bool EraseDestData(const std::string &address, const std::string &key);\n "
      }
    ]
  },
  {
    "sha": "72ff5515fbac691065b6882f16e7fad2fb1aa151",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3MmZmNTUxNWZiYWM2OTEwNjViNjg4MmYxNmU3ZmFkMmZiMWFhMTUx",
    "commit": {
      "author": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-04-06T23:29:05Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-04-07T11:31:35Z"
      },
      "message": "Wallet: When loading a wallet, migrate any \"destdata\" keys on change addresses to \"changedata\"",
      "tree": {
        "sha": "a789ec60c7050e5874ed12cb0b8d9a7e4b8c400f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a789ec60c7050e5874ed12cb0b8d9a7e4b8c400f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/72ff5515fbac691065b6882f16e7fad2fb1aa151",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/72ff5515fbac691065b6882f16e7fad2fb1aa151",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/72ff5515fbac691065b6882f16e7fad2fb1aa151",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/72ff5515fbac691065b6882f16e7fad2fb1aa151/comments",
    "author": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ea487a39c8f4d1b7b99b567cd8442f911f7e3869",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ea487a39c8f4d1b7b99b567cd8442f911f7e3869",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ea487a39c8f4d1b7b99b567cd8442f911f7e3869"
      }
    ],
    "stats": {
      "total": 38,
      "additions": 34,
      "deletions": 4
    },
    "files": [
      {
        "sha": "e82e35fdc224dc7e6ea69a48db2a03b31cb0d704",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 28,
        "deletions": 2,
        "changes": 30,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/72ff5515fbac691065b6882f16e7fad2fb1aa151/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/72ff5515fbac691065b6882f16e7fad2fb1aa151/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=72ff5515fbac691065b6882f16e7fad2fb1aa151",
        "patch": "@@ -3701,9 +3701,35 @@ bool CWallet::EraseDestData(WalletBatch& batch, const CTxDestination &dest, cons\n     return batch.EraseDestData(EncodeDestination(dest), key);\n }\n \n-void CWallet::LoadDestData(const CTxDestination &dest, const std::string &key, const std::string &value)\n+void CWallet::LoadDestData(const CTxDestination &dest, const std::string &key, const std::string &value, const bool is_change)\n {\n-    m_address_book[dest].destdata.insert(std::make_pair(key, value));\n+    auto& destdata = m_address_book[dest].destdata;\n+    destdata.insert(std::make_pair(key, value));\n+    if (!is_change) destdata[\"_nonchange_destdata\"] = std::string();\n+}\n+\n+void CWallet::FixAddressBook(WalletBatch& batch)\n+{\n+    unsigned fixed_addresses = 0, migrated_keys = 0;\n+    for (auto& addressbookdata_pair : m_address_book) {\n+        auto& destdata = addressbookdata_pair.second.destdata;\n+        if (!destdata.count(\"_nonchange_destdata\")) continue;\n+        destdata.erase(\"_nonchange_destdata\");\n+        if (!addressbookdata_pair.second.IsChange()) continue;\n+\n+        // We have a change address with [non-change] destdata set\n+        // Migrate it to changedata keys\n+        ++fixed_addresses;\n+        const std::string strAddress = EncodeDestination(addressbookdata_pair.first);\n+        for (const auto& item : destdata) {\n+            ++migrated_keys;\n+            batch.EraseDestData(strAddress, item.first);\n+            batch.WriteDestData(strAddress, item.first, item.second, /* is_change */ true);\n+        }\n+    }\n+    if (fixed_addresses) {\n+        WalletLogPrintf(\"Fixed %u change address book entries (%u destdata entries)\\n\", fixed_addresses, migrated_keys);\n+    }\n }\n \n bool CWallet::GetDestData(const CTxDestination &dest, const std::string &key, std::string *value) const"
      },
      {
        "sha": "0a3864774cff6eb0333126bc55409d2b2aaf83d6",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 3,
        "deletions": 1,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/72ff5515fbac691065b6882f16e7fad2fb1aa151/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/72ff5515fbac691065b6882f16e7fad2fb1aa151/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=72ff5515fbac691065b6882f16e7fad2fb1aa151",
        "patch": "@@ -847,6 +847,8 @@ class CWallet final : public WalletStorage, public interfaces::Chain::Notificati\n     int64_t ScanningDuration() const { return fScanningWallet ? GetTimeMillis() - m_scanning_start : 0; }\n     double ScanningProgress() const { return fScanningWallet ? (double) m_scanning_progress : 0; }\n \n+    //! Check for change with non-change destdata and move it to changedata\n+    void FixAddressBook(WalletBatch&) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n     //! Upgrade stored CKeyMetadata objects to store key origin info as KeyOriginInfo\n     void UpgradeKeyMetadata() EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n \n@@ -860,7 +862,7 @@ class CWallet final : public WalletStorage, public interfaces::Chain::Notificati\n     //! Erases a destination data tuple in the store and on disk\n     bool EraseDestData(WalletBatch& batch, const CTxDestination& dest, const std::string& key) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n     //! Adds a destination data tuple to the store, without saving it to disk\n-    void LoadDestData(const CTxDestination& dest, const std::string& key, const std::string& value) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n+    void LoadDestData(const CTxDestination& dest, const std::string& key, const std::string& value, bool is_change) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n     //! Look up a destination data tuple in the store, return true if found false otherwise\n     bool GetDestData(const CTxDestination& dest, const std::string& key, std::string* value) const EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n     //! Get all destination values matching a prefix."
      },
      {
        "sha": "51dfe7d311a5f7523b40ebd4d635ff47df44d7c5",
        "filename": "src/wallet/walletdb.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 1,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/72ff5515fbac691065b6882f16e7fad2fb1aa151/src/wallet/walletdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/72ff5515fbac691065b6882f16e7fad2fb1aa151/src/wallet/walletdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.cpp?ref=72ff5515fbac691065b6882f16e7fad2fb1aa151",
        "patch": "@@ -390,7 +390,7 @@ ReadKeyValue(CWallet* pwallet, CDataStream& ssKey, CDataStream& ssValue,\n             ssKey >> strAddress;\n             ssKey >> strKey;\n             ssValue >> strValue;\n-            pwallet->LoadDestData(DecodeDestination(strAddress), strKey, strValue);\n+            pwallet->LoadDestData(DecodeDestination(strAddress), strKey, strValue, (strType == DBKeys::CHANGEDATA));\n         } else if (strType == DBKeys::HDCHAIN) {\n             CHDChain chain;\n             ssValue >> chain;\n@@ -538,6 +538,8 @@ DBErrors WalletBatch::LoadWallet(CWallet* pwallet)\n     if (wss.fAnyUnordered)\n         result = pwallet->ReorderTransactions();\n \n+    pwallet->FixAddressBook(*this);\n+\n     // Upgrade all of the wallet keymetadata to have the hd master key id\n     // This operation is not atomic, but if it fails, updated entries are still backwards compatible with older software\n     try {"
      }
    ]
  }
]