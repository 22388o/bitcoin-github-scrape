[
  {
    "sha": "4df3d139b7261de33c070691f76a535b8b17433a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0ZGYzZDEzOWI3MjYxZGUzM2MwNzA2OTFmNzZhNTM1YjhiMTc0MzNh",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-01-29T15:36:23Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "Add a wtxid-index to the mempool",
      "tree": {
        "sha": "5f69c9ef206c659012770ffb0758d3b63d041b03",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5f69c9ef206c659012770ffb0758d3b63d041b03"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4df3d139b7261de33c070691f76a535b8b17433a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4df3d139b7261de33c070691f76a535b8b17433a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/4df3d139b7261de33c070691f76a535b8b17433a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4df3d139b7261de33c070691f76a535b8b17433a/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "80aa83aa406447d9b0932301b37966a30d0e1b6e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/80aa83aa406447d9b0932301b37966a30d0e1b6e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/80aa83aa406447d9b0932301b37966a30d0e1b6e"
      }
    ],
    "stats": {
      "total": 56,
      "additions": 44,
      "deletions": 12
    },
    "files": [
      {
        "sha": "8de225ba196df764bb5307db685fe55bdd387c4a",
        "filename": "src/txmempool.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 7,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4df3d139b7261de33c070691f76a535b8b17433a/src/txmempool.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4df3d139b7261de33c070691f76a535b8b17433a/src/txmempool.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txmempool.cpp?ref=4df3d139b7261de33c070691f76a535b8b17433a",
        "patch": "@@ -724,12 +724,12 @@ void CTxMemPool::check(const CCoinsViewCache *pcoins) const\n     assert(innerUsage == cachedInnerUsage);\n }\n \n-bool CTxMemPool::CompareDepthAndScore(const uint256& hasha, const uint256& hashb)\n+bool CTxMemPool::CompareDepthAndScore(const uint256& hasha, const uint256& hashb, bool wtxid)\n {\n     LOCK(cs);\n-    indexed_transaction_set::const_iterator i = mapTx.find(hasha);\n+    indexed_transaction_set::const_iterator i = wtxid ? get_iter_from_wtxid(hasha) : mapTx.find(hasha);\n     if (i == mapTx.end()) return false;\n-    indexed_transaction_set::const_iterator j = mapTx.find(hashb);\n+    indexed_transaction_set::const_iterator j = wtxid ? get_iter_from_wtxid(hashb) : mapTx.find(hashb);\n     if (j == mapTx.end()) return true;\n     uint64_t counta = i->GetCountWithAncestors();\n     uint64_t countb = j->GetCountWithAncestors();\n@@ -809,10 +809,10 @@ CTransactionRef CTxMemPool::get(const uint256& hash) const\n     return i->GetSharedTx();\n }\n \n-TxMempoolInfo CTxMemPool::info(const uint256& hash) const\n+TxMempoolInfo CTxMemPool::info(const uint256& hash, bool wtxid) const\n {\n     LOCK(cs);\n-    indexed_transaction_set::const_iterator i = mapTx.find(hash);\n+    indexed_transaction_set::const_iterator i = (wtxid ? get_iter_from_wtxid(hash) : mapTx.find(hash));\n     if (i == mapTx.end())\n         return TxMempoolInfo();\n     return GetInfo(i);\n@@ -915,8 +915,8 @@ bool CCoinsViewMemPool::GetCoin(const COutPoint &outpoint, Coin &coin) const {\n \n size_t CTxMemPool::DynamicMemoryUsage() const {\n     LOCK(cs);\n-    // Estimate the overhead of mapTx to be 12 pointers + an allocation, as no exact formula for boost::multi_index_contained is implemented.\n-    return memusage::MallocUsage(sizeof(CTxMemPoolEntry) + 12 * sizeof(void*)) * mapTx.size() + memusage::DynamicUsage(mapNextTx) + memusage::DynamicUsage(mapDeltas) + memusage::DynamicUsage(mapLinks) + memusage::DynamicUsage(vTxHashes) + cachedInnerUsage;\n+    // Estimate the overhead of mapTx to be 15 pointers + an allocation, as no exact formula for boost::multi_index_contained is implemented.\n+    return memusage::MallocUsage(sizeof(CTxMemPoolEntry) + 15 * sizeof(void*)) * mapTx.size() + memusage::DynamicUsage(mapNextTx) + memusage::DynamicUsage(mapDeltas) + memusage::DynamicUsage(mapLinks) + memusage::DynamicUsage(vTxHashes) + cachedInnerUsage;\n }\n \n void CTxMemPool::RemoveStaged(setEntries &stage, bool updateDescendants, MemPoolRemovalReason reason) {"
      },
      {
        "sha": "40986f13a3df6d036f8e6a55db0099889b76fd25",
        "filename": "src/txmempool.h",
        "status": "modified",
        "additions": 37,
        "deletions": 5,
        "changes": 42,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4df3d139b7261de33c070691f76a535b8b17433a/src/txmempool.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4df3d139b7261de33c070691f76a535b8b17433a/src/txmempool.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txmempool.h?ref=4df3d139b7261de33c070691f76a535b8b17433a",
        "patch": "@@ -198,6 +198,22 @@ struct mempoolentry_txid\n     }\n };\n \n+// extracts a transaction witness-hash from CTxMemPoolEntry or CTransactionRef\n+struct mempoolentry_wtxid\n+{\n+    typedef uint256 result_type;\n+    result_type operator() (const CTxMemPoolEntry &entry) const\n+    {\n+        return entry.GetTx().GetWitnessHash();\n+    }\n+\n+    result_type operator() (const CTransactionRef& tx) const\n+    {\n+        return tx->GetWitnessHash();\n+    }\n+};\n+\n+\n /** \\class CompareTxMemPoolEntryByDescendantScore\n  *\n  *  Sort an entry by max(score/size of entry's tx, score/size with all descendants).\n@@ -318,6 +334,7 @@ class CompareTxMemPoolEntryByAncestorFee\n struct descendant_score {};\n struct entry_time {};\n struct ancestor_score {};\n+struct index_by_wtxid {};\n \n class CBlockPolicyEstimator;\n \n@@ -383,8 +400,9 @@ class SaltedTxidHasher\n  *\n  * CTxMemPool::mapTx, and CTxMemPoolEntry bookkeeping:\n  *\n- * mapTx is a boost::multi_index that sorts the mempool on 4 criteria:\n- * - transaction hash\n+ * mapTx is a boost::multi_index that sorts the mempool on 5 criteria:\n+ * - transaction hash (txid)\n+ * - witness-transaction hash (wtxid)\n  * - descendant feerate [we use max(feerate of tx, feerate of tx with all descendants)]\n  * - time in mempool\n  * - ancestor feerate [we use min(feerate of tx, feerate of tx with all unconfirmed ancestors)]\n@@ -469,6 +487,12 @@ class CTxMemPool\n         boost::multi_index::indexed_by<\n             // sorted by txid\n             boost::multi_index::hashed_unique<mempoolentry_txid, SaltedTxidHasher>,\n+            // sorted by wtxid\n+            boost::multi_index::hashed_unique<\n+                boost::multi_index::tag<index_by_wtxid>,\n+                mempoolentry_wtxid,\n+                SaltedTxidHasher\n+            >,\n             // sorted by fee rate\n             boost::multi_index::ordered_non_unique<\n                 boost::multi_index::tag<descendant_score>,\n@@ -583,7 +607,7 @@ class CTxMemPool\n \n     void clear();\n     void _clear() EXCLUSIVE_LOCKS_REQUIRED(cs); //lock free\n-    bool CompareDepthAndScore(const uint256& hasha, const uint256& hashb);\n+    bool CompareDepthAndScore(const uint256& hasha, const uint256& hashb, bool wtxid=false);\n     void queryHashes(std::vector<uint256>& vtxid) const;\n     bool isSpent(const COutPoint& outpoint) const;\n     unsigned int GetTransactionsUpdated() const;\n@@ -686,14 +710,22 @@ class CTxMemPool\n         return totalTxSize;\n     }\n \n-    bool exists(const uint256& hash) const\n+    bool exists(const uint256& hash, bool wtxid=false) const\n     {\n         LOCK(cs);\n+        if (wtxid) {\n+            return (mapTx.get<index_by_wtxid>().count(hash) != 0);\n+        }\n         return (mapTx.count(hash) != 0);\n     }\n \n     CTransactionRef get(const uint256& hash) const;\n-    TxMempoolInfo info(const uint256& hash) const;\n+    txiter get_iter_from_wtxid(const uint256& wtxid) const EXCLUSIVE_LOCKS_REQUIRED(cs)\n+    {\n+        AssertLockHeld(cs);\n+        return mapTx.project<0>(mapTx.get<index_by_wtxid>().find(wtxid));\n+    }\n+    TxMempoolInfo info(const uint256& hash, bool wtxid=false) const;\n     std::vector<TxMempoolInfo> infoAll() const;\n \n     size_t DynamicMemoryUsage() const;"
      }
    ]
  },
  {
    "sha": "f7833b5bd894aca2d8820402f4a500d71374ea0e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmNzgzM2I1YmQ4OTRhY2EyZDg4MjA0MDJmNGE1MDBkNzEzNzRlYTBl",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-01-30T16:12:56Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "Just pass a hash to AddInventoryKnown\n\nSince it's only used for transactions, there's no need to pass in an inv type.",
      "tree": {
        "sha": "e669a2b85cd2daa48c547471cd7a966187c29fc4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e669a2b85cd2daa48c547471cd7a966187c29fc4"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f7833b5bd894aca2d8820402f4a500d71374ea0e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f7833b5bd894aca2d8820402f4a500d71374ea0e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/f7833b5bd894aca2d8820402f4a500d71374ea0e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f7833b5bd894aca2d8820402f4a500d71374ea0e/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "4df3d139b7261de33c070691f76a535b8b17433a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4df3d139b7261de33c070691f76a535b8b17433a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/4df3d139b7261de33c070691f76a535b8b17433a"
      }
    ],
    "stats": {
      "total": 22,
      "additions": 11,
      "deletions": 11
    },
    "files": [
      {
        "sha": "ce8cbe947d7929f6030a931eb49760012474f22e",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f7833b5bd894aca2d8820402f4a500d71374ea0e/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f7833b5bd894aca2d8820402f4a500d71374ea0e/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=f7833b5bd894aca2d8820402f4a500d71374ea0e",
        "patch": "@@ -969,11 +969,11 @@ class CNode\n     }\n \n \n-    void AddInventoryKnown(const CInv& inv)\n+    void AddInventoryKnown(const uint256& hash)\n     {\n         if (m_tx_relay != nullptr) {\n             LOCK(m_tx_relay->cs_tx_inventory);\n-            m_tx_relay->filterInventoryKnown.insert(inv.hash);\n+            m_tx_relay->filterInventoryKnown.insert(hash);\n         }\n     }\n "
      },
      {
        "sha": "3e050bbe4cc9904f99e6dd51e1fdca6ade94ace7",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 9,
        "changes": 18,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f7833b5bd894aca2d8820402f4a500d71374ea0e/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f7833b5bd894aca2d8820402f4a500d71374ea0e/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=f7833b5bd894aca2d8820402f4a500d71374ea0e",
        "patch": "@@ -2293,7 +2293,7 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n                     best_block = &inv.hash;\n                 }\n             } else {\n-                pfrom->AddInventoryKnown(inv);\n+                pfrom->AddInventoryKnown(inv.hash);\n                 if (fBlocksOnly) {\n                     LogPrint(BCLog::NET, \"transaction (%s) inv sent in violation of protocol, disconnecting peer=%d\\n\", inv.hash.ToString(), pfrom->GetId());\n                     pfrom->fDisconnect = true;\n@@ -2532,26 +2532,26 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n         vRecv >> ptx;\n         const CTransaction& tx = *ptx;\n \n-        CInv inv(MSG_TX, tx.GetHash());\n-        pfrom->AddInventoryKnown(inv);\n+        const uint256& txid = ptx->GetHash();\n+        pfrom->AddInventoryKnown(txid);\n \n         LOCK2(cs_main, g_cs_orphans);\n \n         TxValidationState state;\n \n         CNodeState* nodestate = State(pfrom->GetId());\n-        nodestate->m_tx_download.m_tx_announced.erase(inv.hash);\n-        nodestate->m_tx_download.m_tx_in_flight.erase(inv.hash);\n-        EraseTxRequest(inv.hash);\n+        nodestate->m_tx_download.m_tx_announced.erase(txid);\n+        nodestate->m_tx_download.m_tx_in_flight.erase(txid);\n+        EraseTxRequest(txid);\n \n         std::list<CTransactionRef> lRemovedTxn;\n \n-        if (!AlreadyHave(inv, mempool) &&\n+        if (!AlreadyHave(CInv(MSG_TX, txid), mempool) &&\n             AcceptToMemoryPool(mempool, state, ptx, &lRemovedTxn, false /* bypass_limits */, 0 /* nAbsurdFee */)) {\n             mempool.check(&::ChainstateActive().CoinsTip());\n             RelayTransaction(tx.GetHash(), *connman);\n             for (unsigned int i = 0; i < tx.vout.size(); i++) {\n-                auto it_by_prev = mapOrphanTransactionsByPrev.find(COutPoint(inv.hash, i));\n+                auto it_by_prev = mapOrphanTransactionsByPrev.find(COutPoint(txid, i));\n                 if (it_by_prev != mapOrphanTransactionsByPrev.end()) {\n                     for (const auto& elem : it_by_prev->second) {\n                         pfrom->orphan_work_set.insert(elem->first);\n@@ -2584,7 +2584,7 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n \n                 for (const CTxIn& txin : tx.vin) {\n                     CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                    pfrom->AddInventoryKnown(_inv);\n+                    pfrom->AddInventoryKnown(txin.prevout.hash);\n                     if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom->GetId()), _inv.hash, current_time);\n                 }\n                 AddOrphanTx(ptx, pfrom->GetId());"
      }
    ]
  },
  {
    "sha": "36549376740d28159a5834ecf4ed9eeeeef6715d",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozNjU0OTM3Njc0MGQyODE1OWE1ODM0ZWNmNGVkOWVlZWVlZjY3MTVk",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-01-29T15:40:54Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "Add a wtxid-index to mapRelay",
      "tree": {
        "sha": "410fcd97494c92e7f66f37efb4a75aefeef621d3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/410fcd97494c92e7f66f37efb4a75aefeef621d3"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/36549376740d28159a5834ecf4ed9eeeeef6715d",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/36549376740d28159a5834ecf4ed9eeeeef6715d",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/36549376740d28159a5834ecf4ed9eeeeef6715d",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/36549376740d28159a5834ecf4ed9eeeeef6715d/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f7833b5bd894aca2d8820402f4a500d71374ea0e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f7833b5bd894aca2d8820402f4a500d71374ea0e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f7833b5bd894aca2d8820402f4a500d71374ea0e"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 5,
      "deletions": 0
    },
    "files": [
      {
        "sha": "b6822d93032cbce2d091475f557f226898fb82ac",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/36549376740d28159a5834ecf4ed9eeeeef6715d/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/36549376740d28159a5834ecf4ed9eeeeef6715d/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=36549376740d28159a5834ecf4ed9eeeeef6715d",
        "patch": "@@ -3932,6 +3932,11 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                             if (ret.second) {\n                                 vRelayExpiration.push_back(std::make_pair(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret.first));\n                             }\n+                            // Add wtxid-based lookup into mapRelay as well, so that peers can request by wtxid\n+                            auto ret2 = mapRelay.emplace(ret.first->second->GetWitnessHash(), ret.first->second);\n+                            if (ret2.second) {\n+                                vRelayExpiration.emplace_back(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret2.first);\n+                            }\n                         }\n                         if (vInv.size() == MAX_INV_SZ) {\n                             connman->PushMessage(pto, msgMaker.Make(NetMsgType::INV, vInv));"
      }
    ]
  },
  {
    "sha": "606755b840b1560e4f92c9252fa4cab6eacabdd3",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2MDY3NTViODQwYjE1NjBlNGY5MmM5MjUyZmE0Y2FiNmVhY2FiZGQz",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-01-29T15:51:45Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "Add wtxid-index to orphan map",
      "tree": {
        "sha": "619f31f0aa1ea958a1297f13f4ca2125cbc51c31",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/619f31f0aa1ea958a1297f13f4ca2125cbc51c31"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/606755b840b1560e4f92c9252fa4cab6eacabdd3",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/606755b840b1560e4f92c9252fa4cab6eacabdd3",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/606755b840b1560e4f92c9252fa4cab6eacabdd3",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/606755b840b1560e4f92c9252fa4cab6eacabdd3/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "36549376740d28159a5834ecf4ed9eeeeef6715d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/36549376740d28159a5834ecf4ed9eeeeef6715d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/36549376740d28159a5834ecf4ed9eeeeef6715d"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 5,
      "deletions": 0
    },
    "files": [
      {
        "sha": "c168531e3a7850be8319df14848e0b4ababf4173",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/606755b840b1560e4f92c9252fa4cab6eacabdd3/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/606755b840b1560e4f92c9252fa4cab6eacabdd3/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=606755b840b1560e4f92c9252fa4cab6eacabdd3",
        "patch": "@@ -91,6 +91,7 @@ struct COrphanTx {\n };\n RecursiveMutex g_cs_orphans;\n std::map<uint256, COrphanTx> mapOrphanTransactions GUARDED_BY(g_cs_orphans);\n+std::map<uint256, std::map<uint256, COrphanTx>::iterator> g_orphans_by_wtxid GUARDED_BY(g_cs_orphans);\n \n void EraseOrphansFor(NodeId peer);\n \n@@ -868,6 +869,8 @@ bool AddOrphanTx(const CTransactionRef& tx, NodeId peer) EXCLUSIVE_LOCKS_REQUIRE\n     auto ret = mapOrphanTransactions.emplace(hash, COrphanTx{tx, peer, GetTime() + ORPHAN_TX_EXPIRE_TIME, g_orphan_list.size()});\n     assert(ret.second);\n     g_orphan_list.push_back(ret.first);\n+    // Allow for lookups in the orphan pool by wtxid, as well as txid\n+    g_orphans_by_wtxid.emplace(tx->GetWitnessHash(), ret.first);\n     for (const CTxIn& txin : tx->vin) {\n         mapOrphanTransactionsByPrev[txin.prevout].insert(ret.first);\n     }\n@@ -904,6 +907,7 @@ int static EraseOrphanTx(uint256 hash) EXCLUSIVE_LOCKS_REQUIRED(g_cs_orphans)\n         it_last->second.list_pos = old_pos;\n     }\n     g_orphan_list.pop_back();\n+    g_orphans_by_wtxid.erase(it->second.tx->GetWitnessHash());\n \n     mapOrphanTransactions.erase(it);\n     return 1;\n@@ -4139,6 +4143,7 @@ class CNetProcessingCleanup\n         // orphan transactions\n         mapOrphanTransactions.clear();\n         mapOrphanTransactionsByPrev.clear();\n+        g_orphans_by_wtxid.clear();\n     }\n };\n static CNetProcessingCleanup instance_of_cnetprocessingcleanup;"
      }
    ]
  },
  {
    "sha": "73845211d16ad1558d84c966ae18e3507fa7dea6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3Mzg0NTIxMWQxNmFkMTU1OGQ4NGM5NjZhZTE4ZTM1MDdmYTdkZWE2",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-01-29T15:57:08Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "Add wtxids of confirmed transactions to bloom filter\n\nThis is in preparation for wtxid-based invs (we need to be able to tell whether\nwe AlreadyHave() a transaction based on either txid or wtxid).\n\nThis also double the size of the bloom filter, which is overkill, but still\nuses a manageable amount of memory.",
      "tree": {
        "sha": "238a6c20f9dff5b33fe75dcc8cd841893ffd48b3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/238a6c20f9dff5b33fe75dcc8cd841893ffd48b3"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/73845211d16ad1558d84c966ae18e3507fa7dea6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/73845211d16ad1558d84c966ae18e3507fa7dea6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/73845211d16ad1558d84c966ae18e3507fa7dea6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/73845211d16ad1558d84c966ae18e3507fa7dea6/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "606755b840b1560e4f92c9252fa4cab6eacabdd3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/606755b840b1560e4f92c9252fa4cab6eacabdd3",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/606755b840b1560e4f92c9252fa4cab6eacabdd3"
      }
    ],
    "stats": {
      "total": 8,
      "additions": 6,
      "deletions": 2
    },
    "files": [
      {
        "sha": "ea502ff2f7567cad90460fa7deefc2f5bc4ef929",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 2,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/73845211d16ad1558d84c966ae18e3507fa7dea6/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/73845211d16ad1558d84c966ae18e3507fa7dea6/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=73845211d16ad1558d84c966ae18e3507fa7dea6",
        "patch": "@@ -1117,14 +1117,15 @@ PeerLogicValidation::PeerLogicValidation(CConnman* connmanIn, BanMan* banman, CS\n     recentRejects.reset(new CRollingBloomFilter(120000, 0.000001));\n \n     // Blocks don't typically have more than 4000 transactions, so this should\n-    // be at least six blocks (~1 hr) worth of transactions that we can store.\n+    // be at least six blocks (~1 hr) worth of transactions that we can store,\n+    // inserting both a txid and wtxid for every observed transaction.\n     // If the number of transactions appearing in a block goes up, or if we are\n     // seeing getdata requests more than an hour after initial announcement, we\n     // can increase this number.\n     // The false positive rate of 1/1M should come out to less than 1\n     // transaction per day that would be inadvertently ignored (which is the\n     // same probability that we have in the reject filter).\n-    g_recent_confirmed_transactions.reset(new CRollingBloomFilter(24000, 0.000001));\n+    g_recent_confirmed_transactions.reset(new CRollingBloomFilter(48000, 0.000001));\n \n     const Consensus::Params& consensusParams = Params().GetConsensus();\n     // Stale tip checking and peer eviction are on two different timers, but we\n@@ -1176,6 +1177,9 @@ void PeerLogicValidation::BlockConnected(const std::shared_ptr<const CBlock>& pb\n         LOCK(g_cs_recent_confirmed_transactions);\n         for (const auto& ptx : pblock->vtx) {\n             g_recent_confirmed_transactions->insert(ptx->GetHash());\n+            if (ptx->GetHash() != ptx->GetWitnessHash()) {\n+                g_recent_confirmed_transactions->insert(ptx->GetWitnessHash());\n+            }\n         }\n     }\n }"
      }
    ]
  },
  {
    "sha": "be1b7a8916fdd060db56846ad5dcec0894aae314",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiZTFiN2E4OTE2ZmRkMDYwZGI1Njg0NmFkNWRjZWMwODk0YWFlMzE0",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-01-29T19:09:08Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "Add wtxids to recentRejects\n\nPreviously, we only added txids to recentRejects if we were sure that the\ntransaction couldn't have had the wrong witness (either because the witness was\nmalleated or stripped).\n\nIn preparation for wtxid-based relay, we can observe that txid == wtxid for\ntransactions that have no witness, and add the wtxid of rejected transactions,\nprovided the transaction wasn't a witness-stripped one. This means that we now\nadd more data to the filter (as prior to this commit, any transaction with a\nwitness that failed to be accepted was being skipped for inclusion in the\nfilter) but witness malleation should still not interfere with relay of a valid\nsegwit transaction, because the txid of a segwit transaction would not be added\nto the filter after failing validation.\n\nIn the future, having wtxids in the recent rejects filter will allow us to\nskip downloading the same wtxid multiple times, once our peers use wtxids for\ntransaction relay.\n\nAlso add the txid to recentRejects if the transaction failed for\nTX_INPUTS_NOT_STANDARD.",
      "tree": {
        "sha": "1c217bfb7a682a1fc080a8e4be9cc9973dbdf814",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1c217bfb7a682a1fc080a8e4be9cc9973dbdf814"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/be1b7a8916fdd060db56846ad5dcec0894aae314",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/be1b7a8916fdd060db56846ad5dcec0894aae314",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/be1b7a8916fdd060db56846ad5dcec0894aae314",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/be1b7a8916fdd060db56846ad5dcec0894aae314/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "73845211d16ad1558d84c966ae18e3507fa7dea6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/73845211d16ad1558d84c966ae18e3507fa7dea6",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/73845211d16ad1558d84c966ae18e3507fa7dea6"
      }
    ],
    "stats": {
      "total": 67,
      "additions": 51,
      "deletions": 16
    },
    "files": [
      {
        "sha": "f8b0f98e236a4d70e3a0a04118e5c52b038017f6",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 51,
        "deletions": 16,
        "changes": 67,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/be1b7a8916fdd060db56846ad5dcec0894aae314/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/be1b7a8916fdd060db56846ad5dcec0894aae314/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=be1b7a8916fdd060db56846ad5dcec0894aae314",
        "patch": "@@ -1910,17 +1910,35 @@ void static ProcessOrphanTx(CConnman* connman, CTxMemPool& mempool, std::set<uin\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if ((!orphanTx.HasWitness() && orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) ||\n-                    orphan_state.GetResult() == TxValidationResult::TX_INPUTS_NOT_STANDARD) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n-                // However, if the transaction failed for TX_INPUTS_NOT_STANDARD,\n+            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n+                // We can add the wtxid of this transaction to our reject filter.\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness stripped transactions) once\n+                // wtxid-based relay is broadly deployed.\n+                // See also comments in https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443419034\n+                // for concerns around weakening security of unupgraded nodes\n+                // if we start doing this too early.\n+                assert(recentRejects);\n+                recentRejects->insert(orphanTx.GetWitnessHash());\n+                // If the transaction failed for TX_INPUTS_NOT_STANDARD,\n                 // then we know that the witness was irrelevant to the policy\n                 // failure, since this check depends only on the txid\n                 // (the scriptPubKey being spent is covered by the txid).\n-                assert(recentRejects);\n-                recentRejects->insert(orphanHash);\n+                // Add the txid to the reject filter to prevent repeated\n+                // processing of this transaction in the event that child\n+                // transactions are later received (resulting in\n+                // parent-fetching by txid via the orphan-handling logic).\n+                if (orphan_state.GetResult() == TxValidationResult::TX_INPUTS_NOT_STANDARD && orphanTx.GetWitnessHash() != orphanTx.GetHash()) {\n+                    // We only add the txid if it differs from the wtxid, to\n+                    // avoid wasting entries in the rolling bloom filter.\n+                    recentRejects->insert(orphanTx.GetHash());\n+                }\n             }\n             EraseOrphanTx(orphanHash);\n             done = true;\n@@ -2608,19 +2626,36 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n                 recentRejects->insert(tx.GetHash());\n+                recentRejects->insert(tx.GetWitnessHash());\n             }\n         } else {\n-            if ((!tx.HasWitness() && state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) ||\n-                    state.GetResult() == TxValidationResult::TX_INPUTS_NOT_STANDARD) {\n-                // Do not use rejection cache for witness transactions or\n-                // witness-stripped transactions, as they can have been malleated.\n-                // See https://github.com/bitcoin/bitcoin/issues/8279 for details.\n-                // However, if the transaction failed for TX_INPUTS_NOT_STANDARD,\n+            if (tx.HasWitness() || state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n+                // We can add the wtxid of this transaction to our reject filter.\n+                // Do not add txids of witness transactions or witness-stripped\n+                // transactions to the filter, as they can have been malleated;\n+                // adding such txids to the reject filter would potentially\n+                // interfere with relay of valid transactions from peers that\n+                // do not support wtxid-based relay. See\n+                // https://github.com/bitcoin/bitcoin/issues/8279 for details.\n+                // We can remove this restriction (and always add wtxids to\n+                // the filter even for witness stripped transactions) once\n+                // wtxid-based relay is broadly deployed.\n+                // See also comments in https://github.com/bitcoin/bitcoin/pull/18044#discussion_r443419034\n+                // for concerns around weakening security of unupgraded nodes\n+                // if we start doing this too early.\n+                assert(recentRejects);\n+                recentRejects->insert(tx.GetWitnessHash());\n+                // If the transaction failed for TX_INPUTS_NOT_STANDARD,\n                 // then we know that the witness was irrelevant to the policy\n                 // failure, since this check depends only on the txid\n                 // (the scriptPubKey being spent is covered by the txid).\n-                assert(recentRejects);\n-                recentRejects->insert(tx.GetHash());\n+                // Add the txid to the reject filter to prevent repeated\n+                // processing of this transaction in the event that child\n+                // transactions are later received (resulting in\n+                // parent-fetching by txid via the orphan-handling logic).\n+                if (state.GetResult() == TxValidationResult::TX_INPUTS_NOT_STANDARD && tx.GetWitnessHash() != tx.GetHash()) {\n+                    recentRejects->insert(tx.GetHash());\n+                }\n                 if (RecursiveDynamicUsage(*ptx) < 100000) {\n                     AddToCompactExtraTransactions(ptx);\n                 }"
      }
    ]
  },
  {
    "sha": "2599277e9cb51e3619582978cba9bf03325c0cb6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyNTk5Mjc3ZTljYjUxZTM2MTk1ODI5NzhjYmE5YmYwMzMyNWMwY2I2",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-01-30T14:35:00Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "Add support for tx-relay via wtxid\n\nThis adds a field to CNodeState that tracks whether to relay transactions with\nthat peer via wtxid, instead of txid. As of this commit the field will always\nbe false, but in a later commit we will add a way to negotiate turning this on\nvia p2p messages exchanged with the peer.",
      "tree": {
        "sha": "2ed20411f76e653b71c44d88c2ebf49d15af9100",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2ed20411f76e653b71c44d88c2ebf49d15af9100"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2599277e9cb51e3619582978cba9bf03325c0cb6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2599277e9cb51e3619582978cba9bf03325c0cb6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/2599277e9cb51e3619582978cba9bf03325c0cb6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2599277e9cb51e3619582978cba9bf03325c0cb6/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "be1b7a8916fdd060db56846ad5dcec0894aae314",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/be1b7a8916fdd060db56846ad5dcec0894aae314",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/be1b7a8916fdd060db56846ad5dcec0894aae314"
      }
    ],
    "stats": {
      "total": 137,
      "additions": 98,
      "deletions": 39
    },
    "files": [
      {
        "sha": "106f061d03b12ef833c31cccd72b4ed0af4ff3db",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 90,
        "deletions": 34,
        "changes": 124,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2599277e9cb51e3619582978cba9bf03325c0cb6/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2599277e9cb51e3619582978cba9bf03325c0cb6/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=2599277e9cb51e3619582978cba9bf03325c0cb6",
        "patch": "@@ -362,6 +362,9 @@ struct CNodeState {\n     //! Whether this peer is a manual connection\n     bool m_is_manual_connection;\n \n+    //! Whether this peer relays txs via wtxid\n+    bool m_wtxid_relay{false};\n+\n     CNodeState(CAddress addrIn, std::string addrNameIn, bool is_inbound, bool is_manual) :\n         address(addrIn), name(std::move(addrNameIn)), m_is_inbound(is_inbound),\n         m_is_manual_connection (is_manual)\n@@ -1332,6 +1335,7 @@ bool static AlreadyHave(const CInv& inv, const CTxMemPool& mempool) EXCLUSIVE_LO\n     {\n     case MSG_TX:\n     case MSG_WITNESS_TX:\n+    case MSG_WTX:\n         {\n             assert(recentRejects);\n             if (::ChainActive().Tip()->GetBlockHash() != hashRecentRejectsChainTip)\n@@ -1346,16 +1350,20 @@ bool static AlreadyHave(const CInv& inv, const CTxMemPool& mempool) EXCLUSIVE_LO\n \n             {\n                 LOCK(g_cs_orphans);\n-                if (mapOrphanTransactions.count(inv.hash)) return true;\n+                if (inv.type != MSG_WTX && mapOrphanTransactions.count(inv.hash)) {\n+                    return true;\n+                } else if (inv.type == MSG_WTX && g_orphans_by_wtxid.count(inv.hash)) {\n+                    return true;\n+                }\n             }\n \n             {\n                 LOCK(g_cs_recent_confirmed_transactions);\n                 if (g_recent_confirmed_transactions->contains(inv.hash)) return true;\n             }\n \n-            return recentRejects->contains(inv.hash) ||\n-                   mempool.exists(inv.hash);\n+            const bool by_wtxid = (inv.type == MSG_WTX);\n+            return recentRejects->contains(inv.hash) || mempool.exists(inv.hash, by_wtxid);\n         }\n     case MSG_BLOCK:\n     case MSG_WITNESS_BLOCK:\n@@ -1365,12 +1373,17 @@ bool static AlreadyHave(const CInv& inv, const CTxMemPool& mempool) EXCLUSIVE_LO\n     return true;\n }\n \n-void RelayTransaction(const uint256& txid, const CConnman& connman)\n+void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman)\n {\n-    CInv inv(MSG_TX, txid);\n-    connman.ForEachNode([&inv](CNode* pnode)\n+    connman.ForEachNode([&txid, &wtxid](CNode* pnode)\n     {\n-        pnode->PushInventory(inv);\n+        AssertLockHeld(cs_main);\n+        CNodeState &state = *State(pnode->GetId());\n+        if (state.m_wtxid_relay) {\n+            pnode->PushInventory({MSG_TX, wtxid});  // inv type is MSG_TX even for wtxid relay\n+        } else {\n+            pnode->PushInventory({MSG_TX, txid});\n+        }\n     });\n }\n \n@@ -1585,7 +1598,7 @@ void static ProcessGetData(CNode* pfrom, const CChainParams& chainparams, CConnm\n         // Process as many TX items from the front of the getdata queue as\n         // possible, since they're common and it's efficient to batch process\n         // them.\n-        while (it != pfrom->vRecvGetData.end() && (it->type == MSG_TX || it->type == MSG_WITNESS_TX)) {\n+        while (it != pfrom->vRecvGetData.end() && (it->type == MSG_TX || it->type == MSG_WITNESS_TX || it->type == MSG_WTX)) {\n             if (interruptMsgProc)\n                 return;\n             // The send buffer provides backpressure. If there's no space in\n@@ -1608,7 +1621,7 @@ void static ProcessGetData(CNode* pfrom, const CChainParams& chainparams, CConnm\n                 connman->PushMessage(pfrom, msgMaker.Make(nSendFlags, NetMsgType::TX, *mi->second));\n                 push = true;\n             } else {\n-                auto txinfo = mempool.info(inv.hash);\n+                auto txinfo = mempool.info(inv.hash, inv.type == MSG_WTX);\n                 // To protect privacy, do not answer getdata using the mempool when\n                 // that TX couldn't have been INVed in reply to a MEMPOOL request,\n                 // or when it's too recent to have expired from mapRelay.\n@@ -1888,7 +1901,7 @@ void static ProcessOrphanTx(CConnman* connman, CTxMemPool& mempool, std::set<uin\n         if (setMisbehaving.count(fromPeer)) continue;\n         if (AcceptToMemoryPool(mempool, orphan_state, porphanTx, &removed_txn, false /* bypass_limits */, 0 /* nAbsurdFee */)) {\n             LogPrint(BCLog::MEMPOOL, \"   accepted orphan tx %s\\n\", orphanHash.ToString());\n-            RelayTransaction(orphanHash, *connman);\n+            RelayTransaction(orphanHash, porphanTx->GetWitnessHash(), *connman);\n             for (unsigned int i = 0; i < orphanTx.vout.size(); i++) {\n                 auto it_by_prev = mapOrphanTransactionsByPrev.find(COutPoint(orphanHash, i));\n                 if (it_by_prev != mapOrphanTransactionsByPrev.end()) {\n@@ -2559,23 +2572,47 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n         const CTransaction& tx = *ptx;\n \n         const uint256& txid = ptx->GetHash();\n-        pfrom->AddInventoryKnown(txid);\n+        const uint256& wtxid = ptx->GetWitnessHash();\n \n         LOCK2(cs_main, g_cs_orphans);\n \n+        CNodeState* nodestate = State(pfrom->GetId());\n+\n+        const uint256& hash = nodestate->m_wtxid_relay ? wtxid : txid;\n+        pfrom->AddInventoryKnown(hash);\n+        if (nodestate->m_wtxid_relay && txid != wtxid) {\n+            // Insert txid into filterInventoryKnown, even for\n+            // wtxidrelay peers. This prevents re-adding of\n+            // unconfirmed parents to the recently_announced\n+            // filter, when a child tx is requested. See\n+            // ProcessGetData().\n+            pfrom->AddInventoryKnown(txid);\n+        }\n+\n         TxValidationState state;\n \n-        CNodeState* nodestate = State(pfrom->GetId());\n-        nodestate->m_tx_download.m_tx_announced.erase(txid);\n-        nodestate->m_tx_download.m_tx_in_flight.erase(txid);\n-        EraseTxRequest(txid);\n+        nodestate->m_tx_download.m_tx_announced.erase(hash);\n+        nodestate->m_tx_download.m_tx_in_flight.erase(hash);\n+        EraseTxRequest(hash);\n \n         std::list<CTransactionRef> lRemovedTxn;\n \n-        if (!AlreadyHave(CInv(MSG_TX, txid), mempool) &&\n+        // We do the AlreadyHave() check using wtxid, rather than txid - in the\n+        // absence of witness malleation, this is strictly better, because the\n+        // recent rejects filter may contain the wtxid but will never contain\n+        // the txid of a segwit transaction that has been rejected.\n+        // In the presence of witness malleation, it's possible that by only\n+        // doing the check with wtxid, we could overlook a transaction which\n+        // was confirmed with a different witness, or exists in our mempool\n+        // with a different witness, but this has limited downside:\n+        // mempool validation does its own lookup of whether we have the txid\n+        // already; and an adversary can already relay us old transactions\n+        // (older than our recency filter) if trying to DoS us, without any need\n+        // for witness malleation.\n+        if (!AlreadyHave(CInv(MSG_WTX, wtxid), mempool) &&\n             AcceptToMemoryPool(mempool, state, ptx, &lRemovedTxn, false /* bypass_limits */, 0 /* nAbsurdFee */)) {\n             mempool.check(&::ChainstateActive().CoinsTip());\n-            RelayTransaction(tx.GetHash(), *connman);\n+            RelayTransaction(tx.GetHash(), tx.GetWitnessHash(), *connman);\n             for (unsigned int i = 0; i < tx.vout.size(); i++) {\n                 auto it_by_prev = mapOrphanTransactionsByPrev.find(COutPoint(txid, i));\n                 if (it_by_prev != mapOrphanTransactionsByPrev.end()) {\n@@ -2608,10 +2645,17 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                for (const CTxIn& txin : tx.vin) {\n-                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                    pfrom->AddInventoryKnown(txin.prevout.hash);\n-                    if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom->GetId()), _inv.hash, current_time);\n+                if (!State(pfrom->GetId())->m_wtxid_relay) {\n+                    for (const CTxIn& txin : tx.vin) {\n+                        // Here, we only have the txid (and not wtxid) of the\n+                        // inputs, so we only request parents from\n+                        // non-wtxid-relay peers.\n+                        // Eventually we should replace this with an improved\n+                        // protocol for getting all unconfirmed parents.\n+                        CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n+                        pfrom->AddInventoryKnown(txin.prevout.hash);\n+                        if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom->GetId()), _inv.hash, current_time);\n+                    }\n                 }\n                 AddOrphanTx(ptx, pfrom->GetId());\n \n@@ -2672,7 +2716,7 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n                     LogPrintf(\"Not relaying non-mempool transaction %s from whitelisted peer=%d\\n\", tx.GetHash().ToString(), pfrom->GetId());\n                 } else {\n                     LogPrintf(\"Force relaying tx %s from whitelisted peer=%d\\n\", tx.GetHash().ToString(), pfrom->GetId());\n-                    RelayTransaction(tx.GetHash(), *connman);\n+                    RelayTransaction(tx.GetHash(), tx.GetWitnessHash(), *connman);\n                 }\n             }\n         }\n@@ -3288,7 +3332,7 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n         vRecv >> vInv;\n         if (vInv.size() <= MAX_PEER_TX_IN_FLIGHT + MAX_BLOCKS_IN_TRANSIT_PER_PEER) {\n             for (CInv &inv : vInv) {\n-                if (inv.type == MSG_TX || inv.type == MSG_WITNESS_TX) {\n+                if (inv.type == MSG_TX || inv.type == MSG_WITNESS_TX || inv.type == MSG_WTX) {\n                     // If we receive a NOTFOUND message for a txid we requested, erase\n                     // it from our data structures for this peer.\n                     auto in_flight_it = state->m_tx_download.m_tx_in_flight.find(inv.hash);\n@@ -3580,17 +3624,19 @@ namespace {\n class CompareInvMempoolOrder\n {\n     CTxMemPool *mp;\n+    bool m_wtxid_relay;\n public:\n-    explicit CompareInvMempoolOrder(CTxMemPool *_mempool)\n+    explicit CompareInvMempoolOrder(CTxMemPool *_mempool, bool use_wtxid)\n     {\n         mp = _mempool;\n+        m_wtxid_relay = use_wtxid;\n     }\n \n     bool operator()(std::set<uint256>::iterator a, std::set<uint256>::iterator b)\n     {\n         /* As std::make_heap produces a max-heap, we want the entries with the\n          * fewest ancestors/highest fee to sort later. */\n-        return mp->CompareDepthAndScore(*b, *a);\n+        return mp->CompareDepthAndScore(*b, *a, m_wtxid_relay);\n     }\n };\n }\n@@ -3897,8 +3943,8 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                     LOCK(pto->m_tx_relay->cs_filter);\n \n                     for (const auto& txinfo : vtxinfo) {\n-                        const uint256& hash = txinfo.tx->GetHash();\n-                        CInv inv(MSG_TX, hash);\n+                        const uint256& hash = state.m_wtxid_relay ? txinfo.tx->GetWitnessHash() : txinfo.tx->GetHash();\n+                        CInv inv(state.m_wtxid_relay ? MSG_WTX : MSG_TX, hash);\n                         pto->m_tx_relay->setInventoryTxToSend.erase(hash);\n                         // Don't send transactions that peers will not put into their mempool\n                         if (txinfo.fee < filterrate.GetFee(txinfo.vsize)) {\n@@ -3932,7 +3978,7 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                     }\n                     // Topologically and fee-rate sort the inventory we send for privacy and priority reasons.\n                     // A heap is used so that not all items need sorting if only a few are being sent.\n-                    CompareInvMempoolOrder compareInvMempoolOrder(&m_mempool);\n+                    CompareInvMempoolOrder compareInvMempoolOrder(&m_mempool, state.m_wtxid_relay);\n                     std::make_heap(vInvTx.begin(), vInvTx.end(), compareInvMempoolOrder);\n                     // No reason to drain out at many times the network's capacity,\n                     // especially since we have many peers and some will draw much shorter delays.\n@@ -3951,17 +3997,19 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                             continue;\n                         }\n                         // Not in the mempool anymore? don't bother sending it.\n-                        auto txinfo = m_mempool.info(hash);\n+                        auto txinfo = m_mempool.info(hash, state.m_wtxid_relay);\n                         if (!txinfo.tx) {\n                             continue;\n                         }\n+                        auto txid = txinfo.tx->GetHash();\n+                        auto wtxid = txinfo.tx->GetWitnessHash();\n                         // Peer told you to not send transactions at that feerate? Don't bother sending it.\n                         if (txinfo.fee < filterrate.GetFee(txinfo.vsize)) {\n                             continue;\n                         }\n                         if (pto->m_tx_relay->pfilter && !pto->m_tx_relay->pfilter->IsRelevantAndUpdate(*txinfo.tx)) continue;\n                         // Send\n-                        vInv.push_back(CInv(MSG_TX, hash));\n+                        vInv.push_back(CInv(state.m_wtxid_relay ? MSG_WTX : MSG_TX, hash));\n                         nRelayedTransactions++;\n                         {\n                             // Expire old relay messages\n@@ -3971,12 +4019,12 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                                 vRelayExpiration.pop_front();\n                             }\n \n-                            auto ret = mapRelay.insert(std::make_pair(hash, std::move(txinfo.tx)));\n+                            auto ret = mapRelay.emplace(txid, std::move(txinfo.tx));\n                             if (ret.second) {\n-                                vRelayExpiration.push_back(std::make_pair(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret.first));\n+                                vRelayExpiration.emplace_back(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret.first);\n                             }\n                             // Add wtxid-based lookup into mapRelay as well, so that peers can request by wtxid\n-                            auto ret2 = mapRelay.emplace(ret.first->second->GetWitnessHash(), ret.first->second);\n+                            auto ret2 = mapRelay.emplace(wtxid, ret.first->second);\n                             if (ret2.second) {\n                                 vRelayExpiration.emplace_back(nNow + std::chrono::microseconds{RELAY_TX_CACHE_TIME}.count(), ret2.first);\n                             }\n@@ -3986,6 +4034,14 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                             vInv.clear();\n                         }\n                         pto->m_tx_relay->filterInventoryKnown.insert(hash);\n+                        if (hash != txid) {\n+                            // Insert txid into filterInventoryKnown, even for\n+                            // wtxidrelay peers. This prevents re-adding of\n+                            // unconfirmed parents to the recently_announced\n+                            // filter, when a child tx is requested. See\n+                            // ProcessGetData().\n+                            pto->m_tx_relay->filterInventoryKnown.insert(txid);\n+                        }\n                     }\n                 }\n             }\n@@ -4110,7 +4166,7 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n             // Erase this entry from tx_process_time (it may be added back for\n             // processing at a later time, see below)\n             tx_process_time.erase(tx_process_time.begin());\n-            CInv inv(MSG_TX | GetFetchFlags(pto), txid);\n+            CInv inv(state.m_wtxid_relay ? MSG_WTX : (MSG_TX | GetFetchFlags(pto)), txid);\n             if (!AlreadyHave(inv, m_mempool)) {\n                 // If this transaction was last requested more than 1 minute ago,\n                 // then request."
      },
      {
        "sha": "79a3ccd4ed7fac5533605335e72249db5cb55ac0",
        "filename": "src/net_processing.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2599277e9cb51e3619582978cba9bf03325c0cb6/src/net_processing.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2599277e9cb51e3619582978cba9bf03325c0cb6/src/net_processing.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.h?ref=2599277e9cb51e3619582978cba9bf03325c0cb6",
        "patch": "@@ -92,6 +92,6 @@ struct CNodeStateStats {\n bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats);\n \n /** Relay transaction to every node */\n-void RelayTransaction(const uint256&, const CConnman& connman);\n+void RelayTransaction(const uint256& txid, const uint256& wtxid, const CConnman& connman) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n #endif // BITCOIN_NET_PROCESSING_H"
      },
      {
        "sha": "17878eeb17101933a1a1cbd7ca0e1de723d3a58b",
        "filename": "src/node/transaction.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2599277e9cb51e3619582978cba9bf03325c0cb6/src/node/transaction.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2599277e9cb51e3619582978cba9bf03325c0cb6/src/node/transaction.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/node/transaction.cpp?ref=2599277e9cb51e3619582978cba9bf03325c0cb6",
        "patch": "@@ -78,7 +78,8 @@ TransactionError BroadcastTransaction(NodeContext& node, const CTransactionRef t\n     }\n \n     if (relay) {\n-        RelayTransaction(hashTx, *node.connman);\n+        LOCK(cs_main);\n+        RelayTransaction(hashTx, tx->GetWitnessHash(), *node.connman);\n     }\n \n     return TransactionError::OK;"
      },
      {
        "sha": "f5cf9e6de8879874238d39393c7bd4ef85ab4cdb",
        "filename": "src/protocol.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2599277e9cb51e3619582978cba9bf03325c0cb6/src/protocol.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2599277e9cb51e3619582978cba9bf03325c0cb6/src/protocol.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/protocol.cpp?ref=2599277e9cb51e3619582978cba9bf03325c0cb6",
        "patch": "@@ -183,6 +183,8 @@ std::string CInv::GetCommand() const\n     switch (masked)\n     {\n     case MSG_TX:             return cmd.append(NetMsgType::TX);\n+    // WTX is not a message type, just an inv type\n+    case MSG_WTX:            return cmd.append(\"wtx\");\n     case MSG_BLOCK:          return cmd.append(NetMsgType::BLOCK);\n     case MSG_FILTERED_BLOCK: return cmd.append(NetMsgType::MERKLEBLOCK);\n     case MSG_CMPCT_BLOCK:    return cmd.append(NetMsgType::CMPCTBLOCK);"
      },
      {
        "sha": "1d14585f9737b0f48bb2969eda219e011848e2c4",
        "filename": "src/protocol.h",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2599277e9cb51e3619582978cba9bf03325c0cb6/src/protocol.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2599277e9cb51e3619582978cba9bf03325c0cb6/src/protocol.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/protocol.h?ref=2599277e9cb51e3619582978cba9bf03325c0cb6",
        "patch": "@@ -362,11 +362,11 @@ const uint32_t MSG_TYPE_MASK    = 0xffffffff >> 2;\n  * These numbers are defined by the protocol. When adding a new value, be sure\n  * to mention it in the respective BIP.\n  */\n-enum GetDataMsg\n-{\n+enum GetDataMsg : uint32_t {\n     UNDEFINED = 0,\n     MSG_TX = 1,\n     MSG_BLOCK = 2,\n+    MSG_WTX = 5,                                      //!< Defined in BIP 339\n     // The following can only occur in getdata. Invs always use TX or BLOCK.\n     MSG_FILTERED_BLOCK = 3,  //!< Defined in BIP37\n     MSG_CMPCT_BLOCK = 4,     //!< Defined in BIP152"
      },
      {
        "sha": "f7255d1911062faba899ca04205d3730c7be700b",
        "filename": "test/functional/p2p_segwit.py",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2599277e9cb51e3619582978cba9bf03325c0cb6/test/functional/p2p_segwit.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2599277e9cb51e3619582978cba9bf03325c0cb6/test/functional/p2p_segwit.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_segwit.py?ref=2599277e9cb51e3619582978cba9bf03325c0cb6",
        "patch": "@@ -1296,7 +1296,7 @@ def test_tx_relay_after_segwit_activation(self):\n         self.std_node.announce_tx_and_wait_for_getdata(tx3)\n         test_transaction_acceptance(self.nodes[1], self.std_node, tx3, True, False, 'tx-size')\n         self.std_node.announce_tx_and_wait_for_getdata(tx3)\n-        test_transaction_acceptance(self.nodes[1], self.std_node, tx3, True, False, 'tx-size')\n+        test_transaction_acceptance(self.nodes[1], self.std_node, tx3, True, False)\n \n         # Remove witness stuffing, instead add extra witness push on stack\n         tx3.vout[0] = CTxOut(tx2.vout[0].nValue - 1000, CScript([OP_TRUE, OP_DROP] * 15 + [OP_TRUE]))"
      }
    ]
  },
  {
    "sha": "93826726e76730b061ec4c91d69b2b34ebf98ec9",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5MzgyNjcyNmU3NjczMGIwNjFlYzRjOTFkNjliMmIzNGViZjk4ZWM5",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2020-04-06T09:09:05Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "ignore non-wtxidrelay compliant invs",
      "tree": {
        "sha": "bfccd6faa19ff1eb730fc54e750e64ea616d482c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/bfccd6faa19ff1eb730fc54e750e64ea616d482c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/93826726e76730b061ec4c91d69b2b34ebf98ec9",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/93826726e76730b061ec4c91d69b2b34ebf98ec9",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/93826726e76730b061ec4c91d69b2b34ebf98ec9",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/93826726e76730b061ec4c91d69b2b34ebf98ec9/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "2599277e9cb51e3619582978cba9bf03325c0cb6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2599277e9cb51e3619582978cba9bf03325c0cb6",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/2599277e9cb51e3619582978cba9bf03325c0cb6"
      }
    ],
    "stats": {
      "total": 7,
      "additions": 7,
      "deletions": 0
    },
    "files": [
      {
        "sha": "50aea0fd0bb28e588b1bc3635003578955349257",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 0,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/93826726e76730b061ec4c91d69b2b34ebf98ec9/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/93826726e76730b061ec4c91d69b2b34ebf98ec9/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=93826726e76730b061ec4c91d69b2b34ebf98ec9",
        "patch": "@@ -2314,6 +2314,13 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n             if (interruptMsgProc)\n                 return true;\n \n+            // ignore INVs that don't match wtxidrelay setting\n+            if (State(pfrom->GetId())->m_wtxid_relay) {\n+                if (inv.type == MSG_TX) continue;\n+            } else {\n+                if (inv.type == MSG_WTX) continue;\n+            }\n+\n             bool fAlreadyHave = AlreadyHave(inv, mempool);\n             LogPrint(BCLog::NET, \"got inv: %s  %s peer=%d\\n\", inv.ToString(), fAlreadyHave ? \"have\" : \"new\", pfrom->GetId());\n "
      }
    ]
  },
  {
    "sha": "181ffadd162a84551b3518de77b5dcc08c712425",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxODFmZmFkZDE2MmE4NDU1MWIzNTE4ZGU3N2I1ZGNjMDhjNzEyNDI1",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-01-30T15:10:50Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "Add p2p message \"wtxidrelay\"\n\nWhen sent to and received from a given peer, enables using wtxid's for\nannouncing and fetching transactions with that peer.",
      "tree": {
        "sha": "67144b9e0b026b1e246cc01473954a612832e40d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/67144b9e0b026b1e246cc01473954a612832e40d"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/181ffadd162a84551b3518de77b5dcc08c712425",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/181ffadd162a84551b3518de77b5dcc08c712425",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/181ffadd162a84551b3518de77b5dcc08c712425",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/181ffadd162a84551b3518de77b5dcc08c712425/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "93826726e76730b061ec4c91d69b2b34ebf98ec9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/93826726e76730b061ec4c91d69b2b34ebf98ec9",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/93826726e76730b061ec4c91d69b2b34ebf98ec9"
      }
    ],
    "stats": {
      "total": 31,
      "additions": 29,
      "deletions": 2
    },
    "files": [
      {
        "sha": "835095f4d016887078e18be2ac9619ab40fd8f99",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 16,
        "deletions": 0,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/181ffadd162a84551b3518de77b5dcc08c712425/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/181ffadd162a84551b3518de77b5dcc08c712425/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=181ffadd162a84551b3518de77b5dcc08c712425",
        "patch": "@@ -2055,6 +2055,10 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n         if (pfrom->fInbound)\n             PushNodeVersion(pfrom, connman, GetAdjustedTime());\n \n+        if (nVersion >= WTXID_RELAY_VERSION) {\n+            connman->PushMessage(pfrom, CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::WTXIDRELAY));\n+        }\n+\n         connman->PushMessage(pfrom, CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK));\n \n         pfrom->nServices = nServices;\n@@ -2194,6 +2198,18 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n         return true;\n     }\n \n+    // Feature negotiation of wtxidrelay should happen between VERSION and\n+    // VERACK, to avoid relay problems from switching after a connection is up\n+    if (msg_type == NetMsgType::WTXIDRELAY) {\n+        if (pfrom->nVersion >= WTXID_RELAY_VERSION) {\n+            LOCK(cs_main);\n+            if (!State(pfrom->GetId())->m_wtxid_relay) {\n+                State(pfrom->GetId())->m_wtxid_relay = true;\n+            }\n+        }\n+        return false;\n+    }\n+\n     if (!pfrom->fSuccessfullyConnected) {\n         // Must have a verack message before anything else\n         LOCK(cs_main);"
      },
      {
        "sha": "8b2043fda4f4345da956a276bfc2813a74376f81",
        "filename": "src/protocol.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/181ffadd162a84551b3518de77b5dcc08c712425/src/protocol.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/181ffadd162a84551b3518de77b5dcc08c712425/src/protocol.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/protocol.cpp?ref=181ffadd162a84551b3518de77b5dcc08c712425",
        "patch": "@@ -40,6 +40,7 @@ const char *SENDCMPCT=\"sendcmpct\";\n const char *CMPCTBLOCK=\"cmpctblock\";\n const char *GETBLOCKTXN=\"getblocktxn\";\n const char *BLOCKTXN=\"blocktxn\";\n+const char *WTXIDRELAY=\"wtxidrelay\";\n } // namespace NetMsgType\n \n /** All known message types. Keep this in the same order as the list of\n@@ -71,6 +72,7 @@ const static std::string allNetMessageTypes[] = {\n     NetMsgType::CMPCTBLOCK,\n     NetMsgType::GETBLOCKTXN,\n     NetMsgType::BLOCKTXN,\n+    NetMsgType::WTXIDRELAY,\n };\n const static std::vector<std::string> allNetMessageTypesVec(allNetMessageTypes, allNetMessageTypes+ARRAYLEN(allNetMessageTypes));\n "
      },
      {
        "sha": "a27ca564956a1e23781e965cd4e4de2127b7ea24",
        "filename": "src/protocol.h",
        "status": "modified",
        "additions": 7,
        "deletions": 1,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/181ffadd162a84551b3518de77b5dcc08c712425/src/protocol.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/181ffadd162a84551b3518de77b5dcc08c712425/src/protocol.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/protocol.h?ref=181ffadd162a84551b3518de77b5dcc08c712425",
        "patch": "@@ -234,6 +234,12 @@ extern const char *GETBLOCKTXN;\n  * @since protocol version 70014 as described by BIP 152\n  */\n extern const char *BLOCKTXN;\n+/**\n+ * Indicates that a node prefers to relay transactions via wtxid, rather than\n+ * txid.\n+ * @since protocol version 70016 as described by BIP 339.\n+ */\n+extern const char *WTXIDRELAY;\n };\n \n /* Get a vector of all valid message types (see above) */\n@@ -367,7 +373,7 @@ enum GetDataMsg : uint32_t {\n     MSG_TX = 1,\n     MSG_BLOCK = 2,\n     MSG_WTX = 5,                                      //!< Defined in BIP 339\n-    // The following can only occur in getdata. Invs always use TX or BLOCK.\n+    // The following can only occur in getdata. Invs always use TX/WTX or BLOCK.\n     MSG_FILTERED_BLOCK = 3,  //!< Defined in BIP37\n     MSG_CMPCT_BLOCK = 4,     //!< Defined in BIP152\n     MSG_WITNESS_BLOCK = MSG_BLOCK | MSG_WITNESS_FLAG, //!< Defined in BIP144"
      },
      {
        "sha": "e55871fc413aa04e5478dd1108bc1e175b921369",
        "filename": "src/version.h",
        "status": "modified",
        "additions": 4,
        "deletions": 1,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/181ffadd162a84551b3518de77b5dcc08c712425/src/version.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/181ffadd162a84551b3518de77b5dcc08c712425/src/version.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/version.h?ref=181ffadd162a84551b3518de77b5dcc08c712425",
        "patch": "@@ -9,7 +9,7 @@\n  * network protocol versioning\n  */\n \n-static const int PROTOCOL_VERSION = 70015;\n+static const int PROTOCOL_VERSION = 70016;\n \n //! initial proto version, to be increased after version/verack negotiation\n static const int INIT_PROTO_VERSION = 209;\n@@ -42,4 +42,7 @@ static const int SHORT_IDS_BLOCKS_VERSION = 70014;\n //! not banning for invalid compact blocks starts with this version\n static const int INVALID_CB_NO_BAN_VERSION = 70015;\n \n+//! \"wtxidrelay\" command for wtxid-based relay starts with this version\n+static const int WTXID_RELAY_VERSION = 70016;\n+\n #endif // BITCOIN_VERSION_H"
      }
    ]
  },
  {
    "sha": "c1d6a1003d601ec4ff7d9507563254b29868182f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjMWQ2YTEwMDNkNjAxZWM0ZmY3ZDk1MDc1NjMyNTRiMjk4NjgxODJm",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-01-31T16:23:27Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "Delay getdata requests from peers using txid-based relay\n\nUsing both txid and wtxid-based relay with peers means that we could sometimes\ndownload the same transaction twice, if announced via two different hashes from\ndifferent peers.\n\nUse a heuristic of delaying txid-peer-getdata requests by 2 seconds, if we have\nat least one wtxid-based peer.",
      "tree": {
        "sha": "38758f82f463db6d10b51831267752b363973688",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/38758f82f463db6d10b51831267752b363973688"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c1d6a1003d601ec4ff7d9507563254b29868182f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c1d6a1003d601ec4ff7d9507563254b29868182f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c1d6a1003d601ec4ff7d9507563254b29868182f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c1d6a1003d601ec4ff7d9507563254b29868182f/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "181ffadd162a84551b3518de77b5dcc08c712425",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/181ffadd162a84551b3518de77b5dcc08c712425",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/181ffadd162a84551b3518de77b5dcc08c712425"
      }
    ],
    "stats": {
      "total": 29,
      "additions": 25,
      "deletions": 4
    },
    "files": [
      {
        "sha": "0527bd2022e6b79ceab473132aa9d6eedbc47dca",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 23,
        "deletions": 3,
        "changes": 26,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c1d6a1003d601ec4ff7d9507563254b29868182f/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c1d6a1003d601ec4ff7d9507563254b29868182f/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=c1d6a1003d601ec4ff7d9507563254b29868182f",
        "patch": "@@ -68,6 +68,8 @@ static constexpr int HISTORICAL_BLOCK_AGE = 7 * 24 * 60 * 60;\n static constexpr int32_t MAX_PEER_TX_IN_FLIGHT = 100;\n /** Maximum number of announced transactions from a peer */\n static constexpr int32_t MAX_PEER_TX_ANNOUNCEMENTS = 2 * MAX_INV_SZ;\n+/** How many microseconds to delay requesting transactions via txids, if we have wtxid-relaying peers */\n+static constexpr std::chrono::microseconds TXID_RELAY_DELAY{std::chrono::seconds{2}};\n /** How many microseconds to delay requesting transactions from inbound peers */\n static constexpr std::chrono::microseconds INBOUND_PEER_TX_DELAY{std::chrono::seconds{2}};\n /** How long to wait (in microseconds) before downloading a transaction from an additional peer */\n@@ -174,6 +176,9 @@ namespace {\n     /** Number of peers from which we're downloading blocks. */\n     int nPeersWithValidatedDownloads GUARDED_BY(cs_main) = 0;\n \n+    /** Number of peers with wtxid relay. */\n+    int g_wtxid_relay_peers GUARDED_BY(cs_main) = 0;\n+\n     /** Number of outbound peers with m_chain_sync.m_protect. */\n     int g_outbound_peers_with_protect_from_disconnect GUARDED_BY(cs_main) = 0;\n \n@@ -715,7 +720,7 @@ void UpdateTxRequestTime(const uint256& txid, std::chrono::microseconds request_\n     }\n }\n \n-std::chrono::microseconds CalculateTxGetDataTime(const uint256& txid, std::chrono::microseconds current_time, bool use_inbound_delay) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+std::chrono::microseconds CalculateTxGetDataTime(const uint256& txid, std::chrono::microseconds current_time, bool use_inbound_delay, bool use_txid_delay) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n {\n     std::chrono::microseconds process_time;\n     const auto last_request_time = GetTxRequestTime(txid);\n@@ -731,6 +736,9 @@ std::chrono::microseconds CalculateTxGetDataTime(const uint256& txid, std::chron\n     // We delay processing announcements from inbound peers\n     if (use_inbound_delay) process_time += INBOUND_PEER_TX_DELAY;\n \n+    // We delay processing announcements from peers that use txid-relay (instead of wtxid)\n+    if (use_txid_delay) process_time += TXID_RELAY_DELAY;\n+\n     return process_time;\n }\n \n@@ -748,7 +756,7 @@ void RequestTx(CNodeState* state, const uint256& txid, std::chrono::microseconds\n \n     // Calculate the time to try requesting this transaction. Use\n     // fPreferredDownload as a proxy for outbound peers.\n-    const auto process_time = CalculateTxGetDataTime(txid, current_time, !state->fPreferredDownload);\n+    const auto process_time = CalculateTxGetDataTime(txid, current_time, !state->fPreferredDownload, !state->m_wtxid_relay && g_wtxid_relay_peers > 0);\n \n     peer_download_state.m_tx_process_time.emplace(process_time, txid);\n }\n@@ -805,6 +813,8 @@ void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTim\n     assert(nPeersWithValidatedDownloads >= 0);\n     g_outbound_peers_with_protect_from_disconnect -= state->m_chain_sync.m_protect;\n     assert(g_outbound_peers_with_protect_from_disconnect >= 0);\n+    g_wtxid_relay_peers -= state->m_wtxid_relay;\n+    assert(g_wtxid_relay_peers >= 0);\n \n     mapNodeState.erase(nodeid);\n \n@@ -814,6 +824,7 @@ void PeerLogicValidation::FinalizeNode(NodeId nodeid, bool& fUpdateConnectionTim\n         assert(nPreferredDownload == 0);\n         assert(nPeersWithValidatedDownloads == 0);\n         assert(g_outbound_peers_with_protect_from_disconnect == 0);\n+        assert(g_wtxid_relay_peers == 0);\n     }\n     LogPrint(BCLog::NET, \"Cleared nodestate for peer=%d\\n\", nodeid);\n }\n@@ -2205,6 +2216,7 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n             LOCK(cs_main);\n             if (!State(pfrom->GetId())->m_wtxid_relay) {\n                 State(pfrom->GetId())->m_wtxid_relay = true;\n+                g_wtxid_relay_peers++;\n             }\n         }\n         return false;\n@@ -4208,7 +4220,15 @@ bool PeerLogicValidation::SendMessages(CNode* pto)\n                     // up processing to happen after the download times out\n                     // (with a slight delay for inbound peers, to prefer\n                     // requests to outbound peers).\n-                    const auto next_process_time = CalculateTxGetDataTime(txid, current_time, !state.fPreferredDownload);\n+                    // Don't apply the txid-delay to re-requests of a\n+                    // transaction; the heuristic of delaying requests to\n+                    // txid-relay peers is to save bandwidth on initial\n+                    // announcement of a transaction, and doesn't make sense\n+                    // for a followup request if our first peer times out (and\n+                    // would open us up to an attacker using inbound\n+                    // wtxid-relay to prevent us from requesting transactions\n+                    // from outbound txid-relay peers).\n+                    const auto next_process_time = CalculateTxGetDataTime(txid, current_time, !state.fPreferredDownload, false);\n                     tx_process_time.emplace(next_process_time, txid);\n                 }\n             } else {"
      },
      {
        "sha": "c0edeebcee66f3ebb046bbe8c2b78ff7c93fbfe0",
        "filename": "test/functional/p2p_tx_download.py",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c1d6a1003d601ec4ff7d9507563254b29868182f/test/functional/p2p_tx_download.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c1d6a1003d601ec4ff7d9507563254b29868182f/test/functional/p2p_tx_download.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_tx_download.py?ref=c1d6a1003d601ec4ff7d9507563254b29868182f",
        "patch": "@@ -44,12 +44,13 @@ def on_getdata(self, message):\n GETDATA_TX_INTERVAL = 60  # seconds\n MAX_GETDATA_RANDOM_DELAY = 2  # seconds\n INBOUND_PEER_TX_DELAY = 2  # seconds\n+TXID_RELAY_DELAY = 2 # seconds\n MAX_GETDATA_IN_FLIGHT = 100\n TX_EXPIRY_INTERVAL = GETDATA_TX_INTERVAL * 10\n \n # Python test constants\n NUM_INBOUND = 10\n-MAX_GETDATA_INBOUND_WAIT = GETDATA_TX_INTERVAL + MAX_GETDATA_RANDOM_DELAY + INBOUND_PEER_TX_DELAY\n+MAX_GETDATA_INBOUND_WAIT = GETDATA_TX_INTERVAL + MAX_GETDATA_RANDOM_DELAY + INBOUND_PEER_TX_DELAY + TXID_RELAY_DELAY\n \n \n class TxDownloadTest(BitcoinTestFramework):"
      }
    ]
  },
  {
    "sha": "879a3cf2c2367d51310204d21030f3b218582c30",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4NzlhM2NmMmMyMzY3ZDUxMzEwMjA0ZDIxMDMwZjNiMjE4NTgyYzMw",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-02-07T09:30:41Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "Make TX_WITNESS_STRIPPED its own rejection reason\n\nPreviously, TX_WITNESS_MUTATED could be returned during transaction validation\nfor either transactions that had a witness that was non-standard, or for\ntransactions that had no witness but were invalid due to segwit validation\nrules.\n\nHowever, for txid/wtxid-relay considerations, net_processing distinguishes the\nwitness stripped case separately, because it affects whether a wtxid should be\nable to be added to the reject filter. It is safe to add the wtxid of a\nwitness-mutated transaction to the filter (as that wtxid shouldn't collide with\nthe txid, and hence it wouldn't interfere with transaction relay from\ntxid-relay peers), but it is not safe to add the wtxid (== txid) of a\nwitness-stripped transaction to the filter, because that would interfere with\nrelay of another transaction with the same txid (but different wtxid) when\nrelaying from txid-relay peers.\n\nAlso updates the comment explaining this logic, and explaining that we can get\nrid of this complexity once there's a sufficient deployment of wtxid-relaying\npeers on the network.",
      "tree": {
        "sha": "c6576fd5335346d022dacd86d27dbf56eaeab7ae",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c6576fd5335346d022dacd86d27dbf56eaeab7ae"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/879a3cf2c2367d51310204d21030f3b218582c30",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/879a3cf2c2367d51310204d21030f3b218582c30",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/879a3cf2c2367d51310204d21030f3b218582c30",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/879a3cf2c2367d51310204d21030f3b218582c30/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c1d6a1003d601ec4ff7d9507563254b29868182f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c1d6a1003d601ec4ff7d9507563254b29868182f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c1d6a1003d601ec4ff7d9507563254b29868182f"
      }
    ],
    "stats": {
      "total": 13,
      "additions": 9,
      "deletions": 4
    },
    "files": [
      {
        "sha": "f7d476951b280cf325c575b684d04ca5de788bfe",
        "filename": "src/consensus/validation.h",
        "status": "modified",
        "additions": 5,
        "deletions": 1,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/879a3cf2c2367d51310204d21030f3b218582c30/src/consensus/validation.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/879a3cf2c2367d51310204d21030f3b218582c30/src/consensus/validation.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/consensus/validation.h?ref=879a3cf2c2367d51310204d21030f3b218582c30",
        "patch": "@@ -31,11 +31,15 @@ enum class TxValidationResult {\n     TX_MISSING_INPUTS,        //!< transaction was missing some of its inputs\n     TX_PREMATURE_SPEND,       //!< transaction spends a coinbase too early, or violates locktime/sequence locks\n     /**\n-     * Transaction might be missing a witness, have a witness prior to SegWit\n+     * Transaction might have a witness prior to SegWit\n      * activation, or witness may have been malleated (which includes\n      * non-standard witnesses).\n      */\n     TX_WITNESS_MUTATED,\n+    /**\n+     * Transaction is missing a witness.\n+     */\n+    TX_WITNESS_STRIPPED,\n     /**\n      * Tx already in mempool or conflicts with a tx in the chain\n      * (if it conflicts with another tx in mempool, we use MEMPOOL_POLICY as it failed to reach the RBF threshold)"
      },
      {
        "sha": "8893397e83c0eb2df7f2fee58e781a12f24f5e8d",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 2,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/879a3cf2c2367d51310204d21030f3b218582c30/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/879a3cf2c2367d51310204d21030f3b218582c30/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=879a3cf2c2367d51310204d21030f3b218582c30",
        "patch": "@@ -1092,6 +1092,7 @@ static bool MaybePunishNodeForTx(NodeId nodeid, const TxValidationState& state,\n     case TxValidationResult::TX_MISSING_INPUTS:\n     case TxValidationResult::TX_PREMATURE_SPEND:\n     case TxValidationResult::TX_WITNESS_MUTATED:\n+    case TxValidationResult::TX_WITNESS_STRIPPED:\n     case TxValidationResult::TX_CONFLICT:\n     case TxValidationResult::TX_MEMPOOL_POLICY:\n         break;\n@@ -1934,7 +1935,7 @@ void static ProcessOrphanTx(CConnman* connman, CTxMemPool& mempool, std::set<uin\n             // Has inputs but not accepted to mempool\n             // Probably non-standard or insufficient fee\n             LogPrint(BCLog::MEMPOOL, \"   removed orphan tx %s\\n\", orphanHash.ToString());\n-            if (orphanTx.HasWitness() || orphan_state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n+            if (orphan_state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n                 // We can add the wtxid of this transaction to our reject filter.\n                 // Do not add txids of witness transactions or witness-stripped\n                 // transactions to the filter, as they can have been malleated;\n@@ -2708,7 +2709,7 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n                 recentRejects->insert(tx.GetWitnessHash());\n             }\n         } else {\n-            if (tx.HasWitness() || state.GetResult() != TxValidationResult::TX_WITNESS_MUTATED) {\n+            if (state.GetResult() != TxValidationResult::TX_WITNESS_STRIPPED) {\n                 // We can add the wtxid of this transaction to our reject filter.\n                 // Do not add txids of witness transactions or witness-stripped\n                 // transactions to the filter, as they can have been malleated;"
      },
      {
        "sha": "a4adc81b5aea79890b473c90ab30e1800d32b401",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/879a3cf2c2367d51310204d21030f3b218582c30/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/879a3cf2c2367d51310204d21030f3b218582c30/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=879a3cf2c2367d51310204d21030f3b218582c30",
        "patch": "@@ -916,7 +916,7 @@ bool MemPoolAccept::PolicyScriptChecks(ATMPArgs& args, Workspace& ws, Precompute\n         if (!tx.HasWitness() && CheckInputScripts(tx, state_dummy, m_view, scriptVerifyFlags & ~(SCRIPT_VERIFY_WITNESS | SCRIPT_VERIFY_CLEANSTACK), true, false, txdata) &&\n                 !CheckInputScripts(tx, state_dummy, m_view, scriptVerifyFlags & ~SCRIPT_VERIFY_CLEANSTACK, true, false, txdata)) {\n             // Only the witness is missing, so the transaction itself may be fine.\n-            state.Invalid(TxValidationResult::TX_WITNESS_MUTATED,\n+            state.Invalid(TxValidationResult::TX_WITNESS_STRIPPED,\n                     state.GetRejectReason(), state.GetDebugMessage());\n         }\n         return false; // state filled in by CheckInputScripts"
      }
    ]
  },
  {
    "sha": "e364b2a2d879e8d30ca9dbc578e4d169b41eb227",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplMzY0YjJhMmQ4NzllOGQzMGNhOWRiYzU3OGU0ZDE2OWI0MWViMjI3",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-02-26T18:36:35Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "Rename AddInventoryKnown() to AddKnownTx()",
      "tree": {
        "sha": "36dcf99f7f53e15258f0d96ff14313839e0bcc97",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/36dcf99f7f53e15258f0d96ff14313839e0bcc97"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e364b2a2d879e8d30ca9dbc578e4d169b41eb227",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e364b2a2d879e8d30ca9dbc578e4d169b41eb227",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e364b2a2d879e8d30ca9dbc578e4d169b41eb227",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e364b2a2d879e8d30ca9dbc578e4d169b41eb227/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "879a3cf2c2367d51310204d21030f3b218582c30",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/879a3cf2c2367d51310204d21030f3b218582c30",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/879a3cf2c2367d51310204d21030f3b218582c30"
      }
    ],
    "stats": {
      "total": 10,
      "additions": 5,
      "deletions": 5
    },
    "files": [
      {
        "sha": "8822e4e35d825c12ee67fa2db7fbffbfa3e4aa28",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e364b2a2d879e8d30ca9dbc578e4d169b41eb227/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e364b2a2d879e8d30ca9dbc578e4d169b41eb227/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=e364b2a2d879e8d30ca9dbc578e4d169b41eb227",
        "patch": "@@ -969,7 +969,7 @@ class CNode\n     }\n \n \n-    void AddInventoryKnown(const uint256& hash)\n+    void AddKnownTx(const uint256& hash)\n     {\n         if (m_tx_relay != nullptr) {\n             LOCK(m_tx_relay->cs_tx_inventory);"
      },
      {
        "sha": "853c488bed72fe6a8357e25599f5e6fc8238e19e",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 4,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e364b2a2d879e8d30ca9dbc578e4d169b41eb227/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e364b2a2d879e8d30ca9dbc578e4d169b41eb227/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=e364b2a2d879e8d30ca9dbc578e4d169b41eb227",
        "patch": "@@ -2368,7 +2368,7 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n                     best_block = &inv.hash;\n                 }\n             } else {\n-                pfrom->AddInventoryKnown(inv.hash);\n+                pfrom->AddKnownTx(inv.hash);\n                 if (fBlocksOnly) {\n                     LogPrint(BCLog::NET, \"transaction (%s) inv sent in violation of protocol, disconnecting peer=%d\\n\", inv.hash.ToString(), pfrom->GetId());\n                     pfrom->fDisconnect = true;\n@@ -2615,14 +2615,14 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n         CNodeState* nodestate = State(pfrom->GetId());\n \n         const uint256& hash = nodestate->m_wtxid_relay ? wtxid : txid;\n-        pfrom->AddInventoryKnown(hash);\n+        pfrom->AddKnownTx(hash);\n         if (nodestate->m_wtxid_relay && txid != wtxid) {\n             // Insert txid into filterInventoryKnown, even for\n             // wtxidrelay peers. This prevents re-adding of\n             // unconfirmed parents to the recently_announced\n             // filter, when a child tx is requested. See\n             // ProcessGetData().\n-            pfrom->AddInventoryKnown(txid);\n+            pfrom->AddKnownTx(txid);\n         }\n \n         TxValidationState state;\n@@ -2689,7 +2689,7 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n                         // Eventually we should replace this with an improved\n                         // protocol for getting all unconfirmed parents.\n                         CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                        pfrom->AddInventoryKnown(txin.prevout.hash);\n+                        pfrom->AddKnownTx(txin.prevout.hash);\n                         if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom->GetId()), _inv.hash, current_time);\n                     }\n                 }"
      }
    ]
  },
  {
    "sha": "6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2YmUzOThiNmZiN2E3ZDVjNmMxZmU2ZDc0YTA3MDBiN2ZmOTM2NzRl",
    "commit": {
      "author": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2020-03-27T01:12:47Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "test: Update test framework p2p protocol version to 70016\n\nThis new p2p protocol version allows to use WTXIDs for tx relay.",
      "tree": {
        "sha": "9503f4443e570f4a8d320baff8d32025c58b03af",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9503f4443e570f4a8d320baff8d32025c58b03af"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e/comments",
    "author": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e364b2a2d879e8d30ca9dbc578e4d169b41eb227",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e364b2a2d879e8d30ca9dbc578e4d169b41eb227",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e364b2a2d879e8d30ca9dbc578e4d169b41eb227"
      }
    ],
    "stats": {
      "total": 28,
      "additions": 26,
      "deletions": 2
    },
    "files": [
      {
        "sha": "c8c38e017a0ec3a83899ecc3b8ed7d5311589183",
        "filename": "test/functional/test_framework/messages.py",
        "status": "modified",
        "additions": 23,
        "deletions": 2,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e/test/functional/test_framework/messages.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e/test/functional/test_framework/messages.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_framework/messages.py?ref=6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e",
        "patch": "@@ -31,7 +31,7 @@\n from test_framework.util import hex_str_to_bytes, assert_equal\n \n MIN_VERSION_SUPPORTED = 60001\n-MY_VERSION = 70014  # past bip-31 for ping/pong\n+MY_VERSION = 70016  # past wtxid relay\n MY_SUBVERSION = b\"/python-mininode-tester:0.0.3/\"\n MY_RELAY = 1 # from version 70001 onwards, fRelay should be appended to version messages (BIP37)\n \n@@ -52,6 +52,7 @@\n MSG_TX = 1\n MSG_BLOCK = 2\n MSG_FILTERED_BLOCK = 3\n+MSG_WTX = 5\n MSG_WITNESS_FLAG = 1 << 30\n MSG_TYPE_MASK = 0xffffffff >> 2\n \n@@ -231,7 +232,8 @@ class CInv:\n         MSG_TX | MSG_WITNESS_FLAG: \"WitnessTx\",\n         MSG_BLOCK | MSG_WITNESS_FLAG: \"WitnessBlock\",\n         MSG_FILTERED_BLOCK: \"filtered Block\",\n-        4: \"CompactBlock\"\n+        4: \"CompactBlock\",\n+        5: \"WTX\",\n     }\n \n     def __init__(self, t=0, h=0):\n@@ -252,6 +254,9 @@ def __repr__(self):\n         return \"CInv(type=%s hash=%064x)\" \\\n             % (self.typemap[self.type], self.hash)\n \n+    def __eq__(self, other):\n+        return isinstance(other, CInv) and self.hash == other.hash and self.type == other.type\n+\n \n class CBlockLocator:\n     __slots__ = (\"nVersion\", \"vHave\")\n@@ -1113,6 +1118,22 @@ def serialize(self):\n     def __repr__(self):\n         return \"msg_tx(tx=%s)\" % (repr(self.tx))\n \n+class msg_wtxidrelay:\n+    __slots__ = ()\n+    command = b\"wtxidrelay\"\n+\n+    def __init__(self):\n+        pass\n+\n+    def deserialize(self, f):\n+        pass\n+\n+    def serialize(self):\n+        return b\"\"\n+\n+    def __repr__(self):\n+        return \"msg_wtxidrelay()\"\n+\n \n class msg_no_witness_tx(msg_tx):\n     __slots__ = ()"
      },
      {
        "sha": "bda61fc2e387a0bb27aafa3580db21edf25aa0b8",
        "filename": "test/functional/test_framework/mininode.py",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e/test/functional/test_framework/mininode.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e/test/functional/test_framework/mininode.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_framework/mininode.py?ref=6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e",
        "patch": "@@ -52,6 +52,7 @@\n     MSG_TYPE_MASK,\n     msg_verack,\n     msg_version,\n+    msg_wtxidrelay,\n     NODE_NETWORK,\n     NODE_WITNESS,\n     sha256,\n@@ -86,6 +87,7 @@\n     b\"tx\": msg_tx,\n     b\"verack\": msg_verack,\n     b\"version\": msg_version,\n+    b\"wtxidrelay\": msg_wtxidrelay,\n }\n \n MAGIC_BYTES = {\n@@ -343,6 +345,7 @@ def on_reject(self, message): pass\n     def on_sendcmpct(self, message): pass\n     def on_sendheaders(self, message): pass\n     def on_tx(self, message): pass\n+    def on_wtxidrelay(self, message): pass\n \n     def on_inv(self, message):\n         want = msg_getdata()"
      }
    ]
  },
  {
    "sha": "e4816819630d1e94469ca5499361e0cd2c9ac7c2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplNDgxNjgxOTYzMGQxZTk0NDY5Y2E1NDk5MzYxZTBjZDJjOWFjN2My",
    "commit": {
      "author": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2020-03-27T01:13:32Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "test: Add tests for wtxid tx relay in segwit test\n\nAlso cleans up some doublicate lines in the rest of the test.\n\nco-authored-by: Anthony Towns <aj@erisian.com.au>",
      "tree": {
        "sha": "e64e71eb20976d6d5428601fb14846105b5cfa3f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e64e71eb20976d6d5428601fb14846105b5cfa3f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e4816819630d1e94469ca5499361e0cd2c9ac7c2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e4816819630d1e94469ca5499361e0cd2c9ac7c2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e4816819630d1e94469ca5499361e0cd2c9ac7c2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e4816819630d1e94469ca5499361e0cd2c9ac7c2/comments",
    "author": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6be398b6fb7a7d5c6c1fe6d74a0700b7ff93674e"
      }
    ],
    "stats": {
      "total": 97,
      "additions": 91,
      "deletions": 6
    },
    "files": [
      {
        "sha": "0799fb5189fcaf9e5359c0716afae36fdd6675f8",
        "filename": "test/functional/p2p_segwit.py",
        "status": "modified",
        "additions": 91,
        "deletions": 6,
        "changes": 97,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e4816819630d1e94469ca5499361e0cd2c9ac7c2/test/functional/p2p_segwit.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e4816819630d1e94469ca5499361e0cd2c9ac7c2/test/functional/p2p_segwit.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_segwit.py?ref=e4816819630d1e94469ca5499361e0cd2c9ac7c2",
        "patch": "@@ -22,7 +22,9 @@\n     CTxOut,\n     CTxWitness,\n     MAX_BLOCK_BASE_SIZE,\n+    MSG_TX,\n     MSG_WITNESS_FLAG,\n+    MSG_WTX,\n     NODE_NETWORK,\n     NODE_WITNESS,\n     msg_no_witness_block,\n@@ -32,6 +34,7 @@\n     msg_tx,\n     msg_block,\n     msg_no_witness_tx,\n+    msg_wtxidrelay,\n     ser_uint256,\n     ser_vector,\n     sha256,\n@@ -79,6 +82,7 @@\n     softfork_active,\n     hex_str_to_bytes,\n     assert_raises_rpc_error,\n+    wait_until,\n )\n \n # The versionbit bit used to signal activation of SegWit\n@@ -141,23 +145,40 @@ def test_witness_block(node, p2p, block, accepted, with_witness=True, reason=Non\n \n \n class TestP2PConn(P2PInterface):\n-    def __init__(self):\n+    def __init__(self, wtxidrelay=False):\n         super().__init__()\n         self.getdataset = set()\n+        self.last_wtxidrelay = []\n+        self.lastgetdata = []\n+        self.wtxidrelay = wtxidrelay\n \n     # Avoid sending out msg_getdata in the mininode thread as a reply to invs.\n     # They are not needed and would only lead to races because we send msg_getdata out in the test thread\n     def on_inv(self, message):\n         pass\n \n+    def on_version(self, message):\n+        if self.wtxidrelay:\n+            self.send_message(msg_wtxidrelay())\n+        super().on_version(message)\n+\n     def on_getdata(self, message):\n+        self.lastgetdata = message.inv\n         for inv in message.inv:\n             self.getdataset.add(inv.hash)\n \n-    def announce_tx_and_wait_for_getdata(self, tx, timeout=60, success=True):\n+    def on_wtxidrelay(self, message):\n+        self.last_wtxidrelay.append(message)\n+\n+    def announce_tx_and_wait_for_getdata(self, tx, timeout=60, success=True, use_wtxid=False):\n         with mininode_lock:\n             self.last_message.pop(\"getdata\", None)\n-        self.send_message(msg_inv(inv=[CInv(1, tx.sha256)]))\n+        if use_wtxid:\n+            wtxid = tx.calc_sha256(True)\n+            self.send_message(msg_inv(inv=[CInv(MSG_WTX, wtxid)]))\n+        else:\n+            self.send_message(msg_inv(inv=[CInv(MSG_TX, tx.sha256)]))\n+\n         if success:\n             self.wait_for_getdata(timeout)\n         else:\n@@ -275,6 +296,7 @@ def run_test(self):\n         self.test_upgrade_after_activation()\n         self.test_witness_sigops()\n         self.test_superfluous_witness()\n+        self.test_wtxid_relay()\n \n     # Individual tests\n \n@@ -1268,7 +1290,6 @@ def test_tx_relay_after_segwit_activation(self):\n         test_transaction_acceptance(self.nodes[0], self.test_node, tx, with_witness=True, accepted=False)\n \n         # Verify that removing the witness succeeds.\n-        self.test_node.announce_tx_and_wait_for_getdata(tx)\n         test_transaction_acceptance(self.nodes[0], self.test_node, tx, with_witness=False, accepted=True)\n \n         # Now try to add extra witness data to a valid witness tx.\n@@ -1295,8 +1316,6 @@ def test_tx_relay_after_segwit_activation(self):\n         # Node will not be blinded to the transaction\n         self.std_node.announce_tx_and_wait_for_getdata(tx3)\n         test_transaction_acceptance(self.nodes[1], self.std_node, tx3, True, False, 'tx-size')\n-        self.std_node.announce_tx_and_wait_for_getdata(tx3)\n-        test_transaction_acceptance(self.nodes[1], self.std_node, tx3, True, False)\n \n         # Remove witness stuffing, instead add extra witness push on stack\n         tx3.vout[0] = CTxOut(tx2.vout[0].nValue - 1000, CScript([OP_TRUE, OP_DROP] * 15 + [OP_TRUE]))\n@@ -2023,6 +2042,11 @@ def test_witness_sigops(self):\n \n         # TODO: test p2sh sigop counting\n \n+        # Cleanup and prep for next test\n+        self.utxo.pop(0)\n+        self.utxo.append(UTXO(tx2.sha256, 0, tx2.vout[0].nValue))\n+\n+    @subtest  # type: ignore\n     def test_superfluous_witness(self):\n         # Serialization of tx that puts witness flag to 3 always\n         def serialize_with_bogus_witness(tx):\n@@ -2066,6 +2090,67 @@ def serialize(self):\n         with self.nodes[0].assert_debug_log(['Unknown transaction optional data']):\n             self.nodes[0].p2p.send_and_ping(msg_bogus_tx(tx))\n \n+    @subtest  # type: ignore\n+    def test_wtxid_relay(self):\n+        # Use brand new nodes to avoid contamination from earlier tests\n+        self.wtx_node = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=True), services=NODE_NETWORK | NODE_WITNESS)\n+        self.tx_node = self.nodes[0].add_p2p_connection(TestP2PConn(wtxidrelay=False), services=NODE_NETWORK | NODE_WITNESS)\n+\n+        # Check wtxidrelay feature negotiation message through connecting a new peer\n+        def received_wtxidrelay():\n+            return (len(self.wtx_node.last_wtxidrelay) > 0)\n+        wait_until(received_wtxidrelay, timeout=60, lock=mininode_lock)\n+\n+        # Create a Segwit output from the latest UTXO\n+        # and announce it to the network\n+        witness_program = CScript([OP_TRUE])\n+        witness_hash = sha256(witness_program)\n+        script_pubkey = CScript([OP_0, witness_hash])\n+\n+        tx = CTransaction()\n+        tx.vin.append(CTxIn(COutPoint(self.utxo[0].sha256, self.utxo[0].n), b\"\"))\n+        tx.vout.append(CTxOut(self.utxo[0].nValue - 1000, script_pubkey))\n+        tx.rehash()\n+\n+        # Create a Segwit transaction\n+        tx2 = CTransaction()\n+        tx2.vin.append(CTxIn(COutPoint(tx.sha256, 0), b\"\"))\n+        tx2.vout.append(CTxOut(tx.vout[0].nValue - 1000, script_pubkey))\n+        tx2.wit.vtxinwit.append(CTxInWitness())\n+        tx2.wit.vtxinwit[0].scriptWitness.stack = [witness_program]\n+        tx2.rehash()\n+\n+        # Announce Segwit transaction with wtxid\n+        # and wait for getdata\n+        self.wtx_node.announce_tx_and_wait_for_getdata(tx2, use_wtxid=True)\n+        with mininode_lock:\n+            lgd = self.wtx_node.lastgetdata[:]\n+        assert_equal(lgd, [CInv(MSG_WTX, tx2.calc_sha256(True))])\n+\n+        # Announce Segwit transaction from non wtxidrelay peer\n+        # and wait for getdata\n+        self.tx_node.announce_tx_and_wait_for_getdata(tx2, use_wtxid=False)\n+        with mininode_lock:\n+            lgd = self.tx_node.lastgetdata[:]\n+        assert_equal(lgd, [CInv(MSG_TX | MSG_WITNESS_FLAG, tx2.sha256)])\n+\n+        # Send tx2 through; it's an orphan so won't be accepted\n+        with mininode_lock:\n+            self.tx_node.last_message.pop(\"getdata\", None)\n+        test_transaction_acceptance(self.nodes[0], self.tx_node, tx2, with_witness=True, accepted=False)\n+\n+        # Expect a request for parent (tx) due to use of non-WTX peer\n+        self.tx_node.wait_for_getdata(60)\n+        with mininode_lock:\n+            lgd = self.tx_node.lastgetdata[:]\n+        assert_equal(lgd, [CInv(MSG_TX | MSG_WITNESS_FLAG, tx.sha256)])\n+\n+        # Send tx through\n+        test_transaction_acceptance(self.nodes[0], self.tx_node, tx, with_witness=False, accepted=True)\n+\n+        # Check tx2 is there now\n+        assert_equal(tx2.hash in self.nodes[0].getrawmempool(), True)\n+\n \n if __name__ == '__main__':\n     SegWitTest().main()"
      }
    ]
  },
  {
    "sha": "22effa51a77a8b8c72ba3525cb08dd0cf8464715",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyMmVmZmE1MWE3N2E4YjhjNzJiYTM1MjVjYjA4ZGQwY2Y4NDY0NzE1",
    "commit": {
      "author": {
        "name": "Fabian Jahr",
        "email": "fjahr@protonmail.com",
        "date": "2020-04-21T15:02:46Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "test: Use wtxid relay generally in functional tests",
      "tree": {
        "sha": "4a7e7fd330c83d3d28694e7b9cf01a6295a05db0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4a7e7fd330c83d3d28694e7b9cf01a6295a05db0"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/22effa51a77a8b8c72ba3525cb08dd0cf8464715",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/22effa51a77a8b8c72ba3525cb08dd0cf8464715",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/22effa51a77a8b8c72ba3525cb08dd0cf8464715",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/22effa51a77a8b8c72ba3525cb08dd0cf8464715/comments",
    "author": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e4816819630d1e94469ca5499361e0cd2c9ac7c2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e4816819630d1e94469ca5499361e0cd2c9ac7c2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e4816819630d1e94469ca5499361e0cd2c9ac7c2"
      }
    ],
    "stats": {
      "total": 47,
      "additions": 31,
      "deletions": 16
    },
    "files": [
      {
        "sha": "5a1a73d16ec611bbfd2d2dca89514f436a083f17",
        "filename": "test/functional/mempool_packages.py",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/mempool_packages.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/mempool_packages.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/mempool_packages.py?ref=22effa51a77a8b8c72ba3525cb08dd0cf8464715",
        "patch": "@@ -67,10 +67,15 @@ def run_test(self):\n         fee = Decimal(\"0.0001\")\n         # MAX_ANCESTORS transactions off a confirmed tx should be fine\n         chain = []\n+        witness_chain = []\n         for i in range(MAX_ANCESTORS):\n             (txid, sent_value) = self.chain_transaction(self.nodes[0], txid, 0, value, fee, 1)\n             value = sent_value\n             chain.append(txid)\n+            # We need the wtxids to check P2P announcements\n+            fulltx = self.nodes[0].getrawtransaction(txid)\n+            witnesstx = self.nodes[0].decoderawtransaction(fulltx, True)\n+            witness_chain.append(witnesstx['hash'])\n \n         # Check mempool has MAX_ANCESTORS transactions in it, and descendant and ancestor\n         # count and fees should look correct"
      },
      {
        "sha": "1069702da728a2ec1b89fec80eb829fdc6c093e6",
        "filename": "test/functional/p2p_blocksonly.py",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/p2p_blocksonly.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/p2p_blocksonly.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_blocksonly.py?ref=22effa51a77a8b8c72ba3525cb08dd0cf8464715",
        "patch": "@@ -52,7 +52,7 @@ def run_test(self):\n         self.log.info('Check that txs from rpc are not rejected and relayed to other peers')\n         assert_equal(self.nodes[0].getpeerinfo()[0]['relaytxes'], True)\n         txid = self.nodes[0].testmempoolaccept([sigtx])[0]['txid']\n-        with self.nodes[0].assert_debug_log(['received getdata for: tx {} peer=1'.format(txid)]):\n+        with self.nodes[0].assert_debug_log(['received getdata for: wtx {} peer=1'.format(txid)]):\n             self.nodes[0].sendrawtransaction(sigtx)\n             self.nodes[0].p2p.wait_for_tx(txid)\n             assert_equal(self.nodes[0].getmempoolinfo()['size'], 1)"
      },
      {
        "sha": "f77937d726b501074f059e3f6a3b04d845b55ae5",
        "filename": "test/functional/p2p_feefilter.py",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/p2p_feefilter.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/p2p_feefilter.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_feefilter.py?ref=22effa51a77a8b8c72ba3525cb08dd0cf8464715",
        "patch": "@@ -7,7 +7,7 @@\n from decimal import Decimal\n import time\n \n-from test_framework.messages import msg_feefilter\n+from test_framework.messages import MSG_TX, MSG_WTX, msg_feefilter\n from test_framework.mininode import mininode_lock, P2PInterface\n from test_framework.test_framework import BitcoinTestFramework\n \n@@ -31,7 +31,7 @@ def __init__(self):\n \n     def on_inv(self, message):\n         for i in message.inv:\n-            if (i.type == 1):\n+            if (i.type == MSG_TX) or (i.type == MSG_WTX):\n                 self.txinvs.append(hashToHex(i.hash))\n \n     def clear_invs(self):"
      },
      {
        "sha": "40925ae8c9f4050d7c85778fedec58d32dfd1533",
        "filename": "test/functional/p2p_segwit.py",
        "status": "modified",
        "additions": 5,
        "deletions": 3,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/p2p_segwit.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/p2p_segwit.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_segwit.py?ref=22effa51a77a8b8c72ba3525cb08dd0cf8464715",
        "patch": "@@ -34,7 +34,7 @@\n     msg_tx,\n     msg_block,\n     msg_no_witness_tx,\n-    msg_wtxidrelay,\n+    msg_verack,\n     ser_uint256,\n     ser_vector,\n     sha256,\n@@ -159,8 +159,10 @@ def on_inv(self, message):\n \n     def on_version(self, message):\n         if self.wtxidrelay:\n-            self.send_message(msg_wtxidrelay())\n-        super().on_version(message)\n+            super().on_version(message)\n+        else:\n+            self.send_message(msg_verack())\n+            self.nServices = message.nServices\n \n     def on_getdata(self, message):\n         self.lastgetdata = message.inv"
      },
      {
        "sha": "7e7df1442ecfaa4b9549241dd0368f6070f3fdb1",
        "filename": "test/functional/p2p_tx_download.py",
        "status": "modified",
        "additions": 5,
        "deletions": 4,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/p2p_tx_download.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/p2p_tx_download.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_tx_download.py?ref=22effa51a77a8b8c72ba3525cb08dd0cf8464715",
        "patch": "@@ -12,6 +12,7 @@\n     FromHex,\n     MSG_TX,\n     MSG_TYPE_MASK,\n+    MSG_WTX,\n     msg_inv,\n     msg_notfound,\n )\n@@ -36,7 +37,7 @@ def __init__(self):\n \n     def on_getdata(self, message):\n         for i in message.inv:\n-            if i.type & MSG_TYPE_MASK == MSG_TX:\n+            if i.type & MSG_TYPE_MASK == MSG_TX or i.type & MSG_TYPE_MASK == MSG_WTX:\n                 self.tx_getdata_count += 1\n \n \n@@ -64,7 +65,7 @@ def test_tx_requests(self):\n         txid = 0xdeadbeef\n \n         self.log.info(\"Announce the txid from each incoming peer to node 0\")\n-        msg = msg_inv([CInv(t=1, h=txid)])\n+        msg = msg_inv([CInv(t=MSG_WTX, h=txid)])\n         for p in self.nodes[0].p2ps:\n             p.send_and_ping(msg)\n \n@@ -136,13 +137,13 @@ def test_in_flight_max(self):\n         with mininode_lock:\n             p.tx_getdata_count = 0\n \n-        p.send_message(msg_inv([CInv(t=1, h=i) for i in txids]))\n+        p.send_message(msg_inv([CInv(t=MSG_WTX, h=i) for i in txids]))\n         wait_until(lambda: p.tx_getdata_count >= MAX_GETDATA_IN_FLIGHT, lock=mininode_lock)\n         with mininode_lock:\n             assert_equal(p.tx_getdata_count, MAX_GETDATA_IN_FLIGHT)\n \n         self.log.info(\"Now check that if we send a NOTFOUND for a transaction, we'll get one more request\")\n-        p.send_message(msg_notfound(vec=[CInv(t=1, h=txids[0])]))\n+        p.send_message(msg_notfound(vec=[CInv(t=MSG_WTX, h=txids[0])]))\n         wait_until(lambda: p.tx_getdata_count >= MAX_GETDATA_IN_FLIGHT + 1, timeout=10, lock=mininode_lock)\n         with mininode_lock:\n             assert_equal(p.tx_getdata_count, MAX_GETDATA_IN_FLIGHT + 1)"
      },
      {
        "sha": "383b340118148715b1a54121100681fa01376203",
        "filename": "test/functional/test_framework/mininode.py",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/test_framework/mininode.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/test_framework/mininode.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_framework/mininode.py?ref=22effa51a77a8b8c72ba3525cb08dd0cf8464715",
        "patch": "@@ -363,6 +363,8 @@ def on_verack(self, message):\n \n     def on_version(self, message):\n         assert message.nVersion >= MIN_VERSION_SUPPORTED, \"Version {} received. Test framework only supports versions greater than {}\".format(message.nVersion, MIN_VERSION_SUPPORTED)\n+        if message.nVersion >= 70016:\n+            self.send_message(msg_wtxidrelay())\n         self.send_message(msg_verack())\n         self.nServices = message.nServices\n "
      },
      {
        "sha": "fe670ddaeea5e71b282df1a39c320365513be4c8",
        "filename": "test/functional/wallet_resendwallettransactions.py",
        "status": "modified",
        "additions": 11,
        "deletions": 6,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/wallet_resendwallettransactions.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/22effa51a77a8b8c72ba3525cb08dd0cf8464715/test/functional/wallet_resendwallettransactions.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/wallet_resendwallettransactions.py?ref=22effa51a77a8b8c72ba3525cb08dd0cf8464715",
        "patch": "@@ -7,7 +7,11 @@\n import time\n \n from test_framework.blocktools import create_block, create_coinbase\n-from test_framework.messages import ToHex\n+from test_framework.messages import (\n+    MSG_TX,\n+    MSG_WTX,\n+    ToHex,\n+)\n from test_framework.mininode import P2PInterface, mininode_lock\n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.util import assert_equal, wait_until\n@@ -21,7 +25,7 @@ def __init__(self):\n     def on_inv(self, message):\n         # Store how many times invs have been received for each tx.\n         for i in message.inv:\n-            if i.type == 1:\n+            if i.type == MSG_TX or i.type == MSG_WTX:\n                 # save txid\n                 self.tx_invs_received[i.hash] += 1\n \n@@ -39,7 +43,8 @@ def run_test(self):\n         node.add_p2p_connection(P2PStoreTxInvs())\n \n         self.log.info(\"Create a new transaction and wait until it's broadcast\")\n-        txid = int(node.sendtoaddress(node.getnewaddress(), 1), 16)\n+        txid = node.sendtoaddress(node.getnewaddress(), 1)\n+        wtxid = int(node.getrawtransaction(txid, 1)['hash'], 16)\n \n         # Wallet rebroadcast is first scheduled 1 sec after startup (see\n         # nNextResend in ResendWalletTransactions()). Sleep for just over a\n@@ -48,7 +53,7 @@ def run_test(self):\n         time.sleep(1.1)\n \n         # Can take a few seconds due to transaction trickling\n-        wait_until(lambda: node.p2p.tx_invs_received[txid] >= 1, lock=mininode_lock)\n+        wait_until(lambda: node.p2p.tx_invs_received[wtxid] >= 1, lock=mininode_lock)\n \n         # Add a second peer since txs aren't rebroadcast to the same peer (see filterInventoryKnown)\n         node.add_p2p_connection(P2PStoreTxInvs())\n@@ -67,13 +72,13 @@ def run_test(self):\n         # Transaction should not be rebroadcast\n         node.syncwithvalidationinterfacequeue()\n         node.p2ps[1].sync_with_ping()\n-        assert_equal(node.p2ps[1].tx_invs_received[txid], 0)\n+        assert_equal(node.p2ps[1].tx_invs_received[wtxid], 0)\n \n         self.log.info(\"Transaction should be rebroadcast after 30 minutes\")\n         # Use mocktime and give an extra 5 minutes to be sure.\n         rebroadcast_time = int(time.time()) + 41 * 60\n         node.setmocktime(rebroadcast_time)\n-        wait_until(lambda: node.p2ps[1].tx_invs_received[txid] >= 1, lock=mininode_lock)\n+        wait_until(lambda: node.p2ps[1].tx_invs_received[wtxid] >= 1, lock=mininode_lock)\n \n \n if __name__ == '__main__':"
      }
    ]
  },
  {
    "sha": "f082a13ab756a378b260711a30d363f833a2306a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmMDgyYTEzYWI3NTZhMzc4YjI2MDcxMWEzMGQzNjNmODMzYTIzMDZh",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-06-29T18:59:55Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "Disconnect peers sending wtxidrelay message after VERACK",
      "tree": {
        "sha": "a1119cebc4f42e5afbca7b89e499704b1a51a77a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a1119cebc4f42e5afbca7b89e499704b1a51a77a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f082a13ab756a378b260711a30d363f833a2306a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f082a13ab756a378b260711a30d363f833a2306a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/f082a13ab756a378b260711a30d363f833a2306a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f082a13ab756a378b260711a30d363f833a2306a/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "22effa51a77a8b8c72ba3525cb08dd0cf8464715",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/22effa51a77a8b8c72ba3525cb08dd0cf8464715",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/22effa51a77a8b8c72ba3525cb08dd0cf8464715"
      }
    ],
    "stats": {
      "total": 6,
      "additions": 6,
      "deletions": 0
    },
    "files": [
      {
        "sha": "43447a2c3471411d7af5c2a43ec994a599d4e2ff",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f082a13ab756a378b260711a30d363f833a2306a/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f082a13ab756a378b260711a30d363f833a2306a/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=f082a13ab756a378b260711a30d363f833a2306a",
        "patch": "@@ -2213,6 +2213,12 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n     // Feature negotiation of wtxidrelay should happen between VERSION and\n     // VERACK, to avoid relay problems from switching after a connection is up\n     if (msg_type == NetMsgType::WTXIDRELAY) {\n+        if (pfrom->fSuccessfullyConnected) {\n+            // Disconnect peers that send wtxidrelay message after VERACK; this\n+            // must be negotiated between VERSION and VERACK.\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n         if (pfrom->nVersion >= WTXID_RELAY_VERSION) {\n             LOCK(cs_main);\n             if (!State(pfrom->GetId())->m_wtxid_relay) {"
      }
    ]
  },
  {
    "sha": "d4a1ee8f1d4c46ab726be83965bd86bace2ec1ec",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkNGExZWU4ZjFkNGM0NmFiNzI2YmU4Mzk2NWJkODZiYWNlMmVjMWVj",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-06-29T21:14:40Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-09-24T12:24:10Z"
      },
      "message": "Further improve comments around recentRejects",
      "tree": {
        "sha": "e7669e24fc7bd7131a5ade6e29df9acbe5f5b885",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e7669e24fc7bd7131a5ade6e29df9acbe5f5b885"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d4a1ee8f1d4c46ab726be83965bd86bace2ec1ec",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d4a1ee8f1d4c46ab726be83965bd86bace2ec1ec",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/d4a1ee8f1d4c46ab726be83965bd86bace2ec1ec",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d4a1ee8f1d4c46ab726be83965bd86bace2ec1ec/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f082a13ab756a378b260711a30d363f833a2306a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f082a13ab756a378b260711a30d363f833a2306a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f082a13ab756a378b260711a30d363f833a2306a"
      }
    ],
    "stats": {
      "total": 13,
      "additions": 13,
      "deletions": 0
    },
    "files": [
      {
        "sha": "79a0ce75597891013bbc5ad0d3ce9ed7662a8f50",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 13,
        "deletions": 0,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d4a1ee8f1d4c46ab726be83965bd86bace2ec1ec/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d4a1ee8f1d4c46ab726be83965bd86bace2ec1ec/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=d4a1ee8f1d4c46ab726be83965bd86bace2ec1ec",
        "patch": "@@ -145,6 +145,15 @@ namespace {\n      * million to make it highly unlikely for users to have issues with this\n      * filter.\n      *\n+     * We only need to add wtxids to this filter. For non-segwit\n+     * transactions, the txid == wtxid, so this only prevents us from\n+     * re-downloading non-segwit transactions when communicating with\n+     * non-wtxidrelay peers -- which is important for avoiding malleation\n+     * attacks that could otherwise interfere with transaction relay from\n+     * non-wtxidrelay peers. For communicating with wtxidrelay peers, having\n+     * the reject filter store wtxids is exactly what we want to avoid\n+     * redownload of a rejected transaction.\n+     *\n      * Memory used: 1.3 MB\n      */\n     std::unique_ptr<CRollingBloomFilter> recentRejects GUARDED_BY(cs_main);\n@@ -2711,6 +2720,10 @@ bool ProcessMessage(CNode* pfrom, const std::string& msg_type, CDataStream& vRec\n                 LogPrint(BCLog::MEMPOOL, \"not keeping orphan with rejected parents %s\\n\",tx.GetHash().ToString());\n                 // We will continue to reject this tx since it has rejected\n                 // parents so avoid re-requesting it from other peers.\n+                // Here we add both the txid and the wtxid, as we know that\n+                // regardless of what witness is provided, we will not accept\n+                // this, so we don't need to allow for redownload of this txid\n+                // from any of our non-wtxidrelay peers.\n                 recentRejects->insert(tx.GetHash());\n                 recentRejects->insert(tx.GetWitnessHash());\n             }"
      }
    ]
  }
]