[
  {
    "sha": "4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0ZDRiZTRiYzJkMTQxZGQwODJlZDZlMTdhNDIyYjViOGEyMmQwNmVm",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-02-04T15:13:34Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-03-06T12:32:13Z"
      },
      "message": "rpc: Support specifying change address in bumpfee",
      "tree": {
        "sha": "37cf6bd3893715cb478745d3a779de0a74126401",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/37cf6bd3893715cb478745d3a779de0a74126401"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "4952a953585e99477a89989b009749e40c173013",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4952a953585e99477a89989b009749e40c173013",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/4952a953585e99477a89989b009749e40c173013"
      }
    ],
    "stats": {
      "total": 53,
      "additions": 41,
      "deletions": 12
    },
    "files": [
      {
        "sha": "220b04da6bb3d25d96732bfbe1cff69d11985aed",
        "filename": "src/wallet/feebumper.cpp",
        "status": "modified",
        "additions": 32,
        "deletions": 12,
        "changes": 44,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef/src/wallet/feebumper.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef/src/wallet/feebumper.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/feebumper.cpp?ref=4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef",
        "patch": "@@ -91,21 +91,41 @@ Result CreateTransaction(const CWallet* wallet, const uint256& txid, const CCoin\n         return result;\n     }\n \n-    // figure out which output was change\n-    // if there was no change output or multiple change outputs, fail\n     int nOutput = -1;\n-    for (size_t i = 0; i < wtx.tx->vout.size(); ++i) {\n-        if (wallet->IsChange(wtx.tx->vout[i])) {\n-            if (nOutput != -1) {\n-                errors.push_back(\"Transaction has multiple change outputs\");\n-                return Result::WALLET_ERROR;\n+    if (!boost::get<CNoDestination>(&coin_control.destChange)) {\n+        // Determine output index of the specified change address.\n+        // The specified change address must be spendable.\n+        if (!(IsMine(*wallet, coin_control.destChange) & ISMINE_SPENDABLE)) {\n+            errors.push_back(\"Invalid or non-wallet address\");\n+            return Result::INVALID_ADDRESS_OR_KEY;\n+        }\n+        CScript script_change = GetScriptForDestination(coin_control.destChange);\n+        for (size_t i = 0; i < wtx.tx->vout.size(); ++i) {\n+            if (wtx.tx->vout[i].scriptPubKey == script_change) {\n+                nOutput = i;\n+                break;\n             }\n-            nOutput = i;\n         }\n-    }\n-    if (nOutput == -1) {\n-        errors.push_back(\"Transaction does not have a change output\");\n-        return Result::WALLET_ERROR;\n+        if (nOutput == -1) {\n+            errors.push_back(\"Transaction does not have the specified change output\");\n+            return Result::WALLET_ERROR;\n+        }\n+    } else {\n+        // figure out which output was change\n+        // if there was no change output or multiple change outputs, fail\n+        for (size_t i = 0; i < wtx.tx->vout.size(); ++i) {\n+            if (wallet->IsChange(wtx.tx->vout[i])) {\n+                if (nOutput != -1) {\n+                    errors.push_back(\"Transaction has multiple change outputs\");\n+                    return Result::WALLET_ERROR;\n+                }\n+                nOutput = i;\n+            }\n+        }\n+        if (nOutput == -1) {\n+            errors.push_back(\"Transaction does not have a change output\");\n+            return Result::WALLET_ERROR;\n+        }\n     }\n \n     // Calculate the expected size of the new transaction."
      },
      {
        "sha": "14f250ffab4ce9aab4775545ca66907d917c75f5",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 0,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef",
        "patch": "@@ -3239,6 +3239,7 @@ static UniValue bumpfee(const JSONRPCRequest& request)\n             \"                         so the new transaction will not be explicitly bip-125 replaceable (though it may\\n\"\n             \"                         still be replaceable in practice, for example if it has unconfirmed ancestors which\\n\"\n             \"                         are replaceable).\"},\n+                            {\"change_address\", RPCArg::Type::STR_HEX, /* default */ \"fallback to the transaction change address, if any\", \"The change address to pay the fee bump\"},\n                             {\"estimate_mode\", RPCArg::Type::STR, /* default */ \"UNSET\", \"The fee estimate mode, must be one of:\\n\"\n             \"         \\\"UNSET\\\"\\n\"\n             \"         \\\"ECONOMICAL\\\"\\n\"\n@@ -3276,6 +3277,7 @@ static UniValue bumpfee(const JSONRPCRequest& request)\n                 {\"totalFee\", UniValueType(UniValue::VNUM)},\n                 {\"replaceable\", UniValueType(UniValue::VBOOL)},\n                 {\"estimate_mode\", UniValueType(UniValue::VSTR)},\n+                {\"change_address\", UniValueType(UniValue::VSTR)},\n             },\n             true, true);\n \n@@ -3298,6 +3300,13 @@ static UniValue bumpfee(const JSONRPCRequest& request)\n                 throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid estimate_mode parameter\");\n             }\n         }\n+        if (options.exists(\"change_address\")) {\n+            CTxDestination dest = DecodeDestination(options[\"change_address\"].get_str());\n+            if (!IsValidDestination(dest)) {\n+                throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"change_address must be a valid bitcoin address\");\n+            }\n+            coin_control.destChange = dest;\n+        }\n     }\n \n     // Make sure the results are valid at least up to the most recent block"
      }
    ]
  },
  {
    "sha": "7e5b136ddc808843a280659cd9c12e2f053a14a7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3ZTViMTM2ZGRjODA4ODQzYTI4MDY1OWNkOWMxMmUyZjA1M2ExNGE3",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-02-04T15:26:01Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-03-06T12:32:14Z"
      },
      "message": "qa: Test change_address option in bumpfee",
      "tree": {
        "sha": "44f70b299ec439aa3a6003c644abb8d54f15a0cb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/44f70b299ec439aa3a6003c644abb8d54f15a0cb"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7e5b136ddc808843a280659cd9c12e2f053a14a7",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7e5b136ddc808843a280659cd9c12e2f053a14a7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/7e5b136ddc808843a280659cd9c12e2f053a14a7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7e5b136ddc808843a280659cd9c12e2f053a14a7/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/4d4be4bc2d141dd082ed6e17a422b5b8a22d06ef"
      }
    ],
    "stats": {
      "total": 15,
      "additions": 15,
      "deletions": 0
    },
    "files": [
      {
        "sha": "399c62f8487d30e8379d3df057eb7b7e0f56072d",
        "filename": "test/functional/wallet_bumpfee.py",
        "status": "modified",
        "additions": 15,
        "deletions": 0,
        "changes": 15,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7e5b136ddc808843a280659cd9c12e2f053a14a7/test/functional/wallet_bumpfee.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7e5b136ddc808843a280659cd9c12e2f053a14a7/test/functional/wallet_bumpfee.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/wallet_bumpfee.py?ref=7e5b136ddc808843a280659cd9c12e2f053a14a7",
        "patch": "@@ -62,6 +62,7 @@ def run_test(self):\n         dest_address = peer_node.getnewaddress()\n         test_simple_bumpfee_succeeds(rbf_node, peer_node, dest_address)\n         test_segwit_bumpfee_succeeds(rbf_node, dest_address)\n+        test_change_address_succeeds(rbf_node, peer_node)\n         test_nonrbf_bumpfee_fails(peer_node, dest_address)\n         test_notmine_bumpfee_fails(rbf_node, peer_node, dest_address)\n         test_bumpfee_with_descendant_fails(rbf_node, rbf_node_address, dest_address)\n@@ -128,6 +129,20 @@ def test_segwit_bumpfee_succeeds(rbf_node, dest_address):\n     assert rbfid not in rbf_node.getrawmempool()\n \n \n+def test_change_address_succeeds(rbf_node, peer_node):\n+    dest_address = peer_node.getnewaddress()\n+    change_address = rbf_node.getnewaddress()\n+    hex = rbf_node.createrawtransaction([], {dest_address: '0.00100000'})\n+    tx = rbf_node.fundrawtransaction(hex, {'changeAddress': change_address})\n+    tx = rbf_node.signrawtransactionwithwallet(tx['hex'])\n+    txid = rbf_node.sendrawtransaction(tx['hex'])\n+    assert_raises_rpc_error(-4, 'Transaction does not have a change output', rbf_node.bumpfee, txid)\n+    assert_raises_rpc_error(-5, 'change_address must be a valid bitcoin address', rbf_node.bumpfee, txid, {'change_address': 'abc'})\n+    assert_raises_rpc_error(-5, 'Invalid or non-wallet address', rbf_node.bumpfee, txid, {'change_address': peer_node.getnewaddress()})\n+    assert_raises_rpc_error(-4, 'Transaction does not have the specified change output', rbf_node.bumpfee, txid, {'change_address': rbf_node.getnewaddress()})\n+    rbf_node.bumpfee(txid, {'change_address': change_address})\n+\n+\n def test_nonrbf_bumpfee_fails(peer_node, dest_address):\n     # cannot replace a non RBF transaction (from node which did not enable RBF)\n     not_rbfid = peer_node.sendtoaddress(dest_address, Decimal(\"0.00090000\"))"
      }
    ]
  },
  {
    "sha": "0843bde34e8b38a6a4d2b0435e9514d3d0a130e7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowODQzYmRlMzRlOGIzOGE2YTRkMmIwNDM1ZTk1MTRkM2QwYTEzMGU3",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-02-05T00:35:27Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-03-06T12:34:09Z"
      },
      "message": "doc: Add release note for new change_address option in bumpfee",
      "tree": {
        "sha": "014ace1c1f125612d1b4dc73cc681e50f1bf6f1c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/014ace1c1f125612d1b4dc73cc681e50f1bf6f1c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0843bde34e8b38a6a4d2b0435e9514d3d0a130e7",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0843bde34e8b38a6a4d2b0435e9514d3d0a130e7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/0843bde34e8b38a6a4d2b0435e9514d3d0a130e7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0843bde34e8b38a6a4d2b0435e9514d3d0a130e7/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "7e5b136ddc808843a280659cd9c12e2f053a14a7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7e5b136ddc808843a280659cd9c12e2f053a14a7",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/7e5b136ddc808843a280659cd9c12e2f053a14a7"
      }
    ],
    "stats": {
      "total": 7,
      "additions": 7,
      "deletions": 0
    },
    "files": [
      {
        "sha": "814c7e0d6348b3e3960489e084d125156bf4519a",
        "filename": "doc/release-15341.md",
        "status": "added",
        "additions": 7,
        "deletions": 0,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0843bde34e8b38a6a4d2b0435e9514d3d0a130e7/doc/release-15341.md",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0843bde34e8b38a6a4d2b0435e9514d3d0a130e7/doc/release-15341.md",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/doc/release-15341.md?ref=0843bde34e8b38a6a4d2b0435e9514d3d0a130e7",
        "patch": "@@ -0,0 +1,7 @@\n+Miscellaneous RPC changes\n+------------\n+\n+- The `bumpfee` RPC has now the option to specify the change address\n+  which is used to identify which output will pay the fee bump.\n+\n+"
      }
    ]
  }
]