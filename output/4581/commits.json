[
  {
    "sha": "886c2f1ed46bdb900b1f89dabc46cb0df26d54ea",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4ODZjMmYxZWQ0NmJkYjkwMGIxZjg5ZGFiYzQ2Y2IwZGYyNmQ1NGVh",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-07-01T08:55:26Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-07-24T03:28:47Z"
      },
      "message": "Improve getblocks (reception) logging",
      "tree": {
        "sha": "b74f57d81d494934468cc3251fded8eb45e89dd0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b74f57d81d494934468cc3251fded8eb45e89dd0"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/886c2f1ed46bdb900b1f89dabc46cb0df26d54ea",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/886c2f1ed46bdb900b1f89dabc46cb0df26d54ea",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/886c2f1ed46bdb900b1f89dabc46cb0df26d54ea",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/886c2f1ed46bdb900b1f89dabc46cb0df26d54ea/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "7bf8ab9dd3efb7ebc685e4ac02b05e6d5eba107d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7bf8ab9dd3efb7ebc685e4ac02b05e6d5eba107d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/7bf8ab9dd3efb7ebc685e4ac02b05e6d5eba107d"
      }
    ],
    "stats": {
      "total": 35,
      "additions": 23,
      "deletions": 12
    },
    "files": [
      {
        "sha": "72e4bd16d4bf3ef03c1bb756589ff05d070d9ff9",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 18,
        "deletions": 10,
        "changes": 28,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/886c2f1ed46bdb900b1f89dabc46cb0df26d54ea/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/886c2f1ed46bdb900b1f89dabc46cb0df26d54ea/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=886c2f1ed46bdb900b1f89dabc46cb0df26d54ea",
        "patch": "@@ -24,6 +24,8 @@\n #include <boost/filesystem.hpp>\n #include <boost/filesystem/fstream.hpp>\n \n+#define MAX_BLOCK_INVS 500\n+\n using namespace std;\n using namespace boost;\n \n@@ -3752,29 +3754,35 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n         // Find the last block the caller has in the main chain\n         CBlockIndex* pindex = chainActive.FindFork(locator);\n+        CBlockIndex* pindexStart;\n+        CBlockIndex* pindexEnd;\n \n         // Send the rest of the chain\n+        int nLimit = MAX_BLOCK_INVS;\n+        LogPrint(\"net\", \"getblocks %d to %s from peer=%d\\n\", (pindex ? pindex->nHeight : -1), hashStop==uint256(0) ? \"end\" : hashStop.ToString(), pfrom->id);\n         if (pindex)\n             pindex = chainActive.Next(pindex);\n-        int nLimit = 500;\n-        LogPrint(\"net\", \"getblocks %d to %s limit %d from peer=%d\\n\", (pindex ? pindex->nHeight : -1), hashStop==uint256(0) ? \"end\" : hashStop.ToString(), nLimit, pfrom->id);\n-        for (; pindex; pindex = chainActive.Next(pindex))\n-        {\n+        pindexStart = 0;\n+        pindexEnd = 0;\n+        int nCount = 0;\n+        for (; pindex; pindex = chainActive.Next(pindex)) {\n             if (pindex->GetBlockHash() == hashStop)\n-            {\n-                LogPrint(\"net\", \"  getblocks stopping at %d %s\\n\", pindex->nHeight, pindex->GetBlockHash().ToString());\n                 break;\n+            if (pfrom->PushInventory(CInv(MSG_BLOCK, pindex->GetBlockHash()))) {\n+                nCount++;\n+                if (pindexStart == 0) pindexStart = pindex;\n+                pindexEnd = pindex;\n             }\n-            pfrom->PushInventory(CInv(MSG_BLOCK, pindex->GetBlockHash()));\n-            if (--nLimit <= 0)\n-            {\n+            if (--nLimit <= 0) {\n                 // When this block is requested, we'll send an inv that'll make them\n                 // getblocks the next batch of inventory.\n-                LogPrint(\"net\", \"  getblocks stopping at limit %d %s\\n\", pindex->nHeight, pindex->GetBlockHash().ToString());\n                 pfrom->hashContinue = pindex->GetBlockHash();\n                 break;\n             }\n         }\n+        if (pindexEnd != 0)\n+            LogPrint(\"net\", \"sending %d block invs (height %d to %d) to peer=%d\\n\",\n+              nCount, pindexStart->nHeight, pindexEnd->nHeight, pfrom->id);\n     }\n \n "
      },
      {
        "sha": "0f403419a37201c4c51632cc8bfec15a673448c8",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 5,
        "deletions": 2,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/886c2f1ed46bdb900b1f89dabc46cb0df26d54ea/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/886c2f1ed46bdb900b1f89dabc46cb0df26d54ea/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=886c2f1ed46bdb900b1f89dabc46cb0df26d54ea",
        "patch": "@@ -442,12 +442,15 @@ class CNode\n         }\n     }\n \n-    void PushInventory(const CInv& inv)\n+    bool PushInventory(const CInv& inv)\n     {\n         {\n             LOCK(cs_inventory);\n-            if (!setInventoryKnown.count(inv))\n+            if (!setInventoryKnown.count(inv)) {\n                 vInventoryToSend.push_back(inv);\n+                return true;\n+            } else\n+                return false;\n         }\n     }\n "
      }
    ]
  },
  {
    "sha": "465a13c0bac5470cf4199fcdfe2c2b3eaec476c6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0NjVhMTNjMGJhYzU0NzBjZjQxOTlmY2RmZTJjMmIzZWFlYzQ3NmM2",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-07-24T03:18:38Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2014-07-24T03:28:49Z"
      },
      "message": "Only respond to getblocks requests that are asking for substantially newer block invs.",
      "tree": {
        "sha": "ec5f8c76f10afe46735b3960a3ea5a5cc8a00c69",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ec5f8c76f10afe46735b3960a3ea5a5cc8a00c69"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/465a13c0bac5470cf4199fcdfe2c2b3eaec476c6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/465a13c0bac5470cf4199fcdfe2c2b3eaec476c6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/465a13c0bac5470cf4199fcdfe2c2b3eaec476c6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/465a13c0bac5470cf4199fcdfe2c2b3eaec476c6/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "886c2f1ed46bdb900b1f89dabc46cb0df26d54ea",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/886c2f1ed46bdb900b1f89dabc46cb0df26d54ea",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/886c2f1ed46bdb900b1f89dabc46cb0df26d54ea"
      }
    ],
    "stats": {
      "total": 11,
      "additions": 10,
      "deletions": 1
    },
    "files": [
      {
        "sha": "83dfee853fd3dccb13ccd5abe608a31ddf38a8f5",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 1,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/465a13c0bac5470cf4199fcdfe2c2b3eaec476c6/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/465a13c0bac5470cf4199fcdfe2c2b3eaec476c6/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=465a13c0bac5470cf4199fcdfe2c2b3eaec476c6",
        "patch": "@@ -220,6 +220,7 @@ struct CNodeState {\n     int nBlocksToDownload;\n     int64_t nLastBlockReceive;\n     int64_t nLastBlockProcess;\n+    int nLastBlockInvHeight;   // Height of last block inv sent.\n \n     CNodeState() {\n         nMisbehavior = 0;\n@@ -230,6 +231,7 @@ struct CNodeState {\n         nBlocksInFlight = 0;\n         nLastBlockReceive = 0;\n         nLastBlockProcess = 0;\n+        nLastBlockInvHeight = 0;\n     }\n };\n \n@@ -3749,6 +3751,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         CBlockLocator locator;\n         uint256 hashStop;\n         vRecv >> locator >> hashStop;\n+        int nLastEnd = State(pfrom->id)->nLastBlockInvHeight;\n \n         LOCK(cs_main);\n \n@@ -3757,6 +3760,10 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         CBlockIndex* pindexStart;\n         CBlockIndex* pindexEnd;\n \n+        // Only accommodate getblocks requests starting from a height just below the last height reached.\n+        if (!pindex || pindex->nHeight < nLastEnd - 2)\n+            return true;\n+\n         // Send the rest of the chain\n         int nLimit = MAX_BLOCK_INVS;\n         LogPrint(\"net\", \"getblocks %d to %s from peer=%d\\n\", (pindex ? pindex->nHeight : -1), hashStop==uint256(0) ? \"end\" : hashStop.ToString(), pfrom->id);\n@@ -3780,9 +3787,11 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                 break;\n             }\n         }\n-        if (pindexEnd != 0)\n+        if (pindexEnd != 0) {\n             LogPrint(\"net\", \"sending %d block invs (height %d to %d) to peer=%d\\n\",\n               nCount, pindexStart->nHeight, pindexEnd->nHeight, pfrom->id);\n+            State(pfrom->id)->nLastBlockInvHeight = pindexEnd->nHeight;\n+        }\n     }\n \n "
      }
    ]
  }
]