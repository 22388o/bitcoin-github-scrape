[
  {
    "sha": "1c6b787e0319c44f0e0bede3f4a77ac7c2089db2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxYzZiNzg3ZTAzMTljNDRmMGUwYmVkZTNmNGE3N2FjN2MyMDg5ZGIy",
    "commit": {
      "author": {
        "name": "gzhao408",
        "email": "gzhao408@berkeley.edu",
        "date": "2020-06-03T23:28:43Z"
      },
      "committer": {
        "name": "gzhao408",
        "email": "gzhao408@berkeley.edu",
        "date": "2020-06-14T18:47:12Z"
      },
      "message": "[netprocessing] disconnect node that sends filterclear\n\n-nodes not serving bloomfilters should disconnect peers\nthat send filterclear, just like filteradd and filterload\n-nodes that want to enable/disable txrelay should use\nfeefilter",
      "tree": {
        "sha": "5a5289253d5cce1cbe2634e0113136929e7ec9d4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5a5289253d5cce1cbe2634e0113136929e7ec9d4"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1c6b787e0319c44f0e0bede3f4a77ac7c2089db2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1c6b787e0319c44f0e0bede3f4a77ac7c2089db2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1c6b787e0319c44f0e0bede3f4a77ac7c2089db2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1c6b787e0319c44f0e0bede3f4a77ac7c2089db2/comments",
    "author": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b33136b6ba9887f7db651c4c5264ca7f2f601df7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b33136b6ba9887f7db651c4c5264ca7f2f601df7",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b33136b6ba9887f7db651c4c5264ca7f2f601df7"
      }
    ],
    "stats": {
      "total": 8,
      "additions": 5,
      "deletions": 3
    },
    "files": [
      {
        "sha": "8e8a84e4e277b6f2f5a11a17dacb24d7cc86c9ca",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 3,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1c6b787e0319c44f0e0bede3f4a77ac7c2089db2/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1c6b787e0319c44f0e0bede3f4a77ac7c2089db2/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=1c6b787e0319c44f0e0bede3f4a77ac7c2089db2",
        "patch": "@@ -3490,13 +3490,15 @@ bool ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRec\n     }\n \n     if (msg_type == NetMsgType::FILTERCLEAR) {\n+        if (!(pfrom.GetLocalServices() & NODE_BLOOM)) {\n+            pfrom.fDisconnect = true;\n+            return true;\n+        }\n         if (pfrom.m_tx_relay == nullptr) {\n             return true;\n         }\n         LOCK(pfrom.m_tx_relay->cs_filter);\n-        if (pfrom.GetLocalServices() & NODE_BLOOM) {\n-            pfrom.m_tx_relay->pfilter = nullptr;\n-        }\n+        pfrom.m_tx_relay->pfilter = nullptr;\n         pfrom.m_tx_relay->fRelayTxes = true;\n         return true;\n     }"
      }
    ]
  },
  {
    "sha": "ff8c430c6589ea72b9e169455cf6437c8623cc52",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmZjhjNDMwYzY1ODllYTcyYjllMTY5NDU1Y2Y2NDM3Yzg2MjNjYzUy",
    "commit": {
      "author": {
        "name": "gzhao408",
        "email": "gzhao408@berkeley.edu",
        "date": "2020-06-12T16:30:42Z"
      },
      "committer": {
        "name": "gzhao408",
        "email": "gzhao408@berkeley.edu",
        "date": "2020-06-14T18:47:49Z"
      },
      "message": "[test] test disconnect for filterclear",
      "tree": {
        "sha": "8f227be52d7ad5eae2771b9fd2c51428a4e128d8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8f227be52d7ad5eae2771b9fd2c51428a4e128d8"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ff8c430c6589ea72b9e169455cf6437c8623cc52",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ff8c430c6589ea72b9e169455cf6437c8623cc52",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ff8c430c6589ea72b9e169455cf6437c8623cc52",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ff8c430c6589ea72b9e169455cf6437c8623cc52/comments",
    "author": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1c6b787e0319c44f0e0bede3f4a77ac7c2089db2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1c6b787e0319c44f0e0bede3f4a77ac7c2089db2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1c6b787e0319c44f0e0bede3f4a77ac7c2089db2"
      }
    ],
    "stats": {
      "total": 6,
      "additions": 5,
      "deletions": 1
    },
    "files": [
      {
        "sha": "8478a752e7feb6ba810d0f201d7b51e9854c7ed9",
        "filename": "test/functional/p2p_nobloomfilter_messages.py",
        "status": "modified",
        "additions": 5,
        "deletions": 1,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ff8c430c6589ea72b9e169455cf6437c8623cc52/test/functional/p2p_nobloomfilter_messages.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ff8c430c6589ea72b9e169455cf6437c8623cc52/test/functional/p2p_nobloomfilter_messages.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_nobloomfilter_messages.py?ref=ff8c430c6589ea72b9e169455cf6437c8623cc52",
        "patch": "@@ -8,9 +8,10 @@\n 1. They send a p2p mempool message\n 2. They send a p2p filterload message\n 3. They send a p2p filteradd message\n+4. They send a p2p filterclear message\n \"\"\"\n \n-from test_framework.messages import msg_mempool, msg_filteradd, msg_filterload\n+from test_framework.messages import msg_mempool, msg_filteradd, msg_filterload, msg_filterclear\n from test_framework.mininode import P2PInterface\n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.util import assert_equal\n@@ -39,5 +40,8 @@ def run_test(self):\n         self.log.info(\"Test that node is disconnected if it sends filteradd message\")\n         self.test_message_causes_disconnect(msg_filteradd(data=b'\\xcc'))\n \n+        self.log.info(\"Test that peer is disconnected if it sends a filterclear message\")\n+        self.test_message_causes_disconnect(msg_filterclear())\n+\n if __name__ == '__main__':\n     P2PNobloomfilterMessages().main()"
      }
    ]
  },
  {
    "sha": "3a10d935ac8ebabdfd336569d943f042ff84b13e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozYTEwZDkzNWFjOGViYWJkZmQzMzY1NjlkOTQzZjA0MmZmODRiMTNl",
    "commit": {
      "author": {
        "name": "gzhao408",
        "email": "gzhao408@berkeley.edu",
        "date": "2020-06-12T20:21:18Z"
      },
      "committer": {
        "name": "gzhao408",
        "email": "gzhao408@berkeley.edu",
        "date": "2020-06-14T18:48:17Z"
      },
      "message": "[p2p/refactor] move disconnect logic and remove misbehaving\n\n-Increasing the banscore and/or banning is too harsh,\njust disconnecting is enough.\n-Return true from ProcessMessage because we already log\nreceipt of filterclear and disconnect.",
      "tree": {
        "sha": "be4be5c44d6308011246c5f39c1756bf0a558015",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/be4be5c44d6308011246c5f39c1756bf0a558015"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3a10d935ac8ebabdfd336569d943f042ff84b13e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3a10d935ac8ebabdfd336569d943f042ff84b13e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/3a10d935ac8ebabdfd336569d943f042ff84b13e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3a10d935ac8ebabdfd336569d943f042ff84b13e/comments",
    "author": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ff8c430c6589ea72b9e169455cf6437c8623cc52",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ff8c430c6589ea72b9e169455cf6437c8623cc52",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ff8c430c6589ea72b9e169455cf6437c8623cc52"
      }
    ],
    "stats": {
      "total": 22,
      "additions": 8,
      "deletions": 14
    },
    "files": [
      {
        "sha": "aa5c9668e3bc7301099fb87032626b1a207b4a8e",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 14,
        "changes": 22,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/3a10d935ac8ebabdfd336569d943f042ff84b13e/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/3a10d935ac8ebabdfd336569d943f042ff84b13e/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=3a10d935ac8ebabdfd336569d943f042ff84b13e",
        "patch": "@@ -2215,20 +2215,6 @@ bool ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRec\n     }\n \n \n-    if (!(pfrom.GetLocalServices() & NODE_BLOOM) &&\n-              (msg_type == NetMsgType::FILTERLOAD ||\n-               msg_type == NetMsgType::FILTERADD))\n-    {\n-        if (pfrom.nVersion >= NO_BLOOM_VERSION) {\n-            LOCK(cs_main);\n-            Misbehaving(pfrom.GetId(), 100);\n-            return false;\n-        } else {\n-            pfrom.fDisconnect = true;\n-            return false;\n-        }\n-    }\n-\n     if (msg_type == NetMsgType::VERSION) {\n         // Each connection can only send one version message\n         if (pfrom.nVersion != 0)\n@@ -3447,6 +3433,10 @@ bool ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRec\n     }\n \n     if (msg_type == NetMsgType::FILTERLOAD) {\n+        if (!(pfrom.GetLocalServices() & NODE_BLOOM)) {\n+            pfrom.fDisconnect = true;\n+            return true;\n+        }\n         CBloomFilter filter;\n         vRecv >> filter;\n \n@@ -3466,6 +3456,10 @@ bool ProcessMessage(CNode& pfrom, const std::string& msg_type, CDataStream& vRec\n     }\n \n     if (msg_type == NetMsgType::FILTERADD) {\n+        if (!(pfrom.GetLocalServices() & NODE_BLOOM)) {\n+            pfrom.fDisconnect = true;\n+            return true;\n+        }\n         std::vector<unsigned char> vData;\n         vRecv >> vData;\n "
      }
    ]
  }
]