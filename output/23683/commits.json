[
  {
    "sha": "b6002b07a36f0d58dc6becd04bfcf78599056b7c",
    "node_id": "C_kwDOABII59oAKGI2MDAyYjA3YTM2ZjBkNThkYzZiZWNkMDRiZmNmNzg1OTkwNTZiN2M",
    "commit": {
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2021-12-03T18:00:00Z"
      },
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2021-12-06T15:29:59Z"
      },
      "message": "MOVEONLY: update_lock_points to txmempool.h",
      "tree": {
        "sha": "cea819b0b8513da2761e194c39b90afb989e360a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cea819b0b8513da2761e194c39b90afb989e360a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b6002b07a36f0d58dc6becd04bfcf78599056b7c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b6002b07a36f0d58dc6becd04bfcf78599056b7c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b6002b07a36f0d58dc6becd04bfcf78599056b7c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b6002b07a36f0d58dc6becd04bfcf78599056b7c/comments",
    "author": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "d20d6ac545159fb98bd9ac828678ddf20f5d016d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d20d6ac545159fb98bd9ac828678ddf20f5d016d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/d20d6ac545159fb98bd9ac828678ddf20f5d016d"
      }
    ],
    "stats": {
      "total": 20,
      "additions": 10,
      "deletions": 10
    },
    "files": [
      {
        "sha": "ba1bdb197bacf051065bbd460b48e2b110a66709",
        "filename": "src/txmempool.cpp",
        "status": "modified",
        "additions": 0,
        "deletions": 10,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b6002b07a36f0d58dc6becd04bfcf78599056b7c/src/txmempool.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b6002b07a36f0d58dc6becd04bfcf78599056b7c/src/txmempool.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txmempool.cpp?ref=b6002b07a36f0d58dc6becd04bfcf78599056b7c",
        "patch": "@@ -64,16 +64,6 @@ struct update_fee_delta\n     int64_t feeDelta;\n };\n \n-struct update_lock_points\n-{\n-    explicit update_lock_points(const LockPoints& _lp) : lp(_lp) { }\n-\n-    void operator() (CTxMemPoolEntry &e) { e.UpdateLockPoints(lp); }\n-\n-private:\n-    const LockPoints& lp;\n-};\n-\n bool TestLockPointValidity(CChain& active_chain, const LockPoints& lp)\n {\n     AssertLockHeld(cs_main);"
      },
      {
        "sha": "ba1d381a5cc634e44e02f2d2b10278d518d80e8b",
        "filename": "src/txmempool.h",
        "status": "modified",
        "additions": 10,
        "deletions": 0,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b6002b07a36f0d58dc6becd04bfcf78599056b7c/src/txmempool.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b6002b07a36f0d58dc6becd04bfcf78599056b7c/src/txmempool.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txmempool.h?ref=b6002b07a36f0d58dc6becd04bfcf78599056b7c",
        "patch": "@@ -312,6 +312,16 @@ class CompareTxMemPoolEntryByAncestorFee\n     }\n };\n \n+struct update_lock_points\n+{\n+    explicit update_lock_points(const LockPoints& _lp) : lp(_lp) { }\n+\n+    void operator() (CTxMemPoolEntry &e) { e.UpdateLockPoints(lp); }\n+\n+private:\n+    const LockPoints& lp;\n+};\n+\n // Multi_index tag names\n struct descendant_score {};\n struct entry_time {};"
      }
    ]
  },
  {
    "sha": "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
    "node_id": "C_kwDOABII59oAKGI0YWRjNWFkNjc2OWU0YTVhNjE3OWRmZmYyNzFjZDRjOWRjNDdhNWI",
    "commit": {
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2021-12-03T18:03:16Z"
      },
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2021-12-06T15:30:06Z"
      },
      "message": "[bugfix] update lockpoints correctly during reorg\n\nDuring a reorg, we re-check timelocks on all mempool entries using\nCheckSequenceLocks(useExistingLockPoints=false) and remove any\nnow-invalid entries. CheckSequenceLocks() also mutates the LockPoints\npassed in, and we update valid entries' LockPoints using\nupdate_lock_points. Thus, update_lock_points(lp) needs to be called\nright after CheckSequenceLocks(lp), otherwise we lose the data in lp.\ncommit bedf246 introduced a bug by separating those two loops.",
      "tree": {
        "sha": "f1480b9141908f2299d160790de098bc7590159b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f1480b9141908f2299d160790de098bc7590159b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b/comments",
    "author": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b6002b07a36f0d58dc6becd04bfcf78599056b7c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b6002b07a36f0d58dc6becd04bfcf78599056b7c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b6002b07a36f0d58dc6becd04bfcf78599056b7c"
      }
    ],
    "stats": {
      "total": 7,
      "additions": 3,
      "deletions": 4
    },
    "files": [
      {
        "sha": "26cb2ff4b428c3a69f0679b888ab10175727f1fb",
        "filename": "src/txmempool.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 4,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b/src/txmempool.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b/src/txmempool.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txmempool.cpp?ref=b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
        "patch": "@@ -639,10 +639,7 @@ void CTxMemPool::removeForReorg(CChain& chain, std::function<bool(txiter)> check\n     }\n     RemoveStaged(setAllRemoves, false, MemPoolRemovalReason::REORG);\n     for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n-        const LockPoints lp{it->GetLockPoints()};\n-        if (!TestLockPointValidity(chain, lp)) {\n-            mapTx.modify(it, update_lock_points(lp));\n-        }\n+        assert(TestLockPointValidity(chain, it->GetLockPoints()));\n     }\n }\n "
      },
      {
        "sha": "68729e48637fc57d7f7b83f1ea0b55f34c041def",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
        "patch": "@@ -378,6 +378,8 @@ void CChainState::MaybeUpdateMempoolForReorg(\n                 }\n             }\n         }\n+        // CheckSequenceLocks updates lp. Update the mempool entry LockPoints.\n+        if (!validLP) m_mempool->mapTx.modify(it, update_lock_points(lp));\n         return should_remove;\n     };\n "
      }
    ]
  },
  {
    "sha": "28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
    "node_id": "C_kwDOABII59oAKDI4YjYwY2UzMTIyYjI5ZmZhZDJjNjA3OTBkM2JmZTlhMmVkZTI0NzE",
    "commit": {
      "author": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2021-12-06T11:00:12Z"
      },
      "committer": {
        "name": "glozow",
        "email": "gloriajzhao@gmail.com",
        "date": "2021-12-06T15:31:30Z"
      },
      "message": "[test] natural reorg where entry remains final but lockpoints change",
      "tree": {
        "sha": "1a96d7db1d24ad6faa39cc4c714e27f31a63c975",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1a96d7db1d24ad6faa39cc4c714e27f31a63c975"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/28b60ce3122b29ffad2c60790d3bfe9a2ede2471/comments",
    "author": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b4adc5ad6769e4a5a6179dfff271cd4c9dc47a5b"
      }
    ],
    "stats": {
      "total": 31,
      "additions": 31,
      "deletions": 0
    },
    "files": [
      {
        "sha": "f8405172e6c7a669bb6e1898f2c384671653f817",
        "filename": "test/functional/mempool_reorg.py",
        "status": "modified",
        "additions": 31,
        "deletions": 0,
        "changes": 31,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/28b60ce3122b29ffad2c60790d3bfe9a2ede2471/test/functional/mempool_reorg.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/28b60ce3122b29ffad2c60790d3bfe9a2ede2471/test/functional/mempool_reorg.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/mempool_reorg.py?ref=28b60ce3122b29ffad2c60790d3bfe9a2ede2471",
        "patch": "@@ -108,6 +108,37 @@ def run_test(self):\n         assert_equal(set(self.nodes[0].getrawmempool()), set())\n         self.sync_all()\n \n+        self.log.info(\"Simulate a natural reorg where mempool transaction stays valid but on a different block\")\n+        self.connect_nodes(0, 1)\n+        # Mine a block to create mature coinbase\n+        self.generate(self.nodes[0], 2)\n+        # Create another transaction which is time-locked to two blocks in the future\n+        timelock_tx_2 = wallet.create_self_transfer(\n+            from_node=self.nodes[0],\n+            mempool_valid=False,\n+            locktime=self.nodes[0].getblockcount() + 2,\n+        )['hex']\n+        # Check that the time-locked transaction is too immature to spend\n+        assert_raises_rpc_error(-26, \"non-final\", self.nodes[0].sendrawtransaction, timelock_tx_2)\n+        assert_raises_rpc_error(-26, \"non-final\", self.nodes[1].sendrawtransaction, timelock_tx_2)\n+\n+        self.log.info(\"Disconnect nodes and mine separate forks\")\n+        self.disconnect_nodes(0, 1)\n+        # Don't try to sync nodes because they are disconnected\n+        self.generate(self.nodes[0], 2, sync_fun=self.no_op)\n+        self.generate(self.nodes[1], 5, sync_fun=self.no_op)\n+        more_work_height = self.nodes[1].getblockcount()\n+        # Submit timelocked transaction to both nodes' mempools. They should both be final now, but\n+        # they became final at different blocks (LockPoints are different).\n+        self.nodes[0].sendrawtransaction(timelock_tx_2)\n+        self.nodes[1].sendrawtransaction(timelock_tx_2)\n+        self.log.info(\"Reconnect nodes to trigger natural reorg in node0\")\n+        self.connect_nodes(0, 1)\n+        self.sync_all()\n+        assert_equal(self.nodes[0].getblockcount(), self.nodes[1].getblockcount())\n+        assert_equal(self.nodes[0].getblockcount(), more_work_height)\n+        assert_equal(set(self.nodes[0].getrawmempool()), set(self.nodes[0].getrawmempool()))\n+\n \n if __name__ == '__main__':\n     MempoolCoinbaseTest().main()"
      }
    ]
  }
]