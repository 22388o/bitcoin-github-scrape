[
  {
    "sha": "264c64380978d7b0bd3ecb56a861eb004cc58b01",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyNjRjNjQzODA5NzhkN2IwYmQzZWNiNTZhODYxZWIwMDRjYzU4YjAx",
    "commit": {
      "author": {
        "name": "Tim Ruffing",
        "email": "crypto@timruffing.de",
        "date": "2018-05-03T15:45:51Z"
      },
      "committer": {
        "name": "Tim Ruffing",
        "email": "crypto@timruffing.de",
        "date": "2018-05-03T17:15:11Z"
      },
      "message": "wallet: Reset BerkeleyDB handle after connection fails\n\nAccording to the BerkeleyDB docs, the DbEnv handle may not be accessed\nafter close() has been called. This change ensures that we create a new\nhandle after close() is called. This avoids a segfault when the first\nconnection attempt fails and then a second connection attempt tries to\ncall open() on the already closed DbEnv handle.",
      "tree": {
        "sha": "03438990ead1c785bec2a2775ae424d1d3c07441",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/03438990ead1c785bec2a2775ae424d1d3c07441"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/264c64380978d7b0bd3ecb56a861eb004cc58b01",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYIAB0WIQR/BPrrnsbSRxvha9Tqz/dys4s0eQUCWutDyQAKCRDqz/dys4s0\neREAAP4nxipZ2zNyc2nYPMIf4IBXGAsau83FfO8XJr3nwwmyiAEAzMB4vgyaltVW\nY4Mb3+MXYSB4sK2Al5vLg0D/lno/qgA=\n=2+6A\n-----END PGP SIGNATURE-----",
        "payload": "tree 03438990ead1c785bec2a2775ae424d1d3c07441\nparent a024a1841d6229ef5ed5d9d92b0b320bbf34fb5c\nauthor Tim Ruffing <crypto@timruffing.de> 1525362351 +0200\ncommitter Tim Ruffing <crypto@timruffing.de> 1525367711 +0200\n\nwallet: Reset BerkeleyDB handle after connection fails\n\nAccording to the BerkeleyDB docs, the DbEnv handle may not be accessed\nafter close() has been called. This change ensures that we create a new\nhandle after close() is called. This avoids a segfault when the first\nconnection attempt fails and then a second connection attempt tries to\ncall open() on the already closed DbEnv handle.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/264c64380978d7b0bd3ecb56a861eb004cc58b01",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/264c64380978d7b0bd3ecb56a861eb004cc58b01",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/264c64380978d7b0bd3ecb56a861eb004cc58b01/comments",
    "author": {
      "login": "real-or-random",
      "id": 1071625,
      "node_id": "MDQ6VXNlcjEwNzE2MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1071625?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/real-or-random",
      "html_url": "https://github.com/real-or-random",
      "followers_url": "https://api.github.com/users/real-or-random/followers",
      "following_url": "https://api.github.com/users/real-or-random/following{/other_user}",
      "gists_url": "https://api.github.com/users/real-or-random/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/real-or-random/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/real-or-random/subscriptions",
      "organizations_url": "https://api.github.com/users/real-or-random/orgs",
      "repos_url": "https://api.github.com/users/real-or-random/repos",
      "events_url": "https://api.github.com/users/real-or-random/events{/privacy}",
      "received_events_url": "https://api.github.com/users/real-or-random/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "real-or-random",
      "id": 1071625,
      "node_id": "MDQ6VXNlcjEwNzE2MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1071625?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/real-or-random",
      "html_url": "https://github.com/real-or-random",
      "followers_url": "https://api.github.com/users/real-or-random/followers",
      "following_url": "https://api.github.com/users/real-or-random/following{/other_user}",
      "gists_url": "https://api.github.com/users/real-or-random/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/real-or-random/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/real-or-random/subscriptions",
      "organizations_url": "https://api.github.com/users/real-or-random/orgs",
      "repos_url": "https://api.github.com/users/real-or-random/repos",
      "events_url": "https://api.github.com/users/real-or-random/events{/privacy}",
      "received_events_url": "https://api.github.com/users/real-or-random/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "a024a1841d6229ef5ed5d9d92b0b320bbf34fb5c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a024a1841d6229ef5ed5d9d92b0b320bbf34fb5c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/a024a1841d6229ef5ed5d9d92b0b320bbf34fb5c"
      }
    ],
    "stats": {
      "total": 1,
      "additions": 1,
      "deletions": 0
    },
    "files": [
      {
        "sha": "adf6944280f36faca7e77cbc5d4691cb6d858f75",
        "filename": "src/wallet/db.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/264c64380978d7b0bd3ecb56a861eb004cc58b01/src/wallet/db.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/264c64380978d7b0bd3ecb56a861eb004cc58b01/src/wallet/db.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/db.cpp?ref=264c64380978d7b0bd3ecb56a861eb004cc58b01",
        "patch": "@@ -169,6 +169,7 @@ bool BerkeleyEnvironment::Open(bool retry)\n                          S_IRUSR | S_IWUSR);\n     if (ret != 0) {\n         dbenv->close(0);\n+        Reset();\n         LogPrintf(\"BerkeleyEnvironment::Open: Error %d opening database environment: %s\\n\", ret, DbEnv::strerror(ret));\n         if (retry) {\n             // try moving the database env out of the way"
      }
    ]
  },
  {
    "sha": "b6f0b4d8595df0241a6499cd57e7ddac56558bf1",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiNmYwYjRkODU5NWRmMDI0MWE2NDk5Y2Q1N2U3ZGRhYzU2NTU4YmYx",
    "commit": {
      "author": {
        "name": "Tim Ruffing",
        "email": "crypto@timruffing.de",
        "date": "2018-05-08T22:20:12Z"
      },
      "committer": {
        "name": "Tim Ruffing",
        "email": "crypto@timruffing.de",
        "date": "2018-05-09T13:23:16Z"
      },
      "message": "wallet: Improve logging when BerkeleyDB environment fails to close",
      "tree": {
        "sha": "7e85cbb1f2ecbcd9d7187faee4b0fe4cc5d6af35",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7e85cbb1f2ecbcd9d7187faee4b0fe4cc5d6af35"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b6f0b4d8595df0241a6499cd57e7ddac56558bf1",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niHUEABYIAB0WIQR/BPrrnsbSRxvha9Tqz/dys4s0eQUCWvL2RAAKCRDqz/dys4s0\neRA+AP9b4xlUceILNch1z/sDWNdFNkodoCqAuEcOeXHmVEAEvwD9HXWk9Nh4MPwS\nCdrs/C510ZsmjKjfpqODaCmbAISTsgk=\n=H8OZ\n-----END PGP SIGNATURE-----",
        "payload": "tree 7e85cbb1f2ecbcd9d7187faee4b0fe4cc5d6af35\nparent 264c64380978d7b0bd3ecb56a861eb004cc58b01\nauthor Tim Ruffing <crypto@timruffing.de> 1525818012 +0200\ncommitter Tim Ruffing <crypto@timruffing.de> 1525872196 +0200\n\nwallet: Improve logging when BerkeleyDB environment fails to close\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b6f0b4d8595df0241a6499cd57e7ddac56558bf1",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b6f0b4d8595df0241a6499cd57e7ddac56558bf1",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b6f0b4d8595df0241a6499cd57e7ddac56558bf1/comments",
    "author": {
      "login": "real-or-random",
      "id": 1071625,
      "node_id": "MDQ6VXNlcjEwNzE2MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1071625?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/real-or-random",
      "html_url": "https://github.com/real-or-random",
      "followers_url": "https://api.github.com/users/real-or-random/followers",
      "following_url": "https://api.github.com/users/real-or-random/following{/other_user}",
      "gists_url": "https://api.github.com/users/real-or-random/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/real-or-random/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/real-or-random/subscriptions",
      "organizations_url": "https://api.github.com/users/real-or-random/orgs",
      "repos_url": "https://api.github.com/users/real-or-random/repos",
      "events_url": "https://api.github.com/users/real-or-random/events{/privacy}",
      "received_events_url": "https://api.github.com/users/real-or-random/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "real-or-random",
      "id": 1071625,
      "node_id": "MDQ6VXNlcjEwNzE2MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1071625?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/real-or-random",
      "html_url": "https://github.com/real-or-random",
      "followers_url": "https://api.github.com/users/real-or-random/followers",
      "following_url": "https://api.github.com/users/real-or-random/following{/other_user}",
      "gists_url": "https://api.github.com/users/real-or-random/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/real-or-random/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/real-or-random/subscriptions",
      "organizations_url": "https://api.github.com/users/real-or-random/orgs",
      "repos_url": "https://api.github.com/users/real-or-random/repos",
      "events_url": "https://api.github.com/users/real-or-random/events{/privacy}",
      "received_events_url": "https://api.github.com/users/real-or-random/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "264c64380978d7b0bd3ecb56a861eb004cc58b01",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/264c64380978d7b0bd3ecb56a861eb004cc58b01",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/264c64380978d7b0bd3ecb56a861eb004cc58b01"
      }
    ],
    "stats": {
      "total": 9,
      "additions": 6,
      "deletions": 3
    },
    "files": [
      {
        "sha": "7e75ee7ad188034773b4eb663ef867bf1ca55064",
        "filename": "src/wallet/db.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 3,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b6f0b4d8595df0241a6499cd57e7ddac56558bf1/src/wallet/db.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b6f0b4d8595df0241a6499cd57e7ddac56558bf1/src/wallet/db.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/db.cpp?ref=b6f0b4d8595df0241a6499cd57e7ddac56558bf1",
        "patch": "@@ -102,7 +102,7 @@ void BerkeleyEnvironment::Close()\n \n     int ret = dbenv->close(0);\n     if (ret != 0)\n-        LogPrintf(\"BerkeleyEnvironment::EnvShutdown: Error %d shutting down database environment: %s\\n\", ret, DbEnv::strerror(ret));\n+        LogPrintf(\"BerkeleyEnvironment::Close: Error %d closing database environment: %s\\n\", ret, DbEnv::strerror(ret));\n     if (!fMockDb)\n         DbEnv((u_int32_t)0).remove(strPath.c_str(), 0);\n }\n@@ -168,9 +168,12 @@ bool BerkeleyEnvironment::Open(bool retry)\n                              nEnvFlags,\n                          S_IRUSR | S_IWUSR);\n     if (ret != 0) {\n-        dbenv->close(0);\n-        Reset();\n         LogPrintf(\"BerkeleyEnvironment::Open: Error %d opening database environment: %s\\n\", ret, DbEnv::strerror(ret));\n+        int ret2 = dbenv->close(0);\n+        if (ret2 != 0) {\n+            LogPrintf(\"BerkeleyEnvironment::Open: Error %d closing failed database environment: %s\\n\", ret2, DbEnv::strerror(ret2));\n+        }\n+        Reset();\n         if (retry) {\n             // try moving the database env out of the way\n             fs::path pathDatabaseBak = pathIn / strprintf(\"database.%d.bak\", GetTime());"
      }
    ]
  }
]