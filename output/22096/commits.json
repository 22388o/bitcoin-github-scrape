[
  {
    "sha": "b6c5d1e450dde6a54bd785504c923adfb45c7060",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiNmM1ZDFlNDUwZGRlNmE1NGJkNzg1NTA0YzkyM2FkZmI0NWM3MDYw",
    "commit": {
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-05-28T14:06:27Z"
      },
      "committer": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-05-28T16:29:05Z"
      },
      "message": "p2p: AddrFetch - don't disconnect on self-announcements\n\nDisconnecting an AddrFetch peer only after receiving an addr\nmessage of size >1 prevents dropping them before\nthey had a chance to answer the getaddr request.",
      "tree": {
        "sha": "9c2557716897e30701e0df891267611650b540be",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9c2557716897e30701e0df891267611650b540be"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b6c5d1e450dde6a54bd785504c923adfb45c7060",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b6c5d1e450dde6a54bd785504c923adfb45c7060",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b6c5d1e450dde6a54bd785504c923adfb45c7060",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b6c5d1e450dde6a54bd785504c923adfb45c7060/comments",
    "author": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "7257e50dba36328be60f69c998632408802b9a29",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7257e50dba36328be60f69c998632408802b9a29",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/7257e50dba36328be60f69c998632408802b9a29"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 3,
      "deletions": 1
    },
    "files": [
      {
        "sha": "51d628773c1de9a315dbc73651f0f8f2e9ae7cca",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 1,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b6c5d1e450dde6a54bd785504c923adfb45c7060/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b6c5d1e450dde6a54bd785504c923adfb45c7060/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=b6c5d1e450dde6a54bd785504c923adfb45c7060",
        "patch": "@@ -2779,7 +2779,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         }\n         m_addrman.Add(vAddrOk, pfrom.addr, 2 * 60 * 60);\n         if (vAddr.size() < 1000) peer->m_getaddr_sent = false;\n-        if (pfrom.IsAddrFetchConn()) {\n+\n+        // AddrFetch: Require multiple addresses to avoid disconnecting on self-announcements\n+        if (pfrom.IsAddrFetchConn() && vAddr.size() > 1) {\n             LogPrint(BCLog::NET, \"addrfetch connection completed peer=%d; disconnecting\\n\", pfrom.GetId());\n             pfrom.fDisconnect = true;\n         }"
      }
    ]
  },
  {
    "sha": "533500d9072b7d5a36a6491784bdeb9247e91fb0",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1MzM1MDBkOTA3MmI3ZDVhMzZhNjQ5MTc4NGJkZWI5MjQ3ZTkxZmIw",
    "commit": {
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-05-29T21:58:37Z"
      },
      "committer": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-06-17T20:00:07Z"
      },
      "message": "p2p: Add timeout for AddrFetch peers\n\nIf AddrFetch peers don't send us addresses, disconnect them after\na while.",
      "tree": {
        "sha": "2d288d71dfd1fa7567fd27bd39e2cbeb728356d6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2d288d71dfd1fa7567fd27bd39e2cbeb728356d6"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/533500d9072b7d5a36a6491784bdeb9247e91fb0",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/533500d9072b7d5a36a6491784bdeb9247e91fb0",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/533500d9072b7d5a36a6491784bdeb9247e91fb0",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/533500d9072b7d5a36a6491784bdeb9247e91fb0/comments",
    "author": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b6c5d1e450dde6a54bd785504c923adfb45c7060",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b6c5d1e450dde6a54bd785504c923adfb45c7060",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b6c5d1e450dde6a54bd785504c923adfb45c7060"
      }
    ],
    "stats": {
      "total": 6,
      "additions": 6,
      "deletions": 0
    },
    "files": [
      {
        "sha": "702a23599320d56e438808654e171f7e0804a41a",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/533500d9072b7d5a36a6491784bdeb9247e91fb0/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/533500d9072b7d5a36a6491784bdeb9247e91fb0/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=533500d9072b7d5a36a6491784bdeb9247e91fb0",
        "patch": "@@ -4364,6 +4364,12 @@ bool PeerManagerImpl::SendMessages(CNode* pto)\n \n     const auto current_time = GetTime<std::chrono::microseconds>();\n \n+    if (pto->IsAddrFetchConn() && current_time - std::chrono::seconds(pto->nTimeConnected) > 10 * AVG_ADDRESS_BROADCAST_INTERVAL) {\n+        LogPrint(BCLog::NET, \"addrfetch connection timeout; disconnecting peer=%d\\n\", pto->GetId());\n+        pto->fDisconnect = true;\n+        return true;\n+    }\n+\n     MaybeSendPing(*pto, *peer, current_time);\n \n     // MaybeSendPing may have marked peer for disconnection"
      }
    ]
  },
  {
    "sha": "c34ad3309f93979b274a37de013502b05d25fad8",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjMzRhZDMzMDlmOTM5NzliMjc0YTM3ZGUwMTM1MDJiMDVkMjVmYWQ4",
    "commit": {
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-05-31T20:49:42Z"
      },
      "committer": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-07-12T00:16:45Z"
      },
      "message": "net, rpc: Enable AddrFetch connections for functional testing\n\nCo-authored-by: Amiti Uttarwar <amiti@uttarwar.org>",
      "tree": {
        "sha": "003e8754ab4add0aadc72107983134560a6ec851",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/003e8754ab4add0aadc72107983134560a6ec851"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c34ad3309f93979b274a37de013502b05d25fad8",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c34ad3309f93979b274a37de013502b05d25fad8",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c34ad3309f93979b274a37de013502b05d25fad8",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c34ad3309f93979b274a37de013502b05d25fad8/comments",
    "author": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "533500d9072b7d5a36a6491784bdeb9247e91fb0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/533500d9072b7d5a36a6491784bdeb9247e91fb0",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/533500d9072b7d5a36a6491784bdeb9247e91fb0"
      }
    ],
    "stats": {
      "total": 31,
      "additions": 23,
      "deletions": 8
    },
    "files": [
      {
        "sha": "a43fe9cdf6c7753d1545cff6a78f9944b3f03710",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 17,
        "deletions": 4,
        "changes": 21,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c34ad3309f93979b274a37de013502b05d25fad8/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c34ad3309f93979b274a37de013502b05d25fad8/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=c34ad3309f93979b274a37de013502b05d25fad8",
        "patch": "@@ -1166,16 +1166,29 @@ void CConnman::CreateNodeFromAcceptedSocket(SOCKET hSocket,\n \n bool CConnman::AddConnection(const std::string& address, ConnectionType conn_type)\n {\n-    if (conn_type != ConnectionType::OUTBOUND_FULL_RELAY && conn_type != ConnectionType::BLOCK_RELAY) return false;\n-\n-    const int max_connections = conn_type == ConnectionType::OUTBOUND_FULL_RELAY ? m_max_outbound_full_relay : m_max_outbound_block_relay;\n+    std::optional<int> max_connections;\n+    switch (conn_type) {\n+    case ConnectionType::INBOUND:\n+    case ConnectionType::MANUAL:\n+    case ConnectionType::FEELER:\n+        return false;\n+    case ConnectionType::OUTBOUND_FULL_RELAY:\n+        max_connections = m_max_outbound_full_relay;\n+        break;\n+    case ConnectionType::BLOCK_RELAY:\n+        max_connections = m_max_outbound_block_relay;\n+        break;\n+    // no limit for ADDR_FETCH because -seednode has no limit either\n+    case ConnectionType::ADDR_FETCH:\n+        break;\n+    } // no default case, so the compiler can warn about missing cases\n \n     // Count existing connections\n     int existing_connections = WITH_LOCK(cs_vNodes,\n                                          return std::count_if(vNodes.begin(), vNodes.end(), [conn_type](CNode* node) { return node->m_conn_type == conn_type; }););\n \n     // Max connections of specified type already exist\n-    if (existing_connections >= max_connections) return false;\n+    if (max_connections != std::nullopt && existing_connections >= max_connections) return false;\n \n     // Max total outbound connections already exist\n     CSemaphoreGrant grant(*semOutbound, true);"
      },
      {
        "sha": "3af23d2bd7991f3a4e4dc65e61338845dda1f33e",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c34ad3309f93979b274a37de013502b05d25fad8/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c34ad3309f93979b274a37de013502b05d25fad8/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=c34ad3309f93979b274a37de013502b05d25fad8",
        "patch": "@@ -890,6 +890,7 @@ class CConnman\n      *\n      * @param[in]   address     Address of node to try connecting to\n      * @param[in]   conn_type   ConnectionType::OUTBOUND or ConnectionType::BLOCK_RELAY\n+     *                          or ConnectionType::ADDR_FETCH\n      * @return      bool        Returns false if there are no available\n      *                          slots for this connection:\n      *                          - conn_type not a supported ConnectionType"
      },
      {
        "sha": "50280915c355e7b71b24c8f02df5ab153c08a7cb",
        "filename": "src/rpc/net.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 1,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c34ad3309f93979b274a37de013502b05d25fad8/src/rpc/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c34ad3309f93979b274a37de013502b05d25fad8/src/rpc/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/net.cpp?ref=c34ad3309f93979b274a37de013502b05d25fad8",
        "patch": "@@ -337,7 +337,7 @@ static RPCHelpMan addconnection()\n         \"\\nOpen an outbound connection to a specified node. This RPC is for testing only.\\n\",\n         {\n             {\"address\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The IP address and port to attempt connecting to.\"},\n-            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open, either \\\"outbound-full-relay\\\" or \\\"block-relay-only\\\".\"},\n+            {\"connection_type\", RPCArg::Type::STR, RPCArg::Optional::NO, \"Type of connection to open (\\\"outbound-full-relay\\\", \\\"block-relay-only\\\" or \\\"addr-fetch\\\").\"},\n         },\n         RPCResult{\n             RPCResult::Type::OBJ, \"\", \"\",\n@@ -363,6 +363,8 @@ static RPCHelpMan addconnection()\n         conn_type = ConnectionType::OUTBOUND_FULL_RELAY;\n     } else if (conn_type_in == \"block-relay-only\") {\n         conn_type = ConnectionType::BLOCK_RELAY;\n+    } else if (conn_type_in == \"addr-fetch\") {\n+        conn_type = ConnectionType::ADDR_FETCH;\n     } else {\n         throw JSONRPCError(RPC_INVALID_PARAMETER, self.ToString());\n     }"
      },
      {
        "sha": "71b8aeb20e4db03bcb595579331f0a869e2f1e99",
        "filename": "test/functional/test_framework/test_node.py",
        "status": "modified",
        "additions": 2,
        "deletions": 3,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c34ad3309f93979b274a37de013502b05d25fad8/test/functional/test_framework/test_node.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c34ad3309f93979b274a37de013502b05d25fad8/test/functional/test_framework/test_node.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_framework/test_node.py?ref=c34ad3309f93979b274a37de013502b05d25fad8",
        "patch": "@@ -557,9 +557,8 @@ def add_p2p_connection(self, p2p_conn, *, wait_for_verack=True, **kwargs):\n         return p2p_conn\n \n     def add_outbound_p2p_connection(self, p2p_conn, *, p2p_idx, connection_type=\"outbound-full-relay\", **kwargs):\n-        \"\"\"Add an outbound p2p connection from node. Either\n-        full-relay(\"outbound-full-relay\") or\n-        block-relay-only(\"block-relay-only\") connection.\n+        \"\"\"Add an outbound p2p connection from node. Must be an\n+        \"outbound-full-relay\", \"block-relay-only\" or \"addr-fetch\" connection.\n \n         This method adds the p2p connection to the self.p2ps list and returns\n         the connection to the caller."
      }
    ]
  },
  {
    "sha": "5730a43703f7e5a5ca26245ba3b55fbdd027d0b6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1NzMwYTQzNzAzZjdlNWE1Y2EyNjI0NWJhM2I1NWZiZGQwMjdkMGI2",
    "commit": {
      "author": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-05-31T20:52:08Z"
      },
      "committer": {
        "name": "Martin Zumsande",
        "email": "mzumsande@gmail.com",
        "date": "2021-07-12T00:16:54Z"
      },
      "message": "test: Add functional test for AddrFetch connections\n\nCo-authored-by: Amiti Uttarwar <amiti@uttarwar.org>",
      "tree": {
        "sha": "b0524262002f86ffb7977263e85da27a6d3a9143",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b0524262002f86ffb7977263e85da27a6d3a9143"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5730a43703f7e5a5ca26245ba3b55fbdd027d0b6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5730a43703f7e5a5ca26245ba3b55fbdd027d0b6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/5730a43703f7e5a5ca26245ba3b55fbdd027d0b6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5730a43703f7e5a5ca26245ba3b55fbdd027d0b6/comments",
    "author": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c34ad3309f93979b274a37de013502b05d25fad8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c34ad3309f93979b274a37de013502b05d25fad8",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c34ad3309f93979b274a37de013502b05d25fad8"
      }
    ],
    "stats": {
      "total": 63,
      "additions": 63,
      "deletions": 0
    },
    "files": [
      {
        "sha": "66ee1544a91d96325c7c16ced62add1a06bcb037",
        "filename": "test/functional/p2p_addrfetch.py",
        "status": "added",
        "additions": 62,
        "deletions": 0,
        "changes": 62,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5730a43703f7e5a5ca26245ba3b55fbdd027d0b6/test/functional/p2p_addrfetch.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5730a43703f7e5a5ca26245ba3b55fbdd027d0b6/test/functional/p2p_addrfetch.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_addrfetch.py?ref=5730a43703f7e5a5ca26245ba3b55fbdd027d0b6",
        "patch": "@@ -0,0 +1,62 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"\n+Test p2p addr-fetch connections\n+\"\"\"\n+\n+import time\n+\n+from test_framework.messages import msg_addr, CAddress, NODE_NETWORK, NODE_WITNESS\n+from test_framework.p2p import P2PInterface, p2p_lock\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal\n+\n+ADDR = CAddress()\n+ADDR.time = int(time.time())\n+ADDR.nServices = NODE_NETWORK | NODE_WITNESS\n+ADDR.ip = \"192.0.0.8\"\n+ADDR.port = 18444\n+\n+\n+class P2PAddrFetch(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        node = self.nodes[0]\n+        self.log.info(\"Connect to an addr-fetch peer\")\n+        peer = node.add_outbound_p2p_connection(P2PInterface(), p2p_idx=0, connection_type=\"addr-fetch\")\n+        info = node.getpeerinfo()\n+        assert_equal(len(info), 1)\n+        assert_equal(info[0]['connection_type'], 'addr-fetch')\n+\n+        self.log.info(\"Check that we send getaddr but don't try to sync headers with the addr-fetch peer\")\n+        peer.sync_send_with_ping()\n+        with p2p_lock:\n+            assert peer.message_count['getaddr'] == 1\n+            assert peer.message_count['getheaders'] == 0\n+\n+        self.log.info(\"Check that answering the getaddr with a single address does not lead to disconnect\")\n+        # This prevents disconnecting on self-announcements\n+        msg = msg_addr()\n+        msg.addrs = [ADDR]\n+        peer.send_and_ping(msg)\n+        assert_equal(len(node.getpeerinfo()), 1)\n+\n+        self.log.info(\"Check that answering with larger addr messages leads to disconnect\")\n+        msg.addrs = [ADDR] * 2\n+        peer.send_message(msg)\n+        peer.wait_for_disconnect(timeout=5)\n+\n+        self.log.info(\"Check timeout for addr-fetch peer that does not send addrs\")\n+        peer = node.add_outbound_p2p_connection(P2PInterface(), p2p_idx=1, connection_type=\"addr-fetch\")\n+        node.setmocktime(int(time.time()) + 301)  # Timeout: 5 minutes\n+        peer.wait_for_disconnect(timeout=5)\n+\n+\n+if __name__ == '__main__':\n+    P2PAddrFetch().main()"
      },
      {
        "sha": "4dcd92708c1b7281cc3acfccfc6dfad1e4a24681",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5730a43703f7e5a5ca26245ba3b55fbdd027d0b6/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5730a43703f7e5a5ca26245ba3b55fbdd027d0b6/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=5730a43703f7e5a5ca26245ba3b55fbdd027d0b6",
        "patch": "@@ -182,6 +182,7 @@\n     'p2p_addr_relay.py',\n     'p2p_getaddr_caching.py',\n     'p2p_getdata.py',\n+    'p2p_addrfetch.py',\n     'rpc_net.py',\n     'wallet_keypool.py --legacy-wallet',\n     'wallet_keypool.py --descriptors',"
      }
    ]
  }
]