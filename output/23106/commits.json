[
  {
    "sha": "0e895212bb571ae0de5580adfd8ee9b3c2137e24",
    "node_id": "C_kwDOABII59oAKDBlODk1MjEyYmI1NzFhZTBkZTU1ODBhZGZkOGVlOWIzYzIxMzdlMjQ",
    "commit": {
      "author": {
        "name": "Samuel Dobson",
        "email": "dobsonsa68@gmail.com",
        "date": "2021-09-27T12:24:23Z"
      },
      "committer": {
        "name": "Samuel Dobson",
        "email": "dobsonsa68@gmail.com",
        "date": "2021-09-27T12:25:42Z"
      },
      "message": "Ensure wallet is unlocked before signing in walletprocesspsbt",
      "tree": {
        "sha": "a7d18e57eceb096c32301afdc3847b0cab43afd6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a7d18e57eceb096c32301afdc3847b0cab43afd6"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0e895212bb571ae0de5580adfd8ee9b3c2137e24",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0e895212bb571ae0de5580adfd8ee9b3c2137e24",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/0e895212bb571ae0de5580adfd8ee9b3c2137e24",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0e895212bb571ae0de5580adfd8ee9b3c2137e24/comments",
    "author": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "09cb5ec6c8b4468ee3e8c2b3e1a9075907e5c84d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/09cb5ec6c8b4468ee3e8c2b3e1a9075907e5c84d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/09cb5ec6c8b4468ee3e8c2b3e1a9075907e5c84d"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 4,
      "deletions": 1
    },
    "files": [
      {
        "sha": "c430b1db5c6102685685a930c2226fbc3ff91581",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 1,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0e895212bb571ae0de5580adfd8ee9b3c2137e24/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0e895212bb571ae0de5580adfd8ee9b3c2137e24/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=0e895212bb571ae0de5580adfd8ee9b3c2137e24",
        "patch": "@@ -4420,7 +4420,7 @@ static RPCHelpMan walletprocesspsbt()\n         HELP_REQUIRING_PASSPHRASE,\n                 {\n                     {\"psbt\", RPCArg::Type::STR, RPCArg::Optional::NO, \"The transaction base64 string\"},\n-                    {\"sign\", RPCArg::Type::BOOL, RPCArg::Default{true}, \"Also sign the transaction when updating\"},\n+                    {\"sign\", RPCArg::Type::BOOL, RPCArg::Default{true}, \"Also sign the transaction when updating (requires wallet to be unlocked)\"},\n                     {\"sighashtype\", RPCArg::Type::STR, RPCArg::Default{\"DEFAULT\"}, \"The signature hash type to sign with if not specified by the PSBT. Must be one of\\n\"\n             \"       \\\"DEFAULT\\\"\\n\"\n             \"       \\\"ALL\\\"\\n\"\n@@ -4467,6 +4467,9 @@ static RPCHelpMan walletprocesspsbt()\n     bool sign = request.params[1].isNull() ? true : request.params[1].get_bool();\n     bool bip32derivs = request.params[3].isNull() ? true : request.params[3].get_bool();\n     bool complete = true;\n+\n+    if (sign) EnsureWalletIsUnlocked(*pwallet);\n+\n     const TransactionError err{wallet.FillPSBT(psbtx, complete, nHashType, sign, bip32derivs)};\n     if (err != TransactionError::OK) {\n         throw JSONRPCTransactionError(err);"
      }
    ]
  },
  {
    "sha": "0f3acecf3372f9da143590bb17d8444564e083f4",
    "node_id": "C_kwDOABII59oAKDBmM2FjZWNmMzM3MmY5ZGExNDM1OTBiYjE3ZDg0NDQ1NjRlMDgzZjQ",
    "commit": {
      "author": {
        "name": "Samuel Dobson",
        "email": "dobsonsa68@gmail.com",
        "date": "2021-09-27T23:40:26Z"
      },
      "committer": {
        "name": "Samuel Dobson",
        "email": "dobsonsa68@gmail.com",
        "date": "2021-09-28T00:27:07Z"
      },
      "message": "Add test that walletprocesspsbt requires unlocked wallet when signing",
      "tree": {
        "sha": "1f82272379f2352e5f39a90165c130b78e1db8cd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1f82272379f2352e5f39a90165c130b78e1db8cd"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0f3acecf3372f9da143590bb17d8444564e083f4",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0f3acecf3372f9da143590bb17d8444564e083f4",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/0f3acecf3372f9da143590bb17d8444564e083f4",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0f3acecf3372f9da143590bb17d8444564e083f4/comments",
    "author": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "0e895212bb571ae0de5580adfd8ee9b3c2137e24",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0e895212bb571ae0de5580adfd8ee9b3c2137e24",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/0e895212bb571ae0de5580adfd8ee9b3c2137e24"
      }
    ],
    "stats": {
      "total": 10,
      "additions": 10,
      "deletions": 0
    },
    "files": [
      {
        "sha": "f330bbf1c3285136f622559ae462675640bc5bbd",
        "filename": "test/functional/rpc_psbt.py",
        "status": "modified",
        "additions": 10,
        "deletions": 0,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0f3acecf3372f9da143590bb17d8444564e083f4/test/functional/rpc_psbt.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0f3acecf3372f9da143590bb17d8444564e083f4/test/functional/rpc_psbt.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_psbt.py?ref=0f3acecf3372f9da143590bb17d8444564e083f4",
        "patch": "@@ -108,6 +108,16 @@ def run_test(self):\n         psbtx = self.nodes[1].walletprocesspsbt(psbtx1)['psbt']\n         assert_equal(psbtx1, psbtx)\n \n+        # Node 0 should not be able to sign the transaction with the wallet is locked\n+        self.nodes[0].encryptwallet(\"password\")\n+        assert_raises_rpc_error(-13, \"Please enter the wallet passphrase with walletpassphrase first\", self.nodes[0].walletprocesspsbt, psbtx)\n+\n+        # Node 0 should be able to process without signing though\n+        unsigned_tx = self.nodes[0].walletprocesspsbt(psbtx, False)\n+        assert_equal(unsigned_tx['complete'], False)\n+\n+        self.nodes[0].walletpassphrase(passphrase=\"password\", timeout=1000000)\n+\n         # Sign the transaction and send\n         signed_tx = self.nodes[0].walletprocesspsbt(psbtx)['psbt']\n         final_tx = self.nodes[0].finalizepsbt(signed_tx)['hex']"
      }
    ]
  },
  {
    "sha": "7e3ee4cdd0f60a2f549ba030fe96b90d61c036c5",
    "node_id": "C_kwDOABII59oAKDdlM2VlNGNkZDBmNjBhMmY1NDliYTAzMGZlOTZiOTBkNjFjMDM2YzU",
    "commit": {
      "author": {
        "name": "Samuel Dobson",
        "email": "dobsonsa68@gmail.com",
        "date": "2021-09-27T23:49:14Z"
      },
      "committer": {
        "name": "Samuel Dobson",
        "email": "dobsonsa68@gmail.com",
        "date": "2021-09-28T00:27:07Z"
      },
      "message": "GUI: Ask user to unlock wallet before signing psbt",
      "tree": {
        "sha": "eb1b066d6b4cdfc291c7149082be4f01249946f9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/eb1b066d6b4cdfc291c7149082be4f01249946f9"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7e3ee4cdd0f60a2f549ba030fe96b90d61c036c5",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7e3ee4cdd0f60a2f549ba030fe96b90d61c036c5",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/7e3ee4cdd0f60a2f549ba030fe96b90d61c036c5",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7e3ee4cdd0f60a2f549ba030fe96b90d61c036c5/comments",
    "author": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "0f3acecf3372f9da143590bb17d8444564e083f4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0f3acecf3372f9da143590bb17d8444564e083f4",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/0f3acecf3372f9da143590bb17d8444564e083f4"
      }
    ],
    "stats": {
      "total": 7,
      "additions": 6,
      "deletions": 1
    },
    "files": [
      {
        "sha": "34d56e5506a359fd2cdebf2cf0d7932cda5d39a8",
        "filename": "src/qt/psbtoperationsdialog.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 1,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7e3ee4cdd0f60a2f549ba030fe96b90d61c036c5/src/qt/psbtoperationsdialog.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7e3ee4cdd0f60a2f549ba030fe96b90d61c036c5/src/qt/psbtoperationsdialog.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/psbtoperationsdialog.cpp?ref=7e3ee4cdd0f60a2f549ba030fe96b90d61c036c5",
        "patch": "@@ -71,6 +71,9 @@ void PSBTOperationsDialog::signTransaction()\n {\n     bool complete;\n     size_t n_signed;\n+\n+    WalletModel::UnlockContext ctx(m_wallet_model->requestUnlock());\n+\n     TransactionError err = m_wallet_model->wallet().fillPSBT(SIGHASH_ALL, true /* sign */, true /* bip32derivs */, &n_signed, m_transaction_data, complete);\n \n     if (err != TransactionError::OK) {\n@@ -81,7 +84,9 @@ void PSBTOperationsDialog::signTransaction()\n \n     updateTransactionDisplay();\n \n-    if (!complete && n_signed < 1) {\n+    if (!complete && !ctx.isValid()) {\n+        showStatus(tr(\"Cannot sign inputs while wallet is locked.\"), StatusLevel::WARN);\n+    } else if (!complete && n_signed < 1) {\n         showStatus(tr(\"Could not sign any more inputs.\"), StatusLevel::WARN);\n     } else if (!complete) {\n         showStatus(tr(\"Signed %1 inputs, but more signatures are still required.\").arg(n_signed),"
      }
    ]
  }
]