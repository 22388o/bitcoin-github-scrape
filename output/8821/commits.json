[
  {
    "sha": "faa4de2a2ac2eb9bb6a419940da83fa898d16a3c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmYWE0ZGUyYTJhYzJlYjliYjZhNDE5OTQwZGE4M2ZhODk4ZDE2YTNj",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2016-09-26T16:58:51Z"
      },
      "committer": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2016-09-26T20:29:45Z"
      },
      "message": "[qt] sync-overlay: Don't block during reindex",
      "tree": {
        "sha": "6170fcdfcff59a08f41090afe71439430c9f5f1d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6170fcdfcff59a08f41090afe71439430c9f5f1d"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/faa4de2a2ac2eb9bb6a419940da83fa898d16a3c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/faa4de2a2ac2eb9bb6a419940da83fa898d16a3c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/faa4de2a2ac2eb9bb6a419940da83fa898d16a3c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/faa4de2a2ac2eb9bb6a419940da83fa898d16a3c/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "2f71490d21796594ca6f55e375558944de9db5a0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2f71490d21796594ca6f55e375558944de9db5a0",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/2f71490d21796594ca6f55e375558944de9db5a0"
      }
    ],
    "stats": {
      "total": 36,
      "additions": 22,
      "deletions": 14
    },
    "files": [
      {
        "sha": "87704c641d489ad2717149fc35f00c640f518f57",
        "filename": "src/qt/clientmodel.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/faa4de2a2ac2eb9bb6a419940da83fa898d16a3c/src/qt/clientmodel.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/faa4de2a2ac2eb9bb6a419940da83fa898d16a3c/src/qt/clientmodel.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/clientmodel.cpp?ref=faa4de2a2ac2eb9bb6a419940da83fa898d16a3c",
        "patch": "@@ -256,7 +256,7 @@ static void BlockTipChanged(ClientModel *clientmodel, bool initialSync, const CB\n     int64_t& nLastUpdateNotification = fHeader ? nLastHeaderTipUpdateNotification : nLastBlockTipUpdateNotification;\n \n     // if we are in-sync, update the UI regardless of last update time\n-    if (fHeader || !initialSync || now - nLastUpdateNotification > MODEL_UPDATE_DELAY) {\n+    if (!initialSync || now - nLastUpdateNotification > MODEL_UPDATE_DELAY) {\n         //pass a async signal to the UI thread\n         QMetaObject::invokeMethod(clientmodel, \"numBlocksChanged\", Qt::QueuedConnection,\n                                   Q_ARG(int, pIndex->nHeight),"
      },
      {
        "sha": "461077ff76e5c9999d62bd667a51d6fffb859fdc",
        "filename": "src/qt/modaloverlay.cpp",
        "status": "modified",
        "additions": 19,
        "deletions": 12,
        "changes": 31,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/faa4de2a2ac2eb9bb6a419940da83fa898d16a3c/src/qt/modaloverlay.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/faa4de2a2ac2eb9bb6a419940da83fa898d16a3c/src/qt/modaloverlay.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/modaloverlay.cpp?ref=faa4de2a2ac2eb9bb6a419940da83fa898d16a3c",
        "patch": "@@ -13,7 +13,8 @@\n ModalOverlay::ModalOverlay(QWidget *parent) :\n QWidget(parent),\n ui(new Ui::ModalOverlay),\n-bestBlockHeight(0),\n+bestHeaderHeight(0),\n+bestHeaderDate(QDateTime()),\n layerIsVisible(false),\n userClosed(false)\n {\n@@ -65,14 +66,9 @@ bool ModalOverlay::event(QEvent* ev) {\n \n void ModalOverlay::setKnownBestHeight(int count, const QDateTime& blockDate)\n {\n-\n-    /* only update the blockheight if the headerschain-tip is not older then 30 days */\n-    int64_t now = QDateTime::currentDateTime().toTime_t();\n-    int64_t btime = blockDate.toTime_t();\n-    if (btime+3600*24*30 > now)\n-    {\n-        if (count > bestBlockHeight)\n-            bestBlockHeight = count;\n+    if (count > bestHeaderHeight) {\n+        bestHeaderHeight = count;\n+        bestHeaderDate = blockDate;\n     }\n }\n \n@@ -125,11 +121,22 @@ void ModalOverlay::tipUpdate(int count, const QDateTime& blockDate, double nVeri\n     ui->percentageProgress->setText(QString::number(nVerificationProgress*100, 'f', 2)+\"%\");\n     ui->progressBar->setValue(nVerificationProgress*100);\n \n+    if (!bestHeaderDate.isValid())\n+        // not syncing\n+        return;\n+\n+    // estimate the number of headers left based on nPowTargetSpacing\n+    // and check if the gui is not aware of the the best header (happens rarely)\n+    int estimateNumHeadersLeft = bestHeaderDate.secsTo(currentDate) / 600;\n+    bool hasBestHeader = bestHeaderHeight >= count;\n+\n     // show remaining number of blocks\n-    if (bestBlockHeight > 0)\n-        ui->numberOfBlocksLeft->setText(QString::number(bestBlockHeight-count));\n-    else\n+    if (estimateNumHeadersLeft < 24 && hasBestHeader) {\n+        ui->numberOfBlocksLeft->setText(QString::number(bestHeaderHeight - count));\n+    } else {\n+        ui->numberOfBlocksLeft->setText(\"~\" + QString::number(bestHeaderHeight + estimateNumHeadersLeft - count));\n         ui->expectedTimeLeft->setText(tr(\"Unknown. Syncing Headers...\"));\n+    }\n }\n \n void ModalOverlay::showHide(bool hide, bool userRequested)"
      },
      {
        "sha": "66c0aa78cfb958592d9b7a5fca699ff5283a62c6",
        "filename": "src/qt/modaloverlay.h",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/faa4de2a2ac2eb9bb6a419940da83fa898d16a3c/src/qt/modaloverlay.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/faa4de2a2ac2eb9bb6a419940da83fa898d16a3c/src/qt/modaloverlay.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/modaloverlay.h?ref=faa4de2a2ac2eb9bb6a419940da83fa898d16a3c",
        "patch": "@@ -35,7 +35,8 @@ public Q_SLOTS:\n \n private:\n     Ui::ModalOverlay *ui;\n-    int bestBlockHeight; //best known height (based on the headers)\n+    int bestHeaderHeight; //best known height (based on the headers)\n+    QDateTime bestHeaderDate;\n     QVector<QPair<qint64, double> > blockProcessTime;\n     bool layerIsVisible;\n     bool userClosed;"
      }
    ]
  },
  {
    "sha": "fa85e860a9261e6c585ec40e67845fa93a20c6e7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmYTg1ZTg2MGE5MjYxZTZjNTg1ZWM0MGU2Nzg0NWZhOTNhMjBjNmU3",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2016-09-29T11:23:54Z"
      },
      "committer": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2016-09-29T11:24:29Z"
      },
      "message": "[qt] sync-overlay: Don't show estimated number of headers left",
      "tree": {
        "sha": "bc15c80fc6cbf7dd5f8a6b3cb91587c1034d1c37",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/bc15c80fc6cbf7dd5f8a6b3cb91587c1034d1c37"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fa85e860a9261e6c585ec40e67845fa93a20c6e7",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fa85e860a9261e6c585ec40e67845fa93a20c6e7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/fa85e860a9261e6c585ec40e67845fa93a20c6e7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fa85e860a9261e6c585ec40e67845fa93a20c6e7/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "faa4de2a2ac2eb9bb6a419940da83fa898d16a3c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/faa4de2a2ac2eb9bb6a419940da83fa898d16a3c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/faa4de2a2ac2eb9bb6a419940da83fa898d16a3c"
      }
    ],
    "stats": {
      "total": 1,
      "additions": 0,
      "deletions": 1
    },
    "files": [
      {
        "sha": "5caade7d381c926cd22c3ca16fd0d326a581f610",
        "filename": "src/qt/modaloverlay.cpp",
        "status": "modified",
        "additions": 0,
        "deletions": 1,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fa85e860a9261e6c585ec40e67845fa93a20c6e7/src/qt/modaloverlay.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fa85e860a9261e6c585ec40e67845fa93a20c6e7/src/qt/modaloverlay.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/modaloverlay.cpp?ref=fa85e860a9261e6c585ec40e67845fa93a20c6e7",
        "patch": "@@ -134,7 +134,6 @@ void ModalOverlay::tipUpdate(int count, const QDateTime& blockDate, double nVeri\n     if (estimateNumHeadersLeft < 24 && hasBestHeader) {\n         ui->numberOfBlocksLeft->setText(QString::number(bestHeaderHeight - count));\n     } else {\n-        ui->numberOfBlocksLeft->setText(\"~\" + QString::number(bestHeaderHeight + estimateNumHeadersLeft - count));\n         ui->expectedTimeLeft->setText(tr(\"Unknown. Syncing Headers...\"));\n     }\n }"
      }
    ]
  }
]