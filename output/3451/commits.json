[
  {
    "sha": "5fe19d640e50373ddaa810e5bfff9764d9ac549e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1ZmUxOWQ2NDBlNTAzNzNkZGFhODEwZTViZmZmOTc2NGQ5YWM1NDll",
    "commit": {
      "author": {
        "name": "Wladimir J. van der Laan",
        "email": "laanwj@gmail.com",
        "date": "2013-12-20T16:12:39Z"
      },
      "committer": {
        "name": "Wladimir J. van der Laan",
        "email": "laanwj@gmail.com",
        "date": "2013-12-20T16:12:39Z"
      },
      "message": "qt: make wallet test consistent\n\nAdd a function `WaitBlocks` to wait for blocks to propagate to all three\nnodes, and use this instead of waiting a fixed time of one second.\n\nFixes #3445.",
      "tree": {
        "sha": "72a53ad596e73a0113d2008eeacc1571fb4547f5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/72a53ad596e73a0113d2008eeacc1571fb4547f5"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5fe19d640e50373ddaa810e5bfff9764d9ac549e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5fe19d640e50373ddaa810e5bfff9764d9ac549e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/5fe19d640e50373ddaa810e5bfff9764d9ac549e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5fe19d640e50373ddaa810e5bfff9764d9ac549e/comments",
    "author": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "365350140a19459b3c763245339e062d1ae0d733",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/365350140a19459b3c763245339e062d1ae0d733",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/365350140a19459b3c763245339e062d1ae0d733"
      }
    ],
    "stats": {
      "total": 31,
      "additions": 26,
      "deletions": 5
    },
    "files": [
      {
        "sha": "e4e3953748ac2eddc3a8f7e4213489095b8c0951",
        "filename": "qa/rpc-tests/util.sh",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5fe19d640e50373ddaa810e5bfff9764d9ac549e/qa/rpc-tests/util.sh",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5fe19d640e50373ddaa810e5bfff9764d9ac549e/qa/rpc-tests/util.sh",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/util.sh?ref=5fe19d640e50373ddaa810e5bfff9764d9ac549e",
        "patch": "@@ -82,3 +82,9 @@ function CreateTxn1 {\n function SendRawTxn {\n   $CLI $1 sendrawtransaction $2\n }\n+\n+# Use: GetBlocks <datadir>\n+# returns number of blocks from getinfo\n+function GetBlocks {\n+    ExtractKey blocks \"$( $CLI $1 getinfo )\"\n+}"
      },
      {
        "sha": "118809a26554cc80688d56f06e9182bc6a740276",
        "filename": "qa/rpc-tests/wallet.sh",
        "status": "modified",
        "additions": 20,
        "deletions": 5,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5fe19d640e50373ddaa810e5bfff9764d9ac549e/qa/rpc-tests/wallet.sh",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5fe19d640e50373ddaa810e5bfff9764d9ac549e/qa/rpc-tests/wallet.sh",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/wallet.sh?ref=5fe19d640e50373ddaa810e5bfff9764d9ac549e",
        "patch": "@@ -37,12 +37,27 @@ B3PID=$!\n \n trap \"kill -9 $B1PID $B2PID $B3PID; rm -rf $D\" EXIT\n \n+# Wait until all three nodes are at the same block number\n+function WaitBlocks {\n+    while :\n+    do\n+        sleep 1\n+        BLOCKS1=$( GetBlocks $B1ARGS )\n+        BLOCKS2=$( GetBlocks $B2ARGS )\n+        BLOCKS3=$( GetBlocks $B3ARGS )\n+        if (( $BLOCKS1 == $BLOCKS2 && $BLOCKS2 == $BLOCKS3 ))\n+        then\n+            break\n+        fi\n+    done\n+}\n+\n # 1 block, 50 XBT each == 50 XBT\n $CLI $B1ARGS setgenerate true 1\n-sleep 1  # sleep is necessary to let block broadcast\n+WaitBlocks\n # 101 blocks, 1 mature == 50 XBT\n $CLI $B2ARGS setgenerate true 101\n-sleep 1\n+WaitBlocks\n \n CheckBalance $B1ARGS 50\n CheckBalance $B2ARGS 50\n@@ -56,11 +71,11 @@ Send $B1ARGS $B3ARGS 10\n # Have B1 mine a new block, and mature it\n # to recover transaction fees\n $CLI $B1ARGS setgenerate true 1\n-sleep 1\n+WaitBlocks\n \n # Have B2 mine 100 blocks so B1's block is mature:\n $CLI $B2ARGS setgenerate true 100\n-sleep 1\n+WaitBlocks\n \n # B1 should end up with 100 XBT in block rewards plus fees,\n # minus the 21 XBT sent to B3:\n@@ -77,7 +92,7 @@ RAWTXID2=$(SendRawTxn $B2ARGS $RAW2)\n \n # Have B2 mine a block to confirm transactions:\n $CLI $B2ARGS setgenerate true 1\n-sleep 1 # allow time for block to be relayed\n+WaitBlocks\n \n # Check balances after confirmation\n CheckBalance $B1ARGS 0"
      }
    ]
  }
]