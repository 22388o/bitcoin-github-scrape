[
  {
    "sha": "fa86dca340b682aae6b501a50c584be47d38a2ae",
    "node_id": "C_kwDOABII59oAKGZhODZkY2EzNDBiNjgyYWFlNmI1MDFhNTBjNTg0YmU0N2QzOGEyYWU",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2021-09-23T18:21:22Z"
      },
      "committer": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2021-09-24T08:29:54Z"
      },
      "message": "rpc: Add m_skip_type_check to RPCResult\n\nUsed in the next commit.",
      "tree": {
        "sha": "3816dd58713536bea92b9141a8e8d896589136da",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3816dd58713536bea92b9141a8e8d896589136da"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fa86dca340b682aae6b501a50c584be47d38a2ae",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unknown_key",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\npUjazAwAvbLoxwCn5WuCa6jQgbThRdLYtL+RtlMOI+GDKbChSXFx0aHOKar+pMT3\n1/JJfwuBG2JXnhtLkTxVjHO9UbSXQDW24sdQtPq0DeaENHlR1kw0xxxPU1w706p8\nF23kqfSm+S5/w11izThBhXaWIUrKODWXrVf28QxlYazXrLjdjC/ndK2HrwywzrIl\nQyy3M8CIrrjh/SU/vEloYDuL99o7z0phzqGOGGvlkLQZZCnkF9Y5B1Mf2KDOznZV\n151+Ghv1AdXOlfixk7dcV2mETVE8zvD7GwxaNQ1AGFxo6T5+FreyJSG5stI8VZDf\n4bl6kIfYNe9uXvm5CtKVjXhFg1buQ84/FekSPvog+zSkq/1lEhNFCDosPNsrJrFz\nUirIFuOaVLDhx8Cif6/RiJ/xpGCyi9njQ/aYDYglIJwOu90WSrihnHpSh5vaByaA\nRT2ywDAgSGfsmUUavTxE7xzxKBWDUh0GQCUheyE0fR+ccr2GuGC1/VWcg2rU4+Op\n2FN9f05S\n=zVh8\n-----END PGP SIGNATURE-----",
        "payload": "tree 3816dd58713536bea92b9141a8e8d896589136da\nparent 95b16e70a8b7ebd103e0ada62a7449184fc9200c\nauthor MarcoFalke <falke.marco@gmail.com> 1632421282 +0200\ncommitter MarcoFalke <falke.marco@gmail.com> 1632472194 +0200\n\nrpc: Add m_skip_type_check to RPCResult\n\nUsed in the next commit.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fa86dca340b682aae6b501a50c584be47d38a2ae",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/fa86dca340b682aae6b501a50c584be47d38a2ae",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fa86dca340b682aae6b501a50c584be47d38a2ae/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "95b16e70a8b7ebd103e0ada62a7449184fc9200c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/95b16e70a8b7ebd103e0ada62a7449184fc9200c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/95b16e70a8b7ebd103e0ada62a7449184fc9200c"
      }
    ],
    "stats": {
      "total": 11,
      "additions": 8,
      "deletions": 3
    },
    "files": [
      {
        "sha": "699611232f125090eb43192e2b7eecc741dbd410",
        "filename": "src/rpc/util.h",
        "status": "modified",
        "additions": 8,
        "deletions": 3,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fa86dca340b682aae6b501a50c584be47d38a2ae/src/rpc/util.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fa86dca340b682aae6b501a50c584be47d38a2ae/src/rpc/util.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/util.h?ref=fa86dca340b682aae6b501a50c584be47d38a2ae",
        "patch": "@@ -249,6 +249,7 @@ struct RPCResult {\n     const std::string m_key_name;         //!< Only used for dicts\n     const std::vector<RPCResult> m_inner; //!< Only used for arrays or dicts\n     const bool m_optional;\n+    const bool m_skip_type_check;\n     const std::string m_description;\n     const std::string m_cond;\n \n@@ -263,6 +264,7 @@ struct RPCResult {\n           m_key_name{std::move(m_key_name)},\n           m_inner{std::move(inner)},\n           m_optional{optional},\n+          m_skip_type_check{false},\n           m_description{std::move(description)},\n           m_cond{std::move(cond)}\n     {\n@@ -284,11 +286,13 @@ struct RPCResult {\n         const std::string m_key_name,\n         const bool optional,\n         const std::string description,\n-        const std::vector<RPCResult> inner = {})\n+        const std::vector<RPCResult> inner = {},\n+        bool skip_type_check = false)\n         : m_type{std::move(type)},\n           m_key_name{std::move(m_key_name)},\n           m_inner{std::move(inner)},\n           m_optional{optional},\n+          m_skip_type_check{skip_type_check},\n           m_description{std::move(description)},\n           m_cond{}\n     {\n@@ -300,8 +304,9 @@ struct RPCResult {\n         const Type type,\n         const std::string m_key_name,\n         const std::string description,\n-        const std::vector<RPCResult> inner = {})\n-        : RPCResult{type, m_key_name, false, description, inner} {}\n+        const std::vector<RPCResult> inner = {},\n+        bool skip_type_check = false)\n+        : RPCResult{type, m_key_name, false, description, inner, skip_type_check} {}\n \n     /** Append the sections of the result. */\n     void ToSections(Sections& sections, OuterType outer_type = OuterType::NONE, const int current_indent = 0) const;"
      }
    ]
  },
  {
    "sha": "faa4b6f9579e54d8095751eec51071385dac45af",
    "node_id": "C_kwDOABII59oAKGZhYTRiNmY5NTc5ZTU0ZDgwOTU3NTFlZWM1MTA3MTM4NWRhYzQ1YWY",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2021-08-25T18:15:58Z"
      },
      "committer": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2021-09-24T08:56:45Z"
      },
      "message": "rpc: Fail to return undocumented or misdocumented JSON",
      "tree": {
        "sha": "0cfb90b2c8c3ae0add240c763887c8504e5841b6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0cfb90b2c8c3ae0add240c763887c8504e5841b6"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/faa4b6f9579e54d8095751eec51071385dac45af",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unknown_key",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\npUgk2wwAtpGPHRQn17Vmazbv3u5xKnVAx6h4NtoNrTEE2z18kp7us+Zg78VaMtYj\nO9/o84WiqnGhpqF8BTxdai6aq14+2pqo/K2JnxO13IN2gowpugxt4cq3gWpgRI9Q\naNBVGIODV0NDTPLX1288jfpBwhxSXTmeSPbSvzNWe43vrGHducUmG5XUPCvD/7Bp\neeIImJBeR39L5Wevi2DInU4FmRiPjcdS65FNVtQyrwSY4MR3NdwajW9xZ7lIRoQQ\nXy5nldBQZD2+0fQnuqsPOjgfv06L59WNVFslXdHa2hY1qKld2jvrV5l2MeYY/g5f\nvbkpLNeE1/OyHfrAzuDpovOza3LexpI4jD/gOSUCP2lo7s0VpOuRgAGIB3u85nJK\nuQH3+cE9IYrS7hpvHflumY5h3m1S+3iIf70rAMO8YHwKUfImDdYbIJpVHzHjVwJR\n+nAeXha3zF2XTOx36az26wcjpEqmOPgwakvWR0MbO42kzlDoxx42ylbpNAiPp15z\nPAor3wjY\n=PfQE\n-----END PGP SIGNATURE-----",
        "payload": "tree 0cfb90b2c8c3ae0add240c763887c8504e5841b6\nparent fa86dca340b682aae6b501a50c584be47d38a2ae\nauthor MarcoFalke <falke.marco@gmail.com> 1629915358 +0200\ncommitter MarcoFalke <falke.marco@gmail.com> 1632473805 +0200\n\nrpc: Fail to return undocumented or misdocumented JSON\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/faa4b6f9579e54d8095751eec51071385dac45af",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/faa4b6f9579e54d8095751eec51071385dac45af",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/faa4b6f9579e54d8095751eec51071385dac45af/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "fa86dca340b682aae6b501a50c584be47d38a2ae",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fa86dca340b682aae6b501a50c584be47d38a2ae",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/fa86dca340b682aae6b501a50c584be47d38a2ae"
      }
    ],
    "stats": {
      "total": 50,
      "additions": 43,
      "deletions": 7
    },
    "files": [
      {
        "sha": "977b872b88124b1c00b1ec7dc1192ded10b7b079",
        "filename": "src/rpc/util.cpp",
        "status": "modified",
        "additions": 42,
        "deletions": 6,
        "changes": 48,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/faa4b6f9579e54d8095751eec51071385dac45af/src/rpc/util.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/faa4b6f9579e54d8095751eec51071385dac45af/src/rpc/util.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/util.cpp?ref=faa4b6f9579e54d8095751eec51071385dac45af",
        "patch": "@@ -764,7 +764,7 @@ void RPCResult::ToSections(Sections& sections, const OuterType outer_type, const\n     // Elements in a JSON structure (dictionary or array) are separated by a comma\n     const std::string maybe_separator{outer_type != OuterType::NONE ? \",\" : \"\"};\n \n-    // The key name if recursed into an dictionary\n+    // The key name if recursed into a dictionary\n     const std::string maybe_key{\n         outer_type == OuterType::OBJ ?\n             \"\\\"\" + this->m_key_name + \"\\\" : \" :\n@@ -852,10 +852,11 @@ void RPCResult::ToSections(Sections& sections, const OuterType outer_type, const\n \n bool RPCResult::MatchesType(const UniValue& result) const\n {\n-    switch (m_type) {\n-    case Type::ELISION: {\n-        return false;\n+    if (m_skip_type_check) {\n+        return true;\n     }\n+    switch (m_type) {\n+    case Type::ELISION:\n     case Type::ANY: {\n         return true;\n     }\n@@ -876,11 +877,46 @@ bool RPCResult::MatchesType(const UniValue& result) const\n     }\n     case Type::ARR_FIXED:\n     case Type::ARR: {\n-        return UniValue::VARR == result.getType();\n+        if (UniValue::VARR != result.getType()) return false;\n+        for (size_t i{0}; i < result.get_array().size(); ++i) {\n+            // If there are more results than documented, re-use the last doc_inner.\n+            const RPCResult& doc_inner{m_inner.at(std::min(m_inner.size() - 1, i))};\n+            if (!doc_inner.MatchesType(result.get_array()[i])) return false;\n+        }\n+        return true; // empty result array is valid\n     }\n     case Type::OBJ_DYN:\n     case Type::OBJ: {\n-        return UniValue::VOBJ == result.getType();\n+        if (UniValue::VOBJ != result.getType()) return false;\n+        if (m_inner.at(0).m_type == Type::ELISION) return true;\n+        if (m_type == Type::OBJ_DYN) {\n+            const RPCResult& doc_inner{m_inner.at(0)}; // Assume all types are the same, randomly pick the first\n+            for (size_t i{0}; i < result.get_obj().size(); ++i) {\n+                if (!doc_inner.MatchesType(result.get_obj()[i])) return false;\n+            }\n+            return true; // empty result obj is valid\n+        }\n+        std::set<std::string> doc_keys;\n+        for (const auto& doc_entry : m_inner) {\n+            doc_keys.insert(doc_entry.m_key_name);\n+        }\n+        std::map<std::string, UniValue> result_obj;\n+        result.getObjMap(result_obj);\n+        for (const auto& result_entry : result_obj) {\n+            if (doc_keys.find(result_entry.first) == doc_keys.end()) return false; // missing documentation\n+        }\n+\n+        for (const auto& doc_entry : m_inner) {\n+            const auto result_it{result_obj.find(doc_entry.m_key_name)};\n+            if (result_it == result_obj.end()) {\n+                if (!doc_entry.m_optional) {\n+                    return false; // result is missing a required key\n+                }\n+                continue;\n+            }\n+            if (!doc_entry.MatchesType(result_it->second)) return false; // wrong type\n+        }\n+        return true;\n     }\n     } // no default case, so the compiler can warn about missing cases\n     CHECK_NONFATAL(false);"
      },
      {
        "sha": "9b8cf9c87e25814eb34e8c7285aabe1053ad3df3",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/faa4b6f9579e54d8095751eec51071385dac45af/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/faa4b6f9579e54d8095751eec51071385dac45af/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=faa4b6f9579e54d8095751eec51071385dac45af",
        "patch": "@@ -2446,7 +2446,7 @@ static RPCHelpMan getwalletinfo()\n                         {\n                             {RPCResult::Type::NUM, \"duration\", \"elapsed seconds since scan start\"},\n                             {RPCResult::Type::NUM, \"progress\", \"scanning progress percentage [0.0, 1.0]\"},\n-                        }},\n+                        }, /*skip_type_check=*/true},\n                         {RPCResult::Type::BOOL, \"descriptors\", \"whether this wallet uses descriptors for scriptPubKey management\"},\n                     }},\n                 },"
      }
    ]
  }
]