PierreRochard,2018-04-15T22:35:53Z,"Thank you @dooglus for bringing attention to this in #11317 and opening #11320. \n\nThis is #11320 with the following changes:\n * rebased on master\n * added the wallet name in three additional logging messages for `rpcdump.cpp`'s `importwallet` function\n\nIn #11320 @promag and @luke-jr suggested approaches to reducing the repetition of `""[%s]"" GetName()` boilerplate. @jimpo, in the contex",https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-381443567,381443567,
jimpo,2018-04-16T05:39:47Z,"I luke-jr's suggestion of `CWallet::LogPrintf`. The main benefit is not even reducing boilerplate, it's to reduce the amount of refactoring required if someone decides that there is a better way of presenting the wallet info on the log line. Also, I think it'll be more obvious that way when people add new log statements in wallet files as compared to noticing the extra log argument and having to r",https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-381485280,381485280,
MarcoFalke,2018-04-16T13:25:43Z,Agree that it makes sense to move this to `CWallet::LogPrintf` instead.,https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-381598320,381598320,
jnewbery,2018-04-16T14:03:45Z,Concept ACK. I agree that `CWallet::LogPrintf` would be useful.,https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-381610475,381610475,
PierreRochard,2018-06-16T13:57:26Z,"Unfortunately `CWallet::LogPrintf` doesn't play nice with the `LogPrintf` macro so I created a `CWallet::WalletLogPrintf` function, using a variadic template to forward args to the macro. Creative solutions to avoid the double namespacing are welcome\n\nhttps://github.com/PierreRochard/bitcoin/commit/45343a251306000501654d1dc015dd88501e271d → https://github.com/PierreRochard/bitcoin/commit/77152",https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-397813805,397813805,
PierreRochard,2018-06-22T19:13:32Z,"Thanks for the review John, I've addressed your nits, and I agree re: structured logging\n\nhttps://github.com/PierreRochard/bitcoin/commit/77152113c9939d4ba7b6e8f22ec4d07703d1891b → https://github.com/PierreRochard/bitcoin/commit/553b1a7f815ec39dc30c65f22aa2f9f6cae41c25 force push diff [here](https://pierrerochard.github.io/bitcoin/diffs/pr_log-wallet-name_2__pr_log-wallet-name_3.html)",https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-399551904,399551904,
achow101,2018-07-18T21:20:51Z,Needs rebase,https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-406078203,406078203,
sipa,2018-07-19T21:57:25Z,Needs trivial rebase after #13500.,https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-406426931,406426931,
achow101,2018-07-20T00:11:49Z,utACK fb71743dbbd188ec3796f6e489f0a73e328bb7cb,https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-406450887,406450887,
PierreRochard,2018-07-20T00:17:28Z,"Thank you for the reviews and comments @empact, @251Labs, and @achow101. \n\nhttps://github.com/PierreRochard/bitcoin/commit/553b1a7f815ec39dc30c65f22aa2f9f6cae41c25 → https://github.com/PierreRochard/bitcoin/commit/fb71743dbbd188ec3796f6e489f0a73e328bb7cb force push diff [here](https://pierrerochard.github.io/bitcoin/diffs/pr_log-wallet-name_3__pr_log-wallet-name_4.html)",https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-406451777,406451777,
PierreRochard,2018-07-20T14:32:02Z,"Trivial rebase to resolve conflict with https://github.com/bitcoin/bitcoin/pull/9662\n\n",https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-406618548,406618548,
skeees,2018-07-26T15:34:54Z,"utACK dd67b82\non an unrelated note the force push diffs are great (i'm guessing you have some automated solution that does those) - would be very cool functionality to put into a bot of some sort",https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-408138663,408138663,
MarcoFalke,2018-07-26T15:39:39Z,@skeees I presume the diff would only be useful if you reviewed the pre-force-push diff as well. In which case you could just do `git diff $pre_force_push_commit $new_commit` locally (after fetching the objects),https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-408140314,408140314,
PierreRochard,2018-07-26T16:03:21Z,"Thank you for the review @skeees, I've been manually experimenting with different approaches and I think I've found a good way to do it with interdiff + diff2html. I'll be automating it and integrating it with bitcoinacks.com, if people find it useful I could work with @MarcoFalke to make a bot.\n\n@MarcoFalke agree it may only be a marginal improvement ",https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-408148458,408148458,
skeees,2018-07-26T17:15:34Z,"yah - its the sort of thing where the people i know who are pro reviewers have built their own tools to do this already. ideally github would have this, but in lieu of that would be an excellent addition to bitcoinacks when you've got the time :)",https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-408169452,408169452,
jtimon,2018-07-26T20:23:42Z,utACK dd67b82bbeba948823224d9ab6c2aa2d24730e21,https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-408223735,408223735,
PierreRochard,2018-07-27T20:16:16Z,"Thank you for catching that @jnewbery!\n\nhttps://github.com/PierreRochard/bitcoin/commit/dd67b82bbeba948823224d9ab6c2aa2d24730e21 → https://github.com/PierreRochard/bitcoin/commit/237a0f87c9841c46276b04b1f947db9fcd10221d force push diff [here](https://pierrerochard.github.io/bitcoin/diffs/pr_log-wallet-name_5__pr_log-wallet-name_6.html)\n",https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-408527693,408527693,
MarcoFalke,2018-08-01T20:51:48Z,"There might be some more instances after you rebase on master:\n\n```sh\ngit grep LogPrint ./src/wallet ':(exclude)src/wallet/db.cpp' ':(exclude)src/wallet/init.cpp' ':(exclude)src/wallet/walletdb.cpp' ':(exclude)src/wallet/crypter.cpp' |grep -v WalletLogPrintf| grep -v GetDisplayName",https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-409718592,409718592,
PierreRochard,2018-08-02T19:21:09Z,"@MarcoFalke Thanks, I found one more after rebasing on to master. \n\nI avoided changing the InitError related strings as many already have the wallet name. I could fix the one you pointed out which does not - but that would change the translation string and prevent this from being merged into 0.17.0. I'll create a follow up PR to standardize the formatting of the InitError messages.\n\nForce ",https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-410038889,410038889,
laanwj,2018-08-06T15:36:07Z,lightly-tested ACK 909f54c80abb7195c2e82c6e06c414f4526a339e,https://github.com/bitcoin/bitcoin/pull/12992#issuecomment-410750740,410750740,
MarcoFalke,2018-04-16T13:27:26Z,"Weird ascii characters should not be translated. You can keep the `_(""Importing..."")` and do the string manipulation afterward",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r181732834,181732834,src/wallet/rpcdump.cpp
jnewbery,2018-06-21T14:14:56Z,"This results in empty brackets at the start of the log if the default is being used, eg:\n\n```\n2018-06-21T14:12:32.172374Z init message: [] Loading wallet...\n2018-06-21T14:12:32.174733Z [] nFileVersion = 169900\n2018-06-21T14:12:32.174776Z [] Keys: 0 plaintext, 0 encrypted, 0 w/ metadata, 0 total. Unknown wallet records: 0\n2018-06-21T14:12:32.175201Z [] Performing wallet upgrade to 16990",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r197149106,197149106,src/wallet/wallet.h
jnewbery,2018-06-21T14:16:33Z,"nit: This looks a bit weird in the logs compared to the other messages:\n\n```\n2018-06-21T14:12:32.894599Z init message: [w1] Loading wallet...\n```\n\n(ie the `[<wallet_name>]` prefix is not at the start of the log). Maybe just change to:\n\n```\n    uiInterface.InitMessage(strprintf(_(""Loading wallet %s ...""), walletFile));\n```",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r197149692,197149692,src/wallet/wallet.cpp
jnewbery,2018-06-21T14:20:38Z,"There are a couple of logs lower down that you've missed:\n\n- `            LogPrintf(""Upgrading wallet to HD\n"");` (L4131)\n- `            LogPrintf(""Upgrading wallet to use HD chain split\n"");` (L4143)",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r197151352,197151352,src/wallet/wallet.cpp
jnewbery,2018-06-21T14:21:27Z,I think this should just be changed to a `WalletLogPrintf`. I don't think this needs to be in the RPC category.,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r197151664,197151664,src/wallet/feebumper.cpp
PierreRochard,2018-06-22T19:12:17Z,"Agree empty is ugly, I'm ended up changing it to be like the GUI and put `default wallet` there instead, so that it's explicit.",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r197542929,197542929,src/wallet/wallet.h
PierreRochard,2018-06-22T19:12:28Z,Fixed,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r197542972,197542972,src/wallet/wallet.cpp
PierreRochard,2018-06-22T19:12:46Z,Fixed,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r197543050,197543050,src/wallet/wallet.cpp
PierreRochard,2018-06-22T19:13:04Z,Fixed,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r197543114,197543114,src/wallet/feebumper.cpp
l2a5b1,2018-07-06T21:02:55Z,"A minor improvement could be to separate logging from the wallet interface by (i) implementing `WalletLogPrintf` as a non-member function; or (ii) implementing a `CWallet::GetDebugString(...)`-like method that returns the debug string, which can be passed to the `LogPrintf` macro.",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r200768817,200768817,src/wallet/wallet.h
Empact,2018-07-09T04:10:04Z,Maybe a method like `CWallet::DisplayName` is called for - the concept is used in e.g. https://github.com/bitcoin/bitcoin/blob/88a15ebc8d317a6fd4851adb344ff944d497284c/src/qt/bitcoingui.cpp#L509,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r200877207,200877207,src/wallet/wallet.h
Empact,2018-07-09T04:13:45Z,Seems like a need for `GetDisplayName` here.,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r200877489,200877489,src/wallet/rpcdump.cpp
l2a5b1,2018-07-19T22:24:15Z,nit: whitespace (alignment is off by one space).,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r203891119,203891119,src/wallet/wallet.cpp
PierreRochard,2018-07-19T23:32:55Z,Fixed,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r203902572,203902572,src/wallet/wallet.cpp
PierreRochard,2018-07-19T23:33:14Z,Fixed,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r203902623,203902623,src/wallet/rpcdump.cpp
PierreRochard,2018-07-19T23:33:28Z,"@251Labs I was hoping that there'd be an approach so that the logging user can call `LogPrintf` and not have to think about the context - the macro or some other magic would automatically add the wallet name if it's available in that context. Ultimately I think that kind of improvement would be part of a wider (structured) logging refactoring.\n\n@Empact agree, I've factored out a `CWallet::GetD",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r203902665,203902665,src/wallet/wallet.h
achow101,2018-07-19T23:43:15Z,Extra whitespace on this line is causing the linter to fail.,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r203904080,203904080,src/wallet/wallet.h
PierreRochard,2018-07-19T23:52:59Z,"Ah thank you, I'll take it as an opportunity to add comments, that should fix it",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r203905369,203905369,src/wallet/wallet.h
l2a5b1,2018-07-20T12:59:52Z,"Thanks @PierreRochard, yeah you're absolutely right about that. \n\nI was thinking about something more straightforward. \n\nThe gist of my suggestion was to *just* extract (or remove) `WalletLogPrintf` from the wallet for the advantages that this may provide.\n\nWhen extracted the signature of `WalletLogPrintf` could look something like this:\n\n```c++\ntemplate<typename... Params> \nvo",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r204035503,204035503,src/wallet/wallet.h
jnewbery,2018-07-27T14:39:28Z,"sanitize inputs please :)\n\n```\n/home/ubuntu/bitcoin\n→ bcli createwallet ""a%ib""\n{\n  ""name"": ""a%ib"",\n  ""warning"": """"\n}\n/home/ubuntu/bitcoin\n→ tail -30 ../.bitcoin/regtest/debug.log\n2018-07-27T14:36:38Z tor: Not connected to Tor control port 127.0.0.1:9051, trying to reconnect\n2018-07-27T14:36:40Z tor: Error connecting to Tor control socket\n2018-07-27T14:36:40Z tor: Not conn",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r205796531,205796531,src/wallet/wallet.h
MarcoFalke,2018-08-01T20:35:09Z,"This would probably conflict with unicode support in wallet file names, no?",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r207022362,207022362,src/wallet/wallet.h
MarcoFalke,2018-08-01T20:40:32Z,Should probably escape or quote instead.,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r207023884,207023884,src/wallet/wallet.h
MarcoFalke,2018-08-01T20:52:54Z,"If you prefix this, it would be better to not change the translation string. I.e. `strprintf(""%s "" + _(""Imp...`",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r207027600,207027600,src/wallet/rpcdump.cpp
MarcoFalke,2018-08-01T20:53:27Z,Same here and all cases below ...,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r207027776,207027776,src/wallet/wallet.cpp
MarcoFalke,2018-08-01T20:54:42Z,Is this one fixed?,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r207028162,207028162,src/wallet/wallet.cpp
laanwj,2018-08-02T11:33:37Z,agree (especially if you want this in 0.17.0),https://github.com/bitcoin/bitcoin/pull/12992#discussion_r207193012,207193012,src/wallet/rpcdump.cpp
PierreRochard,2018-08-02T12:30:41Z,"@MarcoFalke I definitely agree that escape or quote would be better than sanitize (which simply drops characters), however the only existing escape functions I found were in leveldb, qt, and univalue. Any advice before I try my hand at adding one?",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r207207637,207207637,src/wallet/wallet.h
skeees,2018-08-02T12:35:04Z,"Rather than adding an escape fn another option is to just \n```\nLogPrintf(""%s "" + fmt, GetDisplayName(), parameters...)\n```",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r207208792,207208792,src/wallet/wallet.h
MarcoFalke,2018-08-02T12:42:24Z,Good point!,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r207210796,207210796,src/wallet/wallet.h
PierreRochard,2018-08-02T19:20:40Z,Fixed,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r207343878,207343878,src/wallet/rpcdump.cpp
PierreRochard,2018-08-02T19:20:43Z,Fixed,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r207343889,207343889,src/wallet/wallet.cpp
PierreRochard,2018-08-02T19:21:47Z,Thank you @skeees! That worked very well,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r207344169,207344169,src/wallet/wallet.h
jnewbery,2018-08-08T14:17:10Z,This has changed the translation string. Do we want to revert it before V0.17?,https://github.com/bitcoin/bitcoin/pull/12992#discussion_r208598179,208598179,src/wallet/wallet.cpp
jnewbery,2018-08-08T14:19:10Z,"Since the format of this log is being changed in this PR, does it make sense to make the log a bit clearer. Something like:\n\n```\n""wallet completed loading in %15dms\n"", GetTimeMillis() - nStart\n```\n",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r208598963,208598963,src/wallet/wallet.cpp
jnewbery,2018-08-08T14:20:11Z,"Again, this log could be made clearer as part of this or a follow-up PR:\n\n```\n""rescan completed in %15dms\n"", GetTimeMillis() - nStart\n```",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r208599381,208599381,src/wallet/wallet.cpp
PierreRochard,2018-08-08T15:07:14Z,"Yes, reverted in https://github.com/bitcoin/bitcoin/pull/13911 and I'll open up a post-0.17 PR for `InitMessage`, `InitWarning`, and `InitError` messages",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r208618929,208618929,src/wallet/wallet.cpp
PierreRochard,2018-08-08T15:07:28Z,"Agree, fixed in https://github.com/bitcoin/bitcoin/pull/13911",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r208619007,208619007,src/wallet/wallet.cpp
PierreRochard,2018-08-08T15:07:33Z,"Agree, fixed in https://github.com/bitcoin/bitcoin/pull/13911",https://github.com/bitcoin/bitcoin/pull/12992#discussion_r208619038,208619038,src/wallet/wallet.cpp
