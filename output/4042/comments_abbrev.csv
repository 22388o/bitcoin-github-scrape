gmaxwell,2014-04-10T04:48:22Z,"I like this approach much better. Fully statically linking glibc is usually a bad idea, I've spent many an hour tracking down mysterious name resolution failures from static libc.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40042753,40042753,
wtogami,2014-04-10T05:30:44Z,"This should also benefit from ASLR, which was not possible with static linked glibc.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40044446,40044446,
laanwj,2014-04-10T06:08:26Z,"Static may be a bad idea, but it is the only way to be consistently compatible with a lot of old releases without extra maintenance overhead.\n\nI feel scared importing parts of the C and C++ libraries into bitcoin. Any change in the code may make it necessary to extend glibcxx_compat.cpp /  src/glibc_compat.cpp with 'one more function'. If there are implementation problems in those files it will ",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40046051,40046051,
theuni,2014-04-10T06:14:47Z,"Agreed on the overhead, but I do think that it's the best of all evils. We'd basically just have to keep an eye on it, and update as necessary. As for debugging though, as @gmaxwell pointed out, this makes it substantially easier, not harder.\n\nAnyway, release decisions should be locked in far earlier than they have been in the past. With a sane procedure, we'd know how we stand on final back-com",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40046325,40046325,
laanwj,2014-04-10T06:24:56Z,"Half related, but more urgent if the gitian-shipped and self-built executables further diverge in implementation: we should make gitian build external debug information files (not to be shipped, just for our own use). This makes it possible to debug crashes in the gitian builds as well as to resolve crash dumps that people send.\n\nWorking on test builds...\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40046762,40046762,
theuni,2014-04-10T06:29:54Z,That's one of the benefits of being deterministic :)\n\n'objcopy --only-keep-debug' on the pre-stripped binaries should be enough to track things down in the future.\n,https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40047003,40047003,
laanwj,2014-04-10T08:48:48Z,"Test builds available here:\nhttps://download.visucore.com/bitcoin/bitcoin-f17e2c7-linux.tar.gz\nhttps://download.visucore.com/bitcoin/bitcoin-f17e2c7-linux.tar.gz.sig\n\nIf you help testing, please let us know what you tested, and on what OS version and architecture.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40055726,40055726,
theuni,2014-04-11T02:27:59Z,"moved to compat/ and force-pushed, since nothing else changed.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40165236,40165236,
theuni,2014-04-11T02:52:39Z,"pinging @anton000, @jcea, and @norbertVC since they spoke up in the other PR. Would be great if you could test the binaries from @laanwj.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40166295,40166295,
anton000,2014-04-11T10:18:55Z,@laanwj  bins run fine on fully updated CentOS 6.5 64-bit. Currently offshore so cant test 32bit on my box as of yet.  \n,https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40189608,40189608,
sipa,2014-04-11T10:52:44Z,"Do any of the functions reimplemented by this patch actually get called from within Bitcoin? In particular, from within consensus-critical code?\n\nIs there any risk of this code not being exactly compatible with the libc/libstdc++ version the rest of the code is linked with? What if some of the implementation assumptions in std::list change?\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40191852,40191852,
laanwj,2014-04-11T11:07:03Z,"> Do any of the functions reimplemented by this patch actually get called from within Bitcoin? In particular, from within consensus-critical code?\n\nThat would be useful to investigate.\n\n> Is there any risk of this code not being exactly compatible with the libc/libstdc++ version the rest of the code is linked with? What if some of the implementation assumptions in std::list change?\n\nA signif",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40192694,40192694,
sipa,2014-04-11T11:42:54Z,"To be clear: I like this solution a lot, but I want to understand the risks.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40194972,40194972,
theuni,2014-04-11T17:19:35Z,"@sipa obviously memcpy does. But I think that one is pretty self-explanatory.\n\nAs for the c++ ones, they have a specific purpose, just that the definitions were moved from the header to the binary implementation. I think it's safe to say that the purpose of those functions won't change. The only danger I can imagine is that they could (for example) change the side-effects of an internal function",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40227607,40227607,
theuni,2014-04-11T17:24:55Z,"Also worth noting that we may be able to drop some of these (the what()s look like good candidates) with smarter linking. Namely -ffunctions-sections + -Wl,--gc-sections, or by enabling lto. Unfortunately, these would need to be used for all dependencies as well since we link statically, so they wouldn't be trivial to pull off.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40228146,40228146,
theuni,2014-04-11T17:25:28Z,"@Diapolo old habit, will fix.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40228193,40228193,
theuni,2014-04-11T17:39:08Z,"One last point. The libstdc++ stubs shouldn't be called in older distros anyway. The fact that those symbols aren't present means that their libs don't expect those functions to exist.. they're routed elsewhere. They just need to be present to satisfy the runtime linker.\n\nPoint being that the testing of these needs to happen on _newer_ distros, rather than old. For old distros, pass/fail should ",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40229555,40229555,
theuni,2014-04-11T18:30:03Z,"Err.. above, out-of-range is simple enough, I meant that I hadn't looked deeply into ctype<char>::_M_widen_init.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40238511,40238511,
theuni,2014-04-11T18:48:00Z,"(last spam here, I'm just trying to hit all of this at once)\n\nSee here for the _M_widen_init move: http://gcc.gnu.org/git/?p=gcc.git;a=commitdiff;h=2dbdf201fad2ea4c13a4826e515dc76cb66f84dd\n\nlibstdc++ even implements it several times (eww). So the abi is pretty much locked in.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40240291,40240291,
BitcoinPullTester,2014-04-11T23:33:56Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/05c20a553a12d03b1512a75973674c6d25534259 for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/cu",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40263532,40263532,
laanwj,2014-04-12T09:11:54Z,"Compiling everything with -lto would be interesting. As we compile everything including the dependencies from source I expect that there would be quite some savings. On the other hand, the compile time and memory usage juggling all those symbols may make this infeasible. But it's good to keep in mind.\n\n> One last point. The libstdc++ stubs shouldn't be called in older distros anyway. The fact th",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40275751,40275751,
theuni,2014-04-12T15:19:47Z,"@laanwj I had a long explanation written up before I realized that you were right and I was wrong :)\n\nYou're overlooking how the function is called, but in these cases, it doesn't matter. For example, _M_unhook() is called by _M_erase(). If _M_erase were present in the libstdc++ shared lib, it would call whichever unhook implementation was hard-coded into it. But, as far as I can see, all of our",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40283195,40283195,
kristovatlas,2014-04-14T00:06:26Z,"@laanwj can this also be tested for debian 6 squeeze? this is what Tails is based on, which is the basis of my interest in this issue, since I want people to easily use Bitcoin Core with Tor.\n\nEdit: Here's the results of running the 32-bit binaries in the latest version of tails (0.23):\n...\namnesia@amnesia:~/bitcoin-f17e2c7-linux/bin/32$ ./bitcoin-qt\n./bitcoin-qt: symbol lookup error: ./bitco",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40324470,40324470,
theuni,2014-04-14T01:06:53Z,"@kristovatlas Thanks for testing. Looks like qt drags in some other symbols. I'll take a look.\n\nAnd yes, Debian stable is my primary motivation.\n\nEdit: Mm, I misread you. Squeeze is a target too, though.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40326155,40326155,
theuni,2014-04-14T01:23:16Z,"Ok, those are coming from Qt itself.\n\n@laanwj Why are we using shared qt?\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40326639,40326639,
laanwj,2014-04-14T05:09:50Z,"@theuni Statically linking Qt on Linux sucks. If you don't use the system's Qt, you'll lose system-specific theming and plugins (ubuntu appmenu integration, etc). Also, statically linking all the dependencies of Qt (such as X11 libs, possibly OpenGL) is a horrible mess in general.\n\nHow can this be a problem here? The system's Qt should not use any symbols that are not in the system's glibc.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40333638,40333638,
theuni,2014-04-14T05:19:38Z,"@laanwj I'll reserve judgement on the Qt static link since I haven't looked into it before for Linux. I'll take your word for it, but I'm curious so I'll research a bit. Qt (qt5 at least) dyloads GL and friends via plugins, specifically to avoid compile-time dependencies. It may be worth looking into using qt5 for that reason.\n\nThose aren't missing glibc symbols, they're missing qt symbols. The ",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40333946,40333946,
laanwj,2014-04-14T05:22:41Z,"Last time I tried it was a mess, but you're welcome to try.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40334042,40334042,
wtogami,2014-04-14T09:35:17Z,"> To be more specific, Precise links against qt 4.8, Squeeze uses 4.6.\n\nIf this is the case, then this would not be a regression from the lucid-based gitian builds of Bitcoin 0.8.x.  We should not attempt to support things that old.\n\nIsn't Debian stable now 7 or Wheezy?\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40348133,40348133,
quel,2014-04-15T02:09:13Z,@wtogami Debian stable is currently 7/Wheezy and qt is 4.8.  The strangest build requirement for bitcoin on Debian 7 is that we have to forward port/pull db4.8 from Debian 6/Squeeze/oldstable as db5.1 is the default on 7.\n,https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40438740,40438740,
wtogami,2014-04-15T02:12:58Z,@quel This statement of fact has nothing to do with the gitian binary.\n,https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40438920,40438920,
quel,2014-04-15T02:19:30Z,@wtogami I will test the gitian binary on Debian 6 and 7 if I can ever pull it.  I'm averaging 15KB/s.\n,https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40439234,40439234,
quel,2014-04-15T03:02:46Z,"@wtogami https://download.visucore.com/bitcoin/bitcoin-f17e2c7-linux.tar.gz with gpg signature verified on Deiban 7.4, x86_64, running bin/64 for bitcoind, bitcoin-cli, and bitcoin-qt run for me without errors.  That tar.gz appears to be dated 2014-04-10 08:22:55.  Additionally, on a 64-bit platform running the 32-bit binaries works without issue as well.  Besides click testing and basic cli testi",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40441214,40441214,
wtogami,2014-04-17T21:15:16Z,@theuni Anything else in particular do you think needs testing before merge?\n,https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40763765,40763765,
theuni,2014-04-18T00:00:28Z,"@wtogami For the most part, I think these are pretty much all or nothing. If bitcoind starts up successfully and runs for a few seconds, I don't believe any problems would be likely to surface afterward.\n\nIf anyone is uncomfortable with that response, I can look into adding some tests, but they're low level enough that the tests would be something like:\n\n```\nstd::list<int> foo, bar;\nfoo.push",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40775770,40775770,
laanwj,2014-04-18T07:23:31Z,"@theuni It would be nice to have at least tests that (indirectly) make use of the more complex functions in the compat/ files, like those in list_node and ctype<char>::_M_widen_init(). \nI don't care so much about all the errors, exceptions variants.\n\nAs for policy, we want to stay compatible with:\n- GLIBC_2.13+\n- GLIBCXX_3.4+\n\nRight? Let's write these things down and put them in some docume",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40792035,40792035,
theuni,2014-04-18T08:22:33Z,"@laanwj See my comment above about the low-level-ness of these functions. The example above wasn't abstract, that would be the actual test-case for list_node.\n\nAs for _M_widen_init(), this is all it takes is this to bring it in:\n\n``` c++\n#include <iostream>\nint main()\n{\n  for(int i=0; i != 2; i++)\n    std::cout << std::endl;\n}\n```\n\nYou can verify that by doing a quick compile and grep",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40794642,40794642,
laanwj,2014-04-18T09:56:32Z,"Low level is fine. If no difficult contortions are needed to bring the symbols in and test them, then that's all the better. Let's add those two examples that you give as sanity tests (maybe use std::iostream instead of std::cout so that no standard output is generated).\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40799123,40799123,
wtogami,2014-04-18T21:11:52Z,Lucid is glibc-2.11\nRHEL6 is glibc-2.12\n,https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40844942,40844942,
sipa,2014-04-18T21:46:13Z,"I wonder whether we want something like a start-up test at runtime, rather than unit tests (which wouldn't catch being loaded with an incompatible dynamic library).\n\nIt could also do something like a basic (and very short) memory test, or computing some EC identity to check verification correctness. On the other hand, systems that are sufficiently broken to be detected using a subsecond test lik",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40847318,40847318,
theuni,2014-04-18T21:52:44Z,"@sipa: This is compatible back to glibc 2.9 and libstdc++ 3.4. Qt is a different story though, I'm afraid, see the discussion above.\n\nI agree that a startup check would be better. I still can't really wrap my head around what a unit-test would actually be able to verify.\n\nBasically every operation at startup would depend on these in some way, so I agree that it likely wouldn't get as far as ru",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40847793,40847793,
laanwj,2014-04-19T06:57:03Z,"@sipa Good idea on a start-up sanity check.\n\n@theuni Ok let's make the policy then:\n- GLIBC_2.11+\n- GLIBCXX_3.4+\n\nWe could even add a script that automatically checks the post-gitian executables if 'forbidden' symbols have been used, hence the compat/ wrappers needs updating.\n\nI don't care about Qt there but only bitcoind/bitcoin-cli. The older stable distributions are almost exclusively u",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-40862697,40862697,
gmaxwell,2014-04-22T07:43:41Z,"@sipa ACK on the startup built in self-tests, the fact that e.g. on current fedora the fact that secp256k1 isn't supported in openssl is only 'detected' by a failed assertion deep inside key.cpp when other things run is somewhat concerning to me... but doesn't need to be part of this pull.\n",https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-41012112,41012112,
wtogami,2014-04-22T14:22:40Z,+1 to doing sanity checks as the next PR.  This current PR is ready for merge.\n\nACK\n,https://github.com/bitcoin/bitcoin/pull/4042#issuecomment-41045345,41045345,
laanwj,2014-04-10T06:00:46Z,I'd prefer to move these source files to `src/compat`. Let's keep them separate from the main bitcoin source.\n,https://github.com/bitcoin/bitcoin/pull/4042#discussion_r11470995,11470995,src/glibc_compat.cpp
theuni,2014-04-10T06:06:42Z,"Sure, makes sense.\n",https://github.com/bitcoin/bitcoin/pull/4042#discussion_r11471089,11471089,src/glibc_compat.cpp
Diapolo,2014-04-11T12:46:53Z,That file and the above one don't seem to use our 4 spaces indentation rule.\n,https://github.com/bitcoin/bitcoin/pull/4042#discussion_r11530150,11530150,src/compat/glibcxx_compat.cpp
