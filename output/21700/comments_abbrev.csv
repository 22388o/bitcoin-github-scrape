practicalswift,2021-04-15 15:18:02,"Wow great work @vasild! Love it. Will review.\n\nSuper strong Concept ACK obviously :)",https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-820512046,820512046,
DrahtBot,2021-04-15 19:26:40,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21506 (p2p, refactor: make NetPermissionFlags an enum class by jonatack)\n\nIf you consider this pull request important, ",https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-820677437,820677437,
vasild,2021-04-16 06:19:05,`386676a9f...6b86187a8`: use the proper socket variable after `std::move`,https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-820938399,820938399,
practicalswift,2021-04-16 09:34:54,"Random note:\n\nAFAICT the only remaining non-test usage of `SOCKET Socket::Get()` after this PR is this call in `CreateSockTCP(â€¦)`:\n\n```\n    // Set the non-blocking option on the socket.\n    if (!SetSocketNonBlocking(sock->Get(), true)) {\n```\n\nWhat about adding `Socket::SetNonBlocking(bool)` as part of this PR? That would allow us to drop `Socket::Get` (from `sock.h` at least), wh",https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-821051430,821051430,
vasild,2021-04-16 10:05:30,"I actually did that, but then removed this change because I realized it is not necessary - `CreateSockTCP()` is never supposed to be fuzz- or unit- tested. In fuzz/unit tests we override the global `CreateSock()` to do something else than the real `CreateSockTCP()`.\n\nI think it is still useful to have `Get()`. If removed then what about the unit tests that use it? Maybe if at some point `Sock`",https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-821068471,821068471,
practicalswift,2021-04-16 10:19:13,"More random notes:\n\nThese are the direct uses of socket related syscalls and library functions with this PR applied:\n\n```\n$ git grep -E '[^a-z_:.](accept|bind|connect|getsockopt|listen|poll|recv|select|send|setsockopt|socket)\(' -- \\n      ""src/"" "":(exclude)src/compat/stdin.cpp"" "":(exclude)src/qt/"" "":(exclude)src/test/"" \\n      "":(exclude)src/wallet/"" | grep -vE ""\.(cpp|h): *(//|\*|L",https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-821075605,821075605,
vasild,2021-04-16 10:40:03,"Moving `CreateSockTCP()` - it makes sense if it works (e.g. does not create a circular dependency).\n\nLooking at the above list - it is not that many left! :) (btw `close(2)` is missing)",https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-821086342,821086342,
vasild,2021-04-16 14:44:22,`6b86187a8...9155dee01`: use pointers to `Sock` so that mocking via inheritance works properly,https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-821227891,821227891,
practicalswift,2021-04-18 21:23:39,"Here is a patch that removes some unused code (+22 -30), further encapsulates socket operations to `Sock` (`src/util/sock.{cpp,h}`) and gets rid of the last non-test use of `Sock::Get`.\n\nFeel free to use as you wish! :)\n\n```diff\ndiff --git a/src/netbase.cpp b/src/netbase.cpp\nindex b03fd1028..69ef63b0e 100644\n--- a/src/netbase.cpp\n+++ b/src/netbase.cpp\n@@ -303,8 +303,7 @@ enum cla",https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-822064126,822064126,
vasild,2021-04-19 12:53:57,"`9155dee01...6a91cac15`:\n* take the [above patch](https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-822064126) that adds `Sock::SetNonBlocking()`\n* remove the newly added tests - they require ""all or nothing"" - to remove all occurrences of `Sock::Get()` and `Sock::Release()` otherwise dummy values of `Sock::m_socket` from the mocked `Sock` implementation leak into the main code during",https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-822443198,822443198,
vasild,2021-04-21 12:52:32,`6a91cac15...67097b29c`: fix Windows compilation,https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-824035395,824035395,
jonatack,2021-04-27 17:32:20,Concept ACK,https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-827783940,827783940,
vasild,2021-05-07 16:18:31,"Closing: superseded by https://github.com/bitcoin/bitcoin/pull/21878 which replaces all usage of `SOCKET` with `Sock` and removes `Sock::Get()` and `Sock::Release()`, making it impossible to leak dummy file descriptors from mocked `Sock` implementations into the real code during tests (and accidentally call `close()`, `write()` or whatever on the dummy fds during tests).",https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-834587046,834587046,
