[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/820512046",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-820512046",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21700",
    "id": 820512046,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMDUxMjA0Ng==",
    "user": {
      "login": "practicalswift",
      "id": 7826565,
      "node_id": "MDQ6VXNlcjc4MjY1NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7826565?u=5ff13e375b40ea55ecd3c108337dd6a23f68eddf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/practicalswift",
      "html_url": "https://github.com/practicalswift",
      "followers_url": "https://api.github.com/users/practicalswift/followers",
      "following_url": "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url": "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
      "organizations_url": "https://api.github.com/users/practicalswift/orgs",
      "repos_url": "https://api.github.com/users/practicalswift/repos",
      "events_url": "https://api.github.com/users/practicalswift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/practicalswift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-15T15:18:02Z",
    "updated_at": "2021-04-15T15:18:02Z",
    "author_association": "CONTRIBUTOR",
    "body": "Wow great work @vasild! Love it. Will review.\r\n\r\nSuper strong Concept ACK obviously :)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/820512046/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/820677437",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-820677437",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21700",
    "id": 820677437,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMDY3NzQzNw==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-15T19:26:40Z",
    "updated_at": "2021-05-03T16:59:07Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21506 (p2p, refactor: make NetPermissionFlags an enum class by jonatack)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/820677437/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/820938399",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-820938399",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21700",
    "id": 820938399,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMDkzODM5OQ==",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-16T06:19:05Z",
    "updated_at": "2021-04-16T06:19:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "`386676a9f...6b86187a8`: use the proper socket variable after `std::move`",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/820938399/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821051430",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-821051430",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21700",
    "id": 821051430,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMTA1MTQzMA==",
    "user": {
      "login": "practicalswift",
      "id": 7826565,
      "node_id": "MDQ6VXNlcjc4MjY1NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7826565?u=5ff13e375b40ea55ecd3c108337dd6a23f68eddf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/practicalswift",
      "html_url": "https://github.com/practicalswift",
      "followers_url": "https://api.github.com/users/practicalswift/followers",
      "following_url": "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url": "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
      "organizations_url": "https://api.github.com/users/practicalswift/orgs",
      "repos_url": "https://api.github.com/users/practicalswift/repos",
      "events_url": "https://api.github.com/users/practicalswift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/practicalswift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-16T09:34:54Z",
    "updated_at": "2021-04-16T09:34:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "Random note:\r\n\r\nAFAICT the only remaining non-test usage of `SOCKET Socket::Get()` after this PR is this call in `CreateSockTCP(\u2026)`:\r\n\r\n```\r\n    // Set the non-blocking option on the socket.\r\n    if (!SetSocketNonBlocking(sock->Get(), true)) {\r\n```\r\n\r\nWhat about adding `Socket::SetNonBlocking(bool)` as part of this PR? That would allow us to drop `Socket::Get` (from `sock.h` at least), which in turn would mean that there is no risk of a `SOCKET` \"escaping\" `Socket` (other than using `Socket::Release`, and `Socket::Release` makes is clear that the responsibility of closing is taken over by the caller).\r\n\r\nWDYT? :)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821051430/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821068471",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-821068471",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21700",
    "id": 821068471,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMTA2ODQ3MQ==",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-16T10:05:30Z",
    "updated_at": "2021-04-16T10:05:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "I actually did that, but then removed this change because I realized it is not necessary - `CreateSockTCP()` is never supposed to be fuzz- or unit- tested. In fuzz/unit tests we override the global `CreateSock()` to do something else than the real `CreateSockTCP()`.\r\n\r\nI think it is still useful to have `Get()`. If removed then what about the unit tests that use it? Maybe if at some point `Sock` is used all over the place, then both `Get()` and `Release()` could be removed.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821068471/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821075605",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-821075605",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21700",
    "id": 821075605,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMTA3NTYwNQ==",
    "user": {
      "login": "practicalswift",
      "id": 7826565,
      "node_id": "MDQ6VXNlcjc4MjY1NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7826565?u=5ff13e375b40ea55ecd3c108337dd6a23f68eddf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/practicalswift",
      "html_url": "https://github.com/practicalswift",
      "followers_url": "https://api.github.com/users/practicalswift/followers",
      "following_url": "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url": "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
      "organizations_url": "https://api.github.com/users/practicalswift/orgs",
      "repos_url": "https://api.github.com/users/practicalswift/repos",
      "events_url": "https://api.github.com/users/practicalswift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/practicalswift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-16T10:19:13Z",
    "updated_at": "2021-04-16T10:19:13Z",
    "author_association": "CONTRIBUTOR",
    "body": "More random notes:\r\n\r\nThese are the direct uses of socket related syscalls and library functions with this PR applied:\r\n\r\n```\r\n$ git grep -E '[^a-z_:.](accept|bind|connect|getsockopt|listen|poll|recv|select|send|setsockopt|socket)\\(' -- \\\r\n      \"src/\" \":(exclude)src/compat/stdin.cpp\" \":(exclude)src/qt/\" \":(exclude)src/test/\" \\\r\n      \":(exclude)src/wallet/\" | grep -vE \"\\.(cpp|h): *(//|\\*|Log|\\\"|ListenSocket|throw|strprintf)\"\r\nsrc/net.cpp:            nBytes = send(node.hSocket, reinterpret_cast<const char*>(data.data()) + node.nSendOffset, data.size() - node.nSendOffset, MSG_NOSIGNAL | MSG_DONTWAIT);\r\nsrc/net.cpp:    SOCKET hSocket = accept(hListenSocket.socket, (struct sockaddr*)&sockaddr, &len);\r\nsrc/net.cpp:    if (poll(vpollfds.data(), vpollfds.size(), SELECT_TIMEOUT_MILLISECONDS) < 0) return;\r\nsrc/net.cpp:    int nSelect = select(hSocketMax + 1, &fdsetRecv, &fdsetSend, &fdsetError, &timeout);\r\nsrc/net.cpp:                nBytes = recv(pnode->hSocket, (char*)pchBuf, sizeof(pchBuf), MSG_DONTWAIT);\r\nsrc/netbase.cpp:    SOCKET hSocket = socket(((struct sockaddr*)&sockaddr)->sa_family, SOCK_STREAM, IPPROTO_TCP);\r\nsrc/util/sock.cpp:    return send(m_socket, static_cast<const char*>(data), len, flags);\r\nsrc/util/sock.cpp:    return recv(m_socket, static_cast<char*>(buf), len, flags);\r\nsrc/util/sock.cpp:    return connect(m_socket, addr, addr_len);\r\nsrc/util/sock.cpp:    return bind(m_socket, addr, addr_len);\r\nsrc/util/sock.cpp:    return listen(m_socket, backlog);\r\nsrc/util/sock.cpp:    return getsockopt(m_socket, level, opt_name, static_cast<char*>(opt_val), opt_len);\r\nsrc/util/sock.cpp:    return setsockopt(m_socket, level, opt_name, static_cast<const char*>(opt_val), opt_len);\r\nsrc/util/sock.cpp:    if (poll(&fd, 1, count_milliseconds(timeout)) == SOCKET_ERROR) {\r\nsrc/util/sock.cpp:    if (select(m_socket + 1, &fdset_recv, &fdset_send, nullptr, &timeout_struct) == SOCKET_ERROR) {\r\n```\r\n\r\nGreat to see our socket related syscalls and library functions being further encapsulated by `Socket` (`src/util/sock.cpp`). It simplifies fuzzing, it simplifies syscall analysis and generally makes our socket use easier to reason about. Great stuff! :)\r\n\r\nThe remaining `src/net.cpp` cases are probably out of scope for this PR, but what about moving `CreateSockTCP` from `src/netbase.{cpp,h}` to `src/util/sock.{cpp,h}`. I think it belongs there and it would then make `src/net.cpp` the only remaining place where we make direct use of socket related syscalls and library functions without using `Socket`. WDYT @vasild?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821075605/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821086342",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-821086342",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21700",
    "id": 821086342,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMTA4NjM0Mg==",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-16T10:40:03Z",
    "updated_at": "2021-04-16T10:40:03Z",
    "author_association": "CONTRIBUTOR",
    "body": "Moving `CreateSockTCP()` - it makes sense if it works (e.g. does not create a circular dependency).\r\n\r\nLooking at the above list - it is not that many left! :) (btw `close(2)` is missing)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821086342/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821227891",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-821227891",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21700",
    "id": 821227891,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMTIyNzg5MQ==",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-16T14:44:22Z",
    "updated_at": "2021-04-16T14:44:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "`6b86187a8...9155dee01`: use pointers to `Sock` so that mocking via inheritance works properly",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/821227891/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822064126",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-822064126",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21700",
    "id": 822064126,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMjA2NDEyNg==",
    "user": {
      "login": "practicalswift",
      "id": 7826565,
      "node_id": "MDQ6VXNlcjc4MjY1NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7826565?u=5ff13e375b40ea55ecd3c108337dd6a23f68eddf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/practicalswift",
      "html_url": "https://github.com/practicalswift",
      "followers_url": "https://api.github.com/users/practicalswift/followers",
      "following_url": "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url": "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
      "organizations_url": "https://api.github.com/users/practicalswift/orgs",
      "repos_url": "https://api.github.com/users/practicalswift/repos",
      "events_url": "https://api.github.com/users/practicalswift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/practicalswift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-18T21:23:39Z",
    "updated_at": "2021-04-18T21:27:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "Here is a patch that removes some unused code (+22 -30), further encapsulates socket operations to `Sock` (`src/util/sock.{cpp,h}`) and gets rid of the last non-test use of `Sock::Get`.\r\n\r\nFeel free to use as you wish! :)\r\n\r\n```diff\r\ndiff --git a/src/netbase.cpp b/src/netbase.cpp\r\nindex b03fd1028..69ef63b0e 100644\r\n--- a/src/netbase.cpp\r\n+++ b/src/netbase.cpp\r\n@@ -303,8 +303,7 @@ enum class IntrRecvError {\r\n  *          read.\r\n  *\r\n  * @see This function can be interrupted by calling InterruptSocks5(bool).\r\n- *      Sockets can be made non-blocking with SetSocketNonBlocking(const\r\n- *      SOCKET&, bool).\r\n+ *      Sockets can be made non-blocking with Sock::SetNonBlocking().\r\n  */\r\n static IntrRecvError InterruptibleRecv(uint8_t* data, size_t len, int timeout, const Sock& sock)\r\n {\r\n@@ -520,7 +519,7 @@ std::unique_ptr<Sock> CreateSockTCP(const CService& address_family)\r\n     }\r\n\r\n     // Set the non-blocking option on the socket.\r\n-    if (!SetSocketNonBlocking(sock->Get(), true)) {\r\n+    if (!sock->SetNonBlocking()) {\r\n         LogPrintf(\"Error setting socket to non-blocking: %s\\n\", NetworkErrorString(WSAGetLastError()));\r\n         return nullptr;\r\n     }\r\n@@ -718,33 +717,6 @@ bool LookupSubNet(const std::string& strSubnet, CSubNet& ret, DNSLookupFn dns_lo\r\n     return false;\r\n }\r\n\r\n-bool SetSocketNonBlocking(const SOCKET& hSocket, bool fNonBlocking)\r\n-{\r\n-    if (fNonBlocking) {\r\n-#ifdef WIN32\r\n-        u_long nOne = 1;\r\n-        if (ioctlsocket(hSocket, FIONBIO, &nOne) == SOCKET_ERROR) {\r\n-#else\r\n-        int fFlags = fcntl(hSocket, F_GETFL, 0);\r\n-        if (fcntl(hSocket, F_SETFL, fFlags | O_NONBLOCK) == SOCKET_ERROR) {\r\n-#endif\r\n-            return false;\r\n-        }\r\n-    } else {\r\n-#ifdef WIN32\r\n-        u_long nZero = 0;\r\n-        if (ioctlsocket(hSocket, FIONBIO, &nZero) == SOCKET_ERROR) {\r\n-#else\r\n-        int fFlags = fcntl(hSocket, F_GETFL, 0);\r\n-        if (fcntl(hSocket, F_SETFL, fFlags & ~O_NONBLOCK) == SOCKET_ERROR) {\r\n-#endif\r\n-            return false;\r\n-        }\r\n-    }\r\n-\r\n-    return true;\r\n-}\r\n-\r\n void InterruptSocks5(bool interrupt)\r\n {\r\n     interruptSocks5Recv = interrupt;\r\ndiff --git a/src/util/sock.cpp b/src/util/sock.cpp\r\nindex e560f5b90..7f9b6d17c 100644\r\n--- a/src/util/sock.cpp\r\n+++ b/src/util/sock.cpp\r\n@@ -107,6 +107,20 @@ bool Sock::SetNoDelay() const\r\n     return SetSockOpt(IPPROTO_TCP, TCP_NODELAY, &on, sizeof(on)) == 0;\r\n }\r\n\r\n+bool Sock::SetNonBlocking() const\r\n+{\r\n+#ifdef WIN32\r\n+    const u_long one{1};\r\n+    if (ioctlsocket(m_socket, FIONBIO, &nOne) == SOCKET_ERROR) {\r\n+#else\r\n+    const int flags{fcntl(m_socket, F_GETFL, 0)};\r\n+    if (fcntl(m_socket, F_SETFL, flags | O_NONBLOCK) == SOCKET_ERROR) {\r\n+#endif\r\n+        return false;\r\n+    }\r\n+    return true;\r\n+}\r\n+\r\n bool Sock::IsSelectable() const\r\n {\r\n #if defined(USE_POLL) || defined(WIN32)\r\ndiff --git a/src/util/sock.h b/src/util/sock.h\r\nindex 0ce2decd8..9e33b9159 100644\r\n--- a/src/util/sock.h\r\n+++ b/src/util/sock.h\r\n@@ -140,6 +140,12 @@ public:\r\n      */\r\n     [[nodiscard]] virtual bool SetNoDelay() const;\r\n\r\n+    /**\r\n+     * Set the non-blocking option on the socket.\r\n+     * @return true if set successfully\r\n+     */\r\n+    [[nodiscard]] virtual bool SetNonBlocking() const;\r\n+\r\n     /**\r\n      * Check if the underlying socket can be used for `select(2)` (or the `Wait()` method).\r\n      * @return true if selectable\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822064126/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822443198",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-822443198",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21700",
    "id": 822443198,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMjQ0MzE5OA==",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-19T12:53:57Z",
    "updated_at": "2021-04-19T12:53:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "`9155dee01...6a91cac15`:\r\n* take the [above patch](https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-822064126) that adds `Sock::SetNonBlocking()`\r\n* remove the newly added tests - they require \"all or nothing\" - to remove all occurrences of `Sock::Get()` and `Sock::Release()` otherwise dummy values of `Sock::m_socket` from the mocked `Sock` implementation leak into the main code during fuzzing.\r\n\r\nThis PR is reviewable and mergeable in its current state. I will see what it takes to remove `Sock::Get()` and `Sock::Release()` and decide whether to append to this PR or file a separate one.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822443198/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/824035395",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-824035395",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21700",
    "id": 824035395,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNDAzNTM5NQ==",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-21T12:52:32Z",
    "updated_at": "2021-04-21T12:52:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "`6a91cac15...67097b29c`: fix Windows compilation",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/824035395/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/827783940",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-827783940",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21700",
    "id": 827783940,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNzc4Mzk0MA==",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-27T17:32:20Z",
    "updated_at": "2021-04-27T17:32:20Z",
    "author_association": "MEMBER",
    "body": "Concept ACK",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/827783940/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/834587046",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21700#issuecomment-834587046",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21700",
    "id": 834587046,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgzNDU4NzA0Ng==",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-07T16:18:31Z",
    "updated_at": "2021-05-07T16:18:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "Closing: superseded by https://github.com/bitcoin/bitcoin/pull/21878 which replaces all usage of `SOCKET` with `Sock` and removes `Sock::Get()` and `Sock::Release()`, making it impossible to leak dummy file descriptors from mocked `Sock` implementations into the real code during tests (and accidentally call `close()`, `write()` or whatever on the dummy fds during tests).",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/834587046/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  }
]