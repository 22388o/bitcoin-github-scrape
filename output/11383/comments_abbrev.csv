jonasschnelli,2017-09-22T04:55:53Z,"Nice!\nWorks pretty good (played around with it a bit).\nI think this may be a first step.\n\nConceptual issues:\n* The Combox box without a direct user feedback may lead to selecting the wrong wallet. Android dual/multi-sim works against this by always displaying an icon for the SIM card the action will be executed with. Not 1:1 applicable here... but users should get A) a feedback after swi",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-331349991,331349991,
jnewbery,2017-10-05T22:01:06Z,I think we can fairly easily pull out the contentious rpcauth parts of this to make it more palatable for review. I have a branch here: https://github.com/jnewbery/bitcoin/tree/pr11383.1 which removes the first three commits and makes the one change to `rpcconsole.cpp` to make this work without rpcauth. It's also rebased on master since there was a merge conflict.,https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-334604408,334604408,
luke-jr,2017-10-06T02:51:22Z,"Rebased, eliminated `ENABLE_WALLET` stuff added to non-wallet/GUI code, and removed the dependency on `rpcauth` default wallet stuff.\n\nI did not address @jonasschnelli's GUI comments, because I feel some is best explored separately, as improvements on top of this, while others (confirming wallet changes with a prompt) I think would make the feature annoying to use.",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-334644960,334644960,
luke-jr,2017-10-12T07:34:10Z,(Note Travis failure is due to the batch request bug fixed in #11277),https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-336045870,336045870,
jnewbery,2017-10-12T18:02:34Z,#11277 is merged. Can you rebase?,https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-336218261,336218261,
luke-jr,2017-10-12T19:58:25Z,Rebased,https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-336248728,336248728,
Sjors,2017-11-20T15:07:01Z,"I tested the debug console by switching wallets (including no wallet) and using `dumpwallet`. This seems to work as expected. I also checked that wallet backups from the application menu use the correct wallet. \n\nI agree with @promag's suggestions and added a few below. I don't think any should block this PR, although some might simplify it. \n\nMaybe this is what you were saying, but I have",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-345723074,345723074,
promag,2017-11-29T00:05:53Z,"@luke-jr friendly ping, rebase needed.",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-347706904,347706904,
laanwj,2017-12-07T19:05:30Z,As per IRC discussion removing this from high priority for review until review comments get addressed.,https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-350063561,350063561,
luke-jr,2017-12-14T03:34:59Z,"Comments addressed and rebased. Also added a fix to unregister the `""/wallet/""` handler.",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-351598987,351598987,
Sjors,2018-01-02T14:23:00Z,"I tried making `m_wallet_models` of `BitcoinApplication` public in hopes of being able to use it from `bitcoingui.cpp`, `bitcoin.cpp` and `rpcconsole.cpp`, but that turned into a mess.\n\nI'm still confused as to what's supposed to be the difference between `qt/bitcoin.cpp` and `qt/bitcoin-gui.cpp`. Why are they both importing `qt/bitcoin-gui.h` and why is there `no qt/bitcoin.h`?\n\nWhy is th",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-354776352,354776352,
luke-jr,2018-01-02T20:28:29Z,"It's not copied... m_wallet_models has models, not the wallets themselves.",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-354867352,354867352,
jonasschnelli,2018-02-12T11:18:13Z,"Tested again, works.\nI think it's worth to fix...\n1. The unused signal (remove it and add it when needed)\n2. Fix the `delete ppwallet;` (move to shared pointers or similar?)",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-364894098,364894098,
luke-jr,2018-03-01T19:12:41Z,"> The unused signal (remove it and add it when needed)\n\nWhat unused signal?\n\n> Fix the delete ppwallet; (move to shared pointers or similar?)\n\nI don't know how to do this with Qt. Note that the original design here had the CWalletRef as a shared pointer type, but that still needed a new/delete for the ref itself. If someone feels like improving it, that can be done in a later PR.",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-369698228,369698228,
randolf,2018-03-01T19:19:11Z,utACK.,https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-369700109,369700109,
jonasschnelli,2018-03-02T04:24:42Z,I would recommend to remove the signal and the JSONRequest wallet member (the JSON RPC layer should not know what a wallet is) and add the URI parsing logic in `rpcconsole.cpp` (though `WalletModel` and a little refactoring of `GetWalletForJSONRPCRequest`).,https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-369816366,369816366,
luke-jr,2018-03-02T04:41:57Z,That would be ugly. :/,https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-369818426,369818426,
jonasschnelli,2018-03-02T05:01:04Z,"> That would be ugly. :/\n\nWe should just avoid overlapping layers.\nYour current design adds wallet knowhow to `JSONRPCRequest` (`server.h`) and adds a boost signal (which we are trying to get rid of) including a forward declaration in the httpserver of a wallet function.\nIt looks like you have added this only to allow getting the called wallet from within `rpcconsole.cpp`.\n\nIMO it woul",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-369821228,369821228,
luke-jr,2018-03-02T05:07:35Z,"I assume by parse, you mean fabricate...?\n\nThe JSONRPCRequest only holds a pointer. This is a good design, unlike making up and then parsing strings internally.",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-369822007,369822007,
jonasschnelli,2018-03-02T05:47:36Z,"> I assume by parse, you mean fabricate...?\n\nYes. Since the rpcconsole does already fabricate artificial JSONRPCRequests. There is nothing wrong with that. If you want to avoid the artificial JSONRPCRquest creation, you would need to get rid of it completely.\n\nSee my commit that...\n* ...remove the unnecessary coupling of server.h and wallet\n* ...removes the signal\n* ...removes ""knowh",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-369827385,369827385,
jonasschnelli,2018-03-02T05:49:19Z,"Another tiny conceptual problem is that if one switches the wallet in the main window, it does not automatically switch in the console window (Not sure if it should, but if so, it can be address in a follow up PR).",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-369827634,369827634,
luke-jr,2018-03-02T05:53:08Z,"I fundamentally disagree with that approach. It is a poor design, and assumes the RPC layer and GUI share some common wallet name table. Perhaps they do for now, but it doesn't excuse the bad design.",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-369828151,369828151,
jonasschnelli,2018-03-03T02:32:31Z,"I rewrote this PR to avoid the pointer passing and the signal & wallet-server coupling:\nhttps://github.com/bitcoin/bitcoin/compare/master...jonasschnelli:2018/03/multiwallet?expand=1\n\nIf I'm alone with my design concerns, then I'm fine dropping it. :)\nWould be good the hear other opinions: @ryanofsky @Sjors @promag ",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-370109429,370109429,
Sjors,2018-03-05T14:49:59Z,@jonasschnelli can you turn that into a PR so it's easier to provide line-by-line feedback? It seems `bool BitcoinGUI::multiWallet()` still counts UI elements (`QComboBox *m_wallet_selector` instances). Can that be avoided?,https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-370442812,370442812,
promag,2018-03-05T17:49:35Z,"In the ""Sending addresses"" and ""Receiving addresses"" dialogs, it's missing the wallet name. Not sure if the dialog title is the best place.",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-370503808,370503808,
jonasschnelli,2018-03-07T02:08:43Z,"I really like to merge this,... but I would feel pretty uncomfortable to merge code where we unnecessary glue together the RPC/HTTP layer with the wallet as well as manual pointer memory management... this is something that should be fixed in the initial PR IMO rather the count for follow up PR.",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-370997618,370997618,
luke-jr,2018-03-07T03:02:52Z,"@jonasschnelli This only *reduces/removes* existing glue between the RPC/HTTP and wallet. It doesn't add any.\n\nThe manual pointer management is unavoidable with Qt AFAIK, without resorting to worse, ugly hacks like passing it as a string (which will break as soon as we support wallet unloading).",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-371006664,371006664,
jonasschnelli,2018-03-07T03:39:15Z,"> @jonasschnelli This only reduces/removes existing glue between the RPC/HTTP and wallet. It doesn't add any.\n\nAre you referring to this PR? In this PR you are trying to add a `CWallet *wallet;` member to `JSONRPCRequest` which IMO is the wrong direction.\n\n> The manual pointer management is unavoidable with Qt AFAIK, without resorting to worse, ugly hacks like passing it as a string (which",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-371012249,371012249,
jonasschnelli,2018-03-07T03:47:04Z,">> The manual pointer management is unavoidable with Qt AFAIK, without resorting to worse, ugly hacks like passing it as a string (which will break as soon as we support wallet unloading).\n\n> Right now, we do identify wallets in multiwallet by it's filename. IMO identifying wallets by it's name is currently superior to passing around CWallet pointer with manual deallocation (delete) (which wil",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-371013452,371013452,
luke-jr,2018-03-07T04:36:40Z,"> Are you referring to this PR? In this PR you are trying to add a CWallet *wallet; member to JSONRPCRequest which IMO is the wrong direction.\n\nIndeed I am. This PR improves the situation by moving the wallet-handling logic out of the RPC/HTTP code, into the wallet-specific module. Having a reference to the wallet for the request, on the request is only reasonable. It is a shortcoming of C++ t",https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-371020176,371020176,
jonasschnelli,2018-03-26T11:59:29Z,Closing in favour of now merged #12610,https://github.com/bitcoin/bitcoin/pull/11383#issuecomment-376141235,376141235,
jonasschnelli,2017-09-22T04:32:27Z,Hmm.. not sure if we should hardcode `.dat` at this point.,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r140410333,140410333,src/qt/bitcoin.cpp
jonasschnelli,2017-09-22T04:39:43Z,"~~this `#ifdef` could be avoided/removed, right?~~",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r140410836,140410836,src/qt/bitcoingui.cpp
luke-jr,2017-09-22T04:48:51Z,It's strictly for stripping.,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r140411507,140411507,src/qt/bitcoin.cpp
luke-jr,2017-09-22T04:49:59Z,Maybe.,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r140411594,140411594,src/qt/bitcoingui.cpp
ryanofsky,2017-10-09T14:19:15Z,"In commit ""RPC: Pass wallet through JSONRPCRequest""\n\nMultiwallet rpc calls are broken in this commit (and the whole PR) because JSONRPCRequestWalletResolver is not actually registered or called anywhere. Maybe a commit was lost in the rebase? The problem causes multiwallet.py test to fail with ""Wallet file not specified""",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r143480448,143480448,src/wallet/rpcwallet.cpp
ryanofsky,2017-10-09T14:21:48Z,"In commit ""Qt: Load all wallets into WalletModels""\n\nMight be simpler to make this a vector of unique_ptr, to avoid need for manual deletions. Also since renaming this member anyway, could follow current naming convenetion (m_wallet_models).",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r143481141,143481141,src/qt/bitcoin.cpp
ryanofsky,2017-10-09T14:31:08Z,"In commit ""Qt: Ensure UI updates only come from the currently selected walletView""\n\nThis is silently dropping the `int status` value passed to `encryptionStatusChanged`, and the `int hdEnabled` value passed to `hdEnabledStatusChanged.` Assuming this is intended, you should clean up after this change by deleting the unused parameters from `encryptionStatusChanged` and `hdEnabledStatusChanged` d",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r143483738,143483738,src/qt/walletview.cpp
ryanofsky,2017-10-09T14:36:56Z,"In commit ""Qt: Add wallet selector to debug console""\n\nWhat does refcount comment mean? Is this a todo suggesting that you want to add refcounting in the future? Should clarify comment or maybe remove it.",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r143485393,143485393,src/qt/rpcconsole.cpp
ryanofsky,2017-10-09T14:47:13Z,"In commit ""Qt: When multiple wallets are used, include in notifications the name""\n\nWould be nice to follow this up by removing the `name` parameter passed to `BitcoinGUI::addWallet` to avoid duplicating .dat stripping logic.",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r143488485,143488485,src/qt/walletmodel.cpp
luke-jr,2017-10-12T06:59:57Z,Fixed,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r144207785,144207785,src/wallet/rpcwallet.cpp
luke-jr,2017-10-12T07:23:44Z,Not sure unique_ptr is the right tool for the job here. Renamed.,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r144211426,144211426,src/qt/bitcoin.cpp
luke-jr,2017-10-12T07:24:27Z,Clarified.,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r144211531,144211531,src/qt/rpcconsole.cpp
luke-jr,2017-10-12T07:24:41Z,Done.,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r144211563,144211563,src/qt/walletmodel.cpp
jonasschnelli,2017-11-16T20:33:10Z,"This gets never called, right?",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r151529418,151529418,src/httprpc.cpp
jonasschnelli,2017-11-16T20:49:45Z,use `extern`outside function scope?,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r151533092,151533092,src/httprpc.cpp
jonasschnelli,2017-11-16T20:57:39Z,"Isn't the `HTTPRequest` object unused? Why pack it into the signal, future extensions?",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r151534936,151534936,src/httprpc.cpp
jonasschnelli,2017-11-16T21:00:21Z,looks like we should use a C++11 (shared?) pointer here to avoid the manual memory management.,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r151535527,151535527,src/qt/rpcconsole.cpp
promag,2017-11-19T22:44:52Z,Do we want wallet here even an opaque pointer? ,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r151881014,151881014,src/rpc/server.h
Sjors,2017-11-22T13:04:55Z,Using a UI element to count the number of wallets doesn't seem ideal.,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r152557907,152557907,src/qt/bitcoingui.cpp
luke-jr,2017-12-14T03:15:37Z,Right,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r156845409,156845409,src/httprpc.cpp
luke-jr,2017-12-14T03:16:13Z,"Right, nor does /wallet/ get unregistered... Fixing",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r156845469,156845469,src/httprpc.cpp
luke-jr,2017-12-14T03:17:12Z,Isn't `extern` not needed (nor desirable in our codebase) for function references?,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r156845556,156845556,src/httprpc.cpp
luke-jr,2017-12-14T03:30:37Z,? This is where it belongs..,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r156846768,156846768,src/rpc/server.h
Sjors,2018-01-02T12:25:58Z,"I think a better approach is to give QT access to `std::vector<CWalletRef> vpwallets` or `m_wallet_models`, and then when the dropdown box (re-)renders itself, it should query that.\n\nThat would also avoid passing walletModel instances around like in `rpcConsole->addWallet(walletModel);`.",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r159217482,159217482,src/qt/bitcoingui.cpp
ryanofsky,2018-01-02T22:28:42Z,"https://github.com/bitcoin/bitcoin/pull/11383#discussion_r140410333\n\n> Hmm.. not sure if we should hardcode .dat at this point.\n\nNote: this is now cleaned up in a later commit (""Get wallet name from WalletModel rather than passing it around"")\n",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r159330165,159330165,src/qt/bitcoin.cpp
jonasschnelli,2018-02-12T11:15:10Z,Has to bee there I guess because of `bool setCurrentWallet(const QString& name);` being only defined if `ENABLE_WALLET`.,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r167525178,167525178,src/qt/bitcoingui.cpp
jonasschnelli,2018-02-12T11:15:40Z,Agree with @Sjors ,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r167525275,167525275,src/qt/bitcoingui.cpp
jonasschnelli,2018-02-12T11:16:14Z,nit: same line comment?,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r167525377,167525377,src/qt/bitcoingui.h
jonasschnelli,2018-03-02T04:13:00Z,"Looks after a strange design to forward decelerate this here, which is implemented in `rpcwallet.cpp` with not even a `#ifdef ENABLE_WALLET`",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r171761813,171761813,src/httprpc.cpp
jonasschnelli,2018-03-02T04:19:41Z,"Instead of the whole signal & gluing together the wallet and the RPC server, why not just refactor out `GetWalletForJSONRPCRequest` and use the same logic here? Seems much more understandable and less code.",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r171762354,171762354,src/qt/rpcconsole.cpp
jonasschnelli,2018-03-06T04:08:51Z,Why not remove the `bitcoinGui` member and always send the wallet name?,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r172404559,172404559,src/qt/walletview.cpp
luke-jr,2018-03-06T04:10:53Z,"When not in multiwallet mode, this causes the ""Wallet"" line to be omitted from the notification popup.",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r172404755,172404755,src/qt/walletview.cpp
jonasschnelli,2018-03-06T04:13:10Z,"Since only `bitcoingui.cpp` listens to the `incomingTransaction` signal, it could be added or not added there. IMO the signal emitter should not decide wether to show the wallet name or not.",https://github.com/bitcoin/bitcoin/pull/11383#discussion_r172404958,172404958,src/qt/walletview.cpp
luke-jr,2018-03-06T04:22:40Z,But there is no wallet name in single-wallet mode...,https://github.com/bitcoin/bitcoin/pull/11383#discussion_r172405813,172405813,src/qt/walletview.cpp
