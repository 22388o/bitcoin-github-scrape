DrahtBot,2021-06-17 08:26:20,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #22266 (refactor: call GetBestBlock() before NewIterator() by endjkv)\n* #22242 (Move CBlockTreeDB to node/blockstorage by",https://github.com/bitcoin/bitcoin/pull/22263#issuecomment-863040333,863040333,
practicalswift,2021-06-17 08:56:13,"Concept ACK: nice catch!\n\nNon-blocking nit: The list[1] of naked `new`:s in our code base is fairly short nowadays so it would be nice to avoid adding an unnecessary `new` to that list. Avoided by using `std::make_unique` as suggested by MarcoFalke :)\n\n[1]\n```\n$ git grep -E 'new [A-Za-z0-9_]+\(' -- ""*.cpp"" ""*.h"" "":(exclude)src/qt/"" "":(exclude)src/test/"" \\n      "":(exclude)src/bench/""",https://github.com/bitcoin/bitcoin/pull/22263#issuecomment-863061324,863061324,
jamesob,2021-06-17 13:49:54,"Thanks for the quick looks everyone. I've made both changes suggested, though it's worth noting that I had to make the `CCoinsViewDBCursor` constructor public (from private) in order to allow `std::make_unique` to compile.",https://github.com/bitcoin/bitcoin/pull/22263#issuecomment-863256211,863256211,
jnewbery,2021-06-17 15:07:46,Code review ACK 615c1adfb07b9b466173166dc2e53ace540e4b32,https://github.com/bitcoin/bitcoin/pull/22263#issuecomment-863320679,863320679,
jamesob,2021-06-18 18:17:47,"Thanks for the feedback all. I've added doc, fixed the reference type style, and made the `CCoinsViewDBCursor` private to the unit.",https://github.com/bitcoin/bitcoin/pull/22263#issuecomment-864203071,864203071,
jonatack,2021-06-19 12:26:01,"> These are basically just the two recommendations from https://abseil.io/tips/134#recommendations\n\nThanks for the informative link @ryanofsky!\n",https://github.com/bitcoin/bitcoin/pull/22263#issuecomment-864399726,864399726,
MarcoFalke,2021-06-17 05:50:58,"```suggestion\n    auto i{std::make_unique<CCoinsViewDBCursor>(const_cast<CDBWrapper&>(*m_db).NewIterator(), GetBestBlock())};\n```\n\nCan be written shorter with make_unique?",https://github.com/bitcoin/bitcoin/pull/22263#discussion_r653244619,653244619,src/txdb.cpp
jnewbery,2021-06-17 09:41:43,"Note that this isn't equivalent. Previously `coins_view_cursor` was a pointer to const data, and this is now a const pointer to mutable data. The equivalent of what we had before would be:\n\n```suggestion\n        std::unique_ptr<const CCoinsViewCursor> coins_view_cursor = backend_coins_view.Cursor();\n```\n\nIt doesn't really matter here - I'd suggest just removing the `const` keyword enti",https://github.com/bitcoin/bitcoin/pull/22263#discussion_r653402959,653402959,src/test/fuzz/coins_view.cpp
jamesob,2021-06-17 13:48:35,"Good point, thanks.",https://github.com/bitcoin/bitcoin/pull/22263#discussion_r653582893,653582893,src/test/fuzz/coins_view.cpp
jamesob,2021-06-17 13:48:47,Good call!,https://github.com/bitcoin/bitcoin/pull/22263#discussion_r653583063,653583063,src/txdb.cpp
jonatack,2021-06-18 11:12:32,"Verified the ctor needs to be public to not see `error: calling a private constructor of class 'CCoinsViewDBCursor'` when building. Could clang-format if you retouch:\n```suggestion\n    CCoinsViewDBCursor(CDBIterator* pcursorIn, const uint256& hashBlockIn):\n```\n",https://github.com/bitcoin/bitcoin/pull/22263#discussion_r654346715,654346715,src/txdb.h
jonatack,2021-06-18 11:16:56,The change in this line seems to be style only.,https://github.com/bitcoin/bitcoin/pull/22263#discussion_r654349135,654349135,src/test/fuzz/coins_view.cpp
MarcoFalke,2021-06-18 15:32:08,"Is there a reason to put this into the header? Previously the constructor was private, thus disallowing ""illegal"" access. Now, with it being public, the whole class could be moved to the cpp file?",https://github.com/bitcoin/bitcoin/pull/22263#discussion_r654523403,654523403,src/txdb.h
MarcoFalke,2021-06-18 15:32:30,line 92 still needed?,https://github.com/bitcoin/bitcoin/pull/22263#discussion_r654523625,654523625,src/txdb.h
jamesob,2021-06-18 18:03:07,"Yes, for e.g. `pcursor` access in `CCoinsViewDB::Cursor()`.",https://github.com/bitcoin/bitcoin/pull/22263#discussion_r654601547,654601547,src/txdb.h
jamesob,2021-06-18 18:16:33,Good call! No reason this needs to be exposed; moved to the .cpp file.,https://github.com/bitcoin/bitcoin/pull/22263#discussion_r654607898,654607898,src/txdb.h
jonatack,2021-06-19 12:20:34,"I'd suggest doing the formatting change in the first commit and making the second commit purely move-only.\n```suggestion\n    CCoinsViewDBCursor(CDBIterator* pcursorIn, const uint256& hashBlockIn):\n```",https://github.com/bitcoin/bitcoin/pull/22263#discussion_r654789815,654789815,src/txdb.cpp
jamesob,2021-06-21 15:08:20,Agree in principle but this commit is so easy to verify that I don't think it makes sense to rebase.,https://github.com/bitcoin/bitcoin/pull/22263#discussion_r655462735,655462735,src/txdb.cpp
