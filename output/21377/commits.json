[
  {
    "sha": "63879f0a4760c0c0f784029849cb5d21ee088abb",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2Mzg3OWYwYTQ3NjBjMGMwZjc4NDAyOTg0OWNiNWQyMWVlMDg4YWJi",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-03-27T10:17:56Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-04-12T00:44:04Z"
      },
      "message": "tests: pull ComputeBlockVersion test into its own function\n\nThe intent here is to allow checking ComputeBlockVersion behaviour with\neach deployment, rather than only testdummy on mainnet. This commit does\nthe trivial refactoring component of that change.",
      "tree": {
        "sha": "529e5c7af0466002ff2f84e9a3c7f0c48641999b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/529e5c7af0466002ff2f84e9a3c7f0c48641999b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/63879f0a4760c0c0f784029849cb5d21ee088abb",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/63879f0a4760c0c0f784029849cb5d21ee088abb",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/63879f0a4760c0c0f784029849cb5d21ee088abb",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/63879f0a4760c0c0f784029849cb5d21ee088abb/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "de4d3ba43705ea313f92f17295005c371a8d0bd0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/de4d3ba43705ea313f92f17295005c371a8d0bd0",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/de4d3ba43705ea313f92f17295005c371a8d0bd0"
      }
    ],
    "stats": {
      "total": 74,
      "additions": 39,
      "deletions": 35
    },
    "files": [
      {
        "sha": "b09827ffe5db1925110df0735a22b618d3f6f09a",
        "filename": "src/test/versionbits_tests.cpp",
        "status": "modified",
        "additions": 39,
        "deletions": 35,
        "changes": 74,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/63879f0a4760c0c0f784029849cb5d21ee088abb/src/test/versionbits_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/63879f0a4760c0c0f784029849cb5d21ee088abb/src/test/versionbits_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/versionbits_tests.cpp?ref=63879f0a4760c0c0f784029849cb5d21ee088abb",
        "patch": "@@ -242,17 +242,15 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n     }\n }\n \n-BOOST_AUTO_TEST_CASE(versionbits_computeblockversion)\n+/** Check that ComputeBlockVersion will set the appropriate bit correctly */\n+static void check_computeblockversion(const Consensus::Params& params, Consensus::DeploymentPos dep)\n {\n-    // Check that ComputeBlockVersion will set the appropriate bit correctly\n-    // on mainnet.\n-    const auto chainParams = CreateChainParams(*m_node.args, CBaseChainParams::MAIN);\n-    const Consensus::Params &mainnetParams = chainParams->GetConsensus();\n+    // This implicitly uses versionbitscache, so clear it every time\n+    versionbitscache.Clear();\n \n-    // Use the TESTDUMMY deployment for testing purposes.\n-    int64_t bit = mainnetParams.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].bit;\n-    int64_t nStartTime = mainnetParams.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime;\n-    int64_t nTimeout = mainnetParams.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nTimeout;\n+    int64_t bit = params.vDeployments[dep].bit;\n+    int64_t nStartTime = params.vDeployments[dep].nStartTime;\n+    int64_t nTimeout = params.vDeployments[dep].nTimeout;\n \n     assert(nStartTime < nTimeout);\n \n@@ -267,40 +265,40 @@ BOOST_AUTO_TEST_CASE(versionbits_computeblockversion)\n     // Before MedianTimePast of the chain has crossed nStartTime, the bit\n     // should not be set.\n     CBlockIndex *lastBlock = nullptr;\n-    lastBlock = firstChain.Mine(mainnetParams.nMinerConfirmationWindow, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n-    BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, mainnetParams) & (1<<bit), 0);\n+    lastBlock = firstChain.Mine(params.nMinerConfirmationWindow, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+    BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n \n     // Mine more blocks (4 less than the adjustment period) at the old time, and check that CBV isn't setting the bit yet.\n-    for (uint32_t i = 1; i < mainnetParams.nMinerConfirmationWindow - 4; i++) {\n-        lastBlock = firstChain.Mine(mainnetParams.nMinerConfirmationWindow + i, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+    for (uint32_t i = 1; i < params.nMinerConfirmationWindow - 4; i++) {\n+        lastBlock = firstChain.Mine(params.nMinerConfirmationWindow + i, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n         // This works because VERSIONBITS_LAST_OLD_BLOCK_VERSION happens\n         // to be 4, and the bit we're testing happens to be bit 28.\n-        BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, mainnetParams) & (1<<bit), 0);\n+        BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n     }\n     // Now mine 5 more blocks at the start time -- MTP should not have passed yet, so\n     // CBV should still not yet set the bit.\n     nTime = nStartTime;\n-    for (uint32_t i = mainnetParams.nMinerConfirmationWindow - 4; i <= mainnetParams.nMinerConfirmationWindow; i++) {\n-        lastBlock = firstChain.Mine(mainnetParams.nMinerConfirmationWindow + i, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n-        BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, mainnetParams) & (1<<bit), 0);\n+    for (uint32_t i = params.nMinerConfirmationWindow - 4; i <= params.nMinerConfirmationWindow; i++) {\n+        lastBlock = firstChain.Mine(params.nMinerConfirmationWindow + i, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+        BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n     }\n \n     // Advance to the next period and transition to STARTED,\n-    lastBlock = firstChain.Mine(mainnetParams.nMinerConfirmationWindow * 3, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+    lastBlock = firstChain.Mine(params.nMinerConfirmationWindow * 3, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n     // so ComputeBlockVersion should now set the bit,\n-    BOOST_CHECK((ComputeBlockVersion(lastBlock, mainnetParams) & (1<<bit)) != 0);\n+    BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1<<bit)) != 0);\n     // and should also be using the VERSIONBITS_TOP_BITS.\n-    BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, mainnetParams) & VERSIONBITS_TOP_MASK, VERSIONBITS_TOP_BITS);\n+    BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & VERSIONBITS_TOP_MASK, VERSIONBITS_TOP_BITS);\n \n     // Check that ComputeBlockVersion will set the bit until nTimeout\n     nTime += 600;\n-    uint32_t blocksToMine = mainnetParams.nMinerConfirmationWindow * 2; // test blocks for up to 2 time periods\n-    uint32_t nHeight = mainnetParams.nMinerConfirmationWindow * 3;\n+    uint32_t blocksToMine = params.nMinerConfirmationWindow * 2; // test blocks for up to 2 time periods\n+    uint32_t nHeight = params.nMinerConfirmationWindow * 3;\n     // These blocks are all before nTimeout is reached.\n     while (nTime < nTimeout && blocksToMine > 0) {\n         lastBlock = firstChain.Mine(nHeight+1, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n-        BOOST_CHECK((ComputeBlockVersion(lastBlock, mainnetParams) & (1<<bit)) != 0);\n-        BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, mainnetParams) & VERSIONBITS_TOP_MASK, VERSIONBITS_TOP_BITS);\n+        BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1<<bit)) != 0);\n+        BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & VERSIONBITS_TOP_MASK, VERSIONBITS_TOP_BITS);\n         blocksToMine--;\n         nTime += 600;\n         nHeight += 1;\n@@ -309,14 +307,14 @@ BOOST_AUTO_TEST_CASE(versionbits_computeblockversion)\n     nTime = nTimeout;\n     // FAILED is only triggered at the end of a period, so CBV should be setting\n     // the bit until the period transition.\n-    for (uint32_t i = 0; i < mainnetParams.nMinerConfirmationWindow - 1; i++) {\n+    for (uint32_t i = 0; i < params.nMinerConfirmationWindow - 1; i++) {\n         lastBlock = firstChain.Mine(nHeight+1, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n-        BOOST_CHECK((ComputeBlockVersion(lastBlock, mainnetParams) & (1<<bit)) != 0);\n+        BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1<<bit)) != 0);\n         nHeight += 1;\n     }\n     // The next block should trigger no longer setting the bit.\n     lastBlock = firstChain.Mine(nHeight+1, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n-    BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, mainnetParams) & (1<<bit), 0);\n+    BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n \n     // On a new chain:\n     // verify that the bit will be set after lock-in, and then stop being set\n@@ -325,26 +323,32 @@ BOOST_AUTO_TEST_CASE(versionbits_computeblockversion)\n \n     // Mine one period worth of blocks, and check that the bit will be on for the\n     // next period.\n-    lastBlock = secondChain.Mine(mainnetParams.nMinerConfirmationWindow, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n-    BOOST_CHECK((ComputeBlockVersion(lastBlock, mainnetParams) & (1<<bit)) != 0);\n+    lastBlock = secondChain.Mine(params.nMinerConfirmationWindow, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+    BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1<<bit)) != 0);\n \n     // Mine another period worth of blocks, signaling the new bit.\n-    lastBlock = secondChain.Mine(mainnetParams.nMinerConfirmationWindow * 2, nTime, VERSIONBITS_TOP_BITS | (1<<bit)).Tip();\n+    lastBlock = secondChain.Mine(params.nMinerConfirmationWindow * 2, nTime, VERSIONBITS_TOP_BITS | (1<<bit)).Tip();\n     // After one period of setting the bit on each block, it should have locked in.\n     // We keep setting the bit for one more period though, until activation.\n-    BOOST_CHECK((ComputeBlockVersion(lastBlock, mainnetParams) & (1<<bit)) != 0);\n+    BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1<<bit)) != 0);\n \n     // Now check that we keep mining the block until the end of this period, and\n     // then stop at the beginning of the next period.\n-    lastBlock = secondChain.Mine((mainnetParams.nMinerConfirmationWindow * 3) - 1, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n-    BOOST_CHECK((ComputeBlockVersion(lastBlock, mainnetParams) & (1 << bit)) != 0);\n-    lastBlock = secondChain.Mine(mainnetParams.nMinerConfirmationWindow * 3, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n-    BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, mainnetParams) & (1<<bit), 0);\n+    lastBlock = secondChain.Mine((params.nMinerConfirmationWindow * 3) - 1, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+    BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1 << bit)) != 0);\n+    lastBlock = secondChain.Mine(params.nMinerConfirmationWindow * 3, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+    BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n \n     // Finally, verify that after a soft fork has activated, CBV no longer uses\n     // VERSIONBITS_LAST_OLD_BLOCK_VERSION.\n     //BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, mainnetParams) & VERSIONBITS_TOP_MASK, VERSIONBITS_TOP_BITS);\n }\n \n+BOOST_AUTO_TEST_CASE(versionbits_computeblockversion)\n+{\n+    // Use the TESTDUMMY deployment for testing purposes.\n+    const auto chainParams = CreateChainParams(*m_node.args, CBaseChainParams::MAIN);\n+    check_computeblockversion(chainParams->GetConsensus(), Consensus::DEPLOYMENT_TESTDUMMY);\n+}\n \n BOOST_AUTO_TEST_SUITE_END()"
      }
    ]
  },
  {
    "sha": "593274445004506c921d5d851361aefb3434d744",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1OTMyNzQ0NDUwMDQ1MDZjOTIxZDVkODUxMzYxYWVmYjM0MzRkNzQ0",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-03-27T17:10:48Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-04-12T00:47:42Z"
      },
      "message": "tests: test ComputeBlockVersion for all deployments\n\nThis generalises the ComputeBlockVersion test so that it can apply to\nany activation parameters we might set, and checks all the parameters\nset for each deployment on each chain, to simultaneously ensure that the\ndeployments we have configured work sensibly, and that the test code\ndoes not suffer bitrot in the event that all interesting deployments\nare buried.",
      "tree": {
        "sha": "2fca71183f72b5303dea2358ad35bf97dcfedc04",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2fca71183f72b5303dea2358ad35bf97dcfedc04"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/593274445004506c921d5d851361aefb3434d744",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/593274445004506c921d5d851361aefb3434d744",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/593274445004506c921d5d851361aefb3434d744",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/593274445004506c921d5d851361aefb3434d744/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "63879f0a4760c0c0f784029849cb5d21ee088abb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/63879f0a4760c0c0f784029849cb5d21ee088abb",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/63879f0a4760c0c0f784029849cb5d21ee088abb"
      }
    ],
    "stats": {
      "total": 106,
      "additions": 71,
      "deletions": 35
    },
    "files": [
      {
        "sha": "7e96ef923ea0c847ffdc3ef4e0cb62f9b5f3a631",
        "filename": "src/test/versionbits_tests.cpp",
        "status": "modified",
        "additions": 71,
        "deletions": 35,
        "changes": 106,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/593274445004506c921d5d851361aefb3434d744/src/test/versionbits_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/593274445004506c921d5d851361aefb3434d744/src/test/versionbits_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/versionbits_tests.cpp?ref=593274445004506c921d5d851361aefb3434d744",
        "patch": "@@ -252,38 +252,61 @@ static void check_computeblockversion(const Consensus::Params& params, Consensus\n     int64_t nStartTime = params.vDeployments[dep].nStartTime;\n     int64_t nTimeout = params.vDeployments[dep].nTimeout;\n \n-    assert(nStartTime < nTimeout);\n+    // should not be any signalling for first block\n+    BOOST_CHECK_EQUAL(ComputeBlockVersion(nullptr, params), VERSIONBITS_TOP_BITS);\n+\n+    // always active deployments shouldn't need to be tested further\n+    if (nStartTime == Consensus::BIP9Deployment::ALWAYS_ACTIVE) return;\n+\n+    BOOST_REQUIRE(nStartTime < nTimeout);\n+    BOOST_REQUIRE(nStartTime >= 0);\n+    BOOST_REQUIRE(nTimeout <= std::numeric_limits<uint32_t>::max() || nTimeout == Consensus::BIP9Deployment::NO_TIMEOUT);\n+    BOOST_REQUIRE(0 <= bit && bit < 32);\n+    BOOST_REQUIRE(((1 << bit) & VERSIONBITS_TOP_MASK) == 0);\n \n     // In the first chain, test that the bit is set by CBV until it has failed.\n     // In the second chain, test the bit is set by CBV while STARTED and\n     // LOCKED-IN, and then no longer set while ACTIVE.\n     VersionBitsTester firstChain, secondChain;\n \n-    // Start generating blocks before nStartTime\n-    int64_t nTime = nStartTime - 1;\n+    int64_t nTime = nStartTime;\n \n-    // Before MedianTimePast of the chain has crossed nStartTime, the bit\n-    // should not be set.\n     CBlockIndex *lastBlock = nullptr;\n-    lastBlock = firstChain.Mine(params.nMinerConfirmationWindow, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n-    BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n \n-    // Mine more blocks (4 less than the adjustment period) at the old time, and check that CBV isn't setting the bit yet.\n-    for (uint32_t i = 1; i < params.nMinerConfirmationWindow - 4; i++) {\n-        lastBlock = firstChain.Mine(params.nMinerConfirmationWindow + i, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n-        // This works because VERSIONBITS_LAST_OLD_BLOCK_VERSION happens\n-        // to be 4, and the bit we're testing happens to be bit 28.\n+    // Before MedianTimePast of the chain has crossed nStartTime, the bit\n+    // should not be set.\n+    if (nTime == 0) {\n+        // since CBlockIndex::nTime is uint32_t we can't represent any\n+        // earlier time, so will transition from DEFINED to STARTED at the\n+        // end of the first period by mining blocks at nTime == 0\n+        lastBlock = firstChain.Mine(params.nMinerConfirmationWindow - 1, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n         BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n-    }\n-    // Now mine 5 more blocks at the start time -- MTP should not have passed yet, so\n-    // CBV should still not yet set the bit.\n-    nTime = nStartTime;\n-    for (uint32_t i = params.nMinerConfirmationWindow - 4; i <= params.nMinerConfirmationWindow; i++) {\n-        lastBlock = firstChain.Mine(params.nMinerConfirmationWindow + i, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+        lastBlock = firstChain.Mine(params.nMinerConfirmationWindow, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+        BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1<<bit)) != 0);\n+        // then we'll keep mining at nStartTime...\n+    } else {\n+        // use a time 1s earlier than start time to check we stay DEFINED\n+        --nTime;\n+\n+        // Start generating blocks before nStartTime\n+        lastBlock = firstChain.Mine(params.nMinerConfirmationWindow, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n         BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n+\n+        // Mine more blocks (4 less than the adjustment period) at the old time, and check that CBV isn't setting the bit yet.\n+        for (uint32_t i = 1; i < params.nMinerConfirmationWindow - 4; i++) {\n+            lastBlock = firstChain.Mine(params.nMinerConfirmationWindow + i, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+            BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n+        }\n+        // Now mine 5 more blocks at the start time -- MTP should not have passed yet, so\n+        // CBV should still not yet set the bit.\n+        nTime = nStartTime;\n+        for (uint32_t i = params.nMinerConfirmationWindow - 4; i <= params.nMinerConfirmationWindow; i++) {\n+            lastBlock = firstChain.Mine(params.nMinerConfirmationWindow + i, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+            BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n+        }\n+        // Next we will advance to the next period and transition to STARTED,\n     }\n \n-    // Advance to the next period and transition to STARTED,\n     lastBlock = firstChain.Mine(params.nMinerConfirmationWindow * 3, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n     // so ComputeBlockVersion should now set the bit,\n     BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1<<bit)) != 0);\n@@ -304,17 +327,29 @@ static void check_computeblockversion(const Consensus::Params& params, Consensus\n         nHeight += 1;\n     }\n \n-    nTime = nTimeout;\n-    // FAILED is only triggered at the end of a period, so CBV should be setting\n-    // the bit until the period transition.\n-    for (uint32_t i = 0; i < params.nMinerConfirmationWindow - 1; i++) {\n+    if (nTimeout != Consensus::BIP9Deployment::NO_TIMEOUT) {\n+        // can reach any nTimeout other than NO_TIMEOUT due to earlier BOOST_REQUIRE\n+\n+        nTime = nTimeout;\n+\n+        // finish the last period before we start timing out\n+        while (nHeight % params.nMinerConfirmationWindow != 0) {\n+            lastBlock = firstChain.Mine(nHeight+1, nTime - 1, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+            BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1<<bit)) != 0);\n+            nHeight += 1;\n+        }\n+\n+        // FAILED is only triggered at the end of a period, so CBV should be setting\n+        // the bit until the period transition.\n+        for (uint32_t i = 0; i < params.nMinerConfirmationWindow - 1; i++) {\n+            lastBlock = firstChain.Mine(nHeight+1, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+            BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1<<bit)) != 0);\n+            nHeight += 1;\n+        }\n+        // The next block should trigger no longer setting the bit.\n         lastBlock = firstChain.Mine(nHeight+1, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n-        BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1<<bit)) != 0);\n-        nHeight += 1;\n+        BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n     }\n-    // The next block should trigger no longer setting the bit.\n-    lastBlock = firstChain.Mine(nHeight+1, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n-    BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n \n     // On a new chain:\n     // verify that the bit will be set after lock-in, and then stop being set\n@@ -338,17 +373,18 @@ static void check_computeblockversion(const Consensus::Params& params, Consensus\n     BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1 << bit)) != 0);\n     lastBlock = secondChain.Mine(params.nMinerConfirmationWindow * 3, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n     BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n-\n-    // Finally, verify that after a soft fork has activated, CBV no longer uses\n-    // VERSIONBITS_LAST_OLD_BLOCK_VERSION.\n-    //BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, mainnetParams) & VERSIONBITS_TOP_MASK, VERSIONBITS_TOP_BITS);\n }\n \n BOOST_AUTO_TEST_CASE(versionbits_computeblockversion)\n {\n-    // Use the TESTDUMMY deployment for testing purposes.\n-    const auto chainParams = CreateChainParams(*m_node.args, CBaseChainParams::MAIN);\n-    check_computeblockversion(chainParams->GetConsensus(), Consensus::DEPLOYMENT_TESTDUMMY);\n+    // check that any deployment on any chain can conceivably reach both\n+    // ACTIVE and FAILED states in roughly the way we expect\n+    for (const auto& chain_name : {CBaseChainParams::MAIN, CBaseChainParams::TESTNET, CBaseChainParams::SIGNET, CBaseChainParams::REGTEST}) {\n+        const auto chainParams = CreateChainParams(*m_node.args, chain_name);\n+        for (int i = 0; i < (int)Consensus::MAX_VERSION_BITS_DEPLOYMENTS; ++i) {\n+            check_computeblockversion(chainParams->GetConsensus(), static_cast<Consensus::DeploymentPos>(i));\n+        }\n+    }\n }\n \n BOOST_AUTO_TEST_SUITE_END()"
      }
    ]
  },
  {
    "sha": "9e6b65f6fa205eee5c3b99343988adcb8d320460",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5ZTZiNjVmNmZhMjA1ZWVlNWMzYjk5MzQzOTg4YWRjYjhkMzIwNDYw",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-03-27T14:07:49Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-04-12T00:47:42Z"
      },
      "message": "tests: clean up versionbits test\n\nSimplify the versionbits unit test slightly to make the next set of\nchanges a little easier to follow.",
      "tree": {
        "sha": "f1521b6fcb51c5dade08169b10a8bb18d545c109",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f1521b6fcb51c5dade08169b10a8bb18d545c109"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9e6b65f6fa205eee5c3b99343988adcb8d320460",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9e6b65f6fa205eee5c3b99343988adcb8d320460",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/9e6b65f6fa205eee5c3b99343988adcb8d320460",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9e6b65f6fa205eee5c3b99343988adcb8d320460/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "593274445004506c921d5d851361aefb3434d744",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/593274445004506c921d5d851361aefb3434d744",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/593274445004506c921d5d851361aefb3434d744"
      }
    ],
    "stats": {
      "total": 18,
      "additions": 11,
      "deletions": 7
    },
    "files": [
      {
        "sha": "b42aaff9ad154847bbcc0d4179de8fc95128e707",
        "filename": "src/test/versionbits_tests.cpp",
        "status": "modified",
        "additions": 11,
        "deletions": 7,
        "changes": 18,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9e6b65f6fa205eee5c3b99343988adcb8d320460/src/test/versionbits_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9e6b65f6fa205eee5c3b99343988adcb8d320460/src/test/versionbits_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/versionbits_tests.cpp?ref=9e6b65f6fa205eee5c3b99343988adcb8d320460",
        "patch": "@@ -100,7 +100,7 @@ class VersionBitsTester\n         while (vpblock.size() < height) {\n             CBlockIndex* pindex = new CBlockIndex();\n             pindex->nHeight = vpblock.size();\n-            pindex->pprev = vpblock.size() > 0 ? vpblock.back() : nullptr;\n+            pindex->pprev = Tip();\n             pindex->nTime = nTime;\n             pindex->nVersion = nVersion;\n             pindex->BuildSkip();\n@@ -110,13 +110,14 @@ class VersionBitsTester\n     }\n \n     VersionBitsTester& TestStateSinceHeight(int height) {\n+        const CBlockIndex* tip = Tip();\n         for (int i = 0; i < CHECKERS; i++) {\n             if (InsecureRandBits(i) == 0) {\n-                BOOST_CHECK_MESSAGE(checker[i].GetStateSinceHeightFor(vpblock.empty() ? nullptr : vpblock.back()) == height, strprintf(\"Test %i for StateSinceHeight\", num));\n-                BOOST_CHECK_MESSAGE(checker_always[i].GetStateSinceHeightFor(vpblock.empty() ? nullptr : vpblock.back()) == 0, strprintf(\"Test %i for StateSinceHeight (always active)\", num));\n+                BOOST_CHECK_MESSAGE(checker[i].GetStateSinceHeightFor(tip) == height, strprintf(\"Test %i for StateSinceHeight\", num));\n+                BOOST_CHECK_MESSAGE(checker_always[i].GetStateSinceHeightFor(tip) == 0, strprintf(\"Test %i for StateSinceHeight (always active)\", num));\n \n                 // never active may go from DEFINED -> FAILED at the first period\n-                const auto never_height = checker_never[i].GetStateSinceHeightFor(vpblock.empty() ? nullptr : vpblock.back());\n+                const auto never_height = checker_never[i].GetStateSinceHeightFor(tip);\n                 BOOST_CHECK_MESSAGE(never_height == 0 || never_height == checker_never[i].Period(paramsDummy), strprintf(\"Test %i for StateSinceHeight (never active)\", num));\n             }\n         }\n@@ -125,9 +126,9 @@ class VersionBitsTester\n     }\n \n     VersionBitsTester& TestState(ThresholdState exp) {\n+        const CBlockIndex* pindex = Tip();\n         for (int i = 0; i < CHECKERS; i++) {\n             if (InsecureRandBits(i) == 0) {\n-                const CBlockIndex* pindex = vpblock.empty() ? nullptr : vpblock.back();\n                 ThresholdState got = checker[i].GetStateFor(pindex);\n                 ThresholdState got_always = checker_always[i].GetStateFor(pindex);\n                 ThresholdState got_never = checker_never[i].GetStateFor(pindex);\n@@ -149,7 +150,7 @@ class VersionBitsTester\n     VersionBitsTester& TestActive() { return TestState(ThresholdState::ACTIVE); }\n     VersionBitsTester& TestFailed() { return TestState(ThresholdState::FAILED); }\n \n-    CBlockIndex * Tip() { return vpblock.size() ? vpblock.back() : nullptr; }\n+    CBlockIndex* Tip() { return vpblock.empty() ? nullptr : vpblock.back(); }\n };\n \n BOOST_FIXTURE_TEST_SUITE(versionbits_tests, TestingSetup)\n@@ -217,7 +218,10 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n                            .Mine(6000, TestTime(20000), 0).TestFailed().TestStateSinceHeight(6000)\n                            .Mine(7000, TestTime(20000), 0x100).TestFailed().TestStateSinceHeight(6000);\n     }\n+}\n \n+BOOST_AUTO_TEST_CASE(versionbits_sanity)\n+{\n     // Sanity checks of version bit deployments\n     const auto chainParams = CreateChainParams(*m_node.args, CBaseChainParams::MAIN);\n     const Consensus::Params &mainnetParams = chainParams->GetConsensus();\n@@ -271,7 +275,7 @@ static void check_computeblockversion(const Consensus::Params& params, Consensus\n \n     int64_t nTime = nStartTime;\n \n-    CBlockIndex *lastBlock = nullptr;\n+    const CBlockIndex *lastBlock = nullptr;\n \n     // Before MedianTimePast of the chain has crossed nStartTime, the bit\n     // should not be set."
      }
    ]
  },
  {
    "sha": "73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3M2Q0YTcwNjM5M2U2ZGJkNmI2ZDZiNjQyOGY4ZDMyMzNhYzBhMmQ4",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-03-06T08:18:49Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-04-12T01:14:49Z"
      },
      "message": "versionbits: Add support for delayed activation",
      "tree": {
        "sha": "d187f08c276e57a617c3e9eee6c635890e3873a6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d187f08c276e57a617c3e9eee6c635890e3873a6"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "9e6b65f6fa205eee5c3b99343988adcb8d320460",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9e6b65f6fa205eee5c3b99343988adcb8d320460",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/9e6b65f6fa205eee5c3b99343988adcb8d320460"
      }
    ],
    "stats": {
      "total": 51,
      "additions": 41,
      "deletions": 10
    },
    "files": [
      {
        "sha": "7e2c2ac7cf6559d7d949cfda8196094407405f5d",
        "filename": "src/chainparams.cpp",
        "status": "modified",
        "additions": 20,
        "deletions": 5,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/chainparams.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/chainparams.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/chainparams.cpp?ref=73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
        "patch": "@@ -83,11 +83,13 @@ class CMainParams : public CChainParams {\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].bit = 28;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime = 1199145601; // January 1, 2008\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nTimeout = 1230767999; // December 31, 2008\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].min_activation_height = 0; // No activation delay\n \n         // Deployment of Taproot (BIPs 340-342)\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].bit = 2;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nStartTime = 1199145601; // January 1, 2008\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nTimeout = 1230767999; // December 31, 2008\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].min_activation_height = 0; // No activation delay\n \n         consensus.nMinimumChainWork = uint256S(\"0x00000000000000000000000000000000000000001533efd8d716a517fe2c5008\");\n         consensus.defaultAssumeValid = uint256S(\"0x0000000000000000000b9d2ec5a352ecba0592946514a92f14319dc2b367fc72\"); // 654683\n@@ -200,11 +202,13 @@ class CTestNetParams : public CChainParams {\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].bit = 28;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime = 1199145601; // January 1, 2008\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nTimeout = 1230767999; // December 31, 2008\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].min_activation_height = 0; // No activation delay\n \n         // Deployment of Taproot (BIPs 340-342)\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].bit = 2;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nStartTime = 1199145601; // January 1, 2008\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nTimeout = 1230767999; // December 31, 2008\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].min_activation_height = 0; // No activation delay\n \n         consensus.nMinimumChainWork = uint256S(\"0x0000000000000000000000000000000000000000000001db6ec4ac88cf2272c6\");\n         consensus.defaultAssumeValid = uint256S(\"0x000000000000006433d1efec504c53ca332b64963c425395515b01977bd7b3b0\"); // 1864000\n@@ -335,11 +339,13 @@ class SigNetParams : public CChainParams {\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].bit = 28;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime = 1199145601; // January 1, 2008\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nTimeout = 1230767999; // December 31, 2008\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].min_activation_height = 0; // No activation delay\n \n         // Activation of Taproot (BIPs 340-342)\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].bit = 2;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nStartTime = Consensus::BIP9Deployment::ALWAYS_ACTIVE;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nTimeout = Consensus::BIP9Deployment::NO_TIMEOUT;\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].min_activation_height = 0; // No activation delay\n \n         // message start is defined as the first 4 bytes of the sha256d of the block script\n         CHashWriter h(SER_DISK, 0);\n@@ -397,12 +403,16 @@ class CRegTestParams : public CChainParams {\n         consensus.fPowNoRetargeting = true;\n         consensus.nRuleChangeActivationThreshold = 108; // 75% for testchains\n         consensus.nMinerConfirmationWindow = 144; // Faster than normal for regtest (144 instead of 2016)\n+\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].bit = 28;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime = 0;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nTimeout = Consensus::BIP9Deployment::NO_TIMEOUT;\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].min_activation_height = 0; // No activation delay\n+\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].bit = 2;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nStartTime = Consensus::BIP9Deployment::ALWAYS_ACTIVE;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nTimeout = Consensus::BIP9Deployment::NO_TIMEOUT;\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].min_activation_height = 0; // No activation delay\n \n         consensus.nMinimumChainWork = uint256{};\n         consensus.defaultAssumeValid = uint256{};\n@@ -466,10 +476,11 @@ class CRegTestParams : public CChainParams {\n     /**\n      * Allows modifying the Version Bits regtest parameters.\n      */\n-    void UpdateVersionBitsParameters(Consensus::DeploymentPos d, int64_t nStartTime, int64_t nTimeout)\n+    void UpdateVersionBitsParameters(Consensus::DeploymentPos d, int64_t nStartTime, int64_t nTimeout, int min_activation_height)\n     {\n         consensus.vDeployments[d].nStartTime = nStartTime;\n         consensus.vDeployments[d].nTimeout = nTimeout;\n+        consensus.vDeployments[d].min_activation_height = min_activation_height;\n     }\n     void UpdateActivationParametersFromArgs(const ArgsManager& args);\n };\n@@ -492,22 +503,26 @@ void CRegTestParams::UpdateActivationParametersFromArgs(const ArgsManager& args)\n     for (const std::string& strDeployment : args.GetArgs(\"-vbparams\")) {\n         std::vector<std::string> vDeploymentParams;\n         boost::split(vDeploymentParams, strDeployment, boost::is_any_of(\":\"));\n-        if (vDeploymentParams.size() != 3) {\n-            throw std::runtime_error(\"Version bits parameters malformed, expecting deployment:start:end\");\n+        if (vDeploymentParams.size() < 3 || 4 < vDeploymentParams.size()) {\n+            throw std::runtime_error(\"Version bits parameters malformed, expecting deployment:start:end[:min_activation_height]\");\n         }\n         int64_t nStartTime, nTimeout;\n+        int min_activation_height = 0;\n         if (!ParseInt64(vDeploymentParams[1], &nStartTime)) {\n             throw std::runtime_error(strprintf(\"Invalid nStartTime (%s)\", vDeploymentParams[1]));\n         }\n         if (!ParseInt64(vDeploymentParams[2], &nTimeout)) {\n             throw std::runtime_error(strprintf(\"Invalid nTimeout (%s)\", vDeploymentParams[2]));\n         }\n+        if (vDeploymentParams.size() >= 4 && !ParseInt32(vDeploymentParams[3], &min_activation_height)) {\n+            throw std::runtime_error(strprintf(\"Invalid min_activation_height (%s)\", vDeploymentParams[3]));\n+        }\n         bool found = false;\n         for (int j=0; j < (int)Consensus::MAX_VERSION_BITS_DEPLOYMENTS; ++j) {\n             if (vDeploymentParams[0] == VersionBitsDeploymentInfo[j].name) {\n-                UpdateVersionBitsParameters(Consensus::DeploymentPos(j), nStartTime, nTimeout);\n+                UpdateVersionBitsParameters(Consensus::DeploymentPos(j), nStartTime, nTimeout, min_activation_height);\n                 found = true;\n-                LogPrintf(\"Setting version bits activation parameters for %s to start=%ld, timeout=%ld\\n\", vDeploymentParams[0], nStartTime, nTimeout);\n+                LogPrintf(\"Setting version bits activation parameters for %s to start=%ld, timeout=%ld, min_activation_height=%d\\n\", vDeploymentParams[0], nStartTime, nTimeout, min_activation_height);\n                 break;\n             }\n         }"
      },
      {
        "sha": "e71b4bc85937511f33f7bde32a09ecb0ade339ac",
        "filename": "src/chainparamsbase.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/chainparamsbase.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/chainparamsbase.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/chainparamsbase.cpp?ref=73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
        "patch": "@@ -22,7 +22,7 @@ void SetupChainParamsBaseOptions(ArgsManager& argsman)\n                  \"This is intended for regression testing tools and app development. Equivalent to -chain=regtest.\", ArgsManager::ALLOW_ANY | ArgsManager::DEBUG_ONLY, OptionsCategory::CHAINPARAMS);\n     argsman.AddArg(\"-segwitheight=<n>\", \"Set the activation height of segwit. -1 to disable. (regtest-only)\", ArgsManager::ALLOW_ANY | ArgsManager::DEBUG_ONLY, OptionsCategory::DEBUG_TEST);\n     argsman.AddArg(\"-testnet\", \"Use the test chain. Equivalent to -chain=test.\", ArgsManager::ALLOW_ANY, OptionsCategory::CHAINPARAMS);\n-    argsman.AddArg(\"-vbparams=deployment:start:end\", \"Use given start/end times for specified version bits deployment (regtest-only)\", ArgsManager::ALLOW_ANY | ArgsManager::DEBUG_ONLY, OptionsCategory::CHAINPARAMS);\n+    argsman.AddArg(\"-vbparams=deployment:start:end[:min_activation_height]\", \"Use given start/end times and min_activation_height for specified version bits deployment (regtest-only)\", ArgsManager::ALLOW_ANY | ArgsManager::DEBUG_ONLY, OptionsCategory::CHAINPARAMS);\n     argsman.AddArg(\"-signet\", \"Use the signet chain. Equivalent to -chain=signet. Note that the network is defined by the -signetchallenge parameter\", ArgsManager::ALLOW_ANY, OptionsCategory::CHAINPARAMS);\n     argsman.AddArg(\"-signetchallenge\", \"Blocks must satisfy the given script to be considered valid (only for signet networks; defaults to the global default signet test network challenge)\", ArgsManager::ALLOW_STRING, OptionsCategory::CHAINPARAMS);\n     argsman.AddArg(\"-signetseednode\", \"Specify a seed node for the signet network, in the hostname[:port] format, e.g. sig.net:1234 (may be used multiple times to specify multiple seed nodes; defaults to the global default signet test network seed node(s))\", ArgsManager::ALLOW_STRING, OptionsCategory::CHAINPARAMS);"
      },
      {
        "sha": "705205c95b019190e4719e45e49c9484e683c555",
        "filename": "src/consensus/params.h",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/consensus/params.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/consensus/params.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/consensus/params.h?ref=73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
        "patch": "@@ -29,6 +29,11 @@ struct BIP9Deployment {\n     int64_t nStartTime;\n     /** Timeout/expiry MedianTime for the deployment attempt. */\n     int64_t nTimeout;\n+    /** If lock in occurs, delay activation until at least this block\n+     *  height.  Note that activation will only occur on a retarget\n+     *  boundary.\n+     */\n+    int min_activation_height{0};\n \n     /** Constant for nTimeout very far in the future. */\n     static constexpr int64_t NO_TIMEOUT = std::numeric_limits<int64_t>::max();"
      },
      {
        "sha": "acf2f5d6b48a03e08a6193ac81d3ea89a270b507",
        "filename": "src/rpc/blockchain.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/rpc/blockchain.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/rpc/blockchain.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/blockchain.cpp?ref=73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
        "patch": "@@ -1258,6 +1258,7 @@ static void BIP9SoftForkDescPushBack(UniValue& softforks, const std::string &nam\n         statsUV.pushKV(\"possible\", statsStruct.possible);\n         bip9.pushKV(\"statistics\", statsUV);\n     }\n+    bip9.pushKV(\"min_activation_height\", consensusParams.vDeployments[id].min_activation_height);\n \n     UniValue rv(UniValue::VOBJ);\n     rv.pushKV(\"type\", \"bip9\");\n@@ -1304,6 +1305,7 @@ RPCHelpMan getblockchaininfo()\n                                     {RPCResult::Type::NUM_TIME, \"start_time\", \"the minimum median time past of a block at which the bit gains its meaning\"},\n                                     {RPCResult::Type::NUM_TIME, \"timeout\", \"the median time past of a block at which the deployment is considered failed if not yet locked in\"},\n                                     {RPCResult::Type::NUM, \"since\", \"height of the first block to which the status applies\"},\n+                                    {RPCResult::Type::NUM, \"min_activation_height\", \"minimum height of blocks for which the rules may be enforced\"},\n                                     {RPCResult::Type::OBJ, \"statistics\", \"numeric statistics about BIP9 signalling for a softfork (only for \\\"started\\\" status)\",\n                                     {\n                                         {RPCResult::Type::NUM, \"period\", \"the length in blocks of the BIP9 signalling period\"},"
      },
      {
        "sha": "ae0d47b2b43cf96f404f71728141e813e5904220",
        "filename": "src/test/versionbits_tests.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/test/versionbits_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/test/versionbits_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/versionbits_tests.cpp?ref=73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
        "patch": "@@ -255,6 +255,7 @@ static void check_computeblockversion(const Consensus::Params& params, Consensus\n     int64_t bit = params.vDeployments[dep].bit;\n     int64_t nStartTime = params.vDeployments[dep].nStartTime;\n     int64_t nTimeout = params.vDeployments[dep].nTimeout;\n+    int min_activation_height = params.vDeployments[dep].min_activation_height;\n \n     // should not be any signalling for first block\n     BOOST_CHECK_EQUAL(ComputeBlockVersion(nullptr, params), VERSIONBITS_TOP_BITS);\n@@ -267,6 +268,7 @@ static void check_computeblockversion(const Consensus::Params& params, Consensus\n     BOOST_REQUIRE(nTimeout <= std::numeric_limits<uint32_t>::max() || nTimeout == Consensus::BIP9Deployment::NO_TIMEOUT);\n     BOOST_REQUIRE(0 <= bit && bit < 32);\n     BOOST_REQUIRE(((1 << bit) & VERSIONBITS_TOP_MASK) == 0);\n+    BOOST_REQUIRE(min_activation_height == 0);\n \n     // In the first chain, test that the bit is set by CBV until it has failed.\n     // In the second chain, test the bit is set by CBV while STARTED and"
      },
      {
        "sha": "11da729596f50da2ca119bd08c733dd4a9ee152d",
        "filename": "src/versionbits.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 2,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/versionbits.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/versionbits.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/versionbits.cpp?ref=73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
        "patch": "@@ -9,6 +9,7 @@ ThresholdState AbstractThresholdConditionChecker::GetStateFor(const CBlockIndex*\n {\n     int nPeriod = Period(params);\n     int nThreshold = Threshold(params);\n+    int min_activation_height = MinActivationHeight(params);\n     int64_t nTimeStart = BeginTime(params);\n     int64_t nTimeTimeout = EndTime(params);\n \n@@ -78,8 +79,10 @@ ThresholdState AbstractThresholdConditionChecker::GetStateFor(const CBlockIndex*\n                 break;\n             }\n             case ThresholdState::LOCKED_IN: {\n-                // Always progresses into ACTIVE.\n-                stateNext = ThresholdState::ACTIVE;\n+                // Progresses into ACTIVE provided activation height will have been reached.\n+                if (pindexPrev->nHeight + 1 >= min_activation_height) {\n+                    stateNext = ThresholdState::ACTIVE;\n+                }\n                 break;\n             }\n             case ThresholdState::FAILED:\n@@ -170,6 +173,7 @@ class VersionBitsConditionChecker : public AbstractThresholdConditionChecker {\n protected:\n     int64_t BeginTime(const Consensus::Params& params) const override { return params.vDeployments[id].nStartTime; }\n     int64_t EndTime(const Consensus::Params& params) const override { return params.vDeployments[id].nTimeout; }\n+    int MinActivationHeight(const Consensus::Params& params) const override { return params.vDeployments[id].min_activation_height; }\n     int Period(const Consensus::Params& params) const override { return params.nMinerConfirmationWindow; }\n     int Threshold(const Consensus::Params& params) const override { return params.nRuleChangeActivationThreshold; }\n "
      },
      {
        "sha": "634a848ef58f5a9b8501eafdb0dea5a90ebc354e",
        "filename": "src/versionbits.h",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/versionbits.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/src/versionbits.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/versionbits.h?ref=73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
        "patch": "@@ -25,7 +25,7 @@ static const int32_t VERSIONBITS_NUM_BITS = 29;\n enum class ThresholdState {\n     DEFINED,   // First state that each softfork starts out as. The genesis block is by definition in this state for each deployment.\n     STARTED,   // For blocks past the starttime.\n-    LOCKED_IN, // For one retarget period after the first retarget period with STARTED blocks of which at least threshold have the associated bit set in nVersion.\n+    LOCKED_IN, // For at least one retarget period after the first retarget period with STARTED blocks of which at least threshold have the associated bit set in nVersion, until min_activation_height is reached.\n     ACTIVE,    // For all blocks after the LOCKED_IN retarget period (final state)\n     FAILED,    // For all blocks once the first retarget period after the timeout time is hit, if LOCKED_IN wasn't already reached (final state)\n };\n@@ -57,6 +57,7 @@ class AbstractThresholdConditionChecker {\n     virtual bool Condition(const CBlockIndex* pindex, const Consensus::Params& params) const =0;\n     virtual int64_t BeginTime(const Consensus::Params& params) const =0;\n     virtual int64_t EndTime(const Consensus::Params& params) const =0;\n+    virtual int MinActivationHeight(const Consensus::Params& params) const { return 0; }\n     virtual int Period(const Consensus::Params& params) const =0;\n     virtual int Threshold(const Consensus::Params& params) const =0;\n "
      },
      {
        "sha": "821409ccc143e3a8fe50f72c35c48797e863a212",
        "filename": "test/functional/rpc_blockchain.py",
        "status": "modified",
        "additions": 3,
        "deletions": 1,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/test/functional/rpc_blockchain.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8/test/functional/rpc_blockchain.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_blockchain.py?ref=73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
        "patch": "@@ -149,6 +149,7 @@ def _test_getblockchaininfo(self):\n                         'count': 57,\n                         'possible': True,\n                     },\n+                    'min_activation_height': 0,\n                 },\n                 'active': False\n             },\n@@ -158,7 +159,8 @@ def _test_getblockchaininfo(self):\n                     'status': 'active',\n                     'start_time': -1,\n                     'timeout': 9223372036854775807,\n-                    'since': 0\n+                    'since': 0,\n+                    'min_activation_height': 0,\n                 },\n                 'height': 0,\n                 'active': True"
      }
    ]
  },
  {
    "sha": "dd85d5411c1702c8ae259610fe55050ba212e21e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkZDg1ZDU0MTFjMTcwMmM4YWUyNTk2MTBmZTU1MDUwYmEyMTJlMjFl",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-04-07T01:37:47Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-04-12T01:14:49Z"
      },
      "message": "tests: test versionbits delayed activation",
      "tree": {
        "sha": "7b551569d681e59540f85925025bd137731e1ce1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7b551569d681e59540f85925025bd137731e1ce1"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/dd85d5411c1702c8ae259610fe55050ba212e21e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dd85d5411c1702c8ae259610fe55050ba212e21e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/dd85d5411c1702c8ae259610fe55050ba212e21e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dd85d5411c1702c8ae259610fe55050ba212e21e/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/73d4a706393e6dbd6b6d6b6428f8d3233ac0a2d8"
      }
    ],
    "stats": {
      "total": 83,
      "additions": 74,
      "deletions": 9
    },
    "files": [
      {
        "sha": "1ce31c9af908d7e4368c5ab0ab4553b7d509e9bc",
        "filename": "src/test/versionbits_tests.cpp",
        "status": "modified",
        "additions": 74,
        "deletions": 9,
        "changes": 83,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd85d5411c1702c8ae259610fe55050ba212e21e/src/test/versionbits_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd85d5411c1702c8ae259610fe55050ba212e21e/src/test/versionbits_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/versionbits_tests.cpp?ref=dd85d5411c1702c8ae259610fe55050ba212e21e",
        "patch": "@@ -44,6 +44,12 @@ class TestConditionChecker : public AbstractThresholdConditionChecker\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev) const { return AbstractThresholdConditionChecker::GetStateSinceHeightFor(pindexPrev, paramsDummy, cache); }\n };\n \n+class TestDelayedActivationConditionChecker : public TestConditionChecker\n+{\n+public:\n+    int MinActivationHeight(const Consensus::Params& params) const override { return 15000; }\n+};\n+\n class TestAlwaysActiveConditionChecker : public TestConditionChecker\n {\n public:\n@@ -68,6 +74,8 @@ class VersionBitsTester\n     // The first one performs all checks, the second only 50%, the third only 25%, etc...\n     // This is to test whether lack of cached information leads to the same results.\n     TestConditionChecker checker[CHECKERS];\n+    // Another 6 that assume delayed activation\n+    TestDelayedActivationConditionChecker checker_delayed[CHECKERS];\n     // Another 6 that assume always active activation\n     TestAlwaysActiveConditionChecker checker_always[CHECKERS];\n     // Another 6 that assume never active activation\n@@ -77,14 +85,18 @@ class VersionBitsTester\n     int num;\n \n public:\n-    VersionBitsTester() : num(0) {}\n+    VersionBitsTester() : num(1000) {}\n \n     VersionBitsTester& Reset() {\n+        // Have each group of tests be counted by the 1000s part, starting at 1000\n+        num = num - (num % 1000) + 1000;\n+\n         for (unsigned int i = 0; i < vpblock.size(); i++) {\n             delete vpblock[i];\n         }\n         for (unsigned int  i = 0; i < CHECKERS; i++) {\n             checker[i] = TestConditionChecker();\n+            checker_delayed[i] = TestDelayedActivationConditionChecker();\n             checker_always[i] = TestAlwaysActiveConditionChecker();\n             checker_never[i] = TestNeverActiveConditionChecker();\n         }\n@@ -109,11 +121,18 @@ class VersionBitsTester\n         return *this;\n     }\n \n-    VersionBitsTester& TestStateSinceHeight(int height) {\n+    VersionBitsTester& TestStateSinceHeight(int height)\n+    {\n+        return TestStateSinceHeight(height, height);\n+    }\n+\n+    VersionBitsTester& TestStateSinceHeight(int height, int height_delayed)\n+    {\n         const CBlockIndex* tip = Tip();\n         for (int i = 0; i < CHECKERS; i++) {\n             if (InsecureRandBits(i) == 0) {\n                 BOOST_CHECK_MESSAGE(checker[i].GetStateSinceHeightFor(tip) == height, strprintf(\"Test %i for StateSinceHeight\", num));\n+                BOOST_CHECK_MESSAGE(checker_delayed[i].GetStateSinceHeightFor(tip) == height_delayed, strprintf(\"Test %i for StateSinceHeight (delayed)\", num));\n                 BOOST_CHECK_MESSAGE(checker_always[i].GetStateSinceHeightFor(tip) == 0, strprintf(\"Test %i for StateSinceHeight (always active)\", num));\n \n                 // never active may go from DEFINED -> FAILED at the first period\n@@ -125,17 +144,31 @@ class VersionBitsTester\n         return *this;\n     }\n \n-    VersionBitsTester& TestState(ThresholdState exp) {\n+    VersionBitsTester& TestState(ThresholdState exp)\n+    {\n+        return TestState(exp, exp);\n+    }\n+\n+    VersionBitsTester& TestState(ThresholdState exp, ThresholdState exp_delayed)\n+    {\n+        if (exp != exp_delayed) {\n+            // only expected differences are that delayed stays in locked_in longer\n+            BOOST_CHECK_EQUAL(exp, ThresholdState::ACTIVE);\n+            BOOST_CHECK_EQUAL(exp_delayed, ThresholdState::LOCKED_IN);\n+        }\n+\n         const CBlockIndex* pindex = Tip();\n         for (int i = 0; i < CHECKERS; i++) {\n             if (InsecureRandBits(i) == 0) {\n                 ThresholdState got = checker[i].GetStateFor(pindex);\n+                ThresholdState got_delayed = checker_delayed[i].GetStateFor(pindex);\n                 ThresholdState got_always = checker_always[i].GetStateFor(pindex);\n                 ThresholdState got_never = checker_never[i].GetStateFor(pindex);\n                 // nHeight of the next block. If vpblock is empty, the next (ie first)\n                 // block should be the genesis block with nHeight == 0.\n                 int height = pindex == nullptr ? 0 : pindex->nHeight + 1;\n                 BOOST_CHECK_MESSAGE(got == exp, strprintf(\"Test %i for %s height %d (got %s)\", num, StateName(exp), height, StateName(got)));\n+                BOOST_CHECK_MESSAGE(got_delayed == exp_delayed, strprintf(\"Test %i for %s height %d (got %s; delayed case)\", num, StateName(exp_delayed), height, StateName(got_delayed)));\n                 BOOST_CHECK_MESSAGE(got_always == ThresholdState::ACTIVE, strprintf(\"Test %i for ACTIVE height %d (got %s; always active case)\", num, height, StateName(got_always)));\n                 BOOST_CHECK_MESSAGE(got_never == ThresholdState::DEFINED|| got_never == ThresholdState::FAILED, strprintf(\"Test %i for DEFINED/FAILED height %d (got %s; never active case)\", num, height, StateName(got_never)));\n             }\n@@ -150,6 +183,9 @@ class VersionBitsTester\n     VersionBitsTester& TestActive() { return TestState(ThresholdState::ACTIVE); }\n     VersionBitsTester& TestFailed() { return TestState(ThresholdState::FAILED); }\n \n+    // non-delayed should be active; delayed should still be locked in\n+    VersionBitsTester& TestActiveDelayed() { return TestState(ThresholdState::ACTIVE, ThresholdState::LOCKED_IN); }\n+\n     CBlockIndex* Tip() { return vpblock.empty() ? nullptr : vpblock.back(); }\n };\n \n@@ -170,7 +206,6 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n                            .Mine(2001, TestTime(30003), 0x100).TestFailed().TestStateSinceHeight(1000)\n                            .Mine(2999, TestTime(30004), 0x100).TestFailed().TestStateSinceHeight(1000)\n                            .Mine(3000, TestTime(30005), 0x100).TestFailed().TestStateSinceHeight(1000)\n-\n         // DEFINED -> STARTED -> FAILED\n                            .Reset().TestDefined().TestStateSinceHeight(0)\n                            .Mine(1, TestTime(1), 0).TestDefined().TestStateSinceHeight(0)\n@@ -203,9 +238,10 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n                            .Mine(2999, TestTime(19999), 0x200).TestStarted().TestStateSinceHeight(2000) // 49 old blocks\n                            .Mine(3000, TestTime(29999), 0x200).TestLockedIn().TestStateSinceHeight(3000) // 1 old block (so 900 out of the past 1000)\n                            .Mine(3999, TestTime(30001), 0).TestLockedIn().TestStateSinceHeight(3000)\n-                           .Mine(4000, TestTime(30002), 0).TestActive().TestStateSinceHeight(4000)\n-                           .Mine(14333, TestTime(30003), 0).TestActive().TestStateSinceHeight(4000)\n-                           .Mine(24000, TestTime(40000), 0).TestActive().TestStateSinceHeight(4000)\n+                           .Mine(4000, TestTime(30002), 0).TestActiveDelayed().TestStateSinceHeight(4000, 3000) // delayed will not become active until height=15000\n+                           .Mine(14333, TestTime(30003), 0).TestActiveDelayed().TestStateSinceHeight(4000, 3000)\n+                           .Mine(15000, TestTime(40000), 0).TestActive().TestStateSinceHeight(4000, 15000)\n+                           .Mine(24000, TestTime(40000), 0).TestActive().TestStateSinceHeight(4000, 15000)\n \n         // DEFINED multiple periods -> STARTED multiple periods -> FAILED\n                            .Reset().TestDefined().TestStateSinceHeight(0)\n@@ -216,7 +252,8 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n                            .Mine(4000, TestTime(10000), 0).TestStarted().TestStateSinceHeight(3000)\n                            .Mine(5000, TestTime(10000), 0).TestStarted().TestStateSinceHeight(3000)\n                            .Mine(6000, TestTime(20000), 0).TestFailed().TestStateSinceHeight(6000)\n-                           .Mine(7000, TestTime(20000), 0x100).TestFailed().TestStateSinceHeight(6000);\n+                           .Mine(7000, TestTime(20000), 0x100).TestFailed().TestStateSinceHeight(6000)\n+        ;\n     }\n }\n \n@@ -230,6 +267,13 @@ BOOST_AUTO_TEST_CASE(versionbits_sanity)\n         // Make sure that no deployment tries to set an invalid bit.\n         BOOST_CHECK_EQUAL(bitmask & ~(uint32_t)VERSIONBITS_TOP_MASK, bitmask);\n \n+        // Check min_activation_height is on a retarget boundary\n+        BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height % mainnetParams.nMinerConfirmationWindow, 0);\n+        // Check min_activation_height is 0 for ALWAYS_ACTIVE and never active deployments\n+        if (mainnetParams.vDeployments[i].nStartTime == Consensus::BIP9Deployment::ALWAYS_ACTIVE || mainnetParams.vDeployments[i].nTimeout <= 1230768000) {\n+            BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height, 0);\n+        }\n+\n         // Verify that the deployment windows of different deployment using the\n         // same bit are disjoint.\n         // This test may need modification at such time as a new deployment\n@@ -268,7 +312,8 @@ static void check_computeblockversion(const Consensus::Params& params, Consensus\n     BOOST_REQUIRE(nTimeout <= std::numeric_limits<uint32_t>::max() || nTimeout == Consensus::BIP9Deployment::NO_TIMEOUT);\n     BOOST_REQUIRE(0 <= bit && bit < 32);\n     BOOST_REQUIRE(((1 << bit) & VERSIONBITS_TOP_MASK) == 0);\n-    BOOST_REQUIRE(min_activation_height == 0);\n+    BOOST_REQUIRE(min_activation_height >= 0);\n+    BOOST_REQUIRE_EQUAL(min_activation_height % params.nMinerConfirmationWindow, 0);\n \n     // In the first chain, test that the bit is set by CBV until it has failed.\n     // In the second chain, test the bit is set by CBV while STARTED and\n@@ -378,6 +423,16 @@ static void check_computeblockversion(const Consensus::Params& params, Consensus\n     lastBlock = secondChain.Mine((params.nMinerConfirmationWindow * 3) - 1, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n     BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1 << bit)) != 0);\n     lastBlock = secondChain.Mine(params.nMinerConfirmationWindow * 3, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+\n+    if (lastBlock->nHeight + 1 < min_activation_height) {\n+        // check signalling continues while min_activation_height is not reached\n+        lastBlock = secondChain.Mine(min_activation_height - 1, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+        BOOST_CHECK((ComputeBlockVersion(lastBlock, params) & (1 << bit)) != 0);\n+        // then reach min_activation_height, which was already REQUIRE'd to start a new period\n+        lastBlock = secondChain.Mine(min_activation_height, nTime, VERSIONBITS_LAST_OLD_BLOCK_VERSION).Tip();\n+    }\n+\n+    // Check that we don't signal after activation\n     BOOST_CHECK_EQUAL(ComputeBlockVersion(lastBlock, params) & (1<<bit), 0);\n }\n \n@@ -391,6 +446,16 @@ BOOST_AUTO_TEST_CASE(versionbits_computeblockversion)\n             check_computeblockversion(chainParams->GetConsensus(), static_cast<Consensus::DeploymentPos>(i));\n         }\n     }\n+\n+    {\n+        // Use regtest/testdummy to ensure we always exercise the\n+        // min_activation_height test, even if we're not using that in a\n+        // live deployment\n+        ArgsManager args;\n+        args.ForceSetArg(\"-vbparams\", \"testdummy:1199145601:1230767999:403200\"); // January 1, 2008 - December 31, 2008, min act height 403200\n+        const auto chainParams = CreateChainParams(args, CBaseChainParams::REGTEST);\n+        check_computeblockversion(chainParams->GetConsensus(), Consensus::DEPLOYMENT_TESTDUMMY);\n+    }\n }\n \n BOOST_AUTO_TEST_SUITE_END()"
      }
    ]
  },
  {
    "sha": "dd07e6da48040dc7eae46bc7941db48d98a669fd",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkZDA3ZTZkYTQ4MDQwZGM3ZWFlNDZiYzc5NDFkYjQ4ZDk4YTY2OWZk",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-03-16T12:12:19Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-04-12T01:14:49Z"
      },
      "message": "fuzz: test versionbits delayed activation",
      "tree": {
        "sha": "daae087a16bd0b29751799af85f9068fce70efa2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/daae087a16bd0b29751799af85f9068fce70efa2"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/dd07e6da48040dc7eae46bc7941db48d98a669fd",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dd07e6da48040dc7eae46bc7941db48d98a669fd",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/dd07e6da48040dc7eae46bc7941db48d98a669fd",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dd07e6da48040dc7eae46bc7941db48d98a669fd/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "dd85d5411c1702c8ae259610fe55050ba212e21e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dd85d5411c1702c8ae259610fe55050ba212e21e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/dd85d5411c1702c8ae259610fe55050ba212e21e"
      }
    ],
    "stats": {
      "total": 21,
      "additions": 15,
      "deletions": 6
    },
    "files": [
      {
        "sha": "11640d1ee905678b28d38dd8ae68767a48133aba",
        "filename": "src/test/fuzz/versionbits.cpp",
        "status": "modified",
        "additions": 15,
        "deletions": 6,
        "changes": 21,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd07e6da48040dc7eae46bc7941db48d98a669fd/src/test/fuzz/versionbits.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd07e6da48040dc7eae46bc7941db48d98a669fd/src/test/fuzz/versionbits.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/fuzz/versionbits.cpp?ref=dd07e6da48040dc7eae46bc7941db48d98a669fd",
        "patch": "@@ -29,21 +29,24 @@ class TestConditionChecker : public AbstractThresholdConditionChecker\n     const int64_t m_end;\n     const int m_period;\n     const int m_threshold;\n+    const int m_min_activation_height;\n     const int m_bit;\n \n-    TestConditionChecker(int64_t begin, int64_t end, int period, int threshold, int bit)\n-        : m_begin{begin}, m_end{end}, m_period{period}, m_threshold{threshold}, m_bit{bit}\n+    TestConditionChecker(int64_t begin, int64_t end, int period, int threshold, int min_activation_height, int bit)\n+        : m_begin{begin}, m_end{end}, m_period{period}, m_threshold{threshold}, m_min_activation_height{min_activation_height}, m_bit{bit}\n     {\n         assert(m_period > 0);\n         assert(0 <= m_threshold && m_threshold <= m_period);\n         assert(0 <= m_bit && m_bit < 32 && m_bit < VERSIONBITS_NUM_BITS);\n+        assert(0 <= m_min_activation_height);\n     }\n \n     bool Condition(const CBlockIndex* pindex, const Consensus::Params& params) const override { return Condition(pindex->nVersion); }\n     int64_t BeginTime(const Consensus::Params& params) const override { return m_begin; }\n     int64_t EndTime(const Consensus::Params& params) const override { return m_end; }\n     int Period(const Consensus::Params& params) const override { return m_period; }\n     int Threshold(const Consensus::Params& params) const override { return m_threshold; }\n+    int MinActivationHeight(const Consensus::Params& params) const override { return m_min_activation_height; }\n \n     ThresholdState GetStateFor(const CBlockIndex* pindexPrev) const { return AbstractThresholdConditionChecker::GetStateFor(pindexPrev, dummy_params, m_cache); }\n     int GetStateSinceHeightFor(const CBlockIndex* pindexPrev) const { return AbstractThresholdConditionChecker::GetStateSinceHeightFor(pindexPrev, dummy_params, m_cache); }\n@@ -168,8 +171,9 @@ FUZZ_TARGET_INIT(versionbits, initialize)\n             never_active_test = true;\n         }\n     }\n+    int min_activation = fuzzed_data_provider.ConsumeIntegralInRange<int>(0, period * max_periods);\n \n-    TestConditionChecker checker(start_time, timeout, period, threshold, bit);\n+    TestConditionChecker checker(start_time, timeout, period, threshold, min_activation, bit);\n \n     // Early exit if the versions don't signal sensibly for the deployment\n     if (!checker.Condition(ver_signal)) return;\n@@ -306,11 +310,16 @@ FUZZ_TARGET_INIT(versionbits, initialize)\n         }\n         break;\n     case ThresholdState::LOCKED_IN:\n-        assert(exp_state == ThresholdState::STARTED);\n-        assert(current_block->GetMedianTimePast() < checker.m_end);\n-        assert(blocks_sig >= threshold);\n+        if (exp_state == ThresholdState::LOCKED_IN) {\n+            assert(current_block->nHeight + 1 < min_activation);\n+        } else {\n+            assert(exp_state == ThresholdState::STARTED);\n+            assert(current_block->GetMedianTimePast() < checker.m_end);\n+            assert(blocks_sig >= threshold);\n+        }\n         break;\n     case ThresholdState::ACTIVE:\n+        assert(always_active_test || min_activation <= current_block->nHeight + 1);\n         assert(exp_state == ThresholdState::ACTIVE || exp_state == ThresholdState::LOCKED_IN);\n         break;\n     case ThresholdState::FAILED:"
      }
    ]
  },
  {
    "sha": "55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1NWFjNWY1NjhhM2I3M2Q2ZjFlZjQ2NTQ2MTdmYjc2ZThiY2JjY2Rm",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-03-27T13:00:14Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-04-12T01:14:49Z"
      },
      "message": "versionbits: Add explicit NEVER_ACTIVE deployments\n\nPreviously we used deployments that would timeout prior to Bitcoin's\ninvention, which allowed the deployment to still be activated in unit\ntests. This switches those deployments to be truly never active.",
      "tree": {
        "sha": "2119c25550db38ca3befd8030dbae8338bd65aad",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2119c25550db38ca3befd8030dbae8338bd65aad"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "dd07e6da48040dc7eae46bc7941db48d98a669fd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dd07e6da48040dc7eae46bc7941db48d98a669fd",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/dd07e6da48040dc7eae46bc7941db48d98a669fd"
      }
    ],
    "stats": {
      "total": 89,
      "additions": 48,
      "deletions": 41
    },
    "files": [
      {
        "sha": "318b5c9a7139c3d8877bc4fdb408afe90ff08c9d",
        "filename": "src/chainparams.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 10,
        "changes": 20,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf/src/chainparams.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf/src/chainparams.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/chainparams.cpp?ref=55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf",
        "patch": "@@ -81,14 +81,14 @@ class CMainParams : public CChainParams {\n         consensus.nRuleChangeActivationThreshold = 1916; // 95% of 2016\n         consensus.nMinerConfirmationWindow = 2016; // nPowTargetTimespan / nPowTargetSpacing\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].bit = 28;\n-        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime = 1199145601; // January 1, 2008\n-        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nTimeout = 1230767999; // December 31, 2008\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime = Consensus::BIP9Deployment::NEVER_ACTIVE;\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nTimeout = Consensus::BIP9Deployment::NO_TIMEOUT;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].min_activation_height = 0; // No activation delay\n \n         // Deployment of Taproot (BIPs 340-342)\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].bit = 2;\n-        consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nStartTime = 1199145601; // January 1, 2008\n-        consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nTimeout = 1230767999; // December 31, 2008\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nStartTime = Consensus::BIP9Deployment::NEVER_ACTIVE;\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nTimeout = Consensus::BIP9Deployment::NO_TIMEOUT;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].min_activation_height = 0; // No activation delay\n \n         consensus.nMinimumChainWork = uint256S(\"0x00000000000000000000000000000000000000001533efd8d716a517fe2c5008\");\n@@ -200,14 +200,14 @@ class CTestNetParams : public CChainParams {\n         consensus.nRuleChangeActivationThreshold = 1512; // 75% for testchains\n         consensus.nMinerConfirmationWindow = 2016; // nPowTargetTimespan / nPowTargetSpacing\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].bit = 28;\n-        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime = 1199145601; // January 1, 2008\n-        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nTimeout = 1230767999; // December 31, 2008\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime = Consensus::BIP9Deployment::NEVER_ACTIVE;\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nTimeout = Consensus::BIP9Deployment::NO_TIMEOUT;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].min_activation_height = 0; // No activation delay\n \n         // Deployment of Taproot (BIPs 340-342)\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].bit = 2;\n-        consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nStartTime = 1199145601; // January 1, 2008\n-        consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nTimeout = 1230767999; // December 31, 2008\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nStartTime = Consensus::BIP9Deployment::NEVER_ACTIVE;\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].nTimeout = Consensus::BIP9Deployment::NO_TIMEOUT;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TAPROOT].min_activation_height = 0; // No activation delay\n \n         consensus.nMinimumChainWork = uint256S(\"0x0000000000000000000000000000000000000000000001db6ec4ac88cf2272c6\");\n@@ -337,8 +337,8 @@ class SigNetParams : public CChainParams {\n         consensus.MinBIP9WarningHeight = 0;\n         consensus.powLimit = uint256S(\"00000377ae000000000000000000000000000000000000000000000000000000\");\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].bit = 28;\n-        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime = 1199145601; // January 1, 2008\n-        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nTimeout = 1230767999; // December 31, 2008\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime = Consensus::BIP9Deployment::NEVER_ACTIVE;\n+        consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nTimeout = Consensus::BIP9Deployment::NO_TIMEOUT;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].min_activation_height = 0; // No activation delay\n \n         // Activation of Taproot (BIPs 340-342)"
      },
      {
        "sha": "28c95e0884150851ce68d2ba4dece86249169cde",
        "filename": "src/consensus/params.h",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf/src/consensus/params.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf/src/consensus/params.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/consensus/params.h?ref=55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf",
        "patch": "@@ -43,6 +43,11 @@ struct BIP9Deployment {\n      *  process (which takes at least 3 BIP9 intervals). Only tests that specifically test the\n      *  behaviour during activation cannot use this. */\n     static constexpr int64_t ALWAYS_ACTIVE = -1;\n+\n+    /** Special value for nStartTime indicating that the deployment is never active.\n+     *  This is useful for integrating the code changes for a new feature\n+     *  prior to deploying it on some or all networks. */\n+    static constexpr int64_t NEVER_ACTIVE = -2;\n };\n \n /**"
      },
      {
        "sha": "1130a384e53eb7eb3ffd501785cfa862eae17ea7",
        "filename": "src/rpc/blockchain.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 4,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf/src/rpc/blockchain.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf/src/rpc/blockchain.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/blockchain.cpp?ref=55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf",
        "patch": "@@ -1225,10 +1225,8 @@ static void BuriedForkDescPushBack(UniValue& softforks, const std::string &name,\n static void BIP9SoftForkDescPushBack(UniValue& softforks, const std::string &name, const Consensus::Params& consensusParams, Consensus::DeploymentPos id) EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n {\n     // For BIP9 deployments.\n-    // Deployments (e.g. testdummy) with timeout value before Jan 1, 2009 are hidden.\n-    // A timeout value of 0 guarantees a softfork will never be activated.\n-    // This is used when merging logic to implement a proposed softfork without a specified deployment schedule.\n-    if (consensusParams.vDeployments[id].nTimeout <= 1230768000) return;\n+    // Deployments that are never active are hidden.\n+    if (consensusParams.vDeployments[id].nStartTime == Consensus::BIP9Deployment::NEVER_ACTIVE) return;\n \n     UniValue bip9(UniValue::VOBJ);\n     const ThresholdState thresholdState = VersionBitsState(::ChainActive().Tip(), consensusParams, id, versionbitscache);"
      },
      {
        "sha": "41773232336faa500601d5d6c065022b79e9615e",
        "filename": "src/test/fuzz/versionbits.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 17,
        "changes": 27,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf/src/test/fuzz/versionbits.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf/src/test/fuzz/versionbits.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/fuzz/versionbits.cpp?ref=55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf",
        "patch": "@@ -163,13 +163,12 @@ FUZZ_TARGET_INIT(versionbits, initialize)\n     } else {\n         if (fuzzed_data_provider.ConsumeBool()) {\n             start_time = Consensus::BIP9Deployment::ALWAYS_ACTIVE;\n-            timeout = Consensus::BIP9Deployment::NO_TIMEOUT;\n             always_active_test = true;\n         } else {\n-            start_time = 1199145601; // January 1, 2008\n-            timeout = 1230767999;    // December 31, 2008\n+            start_time = Consensus::BIP9Deployment::NEVER_ACTIVE;\n             never_active_test = true;\n         }\n+        timeout = fuzzed_data_provider.ConsumeBool() ? Consensus::BIP9Deployment::NO_TIMEOUT : fuzzed_data_provider.ConsumeIntegral<int64_t>();\n     }\n     int min_activation = fuzzed_data_provider.ConsumeIntegralInRange<int>(0, period * max_periods);\n \n@@ -323,7 +322,7 @@ FUZZ_TARGET_INIT(versionbits, initialize)\n         assert(exp_state == ThresholdState::ACTIVE || exp_state == ThresholdState::LOCKED_IN);\n         break;\n     case ThresholdState::FAILED:\n-        assert(current_block->GetMedianTimePast() >= checker.m_end);\n+        assert(never_active_test || current_block->GetMedianTimePast() >= checker.m_end);\n         assert(exp_state != ThresholdState::LOCKED_IN && exp_state != ThresholdState::ACTIVE);\n         break;\n     default:\n@@ -335,26 +334,20 @@ FUZZ_TARGET_INIT(versionbits, initialize)\n         assert(state == ThresholdState::ACTIVE || state == ThresholdState::FAILED);\n     }\n \n-    // \"always active\" has additional restrictions\n     if (always_active_test) {\n+        // \"always active\" has additional restrictions\n         assert(state == ThresholdState::ACTIVE);\n         assert(exp_state == ThresholdState::ACTIVE);\n         assert(since == 0);\n+    } else if (never_active_test) {\n+        // \"never active\" does too\n+        assert(state == ThresholdState::FAILED);\n+        assert(exp_state == ThresholdState::FAILED);\n+        assert(since == 0);\n     } else {\n-        // except for always active, the initial state is always DEFINED\n+        // for signalled deployments, the initial state is always DEFINED\n         assert(since > 0 || state == ThresholdState::DEFINED);\n         assert(exp_since > 0 || exp_state == ThresholdState::DEFINED);\n     }\n-\n-    // \"never active\" does too\n-    if (never_active_test) {\n-        assert(state == ThresholdState::FAILED);\n-        assert(since == period);\n-        if (exp_since == 0) {\n-            assert(exp_state == ThresholdState::DEFINED);\n-        } else {\n-            assert(exp_state == ThresholdState::FAILED);\n-        }\n-    }\n }\n } // namespace"
      },
      {
        "sha": "80072eff9c5d64d9ca4dd2cb9111184d4150ce30",
        "filename": "src/test/versionbits_tests.cpp",
        "status": "modified",
        "additions": 15,
        "deletions": 9,
        "changes": 24,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf/src/test/versionbits_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf/src/test/versionbits_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/versionbits_tests.cpp?ref=55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf",
        "patch": "@@ -59,8 +59,7 @@ class TestAlwaysActiveConditionChecker : public TestConditionChecker\n class TestNeverActiveConditionChecker : public TestConditionChecker\n {\n public:\n-    int64_t BeginTime(const Consensus::Params& params) const override { return 0; }\n-    int64_t EndTime(const Consensus::Params& params) const override { return 1230768000; }\n+    int64_t BeginTime(const Consensus::Params& params) const override { return Consensus::BIP9Deployment::NEVER_ACTIVE; }\n };\n \n #define CHECKERS 6\n@@ -134,10 +133,7 @@ class VersionBitsTester\n                 BOOST_CHECK_MESSAGE(checker[i].GetStateSinceHeightFor(tip) == height, strprintf(\"Test %i for StateSinceHeight\", num));\n                 BOOST_CHECK_MESSAGE(checker_delayed[i].GetStateSinceHeightFor(tip) == height_delayed, strprintf(\"Test %i for StateSinceHeight (delayed)\", num));\n                 BOOST_CHECK_MESSAGE(checker_always[i].GetStateSinceHeightFor(tip) == 0, strprintf(\"Test %i for StateSinceHeight (always active)\", num));\n-\n-                // never active may go from DEFINED -> FAILED at the first period\n-                const auto never_height = checker_never[i].GetStateSinceHeightFor(tip);\n-                BOOST_CHECK_MESSAGE(never_height == 0 || never_height == checker_never[i].Period(paramsDummy), strprintf(\"Test %i for StateSinceHeight (never active)\", num));\n+                BOOST_CHECK_MESSAGE(checker_never[i].GetStateSinceHeightFor(tip) == 0, strprintf(\"Test %i for StateSinceHeight (never active)\", num));\n             }\n         }\n         num++;\n@@ -170,7 +166,7 @@ class VersionBitsTester\n                 BOOST_CHECK_MESSAGE(got == exp, strprintf(\"Test %i for %s height %d (got %s)\", num, StateName(exp), height, StateName(got)));\n                 BOOST_CHECK_MESSAGE(got_delayed == exp_delayed, strprintf(\"Test %i for %s height %d (got %s; delayed case)\", num, StateName(exp_delayed), height, StateName(got_delayed)));\n                 BOOST_CHECK_MESSAGE(got_always == ThresholdState::ACTIVE, strprintf(\"Test %i for ACTIVE height %d (got %s; always active case)\", num, height, StateName(got_always)));\n-                BOOST_CHECK_MESSAGE(got_never == ThresholdState::DEFINED|| got_never == ThresholdState::FAILED, strprintf(\"Test %i for DEFINED/FAILED height %d (got %s; never active case)\", num, height, StateName(got_never)));\n+                BOOST_CHECK_MESSAGE(got_never == ThresholdState::FAILED, strprintf(\"Test %i for FAILED height %d (got %s; never active case)\", num, height, StateName(got_never)));\n             }\n         }\n         num++;\n@@ -270,7 +266,7 @@ BOOST_AUTO_TEST_CASE(versionbits_sanity)\n         // Check min_activation_height is on a retarget boundary\n         BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height % mainnetParams.nMinerConfirmationWindow, 0);\n         // Check min_activation_height is 0 for ALWAYS_ACTIVE and never active deployments\n-        if (mainnetParams.vDeployments[i].nStartTime == Consensus::BIP9Deployment::ALWAYS_ACTIVE || mainnetParams.vDeployments[i].nTimeout <= 1230768000) {\n+        if (mainnetParams.vDeployments[i].nStartTime == Consensus::BIP9Deployment::ALWAYS_ACTIVE || mainnetParams.vDeployments[i].nStartTime == Consensus::BIP9Deployment::NEVER_ACTIVE) {\n             BOOST_CHECK_EQUAL(mainnetParams.vDeployments[i].min_activation_height, 0);\n         }\n \n@@ -304,8 +300,9 @@ static void check_computeblockversion(const Consensus::Params& params, Consensus\n     // should not be any signalling for first block\n     BOOST_CHECK_EQUAL(ComputeBlockVersion(nullptr, params), VERSIONBITS_TOP_BITS);\n \n-    // always active deployments shouldn't need to be tested further\n+    // always/never active deployments shouldn't need to be tested further\n     if (nStartTime == Consensus::BIP9Deployment::ALWAYS_ACTIVE) return;\n+    if (nStartTime == Consensus::BIP9Deployment::NEVER_ACTIVE) return;\n \n     BOOST_REQUIRE(nStartTime < nTimeout);\n     BOOST_REQUIRE(nStartTime >= 0);\n@@ -447,6 +444,15 @@ BOOST_AUTO_TEST_CASE(versionbits_computeblockversion)\n         }\n     }\n \n+    {\n+        // Use regtest/testdummy to ensure we always exercise some\n+        // deployment that's not always/never active\n+        ArgsManager args;\n+        args.ForceSetArg(\"-vbparams\", \"testdummy:1199145601:1230767999\"); // January 1, 2008 - December 31, 2008\n+        const auto chainParams = CreateChainParams(args, CBaseChainParams::REGTEST);\n+        check_computeblockversion(chainParams->GetConsensus(), Consensus::DEPLOYMENT_TESTDUMMY);\n+    }\n+\n     {\n         // Use regtest/testdummy to ensure we always exercise the\n         // min_activation_height test, even if we're not using that in a"
      },
      {
        "sha": "df666c963fa4d3fd3811bd2dac944489fc7e5907",
        "filename": "src/versionbits.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 1,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf/src/versionbits.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf/src/versionbits.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/versionbits.cpp?ref=55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf",
        "patch": "@@ -18,6 +18,11 @@ ThresholdState AbstractThresholdConditionChecker::GetStateFor(const CBlockIndex*\n         return ThresholdState::ACTIVE;\n     }\n \n+    // Check if this deployment is never active.\n+    if (nTimeStart == Consensus::BIP9Deployment::NEVER_ACTIVE) {\n+        return ThresholdState::FAILED;\n+    }\n+\n     // A block's state is always the same as that of the first of its period, so it is computed based on a pindexPrev whose height equals a multiple of nPeriod - 1.\n     if (pindexPrev != nullptr) {\n         pindexPrev = pindexPrev->GetAncestor(pindexPrev->nHeight - ((pindexPrev->nHeight + 1) % nPeriod));\n@@ -129,7 +134,7 @@ BIP9Stats AbstractThresholdConditionChecker::GetStateStatisticsFor(const CBlockI\n int AbstractThresholdConditionChecker::GetStateSinceHeightFor(const CBlockIndex* pindexPrev, const Consensus::Params& params, ThresholdConditionCache& cache) const\n {\n     int64_t start_time = BeginTime(params);\n-    if (start_time == Consensus::BIP9Deployment::ALWAYS_ACTIVE) {\n+    if (start_time == Consensus::BIP9Deployment::ALWAYS_ACTIVE || start_time == Consensus::BIP9Deployment::NEVER_ACTIVE) {\n         return 0;\n     }\n "
      }
    ]
  },
  {
    "sha": "f054f6bcd2c2ce5fea84cf8681013f85a444e7ea",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmMDU0ZjZiY2QyYzJjZTVmZWE4NGNmODY4MTAxM2Y4NWE0NDRlN2Vh",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-04-07T00:20:46Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-04-12T01:14:49Z"
      },
      "message": "versionbits: simplify state transitions\n\nThis removes the DEFINED->FAILED transition and changes the\nSTARTED->FAILED transition to only occur if signalling didn't pass the\nthreshold. This ensures that it is always possible for activation to\noccur, no matter what settings are chosen, or the speed at which blocks\nare found.",
      "tree": {
        "sha": "14212c1c8094e94b3f8866698f2d386fb7a40966",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/14212c1c8094e94b3f8866698f2d386fb7a40966"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f054f6bcd2c2ce5fea84cf8681013f85a444e7ea",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f054f6bcd2c2ce5fea84cf8681013f85a444e7ea",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/f054f6bcd2c2ce5fea84cf8681013f85a444e7ea",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f054f6bcd2c2ce5fea84cf8681013f85a444e7ea/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/55ac5f568a3b73d6f1ef4654617fb76e8bcbccdf"
      }
    ],
    "stats": {
      "total": 61,
      "additions": 29,
      "deletions": 32
    },
    "files": [
      {
        "sha": "91868218362c17e4141dde0cc196cf0b03412092",
        "filename": "src/test/fuzz/versionbits.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 10,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f054f6bcd2c2ce5fea84cf8681013f85a444e7ea/src/test/fuzz/versionbits.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f054f6bcd2c2ce5fea84cf8681013f85a444e7ea/src/test/fuzz/versionbits.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/fuzz/versionbits.cpp?ref=f054f6bcd2c2ce5fea84cf8681013f85a444e7ea",
        "patch": "@@ -147,19 +147,14 @@ FUZZ_TARGET_INIT(versionbits, initialize)\n         // pick the timestamp to switch based on a block\n         // note states will change *after* these blocks because mediantime lags\n         int start_block = fuzzed_data_provider.ConsumeIntegralInRange<int>(0, period * (max_periods - 3));\n-        int end_block = fuzzed_data_provider.ConsumeIntegralInRange<int>(start_block, period * (max_periods - 3));\n+        int end_block = fuzzed_data_provider.ConsumeIntegralInRange<int>(0, period * (max_periods - 3));\n \n         start_time = block_start_time + start_block * interval;\n         timeout = block_start_time + end_block * interval;\n \n-        assert(start_time <= timeout);\n-\n         // allow for times to not exactly match a block\n         if (fuzzed_data_provider.ConsumeBool()) start_time += interval / 2;\n         if (fuzzed_data_provider.ConsumeBool()) timeout += interval / 2;\n-\n-        // this may make timeout too early; if so, don't run the test\n-        if (start_time > timeout) return;\n     } else {\n         if (fuzzed_data_provider.ConsumeBool()) {\n             start_time = Consensus::BIP9Deployment::ALWAYS_ACTIVE;\n@@ -297,13 +292,12 @@ FUZZ_TARGET_INIT(versionbits, initialize)\n         assert(since == 0);\n         assert(exp_state == ThresholdState::DEFINED);\n         assert(current_block->GetMedianTimePast() < checker.m_begin);\n-        assert(current_block->GetMedianTimePast() < checker.m_end);\n         break;\n     case ThresholdState::STARTED:\n         assert(current_block->GetMedianTimePast() >= checker.m_begin);\n-        assert(current_block->GetMedianTimePast() < checker.m_end);\n         if (exp_state == ThresholdState::STARTED) {\n             assert(blocks_sig < threshold);\n+            assert(current_block->GetMedianTimePast() < checker.m_end);\n         } else {\n             assert(exp_state == ThresholdState::DEFINED);\n         }\n@@ -313,7 +307,6 @@ FUZZ_TARGET_INIT(versionbits, initialize)\n             assert(current_block->nHeight + 1 < min_activation);\n         } else {\n             assert(exp_state == ThresholdState::STARTED);\n-            assert(current_block->GetMedianTimePast() < checker.m_end);\n             assert(blocks_sig >= threshold);\n         }\n         break;\n@@ -323,7 +316,11 @@ FUZZ_TARGET_INIT(versionbits, initialize)\n         break;\n     case ThresholdState::FAILED:\n         assert(never_active_test || current_block->GetMedianTimePast() >= checker.m_end);\n-        assert(exp_state != ThresholdState::LOCKED_IN && exp_state != ThresholdState::ACTIVE);\n+        if (exp_state == ThresholdState::STARTED) {\n+            assert(blocks_sig < threshold);\n+        } else {\n+            assert(exp_state == ThresholdState::FAILED);\n+        }\n         break;\n     default:\n         assert(false);"
      },
      {
        "sha": "05838ec19a21031c985912274c56bfb91424a8fb",
        "filename": "src/test/versionbits_tests.cpp",
        "status": "modified",
        "additions": 19,
        "deletions": 15,
        "changes": 34,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f054f6bcd2c2ce5fea84cf8681013f85a444e7ea/src/test/versionbits_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f054f6bcd2c2ce5fea84cf8681013f85a444e7ea/src/test/versionbits_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/versionbits_tests.cpp?ref=f054f6bcd2c2ce5fea84cf8681013f85a444e7ea",
        "patch": "@@ -190,18 +190,20 @@ BOOST_FIXTURE_TEST_SUITE(versionbits_tests, TestingSetup)\n BOOST_AUTO_TEST_CASE(versionbits_test)\n {\n     for (int i = 0; i < 64; i++) {\n-        // DEFINED -> FAILED\n+        // DEFINED -> STARTED after timeout reached -> FAILED\n         VersionBitsTester().TestDefined().TestStateSinceHeight(0)\n                            .Mine(1, TestTime(1), 0x100).TestDefined().TestStateSinceHeight(0)\n                            .Mine(11, TestTime(11), 0x100).TestDefined().TestStateSinceHeight(0)\n                            .Mine(989, TestTime(989), 0x100).TestDefined().TestStateSinceHeight(0)\n-                           .Mine(999, TestTime(20000), 0x100).TestDefined().TestStateSinceHeight(0)\n-                           .Mine(1000, TestTime(20000), 0x100).TestFailed().TestStateSinceHeight(1000)\n-                           .Mine(1999, TestTime(30001), 0x100).TestFailed().TestStateSinceHeight(1000)\n-                           .Mine(2000, TestTime(30002), 0x100).TestFailed().TestStateSinceHeight(1000)\n-                           .Mine(2001, TestTime(30003), 0x100).TestFailed().TestStateSinceHeight(1000)\n-                           .Mine(2999, TestTime(30004), 0x100).TestFailed().TestStateSinceHeight(1000)\n-                           .Mine(3000, TestTime(30005), 0x100).TestFailed().TestStateSinceHeight(1000)\n+                           .Mine(999, TestTime(20000), 0x100).TestDefined().TestStateSinceHeight(0) // Timeout and start time reached simultaneously\n+                           .Mine(1000, TestTime(20000), 0).TestStarted().TestStateSinceHeight(1000) // Hit started, stop signalling\n+                           .Mine(1999, TestTime(30001), 0).TestStarted().TestStateSinceHeight(1000)\n+                           .Mine(2000, TestTime(30002), 0x100).TestFailed().TestStateSinceHeight(2000) // Hit failed, start signalling again\n+                           .Mine(2001, TestTime(30003), 0x100).TestFailed().TestStateSinceHeight(2000)\n+                           .Mine(2999, TestTime(30004), 0x100).TestFailed().TestStateSinceHeight(2000)\n+                           .Mine(3000, TestTime(30005), 0x100).TestFailed().TestStateSinceHeight(2000)\n+                           .Mine(4000, TestTime(30006), 0x100).TestFailed().TestStateSinceHeight(2000)\n+\n         // DEFINED -> STARTED -> FAILED\n                            .Reset().TestDefined().TestStateSinceHeight(0)\n                            .Mine(1, TestTime(1), 0).TestDefined().TestStateSinceHeight(0)\n@@ -212,19 +214,19 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n                            .Mine(3000, TestTime(20000), 0).TestFailed().TestStateSinceHeight(3000) // 50 old blocks (so 899 out of the past 1000)\n                            .Mine(4000, TestTime(20010), 0x100).TestFailed().TestStateSinceHeight(3000)\n \n-        // DEFINED -> STARTED -> FAILED while threshold reached\n+        // DEFINED -> STARTED -> LOCKEDIN after timeout reached -> ACTIVE\n                            .Reset().TestDefined().TestStateSinceHeight(0)\n                            .Mine(1, TestTime(1), 0).TestDefined().TestStateSinceHeight(0)\n                            .Mine(1000, TestTime(10000) - 1, 0x101).TestDefined().TestStateSinceHeight(0) // One second more and it would be defined\n                            .Mine(2000, TestTime(10000), 0x101).TestStarted().TestStateSinceHeight(2000) // So that's what happens the next period\n                            .Mine(2999, TestTime(30000), 0x100).TestStarted().TestStateSinceHeight(2000) // 999 new blocks\n-                           .Mine(3000, TestTime(30000), 0x100).TestFailed().TestStateSinceHeight(3000) // 1 new block (so 1000 out of the past 1000 are new)\n-                           .Mine(3999, TestTime(30001), 0).TestFailed().TestStateSinceHeight(3000)\n-                           .Mine(4000, TestTime(30002), 0).TestFailed().TestStateSinceHeight(3000)\n-                           .Mine(14333, TestTime(30003), 0).TestFailed().TestStateSinceHeight(3000)\n-                           .Mine(24000, TestTime(40000), 0).TestFailed().TestStateSinceHeight(3000)\n+                           .Mine(3000, TestTime(30000), 0x100).TestLockedIn().TestStateSinceHeight(3000) // 1 new block (so 1000 out of the past 1000 are new)\n+                           .Mine(3999, TestTime(30001), 0).TestLockedIn().TestStateSinceHeight(3000)\n+                           .Mine(4000, TestTime(30002), 0).TestActiveDelayed().TestStateSinceHeight(4000, 3000)\n+                           .Mine(14333, TestTime(30003), 0).TestActiveDelayed().TestStateSinceHeight(4000, 3000)\n+                           .Mine(24000, TestTime(40000), 0).TestActive().TestStateSinceHeight(4000, 15000)\n \n-        // DEFINED -> STARTED -> LOCKEDIN at the last minute -> ACTIVE\n+        // DEFINED -> STARTED -> LOCKEDIN before timeout -> ACTIVE\n                            .Reset().TestDefined()\n                            .Mine(1, TestTime(1), 0).TestDefined().TestStateSinceHeight(0)\n                            .Mine(1000, TestTime(10000) - 1, 0x101).TestDefined().TestStateSinceHeight(0) // One second more and it would be defined\n@@ -247,8 +249,10 @@ BOOST_AUTO_TEST_CASE(versionbits_test)\n                            .Mine(3000, TestTime(10000), 0).TestStarted().TestStateSinceHeight(3000)\n                            .Mine(4000, TestTime(10000), 0).TestStarted().TestStateSinceHeight(3000)\n                            .Mine(5000, TestTime(10000), 0).TestStarted().TestStateSinceHeight(3000)\n+                           .Mine(5999, TestTime(20000), 0).TestStarted().TestStateSinceHeight(3000)\n                            .Mine(6000, TestTime(20000), 0).TestFailed().TestStateSinceHeight(6000)\n                            .Mine(7000, TestTime(20000), 0x100).TestFailed().TestStateSinceHeight(6000)\n+                           .Mine(24000, TestTime(20000), 0x100).TestFailed().TestStateSinceHeight(6000) // stay in FAILED no matter how much we signal\n         ;\n     }\n }"
      },
      {
        "sha": "df2ec4e056ed7d3a938bcada3343f140ab90d429",
        "filename": "src/versionbits.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 7,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f054f6bcd2c2ce5fea84cf8681013f85a444e7ea/src/versionbits.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f054f6bcd2c2ce5fea84cf8681013f85a444e7ea/src/versionbits.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/versionbits.cpp?ref=f054f6bcd2c2ce5fea84cf8681013f85a444e7ea",
        "patch": "@@ -57,18 +57,12 @@ ThresholdState AbstractThresholdConditionChecker::GetStateFor(const CBlockIndex*\n \n         switch (state) {\n             case ThresholdState::DEFINED: {\n-                if (pindexPrev->GetMedianTimePast() >= nTimeTimeout) {\n-                    stateNext = ThresholdState::FAILED;\n-                } else if (pindexPrev->GetMedianTimePast() >= nTimeStart) {\n+                if (pindexPrev->GetMedianTimePast() >= nTimeStart) {\n                     stateNext = ThresholdState::STARTED;\n                 }\n                 break;\n             }\n             case ThresholdState::STARTED: {\n-                if (pindexPrev->GetMedianTimePast() >= nTimeTimeout) {\n-                    stateNext = ThresholdState::FAILED;\n-                    break;\n-                }\n                 // We need to count\n                 const CBlockIndex* pindexCount = pindexPrev;\n                 int count = 0;\n@@ -80,6 +74,8 @@ ThresholdState AbstractThresholdConditionChecker::GetStateFor(const CBlockIndex*\n                 }\n                 if (count >= nThreshold) {\n                     stateNext = ThresholdState::LOCKED_IN;\n+                } else if (pindexPrev->GetMedianTimePast() >= nTimeTimeout) {\n+                    stateNext = ThresholdState::FAILED;\n                 }\n                 break;\n             }"
      }
    ]
  },
  {
    "sha": "ffe33dfbd4c3b11e3475b022b6c1dd077613de79",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmZmUzM2RmYmQ0YzNiMTFlMzQ3NWIwMjJiNmMxZGQwNzc2MTNkZTc5",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-03-06T08:42:58Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2021-04-12T02:59:04Z"
      },
      "message": "chainparams: drop versionbits threshold to 90% for mainnnet and signet",
      "tree": {
        "sha": "eb74649873cd80eecece7b8ce54bcb3d366b8fbe",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/eb74649873cd80eecece7b8ce54bcb3d366b8fbe"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ffe33dfbd4c3b11e3475b022b6c1dd077613de79",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ffe33dfbd4c3b11e3475b022b6c1dd077613de79",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ffe33dfbd4c3b11e3475b022b6c1dd077613de79",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ffe33dfbd4c3b11e3475b022b6c1dd077613de79/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f054f6bcd2c2ce5fea84cf8681013f85a444e7ea",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f054f6bcd2c2ce5fea84cf8681013f85a444e7ea",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f054f6bcd2c2ce5fea84cf8681013f85a444e7ea"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 2,
      "deletions": 2
    },
    "files": [
      {
        "sha": "0656b099a91456614b3c1fe51fdc14bac9c36cda",
        "filename": "src/chainparams.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ffe33dfbd4c3b11e3475b022b6c1dd077613de79/src/chainparams.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ffe33dfbd4c3b11e3475b022b6c1dd077613de79/src/chainparams.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/chainparams.cpp?ref=ffe33dfbd4c3b11e3475b022b6c1dd077613de79",
        "patch": "@@ -78,7 +78,7 @@ class CMainParams : public CChainParams {\n         consensus.nPowTargetSpacing = 10 * 60;\n         consensus.fPowAllowMinDifficultyBlocks = false;\n         consensus.fPowNoRetargeting = false;\n-        consensus.nRuleChangeActivationThreshold = 1916; // 95% of 2016\n+        consensus.nRuleChangeActivationThreshold = 1815; // 90% of 2016\n         consensus.nMinerConfirmationWindow = 2016; // nPowTargetTimespan / nPowTargetSpacing\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].bit = 28;\n         consensus.vDeployments[Consensus::DEPLOYMENT_TESTDUMMY].nStartTime = Consensus::BIP9Deployment::NEVER_ACTIVE;\n@@ -332,7 +332,7 @@ class SigNetParams : public CChainParams {\n         consensus.nPowTargetSpacing = 10 * 60;\n         consensus.fPowAllowMinDifficultyBlocks = false;\n         consensus.fPowNoRetargeting = false;\n-        consensus.nRuleChangeActivationThreshold = 1916; // 95% of 2016\n+        consensus.nRuleChangeActivationThreshold = 1815; // 90% of 2016\n         consensus.nMinerConfirmationWindow = 2016; // nPowTargetTimespan / nPowTargetSpacing\n         consensus.MinBIP9WarningHeight = 0;\n         consensus.powLimit = uint256S(\"00000377ae000000000000000000000000000000000000000000000000000000\");"
      }
    ]
  }
]