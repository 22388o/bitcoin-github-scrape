[
  {
    "sha": "bf720c14608f884baa862431869ac83d25775f3e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiZjcyMGMxNDYwOGY4ODRiYWE4NjI0MzE4NjlhYzgzZDI1Nzc1ZjNl",
    "commit": {
      "author": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2018-04-27T16:50:45Z"
      },
      "committer": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2018-04-27T19:01:31Z"
      },
      "message": "Add --failfast option to functional test runner\n\nAlso cleans up run_test's arguments list (no more mutable default for `args`)\nand call site.",
      "tree": {
        "sha": "930e19a02279166eea3bf18a904492de680e7ea1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/930e19a02279166eea3bf18a904492de680e7ea1"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bf720c14608f884baa862431869ac83d25775f3e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bf720c14608f884baa862431869ac83d25775f3e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/bf720c14608f884baa862431869ac83d25775f3e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bf720c14608f884baa862431869ac83d25775f3e/comments",
    "author": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "17266a13067c061783e0428c6200985ed8872b16",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/17266a13067c061783e0428c6200985ed8872b16",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/17266a13067c061783e0428c6200985ed8872b16"
      }
    ],
    "stats": {
      "total": 36,
      "additions": 34,
      "deletions": 2
    },
    "files": [
      {
        "sha": "ff4b4801655426601ed3832d7e94096eee5fba96",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 34,
        "deletions": 2,
        "changes": 36,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/bf720c14608f884baa862431869ac83d25775f3e/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/bf720c14608f884baa862431869ac83d25775f3e/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=bf720c14608f884baa862431869ac83d25775f3e",
        "patch": "@@ -201,6 +201,7 @@ def main():\n     parser.add_argument('--keepcache', '-k', action='store_true', help='the default behavior is to flush the cache directory on startup. --keepcache retains the cache from the previous testrun.')\n     parser.add_argument('--quiet', '-q', action='store_true', help='only print results summary and failure logs')\n     parser.add_argument('--tmpdirprefix', '-t', default=tempfile.gettempdir(), help=\"Root directory for datadirs\")\n+    parser.add_argument('--failfast', action='store_true', help='stop execution after the first test failure')\n     args, unknown_args = parser.parse_known_args()\n \n     # args to be passed on always start with two dashes; tests are the remaining unknown args\n@@ -283,9 +284,21 @@ def main():\n     if not args.keepcache:\n         shutil.rmtree(\"%s/test/cache\" % config[\"environment\"][\"BUILDDIR\"], ignore_errors=True)\n \n-    run_tests(test_list, config[\"environment\"][\"SRCDIR\"], config[\"environment\"][\"BUILDDIR\"], tmpdir, args.jobs, args.coverage, passon_args, args.combinedlogslen)\n+    run_tests(\n+        test_list,\n+        config[\"environment\"][\"SRCDIR\"],\n+        config[\"environment\"][\"BUILDDIR\"],\n+        tmpdir,\n+        jobs=args.jobs,\n+        enable_coverage=args.coverage,\n+        args=passon_args,\n+        combined_logs_len=args.combinedlogslen,\n+        failfast=args.failfast,\n+    )\n+\n+def run_tests(test_list, src_dir, build_dir, tmpdir, jobs=1, enable_coverage=False, args=None, combined_logs_len=0, failfast=False):\n+    args = args or []\n \n-def run_tests(test_list, src_dir, build_dir, tmpdir, jobs=1, enable_coverage=False, args=[], combined_logs_len=0):\n     # Warn if bitcoind is already running (unix only)\n     try:\n         if subprocess.check_output([\"pidof\", \"bitcoind\"]) is not None:\n@@ -346,6 +359,10 @@ def run_tests(test_list, src_dir, build_dir, tmpdir, jobs=1, enable_coverage=Fal\n                 combined_logs, _ = subprocess.Popen([sys.executable, os.path.join(tests_dir, 'combine_logs.py'), '-c', testdir], universal_newlines=True, stdout=subprocess.PIPE).communicate()\n                 print(\"\\n\".join(deque(combined_logs.splitlines(), combined_logs_len)))\n \n+            if failfast:\n+                logging.debug(\"Early exiting after test failure\")\n+                break\n+\n     print_results(test_results, max_len_name, (int(time.time() - start_time)))\n \n     if coverage:\n@@ -360,6 +377,10 @@ def run_tests(test_list, src_dir, build_dir, tmpdir, jobs=1, enable_coverage=Fal\n \n     all_passed = all(map(lambda test_result: test_result.was_successful, test_results))\n \n+    # This will be a no-op unless failfast is True in which case there may be dangling\n+    # processes which need to be killed.\n+    job_queue.kill_and_join()\n+\n     sys.exit(not all_passed)\n \n def print_results(test_results, max_len_name, runtime):\n@@ -450,6 +471,17 @@ def get_next(self):\n                     return TestResult(name, status, int(time.time() - start_time)), testdir, stdout, stderr\n             print('.', end='', flush=True)\n \n+    def kill_and_join(self):\n+        \"\"\"Send SIGKILL to all jobs and block until all have ended.\"\"\"\n+        procs = [i[2] for i in self.jobs]\n+\n+        for proc in procs:\n+            proc.kill()\n+\n+        for proc in procs:\n+            proc.wait()\n+\n+\n class TestResult():\n     def __init__(self, name, status, time):\n         self.name = name"
      }
    ]
  },
  {
    "sha": "58f9a0a002ce45597ce2ed9e1902fb6ac608f014",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1OGY5YTBhMDAyY2U0NTU5N2NlMmVkOWUxOTAyZmI2YWM2MDhmMDE0",
    "commit": {
      "author": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2018-04-27T18:18:35Z"
      },
      "committer": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2018-04-27T19:01:40Z"
      },
      "message": "Use --failfast when running functional tests on Travis",
      "tree": {
        "sha": "a599ef06c65a5b83440fed6a5e80341d77e1d095",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a599ef06c65a5b83440fed6a5e80341d77e1d095"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/58f9a0a002ce45597ce2ed9e1902fb6ac608f014",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/58f9a0a002ce45597ce2ed9e1902fb6ac608f014",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/58f9a0a002ce45597ce2ed9e1902fb6ac608f014",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/58f9a0a002ce45597ce2ed9e1902fb6ac608f014/comments",
    "author": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "bf720c14608f884baa862431869ac83d25775f3e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bf720c14608f884baa862431869ac83d25775f3e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/bf720c14608f884baa862431869ac83d25775f3e"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 1,
      "deletions": 1
    },
    "files": [
      {
        "sha": "48bcdf601b72246cc4fa92847338151c4b4f852d",
        "filename": ".travis.yml",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/58f9a0a002ce45597ce2ed9e1902fb6ac608f014/.travis.yml",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/58f9a0a002ce45597ce2ed9e1902fb6ac608f014/.travis.yml",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/.travis.yml?ref=58f9a0a002ce45597ce2ed9e1902fb6ac608f014",
        "patch": "@@ -80,7 +80,7 @@ script:\n     - export LD_LIBRARY_PATH=$TRAVIS_BUILD_DIR/depends/$HOST/lib\n     - if [ \"$RUN_TESTS\" = \"true\" ]; then travis_wait 50 make $MAKEJOBS check VERBOSE=1; fi\n     - if [ \"$TRAVIS_EVENT_TYPE\" = \"cron\" ]; then extended=\"--extended --exclude feature_pruning,feature_dbcrash\"; fi\n-    - if [ \"$RUN_TESTS\" = \"true\" ]; then test/functional/test_runner.py --combinedlogslen=4000 --coverage --quiet ${extended}; fi\n+    - if [ \"$RUN_TESTS\" = \"true\" ]; then test/functional/test_runner.py --combinedlogslen=4000 --coverage --quiet --failfast ${extended}; fi\n after_script:\n     - echo $TRAVIS_COMMIT_RANGE\n     - echo $TRAVIS_COMMIT_LOG"
      }
    ]
  }
]