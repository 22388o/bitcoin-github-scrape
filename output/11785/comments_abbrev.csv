practicalswift,2017-11-29T08:44:57Z,Nice find. Thanks for reporting!,https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-347791237,347791237,
laanwj,2017-11-29T10:01:51Z,"Thanks!\n\nIt's kind of disappointing that evhttp has no way to limit file descriptors. This is the so-manieth hack we need to accommodate it. It's also not very actively maintained so trying to push any fix upstream will take a long time, if ever. I sometimes wonder if moving to [libevhtp](https://github.com/criticalstack/libevhtp), which seems to be the quasi-standard for http servers on top o",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-347810949,347810949,
promag,2017-11-29T10:08:52Z,Should we add a stress test to travis?,https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-347812829,347812829,
vii,2017-11-29T13:47:30Z,"@laanwj yes it is disappointing that there isn't a better API to manage this systemic issue in evhttp.\n\nEven more unfortunately, some configurations in Travis use an old version of libevent that doesn't have the bevcb callback or the ability to count added file descriptors. I've updated the pull request correspondingly. Protection is only available on newer libevents :(\n\nWhat programs are ",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-347864838,347864838,
laanwj,2017-11-30T13:13:24Z,"> I've updated the pull request correspondingly. Protection is only available on newer libevents :(\n\nI think it would make sense to add a ""known issue"" to the release notes, recommending people that stumble on file descriptor problems while doing a lot of separate RPC requests to upgrade their libevent.\n\nFWIW minimum seems to be 2.1.4:\n```bash\n$ git tag --contains 0fa107d8cbc652dacb722",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-348184234,348184234,
laanwj,2017-12-01T03:39:30Z,"This was discussed on IRC and according to @theuni this doesn't fully solve the problem, unfortunately. He could still fairly easy crash the server with many connections. So it will have to be solved from inside libevent.",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-348393090,348393090,
theuni,2017-12-01T05:02:35Z,"Yes, I've spent the last 2 days trying to work out our best option here. The provided patch is a big help, but I think there are a few more things we can do, namely a libevent patch. I'll push up some more changes tomorrow and we can discuss what it makes sense to pull in.",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-348402130,348402130,
vii,2017-12-01T13:29:41Z,"@theuni here is a libevent patch that provides sufficient functionality to constrain the number of file-descriptors to a tight bound: https://github.com/libevent/libevent/pull/578\n\nIn the meantime, as we work through the process to change libevent, the pull request here mitigates the original issue and defends against similar ones",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-348494814,348494814,
theuni,2017-12-02T06:30:20Z,"@vii Nice work on the upstream patch. It'll be great to have a real solution for this.\n\nI have a few concerns about the approach here:\n-  event_base_get_num_events is not a great representative of the connection count, as our own timers and triggers will throw off the count\n- I think keep-alive connections need to be closed if they're re-used once the connection limit has been reached, oth",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-348672418,348672418,
laanwj,2017-12-02T09:30:28Z,"Great!\n\n> It unfortunately doesn't help with libevent 2.0.x, which is by far the majority in the wild.\n\nYes - it would be nice to have a (potentially messy) workaround for older libevent, and a clean solution for future upstream versions.\n",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-348680175,348680175,
vii,2017-12-04T05:56:19Z,"@theuni - your patch looks great! I was cautious about modifying so much.\n\nGiven the discussion, I've reduced my pull request to the simple improvement of making sure to request as many file descriptors as possible.\n\nWith @theuni's improvement to only accept connections that have data on, honest HTTP connections will go into the connection limiter. However, I suspect adversaries using thin",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-348867263,348867263,
vii,2017-12-17T18:05:47Z,"this small change to request more file-descriptors does not depend on the libevent patch (which is making progress towards acceptance) but alleviates the issue in many configurations - except for deliberate attacks\n\nPlease review!\n\n",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-352273973,352273973,
vii,2017-12-18T03:55:03Z,"the libevent change has been merged into that repo so we can have a complete fix https://github.com/libevent/libevent/pull/578 - but the limited PR here does not depend on it\n\nHappy to make a more complete fix if it would be reviewed!",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-352319936,352319936,
theuni,2017-12-20T22:50:18Z,"@vii Great work on the upstream fix!\n\nI'll clean up my changes and PR them separately. I'll go ahead and work in the bevcb for supported versions, so that we can take advantage of that when possible.\n\nAs for raising the fd limit, I have mixed feelings. I worry that this will simply mask problems. I believe @gmaxwell was in favor, though.\n\n@gmaxwell: assuming we manage to contain this i",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-353205900,353205900,
vii,2017-12-30T17:46:23Z,"the issue that it masks is that several usages of file-descriptors are not budgeted for in the process wide file-descriptor allocation defined in https://github.com/bitcoin/bitcoin/blob/master/src/init.cpp#L907 \n\nIt would be quite difficult to carefully audit for all usages of file-descriptors as library functions may use them for various purposes. Even once the budgeting is done, this will be",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-354558923,354558923,
laanwj,2018-01-11T19:31:51Z,"What I'd like to know is how does other software handle this? Is it frowned upon for daemons to increase the file descriptor count without being asked? I thought the usual case for UNIX is to make changing resource limits up to the user/sysadmin, and changing them un-asked is deemed rude, but this might be different for file descriptors.\n",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-357036075,357036075,
vii,2018-01-30T04:30:31Z,"@laanwj we are not attempting to change the maximum, just adjusting to use the maximum we are allowed\n\nNote here is some similar code in the wine project - rather more battlehardened but with the same effect on Linux\n\nhttps://source.winehq.org/source/libs/wine/loader.c#L661\n",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-361474071,361474071,
eklitzke,2018-02-20T00:48:12Z,"@theuni brought this PR to my attention in a conversation we had earlier today. I was actually planning to implement the same behavior, for a completely different reason: I would like to increase the number of file descriptors that leveldb is allowed to use, because performance testing I have done makes me think that the low limit leveldb currently has is causing issues with which pages Linux deci",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-366836463,366836463,
laanwj,2018-03-05T21:23:32Z,@eklitzke Is that an ACK on this?,https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-370570757,370570757,
DrahtBot,2018-07-20T20:30:19Z,"<!--5d09a71f8925f3f132321140b44b946d-->The last travis run for this pull request was 215 days ago and is thus outdated. To trigger a fresh travis build, this pull request should be closed and re-opened.",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-406718512,406718512,
DrahtBot,2018-11-05T11:17:52Z,<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase,https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-435839814,435839814,
laanwj,2019-01-09T15:42:45Z,"Closing this, reviewing and development bled out and a rebase has been necessary for months. Let me know if I should reopen it.",https://github.com/bitcoin/bitcoin/pull/11785#issuecomment-452742267,452742267,
