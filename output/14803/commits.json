[
  {
    "sha": "a57873f0f9b2a96dd56401ff8ee322ca49a4b27e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphNTc4NzNmMGY5YjJhOTZkZDU2NDAxZmY4ZWUzMjJjYTQ5YTRiMjdl",
    "commit": {
      "author": {
        "name": "Hennadii Stepanov",
        "email": "32963518+hebasto@users.noreply.github.com",
        "date": "2018-11-25T14:50:10Z"
      },
      "committer": {
        "name": "Hennadii Stepanov",
        "email": "32963518+hebasto@users.noreply.github.com",
        "date": "2018-11-26T00:35:06Z"
      },
      "message": "Avoid data race in CBlock class",
      "tree": {
        "sha": "df8690f0c2d3b6afec17c6c0883185b369195e10",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/df8690f0c2d3b6afec17c6c0883185b369195e10"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE0dvyxLlvLev0wWZUQQEIES5+qB8FAlv7P7oACgkQQQEIES5+\nqB9SmxAAnL9GftbFr6jMYaLfFc1hlXfASFY74fnX6qfNQA3SPvwh5CU103C1Czcj\n3brr9l//00DnJK2lhpJJ9u7qjZ9PfupAR/duK+oKnu0NRx/aHz4mp1t8smxVYuBR\n6vAG1qPOPaeijJ2Vaqk8775EdT7wL0rCFPFLINkvM5RrAv0EodyeV3pcLjKQk3rY\nq39qXJtljf3WbII5eptYQYXLYRIbh5rxmWjc3/m4I2Q86hKMzfNgI0aD2AoBQeaW\nr4BoRSkRS/C8mJ+tIT/ye/s+vjYLVqx+gFpkQhWemlVnTNPaVrhP6sIZ4O6wMW0F\nh6cUD9OReoLTa+He77lnEUlMCz+OWQyYAZKhu3XxQo2ee2uVvXIUQIR6WNM1ueGZ\nVQmGlnvBYOLmYiI5tNakfKpV2Pk1Guk4vQaVqi9qMP0xwao0lZx7tuEC7uO8A/F7\nuz2YqmobIrGrOaJRCNRZNHdnh8W3fntzXxyReEsZbhPVZAskqePnNcqmOUhfKQtw\nB0/Zbx/31F5H4pfz2KZX94abQMTm4pp+ulCeBwB5KJwyG3agjGIMw8s7RtYANYUP\n25FS98xmJFkPRyJM2lHxr8iacGy7xYkTm5y0qzlLHMop0yQoU6sHdahTRS1lmJ5y\n6ch0FaAtk1rqQQGIJLgakYVdlYyCcFL0EDrkHruQe8Xuu7BZH/k=\n=e9Ha\n-----END PGP SIGNATURE-----",
        "payload": "tree df8690f0c2d3b6afec17c6c0883185b369195e10\nparent a7dc03223e915d7afb30498fe5faa12b5402f7d8\nauthor Hennadii Stepanov <32963518+hebasto@users.noreply.github.com> 1543157410 +0200\ncommitter Hennadii Stepanov <32963518+hebasto@users.noreply.github.com> 1543192506 +0200\n\nAvoid data race in CBlock class\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e/comments",
    "author": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "a7dc03223e915d7afb30498fe5faa12b5402f7d8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a7dc03223e915d7afb30498fe5faa12b5402f7d8",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/a7dc03223e915d7afb30498fe5faa12b5402f7d8"
      }
    ],
    "stats": {
      "total": 45,
      "additions": 38,
      "deletions": 7
    },
    "files": [
      {
        "sha": "cb4da9189f6d4336f2adf7138eba603eafbba54c",
        "filename": "src/primitives/block.cpp",
        "status": "modified",
        "additions": 27,
        "deletions": 0,
        "changes": 27,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e/src/primitives/block.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e/src/primitives/block.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/primitives/block.cpp?ref=a57873f0f9b2a96dd56401ff8ee322ca49a4b27e",
        "patch": "@@ -10,11 +10,38 @@\n #include <util/strencodings.h>\n #include <crypto/common.h>\n \n+#include <atomic>\n+\n uint256 CBlockHeader::GetHash() const\n {\n     return SerializeHash(*this);\n }\n \n+CBlockHeader::CBlockHeader(const CBlockHeader& header)\n+    : nVersion{header.nVersion},\n+      hashPrevBlock{header.hashPrevBlock},\n+      hashMerkleRoot{header.hashMerkleRoot},\n+      nTime{header.nTime},\n+      nBits{header.nBits},\n+      nNonce{header.nNonce}\n+{\n+}\n+\n+CBlock::CBlock(const CBlock& block)\n+    : CBlockHeader{static_cast<CBlockHeader>(block)},\n+      vtx{block.vtx}\n+{\n+    std::atomic_store(&m_checked, std::atomic_load(&block.m_checked));\n+}\n+\n+CBlock& CBlock::operator=(const CBlock& block)\n+{\n+    *(static_cast<CBlockHeader*>(this)) = static_cast<CBlockHeader>(block);\n+    vtx = block.vtx;\n+    std::atomic_store(&m_checked, std::atomic_load(&block.m_checked));\n+    return *this;\n+}\n+\n std::string CBlock::ToString() const\n {\n     std::stringstream s;"
      },
      {
        "sha": "90355818149eeb3a6f96517b69f02f24d5a3c84d",
        "filename": "src/primitives/block.h",
        "status": "modified",
        "additions": 9,
        "deletions": 2,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e/src/primitives/block.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e/src/primitives/block.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/primitives/block.h?ref=a57873f0f9b2a96dd56401ff8ee322ca49a4b27e",
        "patch": "@@ -10,6 +10,8 @@\n #include <serialize.h>\n #include <uint256.h>\n \n+#include <atomic>\n+\n /** Nodes collect new transactions into a block, hash them into a hash tree,\n  * and scan through nonce values to make the block's hash satisfy proof-of-work\n  * requirements.  When they solve the proof-of-work, they broadcast the block\n@@ -33,6 +35,8 @@ class CBlockHeader\n         SetNull();\n     }\n \n+    CBlockHeader(const CBlockHeader& header);\n+\n     ADD_SERIALIZE_METHODS;\n \n     template <typename Stream, typename Operation>\n@@ -76,7 +80,7 @@ class CBlock : public CBlockHeader\n     std::vector<CTransactionRef> vtx;\n \n     // memory only\n-    mutable bool fChecked;\n+    mutable std::atomic<bool> m_checked;\n \n     CBlock()\n     {\n@@ -89,6 +93,9 @@ class CBlock : public CBlockHeader\n         *(static_cast<CBlockHeader*>(this)) = header;\n     }\n \n+    CBlock(const CBlock& block);\n+    CBlock& operator=(const CBlock& block);\n+\n     ADD_SERIALIZE_METHODS;\n \n     template <typename Stream, typename Operation>\n@@ -101,7 +108,7 @@ class CBlock : public CBlockHeader\n     {\n         CBlockHeader::SetNull();\n         vtx.clear();\n-        fChecked = false;\n+        m_checked = false;\n     }\n \n     CBlockHeader GetBlockHeader() const"
      },
      {
        "sha": "6298e9c6c7a4433e0f284489c867df76bd5bd346",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=a57873f0f9b2a96dd56401ff8ee322ca49a4b27e",
        "patch": "@@ -3081,7 +3081,7 @@ bool CheckBlock(const CBlock& block, CValidationState& state, const Consensus::P\n {\n     // These are checks that are independent of context.\n \n-    if (block.fChecked)\n+    if (block.m_checked)\n         return true;\n \n     // Check that the header is valid (particularly PoW).  This is mostly\n@@ -3135,7 +3135,7 @@ bool CheckBlock(const CBlock& block, CValidationState& state, const Consensus::P\n         return state.DoS(100, false, REJECT_INVALID, \"bad-blk-sigops\", false, \"out-of-bounds SigOpCount\");\n \n     if (fCheckPOW && fCheckMerkleRoot)\n-        block.fChecked = true;\n+        block.m_checked = true;\n \n     return true;\n }"
      },
      {
        "sha": "996f342eb97ddca4c0c1598265da583643fbbe42",
        "filename": "test/sanitizer_suppressions/tsan",
        "status": "modified",
        "additions": 0,
        "deletions": 3,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e/test/sanitizer_suppressions/tsan",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e/test/sanitizer_suppressions/tsan",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/sanitizer_suppressions/tsan?ref=a57873f0f9b2a96dd56401ff8ee322ca49a4b27e",
        "patch": "@@ -1,9 +1,6 @@\n # ThreadSanitizer suppressions\n # ============================\n \n-# fChecked is theoretically racy, practically only in unit tests\n-race:CheckBlock\n-\n # WalletBatch (unidentified deadlock)\n deadlock:WalletBatch\n "
      }
    ]
  },
  {
    "sha": "945a642ff4a4aa04222c3b7737aba6c1d1a969d1",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5NDVhNjQyZmY0YTRhYTA0MjIyYzNiNzczN2FiYTZjMWQxYTk2OWQx",
    "commit": {
      "author": {
        "name": "Hennadii Stepanov",
        "email": "32963518+hebasto@users.noreply.github.com",
        "date": "2018-11-26T00:37:22Z"
      },
      "committer": {
        "name": "Hennadii Stepanov",
        "email": "32963518+hebasto@users.noreply.github.com",
        "date": "2018-11-26T00:37:22Z"
      },
      "message": "Refactoring with CBlockHeader copy constructor",
      "tree": {
        "sha": "340d96bfe2a9a095bbcdc0414e83926385418706",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/340d96bfe2a9a095bbcdc0414e83926385418706"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/945a642ff4a4aa04222c3b7737aba6c1d1a969d1",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEE0dvyxLlvLev0wWZUQQEIES5+qB8FAlv7QEIACgkQQQEIES5+\nqB8h9g/+J+DbQSSK3qzVlUgME53ZnzRVDdVhNZ+kSzpYlTMYh77JKjeE9FD4KhCT\noppdyIWTewUT0KBGqEACJTjBJd5DbVS+1StwaTxHCRX/1Kre/mJlIMWAcnQQn77j\npnp3ud8xhJw8JyvgrBqO7K6HczmWYgpYBIumTjRKzSh6H1TkZADLBaE2K2jQxV+O\nQnptkXjKxqOf44UxO/JsxxZk2Ymj6Yz2wRaLH9i2nVEqBldX76mMueUmNDXHkBvV\nVMDI1/5fO4pEoPMPe/3tM8ojxYnaYuVGY1tcXvFH6wK75wF8RPnE7mimuODa88hp\nezuALf8qQGkryUm/mLgiLbHBnScKefRdL6q0ua03z6KZlAFIuzIMvagRuH7Kz1m9\nGWpcav5jgDBpG3l+HCKF3yjFNR1n2bKW25Zb9/i6mWZpogCTJGeRmOTWlnDjFRLd\nNSHkSd0dy2WakUn5KsCuTo2z1VvQKaBbFj5imYCCnsy2Q4EaQRz39QsCePWcc0Vk\nDzmvZXq6C4PtCoFT4nBJiUXURa2DWJRSOCbWTMfbhposSnuDFL2PKRzsamfBllG4\nTxpdfCOIVIIWREBkeH9LBt8hv3GP+A49uXLvpIRhmPBcFdedGfnwxD5nDH+/KqJd\nf+Flvd4aP/bZTtVkzyUKtaRht6zm5O4x6yHngozWFKUHfTmyzK8=\n=gVRE\n-----END PGP SIGNATURE-----",
        "payload": "tree 340d96bfe2a9a095bbcdc0414e83926385418706\nparent a57873f0f9b2a96dd56401ff8ee322ca49a4b27e\nauthor Hennadii Stepanov <32963518+hebasto@users.noreply.github.com> 1543192642 +0200\ncommitter Hennadii Stepanov <32963518+hebasto@users.noreply.github.com> 1543192642 +0200\n\nRefactoring with CBlockHeader copy constructor\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/945a642ff4a4aa04222c3b7737aba6c1d1a969d1",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/945a642ff4a4aa04222c3b7737aba6c1d1a969d1",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/945a642ff4a4aa04222c3b7737aba6c1d1a969d1/comments",
    "author": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "hebasto",
      "id": 32963518,
      "node_id": "MDQ6VXNlcjMyOTYzNTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/32963518?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/hebasto",
      "html_url": "https://github.com/hebasto",
      "followers_url": "https://api.github.com/users/hebasto/followers",
      "following_url": "https://api.github.com/users/hebasto/following{/other_user}",
      "gists_url": "https://api.github.com/users/hebasto/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/hebasto/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/hebasto/subscriptions",
      "organizations_url": "https://api.github.com/users/hebasto/orgs",
      "repos_url": "https://api.github.com/users/hebasto/repos",
      "events_url": "https://api.github.com/users/hebasto/events{/privacy}",
      "received_events_url": "https://api.github.com/users/hebasto/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "a57873f0f9b2a96dd56401ff8ee322ca49a4b27e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/a57873f0f9b2a96dd56401ff8ee322ca49a4b27e"
      }
    ],
    "stats": {
      "total": 9,
      "additions": 1,
      "deletions": 8
    },
    "files": [
      {
        "sha": "8969413647b656f9759c714fd5c8ada1bfbf7a4b",
        "filename": "src/primitives/block.h",
        "status": "modified",
        "additions": 1,
        "deletions": 8,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/945a642ff4a4aa04222c3b7737aba6c1d1a969d1/src/primitives/block.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/945a642ff4a4aa04222c3b7737aba6c1d1a969d1/src/primitives/block.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/primitives/block.h?ref=945a642ff4a4aa04222c3b7737aba6c1d1a969d1",
        "patch": "@@ -113,14 +113,7 @@ class CBlock : public CBlockHeader\n \n     CBlockHeader GetBlockHeader() const\n     {\n-        CBlockHeader block;\n-        block.nVersion       = nVersion;\n-        block.hashPrevBlock  = hashPrevBlock;\n-        block.hashMerkleRoot = hashMerkleRoot;\n-        block.nTime          = nTime;\n-        block.nBits          = nBits;\n-        block.nNonce         = nNonce;\n-        return block;\n+        return CBlockHeader(static_cast<CBlockHeader>(*this));\n     }\n \n     std::string ToString() const;"
      }
    ]
  }
]