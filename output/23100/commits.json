[
  {
    "sha": "58e1ff6a31cd80ad90f26962a04f664f22d6a711",
    "node_id": "C_kwDOABII59oAKDU4ZTFmZjZhMzFjZDgwYWQ5MGYyNjk2MmEwNGY2NjRmMjJkNmE3MTE",
    "commit": {
      "author": {
        "name": "katesalazar",
        "email": "mercedes.catherine.salazar@gmail.com",
        "date": "2021-09-26T15:14:15Z"
      },
      "committer": {
        "name": "katesalazar",
        "email": "mercedes.catherine.salazar@gmail.com",
        "date": "2021-10-19T07:52:01Z"
      },
      "message": "Abort functional tests early upon low drive space\n\nAs an exception, last functional tests to be run do not impose drive\nspace requirements.\n\nSome neighboring lines do not follow PEP8 strictly, so neither does\nsome of the lines in this change.\n\nIncludes many suggestions courtesy of MarcoFalke and fanquake and\ntheStack.",
      "tree": {
        "sha": "6e8f2397f12d9e5d52165018b1ffd0bf27775814",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6e8f2397f12d9e5d52165018b1ffd0bf27775814"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/58e1ff6a31cd80ad90f26962a04f664f22d6a711",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/58e1ff6a31cd80ad90f26962a04f664f22d6a711",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/58e1ff6a31cd80ad90f26962a04f664f22d6a711",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/58e1ff6a31cd80ad90f26962a04f664f22d6a711/comments",
    "author": {
      "login": "katesalazar",
      "id": 52637275,
      "node_id": "MDQ6VXNlcjUyNjM3Mjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/52637275?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/katesalazar",
      "html_url": "https://github.com/katesalazar",
      "followers_url": "https://api.github.com/users/katesalazar/followers",
      "following_url": "https://api.github.com/users/katesalazar/following{/other_user}",
      "gists_url": "https://api.github.com/users/katesalazar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/katesalazar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/katesalazar/subscriptions",
      "organizations_url": "https://api.github.com/users/katesalazar/orgs",
      "repos_url": "https://api.github.com/users/katesalazar/repos",
      "events_url": "https://api.github.com/users/katesalazar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/katesalazar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "katesalazar",
      "id": 52637275,
      "node_id": "MDQ6VXNlcjUyNjM3Mjc1",
      "avatar_url": "https://avatars.githubusercontent.com/u/52637275?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/katesalazar",
      "html_url": "https://github.com/katesalazar",
      "followers_url": "https://api.github.com/users/katesalazar/followers",
      "following_url": "https://api.github.com/users/katesalazar/following{/other_user}",
      "gists_url": "https://api.github.com/users/katesalazar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/katesalazar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/katesalazar/subscriptions",
      "organizations_url": "https://api.github.com/users/katesalazar/orgs",
      "repos_url": "https://api.github.com/users/katesalazar/repos",
      "events_url": "https://api.github.com/users/katesalazar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/katesalazar/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ff65b696f3c6f6e17a790c6646249163ddb39eda",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ff65b696f3c6f6e17a790c6646249163ddb39eda",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ff65b696f3c6f6e17a790c6646249163ddb39eda"
      }
    ],
    "stats": {
      "total": 22,
      "additions": 21,
      "deletions": 1
    },
    "files": [
      {
        "sha": "44544090ff3cdec6bd4a82af436e885adc70ee4f",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 21,
        "deletions": 1,
        "changes": 22,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/58e1ff6a31cd80ad90f26962a04f664f22d6a711/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/58e1ff6a31cd80ad90f26962a04f664f22d6a711/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=58e1ff6a31cd80ad90f26962a04f664f22d6a711",
        "patch": "@@ -27,6 +27,13 @@\n import logging\n import unittest\n \n+# Should break the tests loop immediately stopping testing if free space\n+# falls below this constant. At the time of writing, a node needs more\n+# than this 66MiB free space in order to start. A minimum of 16 MiB is\n+# requested by the node source code in order to start, and an additional\n+# 50 MiB is currently ensured by the utility code checking the space.\n+MIN_FREE_SPACE = (50 + 16) * 1024 * 1024\n+\n # Formatting. Default colors to empty strings.\n BOLD, GREEN, RED, GREY = (\"\", \"\"), (\"\", \"\"), (\"\", \"\"), (\"\", \"\")\n try:\n@@ -548,6 +555,18 @@ def run_tests(*, test_list, src_dir, build_dir, tmpdir, jobs=1, enable_coverage=\n                 logging.debug(\"Early exiting after test failure\")\n                 break\n \n+            shutil_disk_usage_stat_ = shutil.disk_usage(testdir)\n+            # Stop testing if free space in the drive is so low every subsequent test will fail,\n+            # sometimes without even being able to properly write logs (when getting busiest down to 0 free bytes).\n+            # If free space is larger than 0 but smaller than several MiB, nodes will fail to boot and log a message\n+            # telling that disk space is too low.\n+            if (shutil_disk_usage_stat_.free < MIN_FREE_SPACE\n+                    # But last tests to run from the suite do not impose a post-failure space requirement on next tests,\n+                    # because there aren't really next tests (in that exact run).\n+                    and i < test_count - jobs):\n+                logging.debug(\"Not enough free space left on device to continue testing\")\n+                break\n+\n     print_results(test_results, max_len_name, (int(time.time() - start_time)))\n \n     if coverage:\n@@ -564,7 +583,8 @@ def run_tests(*, test_list, src_dir, build_dir, tmpdir, jobs=1, enable_coverage=\n \n     all_passed = all(map(lambda test_result: test_result.was_successful, test_results)) and coverage_passed\n \n-    # Clean up dangling processes if any. This may only happen with --failfast option.\n+    # Clean up dangling processes if any. This may only happen when using the --failfast option,\n+    # or when the tests run loop gets broken early because low free space on the drive.\n     # Killing the process group will also terminate the current process but that is\n     # not an issue\n     if len(job_queue.jobs):"
      }
    ]
  }
]