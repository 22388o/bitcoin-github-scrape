laanwj,2017-05-01T07:11:05Z,utACK (can someone on MacOSX 10.12+ test this please?),https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-298297226,298297226,
jameshilliard,2017-05-01T14:09:25Z,"I tested this on MacOSX 10.12.4 myself, should we have a runtime /dev/random fallback for getentropy like we do for the linux SYS_getrandom?",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-298339546,298339546,
laanwj,2017-05-01T14:26:04Z,"> I tested this on MacOSX 10.12.4 myself, should we have a runtime /dev/random fallback for getentropy like we do for the linux SYS_getrandom?\n\nAs I understand it, MacOSX guarantees that anything compiled with the MacOSX 10.12 SDK, which is necessary to get autotools to detect this in the first place doesn't work on earlier versions of the OS. In which case this would be unnecessary.\n\nFeel",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-298342471,298342471,
theuni,2017-05-01T18:29:35Z,"@laanwj macOS uses weak imports for new symbols. They're fine to use as long as they're checked at runtime. This is how we're able to build with 10.11 (soon 10.12), but remain back-compat to 10.8. See an example of runtime handling at ```MacNotificationHandler::hasUserNotificationCenterSupport```.\n\ngetentropy does not exist in the 10.11 sdk. So I'm assuming that it is a weak import introduced ",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-298395527,298395527,
sipa,2017-05-01T22:55:10Z,@theuni I'm unsure whether your comment above means that this PR is fine or the opposite.,https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-298454264,298454264,
theuni,2017-05-02T00:00:13Z,"@sipa Sorry for being unclear. Cautiously, the opposite. I believe that this PR would cause runtime crashes when building with SDK >= 10.12, and running on < 10.12. We definitely need someone to test that scenario before merge, as 10.12 will likely be the SDK we use for 0.15.",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-298463853,298463853,
jameshilliard,2017-05-02T00:02:16Z,"@theuni so this means we need to do a runtime check and fallback like we do for SYS_getrandom?\n\nSomething like this maybe?\n```c++\nif (getentropy != NULL) {\n    if (getentropy(ent32, NUM_OS_RANDOM_BYTES) != 0) {\n        RandFailure();\n    }\n} else {\n    GetDevURandom(ent32);\n}\n```",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-298464124,298464124,
theuni,2017-05-02T00:21:36Z,"@jameshilliard Yes. According to the [apple docs](https://developer.apple.com/library/content/documentation/MacOSX/Conceptual/BPFrameworks/Concepts/WeakLinking.html#//apple_ref/doc/uid/20002378-106633-CJBGFCAC) it would look something like:\n```c++\n#if defined(HAVE_GETENTROPY_RAND)\n#if defined(MAC_OSX)\nif (getentropy != NULL) {\n    getentropy(foo, bar);\n} else {\n// fallback\n}\n#els",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-298466675,298466675,
jameshilliard,2017-05-02T02:03:25Z,I've added a runtime fallback but I don't have an OSX system with anything older than 10.12 to test against.,https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-298479432,298479432,
jameshilliard,2017-05-02T02:28:56Z,"Apparently the [Solaris version of getentropy](https://blogs.oracle.com/darren/entry/solaris_new_system_calls_getentropy) is not safe to use directly for cryptographic functions unlike OpenBSD and OSX and getrandom should be used there instead.\n\n> On Solaris the output of getentropy(2) is entropy and should not be used where randomness is needed, in particular it must not be used where an IV o",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-298482447,298482447,
sipa,2017-05-02T02:32:18Z,"> It is intended only for seeding a user space RBG (Random Bit Generator) system.\n\nGreat, that's what we're doing.",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-298482857,298482857,
jonasschnelli,2017-05-02T06:47:31Z,"I'll give it a test (build with 10.12 and run it own 10.8). Will report soon.\n\nAnd I agree with @theuni (Using getentropy â€“ which way introduced in 10.12 would crash in < 10.12). Here's the 10.12 manpage for genentropy for the records:\n\n```\n\n\n\n\n\n\n\nGETENTROPY(2)               BSD System Calls Manual              GETENTROPY(2)\n\nNAME\n     getentropy -- get entropy\n\nS",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-298510610,298510610,
laanwj,2017-05-03T10:36:21Z,"> Apparently the Solaris version of getentropy is not safe to use directly for cryptographic functions unlike OpenBSD and OSX and getrandom should be used there instead.\n\nMost of the OSes warn against using kernel entropy directly for cryptographic primitives. For example OpenBSD:\n```\n     getentropy() is not intended for regular code; please use the\n     arc4random(3) family of function",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-298876314,298876314,
laanwj,2017-06-07T10:52:18Z,"This has a lot of discussion but not really (ut)ACKs. Is the current approach ok, anything left to do here?",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-306760182,306760182,
laanwj,2017-07-25T12:17:18Z,This is no longer relevant after #10855 (only use getentropy on openbsd),https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-317719558,317719558,
jameshilliard,2017-07-26T15:14:19Z,"@laanwj It seems #10855 would not result in getentropy being included on systems like OSX, wouldn't this still be needed?",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-318084898,318084898,
laanwj,2017-07-26T17:28:03Z,"That's intentional, getentropy is only to be used on OpenBSD as there it's a system call. On OSX and Linux it's emulation of something at most so there it's not used.\n\nEdit: hrmph, on so OSX 10.12 it's a system call too, so in principle it could be used, but you'd have to ask @theuni.",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-318124947,318124947,
jameshilliard,2017-07-26T17:39:49Z,"> on so OSX 10.12 it's a system call too, so in principle it could be used, but you'd have to ask @theuni.\n\nYeah, that was the main purpose of this PR.",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-318128124,318128124,
laanwj,2017-07-26T17:45:36Z,"Reopening then, I had understood from the title that it just adds a check, which would no longer be relevant when the function is only used on obsd.\nNeeds rebase.",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-318129664,318129664,
gmaxwell,2017-07-26T17:55:10Z,"> This seems to imply that the function returns lower-quality instead of higher-quality entropy?!\n\nNah, FIPS 140-2 processing means standard mandated low qualityness. :P    Basically they do post processing to make sure they don't return all zeros or whatnot, which means (negligibly) lower entropy.  The original motivation is to make certain kinds of hardware RNG failures fail secure instead o",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-318132553,318132553,
jameshilliard,2017-07-27T12:45:18Z,I've modified this to check for OSX explicitly. Should I try and make this more universal or is that good enough for now?,https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-318351196,318351196,
theuni,2017-07-31T15:16:48Z,"I think this is ok as-is. It'd be nice to add a little refactor on top (later) to:\n- early-return on success, and have a single fall-back for /dev/urandom\n- Move detection out to a separate function so that we can log what's in use.",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-319098974,319098974,
theuni,2017-07-31T15:25:25Z,"utACK ee2d10ad0c0e04d0b9da4535a6fff265ac2501e5. I'm a little paranoid that an overly clever linker might try to optimize this check out of lto builds, but the crash would be obvious in that case.",https://github.com/bitcoin/bitcoin/pull/10301#issuecomment-319101718,319101718,
jonasschnelli,2017-05-02T06:56:17Z,nit: `for getentropy rand` sounds after we are looking for a new identifier/function. I recommend to use `for getentropy via random.h`.,https://github.com/bitcoin/bitcoin/pull/10301#discussion_r114257947,114257947,configure.ac
laanwj,2017-05-03T10:44:48Z,It seems harmless to do the `&getentropy != NULL` check for other platforms too (avoiding the MAC_OSX specific code).,https://github.com/bitcoin/bitcoin/pull/10301#discussion_r114516096,114516096,src/random.cpp
laanwj,2017-05-03T13:58:11Z,Keeping this comment would make sense (so those reading the code understand why the check is there),https://github.com/bitcoin/bitcoin/pull/10301#discussion_r114550795,114550795,src/random.cpp
