jonatack,2021-04-05 16:27:30,"I'm not sure about this.\n\nWould this change cause versioning/compatibility issues with previous/existing ban entries? (test coverage needed). It may be better to avoid changing `CBanEntry`, and have the RPC handle the calculation.\n\nAs a human user, I've found myself wishing for a ""time_remaining"" field in `listbanned`.\n",https://github.com/bitcoin/bitcoin/pull/21602#issuecomment-813486134,813486134,
jarolrod,2021-04-05 16:50:31,"@jonatack \n> It may be better to avoid changing `CBanEntry`, and have the RPC handle the calculation.\n\nYou're right, taking into consideration compatibility guarantees, performing the calculation is the simplest path.\n I will revise this PR to perform the calculation and avoid changing `CBanEntry` and `Banman`. \n\n> As a human user, I've found myself wishing for a ""time_remaining"" field",https://github.com/bitcoin/bitcoin/pull/21602#issuecomment-813499203,813499203,
jarolrod,2021-04-05 21:56:48,"updated from 9c896134b12f012d0736742693df4b50c133e506 to 8e34b5ed06f3ca0865b9b7dca6e31f2e95c6f5c8, addressed @jonatack suggestions:\n- perform the calculation inside the RPC command instead of changing `CBanEntry` and `Banman`. This avoids any compatibility issues.\n- Add additional `ban_time_remaining` field to `listbanned`",https://github.com/bitcoin/bitcoin/pull/21602#issuecomment-813673790,813673790,
jarolrod,2021-04-05 22:30:21,"updated from 8e34b5e to 833bebdece0f6fac5fecf602e88ef7c114f2416c, addressed @sipa suggestion:\n- GetTime() was being called inside of a loop due to an oversight. This is unnecessary and can produce inconsistent results. This moves GetTime() out of the loop so it is only called once.",https://github.com/bitcoin/bitcoin/pull/21602#issuecomment-813687171,813687171,
sipa,2021-04-06 00:54:28,utACK 833bebdece0f6fac5fecf602e88ef7c114f2416c,https://github.com/bitcoin/bitcoin/pull/21602#issuecomment-813747391,813747391,
DrahtBot,2021-04-06 02:28:13,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19825 (rpc: simpler setban and new ban manipulation commands by dhruv)\n\nIf you consider this pull request important, pl",https://github.com/bitcoin/bitcoin/pull/21602#issuecomment-813776867,813776867,
jonatack,2021-04-06 17:40:38,@jarolrod feel free to pull in the last commit in this branch https://github.com/jonatack/bitcoin/commits/pr21602-suggestions to add unit test coverage for these changes,https://github.com/bitcoin/bitcoin/pull/21602#issuecomment-814306888,814306888,
jarolrod,2021-04-07 06:21:42,"updated from 833bebd to c5c920f, addressed @jonatack [suggestions](https://github.com/bitcoin/bitcoin/pull/21602#discussion_r608016518)\n\n- swap positions of `ban_created` and `banned_until`\n- rename `ban_time` to `ban_duration`\n- rename `ban_time_remaining` to `time_remaining`\n- drop  `#include util/time.h`, this is already included by something else. \n  - Other commands already use `t",https://github.com/bitcoin/bitcoin/pull/21602#issuecomment-814636801,814636801,
jarolrod,2021-04-08 17:25:32,"Updated from c5c920f to d3b0b08\n\nChanges:\n- Include PR# into release notes",https://github.com/bitcoin/bitcoin/pull/21602#issuecomment-816003521,816003521,
jonatack,2021-04-08 18:01:50,"re-ACK d3b0b08b0f04d2f1dbebbafd7ab0384dfe045dec\n\nThere's a small potential race in the added unit tests. I didn't hit while running the test, even with valgrind to slow it down, but maybe something like this would provide a margin:\n```diff\n@@ -277,6 +277,7 @@ BOOST_AUTO_TEST_CASE(rpc_ban)\n \n     BOOST_CHECK_NO_THROW(r = CallRPC(std::string(""setban 127.0.0.0/24 add 200"")));\n     BOOST",https://github.com/bitcoin/bitcoin/pull/21602#issuecomment-816026617,816026617,
hebasto,2021-04-11 07:09:47,"Concept ACK on:\n> I found this helpful in adding additional context columns to the GUI `bantablemodel` as part of a follow-up PR.\n",https://github.com/bitcoin/bitcoin/pull/21602#issuecomment-817261509,817261509,
MarcoFalke,2021-04-11 11:36:19,(edited OP to remove `@`),https://github.com/bitcoin/bitcoin/pull/21602#issuecomment-817292791,817292791,
jonatack,2021-04-05 16:28:21,"```suggestion\n                        {RPCResult::Type::NUM_TIME, ""ban_time"", ""The ban duration, in seconds""},\n```",https://github.com/bitcoin/bitcoin/pull/21602#discussion_r607184959,607184959,src/rpc/net.cpp
jarolrod,2021-04-05 16:55:21,Thanks for making my original text look like a rube goldberg machine ðŸ¤—,https://github.com/bitcoin/bitcoin/pull/21602#discussion_r607199945,607199945,src/rpc/net.cpp
jarolrod,2021-04-05 21:54:01,addressed in 8e34b5ed06f3ca0865b9b7dca6e31f2e95c6f5c8,https://github.com/bitcoin/bitcoin/pull/21602#discussion_r607356560,607356560,src/rpc/net.cpp
sipa,2021-04-05 22:12:38,"Maybe query the time once before the loop, and use it for every iteration? This is needlessly slow and inconsistent.",https://github.com/bitcoin/bitcoin/pull/21602#discussion_r607364374,607364374,src/rpc/net.cpp
jarolrod,2021-04-05 22:15:18,"whoops, brain fart, forgot we were in a loop ",https://github.com/bitcoin/bitcoin/pull/21602#discussion_r607365347,607365347,src/rpc/net.cpp
jarolrod,2021-04-05 22:27:40,addressed in 833bebdece0f6fac5fecf602e88ef7c114f2416c,https://github.com/bitcoin/bitcoin/pull/21602#discussion_r607370219,607370219,src/rpc/net.cpp
jonatack,2021-04-06 16:46:52,"suggestions\n```diff\n@@ -751,10 +751,10 @@ static RPCHelpMan listbanned()\n                 {RPCResult::Type::OBJ, """", """",\n                     {\n                         {RPCResult::Type::STR, ""address"", ""The IP/Subnet of the banned node""},\n-                        {RPCResult::Type::NUM_TIME, ""banned_until"", ""The "" + UNIX_EPOCH_TIME + "" the node is banned until""},\n                    ",https://github.com/bitcoin/bitcoin/pull/21602#discussion_r608016518,608016518,src/rpc/net.cpp
jarolrod,2021-04-07 06:14:01,Thanks for the in-depth review! Special thanks for contributing a test. Addressed in c5c920f,https://github.com/bitcoin/bitcoin/pull/21602#discussion_r608366384,608366384,src/rpc/net.cpp
jonatack,2021-04-08 17:03:52,"```suggestion\n  both in seconds. Additionally, the `ban_created` field is repositioned to come before `banned_until`.  (#21602)\n```",https://github.com/bitcoin/bitcoin/pull/21602#discussion_r609911436,609911436,doc/release-notes.md
jarolrod,2021-04-08 17:23:51,done in d3b0b08b0f04d2f1dbebbafd7ab0384dfe045dec,https://github.com/bitcoin/bitcoin/pull/21602#discussion_r609929590,609929590,doc/release-notes.md
hebasto,2021-04-11 07:36:20,"https://github.com/bitcoin/bitcoin/blob/dd01dc6a1d23e1f316940cd1092ad716216331aa/src/util/time.h#L40-L44\n\n```suggestion\n    const int64_t current_time{GetSystemTimeInSeconds()};\n```",https://github.com/bitcoin/bitcoin/pull/21602#discussion_r611145828,611145828,src/rpc/net.cpp
MarcoFalke,2021-04-11 11:24:35,"banman uses `GetTime()` (mockable), so mixing non-mockable and mockable should be avoided",https://github.com/bitcoin/bitcoin/pull/21602#discussion_r611173165,611173165,src/rpc/net.cpp
hebasto,2021-04-11 11:26:13,"Ah, thanks!",https://github.com/bitcoin/bitcoin/pull/21602#discussion_r611173387,611173387,src/rpc/net.cpp
hebasto,2021-04-11 11:28:52,So it should be `GetTime<std::chrono::seconds>`?,https://github.com/bitcoin/bitcoin/pull/21602#discussion_r611173767,611173767,src/rpc/net.cpp
MarcoFalke,2021-04-11 11:41:42,"I guess so, but that refactor should also be done for nCreateTime, banman, ...",https://github.com/bitcoin/bitcoin/pull/21602#discussion_r611175422,611175422,src/rpc/net.cpp
MarcoFalke,2021-04-11 11:47:25,"this may fail:\n\n```\nRunning 1 test case...\ntest/rpc_tests.cpp(293): error: in ""rpc_tests/rpc_ban"": check time_remaining == banned_until - now has failed [200 != 199]\n\n*** 1 failure is detected in the test module ""Bitcoin Core Test Suite""\n```\n\ndiff:\n\n```diff\ndiff --git a/src/test/rpc_tests.cpp b/src/test/rpc_tests.cpp\nindex 3b6faf7bbb..be0d79aa86 100644\n--- a/src/test/rp",https://github.com/bitcoin/bitcoin/pull/21602#discussion_r611176103,611176103,src/test/rpc_tests.cpp
MarcoFalke,2021-04-14 08:08:29,See #21676,https://github.com/bitcoin/bitcoin/pull/21602#discussion_r613030085,613030085,src/test/rpc_tests.cpp
