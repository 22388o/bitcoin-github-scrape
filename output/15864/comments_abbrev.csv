hebasto,2019-04-22T04:19:44Z,"@promag Thank you for your review.\nTo be clear, the premature address to the default datadir, until possible `-datadir` option is read from the config file(s), is the root of all issues fixed by this PR.",https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-485320247,485320247,
promag,2019-04-22T10:01:07Z,"On my system:\n```\n# create a file in the default data dir\ntouch ""/Users/joao/Library/Application Support/Bitcoin""\n\n# launch with default data dir\nsrc/bitcoind\n\n\n************************\nEXCEPTION: N5boost10filesystem16filesystem_errorE\nboost::filesystem::create_directory: File exists: ""/Users/joao/Library/Application Support/Bitcoin""\nbitcoin in AppInit()\n\nAssertion fail",https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-485381588,485381588,
hebasto,2019-04-22T17:38:56Z,"@promag \n> On my system:\n> \n> ```\n> # create a file in the default data dir\n> touch ""/Users/joao/Library/Application Support/Bitcoin""\n> \n> # launch with default data dir\n> src/bitcoind\n> \n> \n> ************************\n> EXCEPTION: N5boost10filesystem16filesystem_errorE\n> boost::filesystem::create_directory: File exists: ""/Users/joao/Library/Application Support/Bitcoin""\n",https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-485488462,485488462,
DrahtBot,2019-04-28T11:47:10Z,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#16224](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16224.html) (gui: Bilingual GUI error messages by hebast",https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-487371677,487371677,
hebasto,2019-04-29T20:58:58Z,"@ryanofsky \nThank you for your review. Your comment has been addressed.\nAlso commits for `bitcoin-qt` and tools (`bitcoin-cli`, `bitcoin-wallet`) have been added.\n\nWould you mind re-reviewing?",https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-487741558,487741558,
hebasto,2019-05-09T15:30:04Z,"@ryanofsky \n> It's not really clear to me which bugs are being fixed by these changes, and how exactly the fixes work, but the basic idea seems to be to avoid calling GetDataDir() various places early on startup when it isn't necessary, to avoid caching bad values.\n\nThe root of the reported bugs (#15240, #15745) is `GetDataDir()` tries to _create_ data directory. This step is premature when ",https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-490952565,490952565,
promag,2019-05-09T16:35:33Z,I think we could replace the directory creation with an assertion (that datadir already exists) and create the directory right before the first call to `GetDataDir()` - probably on init.,https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-490976738,490976738,
hebasto,2019-05-09T18:23:43Z,"@promag \n> I think we could replace the directory creation with an assertion (that datadir already exists) and create the directory right before the first call to `GetDataDir()` - probably on init.\n\nIs it a bit out of the scope of this PR?\n",https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-491013690,491013690,
hebasto,2019-05-09T18:24:57Z,"@ryanofsky \nAll your comments have been addressed.",https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-491014090,491014090,
hebasto,2019-06-16T22:57:45Z,@MarcoFalke would you mind reviewing this PR?,https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-502492838,502492838,
hebasto,2019-06-17T15:56:07Z,Rebased after #16205 merged.,https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-502743586,502743586,
MarcoFalke,2019-06-17T17:18:57Z,Concept ACK,https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-502773918,502773918,
hebasto,2019-06-28T19:36:28Z,Rebased on top of #16300.,https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-506853091,506853091,
hebasto,2019-07-10T17:03:57Z,Rebased.,https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-510146436,510146436,
hebasto,2019-07-13T12:52:07Z,@laanwj Would you mind reviewing this PR?,https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-511119871,511119871,
MarcoFalke,2019-07-23T22:50:24Z,"The 09a307183aca7b2f6e1a14caf4430a1fc546e704 commit would have to be in the test commit or before it, otherwise the test running with the gui might fail on the test commit?",https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-514412038,514412038,
hebasto,2019-07-24T16:11:30Z,"Rebased.\n\n@MarcoFalke \n> The 09a3071 commit would have to be in the test commit or before it, otherwise the test running with the gui might fail on the test commit?\n\nCommits have been rearranged. The test commit is the last one now.",https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-514698147,514698147,
hebasto,2019-10-17T13:52:16Z,"@MarcoFalke https://github.com/bitcoin/bitcoin/issues/15240#issuecomment-541334088\n\nLabel ""Needs backport 0.18"" ?",https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-543184974,543184974,
promag,2019-04-21T22:45:49Z,Is this necessary? Looks like `fs::absolute` already does this in `AbsPathForConfigVal`.,https://github.com/bitcoin/bitcoin/pull/15864#discussion_r277184017,277184017,src/util/system.cpp
promag,2019-04-21T22:49:01Z,This doesn't check the default data dir.,https://github.com/bitcoin/bitcoin/pull/15864#discussion_r277184072,277184072,src/util/system.cpp
hebasto,2019-04-22T04:12:51Z,"Yes, it is needed to not touch default datadir unnecessarily, before all configs are read.",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r277202355,277202355,src/util/system.cpp
hebasto,2019-04-22T04:14:48Z,You are right. This behavior is intentional.,https://github.com/bitcoin/bitcoin/pull/15864#discussion_r277202508,277202508,src/util/system.cpp
ryanofsky,2019-04-29T15:06:04Z,"It seems like a better fix (simpler and more general) would be to add:\n\n```c++\nif (path.is_absolute()) return path;\n```\n\nas the first line of AbsPathForConfigVal.",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r279404726,279404726,src/util/system.cpp
ryanofsky,2019-05-07T18:43:57Z,"In commit ""Return absolute path early in AbsPathForConfigVal"" (f46eec4f80117ce242ed8c86b6216ece3eb20fba)\n\nIt would be helpful if the commit message said why this change was being made. Is this an optimization or is it preventing an error or does it have some other effect on behavior?",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r281778978,281778978,src/util/system.cpp
ryanofsky,2019-05-07T18:50:25Z,"> You are right. This behavior is intentional.\n\nWould be helpful to say what the function is supposed to do in the header. Maybe\n\n```c++\n//! Return true if -datadir value points to a valid directory or was not specified.\n```\n\nIt might be also be less confusing to write this as:\n\n```c++\nreturn !gArgs.IsArgSet(""-datadir"") || fs::is_directory(fs::system_complete(gArgs.GetArg(""-d",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r281781553,281781553,src/util/system.cpp
ryanofsky,2019-05-07T19:01:21Z,"In commit ""Add CheckDataDirOption() function"" (a45f692366d7bb4814af83e3b645c9e5a5a734e6)\n\nI don't think `IsArgSet` is the right function to call here. If somebody has a `datadir` option specified in the config file, but wants to unset it on the command line by passing `-nodatadir` or `-datadir=""""`, it seems like this should be allowed. Would suggest:\n\n```\nstd::string datadir = gArgs.GetA",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r281785729,281785729,src/util/system.cpp
ryanofsky,2019-05-07T19:11:06Z,"In commit ""Fix datadir handling in bitcoind"" (160470f76f22edd1f9ef6448584381fc5626b9c4)\n\nI can't figure out what this commit is doing. Is it fixing #15745 or #15864? Is the idea to prevent the datadir from being cached here? Can you write in the commit description what problem this is fixing and how it works?",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r281789154,281789154,src/bitcoind.cpp
hebasto,2019-05-09T15:48:37Z,Fixed.,https://github.com/bitcoin/bitcoin/pull/15864#discussion_r282548284,282548284,src/util/system.cpp
hebasto,2019-05-09T16:14:26Z,"> I don't think IsArgSet is the right function to call here. If somebody has a datadir option specified in the config file, but wants to unset it on the command line by passing -nodatadir or -datadir="""", it seems like this should be allowed.\n\nGood catch! Agree.",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r282559137,282559137,src/util/system.cpp
ryanofsky,2019-05-09T19:37:14Z,"In commit ""Add CheckDataDirOption() function"" (5df1581b9ee6f13593b33fa9629ea9fbadcad732)\n\nIdeally commit message might also mention that it changes the behavior of the GetDataDir function. The effect I think is to now allow `-nodatadir` or `-datadir=''` options on the command line to override any datadir specified in the config file and reset it to default. In theory this could even be mention",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r282634193,282634193,src/util/system.cpp
hebasto,2019-05-26T21:31:47Z,"> The effect I think is to now allow `-nodatadir` or `-datadir=''` options on the command line to override any datadir specified in the config file and reset it to default.\n\nUnfortunately, ~~neither~~ `-nodatadir` ~~nor `-datadir=''`~~ on the command line cannot unset datadir specified in the config file or reset it to default. See: #16097.",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r287615287,287615287,src/util/system.cpp
MarcoFalke,2019-06-28T19:55:28Z,"Would be nice if each commit had a test that failed before compilation and passes after. That might simplify review, no?",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r298729418,298729418,src/util/system.cpp
hebasto,2019-06-29T03:33:04Z,Do tests enabled in 5124b1cef24a9b30876ddedf922dfdb555bd4ace do this job?,https://github.com/bitcoin/bitcoin/pull/15864#discussion_r298785998,298785998,src/util/system.cpp
MarcoFalke,2019-07-02T22:56:33Z,"Then, why is this changed?",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r299716854,299716854,src/util/system.cpp
hebasto,2019-07-05T18:51:00Z,Please see https://github.com/bitcoin/bitcoin/pull/15864#issuecomment-490952565,https://github.com/bitcoin/bitcoin/pull/15864#discussion_r300772171,300772171,src/bitcoind.cpp
hebasto,2019-07-05T19:57:31Z,"The [initial idea](https://github.com/bitcoin/bitcoin/pull/15864#discussion_r281785729) was:\n> I don't think `IsArgSet` is the right function to call here.\n\nIf we recall:\nhttps://github.com/bitcoin/bitcoin/blob/8c69fae94410f54bad13be0f34d54370fddbf4b3/src/util/system.cpp#L470-L474\n\nusing `IsArgNegated` is (logically) inappropriate for `-datadir` option, IMO.\n\nAlso (but minor), the ",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r300785162,300785162,src/util/system.cpp
MarcoFalke,2019-07-08T18:38:53Z,Can they be enabled in this commit (the first commit)?,https://github.com/bitcoin/bitcoin/pull/15864#discussion_r301243552,301243552,src/util/system.cpp
hebasto,2019-07-08T19:16:50Z,"Do you mean to combine the ""Enable all tests in feature_config_args.py "" commit (5124b1cef24a9b30876ddedf922dfdb555bd4ace) into the ""Return absolute path early in AbsPathForConfigVal"" commit (c21150fd6f598196fae93cf4bddc6e7625a43660)?\n\nMaster branch plus this combined commit will fail the test.\nAnd the test will be passed on top of the 584621f9a81b6cc547c8f1365f1b358866e9a335 and b921f6ee951",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r301258664,301258664,src/util/system.cpp
hebasto,2019-07-24T16:30:19Z,"@ryanofsky @MarcoFalke \n> The effect I think is to now allow `-nodatadir` or `-datadir=''` options on the command line to override any datadir specified in the config file and reset it to default.\n\nActually, with this PR `-datadir=''` (with empty string) or `-datadir` will reset it to default. So, going to close #16416 in favor of this PR.",https://github.com/bitcoin/bitcoin/pull/15864#discussion_r306906349,306906349,src/util/system.cpp
