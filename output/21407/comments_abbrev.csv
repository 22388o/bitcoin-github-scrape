jonatack,2021-03-10 12:54:28,Is this from the OOM raised by the new fuzzer? Approach ACK; a test may be good.,https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-795373018,795373018,
vasild,2021-03-10 12:59:28,"I don't think so. To demonstrate the problem this PR is fixing a fuzz seed would have to supply all the data to cause OOM, whereas the [output](https://github.com/bitcoin/bitcoin/pull/21387#issuecomment-795334306) of the OOM you reported reads ""will not generate inputs larger than 1048576 bytes"".",https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-795378332,795378332,
laanwj,2021-03-10 14:16:44,Concept and code review ACK 32b63eb166470b05795f39ab01bc57d62abf79e7,https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-795472083,795472083,
DrahtBot,2021-03-10 16:43:42,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21387 (fuzz: test the I2P Session public interface by vasild)\n\nIf you consider this pull request important, please also",https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-795714357,795714357,
practicalswift,2021-03-10 22:23:51,"Concept ACK\n\nHappy this was caught so soon after I2P merge, and more importantly before release: we're doing something right :)\n\n@vasild May I ask how you found this issue?\n\nIf it wasn't found using the the I2P fuzzer awaiting review, could you add a fuzzing harness which would have been able to catch this issue (""regression fuzzing"")?",https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-796227143,796227143,
vasild,2021-03-11 09:08:58,"@practicalswift,\n> how you found this issue?\n\nExactly the right question! :)\n\nIt was not found by #21387, but a problem in it put this in front of my eyes. While fuzzing with #21387 I noticed that there is one slow case which was unexpected because the fuzz test is very small and should be quick.\n\nIt turned out that once the fuzz data is exhausted `FuzzedSock::Recv()` will keep retur",https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-796585929,796585929,
vasild,2021-03-11 11:17:14,"> Do we need to make the new param max_data optional?\n\nI think it is good to have the possibility for the old behavior (unlimited), which fits well with `std::optional` - ""if the limit is not set, then it is unlimited"".",https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-796662855,796662855,
vasild,2021-03-11 15:31:25,"Appended a new commit with a unit test to ensure that the added functionality of `Sock::RecvUntilTerminator()` works as expected.\n\nThis is not a regression test that would fail if the bug being fixed by this PR resurfaces. I am working on that too, but it will require the changes from #21387 and will be in a separate PR of its own.",https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-796821419,796821419,
vasild,2021-03-12 06:16:32,"> Appended a new commit with a unit test to ensure that the added functionality of `Sock::RecvUntilTerminator()` works as expected.\n\nOr, in other words: invalidate two ACKs and break the CI at the same time :disappointed: \n\n`b9373ec8f...28cfd6de4`: fix the CI failure",https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-797262982,797262982,
vasild,2021-03-13 05:51:36,"`28cfd6de4...faea165c9`: move the `MAX_MSG_SIZE` constant from `i2p.cpp` to `i2p.h` so that it can be used later by tests to send more than that without `\n`.\n\n@MarcoFalke `fa`!",https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-797873015,797873015,
laanwj,2021-03-16 07:42:53,"> Do we need to make the new param max_data optional?\n\n> I think it is good to have the possibility for the old behavior (unlimited), which fits well with std::optional - ""if the limit is not set, then it is unlimited"".\n\nI also thought about this; if there is no realistic case where to use ""unlimited"" (as it would always open some kind of DoS risk), it is more developer friendly to remove ",https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-800032155,800032155,
vasild,2021-03-16 10:11:22,"Alright, keep it simple - no callers currently need ""unlimited"" behavior, so drop that functionality. It would be easy to re-add it if necessary in the future. Thanks, @jonatack, @laanwj, @MarcoFalke for the feedback!\n\n`faea165c9...7059e6d82`: remove optional'ness of the max size argument",https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-800128133,800128133,
laanwj,2021-03-16 11:13:28,"Thank you\nRe-ACK 7059e6d82275b44efc41675ee10760145b6c1073",https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-800169914,800169914,
vasild,2021-03-16 14:03:58,"> a test may be good\n\nA test requires the changes made in https://github.com/bitcoin/bitcoin/pull/21387, added in that PR under the commit `test: add I2P test for a runaway SAM proxy`.",https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-800284886,800284886,
jonatack,2021-03-16 14:59:05,"Changes since my previous review LGTM per `git diff 32b63eb 7059e6d`\n\nPosthumous ACK 7059e6d82275b44efc41675ee10760145b6c1073",https://github.com/bitcoin/bitcoin/pull/21407#issuecomment-800333803,800333803,
jonatack,2021-03-11 10:11:39,"The dereference operator `operator*()` does not check if this optional contains a value, which may be more efficient than `value()` (https://en.cppreference.com/w/cpp/utility/optional/value). As `has_value()` is already checked, can also do (maybe not worth it but as a note):\n\n```diff\n         if (max_data.has_value()) {\n-            if (data.size() >= max_data.value()) {\n+            co",https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592229682,592229682,src/util/sock.cpp
vasild,2021-03-11 10:54:37,"Yeah, there is more than one way to write this. I chose the current one because I think the performance of `operator*` is negligible in this case and I find `.value()` more readable. Also\n```cpp\nif (max_data.has_value()) {\n```\ncan be written as\n```cpp\nif (max_data) {\n```\nbut I don't like those ""hidden"" casts and somehow prefer the former. The latter raises the question: ""given that",https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592260224,592260224,src/util/sock.cpp
jonatack,2021-03-11 10:56:26,"not sure what is more idiomatic\n```suggestion\n                                            std::optional<size_t> max_data = {}) const;\n```",https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592261547,592261547,src/util/sock.h
jonatack,2021-03-11 10:57:20,I generally agree. It was more of a note to expose options.,https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592262205,592262205,src/util/sock.cpp
JeremyRubin,2021-03-11 18:34:57,"personally I think nullopt is more readable. E.g., even though we know that {} is nullopt here, size_t x{} would be x == 0 right? So then could max_data={{}} be some(0)? ",https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592612008,592612008,src/util/sock.h
jonatack,2021-03-11 18:54:02,"yes, `std::nullopt` has the advantage of being more precise",https://github.com/bitcoin/bitcoin/pull/21407#discussion_r592630605,592630605,src/util/sock.h
MarcoFalke,2021-03-16 07:47:43,"Even if the optional is kept, wouldn't it make more sense to not provide a default value here?",https://github.com/bitcoin/bitcoin/pull/21407#discussion_r594927313,594927313,src/util/sock.h
vasild,2021-03-16 10:12:03,Dropped `std::optional` altogether.,https://github.com/bitcoin/bitcoin/pull/21407#discussion_r595027434,595027434,src/util/sock.h
