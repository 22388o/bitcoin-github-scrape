DrahtBot,2020-05-02 12:30:54,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19314 (refactor: Use uint16_t instead of unsigned short by renepickhardt)\n* #19184 (Overhaul transaction request logic b",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-622946443,622946443,
practicalswift,2020-05-02 15:38:41,Would be interesting to see this benchmarked to be able to reason about risk vs reward (where the ideal reward would be a significant measurable _and_ user-perceivable performance improvement) :),https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-622972234,622972234,
elichai,2020-05-04 11:09:06,"I'd be very interested to see the benchmarks of this :)\nI've tried doing similar things in the past, but C++ makes this somewhat scary for a big project with lots of contributors because it requires more careful tracking of lifetimes.\nAlso a few full IBD profiles I've done in the past show IIRC ~10-15% of local IBD time is spent on `new` and `delete`.\n ",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-623401118,623401118,
jb55,2020-05-04 15:26:18,"One of the hottest allocations that I found that might be the ""easiest"" to take a stab at is:\n\n`cacheCoins` `unordered_map` in `CCoinsViewCache::AddCoin`:\n\n`typedef std::unordered_map<COutPoint, CCoinsCacheEntry, SaltedOutpointHasher> CCoinsMap`\n\n\n![May04-081624](https://user-images.githubusercontent.com/45598/80982027-94174d80-8ddf-11ea-8972-4112742492dc.png)\n\nThis picture shows",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-623531668,623531668,
jb55,2020-05-04 15:38:50,"> Also a few full IBD profiles I've done in the past show IIRC ~10-15% of local IBD time is spent on new and delete.\n\nThis is a bit higher than I expected, but yes this is why gamedevs typically ban dynamic allocations from their main game loop, it absolutely kills performance: heap fragmentation, cache incoherency, etc, etc. Most high performing games arena-allocate or use custom allocators. ",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-623538984,623538984,
sipa,2020-05-04 22:17:34,"@jb55 The CCoinsMap is where the actual UTXO cache is stored - it should be one allocation per UTXO. That's a huge number, because we cache a huge number of UTXOs, but I don't expect it will be easy to reduce. IBD performance heavily relies on being able to delete cache entries if they're created and spent without a flush to disk in between, which seems incompatible with arena allocation.",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-623737476,623737476,
jb55,2020-05-05 09:21:32,"> @jb55 The CCoinsMap is where the actual UTXO cache is stored - it\n> should be one allocation per UTXO. That's a huge number, because we\n> cache a huge number of UTXOs, but I don't expect it will be easy to\n> reduce.\n\nyes in this case the only thing we could do better is a custom allocator\nthat maintains an efficient memory layout for cache friendliness, This\nis something I wanted to try a",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-623948640,623948640,
elichai,2020-05-05 10:10:04,"We could also replace the hashmap with one that preserves cache locality, like SwissTable (CC https://github.com/bitcoin/bitcoin/pull/16718)",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-623968554,623968554,
jb55,2020-05-05 18:23:55,"re: allocator, looks like there is some prior art here: https://github.com/bitcoin/bitcoin/pull/16801",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-624226380,624226380,
jamesob,2020-05-20 19:23:31,"I'm Concept ACK and generally in favor of the thought behind this project, but my reindex benchmarks show that runtime is indistinguishable from this branch's master merge-base. These changes still may be worth pursuing for other reasons, but just wanted to add some data.\n\n![Selection_160](https://user-images.githubusercontent.com/73197/82488389-ce563f80-9aad-11ea-886a-cb63150d7834.png)\n",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-631675858,631675858,
sipa,2020-05-20 19:28:38,"@jamesob Unless you're running with -par=1, I believe there is no change in behaviour (and even then, it's probably trivial).",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-631678371,631678371,
jb55,2020-05-20 20:22:53,"@jamesob thanks for running that, is there an easy way to run these myself as I hack on this branch? I'm guessing most perf would be dominated by IO factors/secp? Another motivating factor for this PR was to investigate heap usage in general. right now my core node uses a gig of ram and I'm looking at ways to reduce that outside of IBD.",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-631705413,631705413,
jb55,2020-05-20 20:45:36,"actually, I'm just going to try to reproduce this locally: pruned IBD in-memory filesystem, and I'll just run it a bunch of times up to some height and then compare the time-to-height.",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-631716914,631716914,
jb55,2020-05-20 21:40:16,"looks like the current changes don't affect IBD much at all:\n\n`-datadir=/run/bitcoin -reindex`\n\n```\nprune=550\nprinttoconsole=1\nconnect=127.0.0.2\nnoassumevalid=1\n```\n\n```\nreindex master to height 100,000 (ms)\n\n10700\n10768\n11017\n11016\n10852\n\nreindex zeroalloc to height 100,000 (ms)\n\n10846\n10796\n10826\n10817\n10764\n```\n\nlooks like I'll have to t",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-631741878,631741878,
jamesob,2020-05-21 00:48:15,"> ```\n> reindex zeroalloc to height 100,000 (ms)\n> ```\n\n\nConsider that testing reindex or IBD up to height 100,000 is uncharacteristic because it happens almost instantaneously relative to the rest of the chain. You may find my previous work in [bitcoinperf](https://github.com/chaincodelabs/bitcoinperf) helpful, if not a little hard to set up (happy to try and improve this with you).  [H",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-631813055,631813055,
jb55,2020-05-21 01:26:16,"@jamesob I tried a bit higher and started to see what might be a performance improvement: https://github.com/bitcoin/bitcoin/pull/18847#issuecomment-631822971\n\nThe only IBD focused commit so far is ZAP1 linked above, I'm still looking into utxo heap improvements which might be more interesting, as it is the # 1 allocator during IBD.",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-631823727,631823727,
DrahtBot,2020-06-18 13:19:18,<!--cf906140f33d8803c4a75a2196329ecb-->\nüêô This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).,https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-646012003,646012003,
jamesob,2021-09-20 22:26:20,"Sad to see this closed; I love the idea of exploring how we can reduce allocations in general since it seems like (in addition to any incidental performance benefits) fewer allocations probably makes behavior more predictable... although I guess while we might be able to reasonably preallocate certain things (coinsCache come to mind) others (the block index) might not be possible/desirable, so may",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-923388418,923388418,
JeremyRubin,2021-09-21 02:11:21,"it's generally really hard to get changes like this through; e.g. personally my epoch mempool stuff also has an aim to eliminate short lived allocations in many of the mempool algorithms but it is (from my perspective) stalled out for lack of sufficient review.\n\nIf big refactorings like ZAP or the Mempool Project are going to make the kind of headway you'd want to see they probably would need ",https://github.com/bitcoin/bitcoin/pull/18849#issuecomment-923529718,923529718,
elichai,2020-05-04 11:12:17,"what about returning a `std::array<unsigned char, 18>` instead?",https://github.com/bitcoin/bitcoin/pull/18849#discussion_r419362562,419362562,src/netaddress.cpp
jb55,2020-05-04 15:08:34,I think this makes more sense,https://github.com/bitcoin/bitcoin/pull/18849#discussion_r419508333,419508333,src/netaddress.cpp
jb55,2020-05-15 16:29:10,I decided against this for now since it would require me to implement a bunch of new Serialization machinery for std::array which I couldn't figure out how to do.,https://github.com/bitcoin/bitcoin/pull/18849#discussion_r425914672,425914672,src/netaddress.cpp
