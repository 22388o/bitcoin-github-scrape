[
  {
    "sha": "a92bf4af66f8b5a2e6bc28baa6670065ce76daf2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphOTJiZjRhZjY2ZjhiNWEyZTZiYzI4YmFhNjY3MDA2NWNlNzZkYWYy",
    "commit": {
      "author": {
        "name": "Matthew King",
        "email": "chohag@jtan.com",
        "date": "2016-06-28T06:35:41Z"
      },
      "committer": {
        "name": "Wladimir J. van der Laan",
        "email": "laanwj@gmail.com",
        "date": "2016-09-26T11:37:44Z"
      },
      "message": "bitcoind: Daemonize using daemon(3)\n\nSimplified version of #8278. Assumes that every OS that (a) is supported\nby Bitcoin Core (b) supports daemonization has the `daemon()` function\nin its C library.\n\n- Removes the fallback path for operating systems that support\n  daemonization but not `daemon()`. This prevents never-exercised code from\n  ending up in the repository (see discussion here:\n  https://github.com/bitcoin/bitcoin/pull/8278#issuecomment-242704745).\n\n- Removes the windows-specific path. Windows doesn't support `daemon()`,\n  so it don't support daemonization there, automatically.\n\nOriginal code by Matthew King, adapted by Wladimir van der Laan.",
      "tree": {
        "sha": "12861d870ab05cb735704705096f5b6f2e4b34f7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/12861d870ab05cb735704705096f5b6f2e4b34f7"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a92bf4af66f8b5a2e6bc28baa6670065ce76daf2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a92bf4af66f8b5a2e6bc28baa6670065ce76daf2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a92bf4af66f8b5a2e6bc28baa6670065ce76daf2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a92bf4af66f8b5a2e6bc28baa6670065ce76daf2/comments",
    "author": {
      "login": "ChoHag",
      "id": 139629,
      "node_id": "MDQ6VXNlcjEzOTYyOQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/139629?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ChoHag",
      "html_url": "https://github.com/ChoHag",
      "followers_url": "https://api.github.com/users/ChoHag/followers",
      "following_url": "https://api.github.com/users/ChoHag/following{/other_user}",
      "gists_url": "https://api.github.com/users/ChoHag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ChoHag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ChoHag/subscriptions",
      "organizations_url": "https://api.github.com/users/ChoHag/orgs",
      "repos_url": "https://api.github.com/users/ChoHag/repos",
      "events_url": "https://api.github.com/users/ChoHag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ChoHag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "37871f216e0d9463f456b8b014b80cc064011351",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/37871f216e0d9463f456b8b014b80cc064011351",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/37871f216e0d9463f456b8b014b80cc064011351"
      }
    ],
    "stats": {
      "total": 28,
      "additions": 12,
      "deletions": 16
    },
    "files": [
      {
        "sha": "e129b58461b7cfbe9a0677c371cf9b98c302a53f",
        "filename": "configure.ac",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a92bf4af66f8b5a2e6bc28baa6670065ce76daf2/configure.ac",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a92bf4af66f8b5a2e6bc28baa6670065ce76daf2/configure.ac",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/configure.ac?ref=a92bf4af66f8b5a2e6bc28baa6670065ce76daf2",
        "patch": "@@ -508,6 +508,9 @@ AC_SEARCH_LIBS([inet_pton], [nsl resolv], [AC_DEFINE(HAVE_INET_PTON, 1, [Define\n \n AC_CHECK_DECLS([strnlen])\n \n+# Check for daemon(3), unrelated to --with-daemon (although used by it)\n+AC_CHECK_DECLS([daemon])\n+\n AC_CHECK_DECLS([le16toh, le32toh, le64toh, htole16, htole32, htole64, be16toh, be32toh, be64toh, htobe16, htobe32, htobe64],,,\n \t\t[#if HAVE_ENDIAN_H\n                  #include <endian.h>"
      },
      {
        "sha": "25d720e1e8ccb61455f30c585c9f15aa5da40207",
        "filename": "src/bitcoind.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 15,
        "changes": 23,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a92bf4af66f8b5a2e6bc28baa6670065ce76daf2/src/bitcoind.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a92bf4af66f8b5a2e6bc28baa6670065ce76daf2/src/bitcoind.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bitcoind.cpp?ref=a92bf4af66f8b5a2e6bc28baa6670065ce76daf2",
        "patch": "@@ -9,6 +9,7 @@\n \n #include \"chainparams.h\"\n #include \"clientversion.h\"\n+#include \"compat.h\"\n #include \"rpc/server.h\"\n #include \"init.h\"\n #include \"noui.h\"\n@@ -127,29 +128,21 @@ bool AppInit(int argc, char* argv[])\n             fprintf(stderr, \"Error: There is no RPC client functionality in bitcoind anymore. Use the bitcoin-cli utility instead.\\n\");\n             exit(1);\n         }\n-#ifndef WIN32\n         if (GetBoolArg(\"-daemon\", false))\n         {\n+#if HAVE_DECL_DAEMON\n             fprintf(stdout, \"Bitcoin server starting\\n\");\n \n             // Daemonize\n-            pid_t pid = fork();\n-            if (pid < 0)\n-            {\n-                fprintf(stderr, \"Error: fork() returned %d errno %d\\n\", pid, errno);\n+            if (daemon(1, 0)) { // don't chdir (1), do close FDs (0)\n+                fprintf(stderr, \"Error: daemon() failed: %s\\n\", strerror(errno));\n                 return false;\n             }\n-            if (pid > 0) // Parent process, pid is child process id\n-            {\n-                return true;\n-            }\n-            // Child process falls through to rest of initialization\n-\n-            pid_t sid = setsid();\n-            if (sid < 0)\n-                fprintf(stderr, \"Error: setsid() returned %d errno %d\\n\", sid, errno);\n+#else\n+            fprintf(stderr, \"Error: -daemon is not supported on this operating system\\n\");\n+            return false;\n+#endif // HAVE_DECL_DAEMON\n         }\n-#endif\n         SoftSetBoolArg(\"-server\", true);\n \n         // Set this early so that parameter interactions go to console"
      },
      {
        "sha": "3c4466b8537597cbe99d3315dba2ddac79d9cffb",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a92bf4af66f8b5a2e6bc28baa6670065ce76daf2/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a92bf4af66f8b5a2e6bc28baa6670065ce76daf2/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=a92bf4af66f8b5a2e6bc28baa6670065ce76daf2",
        "patch": "@@ -324,7 +324,7 @@ std::string HelpMessage(HelpMessageMode mode)\n     strUsage += HelpMessageOpt(\"-conf=<file>\", strprintf(_(\"Specify configuration file (default: %s)\"), BITCOIN_CONF_FILENAME));\n     if (mode == HMM_BITCOIND)\n     {\n-#ifndef WIN32\n+#if HAVE_DECL_DAEMON\n         strUsage += HelpMessageOpt(\"-daemon\", _(\"Run in the background as a daemon and accept commands\"));\n #endif\n     }"
      }
    ]
  }
]