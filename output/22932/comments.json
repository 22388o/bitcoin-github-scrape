[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/917662835",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-917662835",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
    "id": 917662835,
    "node_id": "IC_kwDOABII5842smxz",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-12T16:00:46Z",
    "updated_at": "2021-11-27T10:50:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23581](https://github.com/bitcoin/bitcoin/pull/23581) (Move BlockManager to node/blockstorage by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/917662835/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/921206538",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-921206538",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
    "id": 921206538,
    "node_id": "IC_kwDOABII58426H8K",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-16T20:04:00Z",
    "updated_at": "2021-09-16T20:04:00Z",
    "author_association": "MEMBER",
    "body": "Rebased following the merge of #22895 that this was based on.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/921206538/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/921923502",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-921923502",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
    "id": 921923502,
    "node_id": "IC_kwDOABII584282-u",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-17T16:22:22Z",
    "updated_at": "2021-09-17T16:22:22Z",
    "author_association": "MEMBER",
    "body": "Thanks @MarcoFalke, updated with your suggestions per `git diff f6c2fdb e950f0e`\r\n\r\n<details><summary>diff</summary><p>\r\n\r\n```diff \r\ndiff --git a/src/test/util/blockfilter.cpp b/src/test/util/blockfilter.cpp\r\nindex 311913b5db..1a663bd0b3 100644\r\n--- a/src/test/util/blockfilter.cpp\r\n+++ b/src/test/util/blockfilter.cpp\r\n@@ -11,8 +11,10 @@\r\n \r\n bool ComputeFilter(BlockFilterType filter_type, const CBlockIndex* block_index, BlockFilter& filter)\r\n {\r\n+    LOCK(cs_main);\r\n+\r\n     CBlock block;\r\n-    if (!ReadBlockFromDisk(block, WITH_LOCK(cs_main, return block_index->GetBlockPos()), Params().GetConsensus())) {\r\n+    if (!ReadBlockFromDisk(block, block_index->GetBlockPos(), Params().GetConsensus())) {\r\n         return false;\r\n     }\r\n \r\ndiff --git a/src/wallet/test/wallet_tests.cpp b/src/wallet/test/wallet_tests.cpp\r\nindex 37fd52a5e7..4ac8936ee7 100644\r\n--- a/src/wallet/test/wallet_tests.cpp\r\n+++ b/src/wallet/test/wallet_tests.cpp\r\n@@ -86,8 +86,10 @@ BOOST_FIXTURE_TEST_CASE(scan_for_wallet_transactions, TestChain100Setup)\r\n {\r\n     // Cap last block file size, and mine new block in a new block file.\r\n     CBlockIndex* oldTip = m_node.chainman->ActiveChain().Tip();\r\n-    const auto pos{WITH_LOCK(cs_main, return oldTip->GetBlockPos())};\r\n-    GetBlockFileInfo(pos.nFile)->nSize = MAX_BLOCKFILE_SIZE;\r\n+    {\r\n+        LOCK(cs_main);\r\n+        GetBlockFileInfo(oldTip->GetBlockPos().nFile)->nSize = MAX_BLOCKFILE_SIZE;\r\n+    }\r\n     CreateAndProcessBlock({}, GetScriptForRawPubKey(coinbaseKey.GetPubKey()));\r\n     CBlockIndex* newTip = m_node.chainman->ActiveChain().Tip();\r\n```\r\n</p></details>\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/921923502/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/926175891",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-926175891",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
    "id": 926175891,
    "node_id": "IC_kwDOABII5843NFKT",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-23T21:29:53Z",
    "updated_at": "2021-09-23T21:29:53Z",
    "author_association": "MEMBER",
    "body": "Rebased after the merge of #21526.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/926175891/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/975378387",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-975378387",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
    "id": 975378387,
    "node_id": "IC_kwDOABII5846IxfT",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-22T10:29:26Z",
    "updated_at": "2021-11-22T10:29:26Z",
    "author_association": "MEMBER",
    "body": "Thank you for reviewing, @promag. Updated based on your feedback per `git diff 9cacc50 b1c859a`.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/975378387/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/981121451",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#issuecomment-981121451",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22932",
    "id": 981121451,
    "node_id": "IC_kwDOABII5846ermr",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?u=348c27f90b6fff8fd72fa27232272651436a2ff0&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-28T17:24:22Z",
    "updated_at": "2021-11-28T17:24:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hm, the description only says \"Potentially related to issue #17161.\", otherwise I don't really see a description of what problem this PR is actually fixing/improving?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/981121451/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710934432",
    "pull_request_review_id": 757300647,
    "id": 710934432,
    "node_id": "PRRC_kwDOABII584qX_-g",
    "diff_hunk": "@@ -212,7 +215,8 @@ class CBlockIndex\n     {\n     }\n \n-    FlatFilePos GetBlockPos() const {\n+    FlatFilePos GetBlockPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
    "path": "src/chain.h",
    "position": 31,
    "original_position": 22,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This is annotating the function, but not the underlying data member that needs the annotation.\r\n\r\nNot sure how involved it will be to annotate everything properly here. Also, given that cs_main is the validation lock, we should (eventually/ideally) have a separate node_storage lock. Though, this again requires a major validation/node_storage rewrite.\r\n\r\nHowever an argument against adding the lock annotation to the data member could be that `chain` is supposed to be a data-structure-only primitive, like `transaction` or `block`. In that case only annotating the getter and setter functions (and making them standalone) would seem appropriate.",
    "created_at": "2021-09-17T10:17:17Z",
    "updated_at": "2021-09-17T10:17:38Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r710934432",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710934432"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r710934432"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710934432/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 226,
    "original_line": 226,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710942005",
    "pull_request_review_id": 757310339,
    "id": 710942005,
    "node_id": "PRRC_kwDOABII584qYB01",
    "diff_hunk": "@@ -12,7 +12,7 @@\n bool ComputeFilter(BlockFilterType filter_type, const CBlockIndex* block_index, BlockFilter& filter)\n {\n     CBlock block;\n-    if (!ReadBlockFromDisk(block, block_index->GetBlockPos(), Params().GetConsensus())) {\n+    if (!ReadBlockFromDisk(block, WITH_LOCK(cs_main, return block_index->GetBlockPos()), Params().GetConsensus())) {",
    "path": "src/test/util/blockfilter.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: unit tests are single-threaded, so you can just take the lock for the whole function. It is likely that there are other lock violations anyway: See https://github.com/bitcoin/bitcoin/issues/17161#issuecomment-543151879",
    "created_at": "2021-09-17T10:29:40Z",
    "updated_at": "2021-09-17T10:29:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r710942005",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710942005"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r710942005"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710942005/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 15,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710942658",
    "pull_request_review_id": 757311214,
    "id": 710942658,
    "node_id": "PRRC_kwDOABII584qYB_C",
    "diff_hunk": "@@ -86,7 +86,8 @@ BOOST_FIXTURE_TEST_CASE(scan_for_wallet_transactions, TestChain100Setup)\n {\n     // Cap last block file size, and mine new block in a new block file.\n     CBlockIndex* oldTip = m_node.chainman->ActiveChain().Tip();\n-    GetBlockFileInfo(oldTip->GetBlockPos().nFile)->nSize = MAX_BLOCKFILE_SIZE;\n+    const auto pos{WITH_LOCK(cs_main, return oldTip->GetBlockPos())};\n+    GetBlockFileInfo(pos.nFile)->nSize = MAX_BLOCKFILE_SIZE;",
    "path": "src/wallet/test/wallet_tests.cpp",
    "position": null,
    "original_position": 6,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Same: Can include this in the cs_main scope as well, I think.",
    "created_at": "2021-09-17T10:30:50Z",
    "updated_at": "2021-09-17T10:30:50Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r710942658",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710942658"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r710942658"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710942658/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 90,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711181854",
    "pull_request_review_id": 757634219,
    "id": 711181854,
    "node_id": "PRRC_kwDOABII584qY8Ye",
    "diff_hunk": "@@ -12,7 +12,7 @@\n bool ComputeFilter(BlockFilterType filter_type, const CBlockIndex* block_index, BlockFilter& filter)\n {\n     CBlock block;\n-    if (!ReadBlockFromDisk(block, block_index->GetBlockPos(), Params().GetConsensus())) {\n+    if (!ReadBlockFromDisk(block, WITH_LOCK(cs_main, return block_index->GetBlockPos()), Params().GetConsensus())) {",
    "path": "src/test/util/blockfilter.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "done",
    "created_at": "2021-09-17T16:07:38Z",
    "updated_at": "2021-09-17T16:07:38Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711181854",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711181854"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711181854"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711181854/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 15,
    "side": "RIGHT",
    "in_reply_to_id": 710942005
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711187206",
    "pull_request_review_id": 757641366,
    "id": 711187206,
    "node_id": "PRRC_kwDOABII584qY9sG",
    "diff_hunk": "@@ -86,7 +86,8 @@ BOOST_FIXTURE_TEST_CASE(scan_for_wallet_transactions, TestChain100Setup)\n {\n     // Cap last block file size, and mine new block in a new block file.\n     CBlockIndex* oldTip = m_node.chainman->ActiveChain().Tip();\n-    GetBlockFileInfo(oldTip->GetBlockPos().nFile)->nSize = MAX_BLOCKFILE_SIZE;\n+    const auto pos{WITH_LOCK(cs_main, return oldTip->GetBlockPos())};\n+    GetBlockFileInfo(pos.nFile)->nSize = MAX_BLOCKFILE_SIZE;",
    "path": "src/wallet/test/wallet_tests.cpp",
    "position": null,
    "original_position": 6,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "done, thank you",
    "created_at": "2021-09-17T16:15:45Z",
    "updated_at": "2021-09-17T16:15:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711187206",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711187206"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711187206"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711187206/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 90,
    "side": "RIGHT",
    "in_reply_to_id": 710942658
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711201778",
    "pull_request_review_id": 757661010,
    "id": 711201778,
    "node_id": "PRRC_kwDOABII584qZBPy",
    "diff_hunk": "@@ -212,7 +215,8 @@ class CBlockIndex\n     {\n     }\n \n-    FlatFilePos GetBlockPos() const {\n+    FlatFilePos GetBlockPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
    "path": "src/chain.h",
    "position": 31,
    "original_position": 22,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Having a quick look at annotating `nStatus` to assess.",
    "created_at": "2021-09-17T16:38:02Z",
    "updated_at": "2021-09-17T16:38:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711201778",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711201778"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711201778"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711201778/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 226,
    "original_line": 226,
    "side": "RIGHT",
    "in_reply_to_id": 710934432
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711225765",
    "pull_request_review_id": 757693855,
    "id": 711225765,
    "node_id": "PRRC_kwDOABII584qZHGl",
    "diff_hunk": "@@ -212,7 +215,8 @@ class CBlockIndex\n     {\n     }\n \n-    FlatFilePos GetBlockPos() const {\n+    FlatFilePos GetBlockPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)",
    "path": "src/chain.h",
    "position": 31,
    "original_position": 22,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "f6c2fdb0a59d61e2e5d6a5f4d3a3760c777a36ab",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Appended a small commit to guard `CBlockIndex::nStatus` by `cs_main`.",
    "created_at": "2021-09-17T17:17:27Z",
    "updated_at": "2021-09-28T12:45:10Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711225765",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711225765"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r711225765"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711225765/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 226,
    "original_line": 226,
    "side": "RIGHT",
    "in_reply_to_id": 710934432
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241371",
    "pull_request_review_id": 781346727,
    "id": 730241371,
    "node_id": "PRRC_kwDOABII584rhplb",
    "diff_hunk": "@@ -220,7 +223,8 @@ class CBlockIndex\n     {\n     }\n \n-    FlatFilePos GetBlockPos() const {\n+    FlatFilePos GetBlockPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+    {",
    "path": "src/chain.h",
    "position": 32,
    "original_position": 23,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "e8cc6987f34d19f88de8c461af1efcdd8c3825ec",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "e8cc6987f34d19f88de8c461af1efcdd8c3825ec\r\n\r\nMissing\r\n```\r\nAssertLockHeld(cs_main);\r\n```",
    "created_at": "2021-10-16T09:59:01Z",
    "updated_at": "2021-10-16T10:10:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730241371",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241371"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730241371"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241371/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 227,
    "original_line": 227,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241402",
    "pull_request_review_id": 781346727,
    "id": 730241402,
    "node_id": "PRRC_kwDOABII584rhpl6",
    "diff_hunk": "@@ -233,7 +233,8 @@ class CBlockIndex\n         return ret;\n     }\n \n-    FlatFilePos GetUndoPos() const {\n+    FlatFilePos GetUndoPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+    {",
    "path": "src/chain.h",
    "position": 43,
    "original_position": 6,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "9bec673716e68b1854562e4e48a6cb26d8949a59",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "9bec673716e68b1854562e4e48a6cb26d8949a59\r\n\r\nMissing\r\n```\r\nAssertLockHeld(cs_main);\r\n```",
    "created_at": "2021-10-16T09:59:43Z",
    "updated_at": "2021-10-16T10:10:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730241402",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241402"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730241402"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241402/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 238,
    "original_line": 238,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241821",
    "pull_request_review_id": 781346727,
    "id": 730241821,
    "node_id": "PRRC_kwDOABII584rhpsd",
    "diff_hunk": "@@ -336,7 +337,7 @@ static bool WriteBlockToDisk(const CBlock& block, FlatFilePos& pos, const CMessa\n bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& state, CBlockIndex* pindex, const CChainParams& chainparams)\n {\n     // Write undo information to disk\n-    if (pindex->GetUndoPos().IsNull()) {\n+    if (WITH_LOCK(cs_main, return pindex->GetUndoPos()).IsNull()) {",
    "path": "src/node/blockstorage.cpp",
    "position": null,
    "original_position": 15,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "9bec673716e68b1854562e4e48a6cb26d8949a59",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "9bec673716e68b1854562e4e48a6cb26d8949a59\r\n\r\nWhy is this needed? `WriteUndoDataForBlock` is only called  from `CChainState::ConnectBlock` which already locks `cs_main`.",
    "created_at": "2021-10-16T10:03:11Z",
    "updated_at": "2021-10-16T10:10:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730241821",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241821"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730241821"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730241821/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 340,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730242048",
    "pull_request_review_id": 781346727,
    "id": 730242048,
    "node_id": "PRRC_kwDOABII584rhpwA",
    "diff_hunk": "@@ -355,9 +356,12 @@ bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& st\n         }\n \n         // update nUndoPos in block index\n-        pindex->nUndoPos = _pos.nPos;\n-        pindex->nStatus |= BLOCK_HAVE_UNDO;\n-        setDirtyBlockIndex.insert(pindex);\n+        {\n+            LOCK(cs_main);",
    "path": "src/node/blockstorage.cpp",
    "position": null,
    "original_position": 16,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0\r\n\r\nAgain, `cs_main` is already held here right?",
    "created_at": "2021-10-16T10:05:56Z",
    "updated_at": "2021-10-16T10:10:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730242048",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730242048"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730242048"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730242048/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 360,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730242273",
    "pull_request_review_id": 781346727,
    "id": 730242273,
    "node_id": "PRRC_kwDOABII584rhpzh",
    "diff_hunk": "@@ -196,7 +196,8 @@ static RPCHelpMan getrawtransaction()\n     if (!tx) {\n         std::string errmsg;\n         if (blockindex) {\n-            if (!(blockindex->nStatus & BLOCK_HAVE_DATA)) {\n+            const auto status{WITH_LOCK(cs_main, return blockindex->nStatus)};",
    "path": "src/rpc/rawtransaction.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0\r\n\r\nnit,\r\n```cpp\r\nconst bool block_have_data{WITH_LOCK(cs_main, return blockindex->nStatus & BLOCK_HAVE_DATA)};\r\n```",
    "created_at": "2021-10-16T10:08:03Z",
    "updated_at": "2021-10-16T10:10:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730242273",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730242273"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r730242273"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730242273/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753830643",
    "pull_request_review_id": 811946046,
    "id": 753830643,
    "node_id": "PRRC_kwDOABII584s7orz",
    "diff_hunk": "@@ -220,7 +223,8 @@ class CBlockIndex\n     {\n     }\n \n-    FlatFilePos GetBlockPos() const {\n+    FlatFilePos GetBlockPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+    {",
    "path": "src/chain.h",
    "position": 32,
    "original_position": 23,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "e8cc6987f34d19f88de8c461af1efcdd8c3825ec",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks @promag, done.",
    "created_at": "2021-11-21T17:26:46Z",
    "updated_at": "2021-11-21T17:26:46Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753830643",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753830643"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753830643"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753830643/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 227,
    "original_line": 227,
    "side": "RIGHT",
    "in_reply_to_id": 730241371
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753830745",
    "pull_request_review_id": 811946079,
    "id": 753830745,
    "node_id": "PRRC_kwDOABII584s7otZ",
    "diff_hunk": "@@ -233,7 +233,8 @@ class CBlockIndex\n         return ret;\n     }\n \n-    FlatFilePos GetUndoPos() const {\n+    FlatFilePos GetUndoPos() const EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+    {",
    "path": "src/chain.h",
    "position": 43,
    "original_position": 6,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "9bec673716e68b1854562e4e48a6cb26d8949a59",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done.",
    "created_at": "2021-11-21T17:27:09Z",
    "updated_at": "2021-11-21T17:27:09Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753830745",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753830745"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753830745"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753830745/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 238,
    "original_line": 238,
    "side": "RIGHT",
    "in_reply_to_id": 730241402
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753831056",
    "pull_request_review_id": 811946377,
    "id": 753831056,
    "node_id": "PRRC_kwDOABII584s7oyQ",
    "diff_hunk": "@@ -196,7 +196,8 @@ static RPCHelpMan getrawtransaction()\n     if (!tx) {\n         std::string errmsg;\n         if (blockindex) {\n-            if (!(blockindex->nStatus & BLOCK_HAVE_DATA)) {\n+            const auto status{WITH_LOCK(cs_main, return blockindex->nStatus)};",
    "path": "src/rpc/rawtransaction.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done.",
    "created_at": "2021-11-21T17:30:36Z",
    "updated_at": "2021-11-21T17:30:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753831056",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753831056"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753831056"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753831056/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT",
    "in_reply_to_id": 730242273
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753832096",
    "pull_request_review_id": 811947207,
    "id": 753832096,
    "node_id": "PRRC_kwDOABII584s7pCg",
    "diff_hunk": "@@ -336,7 +337,7 @@ static bool WriteBlockToDisk(const CBlock& block, FlatFilePos& pos, const CMessa\n bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& state, CBlockIndex* pindex, const CChainParams& chainparams)\n {\n     // Write undo information to disk\n-    if (pindex->GetUndoPos().IsNull()) {\n+    if (WITH_LOCK(cs_main, return pindex->GetUndoPos()).IsNull()) {",
    "path": "src/node/blockstorage.cpp",
    "position": null,
    "original_position": 15,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "9bec673716e68b1854562e4e48a6cb26d8949a59",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "@promag You're right; Clang 13 seems unable to detect this on its own, but the unneeded lock can be avoided by requiring `WriteUndoDataForBlock()` to hold cs_main instead. Done in  686ae2d97.",
    "created_at": "2021-11-21T17:39:51Z",
    "updated_at": "2021-11-21T17:39:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753832096",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753832096"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753832096"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753832096/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 340,
    "side": "RIGHT",
    "in_reply_to_id": 730241821
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753832294",
    "pull_request_review_id": 811947338,
    "id": 753832294,
    "node_id": "PRRC_kwDOABII584s7pFm",
    "diff_hunk": "@@ -355,9 +356,12 @@ bool WriteUndoDataForBlock(const CBlockUndo& blockundo, BlockValidationState& st\n         }\n \n         // update nUndoPos in block index\n-        pindex->nUndoPos = _pos.nPos;\n-        pindex->nStatus |= BLOCK_HAVE_UNDO;\n-        setDirtyBlockIndex.insert(pindex);\n+        {\n+            LOCK(cs_main);",
    "path": "src/node/blockstorage.cpp",
    "position": null,
    "original_position": 16,
    "commit_id": "b1c859abb790a1bbc9c31e3a535e36d1c59085b9",
    "original_commit_id": "9cacc50225f5d8990aeb4bd3cb6d03a18d776ff0",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks! Removed in both places in this function as described in https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753832096.",
    "created_at": "2021-11-21T17:41:29Z",
    "updated_at": "2021-11-21T17:41:29Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753832294",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753832294"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22932#discussion_r753832294"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22932"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753832294/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 360,
    "side": "RIGHT",
    "in_reply_to_id": 730242048
  }
]