[
  {
    "sha": "18f690ec2f7eb1b4aa51825bfed0cbfdadc93ac7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxOGY2OTBlYzJmN2ViMWI0YWE1MTgyNWJmZWQwY2JmZGFkYzkzYWM3",
    "commit": {
      "author": {
        "name": "Karl-Johan Alm",
        "email": "kalle.alm@gmail.com",
        "date": "2018-07-30T16:50:43Z"
      },
      "committer": {
        "name": "Karl-Johan Alm",
        "email": "karljohan-alm@garage.co.jp",
        "date": "2018-08-10T00:08:11Z"
      },
      "message": "wallet: shuffle coins before grouping, where warranted\n\nIssue brought up in https://github.com/bitcoin/bitcoin/pull/12257\\#discussion_r204554549",
      "tree": {
        "sha": "0cd81cdaa3965f017adcec94006dd14b3e7320d9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0cd81cdaa3965f017adcec94006dd14b3e7320d9"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/18f690ec2f7eb1b4aa51825bfed0cbfdadc93ac7",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEExCr/fGGz5EoUVM01V692LbM1MyIFAlts12sACgkQV692LbM1\nMyIpWQ//fy637cIThiq0o9qDelR4IOg/jEHSy5CKmIRHG1oRz41SZjPHtnjgQKH4\nxdTO1LMEuvr7RydK4WDRLLqV+pK0JNpkPErK8jCReM23VReCgsd2IR3a2G081v2c\n0DPVzwauLCY+aR4kO4zWLg7jRx395ZeRfJXUiYmi+bRDVEhntZK7OtwPzKAv6xsR\nM2VaB8x+ZiiALoRT8Ww8/Sv5X61Ok6VAQ1ooqsjP2ZosdMwn9gytPs/VjEKQ79jc\nT6Bl+E47LEzUe0qBQfQMkcDTqBHvKxM52eg+tHtowA54TvgdYWnN5RYOjtxDlqqz\nFR98etuj9PPyoUvNNWUQMaWQS6wlb3+9qwaYdU+ZBsv5vt0Z+krwp0fFH42m4PV6\nwN+2U999rGPLrfpFL5LmgzYjsKMrpaB3Pko1dKUiauOoIloaH5iznSOpdmmLOA4l\n7Ph43ItwdjS/jiKJakUNJACO1PapQ758b+/w9HItCpiSArq1zlJ7EfSKVYLwAqN1\nWRaCQeKUMNHroZXkxYRa+eko+vr/qfuWjgoVf5z2UricG1roe9x70OBvSWdKfEHD\nBbLEidL28HZn5D+NwMk0Q/tAgmsm4vs+yPq/nCsRPS9sz7o+jRD8JbZKEtcCCbu1\nrwev76vhqcXA0qUCsph37CR9OwlKQWyjzVdaYKxsEHYjbTxID14=\n=1kIF\n-----END PGP SIGNATURE-----",
        "payload": "tree 0cd81cdaa3965f017adcec94006dd14b3e7320d9\nparent f66e1c793eda7a6143fd03400c98512a9b6f00c7\nauthor Karl-Johan Alm <kalle.alm@gmail.com> 1532969443 +0900\ncommitter Karl-Johan Alm <karljohan-alm@garage.co.jp> 1533859691 +0900\n\nwallet: shuffle coins before grouping, where warranted\n\nIssue brought up in https://github.com/bitcoin/bitcoin/pull/12257\\#discussion_r204554549\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/18f690ec2f7eb1b4aa51825bfed0cbfdadc93ac7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/18f690ec2f7eb1b4aa51825bfed0cbfdadc93ac7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/18f690ec2f7eb1b4aa51825bfed0cbfdadc93ac7/comments",
    "author": {
      "login": "kallewoof",
      "id": 250224,
      "node_id": "MDQ6VXNlcjI1MDIyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/250224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kallewoof",
      "html_url": "https://github.com/kallewoof",
      "followers_url": "https://api.github.com/users/kallewoof/followers",
      "following_url": "https://api.github.com/users/kallewoof/following{/other_user}",
      "gists_url": "https://api.github.com/users/kallewoof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kallewoof/subscriptions",
      "organizations_url": "https://api.github.com/users/kallewoof/orgs",
      "repos_url": "https://api.github.com/users/kallewoof/repos",
      "events_url": "https://api.github.com/users/kallewoof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kallewoof/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "kallewoof",
      "id": 250224,
      "node_id": "MDQ6VXNlcjI1MDIyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/250224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kallewoof",
      "html_url": "https://github.com/kallewoof",
      "followers_url": "https://api.github.com/users/kallewoof/followers",
      "following_url": "https://api.github.com/users/kallewoof/following{/other_user}",
      "gists_url": "https://api.github.com/users/kallewoof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kallewoof/subscriptions",
      "organizations_url": "https://api.github.com/users/kallewoof/orgs",
      "repos_url": "https://api.github.com/users/kallewoof/repos",
      "events_url": "https://api.github.com/users/kallewoof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kallewoof/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f66e1c793eda7a6143fd03400c98512a9b6f00c7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f66e1c793eda7a6143fd03400c98512a9b6f00c7",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f66e1c793eda7a6143fd03400c98512a9b6f00c7"
      }
    ],
    "stats": {
      "total": 10,
      "additions": 9,
      "deletions": 1
    },
    "files": [
      {
        "sha": "73d2b205c20a6da9683ce0ab6b8995b4833adf7b",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 1,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/18f690ec2f7eb1b4aa51825bfed0cbfdadc93ac7/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/18f690ec2f7eb1b4aa51825bfed0cbfdadc93ac7/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=18f690ec2f7eb1b4aa51825bfed0cbfdadc93ac7",
        "patch": "@@ -35,6 +35,8 @@\n \n #include <boost/algorithm/string/replace.hpp>\n \n+static const size_t OUTPUT_GROUP_MAX_ENTRIES = 10;\n+\n static CCriticalSection cs_wallets;\n static std::vector<std::shared_ptr<CWallet>> vpwallets GUARDED_BY(cs_wallets);\n \n@@ -2525,6 +2527,12 @@ bool CWallet::SelectCoins(const std::vector<COutput>& vAvailableCoins, const CAm\n \n     // form groups from remaining coins; note that preset coins will not\n     // automatically have their associated (same address) coins included\n+    if (coin_control.m_avoid_partial_spends && vCoins.size() > OUTPUT_GROUP_MAX_ENTRIES) {\n+        // Cases where we have 11+ outputs all pointing to the same destination may result in\n+        // privacy leaks as they will potentially be deterministically sorted. We solve that by\n+        // explicitly shuffling the outputs before processing\n+        std::shuffle(vCoins.begin(), vCoins.end(), FastRandomContext());\n+    }\n     std::vector<OutputGroup> groups = GroupOutputs(vCoins, !coin_control.m_avoid_partial_spends);\n \n     size_t max_ancestors = (size_t)std::max<int64_t>(1, gArgs.GetArg(\"-limitancestorcount\", DEFAULT_ANCESTOR_LIMIT));\n@@ -4444,7 +4452,7 @@ std::vector<OutputGroup> CWallet::GroupOutputs(const std::vector<COutput>& outpu\n                 // Limit output groups to no more than 10 entries, to protect\n                 // against inadvertently creating a too-large transaction\n                 // when using -avoidpartialspends\n-                if (gmap[dst].m_outputs.size() >= 10) {\n+                if (gmap[dst].m_outputs.size() >= OUTPUT_GROUP_MAX_ENTRIES) {\n                     groups.push_back(gmap[dst]);\n                     gmap.erase(dst);\n                 }"
      }
    ]
  }
]