TheBlueMatt,2017-02-03T15:35:26Z,"I dont think we should be using an RC4-based stream cipher for our crypto random stuff. Possibly in conjunction with /dev/urandom and other sources, but not by itself. Given this is only used in conjunction with OpenSSL's rand, its likely fine, but I super dont trust OpenSSL's rand either, so I'd say NACK.",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-277278760,277278760,
laanwj,2017-02-03T16:13:48Z,"Please do not submit incomplete patches, certainly not one-liners. No one is just suddenly going to do your work for you, that's not how open source works, sorry.",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-277289741,277289741,
sipa,2017-02-03T17:38:26Z,"@TheBlueMatt The arc4random functioms are the way to obtain kernel\nrandomness in some (all?) BSDs, even though they've stopped using the RC4\nmethod internally.\n\nOP, you'll need to make your patch work though.\n",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-277311848,277311848,
TheBlueMatt,2017-02-03T18:43:49Z,"@sipa ahh, that was not at all clear to me from man pages I saw, thanks.",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-277327919,277327919,
mlmikael,2017-02-04T03:02:17Z,"Hi, sorry for the incomplete patch, will fix that.\n\narc4random() is the primary randomness interface on OpenBSD and all programs use it for everything.\n\nI submitted this so that BitcoinD will function even if there's no ""/dev/urandom"" device. BitcoinD's current behavior is to terminate if that device not exists, which is a disaster as there are situations when it's totally untrivial or/and",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-277413837,277413837,
sipa,2017-02-04T03:13:41Z,"> Also, why depend on the device's existence when it's technically unnecessary in the first place\n\nWe're relying on the availability of strong randomness, and won't run without. I'm perfectly fine with using a specific kernel interface instead of /dev/random if that's available.",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-277414501,277414501,
mlmikael,2017-02-04T03:34:26Z,"Great. Before crafting the patch: Do you guys prefer that arc4random is used on all platforms where it's supported, or specifically on OpenBSD?\n\nAs soon as that has been clarified, we just need to ensure that a properly scoped define is in the code, and then commit the code patch I suggested (but depending on the proper define), that's all.",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-277415533,277415533,
mlmikael,2017-02-04T04:04:29Z,"One approach here would be to use arc4random() on any arc4random-supported platform, as failover when /dev/urandom not is existent. That would make the risk profile in BitcoinD's entropy sampling unnecessarily complex though.\n\narc4random seems to not be solid since long on other platforms than OpenBSD, so that would be FreeBSD and Mac OS X.\n\nFor that reason, for the time being, and for the",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-277416996,277416996,
laanwj,2017-02-06T11:02:33Z,@theuni could you comment on the build system question ^^,https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-277650424,277650424,
theuni,2017-02-06T22:17:00Z,"@mlmikael Generally we don't run platform-specific tests, rather we run feature-tests. That way if another platform just happens to implement the thing, it will just work without us having to keep up with a list.\n\nSee the check for MSG_NOSIGNAL in configure.ac for example.\n\nYou'll want to do something like:\n```bash\nAC_MSG_CHECKING(for arc4random)\nAC_COMPILE_IFELSE([AC_LANG_PROGRAM([[",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-277832142,277832142,
mlmikael,2017-02-07T01:27:10Z,"@theuni , noted and understood the parts about how to bring in the HAVE_ARC4RANDOM define.\n\nThe finishing part ""All that ignores the ""should we"" part. I'm not sure if we actually want to use it unconditionally if it's found, in this case, we might actually want it whitelisted to certain platforms."", do you mean that we also should make a ""TARGET_OPENBSD"" DEFINE or alike as a way to whitelist O",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-277872200,277872200,
pstratem,2017-02-07T01:45:05Z,"@theuni im not sure there's anyway to do a proper feature test here, arc4random is no longer arc4 on openbsd and other systems which implement it; however it was at one point so the feature test would have to be for a secure arc4random implementation and not just arc4random",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-277875228,277875228,
laanwj,2017-02-07T14:10:07Z,">  arc4random is no longer arc4 on openbsd and other systems which implement it\n\nSo we only want ""non-arc4 that's called arc4random"". That's horribly confusing, and sounds like a really dangerous situation for something this critical. \n\n> Depending on how good entropy GetOSRand() needs, the arc4random() could either be used exclusively on all platforms where it's implemented, or, it could ",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-278010165,278010165,
laanwj,2017-02-07T15:29:36Z,I've [read about this a bit](https://lwn.net/Articles/625506/) deeper: `arc4random` as a kernel-supported cryptographic randomness source is indeed *OpenBSD specific*. Internally it uses the [getentropy(2)](http://man.openbsd.org/cgi-bin/man.cgi/OpenBSD-current/man2/getentropy.2?query=getentropy%26sec=2) system call (which we could also use directly. It is also available on [solaris](https://blogs,https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-278034695,278034695,
mlmikael,2017-02-09T10:33:27Z,"I guess it would make sense to make arc4random use OpenBSD-specific. What do you think?\n\nIn that case, we need some define for #ifdef-ing the OpenBSD target. @theuni and others, how do you suggest we do this, introduce a TARGET_OPENBSD define?? (e.g. here https://github.com/bitcoin/bitcoin/blob/be31a2b3635b893930c731a2929bb593dae9847e/configure.ac#L382 )",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-278604775,278604775,
mlmikael,2017-02-10T09:23:24Z,"https://download.libsodium.org/doc/generating_random_data/ shows how LibSodium does it:\n\n""On Windows systems, the RtlGenRandom() function is used\nOn OpenBSD and Bitrig, the arc4random() function is used\nOn recent Linux kernels, the getrandom system call is used (since Sodium 1.0.3)\nOn other Unices, the /dev/urandom device is used""\n\nPerhaps this behavior can be borrowed.\n",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-278896061,278896061,
theuni,2017-02-10T18:46:53Z,"@mlmikael Rather than worrying about the platform in the code, we can just do the feature-check for known-supported platforms. So you could insert the check i pasted above, but inside the ""\*openbsd\*)"" case that you linked to.\n\nOr if it's really guaranteed to be there, we could just skip the check and unconditionally ```AC_DEFINE(HAVE_ARC4RANDOM)``` there.\n\nThat way we still only have to ",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-279030778,279030778,
mlmikael,2017-02-11T03:10:43Z,"@theuni , arc4random is guaranteed to be there and provide excellent entropy on OpenBSD, see https://www.openbsd.org/papers/hackfest2014-arc4random/index.html . OpenBSD reads arc4random ""A-Replacement Call For(4) /dev/Random"".\n\nMaybe we should call it ""HAVE_HIGHENTROPY_ARC4RANDOM"" or ""HAVE_GOOD_ARC4RANDOM"" or perhaps simply ""TARGET_OPENBSD""?\n\nAnd define that under ""*openbsd*)"". (If any ver",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-279116792,279116792,
laanwj,2017-02-11T07:33:37Z,"Edit: misunderstood @theuni, he got this correct.",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-279127687,279127687,
mlmikael,2017-02-11T07:38:34Z,"(@laanwj @theuni , Bitrig is an OpenBSD derivate so I think Bitrig trigs the ""*openbsd*)"" section in configure.ac too. So, any OpenBSD-specific treatment we add will supposedly automatically also cover Bitrig.)",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-279127872,279127872,
mlmikael,2017-02-21T04:25:51Z,"@theuni and everyone, bump! -\n\nSo: How do we add a DEFINE that's unique to OpenBSD (and hence by implication to Bitrig)?\n\nThat's what we need to do to be able to add an #elif-something for the arc4random usecase.\n\nhttps://github.com/bitcoin/bitcoin/blob/be31a2b3635b893930c731a2929bb593dae9847e/configure.ac#L382 this is a good place to add that define. So we'll add an AC_DEFINE(somethin",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-281242255,281242255,
laanwj,2017-02-21T15:41:05Z,"We actually discussed this last IRC meeting. The preference would be to bypass arc4random (which as discussed above is a risk on some platforms), and to use the syscalls directly when available to get randomness directly from the kernel. `GetOSRandom` could use:\n\n- `getrandom(buf, buflen, 0)` on Linux\n- `getentropy(buf, buflen)` on OpenBSD\n- `sysctl(KERN_ARND)` on FreeBSD and NetBSD\n\nO",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-281380892,281380892,
mlmikael,2017-02-21T15:45:58Z,"Neat!\n\nSo checks for getrandom() and getentropy() will be added, e.g. under the define names HAVE_GETRANDOM and HAVE_GETENTROPY .\n\nWho will implement this? This is beyond my automake/configure.ac skills, maybe @theuni can do it.",https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-281382445,281382445,
laanwj,2017-02-21T15:51:52Z,I'll can have a try at this. I have all those OSes available anyway.,https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-281384340,281384340,
laanwj,2017-02-21T20:08:26Z,@mlmikael see  #9821,https://github.com/bitcoin/bitcoin/pull/9677#issuecomment-281464706,281464706,
