practicalswift,2018-03-15T14:12:56Z,"Good catch! Concept ACK\n\nJust wanted to add that I've noticed a lot of high quality contributions from you recently. Really nice to have you on board! Thanks for your contributions!",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-373389434,373389434,
eklitzke,2018-03-16T18:50:03Z,"Question: do we want to have conditional logic based on GCC vs. Clang, or just do what's best for GCC (as long as it doesn't break Clang)? It seems like if we want to have the best symbols for both we need some additional logic here.\n\nGCC:\n * Recommends you use -Og\n * Says that -g3 includes macro definitions in the debug symbols (the only difference from -g2, which is the default when usin",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-373810555,373810555,
eklitzke,2018-03-16T18:58:57Z,"Also FYI later I plan to submit another PR for you to review to clean up the logic we have to start using more of the newer AX_* macros, most notably AX_APPEND_COMPILE_FLAGS which will clean up a lot of copy/paste logic we have when we check a flag and then append it.[1] I'm going to do that as another PR because I want to separate changes that affect logic (like this PR) with changes that are jus",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-373813075,373813075,
eklitzke,2018-03-16T19:30:54Z,"Summary of recent commits:\n * 0014486f25cfc628d79939f55adb6e020fbf0173 changes you suggested\n * b59e74db3e013a3551ef8d2df889fe26ea2d0a3c make the summary at the end of configure show all the flags we're actually using\n * ed6066b055ca5d024738214a16c91be9cad5c54d proposed way for adding different flags in clang (not sure if you think adding this kind of logic is appropriate or not, just an ide",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-373821394,373821394,
theuni,2018-03-20T19:58:56Z,"Nice investigative work above! \n\nGenerally we don't want to make any assumptions about what compiler will be used, unless an option is known to directly conflict between common ones. I don't think that's the case here. The code also builds fine with msvc, and I'd hope that icc works as well.\n\nSo checks like this really don't make much sense because they're basically just hard-coded:\n```b",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-374736165,374736165,
eklitzke,2018-03-20T21:35:08Z,"Changes here:\n * Remove the GCC/Clang check\n * Try -Og, fall back to -O0\n * Try -g3, fall back to -g\n * Pass in debug/error flags when doing the _FORTIFY_SOURCE check\n\nThere's one other change here that I would like @luke-jr to review. In 9b4e03b27b04f6dc687409a13859d59bb7909d8f he added logic to first try to undefined the flag before setting it. Since we now pass in the debug/error fl",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-374764927,374764927,
theuni,2018-03-20T22:42:38Z,"Thanks, looks good to me now other than the FORTIFY reversal.\n\n> Also note that the _FORTIFY_SOURCE change is a lot less necessary in the first place now since the original error was related to -O0, and we're now preferring -Og (and the warning was a GCC thing in the first place). We could just drop the _FORTIFY_SOURCE change altogether since the logic is a bit confusing; that said, the new lo",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-374782218,374782218,
eklitzke,2018-03-20T23:06:12Z,"Reverted the change to _FORTIFY_SOURCE, now the only difference in that part of the file compared to master is that we pass in debug and error flags when making the check. If this looks OK I can squash the branch down.",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-374787359,374787359,
eklitzke,2018-03-20T23:08:59Z,Hmm it appears the extra flags are supposed to be CPPFLAGS not CFLAGS/CXXFLAGS according to [the m4 macro](https://github.com/bitcoin/bitcoin/blob/master/build-aux/m4/ax_check_preproc_flag.m4). So maybe there's no point in passing in the flags at all there. Kind of a bummer since that means it doesn't catch the interaction with `-O0`.,https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-374787939,374787939,
eklitzke,2018-03-20T23:15:44Z,"Removed the _FORTIFY_SOURCE changes altogether since the new check isn't effective. The only reason I wanted to change it in the first place was because it interacted poorly with -O0, and on the platforms that generates warnings on we no longer expect to see warnings.",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-374789385,374789385,
eklitzke,2018-03-20T23:31:20Z,"One more thing I might as well ask while we're making this change, since I touched this line of code anyway. At the top of `src/Makefile.am` we have:\n```\nAM_LDFLAGS = $(PTHREAD_CFLAGS) $(LIBTOOL_LDFLAGS) $(HARDENED_LDFLAGS) $(GPROF_LDFLAGS)\n```\n\nWe don't set `LIBTOOL_LDFLAGS` anywhere, but we do set `LIBTOOL_APP_LDFLAGS` in `configure.ac` and then add to it `LDFLAGS` all over the place t",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-374792521,374792521,
theuni,2018-03-20T23:38:55Z,"> Hmm it appears the extra flags are supposed to be CPPFLAGS not CFLAGS/CXXFLAGS according to the m4 macro\n\nNot sure what you mean by that. The flags passed in are appended to CPPFLAGS for the test, it doesn't matter how they're stored otherwise.\n\nI agree with just leaving it alone, though.",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-374793941,374793941,
theuni,2018-03-20T23:48:26Z,"> We don't set LIBTOOL_LDFLAGS anywhere, but we do set LIBTOOL_APP_LDFLAGS in configure.ac and then add to it LDFLAGS all over the place to executables we build. It seems like this was originally a typo and the original intention was to add LIBTOOL_APP_LDFLAGS to AM_LDFLAGS.\n\n> The current code works but we might want to fix this (perhaps in another PR).\n\nYes, it looks like LIBTOOL_LDFLAGS",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-374795613,374795613,
eklitzke,2018-03-21T00:46:53Z,"I think that last test failure was Travis being flaky, b0860d8e82041786b3424851b42a8b8c5bc143e8 squashes all of these changes down.",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-374805340,374805340,
ryanofsky,2018-03-22T14:08:25Z,"PR description https://github.com/bitcoin/bitcoin/pull/12695#issue-175233065 should be updated to match commit description, since it seems out of date now.",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-375318719,375318719,
eklitzke,2018-03-27T03:27:58Z,"Updated the configure summary at the end, and changed PR description.",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-376385038,376385038,
eklitzke,2018-03-27T03:52:44Z,"Note the summary list gets formatted kind of weird with extra/leading spaces when options aren't enabled, e.g. `./configure` with no other options prints a summary like this for me:\n\n```\n  CC            = /usr/bin/ccache gcc\n  CFLAGS        = -g -O2\n  CPPFLAGS      =   -U_FORTIFY_SOURCE -D_FORTIFY_SOURCE=2  -DHAVE_BUILD_INFO -D__STDC_FORMAT_MACROS\n  CXX           = /usr/bin/ccache g++ ",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-376388592,376388592,
theuni,2018-03-28T20:51:19Z,I think switching to AX_APPEND_FLAG / AX_APPEND_COMPILE_FLAGS takes care of the whitespace problem more elegantly?,https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-377032058,377032058,
eklitzke,2018-03-29T00:00:04Z,"That's a good point, AX_APPEND_FLAG does in fact do the right thing wrt whitespace and feels a lot less hacky. We can let the output be a little untidy for now, I've got a 12 hour flight coming up in a few days and I might try to see if I can get AX_APPEND_FLAG and AX_APPEND_COMPILE_FLAGS working then.\n\nThanks for your patience reviewing this!",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-377077197,377077197,
theuni,2018-03-29T17:49:47Z,"No problem, thanks for sticking with it!\n\nThe flags change sounds like the perfect thing to fill some idle flight time :)\n\nThough, I think AX_APPEND_FLAG alone is probably enough. configure.ac is already so cryptic, it's helpful for self-documentation to explicitly use CXXFLAGS rather than having it implied.",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-377317666,377317666,
laanwj,2018-03-29T21:52:28Z,"utACK - needs rebase though (probably due to your own commit, 6feb46c :).",https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-377383848,377383848,
fanquake,2018-04-17T08:52:50Z,Rebased in #13005.,https://github.com/bitcoin/bitcoin/pull/12695#issuecomment-381906487,381906487,
theuni,2018-03-20T19:55:35Z,This should be automatically detected where necessary (where it would otherwise be warning) if we turn warnings into errors by passing $CXXFLAG_WERROR as the last argument to AX_CHECK_PREPROC_FLAG.,https://github.com/bitcoin/bitcoin/pull/12695#discussion_r175902247,175902247,configure.ac
eklitzke,2018-03-20T20:53:41Z,"Clever, good idea.",https://github.com/bitcoin/bitcoin/pull/12695#discussion_r175918743,175918743,configure.ac
theuni,2018-03-20T22:38:57Z,"I'd rather not reverse this logic as it now completely depends on -Werror working as intended. If some compiler fails to warn about the redefine, we'd get the wrong behavior here.\n\nWith the current logic, we always undefine and redefine as long as the options work individually.",https://github.com/bitcoin/bitcoin/pull/12695#discussion_r175944795,175944795,configure.ac
eklitzke,2018-03-20T23:01:52Z,"OK, will undo this.",https://github.com/bitcoin/bitcoin/pull/12695#discussion_r175949177,175949177,configure.ac
ryanofsky,2018-03-22T13:37:02Z,"Should this line include $(ERROR_CXXFLAGS) and $(GPROF_CXXFLAGS) as well? Maybe this section of `configure.ac` should include comments to stay in sync with the AM_CXXFLAGS and AM_LDFLAGS lines from `Makefile.am`. \n\nCould also consider combining the flags into a variable that is used both places.",https://github.com/bitcoin/bitcoin/pull/12695#discussion_r176421152,176421152,configure.ac
ryanofsky,2018-03-22T13:55:33Z,"Maybe move this `enable_debug` section up two lines up, above the CXXFLAG_WERROR line. I realise you didn't add this section here, but it is rewritten now, and seems out of place in the middle of the checks for compiler warning flags.",https://github.com/bitcoin/bitcoin/pull/12695#discussion_r176427513,176427513,configure.ac
ryanofsky,2018-03-22T13:57:46Z,"Maybe add a comment here if passing if `$CXXFLAG_WERROR` is intentional, or consider dropping it. It seem like it makes these checks unnecessarily verbose and also fragile.",https://github.com/bitcoin/bitcoin/pull/12695#discussion_r176428273,176428273,configure.ac
ryanofsky,2018-03-22T14:03:14Z,"CPPFLAGS and CXXFLAGS should probably be printed after the other flags instead of before, since they will override them.",https://github.com/bitcoin/bitcoin/pull/12695#discussion_r176430361,176430361,configure.ac
theuni,2018-03-22T17:42:04Z,It's passed on purpose to turn -D_FORTIFY re-definition warnings into errors.,https://github.com/bitcoin/bitcoin/pull/12695#discussion_r176511135,176511135,configure.ac
theuni,2018-03-22T17:44:10Z,Agreed. I haven't complained about this becoming stale because it seemed inevitable that it would be non-exact due to the per-object and per-library flags. But keeping it in sync with AM_*FLAGS makes sense.,https://github.com/bitcoin/bitcoin/pull/12695#discussion_r176511901,176511901,configure.ac
theuni,2018-03-22T17:46:15Z,"enable_debug uses CXXFLAG_WERROR, so it needs to be below the definition.",https://github.com/bitcoin/bitcoin/pull/12695#discussion_r176512723,176512723,configure.ac
eklitzke,2018-03-27T03:19:43Z,"Updated. What about something like:\n\n```bash\nDEFAULT_AM_CXXFLAGS=""$CXXFLAGS $DEBUG_CXXFLAGS etc...""\nAC_SUBST(DEFAULT_AM_CXXFLAGS)\n# and likewise for the other vars\n```\n\nThen the configure script could print that variable, and it could be re-used in src/Makefile.am. Seems like it would be less likely to get out of sync that wya.\n",https://github.com/bitcoin/bitcoin/pull/12695#discussion_r177296716,177296716,configure.ac
eklitzke,2018-03-27T03:20:27Z,updated,https://github.com/bitcoin/bitcoin/pull/12695#discussion_r177296784,177296784,configure.ac
luke-jr,2018-03-29T17:52:15Z,I wonder if it should prefer `-ggdb` first...,https://github.com/bitcoin/bitcoin/pull/12695#discussion_r178133926,178133926,configure.ac
luke-jr,2018-03-29T17:54:01Z,Why would we want an error in that case?,https://github.com/bitcoin/bitcoin/pull/12695#discussion_r178134425,178134425,configure.ac
theuni,2018-03-29T20:22:03Z,"@luke-jr Sorry, that was the explanation for a different change.\n\n-D_FORTIFY has incompatibilities with -O0, and many toolchains forcibly set _FORTIFY. Newer glibc versions spew a warning in that case, which we want to catch here because it means that -O0 is unusable without unsetting _FORTIFY.\n\nOf course, there's the case to be made that --enable-debug and --enable-harden should be mutual",https://github.com/bitcoin/bitcoin/pull/12695#discussion_r178170982,178170982,configure.ac
theuni,2018-03-29T20:25:12Z,"Why not -glldb ? :)\n\nSince we can't anticipate, I think generic makes the most sense.\n",https://github.com/bitcoin/bitcoin/pull/12695#discussion_r178171778,178171778,configure.ac
laanwj,2018-03-29T21:53:19Z,"Right, that kind of option makes more sense to pass in manually if you need it.",https://github.com/bitcoin/bitcoin/pull/12695#discussion_r178191604,178191604,configure.ac
