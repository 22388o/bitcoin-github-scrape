[
  {
    "sha": "9aea601b05b3541fcc7e0c45cba8fd2178224809",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5YWVhNjAxYjA1YjM1NDFmY2M3ZTBjNDVjYmE4ZmQyMTc4MjI0ODA5",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "sipa@ulyssis.org",
        "date": "2013-09-23T22:45:18Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "sipa@ulyssis.org",
        "date": "2014-02-11T19:38:23Z"
      },
      "message": "Move IsPushOnly() to script.cpp",
      "tree": {
        "sha": "539e6ff08c7000b71cdbaaf93a5e68521bce463c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/539e6ff08c7000b71cdbaaf93a5e68521bce463c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9aea601b05b3541fcc7e0c45cba8fd2178224809",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9aea601b05b3541fcc7e0c45cba8fd2178224809",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/9aea601b05b3541fcc7e0c45cba8fd2178224809",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9aea601b05b3541fcc7e0c45cba8fd2178224809/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "d5fa3eff03b4e58fc46d72599904231408cbce80",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d5fa3eff03b4e58fc46d72599904231408cbce80",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/d5fa3eff03b4e58fc46d72599904231408cbce80"
      }
    ],
    "stats": {
      "total": 36,
      "additions": 19,
      "deletions": 17
    },
    "files": [
      {
        "sha": "b2d8a67f969fdf24404464892ba047a797973735",
        "filename": "src/script.cpp",
        "status": "modified",
        "additions": 18,
        "deletions": 0,
        "changes": 18,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9aea601b05b3541fcc7e0c45cba8fd2178224809/src/script.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9aea601b05b3541fcc7e0c45cba8fd2178224809/src/script.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script.cpp?ref=9aea601b05b3541fcc7e0c45cba8fd2178224809",
        "patch": "@@ -1863,6 +1863,24 @@ bool CScript::IsPayToScriptHash() const\n             this->at(22) == OP_EQUAL);\n }\n \n+bool CScript::IsPushOnly() const\n+{\n+    const_iterator pc = begin();\n+    while (pc < end())\n+    {\n+        opcodetype opcode;\n+        if (!GetOp(pc, opcode))\n+            return false;\n+        // Note that IsPushOnly() *does* consider OP_RESERVED to be a\n+        // push-type opcode, however execution of OP_RESERVED fails, so\n+        // it's not relevant to P2SH as the scriptSig would fail prior to\n+        // the P2SH special validation code being executed.\n+        if (opcode > OP_16)\n+            return false;\n+    }\n+    return true;\n+}\n+\n class CScriptVisitor : public boost::static_visitor<bool>\n {\n private:"
      },
      {
        "sha": "a0a6cd1c4499ac0528d6ba813b9edab4ce6075b3",
        "filename": "src/script.h",
        "status": "modified",
        "additions": 1,
        "deletions": 17,
        "changes": 18,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9aea601b05b3541fcc7e0c45cba8fd2178224809/src/script.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9aea601b05b3541fcc7e0c45cba8fd2178224809/src/script.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script.h?ref=9aea601b05b3541fcc7e0c45cba8fd2178224809",
        "patch": "@@ -542,23 +542,7 @@ class CScript : public std::vector<unsigned char>\n     bool IsPayToScriptHash() const;\n \n     // Called by IsStandardTx\n-    bool IsPushOnly() const\n-    {\n-        const_iterator pc = begin();\n-        while (pc < end())\n-        {\n-            opcodetype opcode;\n-            if (!GetOp(pc, opcode))\n-                return false;\n-            // Note that IsPushOnly() *does* consider OP_RESERVED to be a\n-            // push-type opcode, however execution of OP_RESERVED fails, so\n-            // it's not relevant to P2SH as the scriptSig would fail prior to\n-            // the P2SH special validation code being executed.\n-            if (opcode > OP_16)\n-                return false;\n-        }\n-        return true;\n-    }\n+    bool IsPushOnly() const;\n \n     // Returns whether the script is guaranteed to fail at execution,\n     // regardless of the initial stack. This allows outputs to be pruned"
      }
    ]
  },
  {
    "sha": "87fe71e1fc810ee120a10063fdd26c3245686d54",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4N2ZlNzFlMWZjODEwZWUxMjBhMTAwNjNmZGQyNmMzMjQ1Njg2ZDU0",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-09-23T22:48:00Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "sipa@ulyssis.org",
        "date": "2014-02-11T20:11:59Z"
      },
      "message": "Add HasCanonicalPushes(), and use it in IsStandardTx",
      "tree": {
        "sha": "193f73d99ddbd70a67b5aafdcf353174f2cf4a96",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/193f73d99ddbd70a67b5aafdcf353174f2cf4a96"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/87fe71e1fc810ee120a10063fdd26c3245686d54",
      "comment_count": 1,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/87fe71e1fc810ee120a10063fdd26c3245686d54",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/87fe71e1fc810ee120a10063fdd26c3245686d54",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/87fe71e1fc810ee120a10063fdd26c3245686d54/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "9aea601b05b3541fcc7e0c45cba8fd2178224809",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9aea601b05b3541fcc7e0c45cba8fd2178224809",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/9aea601b05b3541fcc7e0c45cba8fd2178224809"
      }
    ],
    "stats": {
      "total": 54,
      "additions": 53,
      "deletions": 1
    },
    "files": [
      {
        "sha": "1df9a24d552581859c43a31a8ff5a109feb71db6",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/87fe71e1fc810ee120a10063fdd26c3245686d54/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/87fe71e1fc810ee120a10063fdd26c3245686d54/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=87fe71e1fc810ee120a10063fdd26c3245686d54",
        "patch": "@@ -442,6 +442,10 @@ bool IsStandardTx(const CTransaction& tx, string& reason)\n             reason = \"scriptsig-not-pushonly\";\n             return false;\n         }\n+        if (!txin.scriptSig.HasCanonicalPushes()) {\n+            reason = \"non-canonical-push\";\n+            return false;\n+        }\n     }\n \n     unsigned int nDataOut = 0;"
      },
      {
        "sha": "83fc91956cf2f4acb1e47167d7d02c70ae1a5245",
        "filename": "src/script.cpp",
        "status": "modified",
        "additions": 27,
        "deletions": 0,
        "changes": 27,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/87fe71e1fc810ee120a10063fdd26c3245686d54/src/script.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/87fe71e1fc810ee120a10063fdd26c3245686d54/src/script.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script.cpp?ref=87fe71e1fc810ee120a10063fdd26c3245686d54",
        "patch": "@@ -1881,6 +1881,33 @@ bool CScript::IsPushOnly() const\n     return true;\n }\n \n+bool CScript::HasCanonicalPushes() const\n+{\n+    const_iterator pc = begin();\n+    while (pc < end())\n+    {\n+        opcodetype opcode;\n+        std::vector<unsigned char> data;\n+        if (!GetOp(pc, opcode, data))\n+            return false;\n+        if (opcode > OP_16)\n+            continue;\n+        if (opcode < OP_PUSHDATA1 && opcode > OP_0 && (data.size() == 1 && data[0] <= 16))\n+            // Could have used an OP_n code, rather than a 1-byte push.\n+            return false;\n+        if (opcode == OP_PUSHDATA1 && data.size() < OP_PUSHDATA1)\n+            // Could have used a normal n-byte push, rather than OP_PUSHDATA1.\n+            return false;\n+        if (opcode == OP_PUSHDATA2 && data.size() <= 0xFF)\n+            // Could have used an OP_PUSHDATA1.\n+            return false;\n+        if (opcode == OP_PUSHDATA4 && data.size() <= 0xFFFF)\n+            // Could have used an OP_PUSHDATA2.\n+            return false;\n+    }\n+    return true;\n+}\n+\n class CScriptVisitor : public boost::static_visitor<bool>\n {\n private:"
      },
      {
        "sha": "335ddfb1b230bec563c18709adb6d05dae94b441",
        "filename": "src/script.h",
        "status": "modified",
        "additions": 4,
        "deletions": 1,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/87fe71e1fc810ee120a10063fdd26c3245686d54/src/script.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/87fe71e1fc810ee120a10063fdd26c3245686d54/src/script.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script.h?ref=87fe71e1fc810ee120a10063fdd26c3245686d54",
        "patch": "@@ -541,9 +541,12 @@ class CScript : public std::vector<unsigned char>\n \n     bool IsPayToScriptHash() const;\n \n-    // Called by IsStandardTx\n+    // Called by IsStandardTx and P2SH VerifyScript (which makes it consensus-critical).\n     bool IsPushOnly() const;\n \n+    // Called by IsStandardTx.\n+    bool HasCanonicalPushes() const;\n+\n     // Returns whether the script is guaranteed to fail at execution,\n     // regardless of the initial stack. This allows outputs to be pruned\n     // instantly when entering the UTXO set."
      },
      {
        "sha": "dd1b61304773b4be136b5677048d432ce874ae4f",
        "filename": "src/test/script_tests.cpp",
        "status": "modified",
        "additions": 18,
        "deletions": 0,
        "changes": 18,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/87fe71e1fc810ee120a10063fdd26c3245686d54/src/test/script_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/87fe71e1fc810ee120a10063fdd26c3245686d54/src/test/script_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/script_tests.cpp?ref=87fe71e1fc810ee120a10063fdd26c3245686d54",
        "patch": "@@ -438,4 +438,22 @@ BOOST_AUTO_TEST_CASE(script_combineSigs)\n     BOOST_CHECK(combined == partial3c);\n }\n \n+BOOST_AUTO_TEST_CASE(script_standard_push)\n+{\n+    for (int i=0; i<1000; i++) {\n+        CScript script;\n+        script << i;\n+        BOOST_CHECK_MESSAGE(script.IsPushOnly(), \"Number \" << i << \" is not pure push.\");\n+        BOOST_CHECK_MESSAGE(script.HasCanonicalPushes(), \"Number \" << i << \" push is not canonical.\");\n+    }\n+\n+    for (int i=0; i<1000; i++) {\n+        std::vector<unsigned char> data(i, '\\111');\n+        CScript script;\n+        script << data;\n+        BOOST_CHECK_MESSAGE(script.IsPushOnly(), \"Length \" << i << \" is not pure push.\");\n+        BOOST_CHECK_MESSAGE(script.HasCanonicalPushes(), \"Length \" << i << \" push is not canonical.\");\n+    }\n+}\n+\n BOOST_AUTO_TEST_SUITE_END()"
      }
    ]
  }
]