[
  {
    "sha": "e41bd449ab2b8d01260795383af2c40b659d8587",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplNDFiZDQ0OWFiMmI4ZDAxMjYwNzk1MzgzYWYyYzQwYjY1OWQ4NTg3",
    "commit": {
      "author": {
        "name": "Johnson Lau",
        "email": "jl2012@users.noreply.github.com",
        "date": "2016-09-22T07:06:54Z"
      },
      "committer": {
        "name": "Johnson Lau",
        "email": "jl2012@xbt.hk",
        "date": "2016-09-27T15:40:59Z"
      },
      "message": "Add policy: null signature for failed CHECK(MULTI)SIG",
      "tree": {
        "sha": "ec0bc7f8b5624774199b09072fdcee0ed66f6122",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ec0bc7f8b5624774199b09072fdcee0ed66f6122"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e41bd449ab2b8d01260795383af2c40b659d8587",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e41bd449ab2b8d01260795383af2c40b659d8587",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e41bd449ab2b8d01260795383af2c40b659d8587",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e41bd449ab2b8d01260795383af2c40b659d8587/comments",
    "author": {
      "login": "jl2012",
      "id": 8403418,
      "node_id": "MDQ6VXNlcjg0MDM0MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8403418?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jl2012",
      "html_url": "https://github.com/jl2012",
      "followers_url": "https://api.github.com/users/jl2012/followers",
      "following_url": "https://api.github.com/users/jl2012/following{/other_user}",
      "gists_url": "https://api.github.com/users/jl2012/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jl2012/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jl2012/subscriptions",
      "organizations_url": "https://api.github.com/users/jl2012/orgs",
      "repos_url": "https://api.github.com/users/jl2012/repos",
      "events_url": "https://api.github.com/users/jl2012/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jl2012/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jl2012",
      "id": 8403418,
      "node_id": "MDQ6VXNlcjg0MDM0MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8403418?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jl2012",
      "html_url": "https://github.com/jl2012",
      "followers_url": "https://api.github.com/users/jl2012/followers",
      "following_url": "https://api.github.com/users/jl2012/following{/other_user}",
      "gists_url": "https://api.github.com/users/jl2012/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jl2012/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jl2012/subscriptions",
      "organizations_url": "https://api.github.com/users/jl2012/orgs",
      "repos_url": "https://api.github.com/users/jl2012/repos",
      "events_url": "https://api.github.com/users/jl2012/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jl2012/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "5a4f6d72e6154d21eb34fbbc8d7c099532569966",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5a4f6d72e6154d21eb34fbbc8d7c099532569966",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/5a4f6d72e6154d21eb34fbbc8d7c099532569966"
      }
    ],
    "stats": {
      "total": 57,
      "additions": 55,
      "deletions": 2
    },
    "files": [
      {
        "sha": "9d6ff1233b6aaef5582a8cbed9c8bdec72c4592d",
        "filename": "src/policy/policy.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e41bd449ab2b8d01260795383af2c40b659d8587/src/policy/policy.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e41bd449ab2b8d01260795383af2c40b659d8587/src/policy/policy.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/policy/policy.h?ref=e41bd449ab2b8d01260795383af2c40b659d8587",
        "patch": "@@ -43,6 +43,7 @@ static const unsigned int STANDARD_SCRIPT_VERIFY_FLAGS = MANDATORY_SCRIPT_VERIFY\n                                                          SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_NOPS |\n                                                          SCRIPT_VERIFY_CLEANSTACK |\n                                                          SCRIPT_VERIFY_MINIMALIF |\n+                                                         SCRIPT_VERIFY_NULLFAIL |\n                                                          SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY |\n                                                          SCRIPT_VERIFY_CHECKSEQUENCEVERIFY |\n                                                          SCRIPT_VERIFY_LOW_S |"
      },
      {
        "sha": "41756ea71196d9168f9d7bde783167ddc4f077ed",
        "filename": "src/script/interpreter.cpp",
        "status": "modified",
        "additions": 13,
        "deletions": 1,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e41bd449ab2b8d01260795383af2c40b659d8587/src/script/interpreter.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e41bd449ab2b8d01260795383af2c40b659d8587/src/script/interpreter.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/interpreter.cpp?ref=e41bd449ab2b8d01260795383af2c40b659d8587",
        "patch": "@@ -885,6 +885,9 @@ bool EvalScript(vector<vector<unsigned char> >& stack, const CScript& script, un\n                     }\n                     bool fSuccess = checker.CheckSig(vchSig, vchPubKey, scriptCode, sigversion);\n \n+                    if (!fSuccess && (flags & SCRIPT_VERIFY_NULLFAIL) && vchSig.size())\n+                        return set_error(serror, SCRIPT_ERR_SIG_NULLFAIL);\n+\n                     popstack(stack);\n                     popstack(stack);\n                     stack.push_back(fSuccess ? vchTrue : vchFalse);\n@@ -914,6 +917,9 @@ bool EvalScript(vector<vector<unsigned char> >& stack, const CScript& script, un\n                     if (nOpCount > MAX_OPS_PER_SCRIPT)\n                         return set_error(serror, SCRIPT_ERR_OP_COUNT);\n                     int ikey = ++i;\n+                    // ikey2 is the position of last non-signature item in the stack. Top stack item = 1.\n+                    // With SCRIPT_VERIFY_NULLFAIL, this is used for cleanup if operation fails.\n+                    int ikey2 = nKeysCount + 2;\n                     i += nKeysCount;\n                     if ((int)stack.size() < i)\n                         return set_error(serror, SCRIPT_ERR_INVALID_STACK_OPERATION);\n@@ -970,8 +976,14 @@ bool EvalScript(vector<vector<unsigned char> >& stack, const CScript& script, un\n                     }\n \n                     // Clean up stack of actual arguments\n-                    while (i-- > 1)\n+                    while (i-- > 1) {\n+                        // If the operation failed, we require that all signatures must be empty vector\n+                        if (!fSuccess && (flags & SCRIPT_VERIFY_NULLFAIL) && !ikey2 && stacktop(-1).size())\n+                            return set_error(serror, SCRIPT_ERR_SIG_NULLFAIL);\n+                        if (ikey2 > 0)\n+                            ikey2--;\n                         popstack(stack);\n+                    }\n \n                     // A bug causes CHECKMULTISIG to consume one extra argument\n                     // whose contents were not checked in any way."
      },
      {
        "sha": "0adc9482ffec64f5575a5b71f1db26504f3b379b",
        "filename": "src/script/interpreter.h",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e41bd449ab2b8d01260795383af2c40b659d8587/src/script/interpreter.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e41bd449ab2b8d01260795383af2c40b659d8587/src/script/interpreter.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/interpreter.h?ref=e41bd449ab2b8d01260795383af2c40b659d8587",
        "patch": "@@ -98,6 +98,10 @@ enum\n     // Segwit script only: Require the argument of OP_IF/NOTIF to be exactly 0x01 or empty vector\n     //\n     SCRIPT_VERIFY_MINIMALIF = (1U << 13),\n+\n+    // Signature(s) must be empty vector if an CHECK(MULTI)SIG operation failed\n+    //\n+    SCRIPT_VERIFY_NULLFAIL = (1U << 14),\n };\n \n bool CheckSignatureEncoding(const std::vector<unsigned char> &vchSig, unsigned int flags, ScriptError* serror);"
      },
      {
        "sha": "e27b715c2cfeab3d5cea1f1b9c2b7d675f343e4b",
        "filename": "src/script/script_error.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e41bd449ab2b8d01260795383af2c40b659d8587/src/script/script_error.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e41bd449ab2b8d01260795383af2c40b659d8587/src/script/script_error.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/script_error.cpp?ref=e41bd449ab2b8d01260795383af2c40b659d8587",
        "patch": "@@ -65,6 +65,8 @@ const char* ScriptErrorString(const ScriptError serror)\n             return \"Dummy CHECKMULTISIG argument must be zero\";\n         case SCRIPT_ERR_MINIMALIF:\n             return \"OP_IF/NOTIF argument must be minimal\";\n+        case SCRIPT_ERR_SIG_NULLFAIL:\n+            return \"Signature must be zero for failed CHECK(MULTI)SIG operation\";\n         case SCRIPT_ERR_DISCOURAGE_UPGRADABLE_NOPS:\n             return \"NOPx reserved for soft-fork upgrades\";\n         case SCRIPT_ERR_DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM:"
      },
      {
        "sha": "bccfdb99e23bb587ba1eab8c425d09fd726e9421",
        "filename": "src/script/script_error.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e41bd449ab2b8d01260795383af2c40b659d8587/src/script/script_error.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e41bd449ab2b8d01260795383af2c40b659d8587/src/script/script_error.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/script_error.h?ref=e41bd449ab2b8d01260795383af2c40b659d8587",
        "patch": "@@ -49,6 +49,7 @@ typedef enum ScriptError_t\n     SCRIPT_ERR_PUBKEYTYPE,\n     SCRIPT_ERR_CLEANSTACK,\n     SCRIPT_ERR_MINIMALIF,\n+    SCRIPT_ERR_SIG_NULLFAIL,\n \n     /* softfork safeness */\n     SCRIPT_ERR_DISCOURAGE_UPGRADABLE_NOPS,"
      },
      {
        "sha": "06103ea5bdd665ecac1df0a82c07bd32f9ecba95",
        "filename": "src/test/data/script_tests.json",
        "status": "modified",
        "additions": 32,
        "deletions": 1,
        "changes": 33,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e41bd449ab2b8d01260795383af2c40b659d8587/src/test/data/script_tests.json",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e41bd449ab2b8d01260795383af2c40b659d8587/src/test/data/script_tests.json",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/data/script_tests.json?ref=e41bd449ab2b8d01260795383af2c40b659d8587",
        "patch": "@@ -1491,6 +1491,27 @@\n     \"OK\",\n     \"BIP66 example 4, with DERSIG\"\n ],\n+[\n+    \"0x09 0x300602010102010101\",\n+    \"0x21 0x038282263212c609d9ea2a6e3e172de238d8c39cabd5ac1ca10646e23fd5f51508 CHECKSIG NOT\",\n+    \"DERSIG\",\n+    \"OK\",\n+    \"BIP66 example 4, with DERSIG, non-null DER-compliant signature\"\n+],\n+[\n+    \"0\",\n+    \"0x21 0x038282263212c609d9ea2a6e3e172de238d8c39cabd5ac1ca10646e23fd5f51508 CHECKSIG NOT\",\n+    \"DERSIG,NULLFAIL\",\n+    \"OK\",\n+    \"BIP66 example 4, with DERSIG and NULLFAIL\"\n+],\n+[\n+    \"0x09 0x300602010102010101\",\n+    \"0x21 0x038282263212c609d9ea2a6e3e172de238d8c39cabd5ac1ca10646e23fd5f51508 CHECKSIG NOT\",\n+    \"DERSIG,NULLFAIL\",\n+    \"NULLFAIL\",\n+    \"BIP66 example 4, with DERSIG and NULLFAIL, non-null DER-compliant signature\"\n+],\n [\n     \"1\",\n     \"0x21 0x038282263212c609d9ea2a6e3e172de238d8c39cabd5ac1ca10646e23fd5f51508 CHECKSIG\",\n@@ -2208,5 +2229,15 @@\n [[\"645168\", 0.00000001], \"0x22 0x0020f913eacf2e38a5d6fc3a8311d72ae704cb83866350a984dd3e5eb76d2a8c28e8\", \"HASH160 0x14 0xdbb7d1c0a56b7a9c423300c8cca6e6e065baf1dc EQUAL\", \"P2SH,WITNESS\", \"UNBALANCED_CONDITIONAL\"],\n [[\"645168\", 0.00000001], \"0x22 0x0020f913eacf2e38a5d6fc3a8311d72ae704cb83866350a984dd3e5eb76d2a8c28e8\", \"HASH160 0x14 0xdbb7d1c0a56b7a9c423300c8cca6e6e065baf1dc EQUAL\", \"P2SH,WITNESS,MINIMALIF\", \"UNBALANCED_CONDITIONAL\"],\n \n- [\"The End\"]\n+[\"NULLFAIL should cover all signatures and signatures only\"],\n+[\"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\", \"0x01 0x14 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0x01 0x14 CHECKMULTISIG NOT\", \"DERSIG\", \"OK\", \"BIP66 and NULLFAIL-compliant\"],\n+[\"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\", \"0x01 0x14 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0x01 0x14 CHECKMULTISIG NOT\", \"DERSIG,NULLFAIL\", \"OK\", \"BIP66 and NULLFAIL-compliant\"],\n+[\"1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\", \"0x01 0x14 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0x01 0x14 CHECKMULTISIG NOT\", \"DERSIG,NULLFAIL\", \"OK\", \"BIP66 and NULLFAIL-compliant, not NULLDUMMY-compliant\"],\n+[\"1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\", \"0x01 0x14 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0x01 0x14 CHECKMULTISIG NOT\", \"DERSIG,NULLFAIL,NULLDUMMY\", \"SIG_NULLDUMMY\", \"BIP66 and NULLFAIL-compliant, not NULLDUMMY-compliant\"],\n+[\"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0x09 0x300602010102010101\", \"0x01 0x14 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0x01 0x14 CHECKMULTISIG NOT\", \"DERSIG\", \"OK\", \"BIP66-compliant but not NULLFAIL-compliant\"],\n+[\"0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0x09 0x300602010102010101\", \"0x01 0x14 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0x01 0x14 CHECKMULTISIG NOT\", \"DERSIG,NULLFAIL\", \"NULLFAIL\", \"BIP66-compliant but not NULLFAIL-compliant\"],\n+[\"0 0x09 0x300602010102010101 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\", \"0x01 0x14 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0x01 0x14 CHECKMULTISIG NOT\", \"DERSIG\", \"OK\", \"BIP66-compliant but not NULLFAIL-compliant\"],\n+[\"0 0x09 0x300602010102010101 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0\", \"0x01 0x14 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0x01 0x14 CHECKMULTISIG NOT\", \"DERSIG,NULLFAIL\", \"NULLFAIL\", \"BIP66-compliant but not NULLFAIL-compliant\"],\n+\n+[\"The End\"]\n ]"
      },
      {
        "sha": "7971b5122ffc964a10d89c7a7a93e1b6d112e3f0",
        "filename": "src/test/script_tests.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e41bd449ab2b8d01260795383af2c40b659d8587/src/test/script_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e41bd449ab2b8d01260795383af2c40b659d8587/src/test/script_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/script_tests.cpp?ref=e41bd449ab2b8d01260795383af2c40b659d8587",
        "patch": "@@ -90,6 +90,7 @@ static ScriptErrorDesc script_errors[]={\n     {SCRIPT_ERR_PUBKEYTYPE, \"PUBKEYTYPE\"},\n     {SCRIPT_ERR_CLEANSTACK, \"CLEANSTACK\"},\n     {SCRIPT_ERR_MINIMALIF, \"MINIMALIF\"},\n+    {SCRIPT_ERR_SIG_NULLFAIL, \"NULLFAIL\"},\n     {SCRIPT_ERR_DISCOURAGE_UPGRADABLE_NOPS, \"DISCOURAGE_UPGRADABLE_NOPS\"},\n     {SCRIPT_ERR_DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM, \"DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM\"},\n     {SCRIPT_ERR_WITNESS_PROGRAM_WRONG_LENGTH, \"WITNESS_PROGRAM_WRONG_LENGTH\"},"
      },
      {
        "sha": "6163d2f6306048bbba58c194a738bd6218cda06e",
        "filename": "src/test/transaction_tests.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e41bd449ab2b8d01260795383af2c40b659d8587/src/test/transaction_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e41bd449ab2b8d01260795383af2c40b659d8587/src/test/transaction_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/transaction_tests.cpp?ref=e41bd449ab2b8d01260795383af2c40b659d8587",
        "patch": "@@ -51,6 +51,7 @@ static std::map<string, unsigned int> mapFlagNames = boost::assign::map_list_of\n     (string(\"DISCOURAGE_UPGRADABLE_NOPS\"), (unsigned int)SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_NOPS)\n     (string(\"CLEANSTACK\"), (unsigned int)SCRIPT_VERIFY_CLEANSTACK)\n     (string(\"MINIMALIF\"), (unsigned int)SCRIPT_VERIFY_MINIMALIF)\n+    (string(\"NULLFAIL\"), (unsigned int)SCRIPT_VERIFY_NULLFAIL)\n     (string(\"CHECKLOCKTIMEVERIFY\"), (unsigned int)SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY)\n     (string(\"CHECKSEQUENCEVERIFY\"), (unsigned int)SCRIPT_VERIFY_CHECKSEQUENCEVERIFY)\n     (string(\"WITNESS\"), (unsigned int)SCRIPT_VERIFY_WITNESS)"
      }
    ]
  }
]