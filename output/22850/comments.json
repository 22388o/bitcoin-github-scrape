[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/909555946",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22850#issuecomment-909555946",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22850",
    "id": 909555946,
    "node_id": "IC_kwDOABII5842Nrjq",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-31T19:43:22Z",
    "updated_at": "2021-09-16T00:17:03Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22976](https://github.com/bitcoin/bitcoin/pull/22976) (scripted-diff: Rename overloaded int GetArg to GetIntArg by ryanofsky)\n* [#22955](https://github.com/bitcoin/bitcoin/pull/22955) (p2p: Rename fBlocksOnly, Add test by MarcoFalke)\n* [#22777](https://github.com/bitcoin/bitcoin/pull/22777) (net processing: don't request tx relay on feeler connections by jnewbery)\n* [#22677](https://github.com/bitcoin/bitcoin/pull/22677) (cut the validation <-> txmempool circular dependency by glozow)\n* [#22564](https://github.com/bitcoin/bitcoin/pull/22564) ([WIP] refactor: Move mutable globals cleared in `::UnloadBlockIndex` to `BlockManager` by dongcarl)\n* [#22340](https://github.com/bitcoin/bitcoin/pull/22340) (p2p: Use legacy relaying to download blocks in blocks-only mode by dergoegge)\n* [#21527](https://github.com/bitcoin/bitcoin/pull/21527) (net_processing: lock clean up by ajtowns)\n* [#20799](https://github.com/bitcoin/bitcoin/pull/20799) (net processing: Only support version 2 compact blocks by jnewbery)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/909555946/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/913141417",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22850#issuecomment-913141417",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22850",
    "id": 913141417,
    "node_id": "IC_kwDOABII5842bW6p",
    "user": {
      "login": "theStack",
      "id": 91535,
      "node_id": "MDQ6VXNlcjkxNTM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theStack",
      "html_url": "https://github.com/theStack",
      "followers_url": "https://api.github.com/users/theStack/followers",
      "following_url": "https://api.github.com/users/theStack/following{/other_user}",
      "gists_url": "https://api.github.com/users/theStack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theStack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
      "organizations_url": "https://api.github.com/users/theStack/orgs",
      "repos_url": "https://api.github.com/users/theStack/repos",
      "events_url": "https://api.github.com/users/theStack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theStack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-05T12:02:57Z",
    "updated_at": "2021-09-05T12:02:57Z",
    "author_association": "CONTRIBUTOR",
    "body": "Concept ACK",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/913141417/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/921031369",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22850#issuecomment-921031369",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22850",
    "id": 921031369,
    "node_id": "IC_kwDOABII58425dLJ",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-16T16:01:31Z",
    "updated_at": "2021-09-16T16:01:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--cf906140f33d8803c4a75a2196329ecb-->\n\ud83d\udc19 This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/921031369/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/928992191",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22850#issuecomment-928992191",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22850",
    "id": 928992191,
    "node_id": "IC_kwDOABII5843X0u_",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?u=71263a00d1269c7f0ed6660aa0c15c894df78a88&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-28T08:55:11Z",
    "updated_at": "2021-09-28T08:55:11Z",
    "author_association": "MEMBER",
    "body": "Concept ACK",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/928992191/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700952750",
    "pull_request_review_id": 744885059,
    "id": 700952750,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDk1Mjc1MA==",
    "diff_hunk": "@@ -3396,8 +3415,8 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n \n     if (msg_type == NetMsgType::CMPCTBLOCK)\n     {\n-        // Ignore cmpctblock received while importing\n-        if (fImporting || fReindex) {\n+        // Ignore cmpctblock received while importing, or when there is no mempool\n+        if (fImporting || fReindex || !m_mempool) {",
    "path": "src/net_processing.cpp",
    "position": 222,
    "original_position": 222,
    "commit_id": "0e07e48a3b049eaa1c7b779187e56cf7ea85ead9",
    "original_commit_id": "0e07e48a3b049eaa1c7b779187e56cf7ea85ead9",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Wouldn't the same check be needed for `BLOCKTXN`?",
    "created_at": "2021-09-02T10:24:02Z",
    "updated_at": "2021-09-02T10:50:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22850#discussion_r700952750",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22850",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700952750"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22850#discussion_r700952750"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22850"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700952750/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3419,
    "original_line": 3419,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700954602",
    "pull_request_review_id": 744885059,
    "id": 700954602,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDk1NDYwMg==",
    "diff_hunk": "@@ -867,7 +867,7 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n     RemoveBlockRequest(hash);\n \n     std::list<QueuedBlock>::iterator it = state->vBlocksInFlight.insert(state->vBlocksInFlight.end(),\n-            {&block, std::unique_ptr<PartiallyDownloadedBlock>(pit ? new PartiallyDownloadedBlock(&m_mempool) : nullptr)});\n+            {&block, std::unique_ptr<PartiallyDownloadedBlock>(pit ? new PartiallyDownloadedBlock(m_mempool) : nullptr)});",
    "path": "src/net_processing.cpp",
    "position": 23,
    "original_position": 23,
    "commit_id": "0e07e48a3b049eaa1c7b779187e56cf7ea85ead9",
    "original_commit_id": "0e07e48a3b049eaa1c7b779187e56cf7ea85ead9",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Wouldn't it be safer to set the block to nullptr when the mempool is nullptr?",
    "created_at": "2021-09-02T10:26:53Z",
    "updated_at": "2021-09-02T10:50:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22850#discussion_r700954602",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22850",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700954602"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22850#discussion_r700954602"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22850"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700954602/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 870,
    "original_line": 870,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700958398",
    "pull_request_review_id": 744885059,
    "id": 700958398,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDk1ODM5OA==",
    "diff_hunk": "@@ -867,7 +867,7 @@ bool PeerManagerImpl::BlockRequested(NodeId nodeid, const CBlockIndex& block, st\n     RemoveBlockRequest(hash);\n \n     std::list<QueuedBlock>::iterator it = state->vBlocksInFlight.insert(state->vBlocksInFlight.end(),\n-            {&block, std::unique_ptr<PartiallyDownloadedBlock>(pit ? new PartiallyDownloadedBlock(&m_mempool) : nullptr)});\n+            {&block, std::unique_ptr<PartiallyDownloadedBlock>(pit ? new PartiallyDownloadedBlock(m_mempool) : nullptr)});",
    "path": "src/net_processing.cpp",
    "position": 23,
    "original_position": 23,
    "commit_id": "0e07e48a3b049eaa1c7b779187e56cf7ea85ead9",
    "original_commit_id": "0e07e48a3b049eaa1c7b779187e56cf7ea85ead9",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "If you pick this suggestion, you can also add a separate commit to document the expectation that `PartiallyDownloadedBlock` assumes a reference (doesn't accept nullptr) and that `InitData` without a pool is UB/Crash.\r\n\r\n```diff\r\ndiff --git a/src/blockencodings.cpp b/src/blockencodings.cpp\r\nindex aa111b5939..8f77c4afd6 100644\r\n--- a/src/blockencodings.cpp\r\n+++ b/src/blockencodings.cpp\r\n@@ -45,8 +45,9 @@ uint64_t CBlockHeaderAndShortTxIDs::GetShortID(const uint256& txhash) const {\r\n }\r\n \r\n \r\n-\r\n-ReadStatus PartiallyDownloadedBlock::InitData(const CBlockHeaderAndShortTxIDs& cmpctblock, const std::vector<std::pair<uint256, CTransactionRef>>& extra_txn) {\r\n+ReadStatus PartiallyDownloadedBlock::InitData(const CBlockHeaderAndShortTxIDs& cmpctblock, const std::vector<std::pair<uint256, CTransactionRef>>& extra_txn)\r\n+{\r\n+    Assert(pool);\r\n     if (cmpctblock.header.IsNull() || (cmpctblock.shorttxids.empty() && cmpctblock.prefilledtxn.empty()))\r\n         return READ_STATUS_INVALID;\r\n     if (cmpctblock.shorttxids.size() + cmpctblock.prefilledtxn.size() > MAX_BLOCK_WEIGHT / MIN_SERIALIZABLE_TRANSACTION_WEIGHT)\r\ndiff --git a/src/blockencodings.h b/src/blockencodings.h\r\nindex 326db1b4a7..ce3284bfd5 100644\r\n--- a/src/blockencodings.h\r\n+++ b/src/blockencodings.h\r\n@@ -6,6 +6,7 @@\r\n #define BITCOIN_BLOCKENCODINGS_H\r\n \r\n #include <primitives/block.h>\r\n+#include <util/check.h>\r\n \r\n \r\n class CTxMemPool;\r\n@@ -127,9 +128,10 @@ protected:\r\n     std::vector<CTransactionRef> txn_available;\r\n     size_t prefilled_count = 0, mempool_count = 0, extra_count = 0;\r\n     const CTxMemPool* pool;\r\n+\r\n public:\r\n     CBlockHeader header;\r\n-    explicit PartiallyDownloadedBlock(CTxMemPool* poolIn) : pool(poolIn) {}\r\n+    explicit PartiallyDownloadedBlock(CTxMemPool* poolIn) : pool(Assume(poolIn)) {}\r\n \r\n     // extra_txn is a list of extra transactions to look at, in <witness hash, reference> form\r\n     ReadStatus InitData(const CBlockHeaderAndShortTxIDs& cmpctblock, const std::vector<std::pair<uint256, CTransactionRef>>& extra_txn);\r\n",
    "created_at": "2021-09-02T10:32:42Z",
    "updated_at": "2021-09-02T10:50:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22850#discussion_r700958398",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22850",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700958398"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22850#discussion_r700958398"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22850"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700958398/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 870,
    "original_line": 870,
    "side": "RIGHT",
    "in_reply_to_id": 700954602
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700966796",
    "pull_request_review_id": 744885059,
    "id": 700966796,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMDk2Njc5Ng==",
    "diff_hunk": "@@ -1632,6 +1640,8 @@ void PeerManagerImpl::BlockChecked(const CBlock& block, const BlockValidationSta\n \n bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid)\n {\n+    if (!m_mempool) return false;",
    "path": "src/net_processing.cpp",
    "position": 90,
    "original_position": 90,
    "commit_id": "0e07e48a3b049eaa1c7b779187e56cf7ea85ead9",
    "original_commit_id": "0e07e48a3b049eaa1c7b779187e56cf7ea85ead9",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n    if (!Assume(m_mempool)) return false;\r\n```\r\n\r\nIt would be nice if this function wasn't called when no mempool exists. If you agree, I think it makes sense to skip calling this function when txs aren't expected at all:\r\n\r\n```diff\r\ndiff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex 3ad34e83ba..68e381db60 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -2949,16 +2949,17 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\r\n                     best_block = &inv.hash;\r\n                 }\r\n             } else if (inv.IsGenTxMsg()) {\r\n+                if (fBlocksOnly) {\r\n+                    LogPrint(BCLog::NET, \"transaction (%s) inv sent in violation of protocol, disconnecting peer=%d\\n\", inv.hash.ToString(), pfrom.GetId());\r\n+                    pfrom.fDisconnect = true;\r\n+                    return;\r\n+                }\r\n                 const GenTxid gtxid = ToGenTxid(inv);\r\n                 const bool fAlreadyHave = AlreadyHaveTx(gtxid);\r\n                 LogPrint(BCLog::NET, \"got inv: %s  %s peer=%d\\n\", inv.ToString(), fAlreadyHave ? \"have\" : \"new\", pfrom.GetId());\r\n \r\n                 pfrom.AddKnownTx(inv.hash);\r\n-                if (fBlocksOnly) {\r\n-                    LogPrint(BCLog::NET, \"transaction (%s) inv sent in violation of protocol, disconnecting peer=%d\\n\", inv.hash.ToString(), pfrom.GetId());\r\n-                    pfrom.fDisconnect = true;\r\n-                    return;\r\n-                } else if (!fAlreadyHave && !m_chainman.ActiveChainstate().IsInitialBlockDownload()) {\r\n+                if (!fAlreadyHave && !m_chainman.ActiveChainstate().IsInitialBlockDownload()) {\r\n                     AddTxAnnouncement(pfrom, gtxid, current_time);\r\n                 }\r\n             } else {\r\n```\r\n\r\nShould be done in a separate commit, or even separate pull",
    "created_at": "2021-09-02T10:45:02Z",
    "updated_at": "2021-09-02T10:50:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22850#discussion_r700966796",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22850",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700966796"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22850#discussion_r700966796"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22850"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/700966796/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1643,
    "original_line": 1643,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712296435",
    "pull_request_review_id": 758809145,
    "id": 712296435,
    "node_id": "PRRC_kwDOABII584qdMfz",
    "diff_hunk": "@@ -1632,6 +1640,8 @@ void PeerManagerImpl::BlockChecked(const CBlock& block, const BlockValidationSta\n \n bool PeerManagerImpl::AlreadyHaveTx(const GenTxid& gtxid)\n {\n+    if (!m_mempool) return false;",
    "path": "src/net_processing.cpp",
    "position": 90,
    "original_position": 90,
    "commit_id": "0e07e48a3b049eaa1c7b779187e56cf7ea85ead9",
    "original_commit_id": "0e07e48a3b049eaa1c7b779187e56cf7ea85ead9",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done in #23042 ",
    "created_at": "2021-09-20T15:48:50Z",
    "updated_at": "2021-09-20T15:48:50Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22850#discussion_r712296435",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22850",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712296435"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22850#discussion_r712296435"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22850"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712296435/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1643,
    "original_line": 1643,
    "side": "RIGHT",
    "in_reply_to_id": 700966796
  }
]