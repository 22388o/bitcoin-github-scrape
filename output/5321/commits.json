[
  {
    "sha": "cca48f69b04462c5c9bfefd34443e0b8401dbd6c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjY2E0OGY2OWIwNDQ2MmM1YzliZmVmZDM0NDQzZTBiODQwMWRiZDZj",
    "commit": {
      "author": {
        "name": "21E14",
        "email": "21xe14@gmail.com",
        "date": "2014-11-01T21:42:12Z"
      },
      "committer": {
        "name": "21E14",
        "email": "21xe14@gmail.com",
        "date": "2014-11-12T05:35:24Z"
      },
      "message": "Reset setBlockIndexCandidates once block index db loaded",
      "tree": {
        "sha": "20392f598e85eae39ff1726c772b9a14fae06b66",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/20392f598e85eae39ff1726c772b9a14fae06b66"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/cca48f69b04462c5c9bfefd34443e0b8401dbd6c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/cca48f69b04462c5c9bfefd34443e0b8401dbd6c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/cca48f69b04462c5c9bfefd34443e0b8401dbd6c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/cca48f69b04462c5c9bfefd34443e0b8401dbd6c/comments",
    "author": null,
    "committer": null,
    "parents": [
      {
        "sha": "04e988c6ce1e7255a9575ff2fd130219f03c64f2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/04e988c6ce1e7255a9575ff2fd130219f03c64f2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/04e988c6ce1e7255a9575ff2fd130219f03c64f2"
      }
    ],
    "stats": {
      "total": 21,
      "additions": 14,
      "deletions": 7
    },
    "files": [
      {
        "sha": "1ba17614df19e341f77d9bd6d9ad33f1d93fa6c9",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 14,
        "deletions": 7,
        "changes": 21,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/cca48f69b04462c5c9bfefd34443e0b8401dbd6c/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/cca48f69b04462c5c9bfefd34443e0b8401dbd6c/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=cca48f69b04462c5c9bfefd34443e0b8401dbd6c",
        "patch": "@@ -1949,6 +1949,16 @@ static CBlockIndex* FindMostWorkChain() {\n     } while(true);\n }\n \n+// Delete all entries in setBlockIndexCandidates that are worse than the current tip.\n+static void PruneBlockIndexCandidates() {\n+    // Note that we can't delete the current block itself, as we may need to return to it later in case a\n+    // reorganization to a better block fails.\n+    std::set<CBlockIndex*, CBlockIndexWorkComparator>::iterator it = setBlockIndexCandidates.begin();\n+    while (setBlockIndexCandidates.value_comp()(*it, chainActive.Tip())) {\n+        setBlockIndexCandidates.erase(it++);\n+    }\n+}\n+\n // Try to make some progress towards making pindexMostWork the active block.\n // pblock is either NULL or a pointer to a CBlock corresponding to pindexMostWork.\n static bool ActivateBestChainStep(CValidationState &state, CBlockIndex *pindexMostWork, CBlock *pblock) {\n@@ -1996,13 +2006,7 @@ static bool ActivateBestChainStep(CValidationState &state, CBlockIndex *pindexMo\n                 return false;\n             }\n         } else {\n-            // Delete all entries in setBlockIndexCandidates that are worse than our new current block.\n-            // Note that we can't delete the current block itself, as we may need to return to it later in case a\n-            // reorganization to a better block fails.\n-            std::set<CBlockIndex*, CBlockIndexWorkComparator>::iterator it = setBlockIndexCandidates.begin();\n-            while (setBlockIndexCandidates.value_comp()(*it, chainActive.Tip())) {\n-                setBlockIndexCandidates.erase(it++);\n-            }\n+            PruneBlockIndexCandidates();\n             // Either the current tip or a successor of it we're working towards is left in setBlockIndexCandidates.\n             assert(!setBlockIndexCandidates.empty());\n             if (!pindexOldTip || chainActive.Tip()->nChainWork > pindexOldTip->nChainWork) {\n@@ -2860,6 +2864,9 @@ bool static LoadBlockIndexDB()\n     if (it == mapBlockIndex.end())\n         return true;\n     chainActive.SetTip(it->second);\n+\n+    PruneBlockIndexCandidates();\n+\n     LogPrintf(\"LoadBlockIndexDB(): hashBestChain=%s height=%d date=%s progress=%f\\n\",\n         chainActive.Tip()->GetBlockHash().ToString(), chainActive.Height(),\n         DateTimeStrFormat(\"%Y-%m-%d %H:%M:%S\", chainActive.Tip()->GetBlockTime()),"
      }
    ]
  },
  {
    "sha": "34559c7c73e3ce67baea0d88ba74b0988b55142d",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozNDU1OWM3YzczZTNjZTY3YmFlYTBkODhiYTc0YjA5ODhiNTUxNDJk",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2014-11-20T11:43:50Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2014-11-20T11:43:50Z"
      },
      "message": "Make PruneBlockIndexCandidates safer",
      "tree": {
        "sha": "9d79bf7b88e9cd81cbe830c2fc3d5410671f9587",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9d79bf7b88e9cd81cbe830c2fc3d5410671f9587"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/34559c7c73e3ce67baea0d88ba74b0988b55142d",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/34559c7c73e3ce67baea0d88ba74b0988b55142d",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/34559c7c73e3ce67baea0d88ba74b0988b55142d",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/34559c7c73e3ce67baea0d88ba74b0988b55142d/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "cca48f69b04462c5c9bfefd34443e0b8401dbd6c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/cca48f69b04462c5c9bfefd34443e0b8401dbd6c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/cca48f69b04462c5c9bfefd34443e0b8401dbd6c"
      }
    ],
    "stats": {
      "total": 6,
      "additions": 3,
      "deletions": 3
    },
    "files": [
      {
        "sha": "ac65a4ac2f13d7ed327977716152e5643e21c973",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/34559c7c73e3ce67baea0d88ba74b0988b55142d/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/34559c7c73e3ce67baea0d88ba74b0988b55142d/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=34559c7c73e3ce67baea0d88ba74b0988b55142d",
        "patch": "@@ -1954,9 +1954,11 @@ static void PruneBlockIndexCandidates() {\n     // Note that we can't delete the current block itself, as we may need to return to it later in case a\n     // reorganization to a better block fails.\n     std::set<CBlockIndex*, CBlockIndexWorkComparator>::iterator it = setBlockIndexCandidates.begin();\n-    while (setBlockIndexCandidates.value_comp()(*it, chainActive.Tip())) {\n+    while (it != setBlockIndexCandidates.end() && setBlockIndexCandidates.value_comp()(*it, chainActive.Tip())) {\n         setBlockIndexCandidates.erase(it++);\n     }\n+    // Either the current tip or a successor of it we're working towards is left in setBlockIndexCandidates.\n+    assert(!setBlockIndexCandidates.empty());\n }\n \n // Try to make some progress towards making pindexMostWork the active block.\n@@ -2007,8 +2009,6 @@ static bool ActivateBestChainStep(CValidationState &state, CBlockIndex *pindexMo\n             }\n         } else {\n             PruneBlockIndexCandidates();\n-            // Either the current tip or a successor of it we're working towards is left in setBlockIndexCandidates.\n-            assert(!setBlockIndexCandidates.empty());\n             if (!pindexOldTip || chainActive.Tip()->nChainWork > pindexOldTip->nChainWork) {\n                 // We're in a better position than we were. Return temporarily to release the lock.\n                 fContinue = false;"
      }
    ]
  }
]