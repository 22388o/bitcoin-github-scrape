[
  {
    "sha": "6ba8f30e7b0b0bbb365fcca95b0c33af31f28ef4",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2YmE4ZjMwZTdiMGIwYmJiMzY1ZmNjYTk1YjBjMzNhZjMxZjI4ZWY0",
    "commit": {
      "author": {
        "name": "Gregory Sanders",
        "email": "gsanders87@gmail.com",
        "date": "2017-12-06T16:49:37Z"
      },
      "committer": {
        "name": "Gregory Sanders",
        "email": "gsanders87@gmail.com",
        "date": "2017-12-11T14:08:54Z"
      },
      "message": "don't attempt mempool entry for wallet transactions on startup if already in mempool",
      "tree": {
        "sha": "edab14e647c5909e1d84983250869b2db5632f5f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/edab14e647c5909e1d84983250869b2db5632f5f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6ba8f30e7b0b0bbb365fcca95b0c33af31f28ef4",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6ba8f30e7b0b0bbb365fcca95b0c33af31f28ef4",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/6ba8f30e7b0b0bbb365fcca95b0c33af31f28ef4",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6ba8f30e7b0b0bbb365fcca95b0c33af31f28ef4/comments",
    "author": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "24df9af81625122c816a0ae6bb842ea47a4041ff",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/24df9af81625122c816a0ae6bb842ea47a4041ff",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/24df9af81625122c816a0ae6bb842ea47a4041ff"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 5,
      "deletions": 0
    },
    "files": [
      {
        "sha": "cb81ec37f53501c7d6f019382e8a0a8ebcd10ce3",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6ba8f30e7b0b0bbb365fcca95b0c33af31f28ef4/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6ba8f30e7b0b0bbb365fcca95b0c33af31f28ef4/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=6ba8f30e7b0b0bbb365fcca95b0c33af31f28ef4",
        "patch": "@@ -4114,6 +4114,11 @@ int CMerkleTx::GetBlocksToMaturity() const\n \n bool CWalletTx::AcceptToMemoryPool(const CAmount& nAbsurdFee, CValidationState& state)\n {\n+    // Quick check to avoid re-setting fInMempool to false\n+    if (mempool.exists(tx->GetHash())) {\n+        return false;\n+    }\n+\n     // We must set fInMempool here - while it will be re-set to true by the\n     // entered-mempool callback, if we did not there would be a race where a\n     // user could call sendmoney in a loop and hit spurious out of funds errors"
      }
    ]
  },
  {
    "sha": "6697a7089441deded836332e7ce3b4a1a9a3cbcd",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2Njk3YTcwODk0NDFkZWRlZDgzNjMzMmU3Y2UzYjRhMWE5YTNjYmNk",
    "commit": {
      "author": {
        "name": "Gregory Sanders",
        "email": "gsanders87@gmail.com",
        "date": "2017-12-06T17:08:40Z"
      },
      "committer": {
        "name": "Gregory Sanders",
        "email": "gsanders87@gmail.com",
        "date": "2017-12-11T14:14:50Z"
      },
      "message": "add test for unconfirmed balance between restarts",
      "tree": {
        "sha": "9935a8cbe309dc2a0d970cec77b8e0027053ac82",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9935a8cbe309dc2a0d970cec77b8e0027053ac82"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6697a7089441deded836332e7ce3b4a1a9a3cbcd",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6697a7089441deded836332e7ce3b4a1a9a3cbcd",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/6697a7089441deded836332e7ce3b4a1a9a3cbcd",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6697a7089441deded836332e7ce3b4a1a9a3cbcd/comments",
    "author": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6ba8f30e7b0b0bbb365fcca95b0c33af31f28ef4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6ba8f30e7b0b0bbb365fcca95b0c33af31f28ef4",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6ba8f30e7b0b0bbb365fcca95b0c33af31f28ef4"
      }
    ],
    "stats": {
      "total": 8,
      "additions": 7,
      "deletions": 1
    },
    "files": [
      {
        "sha": "31a96ec60e234488b84dad1e45b4c79fae4a9cdd",
        "filename": "test/functional/mempool_persist.py",
        "status": "modified",
        "additions": 7,
        "deletions": 1,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6697a7089441deded836332e7ce3b4a1a9a3cbcd/test/functional/mempool_persist.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6697a7089441deded836332e7ce3b4a1a9a3cbcd/test/functional/mempool_persist.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/mempool_persist.py?ref=6697a7089441deded836332e7ce3b4a1a9a3cbcd",
        "patch": "@@ -57,21 +57,27 @@ def run_test(self):\n         self.log.debug(\"Send 5 transactions from node2 (to its own address)\")\n         for i in range(5):\n             self.nodes[2].sendtoaddress(self.nodes[2].getnewaddress(), Decimal(\"10\"))\n+        node2_balance = self.nodes[2].getbalance()\n         self.sync_all()\n \n         self.log.debug(\"Verify that node0 and node1 have 5 transactions in their mempools\")\n         assert_equal(len(self.nodes[0].getrawmempool()), 5)\n         assert_equal(len(self.nodes[1].getrawmempool()), 5)\n \n-        self.log.debug(\"Stop-start node0 and node1. Verify that node0 has the transactions in its mempool and node1 does not.\")\n+        self.log.debug(\"Stop-start the nodes. Verify that node0 has the transactions in its mempool and node1 does not. Verify that node2 calculates its balance correctly after loading wallet transactions.\")\n         self.stop_nodes()\n         self.start_node(0)\n         self.start_node(1)\n+        self.start_node(2)\n         # Give bitcoind a second to reload the mempool\n         time.sleep(1)\n         wait_until(lambda: len(self.nodes[0].getrawmempool()) == 5)\n+        wait_until(lambda: len(self.nodes[2].getrawmempool()) == 5)\n         assert_equal(len(self.nodes[1].getrawmempool()), 0)\n \n+        # Verify accounting of mempool transactions after restart is correct\n+        assert_equal(node2_balance, self.nodes[2].getbalance())\n+\n         self.log.debug(\"Stop-start node0 with -persistmempool=0. Verify that it doesn't load its mempool.dat file.\")\n         self.stop_nodes()\n         self.start_node(0, extra_args=[\"-persistmempool=0\"])"
      }
    ]
  }
]