[
  {
    "sha": "916d8f03c7fe9a8eb6c796756f69234406b98077",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5MTZkOGYwM2M3ZmU5YThlYjZjNzk2NzU2ZjY5MjM0NDA2Yjk4MDc3",
    "commit": {
      "author": {
        "name": "Gleb Naumenko",
        "email": "naumenko.gs@gmail.com",
        "date": "2021-09-14T11:54:40Z"
      },
      "committer": {
        "name": "Gleb Naumenko",
        "email": "naumenko.gs@gmail.com",
        "date": "2021-09-14T12:29:52Z"
      },
      "message": "p2p: Diversify connections only w.r.t *persistent* outbound peers\n\nADDR_FETCH and FEELER are short-lived connections,\nand they should not affect our choice of peers.\n\nAlso, improve comments.",
      "tree": {
        "sha": "e47ede94f7cb069ba15c085dc4eed517f75a9b3f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e47ede94f7cb069ba15c085dc4eed517f75a9b3f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/916d8f03c7fe9a8eb6c796756f69234406b98077",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/916d8f03c7fe9a8eb6c796756f69234406b98077",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/916d8f03c7fe9a8eb6c796756f69234406b98077",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/916d8f03c7fe9a8eb6c796756f69234406b98077/comments",
    "author": {
      "login": "naumenkogs",
      "id": 7975071,
      "node_id": "MDQ6VXNlcjc5NzUwNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naumenkogs",
      "html_url": "https://github.com/naumenkogs",
      "followers_url": "https://api.github.com/users/naumenkogs/followers",
      "following_url": "https://api.github.com/users/naumenkogs/following{/other_user}",
      "gists_url": "https://api.github.com/users/naumenkogs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
      "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
      "repos_url": "https://api.github.com/users/naumenkogs/repos",
      "events_url": "https://api.github.com/users/naumenkogs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "naumenkogs",
      "id": 7975071,
      "node_id": "MDQ6VXNlcjc5NzUwNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naumenkogs",
      "html_url": "https://github.com/naumenkogs",
      "followers_url": "https://api.github.com/users/naumenkogs/followers",
      "following_url": "https://api.github.com/users/naumenkogs/following{/other_user}",
      "gists_url": "https://api.github.com/users/naumenkogs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
      "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
      "repos_url": "https://api.github.com/users/naumenkogs/repos",
      "events_url": "https://api.github.com/users/naumenkogs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "40a9037a1b5d990637d7f5009fc0c39628ed2c05",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/40a9037a1b5d990637d7f5009fc0c39628ed2c05",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/40a9037a1b5d990637d7f5009fc0c39628ed2c05"
      }
    ],
    "stats": {
      "total": 19,
      "additions": 12,
      "deletions": 7
    },
    "files": [
      {
        "sha": "e75c62381647d14f837172ce95f3ddb107f32909",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 12,
        "deletions": 7,
        "changes": 19,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/916d8f03c7fe9a8eb6c796756f69234406b98077/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/916d8f03c7fe9a8eb6c796756f69234406b98077/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=916d8f03c7fe9a8eb6c796756f69234406b98077",
        "patch": "@@ -1908,19 +1908,24 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 if (pnode->IsFullOutboundConn()) nOutboundFullRelay++;\n                 if (pnode->IsBlockOnlyConn()) nOutboundBlockRelay++;\n \n-                // Netgroups for inbound and manual peers are not excluded because our goal here\n-                // is to not use multiple of our limited outbound slots on a single netgroup\n-                // but inbound and manual peers do not use our outbound slots. Inbound peers\n-                // also have the added issue that they could be attacker controlled and used\n-                // to prevent us from connecting to particular hosts if we used them here.\n+                // Make sure our persistent outbound slots belong to different netgroups.\n                 switch (pnode->m_conn_type) {\n+                    // We currently don't take inbound connections into account. Since they are\n+                    // free to make, an attacker could make them to prevent us from connecting to\n+                    // certain peers.\n                     case ConnectionType::INBOUND:\n+                    // Manually selected connections should not affect how we select outbound\n+                    // peers from addrman.\n                     case ConnectionType::MANUAL:\n+                    // Short-lived outbound connections should not affect how we select outbound\n+                    // peers from addrman.\n+                    case ConnectionType::ADDR_FETCH:\n+                    // Short-lived outbound connections should not affect how we select outbound\n+                    // peers from addrman.\n+                    case ConnectionType::FEELER:\n                         break;\n                     case ConnectionType::OUTBOUND_FULL_RELAY:\n                     case ConnectionType::BLOCK_RELAY:\n-                    case ConnectionType::ADDR_FETCH:\n-                    case ConnectionType::FEELER:\n                         setConnected.insert(pnode->addr.GetGroup(addrman.GetAsmap()));\n                 } // no default case, so the compiler can warn about missing cases\n             }"
      }
    ]
  },
  {
    "sha": "a87f04e795b078785bf3cf729adae9b6389f9bc7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphODdmMDRlNzk1YjA3ODc4NWJmM2NmNzI5YWRhZTliNjM4OWY5YmM3",
    "commit": {
      "author": {
        "name": "Gleb Naumenko",
        "email": "naumenko.gs@gmail.com",
        "date": "2021-09-14T12:19:41Z"
      },
      "committer": {
        "name": "Gleb Naumenko",
        "email": "naumenko.gs@gmail.com",
        "date": "2021-09-15T09:02:23Z"
      },
      "message": "p2p: Account for MANUAL conns when diversifying persistent outbound conns\n\nPreviously, we would make connections to peer from the netgroups to which\nour MANUAL outbound connections belong.\nHowever, they should be seen as regular connections from Addrman when it comes to netgroup diversity check, since the same rationale can be applied.\n\nNote, this has nothing to do with how we connect to MANUAL connections:\nwe connect to them unconditionally.",
      "tree": {
        "sha": "e9f488703dbf122f4f07525fe0d97dc9f99ee75d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e9f488703dbf122f4f07525fe0d97dc9f99ee75d"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a87f04e795b078785bf3cf729adae9b6389f9bc7",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a87f04e795b078785bf3cf729adae9b6389f9bc7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a87f04e795b078785bf3cf729adae9b6389f9bc7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a87f04e795b078785bf3cf729adae9b6389f9bc7/comments",
    "author": {
      "login": "naumenkogs",
      "id": 7975071,
      "node_id": "MDQ6VXNlcjc5NzUwNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naumenkogs",
      "html_url": "https://github.com/naumenkogs",
      "followers_url": "https://api.github.com/users/naumenkogs/followers",
      "following_url": "https://api.github.com/users/naumenkogs/following{/other_user}",
      "gists_url": "https://api.github.com/users/naumenkogs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
      "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
      "repos_url": "https://api.github.com/users/naumenkogs/repos",
      "events_url": "https://api.github.com/users/naumenkogs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "naumenkogs",
      "id": 7975071,
      "node_id": "MDQ6VXNlcjc5NzUwNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naumenkogs",
      "html_url": "https://github.com/naumenkogs",
      "followers_url": "https://api.github.com/users/naumenkogs/followers",
      "following_url": "https://api.github.com/users/naumenkogs/following{/other_user}",
      "gists_url": "https://api.github.com/users/naumenkogs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
      "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
      "repos_url": "https://api.github.com/users/naumenkogs/repos",
      "events_url": "https://api.github.com/users/naumenkogs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "916d8f03c7fe9a8eb6c796756f69234406b98077",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/916d8f03c7fe9a8eb6c796756f69234406b98077",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/916d8f03c7fe9a8eb6c796756f69234406b98077"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 1,
      "deletions": 3
    },
    "files": [
      {
        "sha": "5b60355d10be46463e94e0f24d09122dd5a376c0",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 3,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a87f04e795b078785bf3cf729adae9b6389f9bc7/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a87f04e795b078785bf3cf729adae9b6389f9bc7/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=a87f04e795b078785bf3cf729adae9b6389f9bc7",
        "patch": "@@ -1914,16 +1914,14 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                     // free to make, an attacker could make them to prevent us from connecting to\n                     // certain peers.\n                     case ConnectionType::INBOUND:\n-                    // Manually selected connections should not affect how we select outbound\n-                    // peers from addrman.\n-                    case ConnectionType::MANUAL:\n                     // Short-lived outbound connections should not affect how we select outbound\n                     // peers from addrman.\n                     case ConnectionType::ADDR_FETCH:\n                     // Short-lived outbound connections should not affect how we select outbound\n                     // peers from addrman.\n                     case ConnectionType::FEELER:\n                         break;\n+                    case ConnectionType::MANUAL:\n                     case ConnectionType::OUTBOUND_FULL_RELAY:\n                     case ConnectionType::BLOCK_RELAY:\n                         setConnected.insert(pnode->addr.GetGroup(addrman.GetAsmap()));"
      }
    ]
  },
  {
    "sha": "aeec31d7b32b744fecb4115176a5d4e8586cdec2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphZWVjMzFkN2IzMmI3NDRmZWNiNDExNTE3NmE1ZDRlODU4NmNkZWMy",
    "commit": {
      "author": {
        "name": "Gleb Naumenko",
        "email": "naumenko.gs@gmail.com",
        "date": "2021-09-14T12:22:44Z"
      },
      "committer": {
        "name": "Gleb Naumenko",
        "email": "naumenko.gs@gmail.com",
        "date": "2021-09-15T09:07:39Z"
      },
      "message": "doc: peer selection rules do not apply to MANUAL and ADDR_FETCH",
      "tree": {
        "sha": "1e608747fd95b27dd25e583786af3c6b4f5090f3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1e608747fd95b27dd25e583786af3c6b4f5090f3"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/aeec31d7b32b744fecb4115176a5d4e8586cdec2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/aeec31d7b32b744fecb4115176a5d4e8586cdec2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/aeec31d7b32b744fecb4115176a5d4e8586cdec2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/aeec31d7b32b744fecb4115176a5d4e8586cdec2/comments",
    "author": {
      "login": "naumenkogs",
      "id": 7975071,
      "node_id": "MDQ6VXNlcjc5NzUwNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naumenkogs",
      "html_url": "https://github.com/naumenkogs",
      "followers_url": "https://api.github.com/users/naumenkogs/followers",
      "following_url": "https://api.github.com/users/naumenkogs/following{/other_user}",
      "gists_url": "https://api.github.com/users/naumenkogs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
      "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
      "repos_url": "https://api.github.com/users/naumenkogs/repos",
      "events_url": "https://api.github.com/users/naumenkogs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "naumenkogs",
      "id": 7975071,
      "node_id": "MDQ6VXNlcjc5NzUwNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7975071?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naumenkogs",
      "html_url": "https://github.com/naumenkogs",
      "followers_url": "https://api.github.com/users/naumenkogs/followers",
      "following_url": "https://api.github.com/users/naumenkogs/following{/other_user}",
      "gists_url": "https://api.github.com/users/naumenkogs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
      "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
      "repos_url": "https://api.github.com/users/naumenkogs/repos",
      "events_url": "https://api.github.com/users/naumenkogs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "a87f04e795b078785bf3cf729adae9b6389f9bc7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a87f04e795b078785bf3cf729adae9b6389f9bc7",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/a87f04e795b078785bf3cf729adae9b6389f9bc7"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 5,
      "deletions": 0
    },
    "files": [
      {
        "sha": "b8d0193714a09d271ba9597ce28d58315d43e59c",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/aeec31d7b32b744fecb4115176a5d4e8586cdec2/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/aeec31d7b32b744fecb4115176a5d4e8586cdec2/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=aeec31d7b32b744fecb4115176a5d4e8586cdec2",
        "patch": "@@ -2037,6 +2037,11 @@ void CConnman::ThreadOpenConnections(const std::vector<std::string> connect)\n                 addr = addrman.Select();\n             }\n \n+            // The following checks are never applied to MANUAL and ADDR_FETCH,\n+            // because those connections are made elsewhere.\n+            assert(conn_type != ConnectionType::MANUAL);\n+            assert(conn_type != ConnectionType::ADDR_FETCH);\n+\n             // Require outbound connections, other than feelers, to be to distinct network groups\n             if (!fFeeler && setConnected.count(addr.GetGroup(addrman.GetAsmap()))) {\n                 break;"
      }
    ]
  }
]