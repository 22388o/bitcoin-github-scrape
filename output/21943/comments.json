[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840631813",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-840631813",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 840631813,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0MDYzMTgxMw==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-13T15:17:05Z",
    "updated_at": "2021-11-19T11:16:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22829](https://github.com/bitcoin/bitcoin/pull/22829) (refactor: various RecursiveMutex replacements in CConnman by theStack)\n* [#21879](https://github.com/bitcoin/bitcoin/pull/21879) (Wrap accept() and extend usage of Sock by vasild)\n* [#21878](https://github.com/bitcoin/bitcoin/pull/21878) (Make all networking code mockable by vasild)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/840631813/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/841130784",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-841130784",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 841130784,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0MTEzMDc4NA==",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?u=71263a00d1269c7f0ed6660aa0c15c894df78a88&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-14T09:31:56Z",
    "updated_at": "2021-05-14T09:31:56Z",
    "author_association": "MEMBER",
    "body": "Concept ACK",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/841130784/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/841173328",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-841173328",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 841173328,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0MTE3MzMyOA==",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-14T11:00:18Z",
    "updated_at": "2021-05-14T11:00:18Z",
    "author_association": "CONTRIBUTOR",
    "body": "`644726117...92f62d9ea`: add an explicit commit that shows we intentionally don't process newly accepted nodes, as discussed in https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632150326",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/841173328/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/841617954",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-841617954",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 841617954,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0MTYxNzk1NA==",
    "user": {
      "login": "practicalswift",
      "id": 7826565,
      "node_id": "MDQ6VXNlcjc4MjY1NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7826565?u=5ff13e375b40ea55ecd3c108337dd6a23f68eddf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/practicalswift",
      "html_url": "https://github.com/practicalswift",
      "followers_url": "https://api.github.com/users/practicalswift/followers",
      "following_url": "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url": "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
      "organizations_url": "https://api.github.com/users/practicalswift/orgs",
      "repos_url": "https://api.github.com/users/practicalswift/repos",
      "events_url": "https://api.github.com/users/practicalswift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/practicalswift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-15T07:51:32Z",
    "updated_at": "2021-05-15T07:51:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "Concept ACK",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/841617954/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/842411377",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-842411377",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 842411377,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0MjQxMTM3Nw==",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-17T15:19:31Z",
    "updated_at": "2021-05-17T15:19:31Z",
    "author_association": "CONTRIBUTOR",
    "body": "`92f62d9...00a8c94`: address review suggestions",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/842411377/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865809778",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-865809778",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 865809778,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg2NTgwOTc3OA==",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-22T09:25:08Z",
    "updated_at": "2021-06-22T09:25:08Z",
    "author_association": "CONTRIBUTOR",
    "body": "`00a8c943d7...072896b7cf`: rebase due to conflicts",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/865809778/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/922506073",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-922506073",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 922506073,
    "node_id": "IC_kwDOABII5842_FNZ",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-19T17:08:55Z",
    "updated_at": "2021-09-19T17:08:55Z",
    "author_association": "MEMBER",
    "body": "Concept ACK, particularly if this can reduce `vNodes` lock contentions in these areas that are among the most frequent and long-lasting of those I'm seeing on my nodes with `-debug=lock`.\r\n\r\nIt looks like the CI stalled out on the last push. In any case, it rebases cleanly onto current master, the debug build is clean, and the unit/functional test suite is green for me locally. Reviewing.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/922506073/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/927096514",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-927096514",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 927096514,
    "node_id": "IC_kwDOABII5843Ql7C",
    "user": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?u=6a4a31aaddbc438e053c52d084a698a5f622f1ea&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-25T09:46:52Z",
    "updated_at": "2021-09-25T09:46:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "concept ACK ",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/927096514/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/928930542",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-928930542",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 928930542,
    "node_id": "IC_kwDOABII5843Xlru",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-28T07:29:44Z",
    "updated_at": "2021-09-28T07:34:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "`072896b7cf...a4fbf1ba59`: rebase and address review suggestions\r\n\r\nInvalidates ACK from @jonatack.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/928930542/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929004503",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-929004503",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 929004503,
    "node_id": "IC_kwDOABII5843X3vX",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-28T09:10:42Z",
    "updated_at": "2021-09-28T09:10:42Z",
    "author_association": "MEMBER",
    "body": "Diff-review ACK a4fbf1ba594b03379a65e780892b70bb7d4c1e4e per `git range-diff a9d0cec 072896b a4fbf1b` following my earlier full review (https://github.com/bitcoin/bitcoin/pull/21943#pullrequestreview-758400122) ",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929004503/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929201658",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-929201658",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 929201658,
    "node_id": "IC_kwDOABII5843Yn36",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-28T13:18:12Z",
    "updated_at": "2021-09-28T13:18:12Z",
    "author_association": "CONTRIBUTOR",
    "body": "`a4fbf1ba59...40e0bc8de2`: rebase and switch to `/*description=*/123` following https://github.com/bitcoin/bitcoin/pull/21943#discussion_r711994001.\r\n\r\nSorry for the noise, I hope no more changes to this PR.\r\n\r\nInvalidates ACKs from @jonatack, @promag.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929201658/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929213552",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-929213552",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 929213552,
    "node_id": "IC_kwDOABII5843Yqxw",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?u=0691974eedcc2ab5366cc1080fb1c030e87244c2&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-28T13:32:06Z",
    "updated_at": "2021-09-28T13:32:06Z",
    "author_association": "MEMBER",
    "body": "No need to invalidate ACKs. I was planning a scripted-diff some day to clean everything up, which would have covered this.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929213552/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929384060",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-929384060",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 929384060,
    "node_id": "IC_kwDOABII5843ZUZ8",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-28T16:24:03Z",
    "updated_at": "2021-09-28T16:24:03Z",
    "author_association": "MEMBER",
    "body": "Diff-review re-ACK 40e0bc8de29eab1aec4464e93fb42eccb9a81f5d following my earlier full review (https://github.com/bitcoin/bitcoin/pull/21943#pullrequestreview-758400122) ",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/929384060/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/938488261",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-938488261",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 938488261,
    "node_id": "IC_kwDOABII58438DHF",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-08T09:21:52Z",
    "updated_at": "2021-10-08T09:21:52Z",
    "author_association": "CONTRIBUTOR",
    "body": "`40e0bc8de2...99c1af5a8f`: rebase due to conflicts\r\n\r\nInvalidates ACK from @jonatack \r\n\r\nPreviously invalidated ACK from @promag \r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/938488261/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/951672368",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-951672368",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 951672368,
    "node_id": "IC_kwDOABII5844uV4w",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-26T08:10:39Z",
    "updated_at": "2021-10-26T08:34:26Z",
    "author_association": "CONTRIBUTOR",
    "body": "`99c1af5a8f...8589c55e27`: rebase and reorganize `CConnMan::SocketHandler()`, following comments from above: [1](https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632150326) and [2](https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725079584).\r\n\r\nAccepting new connections does not require the snapshot of the existing connected nodes, so make this explicit by accepting new connections after the snapshot has been destroyed, at the end of `CConnMan::SocketHandler()`. Move the pieces of code from `CConnMan::SocketHandler()` that handle existing connections and accept new ones into their own methods and call those methods from `CConnMan::SocketHandler()` to improve the readability.\r\n\r\nInvalidates ACK from @jonatack\r\n\r\nPreviously invalidated ACK from @promag",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/951672368/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/966969216",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-966969216",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 966969216,
    "node_id": "IC_kwDOABII5845oseA",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-12T09:54:17Z",
    "updated_at": "2021-11-12T09:54:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "`8589c55e27...db0a01e0d1`: remove unnecessary `interruptNet` check from `SocketEvents()`, add such a check to `SocketHandlerListening()`. Thanks, @promag, https://github.com/bitcoin/bitcoin/pull/21943#discussion_r738379450 !\r\n\r\nInvalidates ACK from @promag \r\n\r\nPreviously invalidated ACK from @jonatack ",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/966969216/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/972830829",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-972830829",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 972830829,
    "node_id": "IC_kwDOABII5845_Dht",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?u=d06d2903ce6ad8b9d0c66ef9225fa21adfe22c7f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-18T12:41:45Z",
    "updated_at": "2021-11-18T12:51:11Z",
    "author_association": "CONTRIBUTOR",
    "body": "`db0a01e0d1...f52b6b2d9f`: pick nits\r\n\r\nInvalidates ACK from @promag\r\n\r\nPreviously invalidated ACK from @jonatack",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/972830829/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/977201905",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-977201905",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 977201905,
    "node_id": "IC_kwDOABII5846Purx",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-23T21:55:24Z",
    "updated_at": "2021-11-23T21:56:19Z",
    "author_association": "MEMBER",
    "body": "ACK  f52b6b2d9f482353821da0ef4c485c402a396c8d changes since last review are reordered commits, removing an unneeded local variable, and code formatting and documentation improvements ",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/977201905/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/978053383",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-978053383",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21943",
    "id": 978053383,
    "node_id": "IC_kwDOABII5846S-kH",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?u=13b19d1ff2f5f914e180c41418f451a4ba6f8bd1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-24T16:50:17Z",
    "updated_at": "2021-11-24T16:50:17Z",
    "author_association": "MEMBER",
    "body": "Looks like github didn't detect the merge, closing.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/978053383/reactions",
      "total_count": 2,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 2,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632150326",
    "pull_request_review_id": 659359605,
    "id": 632150326,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjE1MDMyNg==",
    "diff_hunk": "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 61,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "157674ef213e6329215d1b7eb85dacbc23c468db",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "157674ef213e6329215d1b7eb85dacbc23c468db\r\n\r\nThis snap catches nodes added in the above `AcceptConnection` where the new snap at the beginning doesn't. Is this intentional?",
    "created_at": "2021-05-13T22:50:29Z",
    "updated_at": "2021-05-13T22:50:43Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632150326",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632150326"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632150326"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632150326/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1470,
    "side": "LEFT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632355737",
    "pull_request_review_id": 659612587,
    "id": 632355737,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjM1NTczNw==",
    "diff_hunk": "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 61,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "157674ef213e6329215d1b7eb85dacbc23c468db",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Hmm, good catch! No, that is not intentional.\r\n\r\nSo, the previous code did:\r\n\r\n1. `SocketEvents()`, adding ready sockets from `vNodes` to `{recv,send,error}_set`.\r\n2. `AcceptConnection()`, adding new entries to `vNodes`.\r\n3. Loop over `vNodes`, for each node:\r\n3.1. Check whether its socket is in one of `{recv,send,error}_set`. Observation - the sockets of nodes that were added in 2. will not be in any of `{recv,send,error}_set`, so for them all of `recvSet`, `sendSet` and `errorSet` will be `false`.\r\n3.2. `InactivityCheck()` - will also be done for nodes added in 2.\r\n\r\nThe new code will skip nodes added in 2. in the 3. loop. That's the same as the old code with respect to 3.1. The only difference is that the new code will not do `InactivityCheck()` for newly accepted nodes. I think that is ok because it is unlikely that a newly accepted peer would be considered inactive. In the rare case where this might have happened in the old code and will not happen in the new code, the new code will do the check on the next call to `SocketHandler()`.\r\n\r\nWhat do you think? Leave it as is or somehow ensure that new and old behave in an identical way?",
    "created_at": "2021-05-14T08:01:48Z",
    "updated_at": "2021-05-14T08:01:48Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632355737",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632355737"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632355737"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632355737/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1470,
    "side": "LEFT",
    "in_reply_to_id": 632150326
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632360108",
    "pull_request_review_id": 659617416,
    "id": 632360108,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjM2MDEwOA==",
    "diff_hunk": "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 61,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "157674ef213e6329215d1b7eb85dacbc23c468db",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "if `InactivityCheck` for new nodes is pointless then maybe move `// Accept new connections` to the end?",
    "created_at": "2021-05-14T08:08:49Z",
    "updated_at": "2021-05-14T08:08:49Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632360108",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632360108"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632360108"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632360108/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1470,
    "side": "LEFT",
    "in_reply_to_id": 632150326
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632451114",
    "pull_request_review_id": 659736046,
    "id": 632451114,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjQ1MTExNA==",
    "diff_hunk": "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 61,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "157674ef213e6329215d1b7eb85dacbc23c468db",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Added an explicit commit (a71b3f426) to show the intention. Putting the accept at the end somehow looked strange to me.\r\n\r\nMaybe these two actions deserve to be split in separate functions (ie split `SocketHandler()`): 1. checking which of the listening sockets are ready for IO and accepting connections on them and 2. checking which of the already connected sockets are ready for IO and processing them. Would require even more changes.",
    "created_at": "2021-05-14T10:58:33Z",
    "updated_at": "2021-05-14T10:58:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632451114",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632451114"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632451114"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632451114/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1470,
    "side": "LEFT",
    "in_reply_to_id": 632150326
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632622357",
    "pull_request_review_id": 659968284,
    "id": 632622357,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjYyMjM1Nw==",
    "diff_hunk": "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 61,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "157674ef213e6329215d1b7eb85dacbc23c468db",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Since you are not splitting maybe add a comment for now like `// Take a snapshot of current nodes before acceptation new ones - new nodes are irrelevant below` or something like that.",
    "created_at": "2021-05-14T15:45:27Z",
    "updated_at": "2021-05-14T15:45:27Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632622357",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632622357"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632622357"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632622357/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1470,
    "side": "LEFT",
    "in_reply_to_id": 632150326
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632651133",
    "pull_request_review_id": 660007293,
    "id": 632651133,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjY1MTEzMw==",
    "diff_hunk": "@@ -1451,8 +1447,10 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    NodesSnapshot snap{*this};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 109,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Could we move this call to `SocketEvents()` to below the _Accept new connections_ logic? I think it's simpler to reason about if we're not holding the nodes snapshot across the _Accept new connections_ logic.",
    "created_at": "2021-05-14T16:30:39Z",
    "updated_at": "2021-05-14T16:30:40Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632651133",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632651133"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632651133"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632651133/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1500,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632966401",
    "pull_request_review_id": 660365073,
    "id": 632966401,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk2NjQwMQ==",
    "diff_hunk": "@@ -1451,8 +1447,10 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    NodesSnapshot snap{*this};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 109,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Sorry, ignore this. I've just realized that the _Accept new connections_ logic is using the `recv_set` that's populated by `SocketEvents()`.",
    "created_at": "2021-05-15T14:58:09Z",
    "updated_at": "2021-05-15T14:58:10Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632966401",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632966401"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632966401"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632966401/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1500,
    "side": "RIGHT",
    "in_reply_to_id": 632651133
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972362",
    "pull_request_review_id": 660366732,
    "id": 632972362,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk3MjM2Mg==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
    "path": "src/net.h",
    "position": 68,
    "original_position": 38,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "amitiuttarwar",
      "id": 1500952,
      "node_id": "MDQ6VXNlcjE1MDA5NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1500952?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/amitiuttarwar",
      "html_url": "https://github.com/amitiuttarwar",
      "followers_url": "https://api.github.com/users/amitiuttarwar/followers",
      "following_url": "https://api.github.com/users/amitiuttarwar/following{/other_user}",
      "gists_url": "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/amitiuttarwar/subscriptions",
      "organizations_url": "https://api.github.com/users/amitiuttarwar/orgs",
      "repos_url": "https://api.github.com/users/amitiuttarwar/repos",
      "events_url": "https://api.github.com/users/amitiuttarwar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/amitiuttarwar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I'm guessing you've defined this class within `CConnman` to enable access to the private members. You could instead define the class in `net.cpp` as a standalone by making `vNodes` and `cs_vNodes` protected & declaring `friend class NodesSnapshot` here. Seems nice to keep this mechanism that's only used internally out of the header file.\r\n\r\ndiff \ud83d\udc47\ud83c\udffd\r\n(also includes constifying `m_nodes_copy`)\r\n```diff \r\ndiff --git a/src/net.cpp b/src/net.cpp\r\nindex 5fd1bf754d..6040ee86be 100644\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -110,6 +110,39 @@ std::map<CNetAddr, LocalServiceInfo> mapLocalHost GUARDED_BY(cs_mapLocalHost);\r\n static bool vfLimited[NET_MAX] GUARDED_BY(cs_mapLocalHost) = {};\r\n std::string strSubVersion;\r\n\r\n+/**\r\n+ * RAII helper to atomically create a copy of `vNodes` and add a reference\r\n+ * to each of the nodes. The nodes are released when this object is destroyed.\r\n+ */\r\n+class NodesSnapshot\r\n+{\r\n+    public:\r\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}, m_nodes_copy{m_connman.vNodes}\r\n+        {\r\n+            LOCK(m_connman.cs_vNodes);\r\n+            for (auto& node : m_nodes_copy) {\r\n+                node->AddRef();\r\n+            }\r\n+        }\r\n+\r\n+        ~NodesSnapshot()\r\n+        {\r\n+            LOCK(m_connman.cs_vNodes);\r\n+            for (auto& node : m_nodes_copy) {\r\n+                node->Release();\r\n+            }\r\n+        }\r\n+\r\n+        const std::vector<CNode*>& Nodes() const\r\n+        {\r\n+            return m_nodes_copy;\r\n+        }\r\n+\r\n+    private:\r\n+        const CConnman& m_connman;\r\n+        const CConnman& m_connman;\r\n+        const std::vector<CNode*> m_nodes_copy;\r\n+};\r\n+\r\n void CConnman::AddAddrFetch(const std::string& strDest)\r\n {\r\n     LOCK(m_addr_fetches_mutex);\r\ndiff --git a/src/net.h b/src/net.h\r\nindex 846c4c0ece..f39c46c166 100644\r\n--- a/src/net.h\r\n+++ b/src/net.h\r\n@@ -1021,6 +1021,10 @@ public:\r\n     /** Return true if we should disconnect the peer for failing an inactivity check. */\r\n     bool ShouldRunInactivityChecks(const CNode& node, std::optional<int64_t> now=std::nullopt) const;\r\n\r\n+protected:\r\n+    std::vector<CNode*> vNodes GUARDED_BY(cs_vNodes);\r\n+    mutable RecursiveMutex cs_vNodes;\r\n+\r\n private:\r\n     struct ListenSocket {\r\n     public:\r\n@@ -1153,9 +1157,7 @@ private:\r\n     RecursiveMutex m_addr_fetches_mutex;\r\n     std::vector<std::string> vAddedNodes GUARDED_BY(cs_vAddedNodes);\r\n     mutable RecursiveMutex cs_vAddedNodes;\r\n-    std::vector<CNode*> vNodes GUARDED_BY(cs_vNodes);\r\n     std::list<CNode*> vNodesDisconnected;\r\n-    mutable RecursiveMutex cs_vNodes;\r\n     std::atomic<NodeId> nLastNodeId{0};\r\n     unsigned int nPrevNodeCount{0};\r\n\r\n@@ -1276,40 +1278,7 @@ private:\r\n      */\r\n     std::vector<CService> m_onion_binds;\r\n\r\n-    /**\r\n-     * RAII helper to atomically create a copy of `vNodes` and add a reference\r\n-     * to each of the nodes. The nodes are released when this object is destroyed.\r\n-     */\r\n-    class NodesSnapshot\r\n-    {\r\n-    public:\r\n-        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\r\n-        {\r\n-            LOCK(m_connman.cs_vNodes);\r\n-            m_nodes_copy = m_connman.vNodes;\r\n-            for (auto& node : m_nodes_copy) {\r\n-                node->AddRef();\r\n-            }\r\n-        }\r\n-\r\n-        ~NodesSnapshot()\r\n-        {\r\n-            LOCK(m_connman.cs_vNodes);\r\n-            for (auto& node : m_nodes_copy) {\r\n-                node->Release();\r\n-            }\r\n-        }\r\n-\r\n-        const std::vector<CNode*>& Nodes() const\r\n-        {\r\n-            return m_nodes_copy;\r\n-        }\r\n-\r\n-    private:\r\n-        const CConnman& m_connman;\r\n-        std::vector<CNode*> m_nodes_copy;\r\n-    };\r\n-\r\n+    friend class NodesSnapshot;\r\n     friend struct CConnmanTest;\r\n     friend struct ConnmanTestMsg;\r\n };\r\n```",
    "created_at": "2021-05-15T15:20:46Z",
    "updated_at": "2021-05-15T15:49:22Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972362",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972362"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972362"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972362/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1232,
    "original_line": 1232,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972531",
    "pull_request_review_id": 660366732,
    "id": 632972531,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk3MjUzMQ==",
    "diff_hunk": "@@ -1451,8 +1447,10 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    NodesSnapshot snap{*this};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 105,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "amitiuttarwar",
      "id": 1500952,
      "node_id": "MDQ6VXNlcjE1MDA5NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1500952?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/amitiuttarwar",
      "html_url": "https://github.com/amitiuttarwar",
      "followers_url": "https://api.github.com/users/amitiuttarwar/followers",
      "following_url": "https://api.github.com/users/amitiuttarwar/following{/other_user}",
      "gists_url": "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/amitiuttarwar/subscriptions",
      "organizations_url": "https://api.github.com/users/amitiuttarwar/orgs",
      "repos_url": "https://api.github.com/users/amitiuttarwar/repos",
      "events_url": "https://api.github.com/users/amitiuttarwar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/amitiuttarwar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n    const NodesSnapshot snap{*this};\r\n```",
    "created_at": "2021-05-15T15:22:20Z",
    "updated_at": "2021-05-15T15:48:50Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972531",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972531"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972531"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972531/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1450,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972552",
    "pull_request_review_id": 660366732,
    "id": 632972552,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk3MjU1Mg==",
    "diff_hunk": "@@ -2174,41 +2159,29 @@ void CConnman::ThreadMessageHandler()\n {\n     while (!flagInterruptMsgProc)\n     {\n-        std::vector<CNode*> vNodesCopy;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy) {\n-                pnode->AddRef();\n-            }\n-        }\n-\n         bool fMoreWork = false;\n \n-        for (CNode* pnode : vNodesCopy)\n         {\n-            if (pnode->fDisconnect)\n-                continue;\n+            NodesSnapshot snap{*this};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 161,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "amitiuttarwar",
      "id": 1500952,
      "node_id": "MDQ6VXNlcjE1MDA5NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1500952?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/amitiuttarwar",
      "html_url": "https://github.com/amitiuttarwar",
      "followers_url": "https://api.github.com/users/amitiuttarwar/followers",
      "following_url": "https://api.github.com/users/amitiuttarwar/following{/other_user}",
      "gists_url": "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/amitiuttarwar/subscriptions",
      "organizations_url": "https://api.github.com/users/amitiuttarwar/orgs",
      "repos_url": "https://api.github.com/users/amitiuttarwar/repos",
      "events_url": "https://api.github.com/users/amitiuttarwar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/amitiuttarwar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n            const NodesSnapshot snap{*this};\r\n```",
    "created_at": "2021-05-15T15:22:32Z",
    "updated_at": "2021-05-15T15:48:50Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972552",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972552"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972552"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632972552/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2165,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632973688",
    "pull_request_review_id": 660366732,
    "id": 632973688,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk3MzY4OA==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const\n+        {\n+            return m_nodes_copy;\n+        }\n+\n+    private:\n+        const CConnman& m_connman;\n+        std::vector<CNode*> m_nodes_copy;",
    "path": "src/net.h",
    "position": 98,
    "original_position": 65,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "amitiuttarwar",
      "id": 1500952,
      "node_id": "MDQ6VXNlcjE1MDA5NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1500952?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/amitiuttarwar",
      "html_url": "https://github.com/amitiuttarwar",
      "followers_url": "https://api.github.com/users/amitiuttarwar/followers",
      "following_url": "https://api.github.com/users/amitiuttarwar/following{/other_user}",
      "gists_url": "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/amitiuttarwar/subscriptions",
      "organizations_url": "https://api.github.com/users/amitiuttarwar/orgs",
      "repos_url": "https://api.github.com/users/amitiuttarwar/repos",
      "events_url": "https://api.github.com/users/amitiuttarwar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/amitiuttarwar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n        const std::vector<CNode*> m_nodes_copy;\r\n```\r\n\r\nCan `const` this if you add the constructor assignment to the initializer list (done in https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632972362 diff) ",
    "created_at": "2021-05-15T15:33:32Z",
    "updated_at": "2021-05-15T15:49:43Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632973688",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632973688"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632973688"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632973688/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1262,
    "original_line": 1262,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632974904",
    "pull_request_review_id": 660366732,
    "id": 632974904,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk3NDkwNA==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();",
    "path": "src/net.h",
    "position": 88,
    "original_position": 54,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "amitiuttarwar",
      "id": 1500952,
      "node_id": "MDQ6VXNlcjE1MDA5NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1500952?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/amitiuttarwar",
      "html_url": "https://github.com/amitiuttarwar",
      "followers_url": "https://api.github.com/users/amitiuttarwar/followers",
      "following_url": "https://api.github.com/users/amitiuttarwar/following{/other_user}",
      "gists_url": "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/amitiuttarwar/subscriptions",
      "organizations_url": "https://api.github.com/users/amitiuttarwar/orgs",
      "repos_url": "https://api.github.com/users/amitiuttarwar/repos",
      "events_url": "https://api.github.com/users/amitiuttarwar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/amitiuttarwar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I see that you haven't changed the behavior here, but I'm curious about the pre-existing logic: \r\n\r\nIs it necessary for `Release()` to be under the lock? \r\n\r\nIt makes sense that `AddRef` has to be under the lock so there isn't a race between a thread that is trying to operate on the node, and a thread that is evaluating for disconnect. However, with `Release`, I don't think there is actually potential for a race.. if `GetRefCount` returns > 0, `DisconnectNodes` will delay processing it. And since `nRefCount` is atomic, it shouldn't be a problem if multiple threads are trying to increment / decrement at the same time. Does this reasoning seem sound? Am I missing something? \r\n\r\ncc @narula ",
    "created_at": "2021-05-15T15:44:42Z",
    "updated_at": "2021-05-15T16:03:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632974904",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632974904"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632974904"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632974904/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1252,
    "original_line": 1252,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632986434",
    "pull_request_review_id": 660376603,
    "id": 632986434,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk4NjQzNA==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
    "path": "src/net.h",
    "position": 68,
    "original_position": 38,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I like this. A few notes:\r\n\r\n- the diff as shown is corrupted (contains the `+        const CConnman& m_connman;` line twice) and so doesn't apply with `git apply`.\r\n- `vNodes` and `cs_vNodes` don't need to change to be protected. Friend classes have access to private members.\r\n- `NodesSnapshot` can be in the unnamed namespace since it's only needed in the net.cpp translation unit.",
    "created_at": "2021-05-15T17:38:06Z",
    "updated_at": "2021-05-15T17:38:06Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632986434",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632986434"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632986434"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632986434/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1232,
    "original_line": 1232,
    "side": "RIGHT",
    "in_reply_to_id": 632972362
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632987235",
    "pull_request_review_id": 660377240,
    "id": 632987235,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk4NzIzNQ==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
    "path": "src/net.h",
    "position": 68,
    "original_position": 38,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The `m_nodes_copy{m_connman.vNodes}` in the initializer list is accessing `vNodes` without the `cs_vNodes` lock. You could update it to take the lock:\r\n\r\n```diff\r\ndiff --git a/src/net.cpp b/src/net.cpp\r\nindex 6040ee86be..d39aa14b20 100644\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -117,7 +117,9 @@ std::string strSubVersion;\r\n class NodesSnapshot\r\n {\r\n     public:\r\n-        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}, m_nodes_copy{m_connman.vNodes}\r\n+        explicit NodesSnapshot(const CConnman& connman) :\r\n+            m_connman{connman},\r\n+            m_nodes_copy{WITH_LOCK(m_connman.cs_vNodes, return m_connman.vNodes;)}\r\n         {\r\n             LOCK(m_connman.cs_vNodes);\r\n             for (auto& node : m_nodes_copy) {\r\n```\r\n\r\nBut that would introduce a race condition if another thread deleted a node between the initializer list and the ctor being run.\r\n\r\nI think better just to assign `m_nodes_copy` in the ctor.",
    "created_at": "2021-05-15T17:47:12Z",
    "updated_at": "2021-05-15T17:47:13Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632987235",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632987235"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632987235"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632987235/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1232,
    "original_line": 1232,
    "side": "RIGHT",
    "in_reply_to_id": 632972362
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632987838",
    "pull_request_review_id": 660377592,
    "id": 632987838,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk4NzgzOA==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();",
    "path": "src/net.h",
    "position": 88,
    "original_position": 54,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think this is correct. There's no need to hold `cs_vNodes` when calling `node->Release();`\r\n\r\nRemoving this lock means that the `m_connman` member is no longer required.",
    "created_at": "2021-05-15T17:52:59Z",
    "updated_at": "2021-05-15T17:52:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632987838",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632987838"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632987838"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632987838/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1252,
    "original_line": 1252,
    "side": "RIGHT",
    "in_reply_to_id": 632974904
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632989196",
    "pull_request_review_id": 660378433,
    "id": 632989196,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjk4OTE5Ng==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const",
    "path": "src/net.h",
    "position": 92,
    "original_position": 58,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "What do you think about just wrapping the m_nodes_copy `begin()` and `end()` functions:\r\n\r\n```diff\r\ndiff --git a/src/net.cpp b/src/net.cpp\r\nindex 6040ee86be..5388af02e3 100644\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -116,6 +116,10 @@ std::string strSubVersion;\r\n  */\r\n class NodesSnapshot\r\n {\r\n+    private:\r\n+        const CConnman& m_connman;\r\n+        const std::vector<CNode*> m_nodes_copy;\r\n+\r\n     public:\r\n         explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}, m_nodes_copy{m_connman.vNodes}\r\n         {\r\n@@ -133,14 +137,18 @@ class NodesSnapshot\r\n             }\r\n         }\r\n \r\n-        const std::vector<CNode*>& Nodes() const\r\n+        using iterator = decltype(m_nodes_copy.begin());\r\n+\r\n+        iterator begin()\r\n         {\r\n-            return m_nodes_copy;\r\n+            return m_nodes_copy.begin();\r\n+        }\r\n+\r\n+        iterator end()\r\n+        {\r\n+            return m_nodes_copy.end();\r\n         }\r\n \r\n-    private:\r\n-        const CConnman& m_connman;\r\n-        const std::vector<CNode*> m_nodes_copy;\r\n };\r\n```\r\n\r\nand then the client code can use a `NodeSnapshot` in range-based loops, eg:\r\n\r\n```diff\r\n\u2192 git d\r\ndiff --git a/src/net.cpp b/src/net.cpp\r\nindex 6040ee86be..5388af02e3 100644\r\n--- a/src/net.cpp\r\n+++ b/src/net.cpp\r\n@@ -1501,7 +1509,7 @@ void CConnman::SocketHandler()\r\n     //\r\n     // Service each socket\r\n     //\r\n-    for (CNode* pnode : snap.Nodes()) {\r\n+    for (CNode* pnode : snap) {\r\n         if (interruptNet)\r\n             return;\r\n \r\n```",
    "created_at": "2021-05-15T18:07:45Z",
    "updated_at": "2021-05-15T18:07:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632989196",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632989196"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632989196"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632989196/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1256,
    "original_line": 1256,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633599186",
    "pull_request_review_id": 661060828,
    "id": 633599186,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzU5OTE4Ng==",
    "diff_hunk": "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 61,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "157674ef213e6329215d1b7eb85dacbc23c468db",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Right, a comment is warranted. Added:\r\n\r\n```cpp\r\n    // Accept new connections. Done after taking a snapshot of the nodes because\r\n    // `AcceptConnection()` will add new entries to `vNodes` which are unwanted\r\n    // in the loop below because:\r\n    // - all of `recvSet`, `sendSet` and `errorSet` will be `false` for them\r\n    // - `InactivityCheck()` will either be a noop or will wrongly command to\r\n    //   disconnect the node before we have tried sending or receiving anything\r\n    //   to it.\r\n```",
    "created_at": "2021-05-17T14:48:38Z",
    "updated_at": "2021-05-17T14:48:39Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633599186",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633599186"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633599186"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633599186/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1470,
    "side": "LEFT",
    "in_reply_to_id": 632150326
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633613085",
    "pull_request_review_id": 661079909,
    "id": 633613085,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYxMzA4NQ==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
    "path": "src/net.h",
    "position": 68,
    "original_position": 38,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> I'm guessing you've defined this class within CConnman to enable access to the private members.\r\n\r\nNo, I did it to minimize the scope of the newly added class.\r\n\r\n> Seems nice to keep this mechanism that's only used internally out of the header file.\r\n\r\nWhy? It is used internally by `CConnman` and is defined in its `private:` section. If defined in `net.cpp` that would broaden its scope unnecessary.",
    "created_at": "2021-05-17T15:04:40Z",
    "updated_at": "2021-05-17T15:04:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633613085",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633613085"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633613085"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633613085/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1232,
    "original_line": 1232,
    "side": "RIGHT",
    "in_reply_to_id": 632972362
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633614762",
    "pull_request_review_id": 661082288,
    "id": 633614762,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYxNDc2Mg==",
    "diff_hunk": "@@ -1451,8 +1447,10 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    NodesSnapshot snap{*this};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 105,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done.",
    "created_at": "2021-05-17T15:06:47Z",
    "updated_at": "2021-05-17T15:06:47Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633614762",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633614762"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633614762"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633614762/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1450,
    "side": "RIGHT",
    "in_reply_to_id": 632972531
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633614896",
    "pull_request_review_id": 661082490,
    "id": 633614896,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYxNDg5Ng==",
    "diff_hunk": "@@ -2174,41 +2159,29 @@ void CConnman::ThreadMessageHandler()\n {\n     while (!flagInterruptMsgProc)\n     {\n-        std::vector<CNode*> vNodesCopy;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy) {\n-                pnode->AddRef();\n-            }\n-        }\n-\n         bool fMoreWork = false;\n \n-        for (CNode* pnode : vNodesCopy)\n         {\n-            if (pnode->fDisconnect)\n-                continue;\n+            NodesSnapshot snap{*this};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 161,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done.",
    "created_at": "2021-05-17T15:06:57Z",
    "updated_at": "2021-05-17T15:06:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633614896",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633614896"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633614896"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633614896/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2165,
    "side": "RIGHT",
    "in_reply_to_id": 632972552
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633616340",
    "pull_request_review_id": 661084484,
    "id": 633616340,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYxNjM0MA==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const\n+        {\n+            return m_nodes_copy;\n+        }\n+\n+    private:\n+        const CConnman& m_connman;\n+        std::vector<CNode*> m_nodes_copy;",
    "path": "src/net.h",
    "position": 98,
    "original_position": 65,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The copying and `AddRef()` should be done under the lock.",
    "created_at": "2021-05-17T15:08:39Z",
    "updated_at": "2021-05-17T15:08:39Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633616340",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633616340"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633616340"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633616340/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1262,
    "original_line": 1262,
    "side": "RIGHT",
    "in_reply_to_id": 632973688
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633617646",
    "pull_request_review_id": 661087509,
    "id": 633617646,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYxNzY0Ng==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();",
    "path": "src/net.h",
    "position": 88,
    "original_position": 54,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> Is it necessary for `Release()` to be under the lock?\r\n\r\nThe lock has two effects:\r\n* All `Release()`s happen atomically together. If removed, then other threads could observe some nodes from the snapshot released and some not yet released. I think that is ok.\r\n* No memory reordering can happen. The `nRefCount--` on the atomic variable has the same effect because `--` is equivalent to [`fetch_sub()`](https://en.cppreference.com/w/cpp/atomic/atomic/fetch_sub) which uses [`memory_order_seq_cst`](https://en.cppreference.com/w/cpp/atomic/memory_order) by default.\r\n\r\n\r\nRemoved the lock and simplified `NodesSnapshot`, thanks!",
    "created_at": "2021-05-17T15:10:02Z",
    "updated_at": "2021-05-17T15:10:02Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633617646",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633617646"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633617646"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633617646/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1252,
    "original_line": 1252,
    "side": "RIGHT",
    "in_reply_to_id": 632974904
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633625021",
    "pull_request_review_id": 661096340,
    "id": 633625021,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYyNTAyMQ==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const",
    "path": "src/net.h",
    "position": 92,
    "original_position": 58,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think both ways would work.\r\n\r\nThe begin/end variant seems to be a bit more code - it saves just `.Nodes()` from the callers but has two methods and is also less friendly to grepping and code navigation - now I can point my \"IDE\" to `Nodes()` on the line `for (CNode* pnode : snap.Nodes()) {` and see what it returns or its definition. Not so with the `for (CNode* pnode : snap) {` line.\r\n\r\nThat said, I am fine either way but have a slight preference for the `.Nodes()` variant.",
    "created_at": "2021-05-17T15:17:35Z",
    "updated_at": "2021-05-17T15:17:36Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633625021",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633625021"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633625021"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633625021/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1256,
    "original_line": 1256,
    "side": "RIGHT",
    "in_reply_to_id": 632989196
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633628981",
    "pull_request_review_id": 661101634,
    "id": 633628981,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzYyODk4MQ==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const",
    "path": "src/net.h",
    "position": 92,
    "original_position": 58,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "No strong preference. Just pointing out an alternative. I'll mark this as resolved.",
    "created_at": "2021-05-17T15:22:19Z",
    "updated_at": "2021-05-17T15:22:19Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633628981",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633628981"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633628981"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633628981/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1256,
    "original_line": 1256,
    "side": "RIGHT",
    "in_reply_to_id": 632989196
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633891308",
    "pull_request_review_id": 661454158,
    "id": 633891308,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMzg5MTMwOA==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const\n+        {\n+            return m_nodes_copy;\n+        }\n+\n+    private:\n+        const CConnman& m_connman;\n+        std::vector<CNode*> m_nodes_copy;",
    "path": "src/net.h",
    "position": 98,
    "original_position": 65,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Why `AddRef`? @amitiuttarwar suggestion can be accomplished with\r\n```diff\r\n         explicit NodesSnapshot(const CConnman& connman)\r\n+            : m_nodes_copy(WITH_LOCK(connman.cs_vNodes, return connman.vNodes))\r\n         {\r\n-            LOCK(connman.cs_vNodes);\r\n-            m_nodes_copy = connman.vNodes;\r\n             for (auto& node : m_nodes_copy) {\r\n                 node->AddRef();\r\n             }\r\n@@ -1305,7 +1304,7 @@ private:\r\n         }\r\n\r\n     private:\r\n-        std::vector<CNode*> m_nodes_copy;\r\n+        const std::vector<CNode*> m_nodes_copy;\r\n     };\r\n```\r\n\r\nNever mind, I see why `AddRef` needs to be under the lock. It's still possible to use the `WITH_LOCK` approach so `m_nodes_copy` could be is const, but not worth it IMO.",
    "created_at": "2021-05-17T21:50:41Z",
    "updated_at": "2021-05-17T21:53:25Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633891308",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633891308"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r633891308"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/633891308/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1262,
    "original_line": 1262,
    "side": "RIGHT",
    "in_reply_to_id": 632973688
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634141685",
    "pull_request_review_id": 661765027,
    "id": 634141685,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDE0MTY4NQ==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();\n+            }\n+        }\n+\n+        const std::vector<CNode*>& Nodes() const\n+        {\n+            return m_nodes_copy;\n+        }\n+\n+    private:\n+        const CConnman& m_connman;\n+        std::vector<CNode*> m_nodes_copy;",
    "path": "src/net.h",
    "position": 98,
    "original_position": 65,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yeah :) `AddRef()` needs to be under the same lock that did the copy (without release in between) because otherwise some of the copied elements may be destroyed in the meantime and `node->` to try to dereference a dangling pointer while trying to call `AddRef()`.\r\n\r\nIt should work with something like\r\n```cpp\r\nexplicit NodesSnapshot(const CConnman& connman)\r\n            : m_nodes_copy(WITH_LOCK(connman.cs_vNodes, for (auto& node : connman.vNodes) { node->AddRef(); } ; return connman.vNodes))\r\n```\r\n\r\nbut that is not worth it indeed :)",
    "created_at": "2021-05-18T08:04:05Z",
    "updated_at": "2021-05-18T08:04:05Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634141685",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634141685"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634141685"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634141685/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1262,
    "original_line": 1262,
    "side": "RIGHT",
    "in_reply_to_id": 632973688
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634196764",
    "pull_request_review_id": 661837870,
    "id": 634196764,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDE5Njc2NA==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
    "path": "src/net.h",
    "position": 68,
    "original_position": 38,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> > Seems nice to keep this mechanism that's only used internally out of the header file.\r\n\r\n> Why?\r\n\r\nBecause it's good to keep header files limited to what's required to be included into other translation units (as far as is possible). That's beneficial for both build time and code management reasons.\r\n\r\nI think both ways are fine, and that eventually we'll want to virtualize both `CNode`'s and `CConnman`'s public interfaces so that they can be mocked out for testing, at which point the private methods could all be moved to the implementation file.",
    "created_at": "2021-05-18T09:15:34Z",
    "updated_at": "2021-05-18T09:15:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634196764",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634196764"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634196764"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634196764/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1232,
    "original_line": 1232,
    "side": "RIGHT",
    "in_reply_to_id": 632972362
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634254981",
    "pull_request_review_id": 661915095,
    "id": 634254981,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDI1NDk4MQ==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
    "path": "src/net.h",
    "position": 68,
    "original_position": 38,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> That's beneficial for both build time...\r\n\r\nI do not think it is justified to put private class members as globals in the `.cpp` file in order to minimize the header file so that it compiles faster.\r\n\r\n> ... and code management reasons.\r\n\r\nUnnecessary broadened scope has an adverse effect on code management.",
    "created_at": "2021-05-18T10:35:22Z",
    "updated_at": "2021-05-18T10:35:22Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634254981",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634254981"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634254981"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634254981/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1232,
    "original_line": 1232,
    "side": "RIGHT",
    "in_reply_to_id": 632972362
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634777026",
    "pull_request_review_id": 662612291,
    "id": 634777026,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNDc3NzAyNg==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
    "path": "src/net.h",
    "position": 68,
    "original_position": 38,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "amitiuttarwar",
      "id": 1500952,
      "node_id": "MDQ6VXNlcjE1MDA5NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1500952?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/amitiuttarwar",
      "html_url": "https://github.com/amitiuttarwar",
      "followers_url": "https://api.github.com/users/amitiuttarwar/followers",
      "following_url": "https://api.github.com/users/amitiuttarwar/following{/other_user}",
      "gists_url": "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/amitiuttarwar/subscriptions",
      "organizations_url": "https://api.github.com/users/amitiuttarwar/orgs",
      "repos_url": "https://api.github.com/users/amitiuttarwar/repos",
      "events_url": "https://api.github.com/users/amitiuttarwar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/amitiuttarwar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "If `NodesSnapshot` was defined as a standalone class in `net.cpp`, it could be added to the unnamed namespace so it would only be accessible within the same translation unit, but it would broaden the scope beyond `CConnman` to within the translation unit. \r\n\r\nMy preference for it to be in the `.cpp` is because I find it easier to understand responsibilities & maneuver the files when the headers capture the way the classes interact with external callers. But I totally understand the point about broadening scope, and think this ultimately comes down to a preference.\r\n\r\nI'm going to resolve this conversation, thanks for the feedback @vasild & @jnewbery :) ",
    "created_at": "2021-05-18T22:00:44Z",
    "updated_at": "2021-05-18T22:00:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634777026",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634777026"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r634777026"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/634777026/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1232,
    "original_line": 1232,
    "side": "RIGHT",
    "in_reply_to_id": 632972362
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635077910",
    "pull_request_review_id": 662980191,
    "id": 635077910,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTA3NzkxMA==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
    "path": "src/net.h",
    "position": 68,
    "original_position": 38,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "@amitiuttarwar, maybe you would like the following pattern to be more widespread:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/1ed859e90e18384376e3a1ff0cb76f3e9ab11c2d/src/txrequest.h#L96-L101",
    "created_at": "2021-05-19T09:40:06Z",
    "updated_at": "2021-05-19T09:40:07Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r635077910",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635077910"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r635077910"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635077910/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1232,
    "original_line": 1232,
    "side": "RIGHT",
    "in_reply_to_id": 632972362
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635470619",
    "pull_request_review_id": 663513225,
    "id": 635470619,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzNTQ3MDYxOQ==",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot",
    "path": "src/net.h",
    "position": 68,
    "original_position": 38,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "amitiuttarwar",
      "id": 1500952,
      "node_id": "MDQ6VXNlcjE1MDA5NTI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1500952?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/amitiuttarwar",
      "html_url": "https://github.com/amitiuttarwar",
      "followers_url": "https://api.github.com/users/amitiuttarwar/followers",
      "following_url": "https://api.github.com/users/amitiuttarwar/following{/other_user}",
      "gists_url": "https://api.github.com/users/amitiuttarwar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/amitiuttarwar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/amitiuttarwar/subscriptions",
      "organizations_url": "https://api.github.com/users/amitiuttarwar/orgs",
      "repos_url": "https://api.github.com/users/amitiuttarwar/repos",
      "events_url": "https://api.github.com/users/amitiuttarwar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/amitiuttarwar/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "yeah, I'm def a fan of the pimpl / related patterns. Another example is how its used in `net_processing` since #20811.",
    "created_at": "2021-05-19T18:03:51Z",
    "updated_at": "2021-05-19T18:03:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r635470619",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635470619"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r635470619"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/635470619/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1232,
    "original_line": 1232,
    "side": "RIGHT",
    "in_reply_to_id": 632972362
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711994001",
    "pull_request_review_id": 758400122,
    "id": 711994001,
    "node_id": "PRRC_kwDOABII584qcCqR",
    "diff_hunk": "@@ -1492,13 +1488,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, false};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 105,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "0d706a6 if you retouch or have to rebase\r\n```suggestion\r\n    const NodesSnapshot snap{*this, /* shuffle=*/ false};\r\n```",
    "created_at": "2021-09-20T09:08:22Z",
    "updated_at": "2021-09-20T10:14:28Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r711994001",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711994001"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r711994001"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711994001/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1491,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711994365",
    "pull_request_review_id": 758400122,
    "id": 711994365,
    "node_id": "PRRC_kwDOABII584qcCv9",
    "diff_hunk": "@@ -2213,49 +2204,34 @@ void CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFai\n \n void CConnman::ThreadMessageHandler()\n {\n-    FastRandomContext rng;\n     while (!flagInterruptMsgProc)\n     {\n-        std::vector<CNode*> vNodesCopy;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy) {\n-                pnode->AddRef();\n-            }\n-        }\n-\n         bool fMoreWork = false;\n \n-        // Randomize the order in which we process messages from/to our peers.\n-        // This prevents attacks in which an attacker exploits having multiple\n-        // consecutive connections in the vNodes list.\n-        Shuffle(vNodesCopy.begin(), vNodesCopy.end(), rng);\n-\n-        for (CNode* pnode : vNodesCopy)\n         {\n-            if (pnode->fDisconnect)\n-                continue;\n+            // Randomize the order in which we process messages from/to our peers.\n+            // This prevents attacks in which an attacker exploits having multiple\n+            // consecutive connections in the vNodes list.\n+            const NodesSnapshot snap{*this, true};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 184,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "0d706a6 if you retouch or have to rebase, I think the comment about randomizing makes more sense with a named arg for `shuffle` \r\n```suggestion\r\n            const NodesSnapshot snap{*this, /* shuffle=*/ true};\r\n```",
    "created_at": "2021-09-20T09:08:52Z",
    "updated_at": "2021-09-20T10:14:28Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r711994365",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711994365"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r711994365"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711994365/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2215,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712014389",
    "pull_request_review_id": 758400122,
    "id": 712014389,
    "node_id": "PRRC_kwDOABII584qcHo1",
    "diff_hunk": "@@ -992,8 +992,27 @@ class CConnman\n     void NotifyNumConnectionsChanged();\n     /** Return true if the peer is inactive and should be disconnected. */\n     bool InactivityCheck(const CNode& node) const;\n-    bool GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n-    void SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Generate a collection of sockets that we want to be checked for readiness for IO.",
    "path": "src/net.h",
    "position": null,
    "original_position": 8,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "bf0dc73 nit doc suggestion, `s/readiness for IO/IO readiness/` or the pithier\r\n\r\n```suggestion\r\n     * Generate a collection of sockets to check for IO readiness.\r\n```",
    "created_at": "2021-09-20T09:39:04Z",
    "updated_at": "2021-09-20T10:14:28Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r712014389",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712014389"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r712014389"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712014389/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 997,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712022174",
    "pull_request_review_id": 758400122,
    "id": 712022174,
    "node_id": "PRRC_kwDOABII584qcJie",
    "diff_hunk": "@@ -1326,57 +1326,53 @@ bool CConnman::InactivityCheck(const CNode& node) const\n     return false;\n }\n \n-bool CConnman::GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n+bool CConnman::GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n {\n     for (const ListenSocket& hListenSocket : vhListenSocket) {\n         recv_set.insert(hListenSocket.socket);\n     }\n \n-    {",
    "path": "src/net.cpp",
    "position": 14,
    "original_position": 11,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "072896b these braces were needed to define the scope for the `LOCK(cs_vNodes);` mutex lock that is removed in the previous commit, so it may be a bit clearer to remove them at the same time as the lock. No strong opinion though. ",
    "created_at": "2021-09-20T09:50:56Z",
    "updated_at": "2021-09-20T10:17:38Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r712022174",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712022174"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r712022174"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712022174/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1340,
    "original_line": 1340,
    "side": "LEFT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301345",
    "pull_request_review_id": 765069220,
    "id": 717301345,
    "node_id": "PRRC_kwDOABII584qwSZh",
    "diff_hunk": "@@ -1492,13 +1488,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, false};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 105,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Added the comment. Some grepping showed the most common form of this is `func(/* description */ param);`",
    "created_at": "2021-09-28T07:31:07Z",
    "updated_at": "2021-09-28T07:31:07Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717301345",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301345"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717301345"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301345/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1491,
    "side": "RIGHT",
    "in_reply_to_id": 711994001
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301455",
    "pull_request_review_id": 765069330,
    "id": 717301455,
    "node_id": "PRRC_kwDOABII584qwSbP",
    "diff_hunk": "@@ -2213,49 +2204,34 @@ void CConnman::OpenNetworkConnection(const CAddress& addrConnect, bool fCountFai\n \n void CConnman::ThreadMessageHandler()\n {\n-    FastRandomContext rng;\n     while (!flagInterruptMsgProc)\n     {\n-        std::vector<CNode*> vNodesCopy;\n-        {\n-            LOCK(cs_vNodes);\n-            vNodesCopy = vNodes;\n-            for (CNode* pnode : vNodesCopy) {\n-                pnode->AddRef();\n-            }\n-        }\n-\n         bool fMoreWork = false;\n \n-        // Randomize the order in which we process messages from/to our peers.\n-        // This prevents attacks in which an attacker exploits having multiple\n-        // consecutive connections in the vNodes list.\n-        Shuffle(vNodesCopy.begin(), vNodesCopy.end(), rng);\n-\n-        for (CNode* pnode : vNodesCopy)\n         {\n-            if (pnode->fDisconnect)\n-                continue;\n+            // Randomize the order in which we process messages from/to our peers.\n+            // This prevents attacks in which an attacker exploits having multiple\n+            // consecutive connections in the vNodes list.\n+            const NodesSnapshot snap{*this, true};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 184,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Added the comment. Some grepping showed the most common form of this is `func(/* description */ param);`",
    "created_at": "2021-09-28T07:31:14Z",
    "updated_at": "2021-09-28T07:31:14Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717301455",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301455"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717301455"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301455/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2215,
    "side": "RIGHT",
    "in_reply_to_id": 711994365
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301573",
    "pull_request_review_id": 765069500,
    "id": 717301573,
    "node_id": "PRRC_kwDOABII584qwSdF",
    "diff_hunk": "@@ -992,8 +992,27 @@ class CConnman\n     void NotifyNumConnectionsChanged();\n     /** Return true if the peer is inactive and should be disconnected. */\n     bool InactivityCheck(const CNode& node) const;\n-    bool GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n-    void SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Generate a collection of sockets that we want to be checked for readiness for IO.",
    "path": "src/net.h",
    "position": null,
    "original_position": 8,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done.",
    "created_at": "2021-09-28T07:31:24Z",
    "updated_at": "2021-09-28T07:31:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717301573",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301573"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717301573"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717301573/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 997,
    "side": "RIGHT",
    "in_reply_to_id": 712014389
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717303767",
    "pull_request_review_id": 765072250,
    "id": 717303767,
    "node_id": "PRRC_kwDOABII584qwS_X",
    "diff_hunk": "@@ -1326,57 +1326,53 @@ bool CConnman::InactivityCheck(const CNode& node) const\n     return false;\n }\n \n-bool CConnman::GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n+bool CConnman::GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n {\n     for (const ListenSocket& hListenSocket : vhListenSocket) {\n         recv_set.insert(hListenSocket.socket);\n     }\n \n-    {",
    "path": "src/net.cpp",
    "position": 14,
    "original_position": 11,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I deliberately did the white-space change in a separate commit to ease review which would be harder if logic changes are mixed with lots of white-space changes. I extended the commit message though, so that it is easier to answer \"how did we end up with those unnecessary braces\".",
    "created_at": "2021-09-28T07:34:14Z",
    "updated_at": "2021-09-28T07:34:14Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717303767",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717303767"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717303767"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717303767/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1340,
    "original_line": 1340,
    "side": "LEFT",
    "in_reply_to_id": 712022174
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717379468",
    "pull_request_review_id": 765175113,
    "id": 717379468,
    "node_id": "PRRC_kwDOABII584qwleM",
    "diff_hunk": "@@ -1492,13 +1488,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, false};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 105,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes. I've very recently started to switch to the `/*named_arg=*/` format for `bugprone-argument-comment` added in fa57fa1a2e7. Not sure how picky clang is about it though.\r\n\r\nhttps://releases.llvm.org/12.0.0/tools/clang/tools/extra/docs/clang-tidy/checks/bugprone-argument-comment.html.",
    "created_at": "2021-09-28T09:08:46Z",
    "updated_at": "2021-10-03T17:34:53Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717379468",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717379468"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717379468"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717379468/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1491,
    "side": "RIGHT",
    "in_reply_to_id": 711994001
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717384169",
    "pull_request_review_id": 765181441,
    "id": 717384169,
    "node_id": "PRRC_kwDOABII584qwmnp",
    "diff_hunk": "@@ -1326,57 +1326,53 @@ bool CConnman::InactivityCheck(const CNode& node) const\n     return false;\n }\n \n-bool CConnman::GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n+bool CConnman::GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n {\n     for (const ListenSocket& hListenSocket : vhListenSocket) {\n         recv_set.insert(hListenSocket.socket);\n     }\n \n-    {",
    "path": "src/net.cpp",
    "position": 14,
    "original_position": 11,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes, no worries. Since some time now my `.gitconfig` has this set by default to simplify whitespace review (open to suggestions).\r\n```\r\n[diff]\r\n  renames = copies\r\n\tcolorMoved = dimmed-zebra\r\n\tcolorMovedWs = allow-indentation-change\r\n```\r\n",
    "created_at": "2021-09-28T09:14:31Z",
    "updated_at": "2021-09-28T09:14:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717384169",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717384169"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717384169"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717384169/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1340,
    "original_line": 1340,
    "side": "LEFT",
    "in_reply_to_id": 712022174
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717405324",
    "pull_request_review_id": 765210141,
    "id": 717405324,
    "node_id": "PRRC_kwDOABII584qwryM",
    "diff_hunk": "@@ -1492,13 +1488,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, false};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 105,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "My testing revealed that the `=` is needed for clang-tidy. I am likely going to use `(/*foo_bar=*/123, ` from now on (I think clang-format \"mirrors\" the whitespace, so clang-format valid options are `(/*foo_bar=*/123, /*bar_foor=*/321, ` or `(/* foo_bar = */ 123, /* bar_foor = */ 321, `",
    "created_at": "2021-09-28T09:41:37Z",
    "updated_at": "2021-09-28T09:41:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717405324",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717405324"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717405324"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717405324/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1491,
    "side": "RIGHT",
    "in_reply_to_id": 711994001
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717427120",
    "pull_request_review_id": 765239667,
    "id": 717427120,
    "node_id": "PRRC_kwDOABII584qwxGw",
    "diff_hunk": "@@ -1492,13 +1488,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, false};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 105,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks, good to know.",
    "created_at": "2021-09-28T10:09:46Z",
    "updated_at": "2021-09-28T10:09:47Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717427120",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717427120"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717427120"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717427120/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1491,
    "side": "RIGHT",
    "in_reply_to_id": 711994001
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717530409",
    "pull_request_review_id": 765380171,
    "id": 717530409,
    "node_id": "PRRC_kwDOABII584qxKUp",
    "diff_hunk": "@@ -1492,13 +1488,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, false};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 105,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "072896b7cf5e69c11a2e6d9e7163df4e0472f504",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`/* bar_foor= */ 321` is also ok for clang-format (re-formatting that with clang-format leaves it unmodified). I don't care which one as long as it is consistent through the code. I will use `/*foo_bar=*/123` too.",
    "created_at": "2021-09-28T12:37:04Z",
    "updated_at": "2021-09-28T12:37:04Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717530409",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717530409"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r717530409"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/717530409/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1491,
    "side": "RIGHT",
    "in_reply_to_id": 711994001
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725079584",
    "pull_request_review_id": 775111135,
    "id": 725079584,
    "node_id": "PRRC_kwDOABII584rN9Yg",
    "diff_hunk": "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n     if (interruptNet) return;\n \n     //\n-    // Accept new connections\n+    // Accept new connections. Done after taking a snapshot of the nodes because",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 115,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "99c1af5a8f95051e98ad4b9486eef70919ab2708",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think the logical flow of this function would be clearer if this logic was either moved to the bottom of the function, or pulled out of `SocketHandler()` entirely and put in `ThreadSocketHandler()` (or a dedicated function for accepting new connections). It's difficult to get my head around creating a NodesSnapshot, receiving events for those nodes, then updating vNodes and finally processing the events for the nodes in the snapshot.",
    "created_at": "2021-10-08T14:50:21Z",
    "updated_at": "2021-10-08T14:50:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725079584",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725079584"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725079584"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725079584/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1505,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725096927",
    "pull_request_review_id": 775135162,
    "id": 725096927,
    "node_id": "PRRC_kwDOABII584rOBnf",
    "diff_hunk": "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n     if (interruptNet) return;\n \n     //\n-    // Accept new connections\n+    // Accept new connections. Done after taking a snapshot of the nodes because",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 115,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "99c1af5a8f95051e98ad4b9486eef70919ab2708",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Alright, I think you are on the same page as @promag: https://github.com/bitcoin/bitcoin/pull/21943#discussion_r632360108. I will move it to the bottom or see how many more changes to split it (pull it out). @jonatack, what do you think?",
    "created_at": "2021-10-08T15:12:15Z",
    "updated_at": "2021-10-08T15:12:15Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725096927",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725096927"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725096927"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725096927/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1505,
    "side": "RIGHT",
    "in_reply_to_id": 725079584
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725119190",
    "pull_request_review_id": 775165468,
    "id": 725119190,
    "node_id": "PRRC_kwDOABII584rOHDW",
    "diff_hunk": "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n     if (interruptNet) return;\n \n     //\n-    // Accept new connections\n+    // Accept new connections. Done after taking a snapshot of the nodes because",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 115,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "99c1af5a8f95051e98ad4b9486eef70919ab2708",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Agree, I recall writing the same comment during my main review, moving the code to the end, then thinking it maybe made the most sense to make it a separate function, then deciding to not hold up this pull with that since it's been open a while and you have more steps in #21878. But yes.",
    "created_at": "2021-10-08T15:42:18Z",
    "updated_at": "2021-10-08T15:42:18Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725119190",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725119190"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r725119190"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725119190/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1505,
    "side": "RIGHT",
    "in_reply_to_id": 725079584
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728473929",
    "pull_request_review_id": 779123140,
    "id": 728473929,
    "node_id": "PRRC_kwDOABII584ra6FJ",
    "diff_hunk": "@@ -1332,57 +1332,53 @@ bool CConnman::InactivityCheck(const CNode& node) const\n     return false;\n }\n \n-bool CConnman::GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n+bool CConnman::GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "99c1af5a8f95051e98ad4b9486eef70919ab2708",
    "user": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: since you're changing this line anyway, maybe reverse the space and `&` for the 3 set arguments (to conform to style convention)?\r\n(Same comment for `SocketEvents()` below, and also in `net.h`.)",
    "created_at": "2021-10-13T21:52:35Z",
    "updated_at": "2021-10-14T16:57:23Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r728473929",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728473929"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r728473929"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728473929/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1334,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728483006",
    "pull_request_review_id": 779123140,
    "id": 728483006,
    "node_id": "PRRC_kwDOABII584ra8S-",
    "diff_hunk": "@@ -1257,6 +1276,40 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman) : m_connman{connman}\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            m_nodes_copy = m_connman.vNodes;\n+            for (auto& node : m_nodes_copy) {\n+                node->AddRef();\n+            }\n+        }\n+\n+        ~NodesSnapshot()\n+        {\n+            LOCK(m_connman.cs_vNodes);\n+            for (auto& node : m_nodes_copy) {\n+                node->Release();",
    "path": "src/net.h",
    "position": 88,
    "original_position": 54,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "92f62d9ea43c6861409916256a403417d80c0932",
    "user": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Perhaps beyond the scope of this PR, but it may be better if [`Release()`](https://github.com/bitcoin/bitcoin/blob/71a85fbd09b5a450edc53a8ba4131f32e7136ca7/src/net.h#L630) asserted that the count is valid:\r\n```\r\nvoid Release()\r\n{\r\n    assert(nRefCount > 0);\r\n    nRefCount--;\r\n}\r\n```\r\nThe count validity is asserted in `GetRefCount()` but it would be better to catch the malefactor in the act :).",
    "created_at": "2021-10-13T22:10:01Z",
    "updated_at": "2021-10-14T16:57:23Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r728483006",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728483006"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r728483006"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728483006/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1252,
    "original_line": 1252,
    "side": "RIGHT",
    "in_reply_to_id": 632974904
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729167321",
    "pull_request_review_id": 779123140,
    "id": 729167321,
    "node_id": "PRRC_kwDOABII584rdjXZ",
    "diff_hunk": "@@ -1177,6 +1196,44 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman, bool shuffle)\n+        {\n+            {\n+                LOCK(connman.cs_vNodes);\n+                m_nodes_copy = connman.vNodes;\n+                for (auto& node : m_nodes_copy) {\n+                    node->AddRef();\n+                }\n+            }\n+            if (shuffle) {\n+                FastRandomContext rng;\n+                Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), rng);\n+            }\n+        }",
    "path": "src/net.h",
    "position": null,
    "original_position": 54,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "99c1af5a8f95051e98ad4b9486eef70919ab2708",
    "user": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I would do this a little differently:\r\n```\r\nNodesSnapshot(const CConnman& connman)\r\n{\r\n    LOCK(connman.cs_vNodes);\r\n    m_nodes_copy = connman.vNodes;\r\n    for (auto& node : m_nodes_copy) {\r\n        node->AddRef();\r\n    }\r\n}\r\nstd::vector<CNode*>& Shuffle() {\r\n    FastRandomContext rng;\r\n    ::Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), rng);\r\n    return m_nodes_copy;\r\n}\r\n```",
    "created_at": "2021-10-14T16:48:48Z",
    "updated_at": "2021-10-14T18:15:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r729167321",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729167321"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r729167321"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729167321/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 1206,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 1247,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729170603",
    "pull_request_review_id": 779123140,
    "id": 729170603,
    "node_id": "PRRC_kwDOABII584rdkKr",
    "diff_hunk": "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 105,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "99c1af5a8f95051e98ad4b9486eef70919ab2708",
    "user": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Suggestion, this may be a little more elegant than the boolean shuffle argument (see suggested changes to `NodesSnapshot`)\r\n```suggestion\r\n    const NodesSnapshot snap{*this};\r\n```",
    "created_at": "2021-10-14T16:53:01Z",
    "updated_at": "2021-10-14T16:57:23Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r729170603",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729170603"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r729170603"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/729170603/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1497,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730243473",
    "pull_request_review_id": 781348101,
    "id": 730243473,
    "node_id": "PRRC_kwDOABII584rhqGR",
    "diff_hunk": "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n     if (interruptNet) return;\n \n     //\n-    // Accept new connections\n+    // Accept new connections. Done after taking a snapshot of the nodes because",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 115,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "99c1af5a8f95051e98ad4b9486eef70919ab2708",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yup, what @jnewbery says makes sense to me as I previously stumbled on the same thing. I'd prefer to review that refactor in a follow-up but am also happy to review here.",
    "created_at": "2021-10-16T10:19:27Z",
    "updated_at": "2021-10-16T10:19:27Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r730243473",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730243473"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r730243473"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/730243473/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1505,
    "side": "RIGHT",
    "in_reply_to_id": 725079584
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736268482",
    "pull_request_review_id": 789009361,
    "id": 736268482,
    "node_id": "PRRC_kwDOABII584r4pDC",
    "diff_hunk": "@@ -1467,8 +1467,6 @@ void CConnman::SocketHandler()\n         }\n     }\n \n-    NodesSnapshot snap{*this};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 61,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "157674ef213e6329215d1b7eb85dacbc23c468db",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This was changed, see https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-951672368",
    "created_at": "2021-10-26T08:11:16Z",
    "updated_at": "2021-10-26T08:11:16Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736268482",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736268482"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736268482"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736268482/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1470,
    "side": "LEFT",
    "in_reply_to_id": 632150326
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736278978",
    "pull_request_review_id": 789024606,
    "id": 736278978,
    "node_id": "PRRC_kwDOABII584r4rnC",
    "diff_hunk": "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+\n     std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n+    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n     if (interruptNet) return;\n \n     //\n-    // Accept new connections\n+    // Accept new connections. Done after taking a snapshot of the nodes because",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 115,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "99c1af5a8f95051e98ad4b9486eef70919ab2708",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I split the accepting of the new connections into its own method, that is independent of `CConnMan::SocketHandler()`, does its own socket polling and can be called independently from `CConnMan::SocketHandler()`. However after doing that, the following realization dawned on me (tldr: I ditched that):\r\n\r\n:bulb: We don't want to wait separately for incoming connections because that event is \"rare\", meaning most of the time we would just sleep for some time until `poll(2)` times out, signaling no socket is ready for IO (no new incoming connections). This would have an adverse effect on the throughput - even on busy nodes that constantly have incoming/outgoing data, we would needlessly sleep for a short while, frequently.\r\n\r\nSo, we want to `poll(2)` the already connected sockets and the listening ones together, in one `poll(2)` call.\r\n\r\nI made some changes to `CConnMan::SocketHander()` to (hopefully) make it easier to read, see https://github.com/bitcoin/bitcoin/pull/21943#issuecomment-951672368",
    "created_at": "2021-10-26T08:23:44Z",
    "updated_at": "2021-10-26T08:23:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736278978",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736278978"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736278978"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736278978/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1505,
    "side": "RIGHT",
    "in_reply_to_id": 725079584
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736283980",
    "pull_request_review_id": 789031243,
    "id": 736283980,
    "node_id": "PRRC_kwDOABII584r4s1M",
    "diff_hunk": "@@ -1177,6 +1196,44 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman, bool shuffle)\n+        {\n+            {\n+                LOCK(connman.cs_vNodes);\n+                m_nodes_copy = connman.vNodes;\n+                for (auto& node : m_nodes_copy) {\n+                    node->AddRef();\n+                }\n+            }\n+            if (shuffle) {\n+                FastRandomContext rng;\n+                Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), rng);\n+            }\n+        }",
    "path": "src/net.h",
    "position": null,
    "original_position": 54,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "99c1af5a8f95051e98ad4b9486eef70919ab2708",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This would require an extra call to `Shuffle()` right after construction. I don't see the benefit of it. It would require the snapshot variable to be non-`const`.",
    "created_at": "2021-10-26T08:29:24Z",
    "updated_at": "2021-10-26T08:29:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736283980",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736283980"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736283980"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736283980/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 1206,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 1247,
    "side": "RIGHT",
    "in_reply_to_id": 729167321
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736287423",
    "pull_request_review_id": 789035914,
    "id": 736287423,
    "node_id": "PRRC_kwDOABII584r4tq_",
    "diff_hunk": "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 105,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "99c1af5a8f95051e98ad4b9486eef70919ab2708",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think it is ok as it is now. We are not frowning upon boolean arguments, are we? If the boolean argument looks too bad, then a 2-value enum can be introduced so call sites look like:\r\n```cpp\r\nconst NodesSnapshot snap{*this, NodesSnapshot::SHUFFLE};\r\n// or\r\nconst NodesSnapshot snap{*this, NodesSnapshot::NO_SHUFFLE};\r\n```\r\nbut I think this would be an overkill.",
    "created_at": "2021-10-26T08:33:30Z",
    "updated_at": "2021-10-26T08:33:30Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736287423",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736287423"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r736287423"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736287423/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1497,
    "side": "RIGHT",
    "in_reply_to_id": 729170603
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738379450",
    "pull_request_review_id": 791851693,
    "id": 738379450,
    "node_id": "PRRC_kwDOABII584sAsa6",
    "diff_hunk": "@@ -1495,28 +1495,33 @@ void CConnman::SocketEvents(const std::vector<CNode*>& nodes, std::set<SOCKET> &\n \n void CConnman::SocketHandler()\n {\n-    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n+    {\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    if (interruptNet) return;\n+        // Check for readiness the already connected sockets and the listening sockets\n+        // in one call. If none is ready, wait for a short while and return empty sets.\n+        SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n-    {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n+        if (interruptNet) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 27,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "3c8fcb94691584871edaa1a142bfa0ebadc01d67",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "3c8fcb94691584871edaa1a142bfa0ebadc01d67\r\n\r\nI think you can ditch this?",
    "created_at": "2021-10-28T13:16:41Z",
    "updated_at": "2021-10-28T13:21:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r738379450",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738379450"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r738379450"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738379450/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1509,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746951383",
    "pull_request_review_id": 803098736,
    "id": 746951383,
    "node_id": "PRRC_kwDOABII584shZLX",
    "diff_hunk": "@@ -1498,13 +1494,21 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n+    const NodesSnapshot snap{*this, /*shuffle=*/false};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 105,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "99c1af5a8f95051e98ad4b9486eef70919ab2708",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think with the named argument this is fine.",
    "created_at": "2021-11-10T20:12:51Z",
    "updated_at": "2021-11-10T20:12:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r746951383",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746951383"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r746951383"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746951383/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1497,
    "side": "RIGHT",
    "in_reply_to_id": 729170603
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747639993",
    "pull_request_review_id": 803984837,
    "id": 747639993,
    "node_id": "PRRC_kwDOABII584skBS5",
    "diff_hunk": "@@ -1495,28 +1495,33 @@ void CConnman::SocketEvents(const std::vector<CNode*>& nodes, std::set<SOCKET> &\n \n void CConnman::SocketHandler()\n {\n-    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n+    {\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    if (interruptNet) return;\n+        // Check for readiness the already connected sockets and the listening sockets\n+        // in one call. If none is ready, wait for a short while and return empty sets.\n+        SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n-    {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n+        if (interruptNet) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 27,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "3c8fcb94691584871edaa1a142bfa0ebadc01d67",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "You are right - the surrounding `SocketEvents()` and `SocketHandlerConnected()` both contain a similar check and would quit \"quickly\" if `interruptNet` becomes true.\r\n\r\nMaybe the newly added `SocketHandlerListening()` deserves such a check too, once per each listening socket to be processed?",
    "created_at": "2021-11-11T16:21:32Z",
    "updated_at": "2021-11-11T16:21:33Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r747639993",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747639993"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r747639993"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747639993/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1509,
    "side": "RIGHT",
    "in_reply_to_id": 738379450
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747642620",
    "pull_request_review_id": 803988240,
    "id": 747642620,
    "node_id": "PRRC_kwDOABII584skB78",
    "diff_hunk": "@@ -1495,28 +1495,33 @@ void CConnman::SocketEvents(const std::vector<CNode*>& nodes, std::set<SOCKET> &\n \n void CConnman::SocketHandler()\n {\n-    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n+    {\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    if (interruptNet) return;\n+        // Check for readiness the already connected sockets and the listening sockets\n+        // in one call. If none is ready, wait for a short while and return empty sets.\n+        SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n-    {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n+        if (interruptNet) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 27,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "3c8fcb94691584871edaa1a142bfa0ebadc01d67",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes, doesn't hurt I guess.",
    "created_at": "2021-11-11T16:24:54Z",
    "updated_at": "2021-11-11T16:24:54Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r747642620",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747642620"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r747642620"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747642620/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1509,
    "side": "RIGHT",
    "in_reply_to_id": 738379450
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748117765",
    "pull_request_review_id": 804595561,
    "id": 748117765,
    "node_id": "PRRC_kwDOABII584sl18F",
    "diff_hunk": "@@ -1495,28 +1495,33 @@ void CConnman::SocketEvents(const std::vector<CNode*>& nodes, std::set<SOCKET> &\n \n void CConnman::SocketHandler()\n {\n-    const NodesSnapshot snap{*this, /*shuffle=*/false};\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n+    {\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    if (interruptNet) return;\n+        // Check for readiness the already connected sockets and the listening sockets\n+        // in one call. If none is ready, wait for a short while and return empty sets.\n+        SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n-    {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n+        if (interruptNet) {",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 27,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "3c8fcb94691584871edaa1a142bfa0ebadc01d67",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done.",
    "created_at": "2021-11-12T09:54:27Z",
    "updated_at": "2021-11-12T09:54:27Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r748117765",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748117765"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r748117765"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748117765/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1509,
    "side": "RIGHT",
    "in_reply_to_id": 738379450
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748339454",
    "pull_request_review_id": 804875630,
    "id": 748339454,
    "node_id": "PRRC_kwDOABII584smsD-",
    "diff_hunk": "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n     {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n-        }\n-    }\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    //\n-    // Service each socket\n-    //\n-    std::vector<CNode*> vNodesCopy;\n-    {\n-        LOCK(cs_vNodes);\n-        vNodesCopy = vNodes;\n-        for (CNode* pnode : vNodesCopy)\n-            pnode->AddRef();\n+        // Check for readiness the already connected sockets and the listening sockets",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 134,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "4097d14 `s/readiness/the readiness of/` ? Perhaps also clarify \"ready\". Also `s/none is/none are/`.",
    "created_at": "2021-11-12T14:40:58Z",
    "updated_at": "2021-11-17T12:44:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r748339454",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748339454"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r748339454"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748339454/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1503,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748343811",
    "pull_request_review_id": 804875630,
    "id": 748343811,
    "node_id": "PRRC_kwDOABII584smtID",
    "diff_hunk": "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n     {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n-        }\n-    }\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};",
    "path": "src/net.cpp",
    "position": 132,
    "original_position": 123,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "9ca6dac0 naming nit: \"snap\" is a verb similar to \"break\"; if you retouch, `s/snap/snapshot/` would be clearer",
    "created_at": "2021-11-12T14:46:37Z",
    "updated_at": "2021-11-17T12:44:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r748343811",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748343811"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r748343811"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748343811/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1510,
    "original_line": 1510,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751165699",
    "pull_request_review_id": 804875630,
    "id": 751165699,
    "node_id": "PRRC_kwDOABII584sxeED",
    "diff_hunk": "@@ -1177,6 +1219,44 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman, bool shuffle)\n+        {\n+            {\n+                LOCK(connman.cs_vNodes);\n+                m_nodes_copy = connman.vNodes;\n+                for (auto& node : m_nodes_copy) {\n+                    node->AddRef();\n+                }\n+            }\n+            if (shuffle) {\n+                FastRandomContext rng;\n+                Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), rng);",
    "path": "src/net.h",
    "position": null,
    "original_position": 76,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "9ca6dac0 can omit localvar `rng`\r\n```diff\r\n             if (shuffle) {\r\n-                FastRandomContext rng;\r\n-                Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), rng);\r\n+                Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), FastRandomContext());\r\n             }\r\n```\r\n",
    "created_at": "2021-11-17T11:50:21Z",
    "updated_at": "2021-11-17T12:44:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751165699",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751165699"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751165699"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751165699/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1240,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751179588",
    "pull_request_review_id": 804875630,
    "id": 751179588,
    "node_id": "PRRC_kwDOABII584sxhdE",
    "diff_hunk": "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
    "path": "src/net.cpp",
    "position": 120,
    "original_position": 111,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "4097d14 unneeded style change, would leave as-is (and as currently exists in both of the `SocketEvents()` functions)\r\n```diff\r\n-    std::set<SOCKET> recv_set;\r\n-    std::set<SOCKET> send_set;\r\n-    std::set<SOCKET> error_set;\r\n-\r\n+    std::set<SOCKET> recv_set, send_set, error_set;\r\n```\r\n",
    "created_at": "2021-11-17T12:10:10Z",
    "updated_at": "2021-11-17T12:44:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751179588",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751179588"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751179588"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751179588/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1507,
    "original_line": 1507,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751190044",
    "pull_request_review_id": 804875630,
    "id": 751190044,
    "node_id": "PRRC_kwDOABII584sxkAc",
    "diff_hunk": "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n     {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n-        }\n-    }\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    //\n-    // Service each socket\n-    //\n-    std::vector<CNode*> vNodesCopy;\n-    {\n-        LOCK(cs_vNodes);\n-        vNodesCopy = vNodes;\n-        for (CNode* pnode : vNodesCopy)\n-            pnode->AddRef();\n+        // Check for readiness the already connected sockets and the listening sockets\n+        // in one call. If none is ready, wait for a short while and return empty sets.\n+        SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n+\n+        SocketHandlerConnected(snap.Nodes(), recv_set, send_set, error_set);",
    "path": "src/net.cpp",
    "position": 150,
    "original_position": 138,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "4097d14 found these comments helpful, would keep\r\n```diff\r\n+        // Service each socket\r\n         SocketHandlerConnected(snap.Nodes(), recv_set, send_set, error_set);\r\n     }\r\n \r\n+    // Accept new connections\r\n     SocketHandlerListening(recv_set);\r\n```\r\n",
    "created_at": "2021-11-17T12:24:40Z",
    "updated_at": "2021-11-17T12:44:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751190044",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751190044"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751190044"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751190044/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1519,
    "original_line": 1519,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751192944",
    "pull_request_review_id": 804875630,
    "id": 751192944,
    "node_id": "PRRC_kwDOABII584sxktw",
    "diff_hunk": "@@ -983,9 +983,51 @@ class CConnman\n     void NotifyNumConnectionsChanged();\n     /** Return true if the peer is inactive and should be disconnected. */\n     bool InactivityCheck(const CNode& node) const;\n-    bool GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n-    void SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Generate a collection of sockets to check for IO readiness.\n+     * @param[in] nodes Select from these nodes' sockets.\n+     * @param[out] recv_set Sockets to check for read readiness.\n+     * @param[out] send_set Sockets to check for write readiness.\n+     * @param[out] error_set Sockets to check for errors.\n+     * @return true if at least one socket is to be checked (the returned set is not empty)\n+     */\n+    bool GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Check which sockets are ready for IO.\n+     * @param[in] nodes Select from these nodes' sockets.\n+     * @param[out] recv_set Sockets which are ready for read.\n+     * @param[out] send_set Sockets which are ready for write.\n+     * @param[out] error_set Sockets which have errors.\n+     * This calls `GenerateSelectSet()` to gather a list of sockets to check.\n+     */\n+    void SocketEvents(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Check connected and listening sockets for IO readiness and process them accordingly.\n+     */\n     void SocketHandler();\n+\n+    /**\n+     * Do the read/write for connected sockets that are ready for IO.\n+     * @param[in] nodes Nodes to process. The socket of each node is checked against\n+     * `recv_set`, `send_set` and `error_set`.\n+     * @param[in] recv_set Sockets that are ready for read.\n+     * @param[in] send_set Sockets that are ready for send.\n+     * @param[in] error_set Sockets that have an exceptional condition (error).\n+     */\n+    void SocketHandlerConnected(const std::vector<CNode*>& nodes,\n+                                const std::set<SOCKET>& recv_set,\n+                                const std::set<SOCKET>& send_set,\n+                                const std::set<SOCKET>& error_set);\n+\n+    /**\n+     * Accept an incoming connection from listening sockets that are ready for read.",
    "path": "src/net.h",
    "position": null,
    "original_position": 46,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "4097d14 the existing \"Accept incoming connections\" comment is an easier-to-understand description for me than this one. \r\n\r\nMaybe:\r\n```suggestion\r\n     * Accept incoming connections, i.e. one from each read-ready listening socket.\r\n```",
    "created_at": "2021-11-17T12:28:39Z",
    "updated_at": "2021-11-17T12:44:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751192944",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751192944"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r751192944"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/751192944/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1026,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752203361",
    "pull_request_review_id": 809869717,
    "id": 752203361,
    "node_id": "PRRC_kwDOABII584s1bZh",
    "diff_hunk": "@@ -983,9 +983,51 @@ class CConnman\n     void NotifyNumConnectionsChanged();\n     /** Return true if the peer is inactive and should be disconnected. */\n     bool InactivityCheck(const CNode& node) const;\n-    bool GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n-    void SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Generate a collection of sockets to check for IO readiness.\n+     * @param[in] nodes Select from these nodes' sockets.\n+     * @param[out] recv_set Sockets to check for read readiness.\n+     * @param[out] send_set Sockets to check for write readiness.\n+     * @param[out] error_set Sockets to check for errors.\n+     * @return true if at least one socket is to be checked (the returned set is not empty)\n+     */\n+    bool GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Check which sockets are ready for IO.\n+     * @param[in] nodes Select from these nodes' sockets.\n+     * @param[out] recv_set Sockets which are ready for read.\n+     * @param[out] send_set Sockets which are ready for write.\n+     * @param[out] error_set Sockets which have errors.\n+     * This calls `GenerateSelectSet()` to gather a list of sockets to check.\n+     */\n+    void SocketEvents(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set);\n+\n+    /**\n+     * Check connected and listening sockets for IO readiness and process them accordingly.\n+     */\n     void SocketHandler();\n+\n+    /**\n+     * Do the read/write for connected sockets that are ready for IO.\n+     * @param[in] nodes Nodes to process. The socket of each node is checked against\n+     * `recv_set`, `send_set` and `error_set`.\n+     * @param[in] recv_set Sockets that are ready for read.\n+     * @param[in] send_set Sockets that are ready for send.\n+     * @param[in] error_set Sockets that have an exceptional condition (error).\n+     */\n+    void SocketHandlerConnected(const std::vector<CNode*>& nodes,\n+                                const std::set<SOCKET>& recv_set,\n+                                const std::set<SOCKET>& send_set,\n+                                const std::set<SOCKET>& error_set);\n+\n+    /**\n+     * Accept an incoming connection from listening sockets that are ready for read.",
    "path": "src/net.h",
    "position": null,
    "original_position": 46,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done.",
    "created_at": "2021-11-18T12:41:58Z",
    "updated_at": "2021-11-18T12:41:58Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752203361",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752203361"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752203361"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752203361/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1026,
    "side": "RIGHT",
    "in_reply_to_id": 751192944
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752203519",
    "pull_request_review_id": 809869935,
    "id": 752203519,
    "node_id": "PRRC_kwDOABII584s1bb_",
    "diff_hunk": "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n     {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n-        }\n-    }\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    //\n-    // Service each socket\n-    //\n-    std::vector<CNode*> vNodesCopy;\n-    {\n-        LOCK(cs_vNodes);\n-        vNodesCopy = vNodes;\n-        for (CNode* pnode : vNodesCopy)\n-            pnode->AddRef();\n+        // Check for readiness the already connected sockets and the listening sockets\n+        // in one call. If none is ready, wait for a short while and return empty sets.\n+        SocketEvents(snap.Nodes(), recv_set, send_set, error_set);\n+\n+        SocketHandlerConnected(snap.Nodes(), recv_set, send_set, error_set);",
    "path": "src/net.cpp",
    "position": 150,
    "original_position": 138,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done.",
    "created_at": "2021-11-18T12:42:09Z",
    "updated_at": "2021-11-18T12:42:10Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752203519",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752203519"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752203519"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752203519/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1519,
    "original_line": 1519,
    "side": "RIGHT",
    "in_reply_to_id": 751190044
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752205516",
    "pull_request_review_id": 809872731,
    "id": 752205516,
    "node_id": "PRRC_kwDOABII584s1b7M",
    "diff_hunk": "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
    "path": "src/net.cpp",
    "position": 120,
    "original_position": 111,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think it is good to always declare one variable per line.",
    "created_at": "2021-11-18T12:44:55Z",
    "updated_at": "2021-11-18T12:44:56Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752205516",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752205516"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752205516"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752205516/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1507,
    "original_line": 1507,
    "side": "RIGHT",
    "in_reply_to_id": 751179588
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752205608",
    "pull_request_review_id": 809872873,
    "id": 752205608,
    "node_id": "PRRC_kwDOABII584s1b8o",
    "diff_hunk": "@@ -1177,6 +1219,44 @@ class CConnman\n      */\n     std::vector<CService> m_onion_binds;\n \n+    /**\n+     * RAII helper to atomically create a copy of `vNodes` and add a reference\n+     * to each of the nodes. The nodes are released when this object is destroyed.\n+     */\n+    class NodesSnapshot\n+    {\n+    public:\n+        explicit NodesSnapshot(const CConnman& connman, bool shuffle)\n+        {\n+            {\n+                LOCK(connman.cs_vNodes);\n+                m_nodes_copy = connman.vNodes;\n+                for (auto& node : m_nodes_copy) {\n+                    node->AddRef();\n+                }\n+            }\n+            if (shuffle) {\n+                FastRandomContext rng;\n+                Shuffle(m_nodes_copy.begin(), m_nodes_copy.end(), rng);",
    "path": "src/net.h",
    "position": null,
    "original_position": 76,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done.",
    "created_at": "2021-11-18T12:45:04Z",
    "updated_at": "2021-11-18T12:45:04Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752205608",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752205608"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752205608"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752205608/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1240,
    "side": "RIGHT",
    "in_reply_to_id": 751165699
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752207151",
    "pull_request_review_id": 809874982,
    "id": 752207151,
    "node_id": "PRRC_kwDOABII584s1cUv",
    "diff_hunk": "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n     {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n-        }\n-    }\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};",
    "path": "src/net.cpp",
    "position": 132,
    "original_position": 123,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`snap` is used as a short for `snapshot`, not in the \"verb\" sense. I have seen this elsewhere too. For example `zfs list -t snapshot` and `zfs list -t snap` both do the same thing.",
    "created_at": "2021-11-18T12:47:09Z",
    "updated_at": "2021-11-18T12:47:09Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752207151",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752207151"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752207151"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752207151/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1510,
    "original_line": 1510,
    "side": "RIGHT",
    "in_reply_to_id": 748343811
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752207254",
    "pull_request_review_id": 809875138,
    "id": 752207254,
    "node_id": "PRRC_kwDOABII584s1cWW",
    "diff_hunk": "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;\n \n-    //\n-    // Accept new connections\n-    //\n-    for (const ListenSocket& hListenSocket : vhListenSocket)\n     {\n-        if (hListenSocket.socket != INVALID_SOCKET && recv_set.count(hListenSocket.socket) > 0)\n-        {\n-            AcceptConnection(hListenSocket);\n-        }\n-    }\n+        const NodesSnapshot snap{*this, /*shuffle=*/false};\n \n-    //\n-    // Service each socket\n-    //\n-    std::vector<CNode*> vNodesCopy;\n-    {\n-        LOCK(cs_vNodes);\n-        vNodesCopy = vNodes;\n-        for (CNode* pnode : vNodesCopy)\n-            pnode->AddRef();\n+        // Check for readiness the already connected sockets and the listening sockets",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 134,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done.",
    "created_at": "2021-11-18T12:47:19Z",
    "updated_at": "2021-11-18T12:47:19Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752207254",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752207254"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752207254"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752207254/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1503,
    "side": "RIGHT",
    "in_reply_to_id": 748339454
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752209237",
    "pull_request_review_id": 809877988,
    "id": 752209237,
    "node_id": "PRRC_kwDOABII584s1c1V",
    "diff_hunk": "@@ -1332,57 +1332,53 @@ bool CConnman::InactivityCheck(const CNode& node) const\n     return false;\n }\n \n-bool CConnman::GenerateSelectSet(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)\n+bool CConnman::GenerateSelectSet(const std::vector<CNode*>& nodes, std::set<SOCKET> &recv_set, std::set<SOCKET> &send_set, std::set<SOCKET> &error_set)",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "99c1af5a8f95051e98ad4b9486eef70919ab2708",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Sometimes reviewers ask for minimal changes, without combining \"real\" changes with whitespace ones. So I refrained from running `clang-format` on this line. Done now.",
    "created_at": "2021-11-18T12:50:03Z",
    "updated_at": "2021-11-18T12:50:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752209237",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752209237"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r752209237"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752209237/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1334,
    "side": "RIGHT",
    "in_reply_to_id": 728473929
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753523180",
    "pull_request_review_id": 811664007,
    "id": 753523180,
    "node_id": "PRRC_kwDOABII584s6dns",
    "diff_hunk": "@@ -1513,18 +1513,12 @@ void CConnman::SocketHandler()\n         }\n     }\n \n+    const NodesSnapshot snap{*this, /*shuffle=*/false};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "75e8bf55f5a014faada7712a9640dc35e8c86f15",
    "user": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I guess it's just me, but I still don't like this boolean (but I do agree with you that it's better than an `enum`). In general, I dislike making a decision at run time (in this case, the constructor evaluating the `shuffle` argument) that is actually being decided at compile (in this case, all the callers pass a constant bool for this argument), if possible (sometimes it's not).\r\n\r\nWhat do you think about always shuffling? Just make that part of the semantics of this object? Could there ever be any harm (other than a very slight performance hit)?",
    "created_at": "2021-11-19T20:48:49Z",
    "updated_at": "2021-11-19T21:26:40Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r753523180",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753523180"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r753523180"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753523180/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1516,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753539733",
    "pull_request_review_id": 811664007,
    "id": 753539733,
    "node_id": "PRRC_kwDOABII584s6hqV",
    "diff_hunk": "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
    "path": "src/net.cpp",
    "position": 120,
    "original_position": 111,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Consider:\r\n```cpp\r\nstruct SocketSets {\r\n    std::set<SOCKET> recv;\r\n    std::set<SOCKET> send;\r\n    std::set<SOCKET> error;\r\n}\r\n```",
    "created_at": "2021-11-19T21:22:21Z",
    "updated_at": "2021-11-19T21:26:40Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r753539733",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753539733"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r753539733"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753539733/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1507,
    "original_line": 1507,
    "side": "RIGHT",
    "in_reply_to_id": 751179588
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755105857",
    "pull_request_review_id": 813634796,
    "id": 755105857,
    "node_id": "PRRC_kwDOABII584tAgBB",
    "diff_hunk": "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
    "path": "src/net.cpp",
    "position": 120,
    "original_position": 111,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "@LarryRuane, something like this is coming as a subsequent change from https://github.com/bitcoin/bitcoin/pull/21878 (see commit `net: introduce Sock::WaitMany()` and the structures `WaitEvents` and `WaitData` introduced in that commit).\r\n\r\nThe current combination of sets stores the sockets in \"one pile of sockets that are ready for read\" and \"one pile of sockets that are ready for write\" (notice that a given socket may be in both). It is more convenient to have just one pile of sockets each one with attached ready-for-read and ready-for-write flags.",
    "created_at": "2021-11-23T13:08:25Z",
    "updated_at": "2021-11-23T13:08:25Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r755105857",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755105857"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r755105857"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755105857/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1507,
    "original_line": 1507,
    "side": "RIGHT",
    "in_reply_to_id": 751179588
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755114947",
    "pull_request_review_id": 813647737,
    "id": 755114947,
    "node_id": "PRRC_kwDOABII584tAiPD",
    "diff_hunk": "@@ -1513,18 +1513,12 @@ void CConnman::SocketHandler()\n         }\n     }\n \n+    const NodesSnapshot snap{*this, /*shuffle=*/false};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "75e8bf55f5a014faada7712a9640dc35e8c86f15",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> What do you think about always shuffling?\r\n\r\nI do not have a strong opinion. My main point with the current code is to preserve behavior - it was not shuffled before, it will not be shuffled with this PR. This PR has a different purpose.\r\n\r\nIn general, I try to avoid such unnecessary behavioral changes. _They may have very subtle effects._\r\n\r\nMaybe it is ok to always shuffle and remove the boolean argument from the `NodesSnapshot` constructor? What do other reviewers think?",
    "created_at": "2021-11-23T13:19:48Z",
    "updated_at": "2021-11-23T13:19:49Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r755114947",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755114947"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r755114947"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755114947/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1516,
    "side": "RIGHT",
    "in_reply_to_id": 753523180
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755390067",
    "pull_request_review_id": 814021503,
    "id": 755390067,
    "node_id": "PRRC_kwDOABII584tBlZz",
    "diff_hunk": "@@ -1513,18 +1513,12 @@ void CConnman::SocketHandler()\n         }\n     }\n \n+    const NodesSnapshot snap{*this, /*shuffle=*/false};",
    "path": "src/net.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "75e8bf55f5a014faada7712a9640dc35e8c86f15",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Slight preference to keep behavior here and simplify in a follow-up.",
    "created_at": "2021-11-23T18:09:16Z",
    "updated_at": "2021-11-23T18:09:16Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r755390067",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755390067"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r755390067"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/755390067/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1516,
    "side": "RIGHT",
    "in_reply_to_id": 753523180
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/756202735",
    "pull_request_review_id": 815081452,
    "id": 756202735,
    "node_id": "PRRC_kwDOABII584tErzv",
    "diff_hunk": "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
    "path": "src/net.cpp",
    "position": 120,
    "original_position": 111,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I like the idea of abstracting this but it seems out of scope of this PR.\r\n\r\n> It is more convenient to have just one pile of sockets each one with attached ready-for-read and ready-for-write flags.\r\n\r\nEventually it depends on the selection mechanism used isn't it? When it's abstracted, might as well store it in a format ready to feed to say, `poll()` or `select()` whatever is used.",
    "created_at": "2021-11-24T15:43:31Z",
    "updated_at": "2021-11-24T15:43:32Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r756202735",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/756202735"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r756202735"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/756202735/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1507,
    "original_line": 1507,
    "side": "RIGHT",
    "in_reply_to_id": 751179588
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/756226265",
    "pull_request_review_id": 815110132,
    "id": 756226265,
    "node_id": "PRRC_kwDOABII584tExjZ",
    "diff_hunk": "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
    "path": "src/net.cpp",
    "position": 120,
    "original_position": 111,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes, those 3 sets are dragged around as parameters to functions and as local variables. It is an obvious improvement to pack them together somehow. Not the purpose of this PR. Once this is PR is merged I will chop off another piece from #21878 into a smaller/manageable PR that will contain the commit which introduces such a packing `net: introduce Sock::WaitMany()`. We can discuss it there, I don't have a strong opinion on how they are packed exactly. Or if this PR is stuck we can move the discussion to #21878 where `WaitData` is introduced.",
    "created_at": "2021-11-24T16:06:25Z",
    "updated_at": "2021-11-24T16:06:25Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r756226265",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/756226265"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r756226265"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/756226265/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1507,
    "original_line": 1507,
    "side": "RIGHT",
    "in_reply_to_id": 751179588
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757474099",
    "pull_request_review_id": 816753105,
    "id": 757474099,
    "node_id": "PRRC_kwDOABII584tJiMz",
    "diff_hunk": "@@ -1497,34 +1493,29 @@ void CConnman::SocketEvents(std::set<SOCKET> &recv_set, std::set<SOCKET> &send_s\n \n void CConnman::SocketHandler()\n {\n-    std::set<SOCKET> recv_set, send_set, error_set;\n-    SocketEvents(recv_set, send_set, error_set);\n-\n-    if (interruptNet) return;\n+    std::set<SOCKET> recv_set;\n+    std::set<SOCKET> send_set;\n+    std::set<SOCKET> error_set;",
    "path": "src/net.cpp",
    "position": 120,
    "original_position": 111,
    "commit_id": "f52b6b2d9f482353821da0ef4c485c402a396c8d",
    "original_commit_id": "db0a01e0d1ab4462b70a44c255c602ea074b96ef",
    "user": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> Once this is PR is merged I will chop off another piece from #21878 into a smaller/manageable PR that will contain the commit which introduces such a packing `net: introduce Sock::WaitMany()`\r\n\r\nThere are too many conflicts if I try to cherry-pick the `WaitMany()` stuff on top of bare `master` - it touches the same areas of code as the preceding commits from #21878. I chopped off those preceding commits in separate PRs instead: https://github.com/bitcoin/bitcoin/pull/23601 and https://github.com/bitcoin/bitcoin/pull/23604.\r\n\r\n```\r\nWaitMany | net: use Sock::WaitMany() instead of CConnman::SocketEvents()\r\nstuff    | net: introduce Sock::WaitMany()\r\n         | net: also wait for exceptional events in Sock::Wait()\r\n\r\n#23601   | net: don't check if the listening socket is valid\r\n\r\n         | scripted-diff: rename CNode::cs_hSocket to CNode::m_sock_mutex\r\n#23604   | net: use Sock in CNode\r\n         | fuzz: move FuzzedSock earlier in src/test/fuzz/util.h\r\n\r\n         | net: change CreateNodeFromAcceptedSocket() to take Sock\r\n#21879   | net: use Sock in CConnman::ListenSocket\r\n         | net: add new method Sock::Accept() that wraps accept()\r\n```\r\n",
    "created_at": "2021-11-26T12:49:31Z",
    "updated_at": "2021-11-26T12:49:32Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r757474099",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757474099"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21943#discussion_r757474099"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21943"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757474099/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1507,
    "original_line": 1507,
    "side": "RIGHT",
    "in_reply_to_id": 751179588
  }
]