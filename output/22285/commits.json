[
  {
    "sha": "dad4627dfeb45d8797c3e24834a5eee8079ba45d",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkYWQ0NjI3ZGZlYjQ1ZDg3OTdjM2UyNDgzNGE1ZWVlODA3OWJhNDVk",
    "commit": {
      "author": {
        "name": "Matt Whitlock",
        "email": "bitcoin@mattwhitlock.name",
        "date": "2021-06-19T17:42:41Z"
      },
      "committer": {
        "name": "Matt Whitlock",
        "email": "bitcoin@mattwhitlock.name",
        "date": "2021-06-19T18:09:23Z"
      },
      "message": "contrib/init: (OpenRC) use -startupnotify to wait for startup completion\n\nWhen other initscripts depend on bitcoind, it's because their daemons\nwant to be able to invoke bitcoin-cli or to communicate with bitcoind\nvia RPC. That can't happen until some time after bitcoind has forked\ninto the background. The -startupnotify option was added in 090530cc24\n(#15367) to support exactly this use case, so let's use it.\n\nThe ideal OpenRC mechanism of marking the service inactive at startup\nand later calling back into the start() function with IN_BACKGROUND=yes\nwon't work here because bitcoind runs as an unprivileged user that\nis not allowed to call \"rc-service ${SVCNAME} start\", and OpenRC has no\nmechanism like systemd-notify, so instead we make start-stop-daemon\nlock a startup dummy file with flock(1) before exec'ing bitcoind, and\nthen we use -startupnotify to release the lock when bitcoind is ready\nto service RPC requests. In the initscript's start_post() function we\nlock the startup file briefly, which forces that function to wait until\nbitcoind has released its lock on the file, which will happen when\nbitcoind either executes the -startupnotify command or dies. After\nacquiring and releasing the lock, start_post() performs one final check\nthat the pid file still exists, which allows the service to be marked\nas started or stopped appropriately.",
      "tree": {
        "sha": "04215881c6c52644dffe3762ee9e7d061f332436",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/04215881c6c52644dffe3762ee9e7d061f332436"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/dad4627dfeb45d8797c3e24834a5eee8079ba45d",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dad4627dfeb45d8797c3e24834a5eee8079ba45d",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/dad4627dfeb45d8797c3e24834a5eee8079ba45d",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dad4627dfeb45d8797c3e24834a5eee8079ba45d/comments",
    "author": {
      "login": "whitslack",
      "id": 797782,
      "node_id": "MDQ6VXNlcjc5Nzc4Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/797782?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/whitslack",
      "html_url": "https://github.com/whitslack",
      "followers_url": "https://api.github.com/users/whitslack/followers",
      "following_url": "https://api.github.com/users/whitslack/following{/other_user}",
      "gists_url": "https://api.github.com/users/whitslack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/whitslack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/whitslack/subscriptions",
      "organizations_url": "https://api.github.com/users/whitslack/orgs",
      "repos_url": "https://api.github.com/users/whitslack/repos",
      "events_url": "https://api.github.com/users/whitslack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/whitslack/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "whitslack",
      "id": 797782,
      "node_id": "MDQ6VXNlcjc5Nzc4Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/797782?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/whitslack",
      "html_url": "https://github.com/whitslack",
      "followers_url": "https://api.github.com/users/whitslack/followers",
      "following_url": "https://api.github.com/users/whitslack/following{/other_user}",
      "gists_url": "https://api.github.com/users/whitslack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/whitslack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/whitslack/subscriptions",
      "organizations_url": "https://api.github.com/users/whitslack/orgs",
      "repos_url": "https://api.github.com/users/whitslack/repos",
      "events_url": "https://api.github.com/users/whitslack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/whitslack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "090530cc24054d6b4658752bb88f75a3b73eab5d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/090530cc24054d6b4658752bb88f75a3b73eab5d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/090530cc24054d6b4658752bb88f75a3b73eab5d"
      }
    ],
    "stats": {
      "total": 24,
      "additions": 20,
      "deletions": 4
    },
    "files": [
      {
        "sha": "972a5598c6aee210e67c0f58a96a9feb98394c64",
        "filename": "contrib/init/bitcoind.openrc",
        "status": "modified",
        "additions": 20,
        "deletions": 4,
        "changes": 24,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dad4627dfeb45d8797c3e24834a5eee8079ba45d/contrib/init/bitcoind.openrc",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dad4627dfeb45d8797c3e24834a5eee8079ba45d/contrib/init/bitcoind.openrc",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/contrib/init/bitcoind.openrc?ref=dad4627dfeb45d8797c3e24834a5eee8079ba45d",
        "patch": "@@ -17,14 +17,20 @@ BITCOIND_GROUP=${BITCOIND_GROUP:-bitcoin}\n BITCOIND_BIN=${BITCOIND_BIN:-/usr/bin/bitcoind}\n BITCOIND_NICE=${BITCOIND_NICE:-${NICELEVEL:-0}}\n BITCOIND_OPTS=\"${BITCOIND_OPTS:-${BITCOIN_OPTS}}\"\n+: ${BITCOIND_STARTUPFILE:=${BITCOIND_PIDFILE%.pid}.startup}\n \n name=\"Bitcoin Core Daemon\"\n description=\"Bitcoin cryptocurrency P2P network daemon\"\n \n-command=\"/usr/bin/bitcoind\"\n-command_args=\"-pid=\\\"${BITCOIND_PIDFILE}\\\" \\\n-\t\t-conf=\\\"${BITCOIND_CONFIGFILE}\\\" \\\n-\t\t-datadir=\\\"${BITCOIND_DATADIR}\\\" \\\n+command=\"/usr/bin/flock\"\n+command_args=\"--no-fork\n+\t\t$(/usr/bin/printf '%q' \"${BITCOIND_STARTUPFILE}\") \\\n+\t\t/usr/bin/bitcoind\n+\t\t$(/usr/bin/printf '%s=%q ' \\\n+\t\t\t-pid \"${BITCOIND_PIDFILE}\" \\\n+\t\t\t-conf \"${BITCOIND_CONFIGFILE}\" \\\n+\t\t\t-datadir \"${BITCOIND_DATADIR}\" \\\n+\t\t\t-startupnotify \"flock -u 3\") \\\n \t\t-daemon \\\n \t\t${BITCOIND_OPTS}\"\n \n@@ -67,6 +73,16 @@ start_pre() {\n \tcheckconfig || return 1\n }\n \n+start_post() {\n+\t# continue only after -startupnotify or daemon failure\n+\tif ! flock -n \"${BITCOIND_STARTUPFILE}\" true ; then\n+\t\tebegin \"Waiting for Bitcoin Core startup to finish\"\n+\t\tflock \"${BITCOIND_STARTUPFILE}\" true\n+\t\t[ -e \"${BITCOIND_PIDFILE}\" ]\n+\t\teend $?\n+\tfi\n+}\n+\n checkconfig()\n {\n \tif ! grep -qs '^rpcpassword=' \"${BITCOIND_CONFIGFILE}\" ; then"
      }
    ]
  }
]