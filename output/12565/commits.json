[
  {
    "sha": "69456ad30267551e21f1c5c4a1e54f59b29d45c7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2OTQ1NmFkMzAyNjc1NTFlMjFmMWM1YzRhMWU1NGY1OWIyOWQ0NWM3",
    "commit": {
      "author": {
        "name": "Karl-Johan Alm",
        "email": "karljohan-alm@garage.co.jp",
        "date": "2018-01-05T09:08:41Z"
      },
      "committer": {
        "name": "Karl-Johan Alm",
        "email": "karljohan-alm@garage.co.jp",
        "date": "2018-02-20T06:47:43Z"
      },
      "message": "[rpc] [wallet] Allow single-output transactions in bumpfee\nCurrently, bumpfee cannot be used to bump a single output transaction. This should be possible, as single output transactions are special in that the exact amount doesn't usually matter (the user is emptying a wallet or using coin control to move UTXOs).",
      "tree": {
        "sha": "29128e22f42c1162c184aed6aa7f95011b9178f3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/29128e22f42c1162c184aed6aa7f95011b9178f3"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/69456ad30267551e21f1c5c4a1e54f59b29d45c7",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEExCr/fGGz5EoUVM01V692LbM1MyIFAlqLxI8ACgkQV692LbM1\nMyJslA//SrC+tKquN8A/BQsQJcj9wQbnKLhXT9Re+3D9j/CfaC2j162JnpgyN6qg\n27djaSTzMU5a8+NOSW5K/l+Uw7Cbl2db6groIEkV9WeXmtYVEDIuj5gjbCiStX14\nkyl9pmUoYxUUz9Wli21nuR3wrFC18NZOGGnWeDkQt6ELi+POnldP7hGnUUUJkZq3\ngxq/9WP+7qaiTdvard9fmCaE4FgajUMneu9qVUK19mstulk8HjJ1XqRafVw/8iLq\nQrJVjoGaYDKZu5a8gK+9Pm/2l0mbuXqdpy6YMl6CIbEubjNtR5w48nzKkAm6Dw8q\nSo6liqp+4PdB5nUHWei8K0jeX0JGFZXD3KVRQ7bCmoEnwfkPP8kdS50mEwNWPYBg\nSynKQSEqlpT7wwLZVXqnV8/iH2l7zsm0TpBKn3SFos9Vdw5BR/i7koeHXSnV1zE5\n/zoBic5iRTPh2tKX8G0fUDrbvwJRRM59CBPmaZ6bJViRgRQlPWQiTFgAJgdvMVs+\nOj/AbCfl/M3BhrgwXi/k7uXAhMSgdJUfwugkdZsB0vx9hvb4mdwKKtC6oJG5s5ro\nwcHhewsHyHLPwl/AV3nbtB4TL8DOIZmZmY9uAms7RZlZWHjbJIPkMMTiOWlSdhY0\nvHilNcnuJwirB42LIMtQrWUgl8nffl3KP1hv0u7vRdRPKkRXs5c=\n=Ga14\n-----END PGP SIGNATURE-----",
        "payload": "tree 29128e22f42c1162c184aed6aa7f95011b9178f3\nparent ffc6e48b2983189dc0ce7de0a038e5329bc07b1b\nauthor Karl-Johan Alm <karljohan-alm@garage.co.jp> 1515143321 +0900\ncommitter Karl-Johan Alm <karljohan-alm@garage.co.jp> 1519109263 +0900\n\n[rpc] [wallet] Allow single-output transactions in bumpfee\nCurrently, bumpfee cannot be used to bump a single output transaction. This should be possible, as single output transactions are special in that the exact amount doesn't usually matter (the user is emptying a wallet or using coin control to move UTXOs).\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/69456ad30267551e21f1c5c4a1e54f59b29d45c7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/69456ad30267551e21f1c5c4a1e54f59b29d45c7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/69456ad30267551e21f1c5c4a1e54f59b29d45c7/comments",
    "author": {
      "login": "kallewoof",
      "id": 250224,
      "node_id": "MDQ6VXNlcjI1MDIyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/250224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kallewoof",
      "html_url": "https://github.com/kallewoof",
      "followers_url": "https://api.github.com/users/kallewoof/followers",
      "following_url": "https://api.github.com/users/kallewoof/following{/other_user}",
      "gists_url": "https://api.github.com/users/kallewoof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kallewoof/subscriptions",
      "organizations_url": "https://api.github.com/users/kallewoof/orgs",
      "repos_url": "https://api.github.com/users/kallewoof/repos",
      "events_url": "https://api.github.com/users/kallewoof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kallewoof/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "kallewoof",
      "id": 250224,
      "node_id": "MDQ6VXNlcjI1MDIyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/250224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kallewoof",
      "html_url": "https://github.com/kallewoof",
      "followers_url": "https://api.github.com/users/kallewoof/followers",
      "following_url": "https://api.github.com/users/kallewoof/following{/other_user}",
      "gists_url": "https://api.github.com/users/kallewoof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kallewoof/subscriptions",
      "organizations_url": "https://api.github.com/users/kallewoof/orgs",
      "repos_url": "https://api.github.com/users/kallewoof/repos",
      "events_url": "https://api.github.com/users/kallewoof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kallewoof/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ffc6e48b2983189dc0ce7de0a038e5329bc07b1b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ffc6e48b2983189dc0ce7de0a038e5329bc07b1b",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ffc6e48b2983189dc0ce7de0a038e5329bc07b1b"
      }
    ],
    "stats": {
      "total": 52,
      "additions": 34,
      "deletions": 18
    },
    "files": [
      {
        "sha": "5a67354e5b24c098860dcc0055462d84a0ffbefb",
        "filename": "src/qt/walletmodel.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/69456ad30267551e21f1c5c4a1e54f59b29d45c7/src/qt/walletmodel.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/69456ad30267551e21f1c5c4a1e54f59b29d45c7/src/qt/walletmodel.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/walletmodel.cpp?ref=69456ad30267551e21f1c5c4a1e54f59b29d45c7",
        "patch": "@@ -671,7 +671,7 @@ bool WalletModel::bumpFee(uint256 hash)\n     CAmount old_fee;\n     CAmount new_fee;\n     CMutableTransaction mtx;\n-    if (feebumper::CreateTransaction(wallet, hash, coin_control, 0 /* totalFee */, errors, old_fee, new_fee, mtx) != feebumper::Result::OK) {\n+    if (feebumper::CreateTransaction(wallet, hash, coin_control, 0 /* totalFee */, -1, errors, old_fee, new_fee, mtx) != feebumper::Result::OK) {\n         QMessageBox::critical(0, tr(\"Fee bump error\"), tr(\"Increasing transaction fee failed\") + \"<br />(\" +\n             (errors.size() ? QString::fromStdString(errors[0]) : \"\") +\")\");\n          return false;"
      },
      {
        "sha": "78ff7b23ad5f9b16773537a62f32098dbe5ca591",
        "filename": "src/wallet/feebumper.cpp",
        "status": "modified",
        "additions": 22,
        "deletions": 15,
        "changes": 37,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/69456ad30267551e21f1c5c4a1e54f59b29d45c7/src/wallet/feebumper.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/69456ad30267551e21f1c5c4a1e54f59b29d45c7/src/wallet/feebumper.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/feebumper.cpp?ref=69456ad30267551e21f1c5c4a1e54f59b29d45c7",
        "patch": "@@ -100,7 +100,8 @@ bool TransactionCanBeBumped(const CWallet* wallet, const uint256& txid)\n     return res == feebumper::Result::OK;\n }\n \n-Result CreateTransaction(const CWallet* wallet, const uint256& txid, const CCoinControl& coin_control, CAmount total_fee, std::vector<std::string>& errors,\n+Result CreateTransaction(const CWallet* wallet, const uint256& txid, const CCoinControl& coin_control,\n+                         CAmount total_fee, int32_t reduce_output, std::vector<std::string>& errors,\n                          CAmount& old_fee, CAmount& new_fee, CMutableTransaction& mtx)\n {\n     LOCK2(cs_main, wallet->cs_wallet);\n@@ -111,22 +112,28 @@ Result CreateTransaction(const CWallet* wallet, const uint256& txid, const CCoin\n         return Result::INVALID_ADDRESS_OR_KEY;\n     }\n     const CWalletTx& wtx = it->second;\n+    if (reduce_output < -1 || reduce_output >= int64_t(wtx.tx->vout.size())) {\n+        errors.push_back(strprintf(\"Change output out of bounds [-1..%zu]\", wtx.tx->vout.size()-1));\n+        return Result::INVALID_PARAMETER;\n+    }\n \n     Result result = PreconditionChecks(wallet, wtx, errors);\n     if (result != Result::OK) {\n         return result;\n     }\n \n-    // figure out which output was change\n-    // if there was no change output or multiple change outputs, fail\n-    int nOutput = -1;\n-    for (size_t i = 0; i < wtx.tx->vout.size(); ++i) {\n-        if (wallet->IsChange(wtx.tx->vout[i])) {\n-            if (nOutput != -1) {\n-                errors.push_back(\"Transaction has multiple change outputs\");\n-                return Result::WALLET_ERROR;\n+    int nOutput = reduce_output;\n+    if (nOutput == -1) {\n+        // figure out which output was change\n+        // if there was no change output or multiple change outputs, fail\n+        for (size_t i = 0; i < wtx.tx->vout.size(); ++i) {\n+            if (wallet->IsChange(wtx.tx->vout[i])) {\n+                if (nOutput != -1) {\n+                    errors.push_back(\"Transaction has multiple change outputs\");\n+                    return Result::WALLET_ERROR;\n+                }\n+                nOutput = i;\n             }\n-            nOutput = i;\n         }\n     }\n     if (nOutput == -1) {\n@@ -185,11 +192,11 @@ Result CreateTransaction(const CWallet* wallet, const uint256& txid, const CCoin\n     }\n \n     // Check that in all cases the new fee doesn't violate maxTxFee\n-     if (new_fee > maxTxFee) {\n-         errors.push_back(strprintf(\"Specified or calculated fee %s is too high (cannot be higher than maxTxFee %s)\",\n-                               FormatMoney(new_fee), FormatMoney(maxTxFee)));\n-         return Result::WALLET_ERROR;\n-     }\n+    if (new_fee > maxTxFee) {\n+        errors.push_back(strprintf(\"Specified or calculated fee %s is too high (cannot be higher than maxTxFee %s)\",\n+                         FormatMoney(new_fee), FormatMoney(maxTxFee)));\n+        return Result::WALLET_ERROR;\n+    }\n \n     // check that fee rate is higher than mempool's minimum fee\n     // (no point in bumping fee if we know that the new tx won't be accepted to the mempool)"
      },
      {
        "sha": "33191e97f3c39ad3b2e16e5cab38e298bda54200",
        "filename": "src/wallet/feebumper.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/69456ad30267551e21f1c5c4a1e54f59b29d45c7/src/wallet/feebumper.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/69456ad30267551e21f1c5c4a1e54f59b29d45c7/src/wallet/feebumper.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/feebumper.h?ref=69456ad30267551e21f1c5c4a1e54f59b29d45c7",
        "patch": "@@ -33,6 +33,7 @@ Result CreateTransaction(const CWallet* wallet,\n                          const uint256& txid,\n                          const CCoinControl& coin_control,\n                          CAmount total_fee,\n+                         int32_t reduce_output,\n                          std::vector<std::string>& errors,\n                          CAmount& old_fee,\n                          CAmount& new_fee,"
      },
      {
        "sha": "571ffaf4fc61c955ae2609648b12fba226366f23",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 2,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/69456ad30267551e21f1c5c4a1e54f59b29d45c7/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/69456ad30267551e21f1c5c4a1e54f59b29d45c7/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=69456ad30267551e21f1c5c4a1e54f59b29d45c7",
        "patch": "@@ -3319,7 +3319,8 @@ UniValue bumpfee(const JSONRPCRequest& request)\n             \"\\nBumps the fee of an opt-in-RBF transaction T, replacing it with a new transaction B.\\n\"\n             \"An opt-in RBF transaction with the given txid must be in the wallet.\\n\"\n             \"The command will pay the additional fee by decreasing (or perhaps removing) its change output.\\n\"\n-            \"If the change output is not big enough to cover the increased fee, the command will currently fail\\n\"\n+            \"If an explicit \\\"reduce_output\\\" has been picked, that will be decreased instead.\\n\"\n+            \"If the selected output is not big enough to cover the increased fee, the command will currently fail\\n\"\n             \"instead of adding new inputs to compensate. (A future implementation could improve this.)\\n\"\n             \"The command will fail if the wallet or mempool contains a transaction that spends one of T's outputs.\\n\"\n             \"By default, the new fee will be calculated automatically using estimatesmartfee.\\n\"\n@@ -3347,6 +3348,8 @@ UniValue bumpfee(const JSONRPCRequest& request)\n             \"         \\\"UNSET\\\"\\n\"\n             \"         \\\"ECONOMICAL\\\"\\n\"\n             \"         \\\"CONSERVATIVE\\\"\\n\"\n+            \"     \\\"reduce_output\\\"     (numeric, optional) Increase the fee by reducing the output value of the output at\\n\"\n+            \"                         the given index. NOTE: The recipient of the given output will receive a smaller amount!\\n\"\n             \"   }\\n\"\n             \"\\nResult:\\n\"\n             \"{\\n\"\n@@ -3366,6 +3369,7 @@ UniValue bumpfee(const JSONRPCRequest& request)\n \n     // optional parameters\n     CAmount totalFee = 0;\n+    int32_t reduce_output = -1;\n     CCoinControl coin_control;\n     coin_control.signalRbf = true;\n     if (!request.params[1].isNull()) {\n@@ -3376,6 +3380,7 @@ UniValue bumpfee(const JSONRPCRequest& request)\n                 {\"totalFee\", UniValueType(UniValue::VNUM)},\n                 {\"replaceable\", UniValueType(UniValue::VBOOL)},\n                 {\"estimate_mode\", UniValueType(UniValue::VSTR)},\n+                {\"reduce_output\", UniValueType(UniValue::VNUM)},\n             },\n             true, true);\n \n@@ -3398,6 +3403,9 @@ UniValue bumpfee(const JSONRPCRequest& request)\n                 throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid estimate_mode parameter\");\n             }\n         }\n+        if (options.exists(\"reduce_output\")) {\n+            reduce_output = options[\"reduce_output\"].get_int64();\n+        }\n     }\n \n     // Make sure the results are valid at least up to the most recent block\n@@ -3412,7 +3420,7 @@ UniValue bumpfee(const JSONRPCRequest& request)\n     CAmount old_fee;\n     CAmount new_fee;\n     CMutableTransaction mtx;\n-    feebumper::Result res = feebumper::CreateTransaction(pwallet, hash, coin_control, totalFee, errors, old_fee, new_fee, mtx);\n+    feebumper::Result res = feebumper::CreateTransaction(pwallet, hash, coin_control, totalFee, reduce_output, errors, old_fee, new_fee, mtx);\n     if (res != feebumper::Result::OK) {\n         switch(res) {\n             case feebumper::Result::INVALID_ADDRESS_OR_KEY:"
      }
    ]
  },
  {
    "sha": "cf02bcb3edb5aac2a93310809fe52c3e2cf02950",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjZjAyYmNiM2VkYjVhYWMyYTkzMzEwODA5ZmU1MmMzZTJjZjAyOTUw",
    "commit": {
      "author": {
        "name": "Karl-Johan Alm",
        "email": "karljohan-alm@garage.co.jp",
        "date": "2018-01-05T09:59:19Z"
      },
      "committer": {
        "name": "Karl-Johan Alm",
        "email": "karljohan-alm@garage.co.jp",
        "date": "2018-02-20T06:49:14Z"
      },
      "message": "[test] Test single-output transaction bumpfee",
      "tree": {
        "sha": "cfe9d086904a23ab5d480626bdee4df5fa815b13",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cfe9d086904a23ab5d480626bdee4df5fa815b13"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/cf02bcb3edb5aac2a93310809fe52c3e2cf02950",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEExCr/fGGz5EoUVM01V692LbM1MyIFAlqLxOoACgkQV692LbM1\nMyIo9w/7BXcgkmcT26Nhdvs8V8mkobwQB8K0OeyZUqdKRrqjBeg5zClBOSDJ1TRZ\noYfZ+QvtR7q/QBrkgzzeSTI4R+do1FEc1HambV0uuO+YTd+JvKZtFZ0T1HZ0rP9j\njSUEgqGjF4NY1LvizgfZ7MAlCB7Rn3dSiBuIPDa8Sa3YL5h3nzmFm71J64dxn4ey\nTrkMf/hLe4UrU52E9ECV+HQ7WWrIAcccogSYQMCQcRHmaI28e6mLJ1cAPv42QIl5\ncXiRbPkMNx9cbcxEvG4aqSQ5IqS1k7zmVkp7QmNAd9kVpoa3vk7lvNaBfaGy+og/\nQg3o5wzM4jfqnIsxeju56FyyFfGmz29EwOvBIektOqe0So0kOYZQONNuXcU9bBw5\nT8spYoq2E187JVxfGfSqWycPjtrxtrp/L1D4YHTFs2n3mGiLWOhdIgSLYeAjVg1a\n2KMc8j3iL+ReviQ3fnkCkKfWhjsbJah+oXHZri2gCO96d0UPRAc3+Or2PSD74Y/w\noDKs0/J7g5h5MZh2+rUaDjgLVFDVqNCoX1N+lD+JDtGSSCN4KGE8c0QWNxp1uzV3\nX0cpIPIiEMWXDKuK+831U6pdXuuxS+z1/AmLhdMOkR0bWw1OSV+wJ8uimtozmcIJ\nJVGW9fOgyPc6Eer4dpvO85K4vUv72nyOStz+CWd5g2RmcOh7UOg=\n=+BPb\n-----END PGP SIGNATURE-----",
        "payload": "tree cfe9d086904a23ab5d480626bdee4df5fa815b13\nparent 69456ad30267551e21f1c5c4a1e54f59b29d45c7\nauthor Karl-Johan Alm <karljohan-alm@garage.co.jp> 1515146359 +0900\ncommitter Karl-Johan Alm <karljohan-alm@garage.co.jp> 1519109354 +0900\n\n[test] Test single-output transaction bumpfee\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/cf02bcb3edb5aac2a93310809fe52c3e2cf02950",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/cf02bcb3edb5aac2a93310809fe52c3e2cf02950",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/cf02bcb3edb5aac2a93310809fe52c3e2cf02950/comments",
    "author": {
      "login": "kallewoof",
      "id": 250224,
      "node_id": "MDQ6VXNlcjI1MDIyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/250224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kallewoof",
      "html_url": "https://github.com/kallewoof",
      "followers_url": "https://api.github.com/users/kallewoof/followers",
      "following_url": "https://api.github.com/users/kallewoof/following{/other_user}",
      "gists_url": "https://api.github.com/users/kallewoof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kallewoof/subscriptions",
      "organizations_url": "https://api.github.com/users/kallewoof/orgs",
      "repos_url": "https://api.github.com/users/kallewoof/repos",
      "events_url": "https://api.github.com/users/kallewoof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kallewoof/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "kallewoof",
      "id": 250224,
      "node_id": "MDQ6VXNlcjI1MDIyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/250224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kallewoof",
      "html_url": "https://github.com/kallewoof",
      "followers_url": "https://api.github.com/users/kallewoof/followers",
      "following_url": "https://api.github.com/users/kallewoof/following{/other_user}",
      "gists_url": "https://api.github.com/users/kallewoof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kallewoof/subscriptions",
      "organizations_url": "https://api.github.com/users/kallewoof/orgs",
      "repos_url": "https://api.github.com/users/kallewoof/repos",
      "events_url": "https://api.github.com/users/kallewoof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kallewoof/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "69456ad30267551e21f1c5c4a1e54f59b29d45c7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/69456ad30267551e21f1c5c4a1e54f59b29d45c7",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/69456ad30267551e21f1c5c4a1e54f59b29d45c7"
      }
    ],
    "stats": {
      "total": 40,
      "additions": 39,
      "deletions": 1
    },
    "files": [
      {
        "sha": "ceb992f0d60b52c9c646af648f993259b1ca9471",
        "filename": "test/functional/wallet_bumpfee.py",
        "status": "modified",
        "additions": 39,
        "deletions": 1,
        "changes": 40,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/cf02bcb3edb5aac2a93310809fe52c3e2cf02950/test/functional/wallet_bumpfee.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/cf02bcb3edb5aac2a93310809fe52c3e2cf02950/test/functional/wallet_bumpfee.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/wallet_bumpfee.py?ref=cf02bcb3edb5aac2a93310809fe52c3e2cf02950",
        "patch": "@@ -73,6 +73,8 @@ def run_test(self):\n         test_rebumping_not_replaceable(rbf_node, dest_address)\n         test_unconfirmed_not_spendable(rbf_node, rbf_node_address)\n         test_bumpfee_metadata(rbf_node, dest_address)\n+        test_single_output_bump(rbf_node, dest_address)\n+        test_explicit_reduce_output(rbf_node, dest_address)\n         test_locked_wallet_fails(rbf_node, dest_address)\n         self.log.info(\"Success\")\n \n@@ -270,6 +272,43 @@ def test_locked_wallet_fails(rbf_node, dest_address):\n     assert_raises_rpc_error(-13, \"Please enter the wallet passphrase with walletpassphrase first.\",\n                           rbf_node.bumpfee, rbfid)\n \n+def test_single_output_bump(node, dest_address):\n+    tx_input = dict(\n+        sequence=BIP125_SEQUENCE_NUMBER, **next(u for u in node.listunspent() if u[\"amount\"] == Decimal(\"0.00100000\")))\n+    rawtx = node.createrawtransaction([tx_input], {dest_address: Decimal(\"0.00099000\")})\n+    signedtx = node.signrawtransactionwithwallet(rawtx)\n+    txid = node.sendrawtransaction(signedtx[\"hex\"])\n+    assert_raises_rpc_error(-4, \"Transaction does not have a change output\", node.bumpfee, txid)\n+    bumped_tx = node.bumpfee(txid, {\"reduce_output\": 0})\n+    bumped_txob = node.getrawtransaction(bumped_tx[\"txid\"], True)\n+    # Only one vout\n+    assert_equal(1, len(bumped_txob[\"vout\"]))\n+    # The vout should have decreased in value, which means 0.00099 > value\n+    assert_greater_than(Decimal(\"0.00099000\"), bumped_txob[\"vout\"][0][\"value\"])\n+\n+def test_explicit_reduce_output(node, dest_address):\n+    txid = spend_one_input(node, dest_address)\n+    txidob = node.getrawtransaction(txid, True)\n+    # OOB checks\n+    assert_raises_rpc_error(-8, \"Change output out of bounds\", node.bumpfee, txid, {\"reduce_output\": -2})\n+    assert_raises_rpc_error(-8, \"Change output out of bounds\", node.bumpfee, txid, {\"reduce_output\": len(txidob[\"vout\"])})\n+    # Type checks\n+    assert_raises_rpc_error(-3, \"Expected type number\", node.bumpfee, txid, {\"reduce_output\": False})\n+    assert_raises_rpc_error(-3, \"Expected type number\", node.bumpfee, txid, {\"reduce_output\": True})\n+    assert_raises_rpc_error(-3, \"Expected type number\", node.bumpfee, txid, {\"reduce_output\": \"HELLO\"})\n+    # Figure out which is which\n+    spendidx = 0 if txidob[\"vout\"][0][\"value\"] == Decimal(\"0.00050000\") else 1\n+    bumped_tx = node.bumpfee(txid, {\"reduce_output\": spendidx})\n+    bumped_txob = node.getrawtransaction(bumped_tx[\"txid\"], True)\n+    assert_greater_than(Decimal(\"0.00050000\"), bumped_txob[\"vout\"][spendidx][\"value\"])\n+    assert_equal(Decimal(\"0.00049000\"), bumped_txob[\"vout\"][1 - spendidx][\"value\"])\n+    txid = spend_one_input(node, dest_address)\n+    txidob = node.getrawtransaction(txid, True)\n+    spendidx = 0 if txidob[\"vout\"][0][\"value\"] == Decimal(\"0.00050000\") else 1\n+    bumped_tx = node.bumpfee(txid, {\"reduce_output\": 1 - spendidx})\n+    bumped_txob = node.getrawtransaction(bumped_tx[\"txid\"], True)\n+    assert_equal(Decimal(\"0.00050000\"), bumped_txob[\"vout\"][spendidx][\"value\"])\n+    assert_greater_than(Decimal(\"0.00049000\"), bumped_txob[\"vout\"][1 - spendidx][\"value\"])\n \n def spend_one_input(node, dest_address):\n     tx_input = dict(\n@@ -281,7 +320,6 @@ def spend_one_input(node, dest_address):\n     txid = node.sendrawtransaction(signedtx[\"hex\"])\n     return txid\n \n-\n def submit_block_with_tx(node, tx):\n     ctx = CTransaction()\n     ctx.deserialize(io.BytesIO(hex_str_to_bytes(tx)))"
      }
    ]
  },
  {
    "sha": "624f27c4d33b241ba3863c8b69a4134207666960",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2MjRmMjdjNGQzM2IyNDFiYTM4NjNjOGI2OWE0MTM0MjA3NjY2OTYw",
    "commit": {
      "author": {
        "name": "Karl-Johan Alm",
        "email": "karljohan-alm@garage.co.jp",
        "date": "2018-02-27T04:42:46Z"
      },
      "committer": {
        "name": "Karl-Johan Alm",
        "email": "karljohan-alm@garage.co.jp",
        "date": "2018-02-27T04:42:46Z"
      },
      "message": "f'throw when explicit -1 reduce_output is given in options",
      "tree": {
        "sha": "0041d3356fb0a79a4e0ba6ab78e94b91db3a0de1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0041d3356fb0a79a4e0ba6ab78e94b91db3a0de1"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/624f27c4d33b241ba3863c8b69a4134207666960",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEExCr/fGGz5EoUVM01V692LbM1MyIFAlqU4cYACgkQV692LbM1\nMyJy1A/+KA0dHoW/Vfbj0oOVK+howXbuOoF4PPws0DOVH5bE98GDRSrxEUD/fx6e\n7oj0atGsQ+Ejh5JmLKNfRxb9Z2PfmVWW45pEHD99ShKO+LVpL0qTcLiz4wf9mHE6\n5gUFEX1TDjOSSuxtPQzuUFAsuxPqKtJfVN/8m0i5Ees8ONjer8UpHRBLFqzRNS8F\nmkqjKraXjyhzMuh/+AwamPoCYRxsf3LQVqJPZ2B34hCx5OGHuPs0gz3q9KAgetCC\nmkOzbUdxqdpDbW4x6AF5xiihrRYrCmtmbkbXAstgW1U1vhjR+K+lH1DE/RHCXWow\ni8BHe10q9w60Eak+sWSUIHJpq3LesD0QIFpFSlXAE00km14aZYCXqZfzURnNw/Cn\nxzUGHq5By/B4MqLH6Dv7/hG1svdmVuIFw59i7PzBSKI7fRtoub6pa88E8mbbCt9e\nfOV+Pv+cd4RHHCArbh6TF5baXjO5sMpNU2Ijdf02eCUxCHNDNtZCbudeuzbi2+r3\nogp5v4mwtyFD1+6J1r/J+DSQw1bwEE5Sg/LXvA5JQZE8mIp0ZYvPg8o7Ywuz1R7A\nCXHeQLMc+qqVKtvePyijD38cMiTwzZy6ngg4SMYfMGK7rfFOOjAitsH0QjBw0uTK\nbhqjwVw39DAFZdl2C59m2V5herwmtDKC6F52T2P2H4+PFz7ocYU=\n=s+Du\n-----END PGP SIGNATURE-----",
        "payload": "tree 0041d3356fb0a79a4e0ba6ab78e94b91db3a0de1\nparent cf02bcb3edb5aac2a93310809fe52c3e2cf02950\nauthor Karl-Johan Alm <karljohan-alm@garage.co.jp> 1519706566 +0900\ncommitter Karl-Johan Alm <karljohan-alm@garage.co.jp> 1519706566 +0900\n\nf'throw when explicit -1 reduce_output is given in options\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/624f27c4d33b241ba3863c8b69a4134207666960",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/624f27c4d33b241ba3863c8b69a4134207666960",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/624f27c4d33b241ba3863c8b69a4134207666960/comments",
    "author": {
      "login": "kallewoof",
      "id": 250224,
      "node_id": "MDQ6VXNlcjI1MDIyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/250224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kallewoof",
      "html_url": "https://github.com/kallewoof",
      "followers_url": "https://api.github.com/users/kallewoof/followers",
      "following_url": "https://api.github.com/users/kallewoof/following{/other_user}",
      "gists_url": "https://api.github.com/users/kallewoof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kallewoof/subscriptions",
      "organizations_url": "https://api.github.com/users/kallewoof/orgs",
      "repos_url": "https://api.github.com/users/kallewoof/repos",
      "events_url": "https://api.github.com/users/kallewoof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kallewoof/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "kallewoof",
      "id": 250224,
      "node_id": "MDQ6VXNlcjI1MDIyNA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/250224?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kallewoof",
      "html_url": "https://github.com/kallewoof",
      "followers_url": "https://api.github.com/users/kallewoof/followers",
      "following_url": "https://api.github.com/users/kallewoof/following{/other_user}",
      "gists_url": "https://api.github.com/users/kallewoof/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kallewoof/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kallewoof/subscriptions",
      "organizations_url": "https://api.github.com/users/kallewoof/orgs",
      "repos_url": "https://api.github.com/users/kallewoof/repos",
      "events_url": "https://api.github.com/users/kallewoof/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kallewoof/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "cf02bcb3edb5aac2a93310809fe52c3e2cf02950",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/cf02bcb3edb5aac2a93310809fe52c3e2cf02950",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/cf02bcb3edb5aac2a93310809fe52c3e2cf02950"
      }
    ],
    "stats": {
      "total": 3,
      "additions": 3,
      "deletions": 0
    },
    "files": [
      {
        "sha": "29ea1ffb65eeb64b7fea5ca68ed336f3b21aebd1",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/624f27c4d33b241ba3863c8b69a4134207666960/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/624f27c4d33b241ba3863c8b69a4134207666960/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=624f27c4d33b241ba3863c8b69a4134207666960",
        "patch": "@@ -3405,6 +3405,9 @@ UniValue bumpfee(const JSONRPCRequest& request)\n         }\n         if (options.exists(\"reduce_output\")) {\n             reduce_output = options[\"reduce_output\"].get_int64();\n+            if (reduce_output < 0) {\n+                throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid reduce_output parameter (cannot be negative)\");\n+            }\n         }\n     }\n "
      }
    ]
  },
  {
    "sha": "81bcb253e18ff830a80145dfebf8339e5f47993a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4MWJjYjI1M2UxOGZmODMwYTgwMTQ1ZGZlYmY4MzM5ZTVmNDc5OTNh",
    "commit": {
      "author": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2018-02-28T12:40:38Z"
      },
      "committer": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2018-02-28T12:40:38Z"
      },
      "message": "[qt] bumpfee: offer user to reduce output for transactions without change",
      "tree": {
        "sha": "b4d9f7716aee904d751359a47ae484eef58cd0ba",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b4d9f7716aee904d751359a47ae484eef58cd0ba"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/81bcb253e18ff830a80145dfebf8339e5f47993a",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7ZvfetalXiMuhFJCV/+b28wwEAkFAlqWo0YACgkQV/+b28ww\nEAnSKA//QxIYz6TNDpRdWpzh64GW6ltXhFte8tHZEOooh9ViziPXXQgvR9riT6TV\nH+wsz/xY2c6Z5GkIuNwhz7Od9IjSs1VsUSO3Eim6ysgKHSDjRqFvNws0LO4vKR+O\nSEroQr0LJq5qhNjdi+8aR5VIITVLXi5FOv7y0SuGrQwUEum7RbdXUWJluLDfVCsq\n9b+pNvBHNIQhd75MYqb8DLgsD8YXQGmx1Cnt6bzxT0AJvHwsrRaL2FTsRxpXDv3c\nsWQ7oNU1EXCo6qnTtZzmeElq8r/gwcUQa1roBfPvI8lXLg59cvZurO1Jmxk5tqnW\noy/4ULqFcJ0c9+XTL9G4ACORGolXQzlZNXanUo07HsO4tcIAYV/VFSDptGIKtH7k\nzcxBL6skR/AdhDeLncVyuUzetLWL13UZVcN3rV4GeHjet2dH/Y3fgitHRa27GhU8\ng2bVDsf6MTsrI6JL4gjccNA5wixybNwIhngfIw20XE5lMlSOdfLgAMUdtac+HE2R\nA6AC5WxF7IdK95ZBr8TNzMkS0tqBbGQ2eqhZP/xMBfapX6OszQ+OOltVvMiyG55C\nbtepg/DKZxQezGNAJoaopG85P7utJ3b46lmRVdiK9GHDEjjWOK/YailbLiKi0C/6\nQWpTZ79X7NLwl7+7Tp2nPwplDdR9BKUCiE9X4MBo0fNvIKYZBCE=\n=x7nh\n-----END PGP SIGNATURE-----",
        "payload": "tree b4d9f7716aee904d751359a47ae484eef58cd0ba\nparent 624f27c4d33b241ba3863c8b69a4134207666960\nauthor Sjors Provoost <sjors@sprovoost.nl> 1519821638 +0100\ncommitter Sjors Provoost <sjors@sprovoost.nl> 1519821638 +0100\n\n[qt] bumpfee: offer user to reduce output for transactions without change\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/81bcb253e18ff830a80145dfebf8339e5f47993a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/81bcb253e18ff830a80145dfebf8339e5f47993a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/81bcb253e18ff830a80145dfebf8339e5f47993a/comments",
    "author": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url": "https://api.github.com/users/Sjors/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url": "https://api.github.com/users/Sjors/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "624f27c4d33b241ba3863c8b69a4134207666960",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/624f27c4d33b241ba3863c8b69a4134207666960",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/624f27c4d33b241ba3863c8b69a4134207666960"
      }
    ],
    "stats": {
      "total": 20,
      "additions": 18,
      "deletions": 2
    },
    "files": [
      {
        "sha": "3c0524333439ee71ae5d46ddae746676bebebba8",
        "filename": "src/qt/walletmodel.cpp",
        "status": "modified",
        "additions": 18,
        "deletions": 2,
        "changes": 20,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/81bcb253e18ff830a80145dfebf8339e5f47993a/src/qt/walletmodel.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/81bcb253e18ff830a80145dfebf8339e5f47993a/src/qt/walletmodel.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/walletmodel.cpp?ref=81bcb253e18ff830a80145dfebf8339e5f47993a",
        "patch": "@@ -671,14 +671,30 @@ bool WalletModel::bumpFee(uint256 hash)\n     CAmount old_fee;\n     CAmount new_fee;\n     CMutableTransaction mtx;\n-    if (feebumper::CreateTransaction(wallet, hash, coin_control, 0 /* totalFee */, -1, errors, old_fee, new_fee, mtx) != feebumper::Result::OK) {\n+\n+    // If the transaction has a single output, ask user if it's OK to reduce:\n+    int32_t reduce_output = -1;\n+    auto it = wallet->mapWallet.find(hash);\n+    if (it != wallet->mapWallet.end()) {\n+        const CWalletTx wtx = it->second;\n+        if (wtx.tx->vout.size() == 1) {\n+            reduce_output = 0;\n+        }\n+    }\n+\n+    if (feebumper::CreateTransaction(wallet, hash, coin_control, 0 /* totalFee */, reduce_output, errors, old_fee, new_fee, mtx) != feebumper::Result::OK) {\n         QMessageBox::critical(0, tr(\"Fee bump error\"), tr(\"Increasing transaction fee failed\") + \"<br />(\" +\n             (errors.size() ? QString::fromStdString(errors[0]) : \"\") +\")\");\n          return false;\n     }\n \n     // allow a user based fee verification\n-    QString questionString = tr(\"Do you want to increase the fee?\");\n+    QString questionString;\n+    if (reduce_output == -1) {\n+        questionString = tr(\"Do you want to increase the fee?\");\n+    } else {\n+        questionString = tr(\"Increasing the fee for this transaction reduces the amount sent. Only do this when sending to a destination you control.\");\n+    }\n     questionString.append(\"<br />\");\n     questionString.append(\"<table style=\\\"text-align: left;\\\">\");\n     questionString.append(\"<tr><td>\");"
      }
    ]
  }
]