MarcoFalke,2020-04-17 20:45:07,"The error was ""  Called Process failed with 'error: Could not locate RPC credentials. No authentication cookie could be found, and RPC password is not set.  See -rpcpassword and -stdinrpcpass.  Configuration file: (/home/travis/build/bitcoin/bitcoin/ci/scratch/test_runner/test_runner_‚Çø_üèÉ_20200417_132645/interface_bitcoin_cli_109/node0/bitcoin.conf) """,https://github.com/bitcoin/bitcoin/pull/18691#issuecomment-615455661,615455661,
jonatack,2020-04-17 20:53:40,"Yes. I'm still looking at it, but since valgrind runs don't work out-of-repo, I wanted to see if the valgrind CI passes with this change while looking further.",https://github.com/bitcoin/bitcoin/pull/18691#issuecomment-615458697,615458697,
MarcoFalke,2020-04-17 21:08:43,"`get_auth_cookie` is used by every single test. It reads the auth cookie from disk, though it fails when the file was not yet created.",https://github.com/bitcoin/bitcoin/pull/18691#issuecomment-615464435,615464435,
DrahtBot,2020-04-17 22:54:13,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18594 (cli: display multiwallet balances in -getinfo by jonatack)\n* #18453 (rpc, cli: add multiwallet balances rpc and u",https://github.com/bitcoin/bitcoin/pull/18691#issuecomment-615497907,615497907,
MarcoFalke,2020-04-18 15:39:34,"Btw, this happens on cirrus reliably: https://cirrus-ci.com/task/6597545033990144?command=functional_test#L1053",https://github.com/bitcoin/bitcoin/pull/18691#issuecomment-615891534,615891534,
MarcoFalke,2020-04-18 15:42:47,"Or, if you want to test locally:\n\n```diff\ndiff --git a/src/httprpc.cpp b/src/httprpc.cpp\nindex 60c4d06f12..3dd06c4758 100644\n--- a/src/httprpc.cpp\n+++ b/src/httprpc.cpp\n@@ -291,6 +291,7 @@ static bool InitRPCAuthentication()\n bool StartHTTPRPC()\n {\n     LogPrint(BCLog::RPC, ""Starting HTTP RPC server\n"");\n+    UninterruptibleSleep(std::chrono::seconds{11});\n     if (!InitRPC",https://github.com/bitcoin/bitcoin/pull/18691#issuecomment-615892030,615892030,
jonatack,2020-04-18 16:54:27,Thanks @MarcoFalke for your suggestions! Being able to reproduce makes all the difference. I updated the PR title and description and pushed a fix that seems to work.,https://github.com/bitcoin/bitcoin/pull/18691#issuecomment-615902936,615902936,
jonatack,2020-04-18 18:44:28,I see that the CI for the latest merge on master (bump wallet_import timeout) failed for this same reason: https://travis-ci.org/github/bitcoin/bitcoin/jobs/676639823,https://github.com/bitcoin/bitcoin/pull/18691#issuecomment-615924424,615924424,
jonatack,2020-04-18 20:17:11,"Simplified.\n\nEdit: FWIW I considered adding the following but don't think it's necessary? IIUC `wait_for_cookie_credentials` shouldn't see any other type of ValueError, nor ECONNREFUSED.\n```diff\n+            except OSError as e:\n+                if e.errno != errno.ECONNREFUSED:  # Port not yet open?\n+                    raise  # Unknown OS error\n-            except ValueError:\n-  ",https://github.com/bitcoin/bitcoin/pull/18691#issuecomment-615939057,615939057,
jonatack,2020-04-18 23:25:03,Took the suggestions.,https://github.com/bitcoin/bitcoin/pull/18691#issuecomment-615977562,615977562,
jonatack,2020-04-20 01:16:57,Rebased and added a docstring to `wait_for_cookie_credentials()`.,https://github.com/bitcoin/bitcoin/pull/18691#issuecomment-616259926,616259926,
MarcoFalke,2020-04-18 17:06:25,"I don't really like offering two interfaces. The existing one that either returns an auth pair or thorws a ValueError should be sufficient.\n\nIf you don't like the generic ValueError, I believe python can create derived classes like this `RpcCredentialsMissing(ValueError)`, which you can then throw/catch.",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r410723624,410723624,test/functional/test_framework/util.py
jonatack,2020-04-18 19:15:33,"Thanks for reviewing and your help. If I understand your comment correctly, I modified the conditional here not to change the interface, but to not raise when we're waiting for the cookie auth credentials. When they do become available, it still returns the auth pair which we're waiting for in `wait_for_cookie_credentials()`.",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r410738978,410738978,test/functional/test_framework/util.py
jonatack,2020-04-18 19:17:55,"E.g. since `wait_for_cookie` is false by default, there is no change in behavior except when it's called by `wait_for_cookie_credentials`.",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r410739285,410739285,test/functional/test_framework/util.py
MarcoFalke,2020-04-18 19:36:05,"Yeah, I don't understand why `wait_for_cookie` is needed? Just because it is turned off by default doesn't mean that it doesn't complicate the interface",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r410741317,410741317,test/functional/test_framework/util.py
jonatack,2020-04-18 19:42:09,"Hm, maybe it isn't. Good question.",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r410741948,410741948,test/functional/test_framework/util.py
MarcoFalke,2020-04-18 19:47:23,"They should never be empty. \n\nEither both are a string of length of at least 1 or a ValueError is thrown",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r410742490,410742490,test/functional/test_framework/util.py
jonatack,2020-04-18 20:06:04,"Good catch, fixed.",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r410744291,410744291,test/functional/test_framework/util.py
MarcoFalke,2020-04-18 22:42:25,"nit: Could rebase and adjust the error to mention the timeout (like the one above, which you can see after rebase)",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r410763238,410763238,test/functional/test_framework/test_node.py
MarcoFalke,2020-04-18 22:43:09,"nit: the values aren't needed, only their presence, so no need to log them?",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r410763361,410763361,test/functional/test_framework/test_node.py
MarcoFalke,2020-04-18 22:44:08,nit: In a future cleanup the three occurrences of `ValueError` can be changed to a self-made error `RpcMissingCred` (or so). Not asking you to do this here.,https://github.com/bitcoin/bitcoin/pull/18691#discussion_r410763588,410763588,test/functional/test_framework/test_node.py
jonatack,2020-04-18 23:18:33,done,https://github.com/bitcoin/bitcoin/pull/18691#discussion_r410768629,410768629,test/functional/test_framework/test_node.py
jonatack,2020-04-18 23:18:50,good idea; done,https://github.com/bitcoin/bitcoin/pull/18691#discussion_r410768689,410768689,test/functional/test_framework/test_node.py
jonatack,2020-04-18 23:22:27,"> nit: In a future cleanup the three occurrences of `ValueError` can be changed to a self-made error `RpcMissingCred` (or so). Not asking you to do this here.\n\nGood idea. Will look at a follow-up.",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r410769244,410769244,test/functional/test_framework/test_node.py
MarcoFalke,2020-04-20 10:08:36,Why is this changed?,https://github.com/bitcoin/bitcoin/pull/18691#discussion_r411256083,411256083,test/functional/interface_bitcoin_cli.py
MarcoFalke,2020-04-20 10:19:23,"-version is not an rpc command, but a command line option",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r411262769,411262769,test/functional/interface_bitcoin_cli.py
MarcoFalke,2020-04-20 10:19:38,same here,https://github.com/bitcoin/bitcoin/pull/18691#discussion_r411262902,411262902,test/functional/interface_bitcoin_cli.py
jonatack,2020-04-20 13:20:48,"I changed it to improve the debug log output:\n```diff\n- TestFramework.bitcoincli (DEBUG): Running bitcoin-cli command: None\n+ TestFramework.bitcoincli (DEBUG): Running bitcoin-cli command: -getinfo\n\n- TestFramework.bitcoincli (DEBUG): Running bitcoin-cli command: None\n+ TestFramework.bitcoincli (DEBUG): Running bitcoin-cli command: -version\n```\nI can revert it in #18594 that also t",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r411371164,411371164,test/functional/interface_bitcoin_cli.py
MarcoFalke,2020-04-20 13:36:41,"That should be fixed by logging the options, not passing the command line option as the rpc command",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r411382589,411382589,test/functional/interface_bitcoin_cli.py
jonatack,2020-04-20 21:38:54,"> That should be fixed by logging the options, not passing the command line option as the rpc command\n\nDone in #18712.",https://github.com/bitcoin/bitcoin/pull/18691#discussion_r411710273,411710273,test/functional/interface_bitcoin_cli.py
