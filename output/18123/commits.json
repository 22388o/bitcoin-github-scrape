[
  {
    "sha": "bf36a3ccc212ad4d7c5cb8f26d7a22e279fe3cec",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiZjM2YTNjY2MyMTJhZDRkN2M1Y2I4ZjI2ZDdhMjJlMjc5ZmUzY2Vj",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2020-02-11T21:53:53Z"
      },
      "committer": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2020-02-11T21:53:53Z"
      },
      "message": "gui: Fix race in WalletModel::pollBalanceChanged\n\nPoll function was wrongly setting cached height to the current chain height\ninstead of the chain height at the time of polling.\n\nThis bug could cause balances to appear out of date, and was first introduced\nhttps://github.com/bitcoin/bitcoin/pull/10244/commits/a0704a8996bb950ae3c4d5b5a30e9dfe34cde1d3#r378452145\nBefore that commit, there wasn't a problem because cs_main was held during the\npoll update.\n\nCurrently, the problem should be rare. But if\n8937d99ce81a27ae5e1012a28323c0e26d89c50b from #17954 were merged, the problem\nwould get worse, because the wrong cachedNumBlocks value would be set if the\nwallet was polled in the interval between a block being connected and it\nprocessing the BlockConnected notification.\n\nMarcoFalke <falke.marco@gmail.com> also points out that a0704a8996b could lead\nto GUI hangs as well, because previously the pollBalanceChanged method, which\nruns on the GUI thread, would only make a nonblocking TRY_LOCK(cs_main) call,\nbut after could make blocking LOCK(cs_main) calls, potentially locking up the\nGUI.\n\nThanks to John Newbery <john@johnnewbery.com> for finding this bug this while\nreviewing https://github.com/bitcoin/bitcoin/pull/17954.",
      "tree": {
        "sha": "d0e99a3f8fd6d23b0e6ca0b567a16f828c3fb52f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d0e99a3f8fd6d23b0e6ca0b567a16f828c3fb52f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bf36a3ccc212ad4d7c5cb8f26d7a22e279fe3cec",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bf36a3ccc212ad4d7c5cb8f26d7a22e279fe3cec",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/bf36a3ccc212ad4d7c5cb8f26d7a22e279fe3cec",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bf36a3ccc212ad4d7c5cb8f26d7a22e279fe3cec/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "98264e2ccb177a6603fe957f7e263fb413b50d04",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/98264e2ccb177a6603fe957f7e263fb413b50d04",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/98264e2ccb177a6603fe957f7e263fb413b50d04"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 2,
      "deletions": 2
    },
    "files": [
      {
        "sha": "8a84a8c1689f8c9f8707ce3348075a06adb34327",
        "filename": "src/qt/walletmodel.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/bf36a3ccc212ad4d7c5cb8f26d7a22e279fe3cec/src/qt/walletmodel.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/bf36a3ccc212ad4d7c5cb8f26d7a22e279fe3cec/src/qt/walletmodel.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/walletmodel.cpp?ref=bf36a3ccc212ad4d7c5cb8f26d7a22e279fe3cec",
        "patch": "@@ -82,12 +82,12 @@ void WalletModel::pollBalanceChanged()\n         return;\n     }\n \n-    if(fForceCheckBalanceChanged || m_node.getNumBlocks() != cachedNumBlocks)\n+    if(fForceCheckBalanceChanged || numBlocks != cachedNumBlocks)\n     {\n         fForceCheckBalanceChanged = false;\n \n         // Balance and number of transactions might have changed\n-        cachedNumBlocks = m_node.getNumBlocks();\n+        cachedNumBlocks = numBlocks;\n \n         checkBalanceChanged(new_balances);\n         if(transactionTableModel)"
      }
    ]
  }
]