DrahtBot,2019-01-18T22:37:03Z,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19107 (p2p: Refactor, move all header verification into the network layer, without changing behavior by troygiorshev)\n* ",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-455710529,455710529,
laanwj,2019-01-19T16:29:19Z,Concept ACK,https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-455794363,455794363,
gmaxwell,2019-01-19T17:42:22Z,"I don't the deferred processing matters-- the checkvalue is protecting against network corruption not malicious input or anything like that, but I also don't think that doing it eagerly is harmful either.\n\nOne consequence of this is that it moves more processing into the networking thread, rather than leaving it in the message processing thread. As a result it may result in lower performance i",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-455800025,455800025,
sipa,2019-01-19T17:46:16Z,"@gmaxwell It actually doesn't change much, as the message hash is being computed on the fly as the message packets come in. The `GetMessageHash` call only does the SHA256 finalization.\n",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-455800330,455800330,
gmaxwell,2019-01-19T18:07:10Z,"@sipa I was aware, but for many messages (e.g. small ones) the finalization is the hashing.",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-455802157,455802157,
TheBlueMatt,2019-01-19T21:37:59Z,"""The checksum check happens after deserialising all messages in the current read buffer."" <-- No, this has not been the case since #9045. We hash as we receive data, only the *finalization* (ie last compression round and second hash) happen after we've received the full message. Don't really have a strong feeling about this, it does move a tiny big of CPU cost over to the net thread from net_proce",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-455817419,455817419,
jonasschnelli,2019-01-20T06:11:16Z,"@TheBlueMatt: thanks for the clarification.\n\nThe intention of this PR is mainly to move the transportation protocol out of the message processing... and slowly moves towards a `CNetMessage` that is transport logic agnostic. With something like BIP150, we will have a different checksum (Poly1305 in the case of BIP151) and a different header. \n\nI think `CNetMessage` should at one point only ",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-455840885,455840885,
MarcoFalke,2019-01-31T15:43:35Z,Needs rebase (for sanity checking against the merged 36aeb43c01d250d99cfffdfbb70d2420b70054cc),https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-459392053,459392053,
jonasschnelli,2019-01-31T19:45:16Z,"Rebased (required for now merged #15246).\nAdapted test.",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-459479966,459479966,
Sjors,2019-02-01T10:20:55Z,`p2p_invalid_messages.py` test passes on macOS 10.14.3 for the newly rebased e7ab7d7. It [failed](https://travis-ci.org/bitcoin/bitcoin/jobs/487103354) on one of the Travis machines though.,https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-459675325,459675325,
jonasschnelli,2019-02-01T23:48:53Z,"> p2p_invalid_messages.py test passes on macOS 10.14.3 for the newly rebased e7ab7d7. It failed on one of the Travis machines though.\n\nIndeed. I think it is because of the immediate termination of the connection which somehow confuses `mininode`'s getdata. I'll investigate.",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-459907144,459907144,
gmaxwell,2019-02-03T04:56:28Z,"Should we also worry about this breaking networking for nodes behind idiot firewalls that corrupt certain strings?   We know they exist because they occasionally cause nodes to be unable to fetch certain blocks and other such sillyness.  Right now if the stupidity that triggers them is in an ephemeral message (like a ping, inv, or an addr message) it'll just get dropped, logged, and move on.",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-460023239,460023239,
NicolasDorier,2019-02-03T05:37:34Z,"I always wondered. Would the checksum could just be skipped at all?\n\nIf I understand what is being said here, the only reason for having the checksum is so people have a clearer message in logs if the message get corrupted by firewall?",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-460024940,460024940,
gmaxwell,2019-02-03T19:57:48Z,"@NicolasDorier  It could be but it would generally be a bad idea, because then nodes would operate with silent corruption in some cases. In particular, a common failure mode (relatively speaking) is for firewalls rewrite addresses and port numbers, corrupting version handshakes and addr messages.  It was more of a concern before we started relaxing banning behaviour, but even without that, no one ",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-460082894,460082894,
jonasschnelli,2020-05-07T07:15:53Z,Rebased,https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-625075555,625075555,
MarcoFalke,2020-05-07T12:15:16Z,I think there have been concerns that a bit flip on the wire will now cause the connection to be dropped instead of the msg that has the bit flip. How was this addressed?,https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-625218417,625218417,
jonasschnelli,2020-05-07T12:27:01Z,"> I think there have been concerns that a bit flip on the wire will now cause the connection to be dropped instead of the msg that has the bit flip. How was this addressed?\n\nNo. That's not addressed. I didn't see that concern. Was there a public discussion?",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-625224092,625224092,
MarcoFalke,2020-05-07T13:17:33Z,"Oh, that is how I read the previous discussion in this pull request. Maybe I am missing something obvious or read the code wrong.",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-625249724,625249724,
jonatack,2020-05-10T12:04:09Z,"> > I think there have been concerns that a bit flip on the wire will now cause the connection to be dropped instead of the msg that has the bit flip. How was this addressed?\n> \n> No. That's not addressed. I didn't see that concern. Was there a public discussion?\n\nI think @MarcoFalke is referring to https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-460023239 above (that is how I'm",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-626317681,626317681,
rajarshimaitra,2020-05-18T07:31:16Z,"The refactoring part seems like a good option. Though I do not have enough expertise to evaluate the proper context, I will look deeper into further review. \n\nCurrently Concept ACK apart from the [#15206(comment)](https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-460023239). There seems to remain a threat of an honest node being eclipsed from the network if an attacker manages to keep",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-629999077,629999077,
jonasschnelli,2020-05-18T11:52:20Z,"> There seems to remain a threat of an honest node being eclipsed from the network if an attacker manages to keep corrupting its incoming data.\n\nIf an attacker can corrupt incoming data, there are plenty of other ways to force a disconnect.\n\n> I am also curious on the motivation behind such aggressive connection dropping behavior.\n\nIt seems to be wasteful to allow other peers to send e",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-630130375,630130375,
MarcoFalke,2020-05-18T16:13:25Z,Might be interesting for reviewers: https://bitcoincore.reviews/15206.html,https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-630287423,630287423,
rajarshimaitra,2020-05-18T17:05:34Z,Concept ACK after this [comment](https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-630130375).,https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-630316285,630316285,
MarcoFalke,2020-05-18T17:12:44Z,"> The operators peer may need to calculate tons of sha256 hashes at almost no cost for the remote peer.\n\nI am pretty sure the same is true for payloads that have a valid checksum. E.g. an unknown message type. The message is hashed, but then dropped without any adverse effects on the peer that sent it. So I think this should not be used as an argument to justify the change in this pull request",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-630319942,630319942,
jonasschnelli,2020-05-18T17:38:48Z,"> I am pretty sure the same is true for payloads that have a valid checksum. E.g. an unknown message type.\n\nUnknown messages require the remote peer to calculate at least a valid sha256 hash.\n\nWhile random 4byes are enough to trigger a remote dbl-sha256 operation.\n\nArguing that there are other places where a remote peer can drain endless resources with almost no cost should bring littl",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-630334125,630334125,
MarcoFalke,2020-05-18T17:42:11Z,"> I though agree that it is debatable if we drop or tolerate connections sending messages with invalid checksums.\n\nI'd be interested to know if it is possible to implement BIP151 without the behaviour change here? If yes, what are the trade-offs?",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-630335753,630335753,
jonasschnelli,2020-05-18T17:57:18Z,"> I'd be interested to know if it is possible to implement BIP151 without the behaviour change here? If yes, what are the trade-offs?\n\nAbsolutely. There is no need to change this behaviour to implement BIP324. In the V2 proposal, we have a MAC (poly1305) instead of a sha256 checksum. There, I'd strongly suggest we drop the connection on an invalid MAC (which is implemented in #18242).",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-630343373,630343373,
MarcoFalke,2020-05-18T18:06:25Z,"Ok, so the motivation of this change is to bring the legacy behaviour in line with BIP324? If yes, it could make sense to mention that motivation in the pull request description.",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-630348082,630348082,
troygiorshev,2020-05-19T17:59:44Z,"ACK 1d9bc6a.  Reviewed the changes, built, and ran the tests.\n\nFull agreement on moving the checksum verification to the net layer.\n\nAgreeing with this [comment](https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-460082894) that we should keep verifying the checksum, for the same reasons.  Removing the checksum seems out of scope for this PR.\n\nI don't think we have consensus on",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-630984908,630984908,
troygiorshev,2020-05-20T17:45:18Z,For reference #15197 ,https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-631625484,631625484,
jnewbery,2020-05-21T15:01:56Z,"I agree with moving the checksum checking to the net layer. Disconnecting on checksum failure is *probably* ok, but I don't think the refactor and behaviour change need to be in the same PR (and certainly not in the same commit). How about changing this PR to just do the refactor and have a follow-up PR where discussion can be focused on whether to disconnect on checksum failure?\n\nI also agree",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-632135600,632135600,
MarcoFalke,2020-05-21T15:08:57Z,"Do you think it is possible to do the refactor without the behaviour change? I believe it is only possible to do the behaviour change without the refactor (see https://github.com/bitcoin/bitcoin/pull/15206#discussion_r428042604) but not the other way round.\n\nHappy to be proven wrong",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-632139425,632139425,
MarcoFalke,2020-05-21T15:20:02Z,"For reference, I had one checksum error on a google cloud test node for one connection. Haven't tested other networks or NAT. Full history for that connection: [history_peer_id_1849951.txt](https://github.com/bitcoin/bitcoin/files/4663193/history_peer_id_1849951.txt) (2.5 Mb). (The error happened in an inv message after about 15 minutes of being connected. Total connection time was less than a day",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-632145457,632145457,
jnewbery,2020-05-21T15:24:01Z,"> Do you think it is possible to do the refactor without the behaviour change?\n\nWhy wouldn't it be possible? The checksum can be checked in `ReceiveMessageBytes()` and the message dropped (with a log) if the checksum is wrong.",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-632147657,632147657,
fjahr,2020-05-21T21:01:11Z,"Concept ACK on the refactor. After reading the discussion here and in the PR review club I am still undecided if the disconnect is a good idea. We don't seem to have enough data to be confident that it will not be a problem for some users.\n\nWould using the banscore be a viable middle ground in this case? Yes, we would ban the peer but only after multiple offenses and we could tweak the number ",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-632343583,632343583,
jnewbery,2020-05-22T00:57:59Z,"> Banscore is generally not considered much these days it seems but I can't see why it would not be a possible solution in this case.\n\n@fjahr my view on banscore is that it's not particularly useful. If a peer sends us one bad message it's generally safe to assume that it'll probably send us more bad messages. Why wait until it's sent us 10 or 100 before disconnecting or banning? The ban score",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-632420501,632420501,
rajarshimaitra,2020-05-22T11:22:47Z,"Ran all the tests. All unit tests and functional tests passing. Verified the test fails on master. Still haven't been able to decide on connection dropping behavior. \n\n> Do you think it is possible to do the refactor without the behavior change? \n\nThis seems like a good idea as the good refactoring part of the change can get merged while we gather up more data to decide on connection dropp",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-632641477,632641477,
Emzy,2020-05-22T13:15:04Z,"Just for information. I see this errors at my node (about 400 connections).\n\n`\n2020-05-21T00:22:57Z CHECKSUM ERROR (SMBr, 0 bytes), expected 5df6e0e2 was 00000000\n2020-05-21T00:23:44Z CHECKSUM ERROR (, 0 bytes), expected 5df6e0e2 was 00000000\n2020-05-21T00:23:55Z CHECKSUM ERROR (, 1 bytes), expected f3035c79 was 01000000\n`\nAbout 15 on one day.\nLogging net is enabled.",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-632684741,632684741,
MarcoFalke,2020-05-22T13:32:26Z,Those are clearly malicious nodes and disconnection is the best we can do,https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-632692403,632692403,
jonasschnelli,2020-05-26T07:00:08Z,Rebased.,https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-633845888,633845888,
troygiorshev,2020-05-27T14:40:45Z,"In acknowledgement of @MarcoFalke's [challenge](https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-632139425) and @jnewbery's [suggestion](https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-632147657), this [branch](https://github.com/troygiorshev/bitcoin/tree/p2p-refactor-checksum) holds an example of moving the checksum verification to `GetMessage()` (called by `ReceiveMsgBytes()",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-634707439,634707439,
jnewbery,2020-05-27T15:07:37Z,"I like the approach in @troygiorshev's branch https://github.com/troygiorshev/bitcoin/tree/p2p-refactor-header, which moves the checks into net.cpp without changing behaviour. @jonasschnelli : can you take a look at that branch and see what you think? Does it interfere with your BIP324 work?",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-634726275,634726275,
jonasschnelli,2020-05-29T06:03:05Z,"I don't know how to proceed (if) with this PR.\nIt seems like that the immediate disconnect on a single checksum is to harsh (by some contributors judgment). I'm personally unsure wether it's too strict or desirable.\n\nSplitting the PR into a pure refactoring is possible. @troygiorshev  branch https://github.com/troygiorshev/bitcoin/tree/p2p-refactor-header looks not bad.\n\nIf we are not go",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-635778140,635778140,
DrahtBot,2020-06-04T20:37:22Z,<!--cf906140f33d8803c4a75a2196329ecb-->\n🐙 This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).,https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-639103077,639103077,
jnewbery,2020-09-29T10:39:31Z,"This is obsoleted by #19107 \n\n@jonasschnelli - if you think that there's anything in here that isn't addressed by 19107, feel free to reopen or open another PR.",https://github.com/bitcoin/bitcoin/pull/15206#issuecomment-700619288,700619288,
Sjors,2019-01-23T15:43:49Z,"Suggest adding "", disconnecting"" to this message, consistent with the other disconnection scenario in `CNode::ReceiveMsgBytes`.",https://github.com/bitcoin/bitcoin/pull/15206#discussion_r250249824,250249824,src/net.cpp
Sjors,2019-01-23T15:45:41Z,"I see that `CNode::ReceiveMsgBytes` returns `false` if `readData` doesn't return `0`, and that in turn `CConnman::SocketHandler()` calls `pnode->CloseSocketDisconnect()` if that returned `false`. This feels a bit brittle though, but maybe that's just because I'm not super familiar with this part of the codebase. ",https://github.com/bitcoin/bitcoin/pull/15206#discussion_r250250631,250250631,src/net.cpp
jonasschnelli,2019-01-24T19:26:56Z,"It's the same path of closing a connection then if a remote peer would send an oversize message (or an invalid header that can't be deserialized). I think it's acceptable,",https://github.com/bitcoin/bitcoin/pull/15206#discussion_r250745459,250745459,src/net.cpp
jonasschnelli,2019-01-24T19:34:34Z,Fixed,https://github.com/bitcoin/bitcoin/pull/15206#discussion_r250748337,250748337,src/net.cpp
jonatack,2020-05-10T12:38:33Z,"It may be good to add a comment here, along the lines of\n```diff\n     if (Complete()) {\n+        // Verify message has valid checksum. If invalid, reject and disconnect the peer.\n```\n",https://github.com/bitcoin/bitcoin/pull/15206#discussion_r422639997,422639997,src/net.cpp
ariard,2020-05-20T05:58:53Z,"If we go forward with disconnecting on an invalid checksum do you think it's worthy to add a release note for this ? We can't evaluate how many nodes may be affected by a tampering firewall, but at least if node operators experience unexpected disconnect they are aware of a possible reason. And we would know what to revert.",https://github.com/bitcoin/bitcoin/pull/15206#discussion_r427758757,427758757,src/net.cpp
MarcoFalke,2020-05-20T14:09:05Z,"We already disconnect on invalid netmagic (which might also be due to a bit-flip), so disconnecting here is probably fine. However, I think for cleaner code, the two seem related enough to be treated in the same way (either both in net_processing or both in net). No strong opinion where, but for example this is the diff if they are kept in net_processing:\n\n\n```diff\ndiff --git a/src/net.cpp",https://github.com/bitcoin/bitcoin/pull/15206#discussion_r428042604,428042604,src/net.h
troygiorshev,2020-05-20T15:11:18Z,"This should be changed to read something like:\n```suggestion\n    // store state about valid header and netmagic\n```",https://github.com/bitcoin/bitcoin/pull/15206#discussion_r428091965,428091965,src/net.cpp
glowang,2020-05-20T16:27:20Z,"Out of curiousity, I l did some googling on payload tampering firewall & checksum, but I couldn't find anything that seems relevant. Could you please point me to some resource to read more about it? Sounds very interesting :) ",https://github.com/bitcoin/bitcoin/pull/15206#discussion_r428146010,428146010,src/net.cpp
narula,2020-05-20T16:54:08Z,Is there a particular reason to check `Complete()` and do this here instead of in the complete check in `ReceiveMsgBytes()`?,https://github.com/bitcoin/bitcoin/pull/15206#discussion_r428164724,428164724,src/net.cpp
ariard,2020-05-20T17:11:00Z,"With regards to firewall, rewriting some outgoing messages could be a NAT implementation, you can read more about this topic here : https://tools.ietf.org/html/rfc3022",https://github.com/bitcoin/bitcoin/pull/15206#discussion_r428174976,428174976,src/net.cpp
jkczyz,2020-05-20T18:35:15Z,Agree that message validity checks should all happen in one place. I have a preference to have them in net so that net_processing only sees valid messages.,https://github.com/bitcoin/bitcoin/pull/15206#discussion_r428225994,428225994,src/net.h
jkczyz,2020-05-20T19:06:31Z,"In the future, I'd like to see `TransportDeserializer` have a stateless interface such that it only produces valid messages or otherwise returns an appropriate error; see https://github.com/bitcoin/bitcoin/pull/16202#issuecomment-535152710. Not sure if @jonasschnelli agrees with me.\n\nIn that world, all validity checks would remain within the deserializer. Then `CNetMessage` would only need to ",https://github.com/bitcoin/bitcoin/pull/15206#discussion_r428245456,428245456,src/net.cpp
glowang,2020-05-20T20:17:00Z,Thanks a lot!! 🙏 ,https://github.com/bitcoin/bitcoin/pull/15206#discussion_r428282630,428282630,src/net.cpp
jnewbery,2020-05-22T01:36:01Z,"@jkczyz I don't think that it's possible to have a stateless interface for `TransportDeserializer`. When we call into `Read(pch, nBytes)` the bytes that we've read from the socket and are passing in may not constitute the full message. That's why `TransportDeserializer` is stateful and keeps track of partially received headers/messages in `hdrbuf`/`vRecv`.\n\nI agree with @narula that the error-",https://github.com/bitcoin/bitcoin/pull/15206#discussion_r428999213,428999213,src/net.cpp
jkczyz,2020-05-29T17:32:10Z,"> @jkczyz I don't think that it's possible to have a stateless interface for `TransportDeserializer`. When we call into `Read(pch, nBytes)` the bytes that we've read from the socket and are passing in may not constitute the full message. That's why `TransportDeserializer` is stateful and keeps track of partially received headers/messages in `hdrbuf`/`vRecv`.\n> \n\nIIRC, my linked comment was a",https://github.com/bitcoin/bitcoin/pull/15206#discussion_r432635102,432635102,src/net.cpp
