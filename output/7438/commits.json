[
  {
    "sha": "46dbcd4833115401fecbb052365b4c7725874414",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0NmRiY2Q0ODMzMTE1NDAxZmVjYmIwNTIzNjViNGM3NzI1ODc0NDE0",
    "commit": {
      "author": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2016-01-28T22:44:14Z"
      },
      "committer": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2016-01-28T22:45:22Z"
      },
      "message": "Do not absolutely protect local peers from eviction.\n\nWith automatic tor HS support in place we should probably not be providing\n absolute protection for local peers, since HS inbound could be used to\n attack pretty easily.  Instead, this counts on the latency metric inside\n AttemptToEvictConnection to privilege actually local peers.",
      "tree": {
        "sha": "8a715524ea32c25ff055ad2d79bac29fb65ed435",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8a715524ea32c25ff055ad2d79bac29fb65ed435"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/46dbcd4833115401fecbb052365b4c7725874414",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/46dbcd4833115401fecbb052365b4c7725874414",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/46dbcd4833115401fecbb052365b4c7725874414",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/46dbcd4833115401fecbb052365b4c7725874414/comments",
    "author": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "cb83beb3759b9bd19cc13b1e3dd589349787ac3e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/cb83beb3759b9bd19cc13b1e3dd589349787ac3e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/cb83beb3759b9bd19cc13b1e3dd589349787ac3e"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 0,
      "deletions": 2
    },
    "files": [
      {
        "sha": "b022255bdf4608812ac28d4ffced2d2a1b1050e3",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 0,
        "deletions": 2,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/46dbcd4833115401fecbb052365b4c7725874414/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/46dbcd4833115401fecbb052365b4c7725874414/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=46dbcd4833115401fecbb052365b4c7725874414",
        "patch": "@@ -884,8 +884,6 @@ static bool AttemptToEvictConnection(bool fPreferNewConnection) {\n                 continue;\n             if (node->fDisconnect)\n                 continue;\n-            if (node->addr.IsLocal())\n-                continue;\n             vEvictionCandidates.push_back(CNodeRef(node));\n         }\n     }"
      }
    ]
  },
  {
    "sha": "8e09f914f8ec66301257358b250e9a61befadd95",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4ZTA5ZjkxNGY4ZWM2NjMwMTI1NzM1OGIyNTBlOWE2MWJlZmFkZDk1",
    "commit": {
      "author": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2015-11-23T03:48:54Z"
      },
      "committer": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2016-01-28T22:46:06Z"
      },
      "message": "Decide eviction group ties based on time.\n\nThis corrects a bug the case of tying group size where the code may\n fail to select the group with the newest member. Since newest time\n is the final selection criteria, failing to break ties on it\n on the step before can undermine the final selection.\n\nTied netgroups are very common.",
      "tree": {
        "sha": "408aa47baf58f66c3adaf6a41d5633ac42aed482",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/408aa47baf58f66c3adaf6a41d5633ac42aed482"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8e09f914f8ec66301257358b250e9a61befadd95",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8e09f914f8ec66301257358b250e9a61befadd95",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/8e09f914f8ec66301257358b250e9a61befadd95",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8e09f914f8ec66301257358b250e9a61befadd95/comments",
    "author": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "46dbcd4833115401fecbb052365b4c7725874414",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/46dbcd4833115401fecbb052365b4c7725874414",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/46dbcd4833115401fecbb052365b4c7725874414"
      }
    ],
    "stats": {
      "total": 16,
      "additions": 10,
      "deletions": 6
    },
    "files": [
      {
        "sha": "2f60cfa1ca11b6d1b23f29e3966b9a8173a84e47",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 6,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8e09f914f8ec66301257358b250e9a61befadd95/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8e09f914f8ec66301257358b250e9a61befadd95/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=8e09f914f8ec66301257358b250e9a61befadd95",
        "patch": "@@ -914,30 +914,34 @@ static bool AttemptToEvictConnection(bool fPreferNewConnection) {\n \n     if (vEvictionCandidates.empty()) return false;\n \n-    // Identify the network group with the most connections\n+    // Identify the network group with the most connections and youngest member.\n+    // (vEvictionCandidates is already sorted by reverse connect time)\n     std::vector<unsigned char> naMostConnections;\n     unsigned int nMostConnections = 0;\n+    int64_t nMostConnectionsTime = 0;\n     std::map<std::vector<unsigned char>, std::vector<CNodeRef> > mapAddrCounts;\n     BOOST_FOREACH(const CNodeRef &node, vEvictionCandidates) {\n         mapAddrCounts[node->addr.GetGroup()].push_back(node);\n+        int64_t grouptime = mapAddrCounts[node->addr.GetGroup()][0]->nTimeConnected;\n+        size_t groupsize = mapAddrCounts[node->addr.GetGroup()].size();\n \n-        if (mapAddrCounts[node->addr.GetGroup()].size() > nMostConnections) {\n-            nMostConnections = mapAddrCounts[node->addr.GetGroup()].size();\n+        if (groupsize > nMostConnections || (groupsize == nMostConnections && grouptime > nMostConnectionsTime)) {\n+            nMostConnections = groupsize;\n+            nMostConnectionsTime = grouptime;\n             naMostConnections = node->addr.GetGroup();\n         }\n     }\n \n     // Reduce to the network group with the most connections\n     vEvictionCandidates = mapAddrCounts[naMostConnections];\n \n-    // Do not disconnect peers if there is only 1 connection from their network group\n+    // Do not disconnect peers if there is only one unprotected connection from their network group.\n     if (vEvictionCandidates.size() <= 1)\n         // unless we prefer the new connection (for whitelisted peers)\n         if (!fPreferNewConnection)\n             return false;\n \n-    // Disconnect the most recent connection from the network group with the most connections\n-    std::sort(vEvictionCandidates.begin(), vEvictionCandidates.end(), ReverseCompareNodeTimeConnected);\n+    // Disconnect from the network group with the most connections\n     vEvictionCandidates[0]->fDisconnect = true;\n \n     return true;"
      }
    ]
  }
]