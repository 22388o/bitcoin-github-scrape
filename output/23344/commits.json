[
  {
    "sha": "17d51e63c2afb389d56866748b4b0f8c594a5b45",
    "node_id": "C_kwDOABII59oAKDE3ZDUxZTYzYzJhZmIzODlkNTY4NjY3NDhiNGIwZjhjNTk0YTViNDU",
    "commit": {
      "author": {
        "name": "Douglas Chimento",
        "email": "dchimento@gmail.com",
        "date": "2021-10-24T09:46:29Z"
      },
      "committer": {
        "name": "Douglas Chimento",
        "email": "dchimento@gmail.com",
        "date": "2021-10-24T09:46:29Z"
      },
      "message": "ci: Reuse pre-built docker builder image for rapid local CI iteration testing\n\nReuse the pre-built image, if available, to bypass most of the ci/test/04_install.sh script",
      "tree": {
        "sha": "1aa39009b54c3a9f086185356954443cacea5411",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1aa39009b54c3a9f086185356954443cacea5411"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/17d51e63c2afb389d56866748b4b0f8c594a5b45",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCAAdFiEEFt7wA8cqIHRePmNa0a1maOubxakFAmF1LEQACgkQ0a1maOub\nxalQEQv6Auo5cbbkbdg5fwGvYi0ixA75qJQXipGbW127nN+bsVT6S590tR/uAxC5\nrnkS7dCNGtpexj0LeSugp7htkge2SR0xwKvIHqCHlLNGbvdEpuJjfIzkPXkjw7ZR\nxlDXudUDa1ZyqcLjYG23ebOBZTOQh+aU5nNqnVQg/O48QH4Hfei6HVNOk2LDIUk7\n2dXrv5NZo4Gc9KOcriBKnDzvqg3sVnNWLh5lhCkzGBdwEEFx58rso2ZTQwlfQko7\nWPJMEOfeywlspEGkXhDVE5WkMtLjIrNYrzI791E7pgCFMhuIjYFSW7rYwvFE6p0L\nGf+W+/AcgXFH71uiq486rBFw7FcTlFkYha1QUzCnsdo2sLdaa4uF052uvs2RKQDw\nB0ta6n5O+M24A4EV/4LT9tukC3rhM10TEzxiBSSz6fmVw3Zw5rUEjW8ue+OQVxmG\nf/TM70SvVOZ2blOO7jQOqUhUPAFW/RfB0aJDN1EGSiv2E0O4bvpc+JXOKkD4edDp\nn/BmnA/Q\n=9JYA\n-----END PGP SIGNATURE-----",
        "payload": "tree 1aa39009b54c3a9f086185356954443cacea5411\nparent 04437ee721e66a7b76bef5ec2f88dd1efcd03b84\nauthor Douglas Chimento <dchimento@gmail.com> 1635068789 +0300\ncommitter Douglas Chimento <dchimento@gmail.com> 1635068789 +0300\n\nci: Reuse pre-built docker builder image for rapid local CI iteration testing\n\nReuse the pre-built image, if available, to bypass most of the ci/test/04_install.sh script\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/17d51e63c2afb389d56866748b4b0f8c594a5b45",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/17d51e63c2afb389d56866748b4b0f8c594a5b45",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/17d51e63c2afb389d56866748b4b0f8c594a5b45/comments",
    "author": {
      "login": "dougEfresh",
      "id": 976425,
      "node_id": "MDQ6VXNlcjk3NjQyNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/976425?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dougEfresh",
      "html_url": "https://github.com/dougEfresh",
      "followers_url": "https://api.github.com/users/dougEfresh/followers",
      "following_url": "https://api.github.com/users/dougEfresh/following{/other_user}",
      "gists_url": "https://api.github.com/users/dougEfresh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dougEfresh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dougEfresh/subscriptions",
      "organizations_url": "https://api.github.com/users/dougEfresh/orgs",
      "repos_url": "https://api.github.com/users/dougEfresh/repos",
      "events_url": "https://api.github.com/users/dougEfresh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dougEfresh/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dougEfresh",
      "id": 976425,
      "node_id": "MDQ6VXNlcjk3NjQyNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/976425?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dougEfresh",
      "html_url": "https://github.com/dougEfresh",
      "followers_url": "https://api.github.com/users/dougEfresh/followers",
      "following_url": "https://api.github.com/users/dougEfresh/following{/other_user}",
      "gists_url": "https://api.github.com/users/dougEfresh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dougEfresh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dougEfresh/subscriptions",
      "organizations_url": "https://api.github.com/users/dougEfresh/orgs",
      "repos_url": "https://api.github.com/users/dougEfresh/repos",
      "events_url": "https://api.github.com/users/dougEfresh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dougEfresh/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "04437ee721e66a7b76bef5ec2f88dd1efcd03b84",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/04437ee721e66a7b76bef5ec2f88dd1efcd03b84",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/04437ee721e66a7b76bef5ec2f88dd1efcd03b84"
      }
    ],
    "stats": {
      "total": 18,
      "additions": 13,
      "deletions": 5
    },
    "files": [
      {
        "sha": "30377172961fa48b768a2e6822e65fd8d97ff8ec",
        "filename": "ci/test/04_install.sh",
        "status": "modified",
        "additions": 13,
        "deletions": 5,
        "changes": 18,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/17d51e63c2afb389d56866748b4b0f8c594a5b45/ci/test/04_install.sh",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/17d51e63c2afb389d56866748b4b0f8c594a5b45/ci/test/04_install.sh",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/ci/test/04_install.sh?ref=17d51e63c2afb389d56866748b4b0f8c594a5b45",
        "patch": "@@ -30,6 +30,11 @@ fi\n \n export P_CI_DIR=\"$PWD\"\n \n+DOCKER_EXEC () {\n+  $DOCKER_CI_CMD_PREFIX bash -c \"export PATH=$BASE_SCRATCH_DIR/bins/:\\$PATH && cd $P_CI_DIR && $*\"\n+}\n+export -f DOCKER_EXEC\n+\n if [ -z \"$DANGER_RUN_CI_ON_HOST\" ]; then\n   echo \"Creating $DOCKER_NAME_TAG container to run in\"\n   ${CI_RETRY_EXE} docker pull \"$DOCKER_NAME_TAG\"\n@@ -39,6 +44,14 @@ if [ -z \"$DANGER_RUN_CI_ON_HOST\" ]; then\n     systemctl restart docker\n   fi\n \n+  # detect if  $CONTAINER_NAME is already running, return if so\n+  DOCKER_ID=$(docker ps -q  --filter name=${CONTAINER_NAME})\n+  if [ -n \"$DOCKER_ID\" ]; then\n+    echo \"Using pre-built docker image $DOCKER_ID ($CONTAINER_NAME). Skipping install\"\n+    export DOCKER_CI_CMD_PREFIX=\"docker exec $DOCKER_ID\"\n+    return\n+  fi\n+\n   DOCKER_ID=$(docker run $DOCKER_ADMIN --rm --interactive --detach --tty \\\n                   --mount type=bind,src=$BASE_ROOT_DIR,dst=/ro_base,readonly \\\n                   --mount type=bind,src=$CCACHE_DIR,dst=$CCACHE_DIR \\\n@@ -53,11 +66,6 @@ else\n   echo \"Running on host system without docker wrapper\"\n fi\n \n-DOCKER_EXEC () {\n-  $DOCKER_CI_CMD_PREFIX bash -c \"export PATH=$BASE_SCRATCH_DIR/bins/:\\$PATH && cd $P_CI_DIR && $*\"\n-}\n-export -f DOCKER_EXEC\n-\n if [ -n \"$DPKG_ADD_ARCH\" ]; then\n   DOCKER_EXEC dpkg --add-architecture \"$DPKG_ADD_ARCH\"\n fi"
      }
    ]
  }
]