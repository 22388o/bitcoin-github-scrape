[
  {
    "sha": "417b6c1d2990ffc78c029442e027797d724a101f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0MTdiNmMxZDI5OTBmZmM3OGMwMjk0NDJlMDI3Nzk3ZDcyNGExMDFm",
    "commit": {
      "author": {
        "name": "Thomas Kerin",
        "email": "thomas.kerin@bitmaintech.com",
        "date": "2018-07-13T11:47:07Z"
      },
      "committer": {
        "name": "Thomas Kerin",
        "email": "thomas.kerin@bitmaintech.com",
        "date": "2018-07-13T21:13:10Z"
      },
      "message": "bitcoinconsensus: invalid flags should be set to bitcoinconsensus_error type, add test cases covering bitcoinconsensus error codes",
      "tree": {
        "sha": "b732d11cf1d45d1a0e9efdcd5df78c6568341ec0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b732d11cf1d45d1a0e9efdcd5df78c6568341ec0"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/417b6c1d2990ffc78c029442e027797d724a101f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/417b6c1d2990ffc78c029442e027797d724a101f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/417b6c1d2990ffc78c029442e027797d724a101f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/417b6c1d2990ffc78c029442e027797d724a101f/comments",
    "author": {
      "login": "afk11",
      "id": 5617245,
      "node_id": "MDQ6VXNlcjU2MTcyNDU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5617245?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/afk11",
      "html_url": "https://github.com/afk11",
      "followers_url": "https://api.github.com/users/afk11/followers",
      "following_url": "https://api.github.com/users/afk11/following{/other_user}",
      "gists_url": "https://api.github.com/users/afk11/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/afk11/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/afk11/subscriptions",
      "organizations_url": "https://api.github.com/users/afk11/orgs",
      "repos_url": "https://api.github.com/users/afk11/repos",
      "events_url": "https://api.github.com/users/afk11/events{/privacy}",
      "received_events_url": "https://api.github.com/users/afk11/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "afk11",
      "id": 5617245,
      "node_id": "MDQ6VXNlcjU2MTcyNDU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5617245?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/afk11",
      "html_url": "https://github.com/afk11",
      "followers_url": "https://api.github.com/users/afk11/followers",
      "following_url": "https://api.github.com/users/afk11/following{/other_user}",
      "gists_url": "https://api.github.com/users/afk11/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/afk11/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/afk11/subscriptions",
      "organizations_url": "https://api.github.com/users/afk11/orgs",
      "repos_url": "https://api.github.com/users/afk11/repos",
      "events_url": "https://api.github.com/users/afk11/events{/privacy}",
      "received_events_url": "https://api.github.com/users/afk11/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "2ea7eb62b21affeb56fcea7433cfff9e5bc4742c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2ea7eb62b21affeb56fcea7433cfff9e5bc4742c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/2ea7eb62b21affeb56fcea7433cfff9e5bc4742c"
      }
    ],
    "stats": {
      "total": 144,
      "additions": 143,
      "deletions": 1
    },
    "files": [
      {
        "sha": "e2370c5e50c68278e80ef0ba91d196e19e88755b",
        "filename": "src/script/bitcoinconsensus.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/417b6c1d2990ffc78c029442e027797d724a101f/src/script/bitcoinconsensus.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/417b6c1d2990ffc78c029442e027797d724a101f/src/script/bitcoinconsensus.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/bitcoinconsensus.cpp?ref=417b6c1d2990ffc78c029442e027797d724a101f",
        "patch": "@@ -81,7 +81,7 @@ static int verify_script(const unsigned char *scriptPubKey, unsigned int scriptP\n                                     unsigned int nIn, unsigned int flags, bitcoinconsensus_error* err)\n {\n     if (!verify_flags(flags)) {\n-        return bitcoinconsensus_ERR_INVALID_FLAGS;\n+        return set_error(err, bitcoinconsensus_ERR_INVALID_FLAGS);\n     }\n     try {\n         TxInputStream stream(SER_NETWORK, PROTOCOL_VERSION, txTo, txToLen);"
      },
      {
        "sha": "543b21e8a603106ab8fb397bae0bb3a453de092e",
        "filename": "src/test/script_tests.cpp",
        "status": "modified",
        "additions": 142,
        "deletions": 0,
        "changes": 142,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/417b6c1d2990ffc78c029442e027797d724a101f/src/test/script_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/417b6c1d2990ffc78c029442e027797d724a101f/src/test/script_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/script_tests.cpp?ref=417b6c1d2990ffc78c029442e027797d724a101f",
        "patch": "@@ -1495,4 +1495,146 @@ BOOST_AUTO_TEST_CASE(script_can_append_self)\n     BOOST_CHECK(s == d);\n }\n \n+\n+#if defined(HAVE_CONSENSUS_LIB)\n+\n+/* Test simple (successful) usage of bitcoinconsensus_verify_script */\n+BOOST_AUTO_TEST_CASE(bitcoinconsensus_verify_script_returns_true)\n+{\n+    unsigned int libconsensus_flags = 0;\n+    int nIn = 0;\n+\n+    CScript scriptPubKey;\n+    CScript scriptSig;\n+    CScriptWitness wit;\n+\n+    scriptPubKey << OP_1;\n+    CTransaction creditTx = BuildCreditingTransaction(scriptPubKey, 1);\n+    CTransaction spendTx = BuildSpendingTransaction(scriptSig, wit, creditTx);\n+\n+    CDataStream stream(SER_NETWORK, PROTOCOL_VERSION);\n+    stream << spendTx;\n+\n+    bitcoinconsensus_error err;\n+    int result = bitcoinconsensus_verify_script(scriptPubKey.data(), scriptPubKey.size(), (const unsigned char*)&stream[0], stream.size(), nIn, libconsensus_flags, &err);\n+    BOOST_CHECK_EQUAL(result, 1);\n+    BOOST_CHECK_EQUAL(err, bitcoinconsensus_ERR_OK);\n+}\n+\n+/* Test bitcoinconsensus_verify_script returns invalid tx index err*/\n+BOOST_AUTO_TEST_CASE(bitcoinconsensus_verify_script_tx_index_err)\n+{\n+    unsigned int libconsensus_flags = 0;\n+    int nIn = 3;\n+\n+    CScript scriptPubKey;\n+    CScript scriptSig;\n+    CScriptWitness wit;\n+\n+    scriptPubKey << OP_EQUAL;\n+    CTransaction creditTx = BuildCreditingTransaction(scriptPubKey, 1);\n+    CTransaction spendTx = BuildSpendingTransaction(scriptSig, wit, creditTx);\n+\n+    CDataStream stream(SER_NETWORK, PROTOCOL_VERSION);\n+    stream << spendTx;\n+\n+    bitcoinconsensus_error err;\n+    int result = bitcoinconsensus_verify_script(scriptPubKey.data(), scriptPubKey.size(), (const unsigned char*)&stream[0], stream.size(), nIn, libconsensus_flags, &err);\n+    BOOST_CHECK_EQUAL(result, 0);\n+    BOOST_CHECK_EQUAL(err, bitcoinconsensus_ERR_TX_INDEX);\n+}\n+\n+/* Test bitcoinconsensus_verify_script returns tx size mismatch err*/\n+BOOST_AUTO_TEST_CASE(bitcoinconsensus_verify_script_tx_size)\n+{\n+    unsigned int libconsensus_flags = 0;\n+    int nIn = 0;\n+\n+    CScript scriptPubKey;\n+    CScript scriptSig;\n+    CScriptWitness wit;\n+\n+    scriptPubKey << OP_EQUAL;\n+    CTransaction creditTx = BuildCreditingTransaction(scriptPubKey, 1);\n+    CTransaction spendTx = BuildSpendingTransaction(scriptSig, wit, creditTx);\n+\n+    CDataStream stream(SER_NETWORK, PROTOCOL_VERSION);\n+    stream << spendTx;\n+\n+    bitcoinconsensus_error err;\n+    int result = bitcoinconsensus_verify_script(scriptPubKey.data(), scriptPubKey.size(), (const unsigned char*)&stream[0], stream.size() * 2, nIn, libconsensus_flags, &err);\n+    BOOST_CHECK_EQUAL(result, 0);\n+    BOOST_CHECK_EQUAL(err, bitcoinconsensus_ERR_TX_SIZE_MISMATCH);\n+}\n+\n+/* Test bitcoinconsensus_verify_script returns invalid tx serialization error */\n+BOOST_AUTO_TEST_CASE(bitcoinconsensus_verify_script_tx_serialization)\n+{\n+    unsigned int libconsensus_flags = 0;\n+    int nIn = 0;\n+\n+    CScript scriptPubKey;\n+    CScript scriptSig;\n+    CScriptWitness wit;\n+\n+    scriptPubKey << OP_EQUAL;\n+    CTransaction creditTx = BuildCreditingTransaction(scriptPubKey, 1);\n+    CTransaction spendTx = BuildSpendingTransaction(scriptSig, wit, creditTx);\n+\n+    CDataStream stream(SER_NETWORK, PROTOCOL_VERSION);\n+    stream << 0xffffffff;\n+\n+    bitcoinconsensus_error err;\n+    int result = bitcoinconsensus_verify_script(scriptPubKey.data(), scriptPubKey.size(), (const unsigned char*)&stream[0], stream.size(), nIn, libconsensus_flags, &err);\n+    BOOST_CHECK_EQUAL(result, 0);\n+    BOOST_CHECK_EQUAL(err, bitcoinconsensus_ERR_TX_DESERIALIZE);\n+}\n+\n+/* Test bitcoinconsensus_verify_script returns amount required error */\n+BOOST_AUTO_TEST_CASE(bitcoinconsensus_verify_script_amount_required_err)\n+{\n+    unsigned int libconsensus_flags = bitcoinconsensus_SCRIPT_FLAGS_VERIFY_WITNESS;\n+    int nIn = 0;\n+\n+    CScript scriptPubKey;\n+    CScript scriptSig;\n+    CScriptWitness wit;\n+\n+    scriptPubKey << OP_EQUAL;\n+    CTransaction creditTx = BuildCreditingTransaction(scriptPubKey, 1);\n+    CTransaction spendTx = BuildSpendingTransaction(scriptSig, wit, creditTx);\n+\n+    CDataStream stream(SER_NETWORK, PROTOCOL_VERSION);\n+    stream << spendTx;\n+\n+    bitcoinconsensus_error err;\n+    int result = bitcoinconsensus_verify_script(scriptPubKey.data(), scriptPubKey.size(), (const unsigned char*)&stream[0], stream.size(), nIn, libconsensus_flags, &err);\n+    BOOST_CHECK_EQUAL(result, 0);\n+    BOOST_CHECK_EQUAL(err, bitcoinconsensus_ERR_AMOUNT_REQUIRED);\n+}\n+\n+/* Test bitcoinconsensus_verify_script returns invalid flags err */\n+BOOST_AUTO_TEST_CASE(bitcoinconsensus_verify_script_invalid_flags)\n+{\n+    unsigned int libconsensus_flags = 1 << 3;\n+    int nIn = 0;\n+\n+    CScript scriptPubKey;\n+    CScript scriptSig;\n+    CScriptWitness wit;\n+\n+    scriptPubKey << OP_EQUAL;\n+    CTransaction creditTx = BuildCreditingTransaction(scriptPubKey, 1);\n+    CTransaction spendTx = BuildSpendingTransaction(scriptSig, wit, creditTx);\n+\n+    CDataStream stream(SER_NETWORK, PROTOCOL_VERSION);\n+    stream << spendTx;\n+\n+    bitcoinconsensus_error err;\n+    int result = bitcoinconsensus_verify_script(scriptPubKey.data(), scriptPubKey.size(), (const unsigned char*)&stream[0], stream.size(), nIn, libconsensus_flags, &err);\n+    BOOST_CHECK_EQUAL(result, 0);\n+    BOOST_CHECK_EQUAL(err, bitcoinconsensus_ERR_INVALID_FLAGS);\n+}\n+\n+#endif\n BOOST_AUTO_TEST_SUITE_END()"
      }
    ]
  }
]