qshuai,2018-04-24T06:34:02Z,"As mentioned above(testnet will exec twice), the referenced code is [here](https://github.com/bitcoin/bitcoin/blob/master/src/miner.cpp#L168-L169).\n```\nUpdateTime(pblock, chainparams.GetConsensus(), pindexPrev); \npblock->nBits          = GetNextWorkRequired(pindexPrev, pblock, chainparams.GetConsensus());\n```",https://github.com/bitcoin/bitcoin/pull/13042#issuecomment-383819324,383819324,
jonasschnelli,2018-04-26T08:18:15Z,"utACK f404765c8ba6ca16f0c7d9e274fd64cf28675a6b.\n`pblock->nBits = GetNextWorkRequired()` is indeed called twice in that case.",https://github.com/bitcoin/bitcoin/pull/13042#issuecomment-384554485,384554485,
MarcoFalke,2018-05-18T14:54:00Z,What is the status of this? I think the feedback wasn't addressed and I suggest closing,https://github.com/bitcoin/bitcoin/pull/13042#issuecomment-390232911,390232911,
MarcoFalke,2018-04-26T11:55:57Z,"You never update nBits here, whereas it should.",https://github.com/bitcoin/bitcoin/pull/13042#discussion_r184362005,184362005,src/rpc/mining.cpp
qshuai,2018-04-26T16:02:28Z,"@MarcoFalke nBits updating depends on whether CreateNewBlock() is called. That is to say, nBits will be updated when CreateNewBlock() is called. It indicates the miner is mining the same height block at the current time at least if CreateNewBlock() is not called. So the nBits needs not to be update, just use cached blocktemplate. \nThe following is the condition of calling CreateNewBlock():\n```",https://github.com/bitcoin/bitcoin/pull/13042#discussion_r184444271,184444271,src/rpc/mining.cpp
MarcoFalke,2018-04-26T16:14:44Z,"Then, why would you need to call `UpdateTime` at all?",https://github.com/bitcoin/bitcoin/pull/13042#discussion_r184448205,184448205,src/rpc/mining.cpp
qshuai,2018-04-26T16:43:24Z,UpdateTime is responsible for updating nTime field.,https://github.com/bitcoin/bitcoin/pull/13042#discussion_r184457184,184457184,src/rpc/mining.cpp
MarcoFalke,2018-04-26T21:00:30Z,"But it is already called in `CreateNewBlock` just before `GetNextWorkRequired`. So if you can skip the `GetNextWorkRequired` in `UpdateTime` (with the reason that it was called twice through CNB), you can also skip `UpdateTime`, no?",https://github.com/bitcoin/bitcoin/pull/13042#discussion_r184529428,184529428,src/rpc/mining.cpp
qshuai,2018-04-27T00:17:24Z,"Firstly, `UpdateTime` must be called regardless of `CreateNewBlock`:\n[https://github.com/bitcoin/bitcoin/blob/master/src/rpc/mining.cpp#L506-L532](https://github.com/bitcoin/bitcoin/blob/master/src/rpc/mining.cpp#L506-L532)\n\nSecondly,  `GetNextWorkRequired` and `TestBlockValidity` use the nTime field. So it may be necessary to update nTime field in advance. ",https://github.com/bitcoin/bitcoin/pull/13042#discussion_r184564880,184564880,src/rpc/mining.cpp
sdaftuar,2018-04-27T12:30:26Z,"If you don't update nBits here, then this patch would change behavior for `getblocktemplate` users on testnet, right?  Previously the calculated difficulty could go down if enough time passes (even using a cached block), whereas after this patch that could no longer happen.",https://github.com/bitcoin/bitcoin/pull/13042#discussion_r184673002,184673002,src/rpc/mining.cpp
qshuai,2018-04-27T14:28:30Z,"@sdaftuar Yeah, that is true. I did not consider it before now. So it works although it is  a bad code smell.",https://github.com/bitcoin/bitcoin/pull/13042#discussion_r184704430,184704430,src/rpc/mining.cpp
