sipa,2017-08-17T23:39:51Z,"Yes, what about it?",https://github.com/bitcoin/bitcoin/pull/11062#issuecomment-323222446,323222446,
sipa,2017-08-18T05:39:30Z,utACK,https://github.com/bitcoin/bitcoin/pull/11062#issuecomment-323264361,323264361,
TheBlueMatt,2017-08-20T21:05:03Z,utACK 8c8ef83edc8724f2dc7e363e9c412c5df564e08f,https://github.com/bitcoin/bitcoin/pull/11062#issuecomment-323611929,323611929,
MarcoFalke,2017-09-01T12:30:14Z,utACK 8c8ef83,https://github.com/bitcoin/bitcoin/pull/11062#issuecomment-326567948,326567948,
kallewoof,2017-09-04T05:48:51Z,"@jnewbery Thanks for the review! You're right, I think I was overthinking things when I tried to split commits. I've squashed into one commit and addressed your nits.",https://github.com/bitcoin/bitcoin/pull/11062#issuecomment-326871466,326871466,
jnewbery,2017-09-04T12:01:16Z,`already_there` seems fine to me. Will retest later.,https://github.com/bitcoin/bitcoin/pull/11062#issuecomment-326945512,326945512,
kallewoof,2017-09-05T01:16:27Z,Didn't realize test failed. Restarting as it's obviously unrelated.,https://github.com/bitcoin/bitcoin/pull/11062#issuecomment-327046949,327046949,
jnewbery,2017-09-06T00:15:40Z,Tested ACK 258d33b41a27917f59e3aee856d032a23cbb5b05,https://github.com/bitcoin/bitcoin/pull/11062#issuecomment-327338078,327338078,
MarcoFalke,2017-09-06T00:27:56Z,re-utACK 258d33b,https://github.com/bitcoin/bitcoin/pull/11062#issuecomment-327339794,327339794,
promag,2017-09-06T00:31:22Z,utACK 258d33b.,https://github.com/bitcoin/bitcoin/pull/11062#issuecomment-327340317,327340317,
promag,2017-08-17T14:49:05Z,"Check `state.GetRejectCode() == REJECT_DUPLICATE`? See [this](https://github.com/bitcoin/bitcoin/blame/master/src/validation.cpp#L476).\n\nAlso, IMO this is prettier:\n```cpp\nif (state.IsValid()) {\n    ...\n} else if (state.GetRejectCode() == REJECT_DUPLICATE) {\n    ...\n} else {\n    ...\n}\n```\n",https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133735165,133735165,src/validation.cpp
promag,2017-08-17T14:56:06Z,"There is more than one reason for`REJECT_DUPLICATE`, don't know if that matters here. @sipa?",https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133737344,133737344,src/validation.cpp
promag,2017-08-17T14:57:14Z,Maybe just increment `skipped`?,https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133737706,133737706,src/validation.cpp
sipa,2017-08-17T23:28:30Z,"REJECT_DUPLICATE is used to indicate double spends, so that wouldn't be correct.",https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133852836,133852836,src/validation.cpp
promag,2017-08-17T23:35:22Z,What about #10503?,https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133853668,133853668,src/validation.cpp
promag,2017-08-17T23:50:34Z,"But REJECT_DUPLICATE is set if it's in the mempool which happens to be what's tested here. So it should be?\n```cpp\n} else if (state.GetRejectCode() == REJECT_DUPLICATE && state.GetRejectReason() == ""txn-already-in-mempool"") {\n```",https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133855454,133855454,src/validation.cpp
sipa,2017-08-17T23:56:41Z,That's pretty ugly. There's no good way to distinuish replay from double spend... for almost everything the distinction doesn't matter.,https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133856124,133856124,src/validation.cpp
promag,2017-08-18T00:24:12Z,Got it. So in this case `if (mempool.exists(tx->GetHash())` can come before `AcceptToMemoryPoolWithTime`?,https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133859106,133859106,src/validation.cpp
kallewoof,2017-08-18T00:36:05Z,But it wasn't skipped. It was already there.,https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133860109,133860109,src/validation.cpp
kallewoof,2017-08-18T00:37:31Z,"As @sipa noted, `REJECT_DUPLICATE` is ambiguous. I don't want to say it was already there, when a conflicted different transaction was there instead. The safest course would seem to simply check if it is there after a failure, as I am doing now.",https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133860245,133860245,src/validation.cpp
promag,2017-08-18T00:45:10Z,"Understood, can't use REJECT_DUPLICATE.\n\nStill, the way it's now is like catching the error, whereas testing before it's like expecting that behaviour.",https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133860846,133860846,src/validation.cpp
kallewoof,2017-08-18T00:50:34Z,"Yes. There's a race condition going on here, which makes this better than the alternative (i.e. checking if exists and then trying to accept).\n\nThread A is doing wallet mempool insertions.\nThread B is calling LoadMempool().\n\nCase 1:\n- Thread A imports tx X\n- Thread B tests for presence of tx X. Found. Marks already there and moves on.\n\nCase 2:\n- Thread B tests for presence of t",https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133861309,133861309,src/validation.cpp
promag,2017-08-18T00:57:41Z,Doesn't the above `LOCK(cs_main)` prevents that case (and the current implementation for all that matters)?,https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133861894,133861894,src/validation.cpp
promag,2017-08-18T01:03:32Z,"Rigth, maybe rename skipped to expired. \n\nEdit: the message on the bottom already prints expired.. ðŸ™„ ",https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133862339,133862339,src/validation.cpp
kallewoof,2017-08-18T01:59:05Z,"Hm, you're right, it does. I think.",https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133867121,133867121,src/validation.cpp
kallewoof,2017-08-18T02:05:21Z,Good point. Done.,https://github.com/bitcoin/bitcoin/pull/11062#discussion_r133867653,133867653,src/validation.cpp
jnewbery,2017-09-01T19:15:56Z,nit: snake case `already_there`,https://github.com/bitcoin/bitcoin/pull/11062#discussion_r136647299,136647299,src/validation.cpp
jnewbery,2017-09-01T19:16:15Z,nit: mark them as 'already there',https://github.com/bitcoin/bitcoin/pull/11062#discussion_r136647361,136647361,src/validation.cpp
promag,2017-09-01T21:46:37Z,"IMO consider renaming to one of `already_imported`, `already_loaded`, `already_in_mempool`.",https://github.com/bitcoin/bitcoin/pull/11062#discussion_r136671150,136671150,src/validation.cpp
kallewoof,2017-09-04T05:49:54Z,"Personally feel the current name is fine as is, but will change if people want it.",https://github.com/bitcoin/bitcoin/pull/11062#discussion_r136747690,136747690,src/validation.cpp
