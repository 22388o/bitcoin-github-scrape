[
  {
    "sha": "942ff2054b41fe3f78f1b3d88cfd032bc95fd62f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5NDJmZjIwNTRiNDFmZTNmNzhmMWIzZDg4Y2ZkMDMyYmM5NWZkNjJm",
    "commit": {
      "author": {
        "name": "nkostoulas",
        "email": "nkostoulas@gmail.com",
        "date": "2019-04-17T16:25:27Z"
      },
      "committer": {
        "name": "nkostoulas",
        "email": "nkostoulas@gmail.com",
        "date": "2019-04-17T19:21:45Z"
      },
      "message": "contrib: gh-merge: Use pagination to fetch all review comments",
      "tree": {
        "sha": "3be2c04c8b629808e788b583231cdde5581dbbb5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3be2c04c8b629808e788b583231cdde5581dbbb5"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/942ff2054b41fe3f78f1b3d88cfd032bc95fd62f",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE3IuBR3rydcfK3KmKiVyjjvxURg8FAly3fMsACgkQiVyjjvxU\nRg8ZsxAAqV5pxYjZ6hCszLcr26YEUtcDfoDc4gPPWpbsHi0sPPAC61JQaefHuQ/5\nMCUXGFQUvaRX10UvCX92JPlSI6OxhdlhP0szqSpk7Ns+mOcptzcglGeWFiOasO+o\nxoaMQ1WfJVlLPVXbzYpwzp+E7wgvAqppxuC6U4WGKSWANSUvkCD6PvwQOL8LcVXC\nL33dFUw1r3CtBSeeiwLgE+uHQEY5cynLSECLDORKCczsmrC4dr2Z9YS67nv59dOS\nXhGbWw3BQ3wvVhWLzVFreDGA6dhJAhpMKjVr7xDmKgXdJw5UD+JvzpuNP36BINCb\nE143j5fT2k5XRm5ygmn7ZdjhT2HAGBdwjjwxpbHzd32+wGVrYX7yr3Fafo1CiZLK\nlm2faBbuEZRhc68FLtie4PdAKzE84a2DFcRqFUrrxhK8P/87h2yjvheV1rGo5lUQ\nFtbwmaQ5F+yxpVoNT/4RQJdWlpP47UVDBkLlHKirgzlz108F2tv31Xu8x7b77+wW\njyhI2KvZEqcpgxjtHKlCJdOeLd2m/aWtwo8O1d9+JO2sXYWgCI0pMNjR9vBb/VX4\nG93NvmEKBVrQLPyaMxd7c64pud2x+0U42++dN0PWIXG5WCFjRmxs5iCH2IWj34Rh\nJy1Xvajt/sZ/fbHAVog1aw6Ocbc6fkWU+fPPjpQoBtMiciT5G/g=\n=NNol\n-----END PGP SIGNATURE-----",
        "payload": "tree 3be2c04c8b629808e788b583231cdde5581dbbb5\nparent 0c9de67f343c0e740a7f488e85270d519a352119\nauthor nkostoulas <nkostoulas@gmail.com> 1555518327 +0100\ncommitter nkostoulas <nkostoulas@gmail.com> 1555528905 +0100\n\ncontrib: gh-merge: Use pagination to fetch all review comments\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/942ff2054b41fe3f78f1b3d88cfd032bc95fd62f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/942ff2054b41fe3f78f1b3d88cfd032bc95fd62f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/942ff2054b41fe3f78f1b3d88cfd032bc95fd62f/comments",
    "author": {
      "login": "nkostoulas",
      "id": 14759579,
      "node_id": "MDQ6VXNlcjE0NzU5NTc5",
      "avatar_url": "https://avatars.githubusercontent.com/u/14759579?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nkostoulas",
      "html_url": "https://github.com/nkostoulas",
      "followers_url": "https://api.github.com/users/nkostoulas/followers",
      "following_url": "https://api.github.com/users/nkostoulas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nkostoulas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nkostoulas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nkostoulas/subscriptions",
      "organizations_url": "https://api.github.com/users/nkostoulas/orgs",
      "repos_url": "https://api.github.com/users/nkostoulas/repos",
      "events_url": "https://api.github.com/users/nkostoulas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nkostoulas/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "nkostoulas",
      "id": 14759579,
      "node_id": "MDQ6VXNlcjE0NzU5NTc5",
      "avatar_url": "https://avatars.githubusercontent.com/u/14759579?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nkostoulas",
      "html_url": "https://github.com/nkostoulas",
      "followers_url": "https://api.github.com/users/nkostoulas/followers",
      "following_url": "https://api.github.com/users/nkostoulas/following{/other_user}",
      "gists_url": "https://api.github.com/users/nkostoulas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/nkostoulas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/nkostoulas/subscriptions",
      "organizations_url": "https://api.github.com/users/nkostoulas/orgs",
      "repos_url": "https://api.github.com/users/nkostoulas/repos",
      "events_url": "https://api.github.com/users/nkostoulas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/nkostoulas/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "0c9de67f343c0e740a7f488e85270d519a352119",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0c9de67f343c0e740a7f488e85270d519a352119",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/0c9de67f343c0e740a7f488e85270d519a352119"
      }
    ],
    "stats": {
      "total": 41,
      "additions": 30,
      "deletions": 11
    },
    "files": [
      {
        "sha": "a57ecf9818370af61eb321ddb6a93484b7d663f9",
        "filename": "contrib/devtools/github-merge.py",
        "status": "modified",
        "additions": 30,
        "deletions": 11,
        "changes": 41,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/942ff2054b41fe3f78f1b3d88cfd032bc95fd62f/contrib/devtools/github-merge.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/942ff2054b41fe3f78f1b3d88cfd032bc95fd62f/contrib/devtools/github-merge.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/contrib/devtools/github-merge.py?ref=942ff2054b41fe3f78f1b3d88cfd032bc95fd62f",
        "patch": "@@ -47,17 +47,36 @@ def git_config_get(option, default=None):\n     except subprocess.CalledProcessError:\n         return default\n \n-def retrieve_json(req, ghtoken):\n+def get_response(req_url, ghtoken):\n+    req = Request(req_url)\n+    if ghtoken is not None:\n+        req.add_header('Authorization', 'token ' + ghtoken)\n+    return urlopen(req)\n+\n+def retrieve_json(req_url, ghtoken, use_pagination=False):\n     '''\n     Retrieve json from github.\n     Return None if an error happens.\n     '''\n     try:\n-        if ghtoken is not None:\n-            req.add_header('Authorization', 'token ' + ghtoken)\n-        result = urlopen(req)\n         reader = codecs.getreader('utf-8')\n-        obj = json.load(reader(result))\n+        if not use_pagination:\n+            return json.load(reader(get_response(req_url, ghtoken)))\n+\n+        obj = []\n+        page_num = 1\n+        while True:\n+            req_url_page = '{}?page={}'.format(req_url, page_num)\n+            result = get_response(req_url_page, ghtoken)\n+            obj.extend(json.load(reader(result)))\n+\n+            link = result.headers.get('link', None)\n+            if link is not None:\n+                link_next = [l for l in link.split(',') if 'rel=\"next\"' in l]\n+                if len(link_next) > 0:\n+                    page_num = int(link_next[0][link_next[0].find(\"page=\")+5:link_next[0].find(\">\")])\n+                    continue\n+            break\n         return obj\n     except HTTPError as e:\n         error_message = e.read()\n@@ -69,16 +88,16 @@ def retrieve_json(req, ghtoken):\n         return None\n \n def retrieve_pr_info(repo,pull,ghtoken):\n-    req = Request(\"https://api.github.com/repos/\"+repo+\"/pulls/\"+pull)\n-    return retrieve_json(req,ghtoken)\n+    req_url = \"https://api.github.com/repos/\"+repo+\"/pulls/\"+pull\n+    return retrieve_json(req_url,ghtoken)\n \n def retrieve_pr_comments(repo,pull,ghtoken):\n-    req = Request(\"https://api.github.com/repos/\"+repo+\"/issues/\"+pull+\"/comments\")\n-    return retrieve_json(req,ghtoken)\n+    req_url = \"https://api.github.com/repos/\"+repo+\"/issues/\"+pull+\"/comments\"\n+    return retrieve_json(req_url,ghtoken,use_pagination=True)\n \n def retrieve_pr_reviews(repo,pull,ghtoken):\n-    req = Request(\"https://api.github.com/repos/\"+repo+\"/pulls/\"+pull+\"/reviews\")\n-    return retrieve_json(req,ghtoken)\n+    req_url = \"https://api.github.com/repos/\"+repo+\"/pulls/\"+pull+\"/reviews\"\n+    return retrieve_json(req_url,ghtoken,use_pagination=True)\n \n def ask_prompt(text):\n     print(text,end=\" \",file=stderr)"
      }
    ]
  }
]