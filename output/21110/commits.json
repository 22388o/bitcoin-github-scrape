[
  {
    "sha": "3c2e16be22ae04bf56663ee5ec1554d0d569741b",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozYzJlMTZiZTIyYWUwNGJmNTY2NjNlZTVlYzE1NTRkMGQ1Njk3NDFi",
    "commit": {
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-01-16T20:01:37Z"
      },
      "committer": {
        "name": "fanquake",
        "email": "fanquake@gmail.com",
        "date": "2021-02-17T04:26:04Z"
      },
      "message": "time: add runtime sanity check\n\nstd::chrono::system_clock.time_since_epoch and time_t(0) are not guaranteed\nto use the Unix epoch timestamp, but in practice they almost certainly will.\nAny differing behavior will be assumed to be an error, unless certain\nplatforms prove to consistently deviate, at which point we'll cope with it\nby adding offsets.\n\nDo a quick runtime check to verify that\ntime_t(0) == std::chrono::system_clock's epoch time == unix epoch.\n\nCo-authored-by: Anthony Towns <aj@erisian.com.au>",
      "tree": {
        "sha": "826d344a5874a6a7c2e71c384288ac4bbc696275",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/826d344a5874a6a7c2e71c384288ac4bbc696275"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3c2e16be22ae04bf56663ee5ec1554d0d569741b",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEz7FuIclQ9n+pXlWPLuufXMCVJsEFAmAsmtwACgkQLuufXMCV\nJsEv1hAAifypCh6FmK2TF071K/+PLFscFpwjj3c3Rw+PZiJmvHHDPHqA4NP9lspl\nSiPjJWJHyeWf4oDkUmyh/bCvV5TQ45kSr2CmkQwMj5va1KpkJw9JWjStYKxORXy8\nzWDm3K2MAsLUArVheZf7olwmvJASKELmop3i2p+jy2UlicEWL8KQRy069AasPUP6\nyQIdY+BT1rZbnKVJviHgU1zJUZIMTtVoeiy2ZCN5Eepxuyv95r4hyHA8crH3zOMf\nm/f/nJoCFC5zNlKHqLJkG89adQHnNGAHfFYm03x88iYc6CxU2SxxBXrmSHjx/xDI\nIJTZw8HWmDr9odLIVaD3WsLYpFjrgbPd1FFfxvlyPgGiX6F1LX/t7UzngkTaxYN7\nVMsEV6/QfxE2o1YOgXEXsjsX5T/jM0AQesgHYNclaSNds+6CFcFoOFs4CnuJiwCY\nEMwiS0mH/ozvJrYTiBJdDbz0bUpzHmy/3wN9VORbZWLYXbdQ0MhuDSxojpywAvwE\nz7EkJ4Wrx25pAkWodJ8R/kCtajmsjXRjPxMEA5l1q3G83WdFOxsppI7ug4ZqunS8\nK1QQjnSTHCCR54KAjyq10MfSR8A+h9NI5VN2qRXZyy9u47uHbdDdDHUnnRxNo+NL\nVJh3Y8J/ood4ih0uwEHcJrF+a9DuLIZgqiVS73IA7TetM9KBq6g=\n=lFOc\n-----END PGP SIGNATURE-----",
        "payload": "tree 826d344a5874a6a7c2e71c384288ac4bbc696275\nparent 36be9b821ae0882ba5ccba543f959636e413991d\nauthor Cory Fields <cory-nospam-@coryfields.com> 1484596897 -0500\ncommitter fanquake <fanquake@gmail.com> 1613535964 +0800\n\ntime: add runtime sanity check\n\nstd::chrono::system_clock.time_since_epoch and time_t(0) are not guaranteed\nto use the Unix epoch timestamp, but in practice they almost certainly will.\nAny differing behavior will be assumed to be an error, unless certain\nplatforms prove to consistently deviate, at which point we'll cope with it\nby adding offsets.\n\nDo a quick runtime check to verify that\ntime_t(0) == std::chrono::system_clock's epoch time == unix epoch.\n\nCo-authored-by: Anthony Towns <aj@erisian.com.au>\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3c2e16be22ae04bf56663ee5ec1554d0d569741b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/3c2e16be22ae04bf56663ee5ec1554d0d569741b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3c2e16be22ae04bf56663ee5ec1554d0d569741b/comments",
    "author": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "fanquake",
      "id": 863730,
      "node_id": "MDQ6VXNlcjg2MzczMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fanquake",
      "html_url": "https://github.com/fanquake",
      "followers_url": "https://api.github.com/users/fanquake/followers",
      "following_url": "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url": "https://api.github.com/users/fanquake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
      "organizations_url": "https://api.github.com/users/fanquake/orgs",
      "repos_url": "https://api.github.com/users/fanquake/repos",
      "events_url": "https://api.github.com/users/fanquake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fanquake/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "36be9b821ae0882ba5ccba543f959636e413991d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/36be9b821ae0882ba5ccba543f959636e413991d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/36be9b821ae0882ba5ccba543f959636e413991d"
      }
    ],
    "stats": {
      "total": 52,
      "additions": 52,
      "deletions": 0
    },
    "files": [
      {
        "sha": "3beb421bf96f4eb6eb2915592d2960aeebeb856d",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/3c2e16be22ae04bf56663ee5ec1554d0d569741b/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/3c2e16be22ae04bf56663ee5ec1554d0d569741b/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=3c2e16be22ae04bf56663ee5ec1554d0d569741b",
        "patch": "@@ -773,6 +773,10 @@ static bool InitSanityCheck()\n         return InitError(Untranslated(\"OS cryptographic RNG sanity check failure. Aborting.\"));\n     }\n \n+    if (!ChronoSanityCheck()) {\n+        return InitError(Untranslated(\"Clock epoch mismatch. Aborting.\"));\n+    }\n+\n     return true;\n }\n "
      },
      {
        "sha": "3e4b963fe3639b6be96e406a69ba80c00ed0fa4f",
        "filename": "src/test/sanity_tests.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/3c2e16be22ae04bf56663ee5ec1554d0d569741b/src/test/sanity_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/3c2e16be22ae04bf56663ee5ec1554d0d569741b/src/test/sanity_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/sanity_tests.cpp?ref=3c2e16be22ae04bf56663ee5ec1554d0d569741b",
        "patch": "@@ -5,6 +5,7 @@\n #include <compat/sanity.h>\n #include <key.h>\n #include <test/util/setup_common.h>\n+#include <util/time.h>\n \n #include <boost/test/unit_test.hpp>\n \n@@ -15,6 +16,7 @@ BOOST_AUTO_TEST_CASE(basic_sanity)\n   BOOST_CHECK_MESSAGE(glibc_sanity_test() == true, \"libc sanity test\");\n   BOOST_CHECK_MESSAGE(glibcxx_sanity_test() == true, \"stdlib sanity test\");\n   BOOST_CHECK_MESSAGE(ECC_InitSanityCheck() == true, \"secp256k1 sanity test\");\n+  BOOST_CHECK_MESSAGE(ChronoSanityCheck() == true, \"chrono epoch test\");\n }\n \n BOOST_AUTO_TEST_SUITE_END()"
      },
      {
        "sha": "9631c115e9cf00731ddc3dfd033de850b51b782c",
        "filename": "src/util/time.cpp",
        "status": "modified",
        "additions": 43,
        "deletions": 0,
        "changes": 43,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/3c2e16be22ae04bf56663ee5ec1554d0d569741b/src/util/time.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/3c2e16be22ae04bf56663ee5ec1554d0d569741b/src/util/time.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/time.cpp?ref=3c2e16be22ae04bf56663ee5ec1554d0d569741b",
        "patch": "@@ -33,6 +33,49 @@ int64_t GetTime()\n     return now;\n }\n \n+bool ChronoSanityCheck()\n+{\n+    // std::chrono::system_clock.time_since_epoch and time_t(0) are not guaranteed\n+    // to use the Unix epoch timestamp, prior to C++20, but in practice they almost\n+    // certainly will. Any differing behavior will be assumed to be an error, unless\n+    // certain platforms prove to consistently deviate, at which point we'll cope\n+    // with it by adding offsets.\n+\n+    // Create a new clock from time_t(0) and make sure that it represents 0\n+    // seconds from the system_clock's time_since_epoch. Then convert that back\n+    // to a time_t and verify that it's the same as before.\n+    const time_t time_t_epoch{};\n+    auto clock = std::chrono::system_clock::from_time_t(time_t_epoch);\n+    if (std::chrono::duration_cast<std::chrono::seconds>(clock.time_since_epoch()).count() != 0) {\n+        return false;\n+    }\n+\n+    time_t time_val = std::chrono::system_clock::to_time_t(clock);\n+    if (time_val != time_t_epoch) {\n+        return false;\n+    }\n+\n+    // Check that the above zero time is actually equal to the known unix timestamp.\n+    struct tm epoch;\n+#ifdef HAVE_GMTIME_R\n+    if (gmtime_r(&time_val, &epoch) == nullptr) {\n+#else\n+    if (gmtime_s(&epoch, &time_val) != 0) {\n+#endif\n+        return false;\n+    }\n+\n+    if ((epoch.tm_sec != 0)  ||\n+       (epoch.tm_min  != 0)  ||\n+       (epoch.tm_hour != 0)  ||\n+       (epoch.tm_mday != 1)  ||\n+       (epoch.tm_mon  != 0)  ||\n+       (epoch.tm_year != 70)) {\n+        return false;\n+    }\n+    return true;\n+}\n+\n template <typename T>\n T GetTime()\n {"
      },
      {
        "sha": "6fb6d5a670faef3e9223e21b022aab623461d9f1",
        "filename": "src/util/time.h",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/3c2e16be22ae04bf56663ee5ec1554d0d569741b/src/util/time.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/3c2e16be22ae04bf56663ee5ec1554d0d569741b/src/util/time.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/time.h?ref=3c2e16be22ae04bf56663ee5ec1554d0d569741b",
        "patch": "@@ -70,4 +70,7 @@ struct timeval MillisToTimeval(int64_t nTimeout);\n  */\n struct timeval MillisToTimeval(std::chrono::milliseconds ms);\n \n+/** Sanity check epoch match normal Unix epoch */\n+bool ChronoSanityCheck();\n+\n #endif // BITCOIN_UTIL_TIME_H"
      }
    ]
  },
  {
    "sha": "9266f7497f256d780178829e0f3a29ddaeb794ba",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5MjY2Zjc0OTdmMjU2ZDc4MDE3ODgyOWUwZjNhMjlkZGFlYjc5NGJh",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2020-02-21T18:12:40Z"
      },
      "committer": {
        "name": "fanquake",
        "email": "fanquake@gmail.com",
        "date": "2021-02-17T04:26:39Z"
      },
      "message": "util: Use std::chrono for time getters",
      "tree": {
        "sha": "a17a9dd6fd98b40b00faa3ae2e4f52d7d49bd00b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a17a9dd6fd98b40b00faa3ae2e4f52d7d49bd00b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9266f7497f256d780178829e0f3a29ddaeb794ba",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEz7FuIclQ9n+pXlWPLuufXMCVJsEFAmAsmv8ACgkQLuufXMCV\nJsFjvg//Wsk1LjjAqltSHMHi6L2z5k8VgXstc2y1Hj+nTgzztuBvBNSW+pr7F9Fp\nR9oSDMLd4+x9BlxzGN97qTDuHqmn/PtKd6ciXmibJyWfCKRG2KDd7UDOR07mePCC\nj/HM5VpAcq2P7Cs+tNqIhTo5unlHRpgiTzZnHBCpFnu7UiwIM1ZEUDhkWUrR7HtZ\nWEQzf4vAo3DN/NV0mlIDl0SnH5a5HCpQNC5wx+bBNKTZWNxRti/7++Cmvh8i4hlR\nR/G1bW8gWpe+SKrwsfXeLP/DVibyPZ4D4pa3dFZVVEh2PdsPPsTrE5uCv4vNHoMo\n12oiRT1ZPyBCPpWPDwRA0ChqlW/HYOsTBz8upWx3buNiBqZocP2kftu7/l8m2NvK\nyi1TmpT7w6OfmSF55ywhDu6UdNQ+dJcTJeQEZNHpCP+GHs4xFmqhQ1kkIKayljrS\nz3W8aaLeE2iQfEYxBij9OBW8kt6Prb4ynpVck58RUfChoJsvt+O2HRQ/kgiYhLvE\nfBV3Ogbyw9dNLJnUuJ5CFsKknZndBjfxjo/bfhdoWMXimUjNLAOoQDG+gT8BeXFf\ng+1jYRjO55BOnKknF0p4huMoTE8sDRDCSRDju7Wib0pu0wB/NT7KxqZrRjrkwObt\nSxqFbDF2+hGC275v0Nk1hQsuiKiCt3JTGrOPlwdyTjmBI+Pycc0=\n=LcLG\n-----END PGP SIGNATURE-----",
        "payload": "tree a17a9dd6fd98b40b00faa3ae2e4f52d7d49bd00b\nparent 3c2e16be22ae04bf56663ee5ec1554d0d569741b\nauthor MarcoFalke <falke.marco@gmail.com> 1582308760 -0500\ncommitter fanquake <fanquake@gmail.com> 1613535999 +0800\n\nutil: Use std::chrono for time getters\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9266f7497f256d780178829e0f3a29ddaeb794ba",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/9266f7497f256d780178829e0f3a29ddaeb794ba",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9266f7497f256d780178829e0f3a29ddaeb794ba/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "fanquake",
      "id": 863730,
      "node_id": "MDQ6VXNlcjg2MzczMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/863730?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fanquake",
      "html_url": "https://github.com/fanquake",
      "followers_url": "https://api.github.com/users/fanquake/followers",
      "following_url": "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url": "https://api.github.com/users/fanquake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
      "organizations_url": "https://api.github.com/users/fanquake/orgs",
      "repos_url": "https://api.github.com/users/fanquake/repos",
      "events_url": "https://api.github.com/users/fanquake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fanquake/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "3c2e16be22ae04bf56663ee5ec1554d0d569741b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3c2e16be22ae04bf56663ee5ec1554d0d569741b",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/3c2e16be22ae04bf56663ee5ec1554d0d569741b"
      }
    ],
    "stats": {
      "total": 20,
      "additions": 11,
      "deletions": 9
    },
    "files": [
      {
        "sha": "06ed8f45169320f85f69b7494bdcc33eb8ff8635",
        "filename": "src/util/time.cpp",
        "status": "modified",
        "additions": 11,
        "deletions": 9,
        "changes": 20,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9266f7497f256d780178829e0f3a29ddaeb794ba/src/util/time.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9266f7497f256d780178829e0f3a29ddaeb794ba/src/util/time.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/time.cpp?ref=9266f7497f256d780178829e0f3a29ddaeb794ba",
        "patch": "@@ -90,6 +90,14 @@ template std::chrono::seconds GetTime();\n template std::chrono::milliseconds GetTime();\n template std::chrono::microseconds GetTime();\n \n+template <typename T>\n+static T GetSystemTime()\n+{\n+    const auto now = std::chrono::duration_cast<T>(std::chrono::system_clock::now().time_since_epoch());\n+    assert(now.count() > 0);\n+    return now;\n+}\n+\n void SetMockTime(int64_t nMockTimeIn)\n {\n     Assert(nMockTimeIn >= 0);\n@@ -103,23 +111,17 @@ int64_t GetMockTime()\n \n int64_t GetTimeMillis()\n {\n-    int64_t now = (boost::posix_time::microsec_clock::universal_time() -\n-                   boost::posix_time::ptime(boost::gregorian::date(1970,1,1))).total_milliseconds();\n-    assert(now > 0);\n-    return now;\n+    return int64_t{GetSystemTime<std::chrono::milliseconds>().count()};\n }\n \n int64_t GetTimeMicros()\n {\n-    int64_t now = (boost::posix_time::microsec_clock::universal_time() -\n-                   boost::posix_time::ptime(boost::gregorian::date(1970,1,1))).total_microseconds();\n-    assert(now > 0);\n-    return now;\n+    return int64_t{GetSystemTime<std::chrono::microseconds>().count()};\n }\n \n int64_t GetSystemTimeInSeconds()\n {\n-    return GetTimeMicros()/1000000;\n+    return int64_t{GetSystemTime<std::chrono::seconds>().count()};\n }\n \n std::string FormatISO8601DateTime(int64_t nTime) {"
      }
    ]
  }
]