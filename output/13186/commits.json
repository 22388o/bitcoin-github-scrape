[
  {
    "sha": "c3c665c4a6eea19906d2a36b2028faccc010dfe5",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjM2M2NjVjNGE2ZWVhMTk5MDZkMmEzNmIyMDI4ZmFjY2MwMTBkZmU1",
    "commit": {
      "author": {
        "name": "Jesse Cohen",
        "email": "jc@jc.lol",
        "date": "2018-03-30T22:05:26Z"
      },
      "committer": {
        "name": "Jesse Cohen",
        "email": "jc@jc.lol",
        "date": "2018-05-07T18:55:36Z"
      },
      "message": "Use a semaphore to trigger shutdown procedures",
      "tree": {
        "sha": "742b1df993d19cb880938b9b04771915e60884d6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/742b1df993d19cb880938b9b04771915e60884d6"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c3c665c4a6eea19906d2a36b2028faccc010dfe5",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c3c665c4a6eea19906d2a36b2028faccc010dfe5",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c3c665c4a6eea19906d2a36b2028faccc010dfe5",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c3c665c4a6eea19906d2a36b2028faccc010dfe5/comments",
    "author": {
      "login": "skeees",
      "id": 195769,
      "node_id": "MDQ6VXNlcjE5NTc2OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/195769?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/skeees",
      "html_url": "https://github.com/skeees",
      "followers_url": "https://api.github.com/users/skeees/followers",
      "following_url": "https://api.github.com/users/skeees/following{/other_user}",
      "gists_url": "https://api.github.com/users/skeees/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/skeees/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/skeees/subscriptions",
      "organizations_url": "https://api.github.com/users/skeees/orgs",
      "repos_url": "https://api.github.com/users/skeees/repos",
      "events_url": "https://api.github.com/users/skeees/events{/privacy}",
      "received_events_url": "https://api.github.com/users/skeees/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "skeees",
      "id": 195769,
      "node_id": "MDQ6VXNlcjE5NTc2OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/195769?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/skeees",
      "html_url": "https://github.com/skeees",
      "followers_url": "https://api.github.com/users/skeees/followers",
      "following_url": "https://api.github.com/users/skeees/following{/other_user}",
      "gists_url": "https://api.github.com/users/skeees/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/skeees/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/skeees/subscriptions",
      "organizations_url": "https://api.github.com/users/skeees/orgs",
      "repos_url": "https://api.github.com/users/skeees/repos",
      "events_url": "https://api.github.com/users/skeees/events{/privacy}",
      "received_events_url": "https://api.github.com/users/skeees/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "bf9b03ddcc65c807503d0622c9e43f85cd15d367",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bf9b03ddcc65c807503d0622c9e43f85cd15d367",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/bf9b03ddcc65c807503d0622c9e43f85cd15d367"
      }
    ],
    "stats": {
      "total": 15,
      "additions": 11,
      "deletions": 4
    },
    "files": [
      {
        "sha": "1d7d39ecf1bd98c41042dee981a4fafc514e67ff",
        "filename": "src/bitcoind.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 4,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c3c665c4a6eea19906d2a36b2028faccc010dfe5/src/bitcoind.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c3c665c4a6eea19906d2a36b2028faccc010dfe5/src/bitcoind.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bitcoind.cpp?ref=c3c665c4a6eea19906d2a36b2028faccc010dfe5",
        "patch": "@@ -42,10 +42,7 @@\n \n static void WaitForShutdown()\n {\n-    while (!ShutdownRequested())\n-    {\n-        MilliSleep(200);\n-    }\n+    BlockUntilShutdown();\n     Interrupt();\n }\n "
      },
      {
        "sha": "78828388ebb9d15b172e3c2f5cf158d64a43de73",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 0,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c3c665c4a6eea19906d2a36b2028faccc010dfe5/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c3c665c4a6eea19906d2a36b2028faccc010dfe5/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=c3c665c4a6eea19906d2a36b2028faccc010dfe5",
        "patch": "@@ -131,16 +131,25 @@ static const char* FEE_ESTIMATES_FILENAME=\"fee_estimates.dat\";\n //\n \n std::atomic<bool> fRequestShutdown(false);\n+CSemaphore shutdown_barrier(0);\n \n void StartShutdown()\n {\n     fRequestShutdown = true;\n+    shutdown_barrier.post();\n }\n bool ShutdownRequested()\n {\n     return fRequestShutdown;\n }\n+void BlockUntilShutdown()\n+{\n+    shutdown_barrier.wait();\n \n+    // we don't know how many other threads are also waiting\n+    // so we let the next thread (if any) wake up too\n+    shutdown_barrier.post();\n+}\n /**\n  * This is a minimally invasive approach to shutdown on LevelDB read errors from the\n  * chainstate, while keeping user interface out of the common library, which is shared"
      },
      {
        "sha": "40934969ca51829840d679fa08f092a15b713640",
        "filename": "src/init.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c3c665c4a6eea19906d2a36b2028faccc010dfe5/src/init.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c3c665c4a6eea19906d2a36b2028faccc010dfe5/src/init.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.h?ref=c3c665c4a6eea19906d2a36b2028faccc010dfe5",
        "patch": "@@ -22,6 +22,7 @@ class thread_group;\n \n void StartShutdown();\n bool ShutdownRequested();\n+void BlockUntilShutdown();\n /** Interrupt threads */\n void Interrupt();\n void Shutdown();"
      }
    ]
  }
]