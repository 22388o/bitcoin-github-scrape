[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/415585660",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/14035#issuecomment-415585660",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/14035",
    "id": 415585660,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNTU4NTY2MA==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-23T22:03:15Z",
    "updated_at": "2018-12-28T14:22:40Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#14942](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14942.html) (wallet: Return a ScanResult from CWallet::RescanFromTime by Empact)\n* [#14384](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14384.html) (Resolve validationinterface circular dependencies by 251Labs)\n* [#14121](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14121.html) (Index for BIP 157 block filters by jimpo)\n* [#14111](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/14111.html) (index: Create IndexRunner class for activing indexes. by jimpo)\n* [#13949](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/13949.html) (Introduce MempoolObserver interface to break \"policy/fees -> txmempool -> policy/fees\" circular dependency by Empact)\n* [#13743](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/13743.html) (refactor: Replace boost::bind with std::bind by ken2812221)\n* [#13088](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/13088.html) (Log early messages with -printtoconsole by ajtowns)\n* [#10973](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/10973.html) (Refactor: separate wallet from node by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/415585660/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/415810823",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/14035#issuecomment-415810823",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/14035",
    "id": 415810823,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNTgxMDgyMw==",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-24T16:25:59Z",
    "updated_at": "2018-08-24T16:25:59Z",
    "author_association": "MEMBER",
    "body": "Might be wortwhile to update it to using output descriptors, like `scantxoutset`: https://github.com/bitcoin/bitcoin/blob/master/src/rpc/blockchain.cpp#L2035",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/415810823/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/415838376",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/14035#issuecomment-415838376",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/14035",
    "id": 415838376,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNTgzODM3Ng==",
    "user": {
      "login": "mgrychow",
      "id": 42271287,
      "node_id": "MDQ6VXNlcjQyMjcxMjg3",
      "avatar_url": "https://avatars.githubusercontent.com/u/42271287?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mgrychow",
      "html_url": "https://github.com/mgrychow",
      "followers_url": "https://api.github.com/users/mgrychow/followers",
      "following_url": "https://api.github.com/users/mgrychow/following{/other_user}",
      "gists_url": "https://api.github.com/users/mgrychow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mgrychow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mgrychow/subscriptions",
      "organizations_url": "https://api.github.com/users/mgrychow/orgs",
      "repos_url": "https://api.github.com/users/mgrychow/repos",
      "events_url": "https://api.github.com/users/mgrychow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mgrychow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-24T18:08:59Z",
    "updated_at": "2018-08-24T18:08:59Z",
    "author_association": "NONE",
    "body": "@instagibbs Thanks for the remarks, how about adding support for descriptors in separate PR?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/415838376/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/415851603",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/14035#issuecomment-415851603",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/14035",
    "id": 415851603,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNTg1MTYwMw==",
    "user": {
      "login": "marcinja",
      "id": 12243734,
      "node_id": "MDQ6VXNlcjEyMjQzNzM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/12243734?u=38970c06fa3c115f2caba3def2c99b78d7a48023&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/marcinja",
      "html_url": "https://github.com/marcinja",
      "followers_url": "https://api.github.com/users/marcinja/followers",
      "following_url": "https://api.github.com/users/marcinja/following{/other_user}",
      "gists_url": "https://api.github.com/users/marcinja/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/marcinja/subscriptions",
      "organizations_url": "https://api.github.com/users/marcinja/orgs",
      "repos_url": "https://api.github.com/users/marcinja/repos",
      "events_url": "https://api.github.com/users/marcinja/events{/privacy}",
      "received_events_url": "https://api.github.com/users/marcinja/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-24T18:57:29Z",
    "updated_at": "2018-08-24T18:57:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "@mgrychow, I recently started working on an address-based index (not just for UTXOs) at #14053. I can improve my PR quite a bit using your changes to the ValidationInterface. If you separated that change (adding CBlockUndo's) into it's own commit this PR would be a bit cleaner, and I could use it for the address index :)\r\n\r\nAnyway, will be reviewing this since it's pretty similar to the PR I just made. \r\n\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/415851603/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/415852168",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/14035#issuecomment-415852168",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/14035",
    "id": 415852168,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQxNTg1MjE2OA==",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-08-24T18:59:37Z",
    "updated_at": "2018-08-24T18:59:37Z",
    "author_association": "MEMBER",
    "body": "@mgrychow Not going to bikeshed this PR to death, just noting it in case you've missed it.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/415852168/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/438617351",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/14035#issuecomment-438617351",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/14035",
    "id": 438617351,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQzODYxNzM1MQ==",
    "user": {
      "login": "mgrychow",
      "id": 42271287,
      "node_id": "MDQ6VXNlcjQyMjcxMjg3",
      "avatar_url": "https://avatars.githubusercontent.com/u/42271287?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mgrychow",
      "html_url": "https://github.com/mgrychow",
      "followers_url": "https://api.github.com/users/mgrychow/followers",
      "following_url": "https://api.github.com/users/mgrychow/following{/other_user}",
      "gists_url": "https://api.github.com/users/mgrychow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mgrychow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mgrychow/subscriptions",
      "organizations_url": "https://api.github.com/users/mgrychow/orgs",
      "repos_url": "https://api.github.com/users/mgrychow/repos",
      "events_url": "https://api.github.com/users/mgrychow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mgrychow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-11-14T10:39:19Z",
    "updated_at": "2018-11-14T10:39:19Z",
    "author_association": "NONE",
    "body": "Rebased",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/438617351/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/450504123",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/14035#issuecomment-450504123",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/14035",
    "id": 450504123,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ1MDUwNDEyMw==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-12-29T16:28:58Z",
    "updated_at": "2018-12-29T16:28:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--cf906140f33d8803c4a75a2196329ecb-->Needs rebase",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/450504123/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/484966847",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/14035#issuecomment-484966847",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/14035",
    "id": 484966847,
    "node_id": "MDEyOklzc3VlQ29tbWVudDQ4NDk2Njg0Nw==",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?u=0691974eedcc2ab5366cc1080fb1c030e87244c2&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-04-19T17:37:46Z",
    "updated_at": "2019-04-19T17:37:46Z",
    "author_association": "MEMBER",
    "body": "There hasn't been much activity lately and the patch still needs rebase, so I am closing this for now. Please let me know when you want to continue working on this, so the pull request can be re-opened.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/484966847/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212682356",
    "pull_request_review_id": 149370692,
    "id": 212682356,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMjY4MjM1Ng==",
    "diff_hunk": "@@ -1079,6 +1082,145 @@ UniValue gettxout(const JSONRPCRequest& request)\n     return ret;\n }\n \n+void utxoSetToJson(const SerializableUtxoSet& utxoSet, UniValue& vObjects, unsigned int minConf)\n+{\n+    for(auto outpoint: utxoSet)\n+    {\n+        Coin coin;\n+        if(minConf == 0)\n+        {\n+            LOCK(mempool.cs);\n+            CCoinsViewMemPool view(pcoinsTip.get(), mempool);\n+            if(!(view.GetCoin(outpoint, coin)))\n+                continue;\n+        }\n+        else if(!(pcoinsTip->GetCoin(outpoint, coin)))\n+            continue;\n+\n+        if(coin.out.IsNull() || coin.out.scriptPubKey.IsUnspendable())\n+            continue;\n+\n+        if(coin.nHeight != MEMPOOL_HEIGHT && !(chainActive[coin.nHeight] && chainActive[coin.nHeight]->phashBlock))\n+            throw JSONRPCError(RPC_INTERNAL_ERROR, \"Internal Error: !chainActive[coins.nHeight]\");\n+\n+        CBlockIndex *pindex = mapBlockIndex.find(pcoinsTip->GetBestBlock())->second;\n+\n+        uint64_t nConfirmations = 0;\n+        if ((unsigned int)coin.nHeight != MEMPOOL_HEIGHT)\n+            nConfirmations = pindex->nHeight - coin.nHeight + 1;\n+        if (nConfirmations < minConf)\n+            continue;\n+\n+        UniValue oScriptPubKey(UniValue::VOBJ);\n+        ScriptPubKeyToUniv(coin.out.scriptPubKey, oScriptPubKey, true);\n+\n+        UniValue o(UniValue::VOBJ);\n+        o.push_back(Pair(\"confirmations\", nConfirmations));",
    "path": "src/rpc/blockchain.cpp",
    "position": null,
    "original_position": 54,
    "commit_id": "34c8e8e7cff4fa79264c510655f2320ac80e1513",
    "original_commit_id": "ebe3d1fb657f206e692de8406d11650890921ecb",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "note: \"push_back(Pair\" is deprecated in favor of pushKV",
    "created_at": "2018-08-24T16:23:37Z",
    "updated_at": "2018-11-13T18:49:33Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/14035#discussion_r212682356",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/14035",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212682356"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/14035#discussion_r212682356"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/14035"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212682356/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1118,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212710403",
    "pull_request_review_id": 149404905,
    "id": 212710403,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMjcxMDQwMw==",
    "diff_hunk": "@@ -1079,6 +1082,145 @@ UniValue gettxout(const JSONRPCRequest& request)\n     return ret;\n }\n \n+void utxoSetToJson(const SerializableUtxoSet& utxoSet, UniValue& vObjects, unsigned int minConf)\n+{\n+    for(auto outpoint: utxoSet)\n+    {\n+        Coin coin;\n+        if(minConf == 0)\n+        {\n+            LOCK(mempool.cs);\n+            CCoinsViewMemPool view(pcoinsTip.get(), mempool);\n+            if(!(view.GetCoin(outpoint, coin)))\n+                continue;\n+        }\n+        else if(!(pcoinsTip->GetCoin(outpoint, coin)))\n+            continue;\n+\n+        if(coin.out.IsNull() || coin.out.scriptPubKey.IsUnspendable())\n+            continue;\n+\n+        if(coin.nHeight != MEMPOOL_HEIGHT && !(chainActive[coin.nHeight] && chainActive[coin.nHeight]->phashBlock))\n+            throw JSONRPCError(RPC_INTERNAL_ERROR, \"Internal Error: !chainActive[coins.nHeight]\");\n+\n+        CBlockIndex *pindex = mapBlockIndex.find(pcoinsTip->GetBestBlock())->second;\n+\n+        uint64_t nConfirmations = 0;\n+        if ((unsigned int)coin.nHeight != MEMPOOL_HEIGHT)\n+            nConfirmations = pindex->nHeight - coin.nHeight + 1;\n+        if (nConfirmations < minConf)\n+            continue;\n+\n+        UniValue oScriptPubKey(UniValue::VOBJ);\n+        ScriptPubKeyToUniv(coin.out.scriptPubKey, oScriptPubKey, true);\n+\n+        UniValue o(UniValue::VOBJ);\n+        o.push_back(Pair(\"confirmations\", nConfirmations));",
    "path": "src/rpc/blockchain.cpp",
    "position": null,
    "original_position": 54,
    "commit_id": "34c8e8e7cff4fa79264c510655f2320ac80e1513",
    "original_commit_id": "ebe3d1fb657f206e692de8406d11650890921ecb",
    "user": {
      "login": "mgrychow",
      "id": 42271287,
      "node_id": "MDQ6VXNlcjQyMjcxMjg3",
      "avatar_url": "https://avatars.githubusercontent.com/u/42271287?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mgrychow",
      "html_url": "https://github.com/mgrychow",
      "followers_url": "https://api.github.com/users/mgrychow/followers",
      "following_url": "https://api.github.com/users/mgrychow/following{/other_user}",
      "gists_url": "https://api.github.com/users/mgrychow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mgrychow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mgrychow/subscriptions",
      "organizations_url": "https://api.github.com/users/mgrychow/orgs",
      "repos_url": "https://api.github.com/users/mgrychow/repos",
      "events_url": "https://api.github.com/users/mgrychow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mgrychow/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Corrected",
    "created_at": "2018-08-24T18:05:58Z",
    "updated_at": "2018-11-13T18:49:33Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/14035#discussion_r212710403",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/14035",
    "author_association": "NONE",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212710403"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/14035#discussion_r212710403"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/14035"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212710403/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1118,
    "side": "RIGHT",
    "in_reply_to_id": 212682356
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212726312",
    "pull_request_review_id": 149424924,
    "id": 212726312,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMjcyNjMxMg==",
    "diff_hunk": "@@ -0,0 +1,455 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/utxoscriptindex.h>\n+#include <util.h>\n+#include <script/standard.h>\n+#include <pubkey.h>\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <txdb.h>\n+#include <ui_interface.h>\n+\n+#include<boost/thread.hpp>\n+\n+\n+std::unique_ptr<UtxoScriptIndex> g_utxoscriptindex;\n+\n+static ScriptHash ScriptIndexHash(const CScript& in){\n+    return Hash160(in.begin(), in.end());\n+}\n+\n+class UtxoScriptIndexDBCursor\n+{\n+public:\n+    UtxoScriptIndexDBCursor(CDBIterator* cursor) : pcursor(cursor){}\n+\n+    bool GetKey(ScriptHash& key);\n+    bool GetValue(SerializableUtxoSet& utxoSet);\n+    unsigned int GetValueSize() const;\n+\n+    bool Valid() const;\n+    void Next();\n+\n+    std::pair<char, ScriptHash> keyTmp;\n+    std::unique_ptr<CDBIterator> pcursor;\n+};\n+\n+class UtxoScriptIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t nCacheSize, bool fMemory = false, bool fWipe = false);\n+\n+    bool WriteUtxos(std::map<ScriptHash, SerializableUtxoSet>& scriptUtxos);\n+    bool ReadUtxos(const ScriptHash&, SerializableUtxoSet& utxoSet);\n+\n+    UtxoScriptIndexDBCursor* Cursor() const;\n+};\n+\n+UtxoScriptIndex::DB::DB(size_t nCacheSize, bool fMemory, bool fWipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"coinsbyscript\", nCacheSize, fMemory, fWipe)\n+{\n+\n+}\n+\n+bool UtxoScriptIndex::DB::WriteUtxos(std::map<ScriptHash, SerializableUtxoSet>& scriptUtxos)\n+{\n+    CDBBatch batch(*this);\n+    for(const auto& scriptUtxo: scriptUtxos)\n+    {\n+        auto key = std::make_pair(DB_UTXO, std::ref(scriptUtxo.first));\n+        auto& value = scriptUtxo.second;\n+        if(scriptUtxo.second.empty())\n+            batch.Erase(key);\n+        else\n+            batch.Write(key,value);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool UtxoScriptIndex::DB::ReadUtxos(const ScriptHash& scriptId, SerializableUtxoSet& utxoSet)\n+{\n+    return Read(std::make_pair(DB_UTXO, scriptId), utxoSet);\n+}\n+\n+UtxoScriptIndexDBCursor* UtxoScriptIndex::DB::Cursor() const\n+{\n+    UtxoScriptIndexDBCursor* cursor = new UtxoScriptIndexDBCursor(\n+                                    const_cast<CDBWrapper*>(\n+                                        static_cast<const CDBWrapper*>(this))->NewIterator());\n+    cursor->pcursor->Seek(DB_UTXO);\n+    if(!(cursor->pcursor->Valid()))\n+        cursor->keyTmp.first = 0;\n+    else\n+        cursor->pcursor->GetKey(cursor->keyTmp);\n+    return cursor;\n+}\n+\n+bool UtxoScriptIndexDBCursor::GetKey(ScriptHash& key)\n+{\n+    if(keyTmp.first == DB_UTXO)\n+    {\n+        key = keyTmp.second;\n+        return true;\n+    }\n+    return false;\n+}\n+\n+bool UtxoScriptIndexDBCursor::GetValue(SerializableUtxoSet& utxoSet)\n+{\n+    return pcursor->GetValue(utxoSet);\n+}\n+\n+bool UtxoScriptIndexDBCursor::Valid() const\n+{\n+    return keyTmp.first == DB_UTXO;\n+}\n+\n+void UtxoScriptIndexDBCursor::Next()\n+{\n+    pcursor->Next();\n+    if(pcursor->Valid() && pcursor->GetKey(keyTmp))\n+        return;\n+    else\n+        keyTmp.first = 0;\n+}\n+\n+UtxoScriptIndex::UtxoScriptIndex(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    m_db(std::move(MakeUnique<UtxoScriptIndex::DB>(n_cache_size, f_memory, f_wipe)))\n+{\n+\n+}\n+\n+UtxoScriptIndex::~UtxoScriptIndex() {\n+    UnregisterValidationInterface(this);\n+}\n+\n+void UtxoScriptIndex::Start()\n+{\n+    RegisterValidationInterface(this);\n+}\n+\n+void UtxoScriptIndex::TransactionAddedToMempool(const CTransactionRef &ptxn) {\n+    LOCK(cs_utxoCacheMempool);\n+    const CTransaction &tx = *ptxn;\n+    for (unsigned int i = 0; i < tx.vout.size(); i++)\n+    {\n+        if (tx.vout[i].IsNull() || tx.vout[i].scriptPubKey.IsUnspendable())",
    "path": "src/index/utxoscriptindex.cpp",
    "position": 137,
    "original_position": 138,
    "commit_id": "34c8e8e7cff4fa79264c510655f2320ac80e1513",
    "original_commit_id": "37562b7e364022b66c073a207aa38428f7d8b4fa",
    "user": {
      "login": "marcinja",
      "id": 12243734,
      "node_id": "MDQ6VXNlcjEyMjQzNzM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/12243734?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/marcinja",
      "html_url": "https://github.com/marcinja",
      "followers_url": "https://api.github.com/users/marcinja/followers",
      "following_url": "https://api.github.com/users/marcinja/following{/other_user}",
      "gists_url": "https://api.github.com/users/marcinja/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/marcinja/subscriptions",
      "organizations_url": "https://api.github.com/users/marcinja/orgs",
      "repos_url": "https://api.github.com/users/marcinja/repos",
      "events_url": "https://api.github.com/users/marcinja/events{/privacy}",
      "received_events_url": "https://api.github.com/users/marcinja/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "~~Is this check needed? In what case will a transaction be added to the mempool where this is true? I might be missing something.~~ (OP_RETURN outputs)",
    "created_at": "2018-08-24T19:04:32Z",
    "updated_at": "2018-11-13T18:49:33Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/14035#discussion_r212726312",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/14035",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212726312"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/14035#discussion_r212726312"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/14035"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212726312/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 137,
    "original_line": 137,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212727496",
    "pull_request_review_id": 149424924,
    "id": 212727496,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMjcyNzQ5Ng==",
    "diff_hunk": "@@ -0,0 +1,455 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/utxoscriptindex.h>\n+#include <util.h>\n+#include <script/standard.h>\n+#include <pubkey.h>\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <txdb.h>\n+#include <ui_interface.h>\n+\n+#include<boost/thread.hpp>\n+\n+\n+std::unique_ptr<UtxoScriptIndex> g_utxoscriptindex;\n+\n+static ScriptHash ScriptIndexHash(const CScript& in){\n+    return Hash160(in.begin(), in.end());\n+}\n+\n+class UtxoScriptIndexDBCursor\n+{\n+public:\n+    UtxoScriptIndexDBCursor(CDBIterator* cursor) : pcursor(cursor){}\n+\n+    bool GetKey(ScriptHash& key);\n+    bool GetValue(SerializableUtxoSet& utxoSet);\n+    unsigned int GetValueSize() const;\n+\n+    bool Valid() const;\n+    void Next();\n+\n+    std::pair<char, ScriptHash> keyTmp;\n+    std::unique_ptr<CDBIterator> pcursor;\n+};\n+\n+class UtxoScriptIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t nCacheSize, bool fMemory = false, bool fWipe = false);\n+\n+    bool WriteUtxos(std::map<ScriptHash, SerializableUtxoSet>& scriptUtxos);\n+    bool ReadUtxos(const ScriptHash&, SerializableUtxoSet& utxoSet);\n+\n+    UtxoScriptIndexDBCursor* Cursor() const;\n+};\n+\n+UtxoScriptIndex::DB::DB(size_t nCacheSize, bool fMemory, bool fWipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"coinsbyscript\", nCacheSize, fMemory, fWipe)\n+{\n+\n+}\n+\n+bool UtxoScriptIndex::DB::WriteUtxos(std::map<ScriptHash, SerializableUtxoSet>& scriptUtxos)\n+{\n+    CDBBatch batch(*this);\n+    for(const auto& scriptUtxo: scriptUtxos)\n+    {\n+        auto key = std::make_pair(DB_UTXO, std::ref(scriptUtxo.first));\n+        auto& value = scriptUtxo.second;\n+        if(scriptUtxo.second.empty())\n+            batch.Erase(key);\n+        else\n+            batch.Write(key,value);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool UtxoScriptIndex::DB::ReadUtxos(const ScriptHash& scriptId, SerializableUtxoSet& utxoSet)\n+{\n+    return Read(std::make_pair(DB_UTXO, scriptId), utxoSet);\n+}\n+\n+UtxoScriptIndexDBCursor* UtxoScriptIndex::DB::Cursor() const\n+{\n+    UtxoScriptIndexDBCursor* cursor = new UtxoScriptIndexDBCursor(\n+                                    const_cast<CDBWrapper*>(\n+                                        static_cast<const CDBWrapper*>(this))->NewIterator());\n+    cursor->pcursor->Seek(DB_UTXO);\n+    if(!(cursor->pcursor->Valid()))\n+        cursor->keyTmp.first = 0;\n+    else\n+        cursor->pcursor->GetKey(cursor->keyTmp);\n+    return cursor;\n+}\n+\n+bool UtxoScriptIndexDBCursor::GetKey(ScriptHash& key)\n+{\n+    if(keyTmp.first == DB_UTXO)\n+    {\n+        key = keyTmp.second;\n+        return true;\n+    }\n+    return false;\n+}\n+\n+bool UtxoScriptIndexDBCursor::GetValue(SerializableUtxoSet& utxoSet)\n+{\n+    return pcursor->GetValue(utxoSet);\n+}\n+\n+bool UtxoScriptIndexDBCursor::Valid() const\n+{\n+    return keyTmp.first == DB_UTXO;\n+}\n+\n+void UtxoScriptIndexDBCursor::Next()\n+{\n+    pcursor->Next();\n+    if(pcursor->Valid() && pcursor->GetKey(keyTmp))\n+        return;\n+    else\n+        keyTmp.first = 0;\n+}\n+\n+UtxoScriptIndex::UtxoScriptIndex(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    m_db(std::move(MakeUnique<UtxoScriptIndex::DB>(n_cache_size, f_memory, f_wipe)))\n+{\n+\n+}\n+\n+UtxoScriptIndex::~UtxoScriptIndex() {\n+    UnregisterValidationInterface(this);\n+}\n+\n+void UtxoScriptIndex::Start()\n+{\n+    RegisterValidationInterface(this);\n+}\n+\n+void UtxoScriptIndex::TransactionAddedToMempool(const CTransactionRef &ptxn) {\n+    LOCK(cs_utxoCacheMempool);\n+    const CTransaction &tx = *ptxn;\n+    for (unsigned int i = 0; i < tx.vout.size(); i++)\n+    {\n+        if (tx.vout[i].IsNull() || tx.vout[i].scriptPubKey.IsUnspendable())\n+            continue;\n+\n+        auto utxoKey = ScriptIndexHash(tx.vout[i].scriptPubKey);\n+        utxoCacheMempool[utxoKey].insert(COutPoint(tx.GetHash(), static_cast<uint32_t>(i)));\n+    }\n+}\n+\n+void UtxoScriptIndex::TransactionRemovedFromMempool(const CTransactionRef &ptx) {\n+    LOCK(cs_utxoCacheMempool);\n+    const CTransaction &tx = *ptx;\n+    for (unsigned int i = 0; i < tx.vout.size(); i++)\n+    {\n+        if (tx.vout[i].IsNull() || tx.vout[i].scriptPubKey.IsUnspendable())\n+            continue;\n+\n+        std::map<ScriptHash, SerializableUtxoSet>::iterator it = utxoCacheMempool.find(ScriptIndexHash(tx.vout[i].scriptPubKey));\n+\n+        if (it != utxoCacheMempool.end())\n+        {\n+            it->second.erase(COutPoint(tx.GetHash(), static_cast<uint32_t>(i)));\n+            if (it->second.empty())\n+                utxoCacheMempool.erase(it);\n+        }\n+    }\n+}\n+\n+void UtxoScriptIndex::BlockConnected(const std::shared_ptr<const CBlock> &block,\n+                                     const CBlockIndex *pindex,\n+                                     const std::shared_ptr<const CBlockUndo> &blockundo,\n+                                     const std::vector<CTransactionRef> &txnConflicted)\n+{\n+    {\n+        LOCK(cs_utxoCache);\n+        removeSpentUtxosOnTipConnected(*block, *blockundo);\n+        addNewUtxosOnTipConnected(*block);\n+    }\n+    WriteBestBlock(block->GetHash());\n+}\n+\n+void UtxoScriptIndex::BlockDisconnected(const std::shared_ptr<const CBlock> &block,\n+                                        const std::shared_ptr<const CBlockUndo> &blockundo) {\n+    assert(block->vtx.size() > 0);\n+    LOCK(cs_utxoCache);\n+    restoreSpentUtxosOnTipDisconnected(*block, *blockundo);\n+    removeUtxosOnTipDisconnected(*block);\n+}\n+\n+BaseIndex::DB& UtxoScriptIndex::GetDB() const { return *m_db; }\n+\n+void UtxoScriptIndex::removeUtxo(const CTxOut& txout, const COutPoint outpoint)\n+{\n+    if(txout.IsNull() || txout.scriptPubKey.IsUnspendable())\n+        return;\n+    const ScriptHash utxoCacheKey = ScriptIndexHash(txout.scriptPubKey);\n+    loadToCache(utxoCacheKey);\n+    if(utxoCache.count(utxoCacheKey) == 0)\n+        return;\n+    SerializableUtxoSet& utxoCacheSet = utxoCache.at(utxoCacheKey);\n+        utxoCacheSet.erase(outpoint);\n+}\n+\n+void UtxoScriptIndex::removeSpentUtxosOnTipConnected(const CBlock& block, const CBlockUndo& blockundo)\n+{\n+\n+    for(unsigned int i = 1; i < block.vtx.size(); ++i)\n+    {\n+        for(unsigned int j = 0; j < (block.vtx[i])->vin.size(); ++j)\n+        {\n+            removeUtxo(blockundo.vtxundo[i-1].vprevout[j].out,\n+                       block.vtx[i]->vin[j].prevout);\n+        }\n+    }\n+}\n+\n+void UtxoScriptIndex::removeUtxosOnTipDisconnected(const CBlock& block)\n+{\n+    if(block.vtx.size() == 0)\n+        return;\n+\n+    unsigned int i = block.vtx.size() - 1;\n+    while(true)",
    "path": "src/index/utxoscriptindex.cpp",
    "position": 218,
    "original_position": 219,
    "commit_id": "34c8e8e7cff4fa79264c510655f2320ac80e1513",
    "original_commit_id": "37562b7e364022b66c073a207aa38428f7d8b4fa",
    "user": {
      "login": "marcinja",
      "id": 12243734,
      "node_id": "MDQ6VXNlcjEyMjQzNzM0",
      "avatar_url": "https://avatars.githubusercontent.com/u/12243734?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/marcinja",
      "html_url": "https://github.com/marcinja",
      "followers_url": "https://api.github.com/users/marcinja/followers",
      "following_url": "https://api.github.com/users/marcinja/following{/other_user}",
      "gists_url": "https://api.github.com/users/marcinja/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/marcinja/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/marcinja/subscriptions",
      "organizations_url": "https://api.github.com/users/marcinja/orgs",
      "repos_url": "https://api.github.com/users/marcinja/repos",
      "events_url": "https://api.github.com/users/marcinja/events{/privacy}",
      "received_events_url": "https://api.github.com/users/marcinja/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This could be a `do{ } while(i  > 0)`",
    "created_at": "2018-08-24T19:09:24Z",
    "updated_at": "2018-11-13T18:49:33Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/14035#discussion_r212727496",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/14035",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212727496"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/14035#discussion_r212727496"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/14035"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212727496/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 218,
    "original_line": 218,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212759261",
    "pull_request_review_id": 149465173,
    "id": 212759261,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDIxMjc1OTI2MQ==",
    "diff_hunk": "@@ -0,0 +1,455 @@\n+// Copyright (c) 2018 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <index/utxoscriptindex.h>\n+#include <util.h>\n+#include <script/standard.h>\n+#include <pubkey.h>\n+#include <txmempool.h>\n+#include <validation.h>\n+#include <txdb.h>\n+#include <ui_interface.h>\n+\n+#include<boost/thread.hpp>\n+\n+\n+std::unique_ptr<UtxoScriptIndex> g_utxoscriptindex;\n+\n+static ScriptHash ScriptIndexHash(const CScript& in){\n+    return Hash160(in.begin(), in.end());\n+}\n+\n+class UtxoScriptIndexDBCursor\n+{\n+public:\n+    UtxoScriptIndexDBCursor(CDBIterator* cursor) : pcursor(cursor){}\n+\n+    bool GetKey(ScriptHash& key);\n+    bool GetValue(SerializableUtxoSet& utxoSet);\n+    unsigned int GetValueSize() const;\n+\n+    bool Valid() const;\n+    void Next();\n+\n+    std::pair<char, ScriptHash> keyTmp;\n+    std::unique_ptr<CDBIterator> pcursor;\n+};\n+\n+class UtxoScriptIndex::DB : public BaseIndex::DB\n+{\n+public:\n+    explicit DB(size_t nCacheSize, bool fMemory = false, bool fWipe = false);\n+\n+    bool WriteUtxos(std::map<ScriptHash, SerializableUtxoSet>& scriptUtxos);\n+    bool ReadUtxos(const ScriptHash&, SerializableUtxoSet& utxoSet);\n+\n+    UtxoScriptIndexDBCursor* Cursor() const;\n+};\n+\n+UtxoScriptIndex::DB::DB(size_t nCacheSize, bool fMemory, bool fWipe) :\n+    BaseIndex::DB(GetDataDir() / \"indexes\" / \"coinsbyscript\", nCacheSize, fMemory, fWipe)\n+{\n+\n+}\n+\n+bool UtxoScriptIndex::DB::WriteUtxos(std::map<ScriptHash, SerializableUtxoSet>& scriptUtxos)\n+{\n+    CDBBatch batch(*this);\n+    for(const auto& scriptUtxo: scriptUtxos)\n+    {\n+        auto key = std::make_pair(DB_UTXO, std::ref(scriptUtxo.first));\n+        auto& value = scriptUtxo.second;\n+        if(scriptUtxo.second.empty())\n+            batch.Erase(key);\n+        else\n+            batch.Write(key,value);\n+    }\n+    return WriteBatch(batch);\n+}\n+\n+bool UtxoScriptIndex::DB::ReadUtxos(const ScriptHash& scriptId, SerializableUtxoSet& utxoSet)\n+{\n+    return Read(std::make_pair(DB_UTXO, scriptId), utxoSet);\n+}\n+\n+UtxoScriptIndexDBCursor* UtxoScriptIndex::DB::Cursor() const\n+{\n+    UtxoScriptIndexDBCursor* cursor = new UtxoScriptIndexDBCursor(\n+                                    const_cast<CDBWrapper*>(\n+                                        static_cast<const CDBWrapper*>(this))->NewIterator());\n+    cursor->pcursor->Seek(DB_UTXO);\n+    if(!(cursor->pcursor->Valid()))\n+        cursor->keyTmp.first = 0;\n+    else\n+        cursor->pcursor->GetKey(cursor->keyTmp);\n+    return cursor;\n+}\n+\n+bool UtxoScriptIndexDBCursor::GetKey(ScriptHash& key)\n+{\n+    if(keyTmp.first == DB_UTXO)\n+    {\n+        key = keyTmp.second;\n+        return true;\n+    }\n+    return false;\n+}\n+\n+bool UtxoScriptIndexDBCursor::GetValue(SerializableUtxoSet& utxoSet)\n+{\n+    return pcursor->GetValue(utxoSet);\n+}\n+\n+bool UtxoScriptIndexDBCursor::Valid() const\n+{\n+    return keyTmp.first == DB_UTXO;\n+}\n+\n+void UtxoScriptIndexDBCursor::Next()\n+{\n+    pcursor->Next();\n+    if(pcursor->Valid() && pcursor->GetKey(keyTmp))\n+        return;\n+    else\n+        keyTmp.first = 0;\n+}\n+\n+UtxoScriptIndex::UtxoScriptIndex(size_t n_cache_size, bool f_memory, bool f_wipe) :\n+    m_db(std::move(MakeUnique<UtxoScriptIndex::DB>(n_cache_size, f_memory, f_wipe)))\n+{\n+\n+}\n+\n+UtxoScriptIndex::~UtxoScriptIndex() {\n+    UnregisterValidationInterface(this);\n+}\n+\n+void UtxoScriptIndex::Start()\n+{\n+    RegisterValidationInterface(this);\n+}\n+\n+void UtxoScriptIndex::TransactionAddedToMempool(const CTransactionRef &ptxn) {\n+    LOCK(cs_utxoCacheMempool);\n+    const CTransaction &tx = *ptxn;\n+    for (unsigned int i = 0; i < tx.vout.size(); i++)\n+    {\n+        if (tx.vout[i].IsNull() || tx.vout[i].scriptPubKey.IsUnspendable())\n+            continue;\n+\n+        auto utxoKey = ScriptIndexHash(tx.vout[i].scriptPubKey);\n+        utxoCacheMempool[utxoKey].insert(COutPoint(tx.GetHash(), static_cast<uint32_t>(i)));\n+    }\n+}\n+\n+void UtxoScriptIndex::TransactionRemovedFromMempool(const CTransactionRef &ptx) {\n+    LOCK(cs_utxoCacheMempool);\n+    const CTransaction &tx = *ptx;\n+    for (unsigned int i = 0; i < tx.vout.size(); i++)\n+    {\n+        if (tx.vout[i].IsNull() || tx.vout[i].scriptPubKey.IsUnspendable())\n+            continue;\n+\n+        std::map<ScriptHash, SerializableUtxoSet>::iterator it = utxoCacheMempool.find(ScriptIndexHash(tx.vout[i].scriptPubKey));\n+\n+        if (it != utxoCacheMempool.end())\n+        {\n+            it->second.erase(COutPoint(tx.GetHash(), static_cast<uint32_t>(i)));\n+            if (it->second.empty())\n+                utxoCacheMempool.erase(it);\n+        }\n+    }\n+}\n+\n+void UtxoScriptIndex::BlockConnected(const std::shared_ptr<const CBlock> &block,\n+                                     const CBlockIndex *pindex,\n+                                     const std::shared_ptr<const CBlockUndo> &blockundo,\n+                                     const std::vector<CTransactionRef> &txnConflicted)\n+{\n+    {\n+        LOCK(cs_utxoCache);\n+        removeSpentUtxosOnTipConnected(*block, *blockundo);\n+        addNewUtxosOnTipConnected(*block);\n+    }\n+    WriteBestBlock(block->GetHash());\n+}\n+\n+void UtxoScriptIndex::BlockDisconnected(const std::shared_ptr<const CBlock> &block,\n+                                        const std::shared_ptr<const CBlockUndo> &blockundo) {\n+    assert(block->vtx.size() > 0);\n+    LOCK(cs_utxoCache);\n+    restoreSpentUtxosOnTipDisconnected(*block, *blockundo);\n+    removeUtxosOnTipDisconnected(*block);\n+}\n+\n+BaseIndex::DB& UtxoScriptIndex::GetDB() const { return *m_db; }\n+\n+void UtxoScriptIndex::removeUtxo(const CTxOut& txout, const COutPoint outpoint)\n+{\n+    if(txout.IsNull() || txout.scriptPubKey.IsUnspendable())\n+        return;\n+    const ScriptHash utxoCacheKey = ScriptIndexHash(txout.scriptPubKey);\n+    loadToCache(utxoCacheKey);\n+    if(utxoCache.count(utxoCacheKey) == 0)\n+        return;\n+    SerializableUtxoSet& utxoCacheSet = utxoCache.at(utxoCacheKey);\n+        utxoCacheSet.erase(outpoint);\n+}\n+\n+void UtxoScriptIndex::removeSpentUtxosOnTipConnected(const CBlock& block, const CBlockUndo& blockundo)\n+{\n+\n+    for(unsigned int i = 1; i < block.vtx.size(); ++i)\n+    {\n+        for(unsigned int j = 0; j < (block.vtx[i])->vin.size(); ++j)\n+        {\n+            removeUtxo(blockundo.vtxundo[i-1].vprevout[j].out,\n+                       block.vtx[i]->vin[j].prevout);\n+        }\n+    }\n+}\n+\n+void UtxoScriptIndex::removeUtxosOnTipDisconnected(const CBlock& block)\n+{\n+    if(block.vtx.size() == 0)\n+        return;\n+\n+    unsigned int i = block.vtx.size() - 1;\n+    while(true)",
    "path": "src/index/utxoscriptindex.cpp",
    "position": 218,
    "original_position": 219,
    "commit_id": "34c8e8e7cff4fa79264c510655f2320ac80e1513",
    "original_commit_id": "37562b7e364022b66c073a207aa38428f7d8b4fa",
    "user": {
      "login": "mgrychow",
      "id": 42271287,
      "node_id": "MDQ6VXNlcjQyMjcxMjg3",
      "avatar_url": "https://avatars.githubusercontent.com/u/42271287?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mgrychow",
      "html_url": "https://github.com/mgrychow",
      "followers_url": "https://api.github.com/users/mgrychow/followers",
      "following_url": "https://api.github.com/users/mgrychow/following{/other_user}",
      "gists_url": "https://api.github.com/users/mgrychow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mgrychow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mgrychow/subscriptions",
      "organizations_url": "https://api.github.com/users/mgrychow/orgs",
      "repos_url": "https://api.github.com/users/mgrychow/repos",
      "events_url": "https://api.github.com/users/mgrychow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mgrychow/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Loop needs to execute for `i==0` too (that is block's tx with index 0); `i` is unsigned so after decrementation it overflows and such loop would be indefinite",
    "created_at": "2018-08-24T21:25:52Z",
    "updated_at": "2018-11-13T18:49:33Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/14035#discussion_r212759261",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/14035",
    "author_association": "NONE",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212759261"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/14035#discussion_r212759261"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/14035"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/212759261/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 218,
    "original_line": 218,
    "side": "RIGHT",
    "in_reply_to_id": 212727496
  }
]