[
  {
    "sha": "22e780737db57bcb18b3824eb8158e19a4775cb6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyMmU3ODA3MzdkYjU3YmNiMThiMzgyNGViODE1OGUxOWE0Nzc1Y2I2",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2015-11-04T23:16:49Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2015-11-04T23:43:49Z"
      },
      "message": "Always flush block and undo when switching to new file\n\nPreviously, the undo weren't being flushed during a reindex because\nfKnown was set to true in FindBlockPos. That is the correct behaviour\nfor block files as they aren't being touched, but undo files are\ntouched.\n\nThis changes the behaviour to always flush when switching to a new file\n(even for block files, though that isn't really necessary).",
      "tree": {
        "sha": "56969bf36db75eb79d9fb33c3eea6bb5ae2822ff",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/56969bf36db75eb79d9fb33c3eea6bb5ae2822ff"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/22e780737db57bcb18b3824eb8158e19a4775cb6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/22e780737db57bcb18b3824eb8158e19a4775cb6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/22e780737db57bcb18b3824eb8158e19a4775cb6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/22e780737db57bcb18b3824eb8158e19a4775cb6/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "193f7b553e0ad41e6579adbce867ef14866034b0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/193f7b553e0ad41e6579adbce867ef14866034b0",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/193f7b553e0ad41e6579adbce867ef14866034b0"
      }
    ],
    "stats": {
      "total": 11,
      "additions": 8,
      "deletions": 3
    },
    "files": [
      {
        "sha": "a2a5e0b729ede7dd33aff7f1e770067a3501ef99",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 3,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/22e780737db57bcb18b3824eb8158e19a4775cb6/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/22e780737db57bcb18b3824eb8158e19a4775cb6/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=22e780737db57bcb18b3824eb8158e19a4775cb6",
        "patch": "@@ -2517,8 +2517,6 @@ bool FindBlockPos(CValidationState &state, CDiskBlockPos &pos, unsigned int nAdd\n \n     if (!fKnown) {\n         while (vinfoBlockFile[nFile].nSize + nAddSize >= MAX_BLOCKFILE_SIZE) {\n-            LogPrintf(\"Leaving block file %i: %s\\n\", nFile, vinfoBlockFile[nFile].ToString());\n-            FlushBlockFile(true);\n             nFile++;\n             if (vinfoBlockFile.size() <= nFile) {\n                 vinfoBlockFile.resize(nFile + 1);\n@@ -2528,7 +2526,14 @@ bool FindBlockPos(CValidationState &state, CDiskBlockPos &pos, unsigned int nAdd\n         pos.nPos = vinfoBlockFile[nFile].nSize;\n     }\n \n-    nLastBlockFile = nFile;\n+    if (nFile != nLastBlockFile) {\n+        if (!fKnown) {\n+            LogPrintf(\"Leaving block file %i: %s\\n\", nFile, vinfoBlockFile[nFile].ToString());\n+        }\n+        FlushBlockFile(!fKnown);\n+        nLastBlockFile = nFile;\n+    }\n+\n     vinfoBlockFile[nFile].AddBlock(nHeight, nTime);\n     if (fKnown)\n         vinfoBlockFile[nFile].nSize = std::max(pos.nPos + nAddSize, vinfoBlockFile[nFile].nSize);"
      }
    ]
  }
]