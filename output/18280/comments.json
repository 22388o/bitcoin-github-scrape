[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/596037394",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#issuecomment-596037394",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18280",
    "id": 596037394,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5NjAzNzM5NA==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-07T02:44:51Z",
    "updated_at": "2020-03-13T04:07:05Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #18338 (wip: Fix wallet unload race condition by promag)\n* #18279 (Ensure wallet and chain tip are in sync by bvbfan)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/596037394/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597150670",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#issuecomment-597150670",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18280",
    "id": 597150670,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5NzE1MDY3MA==",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-10T15:30:55Z",
    "updated_at": "2020-03-10T15:30:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Alternative to #18279. Similar to #15700. More details in #18065. Possibly fixes #16307.\r\n\r\nAbout to look into this but this PR description seems like it is going to take a lot of digging to understand.\r\n\r\nIs it possible to summarize in a paragraph what this change is doing, what problem it fixes, and how it compares to the alternative? Thank you! :pray:",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597150670/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597176774",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#issuecomment-597176774",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18280",
    "id": 597176774,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5NzE3Njc3NA==",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?u=4a9af998e1a560b3f49c3827f453e1bcbe6a5cfb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-10T16:18:25Z",
    "updated_at": "2020-03-10T16:18:25Z",
    "author_association": "MEMBER",
    "body": "Sorry @ryanofsky, should have tagged wip. Will address your comments and address each required change once this is good. Thanks for reviewing and your comments - will also revisit #15719.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597176774/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597299563",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#issuecomment-597299563",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18280",
    "id": 597299563,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5NzI5OTU2Mw==",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?u=4a9af998e1a560b3f49c3827f453e1bcbe6a5cfb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-10T20:31:07Z",
    "updated_at": "2020-03-10T20:31:07Z",
    "author_association": "MEMBER",
    "body": "Updated OP. Reduced the scope to just fix #16307. Will submit other PRs with relevant changes from previous commits.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597299563/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597693595",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#issuecomment-597693595",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18280",
    "id": 597693595,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5NzY5MzU5NQ==",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?u=4a9af998e1a560b3f49c3827f453e1bcbe6a5cfb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-11T15:16:48Z",
    "updated_at": "2020-03-11T15:16:48Z",
    "author_association": "MEMBER",
    "body": "Updated to include dc62f3ce5228a611d973a154eb338e1fd34df38f which ensures that `SyncWithValidationInterfaceQueue` doesn't hang due to `!AreThreadsServicingQueue`.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/597693595/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/598613080",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#issuecomment-598613080",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18280",
    "id": 598613080,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU5ODYxMzA4MA==",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?u=4a9af998e1a560b3f49c3827f453e1bcbe6a5cfb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-03-13T08:46:31Z",
    "updated_at": "2020-03-13T08:46:31Z",
    "author_association": "MEMBER",
    "body": "Replaced by #18338.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/598613080/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388959593",
    "pull_request_review_id": 370395362,
    "id": 388959593,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk1OTU5Mw==",
    "diff_hunk": "@@ -88,9 +88,11 @@ void RegisterValidationInterface(CValidationInterface* pwalletIn) {\n }\n \n void UnregisterValidationInterface(CValidationInterface* pwalletIn) {\n-    if (g_signals.m_internals) {\n-        g_signals.m_internals->m_connMainSignals.erase(pwalletIn);\n-    }\n+    AssertLockNotHeld(cs_main);\n+    std::promise<void> promise;",
    "path": "src/validationinterface.cpp",
    "position": null,
    "original_position": 8,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "ce46396cf7ceac4d39a1bcef560904ee1b1dd6dc",
    "user": {
      "login": "bvbfan",
      "id": 8323581,
      "node_id": "MDQ6VXNlcjgzMjM1ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bvbfan",
      "html_url": "https://github.com/bvbfan",
      "followers_url": "https://api.github.com/users/bvbfan/followers",
      "following_url": "https://api.github.com/users/bvbfan/following{/other_user}",
      "gists_url": "https://api.github.com/users/bvbfan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
      "organizations_url": "https://api.github.com/users/bvbfan/orgs",
      "repos_url": "https://api.github.com/users/bvbfan/repos",
      "events_url": "https://api.github.com/users/bvbfan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bvbfan/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "You don't need make promise or calls function if `g_signals.m_internals` is nullptr.",
    "created_at": "2020-03-06T15:13:32Z",
    "updated_at": "2020-03-11T19:07:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r388959593",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388959593"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r388959593"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388959593/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 99,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388972769",
    "pull_request_review_id": 370413382,
    "id": 388972769,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk3Mjc2OQ==",
    "diff_hunk": "@@ -88,9 +88,11 @@ void RegisterValidationInterface(CValidationInterface* pwalletIn) {\n }\n \n void UnregisterValidationInterface(CValidationInterface* pwalletIn) {\n-    if (g_signals.m_internals) {\n-        g_signals.m_internals->m_connMainSignals.erase(pwalletIn);\n-    }\n+    AssertLockNotHeld(cs_main);\n+    std::promise<void> promise;",
    "path": "src/validationinterface.cpp",
    "position": null,
    "original_position": 8,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "ce46396cf7ceac4d39a1bcef560904ee1b1dd6dc",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done.",
    "created_at": "2020-03-06T15:34:55Z",
    "updated_at": "2020-03-11T19:07:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r388972769",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388972769"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r388972769"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/388972769/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 99,
    "side": "RIGHT",
    "in_reply_to_id": 388959593
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390406472",
    "pull_request_review_id": 372069303,
    "id": 390406472,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQwNjQ3Mg==",
    "diff_hunk": "@@ -3975,14 +3985,6 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n     // Register with the validation interface. It's ok to do this after rescan since we're still holding locked_chain.",
    "path": "src/wallet/wallet.cpp",
    "position": null,
    "original_position": 25,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "afe8d39bdc27cfd0f4b3b61cc7cf1f0cf5df7b1b",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This comment is no longer true, and seems like it means there can now be missing notifications. I wonder if a different approach would be to send the loadwallet notification before locking the chain & scanning instead of after?",
    "created_at": "2020-03-10T15:35:13Z",
    "updated_at": "2020-03-11T19:07:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r390406472",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390406472"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r390406472"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/390406472/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 4097,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391120925",
    "pull_request_review_id": 372950012,
    "id": 391120925,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEyMDkyNQ==",
    "diff_hunk": "@@ -148,6 +148,10 @@ bool CScheduler::AreThreadsServicingQueue() const {\n \n \n void SingleThreadedSchedulerClient::MaybeScheduleProcessQueue() {\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {\n+        EmptyQueue();\n+        return;\n+    }",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 7,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "dc62f3ce5228a611d973a154eb338e1fd34df38f",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Handle no threads serving in MaybeScheduleProcessQueue\" (dc62f3ce5228a611d973a154eb338e1fd34df38f)\r\n\r\nI think it would make more sense to add this logic at the bottom of `AddToProcessQueue` (and avoid calling `MaybeScheduleProcessQueue` in no thread case) than having it at the top of `MaybeScheduleProcessQueue` and returning early.\r\n\r\nFew reasons:\r\n\r\n- Having this logic doesn't seem useful in ProcessQueue, the other place where MaybeScheduleProcessQueue is called\r\n- Adding this code here creates recursion ProcessQueue -> MaybeScheduleProcessQueue -> EmptyQueue -> ProcessQueue\r\n- If code is added here the name `MaybeScheduleProcessQueue` is now misleading because this is running callbacks immediately, not scheduling them for later",
    "created_at": "2020-03-11T16:58:32Z",
    "updated_at": "2020-03-11T19:07:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391120925",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391120925"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391120925"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391120925/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 150,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 154,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391148440",
    "pull_request_review_id": 372983242,
    "id": 391148440,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE0ODQ0MA==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {\n+        EmptyQueue();",
    "path": "src/scheduler.cpp",
    "position": 8,
    "original_position": 5,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Handle no threads serving in MaybeScheduleProcessQueue\" (201eebf13b2723d7fe821d7222600fa04fadc0b0)\r\n\r\nCommit message subject is out of date since `MaybeScheduleProcessQueue` is no longer changing.\r\n\r\nAlso I'm surprised by \"SyncWithValidationInterfaceQueue is called after\r\nscheduler thread exists, which happen at shutdown\" since I would hope wallets are getting unloaded before the scheduler stops, but maybe this is not the case currently. Probably beyond the scope of this PR to address, though\r\n",
    "created_at": "2020-03-11T17:39:21Z",
    "updated_at": "2020-03-11T19:07:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391148440",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391148440"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391148440"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391148440/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 201,
    "original_line": 201,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391151878",
    "pull_request_review_id": 372983242,
    "id": 391151878,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE1MTg3OA==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Handle no threads serving in MaybeScheduleProcessQueue\" (201eebf13b2723d7fe821d7222600fa04fadc0b0)\r\n\r\nIf we can make this code:\r\n\r\n```c++\r\nif (m_pscheduler->AreThreadsServicingQueue()) [\r\n    MaybeScheduleProcessQueue();\r\n} else {\r\n    EmptyQueue();\r\n}\r\n```\r\n\r\nit would be more obvious what's going on here.\r\n\r\nOtherwise if the unconditional `MaybeScheduleProcessQueue` call is needed it would be good have a comment saying what it's needed for.\r\n\r\n",
    "created_at": "2020-03-11T17:44:39Z",
    "updated_at": "2020-03-11T19:07:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391151878",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391151878"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391151878"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391151878/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391175327",
    "pull_request_review_id": 373016278,
    "id": 391175327,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE3NTMyNw==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "bvbfan",
      "id": 8323581,
      "node_id": "MDQ6VXNlcjgzMjM1ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bvbfan",
      "html_url": "https://github.com/bvbfan",
      "followers_url": "https://api.github.com/users/bvbfan/followers",
      "following_url": "https://api.github.com/users/bvbfan/following{/other_user}",
      "gists_url": "https://api.github.com/users/bvbfan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
      "organizations_url": "https://api.github.com/users/bvbfan/orgs",
      "repos_url": "https://api.github.com/users/bvbfan/repos",
      "events_url": "https://api.github.com/users/bvbfan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bvbfan/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Should it be inside `EmptyQueue`",
    "created_at": "2020-03-11T18:23:12Z",
    "updated_at": "2020-03-11T19:07:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391175327",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391175327"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391175327"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391175327/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT",
    "in_reply_to_id": 391151878
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391198452",
    "pull_request_review_id": 373045406,
    "id": 391198452,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE5ODQ1Mg==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> Should it be inside `EmptyQueue`\r\n\r\nI wouldn't change emptyqueue because it's called other places which don't need this logic, and I can't see how the behavior would fit in there (how you could coherently describe it or change the emptyqueue name to reflect it)",
    "created_at": "2020-03-11T19:04:53Z",
    "updated_at": "2020-03-11T19:07:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391198452",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391198452"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391198452"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391198452/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT",
    "in_reply_to_id": 391151878
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391210613",
    "pull_request_review_id": 373060627,
    "id": 391210613,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTIxMDYxMw==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Changed. However if the scheduler thread is stopped after `AreThreadsServicingQueue` then the function won't be called right?",
    "created_at": "2020-03-11T19:28:39Z",
    "updated_at": "2020-03-11T19:28:40Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391210613",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391210613"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391210613"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391210613/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT",
    "in_reply_to_id": 391151878
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391422843",
    "pull_request_review_id": 373304317,
    "id": 391422843,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQyMjg0Mw==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "bvbfan",
      "id": 8323581,
      "node_id": "MDQ6VXNlcjgzMjM1ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bvbfan",
      "html_url": "https://github.com/bvbfan",
      "followers_url": "https://api.github.com/users/bvbfan/followers",
      "following_url": "https://api.github.com/users/bvbfan/following{/other_user}",
      "gists_url": "https://api.github.com/users/bvbfan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
      "organizations_url": "https://api.github.com/users/bvbfan/orgs",
      "repos_url": "https://api.github.com/users/bvbfan/repos",
      "events_url": "https://api.github.com/users/bvbfan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bvbfan/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Test wallet_multiwallet fails due to this code path, see my changes in EmptyQueue, you should schedule process queue when event queue is not empty, the logic is reversed there.",
    "created_at": "2020-03-12T06:28:39Z",
    "updated_at": "2020-03-12T06:28:40Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391422843",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391422843"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391422843"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391422843/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT",
    "in_reply_to_id": 391151878
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391678408",
    "pull_request_review_id": 373629891,
    "id": 391678408,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY3ODQwOA==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "bvbfan",
      "id": 8323581,
      "node_id": "MDQ6VXNlcjgzMjM1ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bvbfan",
      "html_url": "https://github.com/bvbfan",
      "followers_url": "https://api.github.com/users/bvbfan/followers",
      "following_url": "https://api.github.com/users/bvbfan/following{/other_user}",
      "gists_url": "https://api.github.com/users/bvbfan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
      "organizations_url": "https://api.github.com/users/bvbfan/orgs",
      "repos_url": "https://api.github.com/users/bvbfan/repos",
      "events_url": "https://api.github.com/users/bvbfan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bvbfan/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> I wouldn't change emptyqueue because it's called other places\r\n\r\nWhere? It's called in `FlushBackgroundCallbacks` only in init.cpp i'm pretty sure it will not affect anything wrong.",
    "created_at": "2020-03-12T14:55:44Z",
    "updated_at": "2020-03-12T14:55:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391678408",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391678408"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391678408"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391678408/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT",
    "in_reply_to_id": 391151878
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391690701",
    "pull_request_review_id": 373645824,
    "id": 391690701,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY5MDcwMQ==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> > I wouldn't change emptyqueue because it's called other places\r\n> \r\n> Where? It's called in `FlushBackgroundCallbacks` only in init.cpp i'm pretty sure it will not affect anything wrong.\r\n\r\nNot saying it's wrong, saying I don't understand how it makes sense for what how the EmptyQueue function is named, or what it currently does, or how it's called other places.\r\n\r\nMaybe your suggestion to change EmptyQueue to schedule tasks instead of running them on the current thread is good, but it doesn't make sense to me right now, and since no rationale was given and I can't read your mind, I'm saying I wouldn't change it here.",
    "created_at": "2020-03-12T15:12:59Z",
    "updated_at": "2020-03-12T15:13:00Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391690701",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391690701"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391690701"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391690701/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT",
    "in_reply_to_id": 391151878
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391693024",
    "pull_request_review_id": 373648848,
    "id": 391693024,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY5MzAyNA==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {\n+        EmptyQueue();",
    "path": "src/scheduler.cpp",
    "position": 8,
    "original_position": 5,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> since I would hope wallets are getting unloaded before the scheduler stops\r\n\r\nNot currently the case.\r\n\r\n> Probably beyond the scope of this PR to address, though\r\n\r\nAgree, I've tried and it caused some other failures.\r\n\r\n> Commit message subject is out of date since MaybeScheduleProcessQueue is no longer changing.\r\n\r\nOps need to update.",
    "created_at": "2020-03-12T15:16:20Z",
    "updated_at": "2020-03-12T15:16:20Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391693024",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391693024"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391693024"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391693024/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 201,
    "original_line": 201,
    "side": "RIGHT",
    "in_reply_to_id": 391148440
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391706163",
    "pull_request_review_id": 373666522,
    "id": 391706163,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwNjE2Mw==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> Test wallet_multiwallet fails due to this code path, see my changes in EmptyQueue, you should schedule process queue when event queue is not empty, the logic is reversed there.\r\n\r\nwallet_multiwallet.py is failing on appveyor with \"'unloadwallet' RPC took longer than 60.000000 seconds. Consider using larger timeout for calls that take longer to return. (-344)\"\r\n\r\nhttps://ci.appveyor.com/project/DrahtBot/bitcoin/builds/31405838\r\n\r\nSo it looks like there is a problem with the current implementation. But I don't understand the comment about EmptyQueue or logic being reversed",
    "created_at": "2020-03-12T15:35:49Z",
    "updated_at": "2020-03-12T15:35:50Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391706163",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391706163"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391706163"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391706163/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT",
    "in_reply_to_id": 391151878
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391706553",
    "pull_request_review_id": 373667040,
    "id": 391706553,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwNjU1Mw==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "bvbfan",
      "id": 8323581,
      "node_id": "MDQ6VXNlcjgzMjM1ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bvbfan",
      "html_url": "https://github.com/bvbfan",
      "followers_url": "https://api.github.com/users/bvbfan/followers",
      "following_url": "https://api.github.com/users/bvbfan/following{/other_user}",
      "gists_url": "https://api.github.com/users/bvbfan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
      "organizations_url": "https://api.github.com/users/bvbfan/orgs",
      "repos_url": "https://api.github.com/users/bvbfan/repos",
      "events_url": "https://api.github.com/users/bvbfan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bvbfan/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "It makes much more sense compare to current version\r\n```\r\nvoid SingleThreadedSchedulerClient::EmptyQueue() {\r\n    if (!m_pscheduler->AreThreadsServicingQueue())\r\n        return;\r\n    auto pendingCallbacks = [this]() -> bool {\r\n        LOCK(m_cs_callbacks_pending);\r\n        return !m_callbacks_pending.empty();\r\n    };\r\n    bool should_continue = pendingCallbacks();\r\n    while (should_continue) {\r\n        ProcessQueue();\r\n        should_continue = pendingCallbacks();\r\n    }\r\n}\r\n```\r\n1. You don't need to do stupid things, like here one,\r\n`if (!m_pscheduler->AreThreadsServicingQueue())`\r\n2. You don't need to check against is there pending callbacks it's done there, so if you don't have pending ones you don't need to enter eventually endless waiting. ",
    "created_at": "2020-03-12T15:36:28Z",
    "updated_at": "2020-03-12T15:36:28Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391706553",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391706553"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391706553"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391706553/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT",
    "in_reply_to_id": 391151878
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391709067",
    "pull_request_review_id": 373670392,
    "id": 391709067,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwOTA2Nw==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Iv'e been trying to reproduce appveyor error wihtout any luck.",
    "created_at": "2020-03-12T15:40:17Z",
    "updated_at": "2020-03-12T15:40:17Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391709067",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391709067"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391709067"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391709067/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT",
    "in_reply_to_id": 391151878
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391725203",
    "pull_request_review_id": 373691637,
    "id": 391725203,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcyNTIwMw==",
    "diff_hunk": "@@ -195,7 +195,11 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         LOCK(m_cs_callbacks_pending);\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n-    MaybeScheduleProcessQueue();\n+    if (m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": 5,
    "original_position": 5,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "03cd591f47f852e0a2c2e6262367eff4acefca62",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Handle no threads serving in MaybeScheduleProcessQueue\" (03cd591f47f852e0a2c2e6262367eff4acefca62)\r\n\r\nWas experimenting and wrote a small test for this change:\r\n\r\n```c++\r\n// Ensure scheduled tasks run even when there are no scheduler threads\r\nBOOST_AUTO_TEST_CASE(singlethreadedscheduler_nothreads)\r\n{\r\n    CScheduler scheduler;\r\n    SingleThreadedSchedulerClient client(&scheduler);\r\n    bool task_ran = false;\r\n    client.AddToProcessQueue([&] { task_ran = true; });\r\n    BOOST_CHECK(task_ran);\r\n}\r\n```\r\n\r\nCould add this to scheduler_tests.cpp. It fails without this commit and passes with it.",
    "created_at": "2020-03-12T16:04:15Z",
    "updated_at": "2020-03-12T16:04:15Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391725203",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391725203"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391725203"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391725203/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 198,
    "original_line": 198,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391771779",
    "pull_request_review_id": 373750724,
    "id": 391771779,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc3MTc3OQ==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> 1. You don't need to do stupid things, like here one,\r\n>    `if (!m_pscheduler->AreThreadsServicingQueue())`\r\n> 2. You don't need to check against is there pending callbacks it's done there, so if you don't have pending ones you don't need to enter eventually endless waiting.\r\n\r\n@bvbfan, I'm confused by what you are saying here. You seem to be saying you don't need two things, but your code sample is doing both those things. Are you saying that for some reason it is better to do (1) in `EmptyQueue` instead of `AddToProcessQueue`? If so, what is the reason you think this? To me it seems better to do (1) in `AddToProcessQueue` instead of  `EmptyQueue`, because `AddToProcessQueue` has to be aware of thread state while `EmptyQueue` does not.\r\n\r\nI'm even more confused what you are saying about (2) because you're saying we don't need a check for pending callbacks but your code is actually adding an extra check (before the first loop iteration).\r\n\r\nMore importantly, I can't figure out what this suggestion has to do with wallet_multiwallet.py. If you can clarify, it would be much appreciated. I've also been trying to reproduce the failure there and look for possible causes and haven't been able to figure it out.",
    "created_at": "2020-03-12T17:16:50Z",
    "updated_at": "2020-03-12T17:17:21Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391771779",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391771779"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391771779"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391771779/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT",
    "in_reply_to_id": 391151878
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391795447",
    "pull_request_review_id": 373780016,
    "id": 391795447,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc5NTQ0Nw==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "bvbfan",
      "id": 8323581,
      "node_id": "MDQ6VXNlcjgzMjM1ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8323581?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bvbfan",
      "html_url": "https://github.com/bvbfan",
      "followers_url": "https://api.github.com/users/bvbfan/followers",
      "following_url": "https://api.github.com/users/bvbfan/following{/other_user}",
      "gists_url": "https://api.github.com/users/bvbfan/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bvbfan/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bvbfan/subscriptions",
      "organizations_url": "https://api.github.com/users/bvbfan/orgs",
      "repos_url": "https://api.github.com/users/bvbfan/repos",
      "events_url": "https://api.github.com/users/bvbfan/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bvbfan/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": ">  I'm confused by what you are saying here. You seem to be saying you don't need two things, but your code sample is doing both those things. \r\n\r\nI mean you don't need to do these things outside else, i was not clear. These 2 things should be done here in `EmptyQueue`\r\n\r\n> More importantly, I can't figure out what this suggestion has to do with wallet_multiwallet.py\r\n\r\n```\r\nif (m_pscheduler->AreThreadsServicingQueue()) [\r\n    MaybeScheduleProcessQueue();\r\n} else {\r\n    EmptyQueue();\r\n}\r\n```\r\nThis code is wrong, you try to process / flush events but it does not do that. Let analyse current code\r\n ```\r\nvoid SingleThreadedSchedulerClient::EmptyQueue() {\r\nassert(!m_pscheduler->AreThreadsServicingQueue()); // <- assert (you can avoid that)\r\n    bool should_continue = true;\r\n    while (should_continue) {\r\n        ProcessQueue(); // <--- here is the bigger mistake, it tries to process events before it's checked that has pending callbacks, you can enter this and wait to infinity (since app is shutting down) it should be checked for pendings before process queue\r\n        LOCK(m_cs_callbacks_pending);\r\n        should_continue = !m_callbacks_pending.empty();\r\n    }\r\n```",
    "created_at": "2020-03-12T17:56:15Z",
    "updated_at": "2020-03-12T17:56:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391795447",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391795447"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391795447"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391795447/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT",
    "in_reply_to_id": 391151878
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391814619",
    "pull_request_review_id": 373804479,
    "id": 391814619,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgxNDYxOQ==",
    "diff_hunk": "@@ -196,6 +196,9 @@ void SingleThreadedSchedulerClient::AddToProcessQueue(std::function<void ()> fun\n         m_callbacks_pending.emplace_back(std::move(func));\n     }\n     MaybeScheduleProcessQueue();\n+    if (!m_pscheduler->AreThreadsServicingQueue()) {",
    "path": "src/scheduler.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "2097e35a635cd58bfc21e8ab149a903d58e94bf2",
    "original_commit_id": "201eebf13b2723d7fe821d7222600fa04fadc0b0",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> ```\r\n>        ProcessQueue(); // <--- here is the bigger mistake, it tries to process events before it's checked that has pending callbacks, you can enter this and wait to infinity (since app is shutting down) it should be checked for pendings before process queue\r\n> ```\r\n\r\nExplain this more? `ProcessQueue` doesn't wait for callbacks if there aren't any, it just runs a  callbacks if there is one.\r\n\r\n> Iv'e been trying to reproduce appveyor error wihtout any luck.\r\n\r\nI finally reproduced the problem cutting down the test and running in a loop with --usecli. Looking at the stack trace I see `unloadwallet` RPC thread waiting for scheduler thread `MaybeCompactWalletDB` call, which is stuck in `ReleaseWallet` calling `SyncWithValidationInterfaceQueue`, which is stuck because `SyncWithValidationInterfaceQueue` will always hang if called from the scheduler thread. This is basically the same deadlock that was in fanquake's backtrace from https://github.com/bitcoin/bitcoin/issues/16307#issuecomment-597669986, which suggests that 2a42fc1bdb393f88d72ec4d5c93b43b2b86dcc91 and 2097e35a635cd58bfc21e8ab149a903d58e94bf2 aren't going to work as fixes for this problem   in their current form. Maybe more can be done to get them working but an alternate approach like 06d2b530e57b88c0542e2bd8db00ca0b034b589d ([branch](https://github.com/ryanofsky/bitcoin/commits/pr/notify-shared), [comment](https://github.com/bitcoin/bitcoin/issues/16307#issuecomment-597302227)) might be easier at this point",
    "created_at": "2020-03-12T18:31:29Z",
    "updated_at": "2020-03-12T18:31:29Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391814619",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391814619"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/18280#discussion_r391814619"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18280"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/391814619/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 199,
    "side": "RIGHT",
    "in_reply_to_id": 391151878
  }
]