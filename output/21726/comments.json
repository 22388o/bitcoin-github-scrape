[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822147133",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-822147133",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 822147133,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyMjE0NzEzMw==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-19T03:52:24Z",
    "updated_at": "2021-11-13T15:38:58Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23497](https://github.com/bitcoin/bitcoin/pull/23497) (Add `src/node/` and `src/wallet/` code to `node::` and `wallet::` namespaces by ryanofsky)\n* [#23474](https://github.com/bitcoin/bitcoin/pull/23474) (test: scripted-diff cleanups after generate* changes by MarcoFalke)\n* [#23365](https://github.com/bitcoin/bitcoin/pull/23365) (index: Fix backwards search for bestblock by mzumsande)\n* [#22485](https://github.com/bitcoin/bitcoin/pull/22485) (index: doc/log BaseIndex sync behavior with empty datadir by jamesob)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/822147133/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/842538559",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-842538559",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 842538559,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0MjUzODU1OQ==",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?u=13b19d1ff2f5f914e180c41418f451a4ba6f8bd1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-17T18:27:31Z",
    "updated_at": "2021-05-17T18:27:31Z",
    "author_association": "MEMBER",
    "body": "Concept ACK, I think this is an elegant approach.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/842538559/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 1,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/849190916",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-849190916",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 849190916,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg0OTE5MDkxNg==",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?u=348c27f90b6fff8fd72fa27232272651436a2ff0&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-05-26T23:41:04Z",
    "updated_at": "2021-05-26T23:41:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "Addressed comments by @promag , thank you!\r\n\r\nI also fixed a comment I had overlooked and added a new commit at the end because I realized that we can skip the pruning stuff in `index/base` if the node is not actually pruning. With the new behavior especially this prevents locking `cs_main`. Happy to squash this but I am still checking that this is 100% safe and want to make sure it is looked at separately because it was not included in the existing concept acks.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/849190916/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/852550603",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-852550603",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 852550603,
    "node_id": "MDEyOklzc3VlQ29tbWVudDg1MjU1MDYwMw==",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?u=348c27f90b6fff8fd72fa27232272651436a2ff0&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-06-01T23:17:54Z",
    "updated_at": "2021-06-01T23:17:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "> How about keeping some blocks before the deepest prune blocker?\r\n\r\nInteresting. That should help make it a bit more robust. I added this but set it pretty low for now (10), looking for feedback if it should be higher. I also encapsulated the logic for getting the deepest prune height into it's own function to not have more logic in `FlushStateToDisk`.\r\n\r\nAlso rebased.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/852550603/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/883275390",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-883275390",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 883275390,
    "node_id": "IC_kwDOABII5840pbZ-",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-20T10:15:33Z",
    "updated_at": "2021-07-20T10:15:33Z",
    "author_association": "MEMBER",
    "body": "Nudge to update.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/883275390/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/883447438",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-883447438",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 883447438,
    "node_id": "IC_kwDOABII5840qFaO",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?u=0691974eedcc2ab5366cc1080fb1c030e87244c2&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-20T14:38:47Z",
    "updated_at": "2021-07-20T14:38:47Z",
    "author_association": "MEMBER",
    "body": "Removed from high-prio for now due to inactivity, but can be added back",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/883447438/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/913247703",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-913247703",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 913247703,
    "node_id": "IC_kwDOABII5842bw3X",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?u=348c27f90b6fff8fd72fa27232272651436a2ff0&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-05T23:38:33Z",
    "updated_at": "2021-09-05T23:38:33Z",
    "author_association": "CONTRIBUTOR",
    "body": "Sorry for the long wait, I should have addressed all the feedback for now and also optimized the test a bit further.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/913247703/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/914368128",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-914368128",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 914368128,
    "node_id": "IC_kwDOABII5842gCaA",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-07T14:46:41Z",
    "updated_at": "2021-09-07T14:50:55Z",
    "author_association": "CONTRIBUTOR",
    "body": "> Sorry for the long wait, I should have addressed all the feedback for now and also optimized the test a bit further.\r\n\r\nThanks for updating this! I want to review it more soon, and it would be great to have feedback also from @jamesob because I think there is or could be some interaction between this and https://github.com/bitcoin/bitcoin/pull/15606#pullrequestreview-692965905:\r\n\r\n>* More straightforward approach to pruning. Instead of having to write special case pruning logic, this could be integrated with [Improve Indices on pruned nodes via prune blockers #21726](https://github.com/bitcoin/bitcoin/pull/21726), and each chainstate could just add to a list of prune blockers (ranges of blocks not allowed to be pruned) and pruning code would not need to be aware of assumeutxo states.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/914368128/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/914391121",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-914391121",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 914391121,
    "node_id": "IC_kwDOABII5842gIBR",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-07T15:09:00Z",
    "updated_at": "2021-09-07T15:09:00Z",
    "author_association": "MEMBER",
    "body": "> it would be great to have feedback also from @jamesob\r\n\r\nYep, will plan to review this in the next few days.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/914391121/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/930617542",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-930617542",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 930617542,
    "node_id": "IC_kwDOABII5843eBjG",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?u=348c27f90b6fff8fd72fa27232272651436a2ff0&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-29T23:23:23Z",
    "updated_at": "2021-09-29T23:23:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rebased and addressed @ryanofsky 's comments. Thanks for reviewing!",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/930617542/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/933016580",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-933016580",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 933016580,
    "node_id": "IC_kwDOABII5843nLQE",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?u=348c27f90b6fff8fd72fa27232272651436a2ff0&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-03T20:04:09Z",
    "updated_at": "2021-10-03T20:04:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rebased and beefed up the wait time one last block sync that caused a CI failure previously. I think it was a normal timeout because I could not reproduce it locally and there are a lot of blocks being produced. Comparable tests in terms of number of blocks also use longer sync times.\r\n\r\nI kindly ask other reviewers to weigh in on @ryanofsky 's feedback here if you have a preference: https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715059159",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/933016580/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/934744129",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-934744129",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 934744129,
    "node_id": "IC_kwDOABII5843txBB",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-05T19:59:39Z",
    "updated_at": "2021-10-05T19:59:39Z",
    "author_association": "MEMBER",
    "body": "Concept ACK, will have a look.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/934744129/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/965570260",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-965570260",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 965570260,
    "node_id": "IC_kwDOABII5845jW7U",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?u=0691974eedcc2ab5366cc1080fb1c030e87244c2&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-10T17:26:31Z",
    "updated_at": "2021-11-10T17:26:31Z",
    "author_association": "MEMBER",
    "body": "Test failue: https://github.com/bitcoin/bitcoin/pull/21726#discussion_r745556769",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/965570260/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969837222",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#issuecomment-969837222",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/21726",
    "id": 969837222,
    "node_id": "IC_kwDOABII5845zoqm",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-16T04:03:32Z",
    "updated_at": "2021-11-16T04:03:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--cf906140f33d8803c4a75a2196329ecb-->\n\ud83d\udc19 This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969837222/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615556639",
    "pull_request_review_id": 638479069,
    "id": 615556639,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTU1NjYzOQ==",
    "diff_hunk": "@@ -1335,6 +1334,14 @@ int BlockManager::GetSpendHeight(const CCoinsViewCache& inputs)\n     return pindexPrev->nHeight + 1;\n }\n \n+const CBlockIndex* BlockManager::GetLastPruneBlock(const CBlockIndex* start_block) {\n+    const CBlockIndex* block = start_block;\n+    CHECK_NONFATAL(block);",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 14,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "23fb6feec6c070943e4a6ee94055c9d47b6c8a90",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This function doesn't use any member of BlockManager, so could be stand-alone? Also, I think you can avoid this check by having the caller pass a `const CBlockIndex& start_block`.",
    "created_at": "2021-04-19T05:49:00Z",
    "updated_at": "2021-04-19T05:49:00Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r615556639",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615556639"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r615556639"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/615556639/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1339,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632032296",
    "pull_request_review_id": 659205588,
    "id": 632032296,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzMjAzMjI5Ng==",
    "diff_hunk": "@@ -1335,6 +1334,14 @@ int BlockManager::GetSpendHeight(const CCoinsViewCache& inputs)\n     return pindexPrev->nHeight + 1;\n }\n \n+const CBlockIndex* BlockManager::GetLastPruneBlock(const CBlockIndex* start_block) {\n+    const CBlockIndex* block = start_block;\n+    CHECK_NONFATAL(block);",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 14,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "23fb6feec6c070943e4a6ee94055c9d47b6c8a90",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks! I made the changes as suggested.",
    "created_at": "2021-05-13T18:55:13Z",
    "updated_at": "2021-05-13T18:55:13Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r632032296",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632032296"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r632032296"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/632032296/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1339,
    "side": "RIGHT",
    "in_reply_to_id": 615556639
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638228451",
    "pull_request_review_id": 667113687,
    "id": 638228451,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODIyODQ1MQ==",
    "diff_hunk": "@@ -3663,6 +3673,10 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 21,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "5d23ddf5ff3bd1e5d4f6b85440d9ad0c59bb9994",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In 5d23ddf5ff3bd1e5d4f6b85440d9ad0c59bb9994 \"Add prune blockers to BlockManager\"\r\n\r\nSince this has `EXCLUSIVE_LOCKS_REQUIRED`, I think it should also have `AssertLockHeld` in here too.",
    "created_at": "2021-05-24T19:42:35Z",
    "updated_at": "2021-05-24T19:50:42Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638228451",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638228451"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638228451"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638228451/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3672,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638325082",
    "pull_request_review_id": 667236323,
    "id": 638325082,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODMyNTA4Mg==",
    "diff_hunk": "@@ -3663,6 +3673,10 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 21,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "5d23ddf5ff3bd1e5d4f6b85440d9ad0c59bb9994",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Right, fixed!",
    "created_at": "2021-05-24T22:13:42Z",
    "updated_at": "2021-05-24T22:13:42Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638325082",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638325082"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638325082"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638325082/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3672,
    "side": "RIGHT",
    "in_reply_to_id": 638228451
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347138",
    "pull_request_review_id": 667264075,
    "id": 638347138,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0NzEzOA==",
    "diff_hunk": "@@ -51,6 +51,14 @@ bool IsBlockPruned(const CBlockIndex* pblockindex)\n     return (fHavePruned && !(pblockindex->nStatus & BLOCK_HAVE_DATA) && pblockindex->nTx > 0);\n }\n \n+const CBlockIndex* GetLastPruneBlock(const CBlockIndex& start_block) {",
    "path": "src/node/blockstorage.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "bfe9719e29d7947e2ffa9b510cd078e8a09b5d03",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "bfe9719e29d7947e2ffa9b510cd078e8a09b5d03\r\n\r\nnit, `GetLastPrunedBlock`?",
    "created_at": "2021-05-24T23:11:22Z",
    "updated_at": "2021-05-24T23:22:32Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638347138",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347138"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638347138"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347138/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 54,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347828",
    "pull_request_review_id": 667264075,
    "id": 638347828,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0NzgyOA==",
    "diff_hunk": "@@ -450,6 +450,10 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;\n+\n+    void UpdatePruneBlocker(std::string name, const CBlockIndex* block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
    "path": "src/validation.h",
    "position": null,
    "original_position": 6,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "b5a239390fd1b31c7e6107a2e6c35658a2b4697c\r\n\r\nnit, `const std::string&`.",
    "created_at": "2021-05-24T23:13:19Z",
    "updated_at": "2021-05-24T23:22:32Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638347828",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347828"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638347828"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638347828/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 455,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348578",
    "pull_request_review_id": 667264075,
    "id": 638348578,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0ODU3OA==",
    "diff_hunk": "@@ -2041,6 +2041,16 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                if (blocker.second) {",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "b5a239390fd1b31c7e6107a2e6c35658a2b4697c\r\n\r\nHow can it be `nullptr`?",
    "created_at": "2021-05-24T23:15:37Z",
    "updated_at": "2021-05-24T23:22:32Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638348578",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348578"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638348578"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348578/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2045,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348949",
    "pull_request_review_id": 667264075,
    "id": 638348949,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0ODk0OQ==",
    "diff_hunk": "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
    "path": "src/validation.cpp",
    "position": 37,
    "original_position": 23,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "b5a239390fd1b31c7e6107a2e6c35658a2b4697c\r\n\r\nShould check/assert it only goes forward when updating?",
    "created_at": "2021-05-24T23:16:45Z",
    "updated_at": "2021-05-24T23:22:32Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638348949",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348949"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638348949"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638348949/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3604,
    "original_line": 3604,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638349497",
    "pull_request_review_id": 667264075,
    "id": 638349497,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYzODM0OTQ5Nw==",
    "diff_hunk": "@@ -364,3 +364,15 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    m_best_block_index = block;\n+    if (AllowPrune()) {\n+        LOCK(::cs_main);\n+        if (!block) {\n+            g_chainman.m_blockman.UpdatePruneBlocker(GetName(), ::ChainActive().Genesis());",
    "path": "src/index/base.cpp",
    "position": null,
    "original_position": 71,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "d18677006d3d48ca7654039ea6e267164a2690e0",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "d18677006d3d48ca7654039ea6e267164a2690e0\r\n\r\nnit, use ternary? `block ? block : ::ChainActive().Genesis()`",
    "created_at": "2021-05-24T23:18:33Z",
    "updated_at": "2021-05-24T23:22:32Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638349497",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638349497"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r638349497"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/638349497/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 373,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188761",
    "pull_request_review_id": 669625747,
    "id": 640188761,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODc2MQ==",
    "diff_hunk": "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
    "path": "src/validation.cpp",
    "position": 37,
    "original_position": 23,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I am not sure. The way I use it right now it can also go down with reorgs. I am undecided what the right course is. Only going up avoids a potential footgun, with going down it could react to (highly unlikely) deep reorg. If I add this I think I would do it so that setting a lower number is simply a no op:\r\n\r\n```\r\nif (m_prune_blockers[name] < block) m_prune_blockers[name] = block;\r\n```",
    "created_at": "2021-05-26T23:36:05Z",
    "updated_at": "2021-05-26T23:36:05Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188761",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188761"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188761"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188761/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3604,
    "original_line": 3604,
    "side": "RIGHT",
    "in_reply_to_id": 638348949
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188783",
    "pull_request_review_id": 669625774,
    "id": 640188783,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODc4Mw==",
    "diff_hunk": "@@ -364,3 +364,15 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    m_best_block_index = block;\n+    if (AllowPrune()) {\n+        LOCK(::cs_main);\n+        if (!block) {\n+            g_chainman.m_blockman.UpdatePruneBlocker(GetName(), ::ChainActive().Genesis());",
    "path": "src/index/base.cpp",
    "position": null,
    "original_position": 71,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "d18677006d3d48ca7654039ea6e267164a2690e0",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "done",
    "created_at": "2021-05-26T23:36:10Z",
    "updated_at": "2021-05-26T23:36:10Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188783",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188783"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188783"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188783/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 373,
    "side": "RIGHT",
    "in_reply_to_id": 638349497
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188853",
    "pull_request_review_id": 669625858,
    "id": 640188853,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODg1Mw==",
    "diff_hunk": "@@ -2041,6 +2041,16 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                if (blocker.second) {",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I guess it should never be `nullptr`. Dropped that if statement.",
    "created_at": "2021-05-26T23:36:20Z",
    "updated_at": "2021-05-26T23:36:20Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188853",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188853"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188853"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188853/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2045,
    "side": "RIGHT",
    "in_reply_to_id": 638348578
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188945",
    "pull_request_review_id": 669625968,
    "id": 640188945,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODk0NQ==",
    "diff_hunk": "@@ -450,6 +450,10 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;\n+\n+    void UpdatePruneBlocker(std::string name, const CBlockIndex* block) EXCLUSIVE_LOCKS_REQUIRED(::cs_main);",
    "path": "src/validation.h",
    "position": null,
    "original_position": 6,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "done",
    "created_at": "2021-05-26T23:36:37Z",
    "updated_at": "2021-05-26T23:36:38Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188945",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188945"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188945"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188945/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 455,
    "side": "RIGHT",
    "in_reply_to_id": 638347828
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188998",
    "pull_request_review_id": 669626026,
    "id": 640188998,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE4ODk5OA==",
    "diff_hunk": "@@ -51,6 +51,14 @@ bool IsBlockPruned(const CBlockIndex* pblockindex)\n     return (fHavePruned && !(pblockindex->nStatus & BLOCK_HAVE_DATA) && pblockindex->nTx > 0);\n }\n \n+const CBlockIndex* GetLastPruneBlock(const CBlockIndex& start_block) {",
    "path": "src/node/blockstorage.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "bfe9719e29d7947e2ffa9b510cd078e8a09b5d03",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "done",
    "created_at": "2021-05-26T23:36:45Z",
    "updated_at": "2021-05-26T23:36:46Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188998",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188998"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640188998"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640188998/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 54,
    "side": "RIGHT",
    "in_reply_to_id": 638347138
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640190703",
    "pull_request_review_id": 669627925,
    "id": 640190703,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MDE5MDcwMw==",
    "diff_hunk": "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
    "path": "src/validation.cpp",
    "position": 37,
    "original_position": 23,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "But what should happen if the block is already pruned?",
    "created_at": "2021-05-26T23:41:48Z",
    "updated_at": "2021-05-26T23:41:48Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640190703",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640190703"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r640190703"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/640190703/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3604,
    "original_line": 3604,
    "side": "RIGHT",
    "in_reply_to_id": 638348949
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643467366",
    "pull_request_review_id": 673564476,
    "id": 643467366,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0MzQ2NzM2Ng==",
    "diff_hunk": "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
    "path": "src/validation.cpp",
    "position": 37,
    "original_position": 23,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Hm, that would mean the node would have to restart with `-reindex` anyway, right?",
    "created_at": "2021-06-01T20:46:34Z",
    "updated_at": "2021-06-01T20:46:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r643467366",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643467366"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r643467366"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/643467366/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3604,
    "original_line": 3604,
    "side": "RIGHT",
    "in_reply_to_id": 638348949
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644094388",
    "pull_request_review_id": 674379812,
    "id": 644094388,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDA5NDM4OA==",
    "diff_hunk": "@@ -1069,12 +1069,9 @@ static RPCHelpMan pruneblockchain()\n     }\n \n     PruneBlockFilesManual(active_chainstate, height);\n-    const CBlockIndex* block = active_chain.Tip();\n-    CHECK_NONFATAL(block);\n-    while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n-        block = block->pprev;\n-    }\n-    return uint64_t(block->nHeight);\n+    const CBlockIndex* last_block = GetLastPrunedBlock(*active_chain.Tip());",
    "path": "src/rpc/blockchain.cpp",
    "position": null,
    "original_position": 10,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "292d508e956bfe5b05e6ee685415063c2a0f04af",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"refactor: Introduce GetLastPruneBlock helper function\" (292d508e956bfe5b05e6ee685415063c2a0f04af)\r\n\r\nNote: Here and in the other location below there's no more CHECK_NONFATAL so there would be segfault instead of an exception if the tip was null. Doesn't seem like a problem, but if were for some reason, GetLastPrunedBlock argument could be a pointer instead of a reference and the check could be added there.",
    "created_at": "2021-06-02T15:46:54Z",
    "updated_at": "2021-06-02T15:49:34Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644094388",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644094388"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644094388"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644094388/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1075,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644109721",
    "pull_request_review_id": 674399868,
    "id": 644109721,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDEwOTcyMQ==",
    "diff_hunk": "@@ -494,6 +497,12 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;",
    "path": "src/validation.h",
    "position": null,
    "original_position": 14,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Add prune blockers to BlockManager\" (9f8d6a9a8f7d113ae12306c72a773830b5725e37)\r\n\r\nWould be good to have a descriptive comment like:\r\n\r\n```c++\r\n//! Map from external index name to most recent block the index can tolerate being pruned.\r\n//!\r\n//! @note Internally, only blocks at height (block->nHeight + PRUNE_BLOCKER_BUFFER) and\r\n//! below will be pruned, but callers should avoid assuming any particular buffer size.\r\n```",
    "created_at": "2021-06-02T16:04:50Z",
    "updated_at": "2021-06-02T18:11:30Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644109721",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644109721"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644109721"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644109721/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 499,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644115299",
    "pull_request_review_id": 674399868,
    "id": 644115299,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDExNTI5OQ==",
    "diff_hunk": "@@ -3792,6 +3794,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 18,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Add prune blockers to BlockManager\" (9f8d6a9a8f7d113ae12306c72a773830b5725e37)\r\n\r\nJust a style suggestion, so feel free to ignore, but usage of this function seems awkward to understand with last_prune being an input and an output parameter. I think FlushStateToDisk would be easier to read with the code in this function just inlined there (which is the only place where it is called).",
    "created_at": "2021-06-02T16:12:07Z",
    "updated_at": "2021-06-02T18:11:30Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644115299",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644115299"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644115299"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644115299/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3802,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644173288",
    "pull_request_review_id": 674399868,
    "id": 644173288,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDE3MzI4OA==",
    "diff_hunk": "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
    "path": "src/validation.cpp",
    "position": 37,
    "original_position": 23,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Add prune blockers to BlockManager\" (9f8d6a9a8f7d113ae12306c72a773830b5725e37):\r\n\r\nre: https://github.com/bitcoin/bitcoin/pull/21726#discussion_r643467366\r\n\r\n> Hm, that would mean the node would have to restart with `-reindex` anyway, right?\r\n\r\nIt would be nice to have a test for this case if there isn't one. does seem like like if there was reorg and a block needed by the index was pruned, the index should be responsible for handling the error when the rewind method is called. I guess the index could just disable itself or stop the node at that point.\r\n\r\nBut for this `UpdatePruneBlocker` method, it would seem too strict to never allow a blocker to move backwards, because moving an existing blocker backwards seems no worse of a problem than adding new blocker at a lower minimum height. Maybe it could be useful to have a sanity check here which asserts that whenever a new minimum height is set in the map, that no blocks in the (new_min_height, prev_min_height] range have been pruned. But this doesn't seem strictly necessary either if we are confident that indexes compatible with pruning are able to handle pruned block errors safely when they are syncing or handling reorgs",
    "created_at": "2021-06-02T17:23:40Z",
    "updated_at": "2021-06-02T18:11:30Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644173288",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644173288"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644173288"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644173288/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3604,
    "original_line": 3604,
    "side": "RIGHT",
    "in_reply_to_id": 638348949
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644205509",
    "pull_request_review_id": 674399868,
    "id": 644205509,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY0NDIwNTUwOQ==",
    "diff_hunk": "@@ -3792,6 +3794,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {\n+    for (auto const& blocker : m_prune_blockers) {\n+        const int blocker_height = blocker.second->nHeight + PRUNE_BLOCKER_BUFFER;\n+        last_prune = std::max(1, std::min(last_prune, blocker_height));\n+        if (last_prune == blocker_height) {\n+            LogPrintf(\"%s limited pruning to height %d\\n\", blocker.first, blocker_height);",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 23,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Add prune blockers to BlockManager\" (9f8d6a9a8f7d113ae12306c72a773830b5725e37):\r\n\r\nWould it make sense to use a log category here `LogPrint(BCLog::PRUNE, ...)` instead of printing unconditionally? Also in the future it could be nice to unify this print with the prints in the FindFilesToPrune functions and print the full pruning status in a consistent way on just one line.",
    "created_at": "2021-06-02T18:06:23Z",
    "updated_at": "2021-06-02T18:11:30Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644205509",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644205509"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r644205509"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/644205509/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3807,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654778191",
    "pull_request_review_id": 687813168,
    "id": 654778191,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDc3ODE5MQ==",
    "diff_hunk": "@@ -3792,6 +3790,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {\n+    for (auto const& blocker : m_prune_blockers) {\n+        const int blocker_height = blocker.second->nHeight + PRUNE_BLOCKER_BUFFER;",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 35,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
    "user": {
      "login": "dergoegge",
      "id": 8077169,
      "node_id": "MDQ6VXNlcjgwNzcxNjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dergoegge",
      "html_url": "https://github.com/dergoegge",
      "followers_url": "https://api.github.com/users/dergoegge/followers",
      "following_url": "https://api.github.com/users/dergoegge/following{/other_user}",
      "gists_url": "https://api.github.com/users/dergoegge/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
      "organizations_url": "https://api.github.com/users/dergoegge/orgs",
      "repos_url": "https://api.github.com/users/dergoegge/repos",
      "events_url": "https://api.github.com/users/dergoegge/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dergoegge/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n        const int blocker_height = blocker.second->nHeight - PRUNE_BLOCKER_BUFFER;\r\n```\r\nShouldn't we subtract here if we want to keep `PRUNE_BLOCKER_BUFFER` blocks **before** the deepest blocker?\r\n\r\nfrom the logs of a test run:\r\n```\r\nnode1 2021-06-19T12:10:06.022496Z [init] [validation.cpp:3803] [GetLastPruneBlockerHeight] coinstatsindex limited pruning to height 10\r\n...\r\nnode1 2021-06-19T12:10:06.044329Z [coinstatsindex] [index/base.cpp:159] [ThreadSync] Syncing coinstatsindex with block chain from height 0\r\n```\r\nnode1 limited pruning to height 10 before it started syncing from height 0.",
    "created_at": "2021-06-19T10:15:05Z",
    "updated_at": "2021-06-19T12:31:00Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r654778191",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654778191"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r654778191"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654778191/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3800,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654789987",
    "pull_request_review_id": 687813168,
    "id": 654789987,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1NDc4OTk4Nw==",
    "diff_hunk": "@@ -0,0 +1,117 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"]\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(1,2)\n+        self.connect_nodes(2,1)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)",
    "path": "test/functional/feature_index_prune.py",
    "position": 63,
    "original_position": 62,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
    "user": {
      "login": "dergoegge",
      "id": 8077169,
      "node_id": "MDQ6VXNlcjgwNzcxNjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dergoegge",
      "html_url": "https://github.com/dergoegge",
      "followers_url": "https://api.github.com/users/dergoegge/followers",
      "following_url": "https://api.github.com/users/dergoegge/following{/other_user}",
      "gists_url": "https://api.github.com/users/dergoegge/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
      "organizations_url": "https://api.github.com/users/dergoegge/orgs",
      "repos_url": "https://api.github.com/users/dergoegge/repos",
      "events_url": "https://api.github.com/users/dergoegge/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dergoegge/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Wouldn't it make more sense to wait for the indexes to sync *after* pruning?\r\nOtherwise it is pretty much guaranteed that the index data at the tip (700) is available after pruning.\r\n\r\nIn general i think it would be good for the test to check for expected prune blocker heights somehow. (not sure if that is possible, i dont know that much about the functional tests)",
    "created_at": "2021-06-19T12:22:15Z",
    "updated_at": "2021-06-19T12:31:00Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r654789987",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654789987"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r654789987"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/654789987/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 63,
    "original_line": 63,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659805048",
    "pull_request_review_id": 693981880,
    "id": 659805048,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1OTgwNTA0OA==",
    "diff_hunk": "@@ -370,3 +366,11 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    m_best_block_index = block;\n+    if (AllowPrune() && (fPruneMode || fHavePruned) && !fReindex) {\n+        LOCK(::cs_main);\n+        g_chainman.m_blockman.UpdatePruneBlocker(GetName(), block ? block : ::ChainActive().Genesis());",
    "path": "src/index/base.cpp",
    "position": null,
    "original_position": 84,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Error building this branch at e365e87a72cc4 rebased to current master at 8cdf91735f2b, looks like it needs updating:\r\n```rake\r\nindex/base.cpp:373:9: error: use of undeclared identifier 'g_chainman'\r\n        g_chainman.m_blockman.UpdatePruneBlocker(GetName(), block ? block : ::ChainActive().Genesis());\r\n        ^\r\nindex/base.cpp:373:79: error: no member named 'ChainActive' in the global namespace\r\n        g_chainman.m_blockman.UpdatePruneBlocker(GetName(), block ? block : ::ChainActive().Genesis());\r\n                                                                            ~~^\r\n2 errors generated.\r\n```\r\n",
    "created_at": "2021-06-28T13:50:49Z",
    "updated_at": "2021-06-28T13:50:49Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r659805048",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659805048"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r659805048"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/659805048/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 374,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488378",
    "pull_request_review_id": 746690769,
    "id": 702488378,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODM3OA==",
    "diff_hunk": "@@ -3792,6 +3790,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {\n+    for (auto const& blocker : m_prune_blockers) {\n+        const int blocker_height = blocker.second->nHeight + PRUNE_BLOCKER_BUFFER;",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 35,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "right \ud83d\ude44 thanks, fixed!",
    "created_at": "2021-09-05T22:58:17Z",
    "updated_at": "2021-09-05T22:58:17Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488378",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488378"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488378"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488378/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3800,
    "side": "RIGHT",
    "in_reply_to_id": 654778191
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488632",
    "pull_request_review_id": 746691001,
    "id": 702488632,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODYzMg==",
    "diff_hunk": "@@ -3792,6 +3794,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {\n+    for (auto const& blocker : m_prune_blockers) {\n+        const int blocker_height = blocker.second->nHeight + PRUNE_BLOCKER_BUFFER;\n+        last_prune = std::max(1, std::min(last_prune, blocker_height));\n+        if (last_prune == blocker_height) {\n+            LogPrintf(\"%s limited pruning to height %d\\n\", blocker.first, blocker_height);",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 23,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yeah, I agree, I added a log category. I am leaving unifying for a potential follow-up to not complicate this PR further.",
    "created_at": "2021-09-05T23:01:08Z",
    "updated_at": "2021-09-05T23:01:08Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488632",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488632"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488632"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488632/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3807,
    "side": "RIGHT",
    "in_reply_to_id": 644205509
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488725",
    "pull_request_review_id": 746691034,
    "id": 702488725,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODcyNQ==",
    "diff_hunk": "@@ -494,6 +497,12 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;",
    "path": "src/validation.h",
    "position": null,
    "original_position": 14,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Added!",
    "created_at": "2021-09-05T23:01:39Z",
    "updated_at": "2021-09-05T23:01:39Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488725",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488725"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488725"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488725/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 499,
    "side": "RIGHT",
    "in_reply_to_id": 644109721
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488743",
    "pull_request_review_id": 746691065,
    "id": 702488743,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODc0Mw==",
    "diff_hunk": "@@ -3792,6 +3794,21 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;\n+}\n+\n+void BlockManager::GetLastPruneBlockerHeight(int& last_prune) {",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 18,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "9f8d6a9a8f7d113ae12306c72a773830b5725e37",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done",
    "created_at": "2021-09-05T23:01:59Z",
    "updated_at": "2021-09-05T23:02:00Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488743",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488743"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488743"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488743/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3802,
    "side": "RIGHT",
    "in_reply_to_id": 644115299
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488827",
    "pull_request_review_id": 746691118,
    "id": 702488827,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4ODgyNw==",
    "diff_hunk": "@@ -370,3 +366,11 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {\n+    m_best_block_index = block;\n+    if (AllowPrune() && (fPruneMode || fHavePruned) && !fReindex) {\n+        LOCK(::cs_main);\n+        g_chainman.m_blockman.UpdatePruneBlocker(GetName(), block ? block : ::ChainActive().Genesis());",
    "path": "src/index/base.cpp",
    "position": null,
    "original_position": 84,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks, fixed.",
    "created_at": "2021-09-05T23:02:32Z",
    "updated_at": "2021-09-05T23:02:32Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488827",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488827"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702488827"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702488827/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 374,
    "side": "RIGHT",
    "in_reply_to_id": 659805048
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702489106",
    "pull_request_review_id": 746691401,
    "id": 702489106,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ4OTEwNg==",
    "diff_hunk": "@@ -0,0 +1,117 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"]\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(1,2)\n+        self.connect_nodes(2,1)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)",
    "path": "test/functional/feature_index_prune.py",
    "position": 63,
    "original_position": 62,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "e365e87a72cc49e175b31256a11a6c5b1621d1f2",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> Wouldn't it make more sense to wait for the indexes to sync _after_ pruning?\r\n> Otherwise it is pretty much guaranteed that the index data at the tip (700) is available after pruning.\r\n\r\nYes, that would be good, but unless I am misunderstanding your comment, what we would be testing then is a race condition which would make the test flaky.\r\n\r\n> In general i think it would be good for the test to check for expected prune blocker heights somehow. (not sure if that is possible, i dont know that much about the functional tests)\r\n\r\nyes, I added two sanity checks for the exact prune blocker height by checking the logs\r\n",
    "created_at": "2021-09-05T23:05:33Z",
    "updated_at": "2021-09-05T23:05:33Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702489106",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702489106"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702489106"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702489106/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 63,
    "original_line": 63,
    "side": "RIGHT",
    "in_reply_to_id": 654789987
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492020",
    "pull_request_review_id": 746693619,
    "id": 702492020,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ5MjAyMA==",
    "diff_hunk": "@@ -1069,12 +1069,9 @@ static RPCHelpMan pruneblockchain()\n     }\n \n     PruneBlockFilesManual(active_chainstate, height);\n-    const CBlockIndex* block = active_chain.Tip();\n-    CHECK_NONFATAL(block);\n-    while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n-        block = block->pprev;\n-    }\n-    return uint64_t(block->nHeight);\n+    const CBlockIndex* last_block = GetLastPrunedBlock(*active_chain.Tip());",
    "path": "src/rpc/blockchain.cpp",
    "position": null,
    "original_position": 10,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "292d508e956bfe5b05e6ee685415063c2a0f04af",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "True, I changed the function to take a pointer and added a CHECK_NONFATAL to be more consistent with the previous code.",
    "created_at": "2021-09-05T23:30:04Z",
    "updated_at": "2021-09-05T23:30:05Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702492020",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492020"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702492020"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492020/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1075,
    "side": "RIGHT",
    "in_reply_to_id": 644094388
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492978",
    "pull_request_review_id": 746694375,
    "id": 702492978,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwMjQ5Mjk3OA==",
    "diff_hunk": "@@ -3663,6 +3673,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(std::string name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
    "path": "src/validation.cpp",
    "position": 37,
    "original_position": 23,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "b5a239390fd1b31c7e6107a2e6c35658a2b4697c",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes, I added functional tests for the -reindex case.\r\n\r\nI am looking into the sanity check assert idea don't have a clear opinion yet.\r\n\r\n",
    "created_at": "2021-09-05T23:37:40Z",
    "updated_at": "2021-09-05T23:37:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702492978",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492978"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r702492978"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/702492978/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3604,
    "original_line": 3604,
    "side": "RIGHT",
    "in_reply_to_id": 638348949
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705355682",
    "pull_request_review_id": 750371858,
    "id": 705355682,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNTM1NTY4Mg==",
    "diff_hunk": "@@ -72,11 +72,7 @@ bool BaseIndex::Init()\n         if (!m_best_block_index) {\n             // index is not built yet\n             // make sure we have all block data back to the genesis\n-            const CBlockIndex* block = active_chain.Tip();\n-            while (block->pprev && (block->pprev->nStatus & BLOCK_HAVE_DATA)) {\n-                block = block->pprev;\n-            }\n-            prune_violation = block != active_chain.Genesis();\n+            prune_violation = GetLastPrunedBlock(active_chain.Tip()) != active_chain.Genesis();",
    "path": "src/index/base.cpp",
    "position": null,
    "original_position": 9,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "2c815adc881fa90f14887e2ec33ccb11ef964387",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "https://github.com/bitcoin/bitcoin/pull/21726/commits/2c815adc881fa90f14887e2ec33ccb11ef964387\r\n\r\nNote: ensured `active_chain.Tip()` will not ever be nullptr here because `g_txindex` et al are started in init.cpp after genesis block load.",
    "created_at": "2021-09-09T13:53:02Z",
    "updated_at": "2021-09-09T15:37:23Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r705355682",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705355682"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r705355682"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705355682/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 75,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705377815",
    "pull_request_review_id": 750371858,
    "id": 705377815,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNTM3NzgxNQ==",
    "diff_hunk": "@@ -488,6 +490,16 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;",
    "path": "src/validation.h",
    "position": null,
    "original_position": 19,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "9c70676aded6e2c9c4719fd5039f27a2c16a54fb",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "https://github.com/bitcoin/bitcoin/pull/21726/commits/9c70676aded6e2c9c4719fd5039f27a2c16a54fb\r\n\r\nI'm curious why the method below is marked as requiring cs_main, but this data structure isn't marked as guarded by cs_main - is that intentional?",
    "created_at": "2021-09-09T14:13:57Z",
    "updated_at": "2021-09-09T15:37:23Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r705377815",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705377815"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r705377815"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/705377815/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 499,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706609540",
    "pull_request_review_id": 751916636,
    "id": 706609540,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjYwOTU0MA==",
    "diff_hunk": "@@ -0,0 +1,130 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def expected_prune_height(self, n):\n+        # Sanity check for correct prune blocker height in logs\n+        for node in self.nodes:\n+            node.assert_debug_log([f'limited pruning to height {n}'])\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)\n+\n+        self.expected_prune_height(690)\n+\n+        self.log.info(\"prune some blocks\")\n+        for node in self.nodes[:2]:\n+            pruneheight = node.pruneblockchain(400)\n+            assert_equal(pruneheight, 248)\n+\n+        self.log.info(\"check if we can access the tips blockfilter and coinstats when we have pruned some blocks\")\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        self.log.info(\"check if we can access the blockfilter and coinstats of a pruned block\")\n+        height_hash = self.nodes[0].getblockhash(2)\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(height_hash)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=height_hash)['muhash'])\n+\n+        self.log.info(\"restart nodes without indices\")\n+        for i in range(3):\n+            self.restart_node(i, extra_args=[\"-fastprune\", \"-prune=1\"])\n+        self.reconnect_nodes()\n+\n+        self.log.info(\"make sure trying to access the indices throws errors\")\n+        for node in filter_nodes:\n+            msg = \"Index is not enabled for filtertype basic\"\n+            assert_raises_rpc_error(-1, msg, node.getblockfilter, height_hash)\n+        for node in stats_nodes:\n+            msg = \"Querying specific block heights requires coinstatsindex\"\n+            assert_raises_rpc_error(-8, msg, node.gettxoutsetinfo, \"muhash\", height_hash)\n+\n+        self.mine_batches(4)\n+\n+        self.log.info(\"prune further than the indices best blocks while the indices are disabled\")\n+        for i in range(3):\n+            pruneheight_new = self.nodes[i].pruneblockchain(1000)\n+            assert_greater_than(pruneheight_new, pruneheight)",
    "path": "test/functional/feature_index_prune.py",
    "position": null,
    "original_position": 109,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "983a3552f22678d4466e0faa8e784f25b145a76b",
    "user": {
      "login": "dergoegge",
      "id": 8077169,
      "node_id": "MDQ6VXNlcjgwNzcxNjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dergoegge",
      "html_url": "https://github.com/dergoegge",
      "followers_url": "https://api.github.com/users/dergoegge/followers",
      "following_url": "https://api.github.com/users/dergoegge/following{/other_user}",
      "gists_url": "https://api.github.com/users/dergoegge/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
      "organizations_url": "https://api.github.com/users/dergoegge/orgs",
      "repos_url": "https://api.github.com/users/dergoegge/repos",
      "events_url": "https://api.github.com/users/dergoegge/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dergoegge/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: make the code match the log statement (`pruneheight` is here still set to 248 while the indices best block is 700)\r\n```suggestion\r\n            assert_greater_than(pruneheight_new, 700)\r\n```\r\n",
    "created_at": "2021-09-11T12:50:40Z",
    "updated_at": "2021-09-11T15:13:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r706609540",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706609540"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r706609540"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706609540/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 109,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706623557",
    "pull_request_review_id": 751916636,
    "id": 706623557,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDcwNjYyMzU1Nw==",
    "diff_hunk": "@@ -0,0 +1,130 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def expected_prune_height(self, n):\n+        # Sanity check for correct prune blocker height in logs\n+        for node in self.nodes:\n+            node.assert_debug_log([f'limited pruning to height {n}'])\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)\n+\n+        self.expected_prune_height(690)",
    "path": "test/functional/feature_index_prune.py",
    "position": null,
    "original_position": 70,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "983a3552f22678d4466e0faa8e784f25b145a76b",
    "user": {
      "login": "dergoegge",
      "id": 8077169,
      "node_id": "MDQ6VXNlcjgwNzcxNjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dergoegge",
      "html_url": "https://github.com/dergoegge",
      "followers_url": "https://api.github.com/users/dergoegge/followers",
      "following_url": "https://api.github.com/users/dergoegge/following{/other_user}",
      "gists_url": "https://api.github.com/users/dergoegge/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
      "organizations_url": "https://api.github.com/users/dergoegge/orgs",
      "repos_url": "https://api.github.com/users/dergoegge/repos",
      "events_url": "https://api.github.com/users/dergoegge/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dergoegge/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I am able to put any value here besides 690 and the test still passes.\r\n\r\nThis is because [`assert_debug_log`](https://github.com/bitcoin/bitcoin/blob/5c0f46ca46e23a161649b5150baa01020dc85e48/test/functional/test_framework/test_node.py#L381) is a generator and meant to be used in combination with `with`:\r\n```python\r\nwith assert_debug_log(...):\r\n  # some other code that prints the (un)expected logs\r\n```\r\n\"At the point where the generator yields, the block nested in the [`with`](https://docs.python.org/3/reference/compound_stmts.html#with) statement is executed. The generator is then resumed after the block is exited. [...]\" from https://docs.python.org/3/library/contextlib.html#contextlib.contextmanager\r\n\r\nSecondly i think that checking the logs to test the prune blocker height won't work here as the expected message is only printed when pruning is attempted (https://github.com/bitcoin/bitcoin/blob/983a3552f22678d4466e0faa8e784f25b145a76b/src/validation.cpp#L2027)\r\n\r\nthe following would work:\r\n```python\r\n self.log.info(\"prune some blocks\")\r\n for node in self.nodes[:2]:\r\n     with node.assert_debug_log(['limited pruning to height 690']):\r\n         pruneheight = node.pruneblockchain(400)\r\n         assert_equal(pruneheight, 248)\r\n```\r\n",
    "created_at": "2021-09-11T15:04:47Z",
    "updated_at": "2021-09-11T15:13:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r706623557",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706623557"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r706623557"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/706623557/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 70,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712372589",
    "pull_request_review_id": 758911426,
    "id": 712372589,
    "node_id": "PRRC_kwDOABII584qdfFt",
    "diff_hunk": "@@ -48,6 +48,9 @@ extern uint64_t nPruneTarget;\n //! Check whether the block associated with this index entry is pruned or not.\n bool IsBlockPruned(const CBlockIndex* pblockindex);\n \n+//! Find the last block that is pruned\n+const CBlockIndex* GetLastPrunedBlock(const CBlockIndex* start_block);",
    "path": "src/node/blockstorage.h",
    "position": null,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "2c815adc881fa90f14887e2ec33ccb11ef964387",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"refactor: Introduce GetLastPruneBlock helper function\" (2c815adc881fa90f14887e2ec33ccb11ef964387)\r\n\r\nThis doesn't seem to actually return the last block that is pruned. It seems to return the next block that has data. So maybe should be called `GetFirstNonPrunedBlock`? It also seems like `pruneblockchain` RPC documentation describes this incorrectly while `getblockchaininfo` describes it correctly.",
    "created_at": "2021-09-20T17:28:51Z",
    "updated_at": "2021-09-20T17:29:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r712372589",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712372589"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r712372589"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/712372589/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 51,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 52,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341113",
    "pull_request_review_id": 761445223,
    "id": 714341113,
    "node_id": "PRRC_kwDOABII584qk_r5",
    "diff_hunk": "@@ -488,6 +490,16 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers;",
    "path": "src/validation.h",
    "position": null,
    "original_position": 19,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "9c70676aded6e2c9c4719fd5039f27a2c16a54fb",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Not intentional, just an oversight. Fixed!",
    "created_at": "2021-09-22T21:59:31Z",
    "updated_at": "2021-09-22T21:59:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714341113",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341113"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714341113"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341113/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 499,
    "side": "RIGHT",
    "in_reply_to_id": 705377815
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341348",
    "pull_request_review_id": 761445463,
    "id": 714341348,
    "node_id": "PRRC_kwDOABII584qk_vk",
    "diff_hunk": "@@ -0,0 +1,130 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def expected_prune_height(self, n):\n+        # Sanity check for correct prune blocker height in logs\n+        for node in self.nodes:\n+            node.assert_debug_log([f'limited pruning to height {n}'])\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)\n+\n+        self.expected_prune_height(690)\n+\n+        self.log.info(\"prune some blocks\")\n+        for node in self.nodes[:2]:\n+            pruneheight = node.pruneblockchain(400)\n+            assert_equal(pruneheight, 248)\n+\n+        self.log.info(\"check if we can access the tips blockfilter and coinstats when we have pruned some blocks\")\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        self.log.info(\"check if we can access the blockfilter and coinstats of a pruned block\")\n+        height_hash = self.nodes[0].getblockhash(2)\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(height_hash)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=height_hash)['muhash'])\n+\n+        self.log.info(\"restart nodes without indices\")\n+        for i in range(3):\n+            self.restart_node(i, extra_args=[\"-fastprune\", \"-prune=1\"])\n+        self.reconnect_nodes()\n+\n+        self.log.info(\"make sure trying to access the indices throws errors\")\n+        for node in filter_nodes:\n+            msg = \"Index is not enabled for filtertype basic\"\n+            assert_raises_rpc_error(-1, msg, node.getblockfilter, height_hash)\n+        for node in stats_nodes:\n+            msg = \"Querying specific block heights requires coinstatsindex\"\n+            assert_raises_rpc_error(-8, msg, node.gettxoutsetinfo, \"muhash\", height_hash)\n+\n+        self.mine_batches(4)\n+\n+        self.log.info(\"prune further than the indices best blocks while the indices are disabled\")\n+        for i in range(3):\n+            pruneheight_new = self.nodes[i].pruneblockchain(1000)\n+            assert_greater_than(pruneheight_new, pruneheight)",
    "path": "test/functional/feature_index_prune.py",
    "position": null,
    "original_position": 109,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "983a3552f22678d4466e0faa8e784f25b145a76b",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Makes sense, fixed!",
    "created_at": "2021-09-22T21:59:55Z",
    "updated_at": "2021-09-22T21:59:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714341348",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341348"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714341348"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714341348/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 109,
    "side": "RIGHT",
    "in_reply_to_id": 706609540
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714342652",
    "pull_request_review_id": 761447114,
    "id": 714342652,
    "node_id": "PRRC_kwDOABII584qlAD8",
    "diff_hunk": "@@ -48,6 +48,9 @@ extern uint64_t nPruneTarget;\n //! Check whether the block associated with this index entry is pruned or not.\n bool IsBlockPruned(const CBlockIndex* pblockindex);\n \n+//! Find the last block that is pruned\n+const CBlockIndex* GetLastPrunedBlock(const CBlockIndex* start_block);",
    "path": "src/node/blockstorage.h",
    "position": null,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "2c815adc881fa90f14887e2ec33ccb11ef964387",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "True, I fixed this and went with with the name `GetFirstStoredBlock` inspired by the docs in `getblockchaininfo`. I also added an extra commit to fix the docs in `pruneblockchain`. I think fixing the docs is the right approach rather than change the behavior but I kept it in the separate commit in case there are different opinions on that.",
    "created_at": "2021-09-22T22:02:39Z",
    "updated_at": "2021-09-22T22:02:39Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714342652",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714342652"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714342652"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714342652/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 51,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 52,
    "side": "RIGHT",
    "in_reply_to_id": 712372589
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714345854",
    "pull_request_review_id": 761451347,
    "id": 714345854,
    "node_id": "PRRC_kwDOABII584qlA1-",
    "diff_hunk": "@@ -0,0 +1,130 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)\n+            self.sync_blocks()\n+\n+    def expected_prune_height(self, n):\n+        # Sanity check for correct prune blocker height in logs\n+        for node in self.nodes:\n+            node.assert_debug_log([f'limited pruning to height {n}'])\n+\n+    def run_test(self):\n+        filter_nodes = [self.nodes[0], self.nodes[2]]\n+        stats_nodes = [self.nodes[1], self.nodes[2]]\n+\n+        self.log.info(\"check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\")\n+        self.sync_index(height=200)\n+        tip = self.nodes[0].getbestblockhash()\n+        for node in filter_nodes:\n+            assert_greater_than(len(node.getblockfilter(tip)['filter']), 0)\n+        for node in stats_nodes:\n+            assert(node.gettxoutsetinfo(hash_type=\"muhash\", hash_or_height=tip)['muhash'])\n+\n+        # Mine two batches of blocks to avoid hitting NODE_NETWORK_LIMITED_MIN_BLOCKS disconnection\n+        self.mine_batches(2)\n+        self.sync_index(height=700)\n+\n+        self.expected_prune_height(690)",
    "path": "test/functional/feature_index_prune.py",
    "position": null,
    "original_position": 70,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "983a3552f22678d4466e0faa8e784f25b145a76b",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks a lot for the detailed feedback! I fixed this using your suggested approach in the two locations where I wanted to do the check.",
    "created_at": "2021-09-22T22:09:36Z",
    "updated_at": "2021-09-22T22:09:36Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714345854",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714345854"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714345854"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714345854/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 70,
    "side": "RIGHT",
    "in_reply_to_id": 706623557
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714427353",
    "pull_request_review_id": 761541915,
    "id": 714427353,
    "node_id": "PRRC_kwDOABII584qlUvZ",
    "diff_hunk": "@@ -48,6 +48,9 @@ extern uint64_t nPruneTarget;\n //! Check whether the block associated with this index entry is pruned or not.\n bool IsBlockPruned(const CBlockIndex* pblockindex);\n \n+//! Find the first block that is not pruned\n+const CBlockIndex* GetFirstStoredBlock(const CBlockIndex* start_block);",
    "path": "src/node/blockstorage.h",
    "position": 5,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "4ebe3a51da88589f23e243045a9e392701dfbbad",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"refactor: Introduce GetFirstStoredlock helper function\" (4ebe3a51da88589f23e243045a9e392701dfbbad)\r\n\r\nFunction name is spelled wrong in commit message",
    "created_at": "2021-09-23T02:11:16Z",
    "updated_at": "2021-09-23T19:39:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714427353",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714427353"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r714427353"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714427353/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 52,
    "original_line": 52,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715026559",
    "pull_request_review_id": 761541915,
    "id": 715026559,
    "node_id": "PRRC_kwDOABII584qnnB_",
    "diff_hunk": "@@ -369,3 +365,12 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {",
    "path": "src/index/base.cpp",
    "position": 80,
    "original_position": 80,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Index: Use prune blockers for blockfilterindex\" (7db7f26e97665c048b3f614c092899addd658f4f)\r\n\r\nCan we add an assert here:\r\n\r\n```\r\nassert(!fPruneMode || AllowPrune());\r\n```\r\n\r\nI know there is startup code that prevents the indexes which don't support AllowPrune from being enabled at the same time as the prune option, but you could imagine someone adding a new index where AllowPrune is false, and someone forgets to add the startup check. Or if the startup check just happens to be buggy, it would be good to have this check to detect the problem.",
    "created_at": "2021-09-23T17:52:44Z",
    "updated_at": "2021-09-23T19:39:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715026559",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715026559"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715026559"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715026559/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 369,
    "original_line": 369,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715054451",
    "pull_request_review_id": 761541915,
    "id": 715054451,
    "node_id": "PRRC_kwDOABII584qnt1z",
    "diff_hunk": "@@ -1941,12 +1940,9 @@ bool CChainState::FlushStateToDisk(\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState();\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n-            // make sure we don't prune above the blockfilterindexes bestblocks\n+            // make sure we don't prune above any of the prune blockers bestblocks\n             // pruning is height-based\n             int last_prune = m_chain.Height(); // last height we can prune\n-            ForEachBlockFilterIndex([&](BlockFilterIndex& index) {\n-               last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));",
    "path": "src/validation.cpp",
    "position": 17,
    "original_position": 17,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "7db7f26e97665c048b3f614c092899addd658f4f",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Index: Use prune blockers for blockfilterindex\" (7db7f26e97665c048b3f614c092899addd658f4f)\r\n\r\nI think it would be good if the commit message noted the minor change in behavior here: Previously pruning code would keep the blockfilter index best block and later blocks, and now an extra 10 previous blocks(PRUNE_BLOCKER_BUFFER) will be kept.",
    "created_at": "2021-09-23T18:33:43Z",
    "updated_at": "2021-09-23T19:39:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715054451",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715054451"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715054451"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715054451/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1954,
    "original_line": 1954,
    "side": "LEFT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715059159",
    "pull_request_review_id": 761541915,
    "id": 715059159,
    "node_id": "PRRC_kwDOABII584qnu_X",
    "diff_hunk": "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
    "path": "src/index/base.cpp",
    "position": 12,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Index: Skip pruning checks when node is not pruning\" (70b9e4f6abda5d6dd38504d9149ddc79b33961ce)\r\n\r\nWhat is the motivation for this commit? It just seems to be disabling error checking and making the code more complicated and interdependent. Is there a real performance benefit or some other reason to do this?",
    "created_at": "2021-09-23T18:40:49Z",
    "updated_at": "2021-09-23T19:39:38Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715059159",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715059159"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715059159"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715059159/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 70,
    "original_line": 70,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715093019",
    "pull_request_review_id": 761541915,
    "id": 715093019,
    "node_id": "PRRC_kwDOABII584qn3Qb",
    "diff_hunk": "@@ -1948,6 +1948,15 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                const int blocker_height = blocker.second->nHeight - PRUNE_BLOCKER_BUFFER;",
    "path": "src/validation.cpp",
    "position": 21,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "40ec224da2d1e389c6ef148beb27ae4c227b8b2b",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Index: Use prune blockers for blockfilterindex\" (7db7f26e97665c048b3f614c092899addd658f4f)\r\n\r\nI'm seeing a segfault this line starting in the \"Index: Use prune blockers\" commit and continuing up to the \"\"Index: Skip pruning checks\" commit in the `feature_blockfilterindex_prune.py` test because `blocker.second` is null. It would probably be good to not insert null prune blockers or just ignore them.\r\n\r\n```\r\n#0  0x000055555583d8a6 in CChainState::FlushStateToDisk (this=0x555555e46f10, state=..., mode=FlushStateMode::IF_NEEDED, nManualPruneHeight=0) at validation.cpp:1948\r\n#1  0x0000555555849e51 in CChainState::ConnectTip (this=0x555555e46f10, state=..., pindexNew=0x7fffac001000, pblock=..., connectTrace=..., disconnectpool=...) at validation.cpp:2288\r\n#2  0x000055555584f7f2 in CChainState::ActivateBestChainStep (this=0x555555e46f10, state=..., pindexMostWork=0x7fffac001000, pblock=std::shared_ptr<const CBlock> (empty) = {...}, fInvalidFound=@0x7fffa7ffe32f: false, connectTrace=...)\r\n    at validation.cpp:2432\r\n#3  0x000055555584fff8 in CChainState::ActivateBestChain (this=<optimized out>, state=..., pblock=std::shared_ptr<const CBlock> (empty) = {...}) at validation.cpp:2557\r\n#4  0x00005555556c77fd in ThreadImport (chainman=..., vImportFiles=std::vector of length 0, capacity 0, args=...) at node/blockstorage.cpp:555\r\n#5  0x0000555555633850 in operator() (__closure=0x7fffac000b60) at init.cpp:1656\r\n#6  std::__invoke_impl<void, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()>&> (__f=...) at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/invoke.h:60\r\n#7  std::__invoke_r<void, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()>&> (__fn=...) at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/invoke.h:110\r\n#8  std::_Function_handler<void(), AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> >::_M_invoke(const std::_Any_data &) (__functor=...)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/std_function.h:291\r\n#9  0x0000555555b0ef5f in std::function<void ()>::operator()() const (this=0x7fffa7ffeb70) at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/std_function.h:622\r\n#10 util::TraceThread(char const*, std::function<void ()>) (thread_name=<optimized out>, thread_func=...) at util/thread.cpp:18\r\n#11 0x000055555563376b in std::__invoke_impl<void, void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > (\r\n    __f=@0x555555e7f818: 0x555555b0edf0 <util::TraceThread(char const*, std::function<void ()>)>) at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/invoke.h:60\r\n#12 std::__invoke<void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > (__fn=@0x555555e7f818: 0x555555b0edf0 <util::TraceThread(char const*, std::function<void ()>)>)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/bits/invoke.h:95\r\n#13 std::thread::_Invoker<std::tuple<void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > >::_M_invoke<0, 1, 2> (this=0x555555e7f7e8)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/thread:264\r\n#14 std::thread::_Invoker<std::tuple<void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > >::operator() (this=0x555555e7f7e8)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/thread:271\r\n#15 std::thread::_State_impl<std::thread::_Invoker<std::tuple<void (*)(char const*, std::function<void()>), char const*, AppInitMain(NodeContext&, interfaces::BlockAndHeaderTipInfo*)::<lambda()> > > >::_M_run(void) (this=0x555555e7f7e0)\r\n    at /nix/store/5qjycalzb9sqzvqg65kf5zimqwjabm9g-gcc-10.3.0/include/c++/10.3.0/thread:215\r\n#16 0x00007ffff7eaaca0 in ?? () from /nix/store/dzaadhn5y56da24635icafv1nrawxm4n-gcc-10.3.0-lib/lib/../lib64/libstdc++.so.6\r\n#17 0x00007ffff7fb1e9e in start_thread () from /nix/store/gk42f59363p82rg2wv2mfy71jn5w4q4c-glibc-2.32-48/lib/libpthread.so.0\r\n#18 0x00007ffff774949f in clone () from /nix/store/gk42f59363p82rg2wv2mfy71jn5w4q4c-glibc-2.32-48/lib/libc.so.6\r\n```",
    "created_at": "2021-09-23T19:31:22Z",
    "updated_at": "2021-09-23T19:39:38Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715093019",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715093019"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r715093019"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/715093019/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1954,
    "original_line": 1954,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948137",
    "pull_request_review_id": 767267690,
    "id": 718948137,
    "node_id": "PRRC_kwDOABII584q2kcp",
    "diff_hunk": "@@ -48,6 +48,9 @@ extern uint64_t nPruneTarget;\n //! Check whether the block associated with this index entry is pruned or not.\n bool IsBlockPruned(const CBlockIndex* pblockindex);\n \n+//! Find the first block that is not pruned\n+const CBlockIndex* GetFirstStoredBlock(const CBlockIndex* start_block);",
    "path": "src/node/blockstorage.h",
    "position": 5,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "4ebe3a51da88589f23e243045a9e392701dfbbad",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "fixed",
    "created_at": "2021-09-29T23:18:33Z",
    "updated_at": "2021-09-29T23:18:33Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948137",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948137"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948137"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948137/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 52,
    "original_line": 52,
    "side": "RIGHT",
    "in_reply_to_id": 714427353
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948229",
    "pull_request_review_id": 767267785,
    "id": 718948229,
    "node_id": "PRRC_kwDOABII584q2keF",
    "diff_hunk": "@@ -369,3 +365,12 @@ IndexSummary BaseIndex::GetSummary() const\n     summary.best_block_height = m_best_block_index ? m_best_block_index.load()->nHeight : 0;\n     return summary;\n }\n+\n+void BaseIndex::SetBestBlockIndex(const CBlockIndex* block) {",
    "path": "src/index/base.cpp",
    "position": 80,
    "original_position": 80,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Added",
    "created_at": "2021-09-29T23:18:46Z",
    "updated_at": "2021-09-29T23:18:46Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948229",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948229"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948229"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948229/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 369,
    "original_line": 369,
    "side": "RIGHT",
    "in_reply_to_id": 715026559
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948310",
    "pull_request_review_id": 767267863,
    "id": 718948310,
    "node_id": "PRRC_kwDOABII584q2kfW",
    "diff_hunk": "@@ -1941,12 +1940,9 @@ bool CChainState::FlushStateToDisk(\n         CoinsCacheSizeState cache_state = GetCoinsCacheSizeState();\n         LOCK(cs_LastBlockFile);\n         if (fPruneMode && (fCheckForPruning || nManualPruneHeight > 0) && !fReindex) {\n-            // make sure we don't prune above the blockfilterindexes bestblocks\n+            // make sure we don't prune above any of the prune blockers bestblocks\n             // pruning is height-based\n             int last_prune = m_chain.Height(); // last height we can prune\n-            ForEachBlockFilterIndex([&](BlockFilterIndex& index) {\n-               last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));",
    "path": "src/validation.cpp",
    "position": 17,
    "original_position": 17,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "7db7f26e97665c048b3f614c092899addd658f4f",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Added a note in the commit message",
    "created_at": "2021-09-29T23:18:56Z",
    "updated_at": "2021-09-29T23:18:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948310",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948310"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948310"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948310/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1954,
    "original_line": 1954,
    "side": "LEFT",
    "in_reply_to_id": 715054451
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948387",
    "pull_request_review_id": 767267957,
    "id": 718948387,
    "node_id": "PRRC_kwDOABII584q2kgj",
    "diff_hunk": "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
    "path": "src/index/base.cpp",
    "position": 12,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I did not do performance tests on this change, it will probably not be huge but if we can get it, why not? But my main motivation is that I think that these checks are not necessary unless the conditions hold. I think it makes code easier to understand if sections that are not relevant are skipped explicitly. But I can see how this might be missing a comment for clarity, happy to add that if you agree.",
    "created_at": "2021-09-29T23:19:08Z",
    "updated_at": "2021-09-29T23:19:08Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948387",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948387"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718948387"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718948387/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 70,
    "original_line": 70,
    "side": "RIGHT",
    "in_reply_to_id": 715059159
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718949709",
    "pull_request_review_id": 767269509,
    "id": 718949709,
    "node_id": "PRRC_kwDOABII584q2k1N",
    "diff_hunk": "@@ -1948,6 +1948,15 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                const int blocker_height = blocker.second->nHeight - PRUNE_BLOCKER_BUFFER;",
    "path": "src/validation.cpp",
    "position": 21,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "40ec224da2d1e389c6ef148beb27ae4c227b8b2b",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Oh, TIL that `Genesis()` can return a `nullptr` and does so initially when reindexing. I never really checked and assumed this couldn't happen since the Genesis block is hardcoded. Well, good to know and this should be fixed now.",
    "created_at": "2021-09-29T23:22:40Z",
    "updated_at": "2021-09-29T23:22:40Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718949709",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718949709"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r718949709"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718949709/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1954,
    "original_line": 1954,
    "side": "RIGHT",
    "in_reply_to_id": 715093019
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719590304",
    "pull_request_review_id": 768112450,
    "id": 719590304,
    "node_id": "PRRC_kwDOABII584q5BOg",
    "diff_hunk": "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
    "path": "src/index/base.cpp",
    "position": 12,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> I think it makes code easier to understand if sections that are not relevant are skipped explicitly.\r\n\r\nI would love to visit the planet where `if (!m_synced && (fPruneMode || fHavePruned) && !fReindex)` is easier to understand than `if (!m_synced)`. In general I don't think code is easier to read with special cases, and all else equal I wouldn't think that skipping checks would be a great idea even if did make code simpler. But this isn't very important. Would suggest dropping this commit, but it seems fine to keep it or let others weigh in. Thanks at least for splitting this change up nicely so it is easy to understand in sequence.",
    "created_at": "2021-09-30T16:51:01Z",
    "updated_at": "2021-09-30T17:07:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r719590304",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719590304"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r719590304"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719590304/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 70,
    "original_line": 70,
    "side": "RIGHT",
    "in_reply_to_id": 715059159
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720875101",
    "pull_request_review_id": 769618940,
    "id": 720875101,
    "node_id": "PRRC_kwDOABII584q965d",
    "diff_hunk": "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
    "path": "src/index/base.cpp",
    "position": 12,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I agree with you that the line is harder to understand after the change but in exchange for that, it makes explicit that the code inside the block is only relevant and needs to run if this evaluates to true. Let's wait for more feedback as a tie-breaker, of course, I am happy to remove it if others agree with you :)",
    "created_at": "2021-10-03T19:25:36Z",
    "updated_at": "2021-10-03T19:25:36Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r720875101",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720875101"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r720875101"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720875101/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 70,
    "original_line": 70,
    "side": "RIGHT",
    "in_reply_to_id": 715059159
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722607995",
    "pull_request_review_id": 771922093,
    "id": 722607995,
    "node_id": "PRRC_kwDOABII584rEh97",
    "diff_hunk": "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
    "path": "src/index/base.cpp",
    "position": 12,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
    "user": {
      "login": "dergoegge",
      "id": 8077169,
      "node_id": "MDQ6VXNlcjgwNzcxNjk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8077169?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dergoegge",
      "html_url": "https://github.com/dergoegge",
      "followers_url": "https://api.github.com/users/dergoegge/followers",
      "following_url": "https://api.github.com/users/dergoegge/following{/other_user}",
      "gists_url": "https://api.github.com/users/dergoegge/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dergoegge/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dergoegge/subscriptions",
      "organizations_url": "https://api.github.com/users/dergoegge/orgs",
      "repos_url": "https://api.github.com/users/dergoegge/repos",
      "events_url": "https://api.github.com/users/dergoegge/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dergoegge/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> it makes explicit that the code inside the block is only relevant and needs to run if this evaluates to true\r\n\r\nI don't have a strong opinion but i agree with this statement and think the change should stay.",
    "created_at": "2021-10-05T19:53:30Z",
    "updated_at": "2021-10-05T19:53:30Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r722607995",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722607995"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r722607995"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722607995/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 70,
    "original_line": 70,
    "side": "RIGHT",
    "in_reply_to_id": 715059159
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723316569",
    "pull_request_review_id": 772759286,
    "id": 723316569,
    "node_id": "PRRC_kwDOABII584rHO9Z",
    "diff_hunk": "@@ -51,6 +51,15 @@ bool IsBlockPruned(const CBlockIndex* pblockindex)\n     return (fHavePruned && !(pblockindex->nStatus & BLOCK_HAVE_DATA) && pblockindex->nTx > 0);\n }\n \n+const CBlockIndex* GetFirstStoredBlock(const CBlockIndex* start_block) {\n+    CHECK_NONFATAL(start_block);\n+    const CBlockIndex* last_block = start_block;\n+    while (last_block->pprev && (last_block->pprev->nStatus & BLOCK_HAVE_DATA)) {",
    "path": "src/node/blockstorage.cpp",
    "position": 7,
    "original_position": 7,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Note to self, check if #22932 lock annotations/guards need to be updated if this pull is merged (at first look tentatively seems ok).",
    "created_at": "2021-10-06T14:09:25Z",
    "updated_at": "2021-10-06T15:50:15Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723316569",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723316569"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723316569"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723316569/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 57,
    "original_line": 57,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723322094",
    "pull_request_review_id": 772759286,
    "id": 723322094,
    "node_id": "PRRC_kwDOABII584rHQTu",
    "diff_hunk": "@@ -1031,7 +1031,7 @@ static RPCHelpMan pruneblockchain()\n             \"                  to prune blocks whose block time is at least 2 hours older than the provided timestamp.\"},\n                 },\n                 RPCResult{\n-                    RPCResult::Type::NUM, \"\", \"Height of the last block pruned\"},\n+                    RPCResult::Type::NUM, \"\", \"Height of the first block that is still stored after pruning\"},",
    "path": "src/rpc/blockchain.cpp",
    "position": 5,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "19c360e\r\n```suggestion\r\n                    RPCResult::Type::NUM, \"\", \"The height of the first block that is still stored after pruning.\"},\r\n```",
    "created_at": "2021-10-06T14:14:56Z",
    "updated_at": "2021-10-06T15:50:15Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723322094",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723322094"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723322094"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723322094/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1034,
    "original_line": 1034,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723323453",
    "pull_request_review_id": 772759286,
    "id": 723323453,
    "node_id": "PRRC_kwDOABII584rHQo9",
    "diff_hunk": "@@ -88,6 +88,8 @@ static const unsigned int DEFAULT_CHECKLEVEL = 3;\n // one 128MB block file + added 15% undo data = 147MB greater for a total of 545MB\n // Setting the target to >= 550 MiB will make it likely we can respect the target.\n static const uint64_t MIN_DISK_SPACE_FOR_BLOCK_FILES = 550 * 1024 * 1024;\n+/** Blocks to keep below deepest prune blocker */",
    "path": "src/validation.h",
    "position": 4,
    "original_position": 4,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "18e768f\r\n```suggestion\r\n/** The number of blocks to keep below the deepest prune blocker. */\r\n```",
    "created_at": "2021-10-06T14:16:06Z",
    "updated_at": "2021-10-06T15:50:15Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723323453",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723323453"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723323453"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723323453/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 91,
    "original_line": 91,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723329132",
    "pull_request_review_id": 772759286,
    "id": 723329132,
    "node_id": "PRRC_kwDOABII584rHSBs",
    "diff_hunk": "@@ -3594,6 +3599,11 @@ void BlockManager::FindFilesToPrune(std::set<int>& setFilesToPrune, uint64_t nPr\n            nLastBlockWeCanPrune, count);\n }\n \n+void BlockManager::UpdatePruneBlocker(const std::string& name, const CBlockIndex* block) {\n+    AssertLockHeld(::cs_main);\n+    m_prune_blockers[name] = block;",
    "path": "src/validation.cpp",
    "position": 37,
    "original_position": 37,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "18e768f Perhaps just inline this one-line function.",
    "created_at": "2021-10-06T14:21:16Z",
    "updated_at": "2021-10-06T15:50:15Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723329132",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723329132"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723329132"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723329132/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3604,
    "original_line": 3604,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723340964",
    "pull_request_review_id": 772759286,
    "id": 723340964,
    "node_id": "PRRC_kwDOABII584rHU6k",
    "diff_hunk": "@@ -480,6 +482,16 @@ class BlockManager\n      */\n     int GetSpendHeight(const CCoinsViewCache& inputs) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n+    /**\n+     * Map from external index name to most recent block the index can tolerate being pruned.\n+     *\n+     * @note Internally, only blocks at height (block->nHeight - PRUNE_BLOCKER_BUFFER) and\n+     * below will be pruned, but callers should avoid assuming any particular buffer size.\n+     */\n+    std::unordered_map<std::string, const CBlockIndex*> m_prune_blockers GUARDED_BY(::cs_main);",
    "path": "src/validation.h",
    "position": 19,
    "original_position": 19,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "18e768f missing headers for `unordered_map` and `std::min/max` in this commit\r\n```diff\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -54,9 +54,11 @@\r\n #include <warnings.h>\r\n \r\n+#include <algorithm>\r\n #include <numeric>\r\n #include <optional>\r\n #include <string>\r\n+#include <unordered_map>\r\n\r\n--- a/src/validation.h\r\n+++ b/src/validation.h\r\n@@ -34,6 +34,7 @@\r\n #include <thread>\r\n+#include <unordered_map>\r\n #include <utility>\r\n```\r\n",
    "created_at": "2021-10-06T14:33:02Z",
    "updated_at": "2021-10-06T15:50:15Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723340964",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723340964"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723340964"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723340964/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 491,
    "original_line": 491,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723343409",
    "pull_request_review_id": 772759286,
    "id": 723343409,
    "node_id": "PRRC_kwDOABII584rHVgx",
    "diff_hunk": "@@ -1948,6 +1948,15 @@ bool CChainState::FlushStateToDisk(\n                last_prune = std::max(1, std::min(last_prune, index.GetSummary().best_block_height));\n             });\n \n+            for (auto const& blocker : m_blockman.m_prune_blockers) {\n+                const int blocker_height = blocker.second->nHeight - PRUNE_BLOCKER_BUFFER;",
    "path": "src/validation.cpp",
    "position": 21,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "40ec224da2d1e389c6ef148beb27ae4c227b8b2b",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "18e768f style nits and missing space\r\n```diff\r\n-            for (auto const& blocker : m_blockman.m_prune_blockers) {\r\n-                const int blocker_height = blocker.second->nHeight - PRUNE_BLOCKER_BUFFER;\r\n+            for (const auto& blocker : m_blockman.m_prune_blockers) {\r\n+                const int blocker_height{blocker.second->nHeight - PRUNE_BLOCKER_BUFFER};\r\n                 if (last_prune == blocker_height) {\r\n-                    LogPrint(BCLog::PRUNE,\"%s limited pruning to height %d\\n\", blocker.first, blocker_height);\r\n+                    LogPrint(BCLog::PRUNE, \"%s limited pruning to height %d\\n\", blocker.first, blocker_height);\r\n```\r\n",
    "created_at": "2021-10-06T14:35:21Z",
    "updated_at": "2021-10-06T15:50:15Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723343409",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723343409"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723343409"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723343409/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1954,
    "original_line": 1954,
    "side": "RIGHT",
    "in_reply_to_id": 715093019
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723377801",
    "pull_request_review_id": 772759286,
    "id": 723377801,
    "node_id": "PRRC_kwDOABII584rHd6J",
    "diff_hunk": "@@ -0,0 +1,132 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)",
    "path": "test/functional/feature_index_prune.py",
    "position": 46,
    "original_position": 46,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "1b51e212 see #22741\r\n```suggestion\r\n            self.generate(self.nodes[0], 250)\r\n```",
    "created_at": "2021-10-06T15:08:42Z",
    "updated_at": "2021-10-06T15:50:15Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723377801",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723377801"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723377801"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723377801/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 46,
    "original_line": 46,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723411364",
    "pull_request_review_id": 772759286,
    "id": 723411364,
    "node_id": "PRRC_kwDOABII584rHmGk",
    "diff_hunk": "@@ -67,7 +67,7 @@ bool BaseIndex::Init()\n         SetBestBlockIndex(m_chainstate->m_blockman.FindForkInGlobalIndex(active_chain, locator));\n     }\n     m_synced = m_best_block_index.load() == active_chain.Tip();\n-    if (!m_synced) {\n+    if (!m_synced && (fPruneMode || fHavePruned) && !fReindex) {",
    "path": "src/index/base.cpp",
    "position": 12,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "70b9e4f6abda5d6dd38504d9149ddc79b33961ce",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "86121153164a05a5d not sure, but it seems there should be a demonstrated clear improvement and documentation of the intention in both places.",
    "created_at": "2021-10-06T15:43:31Z",
    "updated_at": "2021-10-07T14:54:08Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723411364",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723411364"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723411364"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723411364/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 70,
    "original_line": 70,
    "side": "RIGHT",
    "in_reply_to_id": 715059159
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723429759",
    "pull_request_review_id": 772934310,
    "id": 723429759,
    "node_id": "PRRC_kwDOABII584rHql_",
    "diff_hunk": "@@ -310,7 +310,7 @@\n     'feature_help.py',\n     'feature_shutdown.py',\n     'p2p_ibd_txrelay.py',\n-    'feature_blockfilterindex_prune.py'\n+    'feature_index_prune.py'",
    "path": "test/functional/test_runner.py",
    "position": 5,
    "original_position": 5,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This test is now time-consuming enough (16 minutes for me locally) that it might be best to place it in the extended scripts. Or at least, at the top (rather than the bottom) of the base scripts. Even better, find a way to speed it up :)\r\n```python\r\nEXTENDED_SCRIPTS = [\r\n    # These tests are not run by default.\r\n    # Longest test should go first, to favor running tests in parallel\r\n    'feature_pruning.py',\r\n    'feature_dbcrash.py',\r\n]\r\n\r\nBASE_SCRIPTS = [\r\n    # Scripts that are run by default.\r\n    # Longest test should go first, to favor running tests in parallel\r\n```\r\n```\r\n$ test/functional/feature_index_prune.py --timeout-factor=0\r\n2021-10-06T15:50:22.006000Z TestFramework (INFO): Initializing test directory /tmp/bitcoin_func_test_arh_064q\r\n2021-10-06T15:50:23.815000Z TestFramework (INFO): check if we can access blockfilters and coinstats when pruning is enabled but no blocks are actually pruned\r\n2021-10-06T15:54:06.653000Z TestFramework (INFO): prune some blocks\r\n2021-10-06T15:54:06.656000Z TestFramework (INFO): check if we can access the tips blockfilter and coinstats when we have pruned some blocks\r\n2021-10-06T15:54:06.732000Z TestFramework (INFO): check if we can access the blockfilter and coinstats of a pruned block\r\n2021-10-06T15:54:06.767000Z TestFramework (INFO): restart nodes without indices\r\n2021-10-06T15:54:09.197000Z TestFramework (INFO): make sure trying to access the indices throws errors\r\n2021-10-06T15:55:15.675000Z TestFramework (INFO): prune further than the indices best blocks while the indices are disabled\r\n2021-10-06T15:55:16.536000Z TestFramework (INFO): make sure we get an init error when starting the nodes again with the indices\r\n2021-10-06T15:55:18.413000Z TestFramework (INFO): make sure the nodes start again with the indices and an additional -reindex arg\r\n2021-10-06T16:06:34.500000Z TestFramework (INFO): Stopping nodes\r\n2021-10-06T16:06:35.271000Z TestFramework (INFO): Cleaning up /tmp/bitcoin_func_test_arh_064q on exit\r\n2021-10-06T16:06:35.271000Z TestFramework (INFO): Tests successful\r\n```\r\n",
    "created_at": "2021-10-06T15:59:24Z",
    "updated_at": "2021-10-07T14:53:19Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723429759",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723429759"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r723429759"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/723429759/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 313,
    "original_line": 313,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745556769",
    "pull_request_review_id": 801198814,
    "id": 745556769,
    "node_id": "PRRC_kwDOABII584scEsh",
    "diff_hunk": "@@ -0,0 +1,132 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2020-2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test indices in conjunction with prune.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    assert_greater_than,\n+    assert_raises_rpc_error,\n+    p2p_port,\n+)\n+\n+\n+class FeatureIndexPruneTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 4\n+        self.extra_args = [\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-coinstatsindex=1\"],\n+            [\"-fastprune\", \"-prune=1\", \"-blockfilterindex=1\", \"-coinstatsindex=1\"],\n+            []\n+        ]\n+\n+    def sync_index(self, height):\n+        expected_filter = {\n+            'basic block filter index': {'synced': True, 'best_block_height': height},\n+        }\n+        self.wait_until(lambda: self.nodes[0].getindexinfo() == expected_filter)\n+\n+        expected_stats = {\n+            'coinstatsindex': {'synced': True, 'best_block_height': height}\n+        }\n+        self.wait_until(lambda: self.nodes[1].getindexinfo() == expected_stats)\n+\n+        expected = {**expected_filter, **expected_stats}\n+        self.wait_until(lambda: self.nodes[2].getindexinfo() == expected)\n+\n+    def reconnect_nodes(self):\n+        self.connect_nodes(0,1)\n+        self.connect_nodes(0,2)\n+        self.connect_nodes(0,3)\n+\n+    def mine_batches(self, n):\n+        for _ in range(n):\n+            self.nodes[0].generate(250)",
    "path": "test/functional/feature_index_prune.py",
    "position": 46,
    "original_position": 46,
    "commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "original_commit_id": "86121153164a05a5da9812010f0bfdab434bec1f",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "still not fixed?",
    "created_at": "2021-11-09T12:10:25Z",
    "updated_at": "2021-11-09T12:10:25Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r745556769",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745556769"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/21726#discussion_r745556769"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/21726"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745556769/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 46,
    "original_line": 46,
    "side": "RIGHT",
    "in_reply_to_id": 723377801
  }
]