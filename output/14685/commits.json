[
  {
    "sha": "051faf7e9d4e32142f95f7adb31d2f53f656cb66",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowNTFmYWY3ZTlkNGUzMjE0MmY5NWY3YWRiMzFkMmY1M2Y2NTZjYjY2",
    "commit": {
      "author": {
        "name": "Kaz Wesley",
        "email": "kaz@lambdaverse.org",
        "date": "2018-11-07T20:36:23Z"
      },
      "committer": {
        "name": "Kaz Wesley",
        "email": "kaz@lambdaverse.org",
        "date": "2018-11-13T20:14:08Z"
      },
      "message": "add a test demonstrating an overflow in a deserialization edge case\n\nAlso add a test that the highest legal index is accepted.",
      "tree": {
        "sha": "3cce376c8d783885ae54e5c6ef80112e79625083",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3cce376c8d783885ae54e5c6ef80112e79625083"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/051faf7e9d4e32142f95f7adb31d2f53f656cb66",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/051faf7e9d4e32142f95f7adb31d2f53f656cb66",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/051faf7e9d4e32142f95f7adb31d2f53f656cb66",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/051faf7e9d4e32142f95f7adb31d2f53f656cb66/comments",
    "author": {
      "login": "kazcw",
      "id": 1047859,
      "node_id": "MDQ6VXNlcjEwNDc4NTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1047859?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kazcw",
      "html_url": "https://github.com/kazcw",
      "followers_url": "https://api.github.com/users/kazcw/followers",
      "following_url": "https://api.github.com/users/kazcw/following{/other_user}",
      "gists_url": "https://api.github.com/users/kazcw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kazcw/subscriptions",
      "organizations_url": "https://api.github.com/users/kazcw/orgs",
      "repos_url": "https://api.github.com/users/kazcw/repos",
      "events_url": "https://api.github.com/users/kazcw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kazcw/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "kazcw",
      "id": 1047859,
      "node_id": "MDQ6VXNlcjEwNDc4NTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1047859?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kazcw",
      "html_url": "https://github.com/kazcw",
      "followers_url": "https://api.github.com/users/kazcw/followers",
      "following_url": "https://api.github.com/users/kazcw/following{/other_user}",
      "gists_url": "https://api.github.com/users/kazcw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kazcw/subscriptions",
      "organizations_url": "https://api.github.com/users/kazcw/orgs",
      "repos_url": "https://api.github.com/users/kazcw/repos",
      "events_url": "https://api.github.com/users/kazcw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kazcw/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "d26d15c6c89ad02c0a951d5242bcdd3f29096a31",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d26d15c6c89ad02c0a951d5242bcdd3f29096a31",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/d26d15c6c89ad02c0a951d5242bcdd3f29096a31"
      }
    ],
    "stats": {
      "total": 45,
      "additions": 45,
      "deletions": 0
    },
    "files": [
      {
        "sha": "309b8d2d060342138bc71537adc61d2b2d742ef3",
        "filename": "src/test/blockencodings_tests.cpp",
        "status": "modified",
        "additions": 45,
        "deletions": 0,
        "changes": 45,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/051faf7e9d4e32142f95f7adb31d2f53f656cb66/src/test/blockencodings_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/051faf7e9d4e32142f95f7adb31d2f53f656cb66/src/test/blockencodings_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/blockencodings_tests.cpp?ref=051faf7e9d4e32142f95f7adb31d2f53f656cb66",
        "patch": "@@ -344,4 +344,49 @@ BOOST_AUTO_TEST_CASE(TransactionsRequestSerializationTest) {\n     BOOST_CHECK_EQUAL(req1.indexes[3], req2.indexes[3]);\n }\n \n+BOOST_AUTO_TEST_CASE(TransactionsRequestDeserializationMaxTest) {\n+    // Check that the highest legal index is decoded correctly\n+    BlockTransactionsRequest req0;\n+    req0.blockhash = InsecureRand256();\n+    req0.indexes.resize(1);\n+    req0.indexes[0] = 0xffff;\n+    CDataStream stream(SER_NETWORK, PROTOCOL_VERSION);\n+    stream << req0;\n+\n+    BlockTransactionsRequest req1;\n+    stream >> req1;\n+    BOOST_CHECK_EQUAL(req0.indexes.size(), req1.indexes.size());\n+    BOOST_CHECK_EQUAL(req0.indexes[0], req1.indexes[0]);\n+}\n+\n+BOOST_AUTO_TEST_CASE(TransactionsRequestDeserializationOverflowTest) {\n+    // Any set of index deltas that starts with N values that sum to (0x10000 - N)\n+    // causes the edge-case overflow that was originally not checked for. Such\n+    // a request cannot be created by serializing a real BlockTransactionsRequest\n+    // due to the overflow, so here we'll serialize from raw deltas.\n+    BlockTransactionsRequest req0;\n+    req0.blockhash = InsecureRand256();\n+    req0.indexes.resize(3);\n+    req0.indexes[0] = 0x7000;\n+    req0.indexes[1] = 0x10000 - 0x7000 - 2;\n+    req0.indexes[2] = 0;\n+    CDataStream stream(SER_NETWORK, PROTOCOL_VERSION);\n+    stream << req0.blockhash;\n+    WriteCompactSize(stream, req0.indexes.size());\n+    WriteCompactSize(stream, req0.indexes[0]);\n+    WriteCompactSize(stream, req0.indexes[1]);\n+    WriteCompactSize(stream, req0.indexes[2]);\n+\n+    BlockTransactionsRequest req1;\n+    try {\n+        stream >> req1;\n+        // before patch: deserialize above succeeds and this check fails, demonstrating the overflow\n+        BOOST_CHECK(req1.indexes[1] < req1.indexes[2]);\n+        // this shouldn't be reachable before or after patch\n+        BOOST_CHECK(0);\n+    } catch(std::ios_base::failure &) {\n+        // deserialize should fail\n+    }\n+}\n+\n BOOST_AUTO_TEST_SUITE_END()"
      }
    ]
  },
  {
    "sha": "6bed4b374daf26233e96fa7863d4324a5bfa99c2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2YmVkNGIzNzRkYWYyNjIzM2U5NmZhNzg2M2Q0MzI0YTViZmE5OWMy",
    "commit": {
      "author": {
        "name": "Kaz Wesley",
        "email": "kaz@lambdaverse.org",
        "date": "2018-11-07T20:39:44Z"
      },
      "committer": {
        "name": "Kaz Wesley",
        "email": "kaz@lambdaverse.org",
        "date": "2018-11-13T20:14:34Z"
      },
      "message": "fix a deserialization overflow edge case\n\nA specially-constructed BlockTransactionsRequest can overflow in\ndeserialization in a way that is currently harmless.",
      "tree": {
        "sha": "36b4b7ce50c50ce97b931c0cea37c25e1d09a0c8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/36b4b7ce50c50ce97b931c0cea37c25e1d09a0c8"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6bed4b374daf26233e96fa7863d4324a5bfa99c2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6bed4b374daf26233e96fa7863d4324a5bfa99c2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/6bed4b374daf26233e96fa7863d4324a5bfa99c2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6bed4b374daf26233e96fa7863d4324a5bfa99c2/comments",
    "author": {
      "login": "kazcw",
      "id": 1047859,
      "node_id": "MDQ6VXNlcjEwNDc4NTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1047859?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kazcw",
      "html_url": "https://github.com/kazcw",
      "followers_url": "https://api.github.com/users/kazcw/followers",
      "following_url": "https://api.github.com/users/kazcw/following{/other_user}",
      "gists_url": "https://api.github.com/users/kazcw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kazcw/subscriptions",
      "organizations_url": "https://api.github.com/users/kazcw/orgs",
      "repos_url": "https://api.github.com/users/kazcw/repos",
      "events_url": "https://api.github.com/users/kazcw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kazcw/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "kazcw",
      "id": 1047859,
      "node_id": "MDQ6VXNlcjEwNDc4NTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1047859?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kazcw",
      "html_url": "https://github.com/kazcw",
      "followers_url": "https://api.github.com/users/kazcw/followers",
      "following_url": "https://api.github.com/users/kazcw/following{/other_user}",
      "gists_url": "https://api.github.com/users/kazcw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kazcw/subscriptions",
      "organizations_url": "https://api.github.com/users/kazcw/orgs",
      "repos_url": "https://api.github.com/users/kazcw/repos",
      "events_url": "https://api.github.com/users/kazcw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kazcw/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "051faf7e9d4e32142f95f7adb31d2f53f656cb66",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/051faf7e9d4e32142f95f7adb31d2f53f656cb66",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/051faf7e9d4e32142f95f7adb31d2f53f656cb66"
      }
    ],
    "stats": {
      "total": 6,
      "additions": 3,
      "deletions": 3
    },
    "files": [
      {
        "sha": "4bfe538250ced3f9d595eb80c2f381dad2e29167",
        "filename": "src/blockencodings.h",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6bed4b374daf26233e96fa7863d4324a5bfa99c2/src/blockencodings.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6bed4b374daf26233e96fa7863d4324a5bfa99c2/src/blockencodings.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/blockencodings.h?ref=6bed4b374daf26233e96fa7863d4324a5bfa99c2",
        "patch": "@@ -52,12 +52,12 @@ class BlockTransactionsRequest {\n                 }\n             }\n \n-            uint16_t offset = 0;\n+            int32_t offset = 0;\n             for (size_t j = 0; j < indexes.size(); j++) {\n-                if (uint64_t(indexes[j]) + uint64_t(offset) > std::numeric_limits<uint16_t>::max())\n+                if (int32_t(indexes[j]) + offset > std::numeric_limits<uint16_t>::max())\n                     throw std::ios_base::failure(\"indexes overflowed 16 bits\");\n                 indexes[j] = indexes[j] + offset;\n-                offset = indexes[j] + 1;\n+                offset = int32_t(indexes[j]) + 1;\n             }\n         } else {\n             for (size_t i = 0; i < indexes.size(); i++) {"
      }
    ]
  },
  {
    "sha": "b08af10fb299dc3fdcd1f022619fb112c72e5d8e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiMDhhZjEwZmIyOTlkYzNmZGNkMWYwMjI2MTlmYjExMmM3MmU1ZDhl",
    "commit": {
      "author": {
        "name": "Kaz Wesley",
        "email": "kaz@lambdaverse.org",
        "date": "2018-11-13T20:40:22Z"
      },
      "committer": {
        "name": "Kaz Wesley",
        "email": "kaz@lambdaverse.org",
        "date": "2018-11-13T20:41:41Z"
      },
      "message": "disallow oversized CBlockHeaderAndShortTxIDs\n\nOtherwise we'd reply with a bogus BlockTransactionsRequest trying to\nrequest indexes with overflowed deltas.",
      "tree": {
        "sha": "304484e3afe39caca10281baf70e3f4e66a9490c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/304484e3afe39caca10281baf70e3f4e66a9490c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b08af10fb299dc3fdcd1f022619fb112c72e5d8e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b08af10fb299dc3fdcd1f022619fb112c72e5d8e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b08af10fb299dc3fdcd1f022619fb112c72e5d8e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b08af10fb299dc3fdcd1f022619fb112c72e5d8e/comments",
    "author": {
      "login": "kazcw",
      "id": 1047859,
      "node_id": "MDQ6VXNlcjEwNDc4NTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1047859?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kazcw",
      "html_url": "https://github.com/kazcw",
      "followers_url": "https://api.github.com/users/kazcw/followers",
      "following_url": "https://api.github.com/users/kazcw/following{/other_user}",
      "gists_url": "https://api.github.com/users/kazcw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kazcw/subscriptions",
      "organizations_url": "https://api.github.com/users/kazcw/orgs",
      "repos_url": "https://api.github.com/users/kazcw/repos",
      "events_url": "https://api.github.com/users/kazcw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kazcw/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "kazcw",
      "id": 1047859,
      "node_id": "MDQ6VXNlcjEwNDc4NTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1047859?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/kazcw",
      "html_url": "https://github.com/kazcw",
      "followers_url": "https://api.github.com/users/kazcw/followers",
      "following_url": "https://api.github.com/users/kazcw/following{/other_user}",
      "gists_url": "https://api.github.com/users/kazcw/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/kazcw/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/kazcw/subscriptions",
      "organizations_url": "https://api.github.com/users/kazcw/orgs",
      "repos_url": "https://api.github.com/users/kazcw/repos",
      "events_url": "https://api.github.com/users/kazcw/events{/privacy}",
      "received_events_url": "https://api.github.com/users/kazcw/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6bed4b374daf26233e96fa7863d4324a5bfa99c2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6bed4b374daf26233e96fa7863d4324a5bfa99c2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6bed4b374daf26233e96fa7863d4324a5bfa99c2"
      }
    ],
    "stats": {
      "total": 3,
      "additions": 3,
      "deletions": 0
    },
    "files": [
      {
        "sha": "0c2b83ebcfafec942725fb5accc0236e2088f0ba",
        "filename": "src/blockencodings.h",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b08af10fb299dc3fdcd1f022619fb112c72e5d8e/src/blockencodings.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b08af10fb299dc3fdcd1f022619fb112c72e5d8e/src/blockencodings.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/blockencodings.h?ref=b08af10fb299dc3fdcd1f022619fb112c72e5d8e",
        "patch": "@@ -186,6 +186,9 @@ class CBlockHeaderAndShortTxIDs {\n \n         READWRITE(prefilledtxn);\n \n+        if (BlockTxCount() > std::numeric_limits<uint16_t>::max())\n+            throw std::ios_base::failure(\"indexes overflowed 16 bits\");\n+\n         if (ser_action.ForRead())\n             FillShortTxIDSelector();\n     }"
      }
    ]
  }
]