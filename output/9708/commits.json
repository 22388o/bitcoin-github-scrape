[
  {
    "sha": "321d0fc6b6624c65508f8b9059418cb936f0bbbe",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozMjFkMGZjNmI2NjI0YzY1NTA4ZjhiOTA1OTQxOGNiOTM2ZjBiYmJl",
    "commit": {
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2017-02-06T07:34:57Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-10T16:32:39Z"
      },
      "message": "net: fix a few races. Credit @TheBlueMatt\n\nThese are (afaik) all long-standing races or concurrent accesses. Going\nforward, we can clean these up so that they're not all individual atomic\naccesses.\n\n- Reintroduce cs_vRecv to guard receive-specific vars\n- Lock vRecv/vSend for CNodeStats\n- Make some vars atomic.\n- Only set the connection time in CNode's constructor so that it doesn't change",
      "tree": {
        "sha": "57a99a1ede16e5449db2d230ddbc7a3b561547be",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/57a99a1ede16e5449db2d230ddbc7a3b561547be"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/321d0fc6b6624c65508f8b9059418cb936f0bbbe",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/321d0fc6b6624c65508f8b9059418cb936f0bbbe",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/321d0fc6b6624c65508f8b9059418cb936f0bbbe",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/321d0fc6b6624c65508f8b9059418cb936f0bbbe/comments",
    "author": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "2447c1024e6069bfe62ddff65c4e1aaf28f32b38",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2447c1024e6069bfe62ddff65c4e1aaf28f32b38",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/2447c1024e6069bfe62ddff65c4e1aaf28f32b38"
      }
    ],
    "stats": {
      "total": 37,
      "additions": 22,
      "deletions": 15
    },
    "files": [
      {
        "sha": "c96ca469ff62eb8e1686e173333bed71e01d2bec",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 11,
        "deletions": 5,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/321d0fc6b6624c65508f8b9059418cb936f0bbbe/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/321d0fc6b6624c65508f8b9059418cb936f0bbbe/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=321d0fc6b6624c65508f8b9059418cb936f0bbbe",
        "patch": "@@ -389,7 +389,6 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n         uint64_t nonce = GetDeterministicRandomizer(RANDOMIZER_ID_LOCALHOSTNONCE).Write(id).Finalize();\n         CNode* pnode = new CNode(id, nLocalServices, GetBestHeight(), hSocket, addrConnect, CalculateKeyedNetGroup(addrConnect), nonce, pszDest ? pszDest : \"\", false);\n         pnode->nServicesExpected = ServiceFlags(addrConnect.nServices & nRelevantServices);\n-        pnode->nTimeConnected = GetSystemTimeInSeconds();\n         pnode->AddRef();\n \n         return pnode;\n@@ -612,10 +611,16 @@ void CNode::copyStats(CNodeStats &stats)\n     X(fInbound);\n     X(fAddnode);\n     X(nStartingHeight);\n-    X(nSendBytes);\n-    X(mapSendBytesPerMsgCmd);\n-    X(nRecvBytes);\n-    X(mapRecvBytesPerMsgCmd);\n+    {\n+        LOCK(cs_vSend);\n+        X(mapSendBytesPerMsgCmd);\n+        X(nSendBytes);\n+    }\n+    {\n+        LOCK(cs_vRecv);\n+        X(mapRecvBytesPerMsgCmd);\n+        X(nRecvBytes);\n+    }\n     X(fWhitelisted);\n \n     // It is common for nodes with good ping times to suddenly become lagged,\n@@ -643,6 +648,7 @@ bool CNode::ReceiveMsgBytes(const char *pch, unsigned int nBytes, bool& complete\n {\n     complete = false;\n     int64_t nTimeMicros = GetTimeMicros();\n+    LOCK(cs_vRecv);\n     nLastRecv = nTimeMicros / 1000000;\n     nRecvBytes += nBytes;\n     while (nBytes > 0) {"
      },
      {
        "sha": "89501c764e50abb2bdd82d9927dd9a9aacbcc949",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 10,
        "deletions": 9,
        "changes": 19,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/321d0fc6b6624c65508f8b9059418cb936f0bbbe/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/321d0fc6b6624c65508f8b9059418cb936f0bbbe/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=321d0fc6b6624c65508f8b9059418cb936f0bbbe",
        "patch": "@@ -573,6 +573,7 @@ class CNode\n     std::deque<std::vector<unsigned char>> vSendMsg;\n     CCriticalSection cs_vSend;\n     CCriticalSection cs_hSocket;\n+    CCriticalSection cs_vRecv;\n \n     CCriticalSection cs_vProcessMsg;\n     std::list<CNetMessage> vProcessMsg;\n@@ -584,10 +585,10 @@ class CNode\n     uint64_t nRecvBytes;\n     std::atomic<int> nRecvVersion;\n \n-    int64_t nLastSend;\n-    int64_t nLastRecv;\n+    std::atomic<int64_t> nLastSend;\n+    std::atomic<int64_t> nLastRecv;\n     int64_t nTimeConnected;\n-    int64_t nTimeOffset;\n+    std::atomic<int64_t> nTimeOffset;\n     const CAddress addr;\n     std::string addrName;\n     CService addrLocal;\n@@ -614,7 +615,7 @@ class CNode\n     CSemaphoreGrant grantOutbound;\n     CCriticalSection cs_filter;\n     CBloomFilter* pfilter;\n-    int nRefCount;\n+    std::atomic<int> nRefCount;\n     const NodeId id;\n \n     const uint64_t nKeyedNetGroup;\n@@ -665,15 +666,15 @@ class CNode\n \n     // Ping time measurement:\n     // The pong reply we're expecting, or 0 if no pong expected.\n-    uint64_t nPingNonceSent;\n+    std::atomic<uint64_t> nPingNonceSent;\n     // Time (in usec) the last ping was sent, or 0 if no ping was ever sent.\n-    int64_t nPingUsecStart;\n+    std::atomic<int64_t> nPingUsecStart;\n     // Last measured round-trip time.\n-    int64_t nPingUsecTime;\n+    std::atomic<int64_t> nPingUsecTime;\n     // Best measured round-trip time.\n-    int64_t nMinPingUsecTime;\n+    std::atomic<int64_t> nMinPingUsecTime;\n     // Whether a ping is requested.\n-    bool fPingQueued;\n+    std::atomic<bool> fPingQueued;\n     // Minimum fee rate with which to filter inv's to this node\n     CAmount minFeeFilter;\n     CCriticalSection cs_feeFilter;"
      },
      {
        "sha": "e89a897bd544df74b5444fe706422ea2ab4f3bfe",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/321d0fc6b6624c65508f8b9059418cb936f0bbbe/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/321d0fc6b6624c65508f8b9059418cb936f0bbbe/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=321d0fc6b6624c65508f8b9059418cb936f0bbbe",
        "patch": "@@ -2450,7 +2450,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                     if (pingUsecTime > 0) {\n                         // Successful ping time measurement, replace previous\n                         pfrom->nPingUsecTime = pingUsecTime;\n-                        pfrom->nMinPingUsecTime = std::min(pfrom->nMinPingUsecTime, pingUsecTime);\n+                        pfrom->nMinPingUsecTime = std::min(pfrom->nMinPingUsecTime.load(), pingUsecTime);\n                     } else {\n                         // This should never happen\n                         sProblem = \"Timing mishap\";"
      }
    ]
  },
  {
    "sha": "644f1234e22626a7b5618a1dae60a8457a4063b1",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2NDRmMTIzNGUyMjYyNmE3YjU2MThhMWRhZTYwYTg0NTdhNDA2M2Ix",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-06T16:42:49Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-10T16:32:40Z"
      },
      "message": "Make nTimeConnected const in CNode",
      "tree": {
        "sha": "1126ea900c892ed9ec77b62e11640e18bd5f7c0a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1126ea900c892ed9ec77b62e11640e18bd5f7c0a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/644f1234e22626a7b5618a1dae60a8457a4063b1",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/644f1234e22626a7b5618a1dae60a8457a4063b1",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/644f1234e22626a7b5618a1dae60a8457a4063b1",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/644f1234e22626a7b5618a1dae60a8457a4063b1/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "321d0fc6b6624c65508f8b9059418cb936f0bbbe",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/321d0fc6b6624c65508f8b9059418cb936f0bbbe",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/321d0fc6b6624c65508f8b9059418cb936f0bbbe"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 2,
      "deletions": 2
    },
    "files": [
      {
        "sha": "0e6e00d58b7216511b7a979510f770b16c94df80",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/644f1234e22626a7b5618a1dae60a8457a4063b1/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/644f1234e22626a7b5618a1dae60a8457a4063b1/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=644f1234e22626a7b5618a1dae60a8457a4063b1",
        "patch": "@@ -2574,6 +2574,7 @@ unsigned int CConnman::GetReceiveFloodSize() const { return nReceiveFloodSize; }\n unsigned int CConnman::GetSendBufferSize() const{ return nSendBufferMaxSize; }\n \n CNode::CNode(NodeId idIn, ServiceFlags nLocalServicesIn, int nMyStartingHeightIn, SOCKET hSocketIn, const CAddress& addrIn, uint64_t nKeyedNetGroupIn, uint64_t nLocalHostNonceIn, const std::string& addrNameIn, bool fInboundIn) :\n+    nTimeConnected(GetSystemTimeInSeconds()),\n     addr(addrIn),\n     fInbound(fInboundIn),\n     id(idIn),\n@@ -2593,7 +2594,6 @@ CNode::CNode(NodeId idIn, ServiceFlags nLocalServicesIn, int nMyStartingHeightIn\n     nLastRecv = 0;\n     nSendBytes = 0;\n     nRecvBytes = 0;\n-    nTimeConnected = GetSystemTimeInSeconds();\n     nTimeOffset = 0;\n     addrName = addrNameIn == \"\" ? addr.ToStringIPPort() : addrNameIn;\n     nVersion = 0;"
      },
      {
        "sha": "4bbcfac88b13b0745516a409e111017d6792c006",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/644f1234e22626a7b5618a1dae60a8457a4063b1/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/644f1234e22626a7b5618a1dae60a8457a4063b1/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=644f1234e22626a7b5618a1dae60a8457a4063b1",
        "patch": "@@ -587,7 +587,7 @@ class CNode\n \n     std::atomic<int64_t> nLastSend;\n     std::atomic<int64_t> nLastRecv;\n-    int64_t nTimeConnected;\n+    const int64_t nTimeConnected;\n     std::atomic<int64_t> nTimeOffset;\n     const CAddress addr;\n     std::string addrName;"
      }
    ]
  },
  {
    "sha": "ae683c1b1960b32134f5a5a29504691c91f39cf3",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphZTY4M2MxYjE5NjBiMzIxMzRmNWE1YTI5NTA0NjkxYzkxZjM5Y2Yz",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-06T16:44:38Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-10T16:32:40Z"
      },
      "message": "Avoid copying CNodeStats to make helgrind OK with buggy std::string",
      "tree": {
        "sha": "28065ae3fc560bc8e36fb9b0568422d142ff3371",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/28065ae3fc560bc8e36fb9b0568422d142ff3371"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ae683c1b1960b32134f5a5a29504691c91f39cf3",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ae683c1b1960b32134f5a5a29504691c91f39cf3",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ae683c1b1960b32134f5a5a29504691c91f39cf3",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ae683c1b1960b32134f5a5a29504691c91f39cf3/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "644f1234e22626a7b5618a1dae60a8457a4063b1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/644f1234e22626a7b5618a1dae60a8457a4063b1",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/644f1234e22626a7b5618a1dae60a8457a4063b1"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 2,
      "deletions": 3
    },
    "files": [
      {
        "sha": "b7243dce2050591a71f1ead56fada78e7b8f06c5",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 3,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ae683c1b1960b32134f5a5a29504691c91f39cf3/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ae683c1b1960b32134f5a5a29504691c91f39cf3/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=ae683c1b1960b32134f5a5a29504691c91f39cf3",
        "patch": "@@ -2420,9 +2420,8 @@ void CConnman::GetNodeStats(std::vector<CNodeStats>& vstats)\n     vstats.reserve(vNodes.size());\n     for(std::vector<CNode*>::iterator it = vNodes.begin(); it != vNodes.end(); ++it) {\n         CNode* pnode = *it;\n-        CNodeStats stats;\n-        pnode->copyStats(stats);\n-        vstats.push_back(stats);\n+        vstats.emplace_back();\n+        pnode->copyStats(vstats.back());\n     }\n }\n "
      }
    ]
  },
  {
    "sha": "512731bed0782f10092de35a960153b17ecc11eb",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1MTI3MzFiZWQwNzgyZjEwMDkyZGUzNWE5NjAxNTNiMTdlY2MxMWVi",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-06T16:53:34Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-10T16:32:40Z"
      },
      "message": "Access fRelayTxes with cs_filter lock in copyStats",
      "tree": {
        "sha": "f2026be6a805a95efc78a6063a815e2f87bcbe15",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f2026be6a805a95efc78a6063a815e2f87bcbe15"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/512731bed0782f10092de35a960153b17ecc11eb",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/512731bed0782f10092de35a960153b17ecc11eb",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/512731bed0782f10092de35a960153b17ecc11eb",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/512731bed0782f10092de35a960153b17ecc11eb/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ae683c1b1960b32134f5a5a29504691c91f39cf3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ae683c1b1960b32134f5a5a29504691c91f39cf3",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ae683c1b1960b32134f5a5a29504691c91f39cf3"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 4,
      "deletions": 1
    },
    "files": [
      {
        "sha": "ea8a2a0a4aefd912e6da77946a27853c770065e5",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 1,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/512731bed0782f10092de35a960153b17ecc11eb/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/512731bed0782f10092de35a960153b17ecc11eb/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=512731bed0782f10092de35a960153b17ecc11eb",
        "patch": "@@ -600,7 +600,10 @@ void CNode::copyStats(CNodeStats &stats)\n     stats.nodeid = this->GetId();\n     X(nServices);\n     X(addr);\n-    X(fRelayTxes);\n+    {\n+        LOCK(cs_filter);\n+        X(fRelayTxes);\n+    }\n     X(nLastSend);\n     X(nLastRecv);\n     X(nTimeConnected);"
      }
    ]
  },
  {
    "sha": "96f42d8a12871b8d5c4e31fd27d8135f97c6b3e0",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5NmY0MmQ4YTEyODcxYjhkNWM0ZTMxZmQyN2Q4MTM1Zjk3YzZiM2Uw",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-06T17:15:30Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-10T16:32:40Z"
      },
      "message": "Make nStartingHeight atomic",
      "tree": {
        "sha": "5935b61ce9d80ea69f50a206f9dae5cf982d2153",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5935b61ce9d80ea69f50a206f9dae5cf982d2153"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/96f42d8a12871b8d5c4e31fd27d8135f97c6b3e0",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/96f42d8a12871b8d5c4e31fd27d8135f97c6b3e0",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/96f42d8a12871b8d5c4e31fd27d8135f97c6b3e0",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/96f42d8a12871b8d5c4e31fd27d8135f97c6b3e0/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "512731bed0782f10092de35a960153b17ecc11eb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/512731bed0782f10092de35a960153b17ecc11eb",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/512731bed0782f10092de35a960153b17ecc11eb"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 1,
      "deletions": 1
    },
    "files": [
      {
        "sha": "566284c70b6d3610778fd152cc10a9dea088e022",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/96f42d8a12871b8d5c4e31fd27d8135f97c6b3e0/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/96f42d8a12871b8d5c4e31fd27d8135f97c6b3e0/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=96f42d8a12871b8d5c4e31fd27d8135f97c6b3e0",
        "patch": "@@ -628,7 +628,7 @@ class CNode\n \n public:\n     uint256 hashContinue;\n-    int nStartingHeight;\n+    std::atomic<int> nStartingHeight;\n \n     // flood relay\n     std::vector<CAddress> vAddrToSend;"
      }
    ]
  },
  {
    "sha": "0f3187261519c7568ef4211ce12b9740a3c1200f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowZjMxODcyNjE1MTljNzU2OGVmNDIxMWNlMTJiOTc0MGEzYzEyMDBm",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-06T17:20:16Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-10T16:32:41Z"
      },
      "message": "Make nServices atomic",
      "tree": {
        "sha": "dde1f3a08dfe991f4ec9c901f739b3d047620398",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/dde1f3a08dfe991f4ec9c901f739b3d047620398"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0f3187261519c7568ef4211ce12b9740a3c1200f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0f3187261519c7568ef4211ce12b9740a3c1200f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/0f3187261519c7568ef4211ce12b9740a3c1200f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0f3187261519c7568ef4211ce12b9740a3c1200f/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "96f42d8a12871b8d5c4e31fd27d8135f97c6b3e0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/96f42d8a12871b8d5c4e31fd27d8135f97c6b3e0",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/96f42d8a12871b8d5c4e31fd27d8135f97c6b3e0"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 1,
      "deletions": 1
    },
    "files": [
      {
        "sha": "cf742a8caa59c2c0ac0296b5b276f203e430a19d",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0f3187261519c7568ef4211ce12b9740a3c1200f/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0f3187261519c7568ef4211ce12b9740a3c1200f/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=0f3187261519c7568ef4211ce12b9740a3c1200f",
        "patch": "@@ -564,7 +564,7 @@ class CNode\n     friend class CConnman;\n public:\n     // socket\n-    ServiceFlags nServices;\n+    std::atomic<ServiceFlags> nServices;\n     ServiceFlags nServicesExpected;\n     SOCKET hSocket;\n     size_t nSendSize; // total size of all vSendMsg entries"
      }
    ]
  },
  {
    "sha": "22b4966a29501c4f3f2e970ac5008fbd91e665a9",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyMmI0OTY2YTI5NTAxYzRmM2YyZTk3MGFjNTAwOGZiZDkxZTY2NWE5",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-06T17:08:31Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-10T16:32:41Z"
      },
      "message": "Move [clean|str]SubVer writes/copyStats into a lock",
      "tree": {
        "sha": "2beb02b98598c74d44f4471bf157405804b7c321",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2beb02b98598c74d44f4471bf157405804b7c321"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/22b4966a29501c4f3f2e970ac5008fbd91e665a9",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/22b4966a29501c4f3f2e970ac5008fbd91e665a9",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/22b4966a29501c4f3f2e970ac5008fbd91e665a9",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/22b4966a29501c4f3f2e970ac5008fbd91e665a9/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "0f3187261519c7568ef4211ce12b9740a3c1200f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0f3187261519c7568ef4211ce12b9740a3c1200f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/0f3187261519c7568ef4211ce12b9740a3c1200f"
      }
    ],
    "stats": {
      "total": 17,
      "additions": 13,
      "deletions": 4
    },
    "files": [
      {
        "sha": "e7521f86d14373781e5dbdddf329d328a97bd245",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 1,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/22b4966a29501c4f3f2e970ac5008fbd91e665a9/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/22b4966a29501c4f3f2e970ac5008fbd91e665a9/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=22b4966a29501c4f3f2e970ac5008fbd91e665a9",
        "patch": "@@ -610,7 +610,10 @@ void CNode::copyStats(CNodeStats &stats)\n     X(nTimeOffset);\n     X(addrName);\n     X(nVersion);\n-    X(cleanSubVer);\n+    {\n+        LOCK(cs_SubVer);\n+        X(cleanSubVer);\n+    }\n     X(fInbound);\n     X(fAddnode);\n     X(nStartingHeight);"
      },
      {
        "sha": "ddc050eb1f67c299f8c135602b41fab648746d7e",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/22b4966a29501c4f3f2e970ac5008fbd91e665a9/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/22b4966a29501c4f3f2e970ac5008fbd91e665a9/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=22b4966a29501c4f3f2e970ac5008fbd91e665a9",
        "patch": "@@ -598,6 +598,7 @@ class CNode\n     // store the sanitized version in cleanSubVer. The original should be used when dealing with\n     // the network or wire types and the cleaned string used when displayed or logged.\n     std::string strSubVer, cleanSubVer;\n+    CCriticalSection cs_SubVer; // used for both cleanSubVer and strSubVer\n     bool fWhitelisted; // This peer can bypass DoS banning.\n     bool fFeeler; // If true this node is being used as a short lived feeler.\n     bool fOneShot;"
      },
      {
        "sha": "b5feac2d5926662e6ea5d597490e05e2e3cfa170",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 3,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/22b4966a29501c4f3f2e970ac5008fbd91e665a9/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/22b4966a29501c4f3f2e970ac5008fbd91e665a9/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=22b4966a29501c4f3f2e970ac5008fbd91e665a9",
        "patch": "@@ -1211,6 +1211,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         int nVersion;\n         int nSendVersion;\n         std::string strSubVer;\n+        std::string cleanSubVer;\n         int nStartingHeight = -1;\n         bool fRelay = true;\n \n@@ -1246,6 +1247,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             vRecv >> addrFrom >> nNonce;\n         if (!vRecv.empty()) {\n             vRecv >> LIMITED_STRING(strSubVer, MAX_SUBVERSION_LENGTH);\n+            cleanSubVer = SanitizeString(strSubVer);\n         }\n         if (!vRecv.empty()) {\n             vRecv >> nStartingHeight;\n@@ -1273,8 +1275,11 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n \n         pfrom->nServices = nServices;\n         pfrom->addrLocal = addrMe;\n-        pfrom->strSubVer = strSubVer;\n-        pfrom->cleanSubVer = SanitizeString(strSubVer);\n+        {\n+            LOCK(pfrom->cs_SubVer);\n+            pfrom->strSubVer = strSubVer;\n+            pfrom->cleanSubVer = cleanSubVer;\n+        }\n         pfrom->nStartingHeight = nStartingHeight;\n         pfrom->fClient = !(nServices & NODE_NETWORK);\n         {\n@@ -1330,7 +1335,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n             remoteAddr = \", peeraddr=\" + pfrom->addr.ToString();\n \n         LogPrintf(\"receive version message: %s: version %d, blocks=%d, us=%s, peer=%d%s\\n\",\n-                  pfrom->cleanSubVer, pfrom->nVersion,\n+                  cleanSubVer, pfrom->nVersion,\n                   pfrom->nStartingHeight, addrMe.ToString(), pfrom->id,\n                   remoteAddr);\n "
      }
    ]
  },
  {
    "sha": "d8f2b8a8c032b83a3bd90750e58abaeece7e34e7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkOGYyYjhhOGMwMzJiODNhM2JkOTA3NTBlNThhYmFlZWNlN2UzNGU3",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-06T22:38:57Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-10T16:32:41Z"
      },
      "message": "Make nTimeBestReceived atomic",
      "tree": {
        "sha": "3c68096b426ed16e3be504c7f6cd4b767d05c1d0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3c68096b426ed16e3be504c7f6cd4b767d05c1d0"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d8f2b8a8c032b83a3bd90750e58abaeece7e34e7",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d8f2b8a8c032b83a3bd90750e58abaeece7e34e7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/d8f2b8a8c032b83a3bd90750e58abaeece7e34e7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d8f2b8a8c032b83a3bd90750e58abaeece7e34e7/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "22b4966a29501c4f3f2e970ac5008fbd91e665a9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/22b4966a29501c4f3f2e970ac5008fbd91e665a9",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/22b4966a29501c4f3f2e970ac5008fbd91e665a9"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 1,
      "deletions": 1
    },
    "files": [
      {
        "sha": "62397e68ce0cbc75ae7a22bc8ed531eafd38b199",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d8f2b8a8c032b83a3bd90750e58abaeece7e34e7/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d8f2b8a8c032b83a3bd90750e58abaeece7e34e7/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=d8f2b8a8c032b83a3bd90750e58abaeece7e34e7",
        "patch": "@@ -36,7 +36,7 @@\n # error \"Bitcoin cannot be compiled without assertions.\"\n #endif\n \n-int64_t nTimeBestReceived = 0; // Used only to inform the wallet of when we last received a block\n+std::atomic<int64_t> nTimeBestReceived(0); // Used only to inform the wallet of when we last received a block\n \n struct IteratorComparator\n {"
      }
    ]
  },
  {
    "sha": "036073bf87c07f8d69e39168dd93a52f1aafe85c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowMzYwNzNiZjg3YzA3ZjhkNjllMzkxNjhkZDkzYTUyZjFhYWZlODVj",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-06T17:04:34Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-10T16:32:41Z"
      },
      "message": "Move CNode::addrName accesses behind locked accessors",
      "tree": {
        "sha": "95cdeea1af6e92752009b265b4f1b67e1d040f7f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/95cdeea1af6e92752009b265b4f1b67e1d040f7f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/036073bf87c07f8d69e39168dd93a52f1aafe85c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/036073bf87c07f8d69e39168dd93a52f1aafe85c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/036073bf87c07f8d69e39168dd93a52f1aafe85c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/036073bf87c07f8d69e39168dd93a52f1aafe85c/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "d8f2b8a8c032b83a3bd90750e58abaeece7e34e7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d8f2b8a8c032b83a3bd90750e58abaeece7e34e7",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/d8f2b8a8c032b83a3bd90750e58abaeece7e34e7"
      }
    ],
    "stats": {
      "total": 40,
      "additions": 30,
      "deletions": 10
    },
    "files": [
      {
        "sha": "8aa12619843fa9c409bbbcb12181973bbf5bd4a5",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 22,
        "deletions": 8,
        "changes": 30,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/036073bf87c07f8d69e39168dd93a52f1aafe85c/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/036073bf87c07f8d69e39168dd93a52f1aafe85c/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=036073bf87c07f8d69e39168dd93a52f1aafe85c",
        "patch": "@@ -307,9 +307,11 @@ CNode* CConnman::FindNode(const CSubNet& subNet)\n CNode* CConnman::FindNode(const std::string& addrName)\n {\n     LOCK(cs_vNodes);\n-    BOOST_FOREACH(CNode* pnode, vNodes)\n-        if (pnode->addrName == addrName)\n+    BOOST_FOREACH(CNode* pnode, vNodes) {\n+        if (pnode->GetAddrName() == addrName) {\n             return (pnode);\n+        }\n+    }\n     return NULL;\n }\n \n@@ -373,9 +375,7 @@ CNode* CConnman::ConnectNode(CAddress addrConnect, const char *pszDest, bool fCo\n             CNode* pnode = FindNode((CService)addrConnect);\n             if (pnode)\n             {\n-                if (pnode->addrName.empty()) {\n-                    pnode->addrName = std::string(pszDest);\n-                }\n+                pnode->MaybeSetAddrName(std::string(pszDest));\n                 CloseSocket(hSocket);\n                 LogPrintf(\"Failed to open new connection, already connected\\n\");\n                 return NULL;\n@@ -593,6 +593,19 @@ void CConnman::AddWhitelistedRange(const CSubNet &subnet) {\n     vWhitelistedRange.push_back(subnet);\n }\n \n+\n+std::string CNode::GetAddrName() const {\n+    LOCK(cs_addrName);\n+    return addrName;\n+}\n+\n+void CNode::MaybeSetAddrName(const std::string& addrNameIn) {\n+    LOCK(cs_addrName);\n+    if (addrName.empty()) {\n+        addrName = addrNameIn;\n+    }\n+}\n+\n #undef X\n #define X(name) stats.name = name\n void CNode::copyStats(CNodeStats &stats)\n@@ -608,7 +621,7 @@ void CNode::copyStats(CNodeStats &stats)\n     X(nLastRecv);\n     X(nTimeConnected);\n     X(nTimeOffset);\n-    X(addrName);\n+    stats.addrName = GetAddrName();\n     X(nVersion);\n     {\n         LOCK(cs_SubVer);\n@@ -1798,8 +1811,9 @@ std::vector<AddedNodeInfo> CConnman::GetAddedNodeInfo()\n             if (pnode->addr.IsValid()) {\n                 mapConnected[pnode->addr] = pnode->fInbound;\n             }\n-            if (!pnode->addrName.empty()) {\n-                mapConnectedByName[pnode->addrName] = std::make_pair(pnode->fInbound, static_cast<const CService&>(pnode->addr));\n+            std::string addrName = pnode->GetAddrName();\n+            if (!addrName.empty()) {\n+                mapConnectedByName[std::move(addrName)] = std::make_pair(pnode->fInbound, static_cast<const CService&>(pnode->addr));\n             }\n         }\n     }"
      },
      {
        "sha": "2cfc74e3d55c9c6f8565cec2f6e568c8c8d7b327",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 7,
        "deletions": 1,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/036073bf87c07f8d69e39168dd93a52f1aafe85c/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/036073bf87c07f8d69e39168dd93a52f1aafe85c/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=036073bf87c07f8d69e39168dd93a52f1aafe85c",
        "patch": "@@ -590,7 +590,6 @@ class CNode\n     const int64_t nTimeConnected;\n     std::atomic<int64_t> nTimeOffset;\n     const CAddress addr;\n-    std::string addrName;\n     CService addrLocal;\n     std::atomic<int> nVersion;\n     // strSubVer is whatever byte array we read from the wire. However, this field is intended\n@@ -696,6 +695,9 @@ class CNode\n     const int nMyStartingHeight;\n     int nSendVersion;\n     std::list<CNetMessage> vRecvMsg;  // Used only by SocketHandler thread\n+\n+    mutable CCriticalSection cs_addrName;\n+    std::string addrName;\n public:\n \n     NodeId GetId() const {\n@@ -798,6 +800,10 @@ class CNode\n     {\n         return nLocalServices;\n     }\n+\n+    std::string GetAddrName() const;\n+    //! Sets the addrName only if it was not previously set\n+    void MaybeSetAddrName(const std::string& addrNameIn);\n };\n \n "
      },
      {
        "sha": "b0c9b3c71ba170786e5cdab38b6ec439cd855d92",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/036073bf87c07f8d69e39168dd93a52f1aafe85c/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/036073bf87c07f8d69e39168dd93a52f1aafe85c/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=036073bf87c07f8d69e39168dd93a52f1aafe85c",
        "patch": "@@ -264,7 +264,7 @@ void PushNodeVersion(CNode *pnode, CConnman& connman, int64_t nTime)\n \n void InitializeNode(CNode *pnode, CConnman& connman) {\n     CAddress addr = pnode->addr;\n-    std::string addrName = pnode->addrName;\n+    std::string addrName = pnode->GetAddrName();\n     NodeId nodeid = pnode->GetId();\n     {\n         LOCK(cs_main);"
      }
    ]
  },
  {
    "sha": "db2dc7a58cb0a3df58188b748df8e0d04ba76f00",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkYjJkYzdhNThjYjBhM2RmNTgxODhiNzQ4ZGY4ZTBkMDRiYTc2ZjAw",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-06T17:18:51Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2017-02-10T16:32:41Z"
      },
      "message": "Move CNode::addrLocal access behind locked accessors",
      "tree": {
        "sha": "061df504e100195d1dc93313652c9e2a1ecdc545",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/061df504e100195d1dc93313652c9e2a1ecdc545"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/db2dc7a58cb0a3df58188b748df8e0d04ba76f00",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/db2dc7a58cb0a3df58188b748df8e0d04ba76f00",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/db2dc7a58cb0a3df58188b748df8e0d04ba76f00",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/db2dc7a58cb0a3df58188b748df8e0d04ba76f00/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "036073bf87c07f8d69e39168dd93a52f1aafe85c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/036073bf87c07f8d69e39168dd93a52f1aafe85c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/036073bf87c07f8d69e39168dd93a52f1aafe85c"
      }
    ],
    "stats": {
      "total": 36,
      "additions": 29,
      "deletions": 7
    },
    "files": [
      {
        "sha": "505eb971c09e944d8bd90eb4f525d8b8e3131bf3",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 20,
        "deletions": 4,
        "changes": 24,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/db2dc7a58cb0a3df58188b748df8e0d04ba76f00/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/db2dc7a58cb0a3df58188b748df8e0d04ba76f00/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=db2dc7a58cb0a3df58188b748df8e0d04ba76f00",
        "patch": "@@ -164,8 +164,9 @@ int GetnScore(const CService& addr)\n // Is our peer's addrLocal potentially useful as an external IP source?\n bool IsPeerAddrLocalGood(CNode *pnode)\n {\n-    return fDiscover && pnode->addr.IsRoutable() && pnode->addrLocal.IsRoutable() &&\n-           !IsLimited(pnode->addrLocal.GetNetwork());\n+    CService addrLocal = pnode->GetAddrLocal();\n+    return fDiscover && pnode->addr.IsRoutable() && addrLocal.IsRoutable() &&\n+           !IsLimited(addrLocal.GetNetwork());\n }\n \n // pushes our own address to a peer\n@@ -180,7 +181,7 @@ void AdvertiseLocal(CNode *pnode)\n         if (IsPeerAddrLocalGood(pnode) && (!addrLocal.IsRoutable() ||\n              GetRand((GetnScore(addrLocal) > LOCAL_MANUAL) ? 8:2) == 0))\n         {\n-            addrLocal.SetIP(pnode->addrLocal);\n+            addrLocal.SetIP(pnode->GetAddrLocal());\n         }\n         if (addrLocal.IsRoutable())\n         {\n@@ -606,6 +607,20 @@ void CNode::MaybeSetAddrName(const std::string& addrNameIn) {\n     }\n }\n \n+CService CNode::GetAddrLocal() const {\n+    LOCK(cs_addrLocal);\n+    return addrLocal;\n+}\n+\n+void CNode::SetAddrLocal(const CService& addrLocalIn) {\n+    LOCK(cs_addrLocal);\n+    if (addrLocal.IsValid()) {\n+        error(\"Addr local already set for node: %i. Refusing to change from %s to %s\", id, addrLocal.ToString(), addrLocalIn.ToString());\n+    } else {\n+        addrLocal = addrLocalIn;\n+    }\n+}\n+\n #undef X\n #define X(name) stats.name = name\n void CNode::copyStats(CNodeStats &stats)\n@@ -659,7 +674,8 @@ void CNode::copyStats(CNodeStats &stats)\n     stats.dPingWait = (((double)nPingUsecWait) / 1e6);\n \n     // Leave string empty if addrLocal invalid (not filled in yet)\n-    stats.addrLocal = addrLocal.IsValid() ? addrLocal.ToString() : \"\";\n+    CService addrLocalUnlocked = GetAddrLocal();\n+    stats.addrLocal = addrLocalUnlocked.IsValid() ? addrLocalUnlocked.ToString() : \"\";\n }\n #undef X\n "
      },
      {
        "sha": "29b6a44c88ff2a0dfbccc9f87720e5bbab5ef42c",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 7,
        "deletions": 1,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/db2dc7a58cb0a3df58188b748df8e0d04ba76f00/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/db2dc7a58cb0a3df58188b748df8e0d04ba76f00/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=db2dc7a58cb0a3df58188b748df8e0d04ba76f00",
        "patch": "@@ -590,7 +590,6 @@ class CNode\n     const int64_t nTimeConnected;\n     std::atomic<int64_t> nTimeOffset;\n     const CAddress addr;\n-    CService addrLocal;\n     std::atomic<int> nVersion;\n     // strSubVer is whatever byte array we read from the wire. However, this field is intended\n     // to be printed out, displayed to humans in various forms and so on. So we sanitize it and\n@@ -698,6 +697,9 @@ class CNode\n \n     mutable CCriticalSection cs_addrName;\n     std::string addrName;\n+\n+    CService addrLocal;\n+    mutable CCriticalSection cs_addrLocal;\n public:\n \n     NodeId GetId() const {\n@@ -731,6 +733,10 @@ class CNode\n     void SetSendVersion(int nVersionIn);\n     int GetSendVersion() const;\n \n+    CService GetAddrLocal() const;\n+    //! May not be called more than once\n+    void SetAddrLocal(const CService& addrLocalIn);\n+\n     CNode* AddRef()\n     {\n         nRefCount++;"
      },
      {
        "sha": "7d76aa0b4860ff34a098865e4d7a8a133df290e1",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/db2dc7a58cb0a3df58188b748df8e0d04ba76f00/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/db2dc7a58cb0a3df58188b748df8e0d04ba76f00/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=db2dc7a58cb0a3df58188b748df8e0d04ba76f00",
        "patch": "@@ -1274,7 +1274,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         connman.PushMessage(pfrom, CNetMsgMaker(INIT_PROTO_VERSION).Make(NetMsgType::VERACK));\n \n         pfrom->nServices = nServices;\n-        pfrom->addrLocal = addrMe;\n+        pfrom->SetAddrLocal(addrMe);\n         {\n             LOCK(pfrom->cs_SubVer);\n             pfrom->strSubVer = strSubVer;\n@@ -1315,7 +1315,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n                     LogPrint(\"net\", \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n                     pfrom->PushAddress(addr, insecure_rand);\n                 } else if (IsPeerAddrLocalGood(pfrom)) {\n-                    addr.SetIP(pfrom->addrLocal);\n+                    addr.SetIP(addrMe);\n                     LogPrint(\"net\", \"ProcessMessages: advertising address %s\\n\", addr.ToString());\n                     pfrom->PushAddress(addr, insecure_rand);\n                 }"
      }
    ]
  }
]