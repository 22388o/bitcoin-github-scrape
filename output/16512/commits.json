[
  {
    "sha": "6f405a1d3b38395e35571b68aae55cae50e0762a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2ZjQwNWExZDNiMzgzOTVlMzU1NzFiNjhhYWU1NWNhZTUwZTA3NjJh",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2019-07-31T22:02:24Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2019-09-04T21:44:31Z"
      },
      "message": "Shuffle inputs and outputs after joining psbts",
      "tree": {
        "sha": "b7debd959abce9db4ffec38750f89a8544707dc3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b7debd959abce9db4ffec38750f89a8544707dc3"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6f405a1d3b38395e35571b68aae55cae50e0762a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6f405a1d3b38395e35571b68aae55cae50e0762a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/6f405a1d3b38395e35571b68aae55cae50e0762a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6f405a1d3b38395e35571b68aae55cae50e0762a/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "7821821a23b68cc9ec49d69829ad4c939cb762e8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7821821a23b68cc9ec49d69829ad4c939cb762e8",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/7821821a23b68cc9ec49d69829ad4c939cb762e8"
      }
    ],
    "stats": {
      "total": 29,
      "additions": 28,
      "deletions": 1
    },
    "files": [
      {
        "sha": "9aa9cf36f92b842a0322c90add450f3cee615b9d",
        "filename": "doc/release-notes-16512.md",
        "status": "added",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6f405a1d3b38395e35571b68aae55cae50e0762a/doc/release-notes-16512.md",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6f405a1d3b38395e35571b68aae55cae50e0762a/doc/release-notes-16512.md",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/doc/release-notes-16512.md?ref=6f405a1d3b38395e35571b68aae55cae50e0762a",
        "patch": "@@ -0,0 +1,4 @@\n+RPC changes\n+-----------\n+The RPC `joinpsbts` will shuffle the order of the inputs and outputs of the resulting joined psbt.\n+Previously inputs and outputs were added in the order that the PSBTs were provided which makes correlating inputs to outputs extremely easy."
      },
      {
        "sha": "a26304312414e1cf56bc52bc3d1775456b78e6af",
        "filename": "src/rpc/rawtransaction.cpp",
        "status": "modified",
        "additions": 24,
        "deletions": 1,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6f405a1d3b38395e35571b68aae55cae50e0762a/src/rpc/rawtransaction.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6f405a1d3b38395e35571b68aae55cae50e0762a/src/rpc/rawtransaction.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/rawtransaction.cpp?ref=6f405a1d3b38395e35571b68aae55cae50e0762a",
        "patch": "@@ -17,6 +17,7 @@\n #include <policy/rbf.h>\n #include <primitives/transaction.h>\n #include <psbt.h>\n+#include <random.h>\n #include <rpc/rawtransaction_util.h>\n #include <rpc/server.h>\n #include <rpc/util.h>\n@@ -1604,8 +1605,30 @@ UniValue joinpsbts(const JSONRPCRequest& request)\n         merged_psbt.unknown.insert(psbt.unknown.begin(), psbt.unknown.end());\n     }\n \n+    // Generate list of shuffled indices for shuffling inputs and outputs of the merged PSBT\n+    std::vector<int> input_indices(merged_psbt.inputs.size());\n+    std::iota(input_indices.begin(), input_indices.end(), 0);\n+    std::vector<int> output_indices(merged_psbt.outputs.size());\n+    std::iota(output_indices.begin(), output_indices.end(), 0);\n+\n+    // Shuffle input and output indicies lists\n+    Shuffle(input_indices.begin(), input_indices.end(), FastRandomContext());\n+    Shuffle(output_indices.begin(), output_indices.end(), FastRandomContext());\n+\n+    PartiallySignedTransaction shuffled_psbt;\n+    shuffled_psbt.tx = CMutableTransaction();\n+    shuffled_psbt.tx->nVersion = merged_psbt.tx->nVersion;\n+    shuffled_psbt.tx->nLockTime = merged_psbt.tx->nLockTime;\n+    for (int i : input_indices) {\n+        shuffled_psbt.AddInput(merged_psbt.tx->vin[i], merged_psbt.inputs[i]);\n+    }\n+    for (int i : output_indices) {\n+        shuffled_psbt.AddOutput(merged_psbt.tx->vout[i], merged_psbt.outputs[i]);\n+    }\n+    shuffled_psbt.unknown.insert(merged_psbt.unknown.begin(), merged_psbt.unknown.end());\n+\n     CDataStream ssTx(SER_NETWORK, PROTOCOL_VERSION);\n-    ssTx << merged_psbt;\n+    ssTx << shuffled_psbt;\n     return EncodeBase64((unsigned char*)ssTx.data(), ssTx.size());\n }\n "
      }
    ]
  },
  {
    "sha": "c0b5d9710322a614a50ab5da081558cf6a38ad2a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjMGI1ZDk3MTAzMjJhNjE0YTUwYWI1ZGEwODE1NThjZjZhMzhhZDJh",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2019-08-14T18:29:55Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2019-09-04T21:44:31Z"
      },
      "message": "Test that joinpsbts randomly shuffles the inputs",
      "tree": {
        "sha": "ba7fa172ead773987976cf3a6091161cc66b959f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ba7fa172ead773987976cf3a6091161cc66b959f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c0b5d9710322a614a50ab5da081558cf6a38ad2a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c0b5d9710322a614a50ab5da081558cf6a38ad2a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c0b5d9710322a614a50ab5da081558cf6a38ad2a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c0b5d9710322a614a50ab5da081558cf6a38ad2a/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6f405a1d3b38395e35571b68aae55cae50e0762a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6f405a1d3b38395e35571b68aae55cae50e0762a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6f405a1d3b38395e35571b68aae55cae50e0762a"
      }
    ],
    "stats": {
      "total": 10,
      "additions": 10,
      "deletions": 0
    },
    "files": [
      {
        "sha": "493e025e43315e39b5077e4040a7a697fa43a5bc",
        "filename": "test/functional/rpc_psbt.py",
        "status": "modified",
        "additions": 10,
        "deletions": 0,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c0b5d9710322a614a50ab5da081558cf6a38ad2a/test/functional/rpc_psbt.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c0b5d9710322a614a50ab5da081558cf6a38ad2a/test/functional/rpc_psbt.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_psbt.py?ref=c0b5d9710322a614a50ab5da081558cf6a38ad2a",
        "patch": "@@ -370,6 +370,16 @@ def test_psbt_input_keys(psbt_input, keys):\n         joined_decoded = self.nodes[0].decodepsbt(joined)\n         assert len(joined_decoded['inputs']) == 4 and len(joined_decoded['outputs']) == 2 and \"final_scriptwitness\" not in joined_decoded['inputs'][3] and \"final_scriptSig\" not in joined_decoded['inputs'][3]\n \n+        # Check that joining shuffles the inputs and outputs\n+        # 10 attempts should be enough to get a shuffled join\n+        shuffled = False\n+        for i in range(0, 10):\n+            shuffled_joined = self.nodes[0].joinpsbts([psbt, psbt2])\n+            shuffled |= joined != shuffled_joined\n+            if shuffled:\n+                break\n+        assert shuffled\n+\n         # Newly created PSBT needs UTXOs and updating\n         addr = self.nodes[1].getnewaddress(\"\", \"p2sh-segwit\")\n         txid = self.nodes[0].sendtoaddress(addr, 7)"
      }
    ]
  }
]