[
  {
    "sha": "b191c1a81b245c228b748146e6c8564195cb833c",
    "node_id": "C_kwDOABII59oAKGIxOTFjMWE4MWIyNDVjMjI4Yjc0ODE0NmU2Yzg1NjQxOTVjYjgzM2M",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-11-17T05:00:12Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-11-17T05:00:12Z"
      },
      "message": "wallet: Set change fee only if not subtracting fee from outputs",
      "tree": {
        "sha": "a5df3f76d3ac69151341bac29c090297873c7c2d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a5df3f76d3ac69151341bac29c090297873c7c2d"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b191c1a81b245c228b748146e6c8564195cb833c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b191c1a81b245c228b748146e6c8564195cb833c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b191c1a81b245c228b748146e6c8564195cb833c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b191c1a81b245c228b748146e6c8564195cb833c/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b869a784ef2b259f14545bf6bd314fb58c36514b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b869a784ef2b259f14545bf6bd314fb58c36514b",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b869a784ef2b259f14545bf6bd314fb58c36514b"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 3,
      "deletions": 2
    },
    "files": [
      {
        "sha": "768ee1d619fb8b0b6e2554737a5a78081e6352d5",
        "filename": "src/wallet/spend.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 2,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b191c1a81b245c228b748146e6c8564195cb833c/src/wallet/spend.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b191c1a81b245c228b748146e6c8564195cb833c/src/wallet/spend.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/spend.cpp?ref=b191c1a81b245c228b748146e6c8564195cb833c",
        "patch": "@@ -733,12 +733,13 @@ static bool CreateTransactionInternal(\n     // For creating the change output now, we use the effective feerate.\n     // For spending the change output in the future, we use the discard feerate for now.\n     // So cost of change = (change output size * effective feerate) + (size of spending change output * discard feerate)\n-    coin_selection_params.m_change_fee = coin_selection_params.m_effective_feerate.GetFee(coin_selection_params.change_output_size);\n-    coin_selection_params.m_cost_of_change = coin_selection_params.m_discard_feerate.GetFee(coin_selection_params.change_spend_size) + coin_selection_params.m_change_fee;\n+    CAmount change_fee = coin_selection_params.m_effective_feerate.GetFee(coin_selection_params.change_output_size);\n+    coin_selection_params.m_cost_of_change = coin_selection_params.m_discard_feerate.GetFee(coin_selection_params.change_spend_size) + change_fee;\n \n     // vouts to the payees\n     if (!coin_selection_params.m_subtract_fee_outputs) {\n         coin_selection_params.tx_noinputs_size = 11; // Static vsize overhead + outputs vsize. 4 nVersion, 4 nLocktime, 1 input count, 1 output count, 1 witness overhead (dummy, flag, stack size)\n+        coin_selection_params.m_change_fee = change_fee;\n     }\n     for (const auto& recipient : vecSend)\n     {"
      }
    ]
  },
  {
    "sha": "851e73e05b7d5fcd65448cf5488c9b9ffe3138f2",
    "node_id": "C_kwDOABII59oAKDg1MWU3M2UwNWI3ZDVmY2Q2NTQ0OGNmNTQ4OGM5YjlmZmUzMTM4ZjI",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-11-17T05:03:32Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-11-17T05:03:56Z"
      },
      "message": "wallet: Allow negative ev UTXOs when subtracting fee from outputs",
      "tree": {
        "sha": "5f0e453de9f76ddc9e86c95582750013bacbd2ca",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5f0e453de9f76ddc9e86c95582750013bacbd2ca"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/851e73e05b7d5fcd65448cf5488c9b9ffe3138f2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/851e73e05b7d5fcd65448cf5488c9b9ffe3138f2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/851e73e05b7d5fcd65448cf5488c9b9ffe3138f2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/851e73e05b7d5fcd65448cf5488c9b9ffe3138f2/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b191c1a81b245c228b748146e6c8564195cb833c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b191c1a81b245c228b748146e6c8564195cb833c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b191c1a81b245c228b748146e6c8564195cb833c"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 1,
      "deletions": 1
    },
    "files": [
      {
        "sha": "b9dcdd7967f21f99eb7f090bee5737f7261171c1",
        "filename": "src/wallet/spend.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/851e73e05b7d5fcd65448cf5488c9b9ffe3138f2/src/wallet/spend.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/851e73e05b7d5fcd65448cf5488c9b9ffe3138f2/src/wallet/spend.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/spend.cpp?ref=851e73e05b7d5fcd65448cf5488c9b9ffe3138f2",
        "patch": "@@ -384,7 +384,7 @@ bool AttemptSelection(const CWallet& wallet, const CAmount& nTargetValue, const\n     std::vector<std::tuple<CAmount, std::set<CInputCoin>, CAmount>> results;\n \n     // Note that unlike KnapsackSolver, we do not include the fee for creating a change output as BnB will not create a change output.\n-    std::vector<OutputGroup> positive_groups = GroupOutputs(wallet, coins, coin_selection_params, eligibility_filter, true /* positive_only */);\n+    std::vector<OutputGroup> positive_groups = GroupOutputs(wallet, coins, coin_selection_params, eligibility_filter, !coin_selection_params.m_subtract_fee_outputs/* positive_only */);\n     std::set<CInputCoin> bnb_coins;\n     CAmount bnb_value;\n     if (SelectCoinsBnB(positive_groups, nTargetValue, coin_selection_params.m_cost_of_change, bnb_coins, bnb_value)) {"
      }
    ]
  },
  {
    "sha": "c351e53f42c85c7ed95bde842f07554c9798dbcb",
    "node_id": "C_kwDOABII59oAKGMzNTFlNTNmNDJjODVjN2VkOTViZGU4NDJmMDc1NTRjOTc5OGRiY2I",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-11-17T05:00:25Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-11-17T18:11:58Z"
      },
      "message": "tests: Test for spending neg ev UTXOs when subtracting fee from outputs\n\nWhen subtracting fee from outputs, it should be okay to spend negative\nev UTXOs because the recipient is paying for it.",
      "tree": {
        "sha": "2dee25a069a7aab9e2429bd1ca69a79192b54edc",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2dee25a069a7aab9e2429bd1ca69a79192b54edc"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c351e53f42c85c7ed95bde842f07554c9798dbcb",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c351e53f42c85c7ed95bde842f07554c9798dbcb",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c351e53f42c85c7ed95bde842f07554c9798dbcb",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c351e53f42c85c7ed95bde842f07554c9798dbcb/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "851e73e05b7d5fcd65448cf5488c9b9ffe3138f2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/851e73e05b7d5fcd65448cf5488c9b9ffe3138f2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/851e73e05b7d5fcd65448cf5488c9b9ffe3138f2"
      }
    ],
    "stats": {
      "total": 16,
      "additions": 16,
      "deletions": 0
    },
    "files": [
      {
        "sha": "2152904d07debf11bd4af9db3bfab68c15d4c904",
        "filename": "test/functional/rpc_fundrawtransaction.py",
        "status": "modified",
        "additions": 16,
        "deletions": 0,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c351e53f42c85c7ed95bde842f07554c9798dbcb/test/functional/rpc_fundrawtransaction.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c351e53f42c85c7ed95bde842f07554c9798dbcb/test/functional/rpc_fundrawtransaction.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_fundrawtransaction.py?ref=c351e53f42c85c7ed95bde842f07554c9798dbcb",
        "patch": "@@ -135,6 +135,7 @@ def run_test(self):\n         self.test_external_inputs()\n         self.test_22670()\n         self.test_feerate_rounding()\n+        self.test_sffo_with_negative_ev()\n \n     def test_change_position(self):\n         \"\"\"Ensure setting changePosition in fundraw with an exact match is handled properly.\"\"\"\n@@ -1143,6 +1144,21 @@ def test_feerate_rounding(self):\n         rawtx = w.createrawtransaction(inputs=[], outputs=[{self.nodes[0].getnewaddress(address_type=\"bech32\"): 1 - 0.00000202}])\n         assert_raises_rpc_error(-4, \"Insufficient funds\", w.fundrawtransaction, rawtx, {\"fee_rate\": 1.85})\n \n+    def test_sffo_with_negative_ev(self):\n+        self.log.info(\"Testing that subtract fee from outputs with negative effective value outputs still works\")\n+\n+        self.nodes[1].createwallet(\"negevsffotest\")\n+        w = self.nodes[1].get_wallet_rpc(\"negevsffotest\")\n+\n+        self.nodes[0].sendtoaddress(w.getnewaddress(address_type=\"bech32\"), 0.00001000)\n+        self.nodes[0].sendtoaddress(w.getnewaddress(address_type=\"bech32\"), 1)\n+\n+        self.generate(self.nodes[0], 1)\n+\n+        created = w.createrawtransaction([], [{self.nodes[0].getnewaddress(address_type=\"bech32\"): 1.00001000}])\n+\n+        # With 15 sat/vb, the low value input is negative ev. This should still fund.\n+        w.fundrawtransaction(created, {\"subtractFeeFromOutputs\":[0], \"fee_rate\": 15})\n \n if __name__ == '__main__':\n     RawTransactionsTest().main()"
      }
    ]
  }
]