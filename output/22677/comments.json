[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896190244",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-896190244",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 896190244,
    "node_id": "IC_kwDOABII5841asck",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?u=8cdd8653982252593843d7369ecfebe432b89768&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-10T17:48:48Z",
    "updated_at": "2021-08-10T17:48:48Z",
    "author_association": "CONTRIBUTOR",
    "body": "Hmm I'm mildly concept NACK on this refactoring; removeForReorg really feels like internal mempool functionality.\r\n\r\nAnother tactic to remove the module links would be to make removeForReorg generic to any T ChainState class. Then you don't need to have the specifics of the implementation of T known within mempool.\r\n\r\n(Circular deps within `.cpp` are not *that* bad IMO)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896190244/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896232272",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-896232272",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 896232272,
    "node_id": "IC_kwDOABII5841a2tQ",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-10T18:51:03Z",
    "updated_at": "2021-11-02T01:50:29Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22282](https://github.com/bitcoin/bitcoin/pull/22282) (refactor: CheckFinalTx pass by reference instead of pointer by klementtan)\n* [#10443](https://github.com/bitcoin/bitcoin/pull/10443) (Add fee_est tool for debugging fee estimation code by ryanofsky)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896232272/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896456577",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-896456577",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 896456577,
    "node_id": "IC_kwDOABII5841bteB",
    "user": {
      "login": "fanquake",
      "id": 863730,
      "node_id": "MDQ6VXNlcjg2MzczMA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/863730?u=a0e0040aacd7d4f0787481e8ac30b494fa429e11&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fanquake",
      "html_url": "https://github.com/fanquake",
      "followers_url": "https://api.github.com/users/fanquake/followers",
      "following_url": "https://api.github.com/users/fanquake/following{/other_user}",
      "gists_url": "https://api.github.com/users/fanquake/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fanquake/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fanquake/subscriptions",
      "organizations_url": "https://api.github.com/users/fanquake/orgs",
      "repos_url": "https://api.github.com/users/fanquake/repos",
      "events_url": "https://api.github.com/users/fanquake/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fanquake/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-11T02:44:17Z",
    "updated_at": "2021-08-11T02:44:17Z",
    "author_association": "MEMBER",
    "body": "```bash\r\nvalidation.cpp:338:25: error: calling function 'TestLockPointValidity' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n        bool validLP =  TestLockPointValidity(m_chain, &lp);\r\n                        ^\r\nvalidation.cpp:339:41: error: calling function 'CoinsTip' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n        CCoinsViewMemPool view_mempool(&CoinsTip(), pool);\r\n                                        ^\r\nvalidation.cpp:340:14: error: calling function 'CheckFinalTx' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n        if (!CheckFinalTx(m_chain.Tip(), tx, flags)\r\n             ^\r\nvalidation.cpp:350:36: error: calling function 'CoinsTip' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n                const Coin &coin = CoinsTip().AccessCoin(txin.prevout);\r\n                                   ^\r\nvalidation.cpp:5113:5: error: calling function 'AssertLockHeldInternal<AnnotatedMixin<std::__1::recursive_mutex> >' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n    AssertLockHeld(::cs_main);\r\n    ^\r\n./sync.h:81:28: note: expanded from macro 'AssertLockHeld'\r\n#define AssertLockHeld(cs) AssertLockHeldInternal(#cs, __FILE__, __LINE__, &cs)\r\n                           ^\r\nvalidation.cpp:5117:10: error: calling function 'check' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n    pool.check();\r\n         ^\r\nvalidation.cpp:5119:41: error: calling function 'CoinsTip' requires holding mutex 'cs_main' exclusively [-Werror,-Wthread-safety-analysis]\r\n    CCoinsViewCache& active_coins_tip = CoinsTip();\r\n                                        ^\r\n7 errors generated.\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896456577/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896691512",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-896691512",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 896691512,
    "node_id": "IC_kwDOABII5841cm04",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?u=3e27bc6589085f3450be1b0e969d04008cc77565&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-11T10:06:39Z",
    "updated_at": "2021-08-11T10:06:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "> removeForReorg really feels like internal mempool functionality. Another tactic to remove the module links would be to make removeForReorg generic to any T ChainState class. Then you don't need to have the specifics of the implementation of T known within mempool.\r\n\r\nYeah, I see this. Perhaps the function could instead be parametrized by tip, coins cache, etc?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/896691512/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901412474",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-901412474",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 901412474,
    "node_id": "IC_kwDOABII5841unZ6",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?u=3e27bc6589085f3450be1b0e969d04008cc77565&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-18T20:34:28Z",
    "updated_at": "2021-08-18T20:34:28Z",
    "author_association": "CONTRIBUTOR",
    "body": "I've pushed a version that splits out the finality checking part of removeForReorg (parts that require validation functions CheckSequenceLocks and CheckFinalTx) into validation, but leaves most of it in txmempool. Perhaps a better separation?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901412474/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901443258",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-901443258",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 901443258,
    "node_id": "IC_kwDOABII5841uu66",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?u=8cdd8653982252593843d7369ecfebe432b89768&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-18T21:30:28Z",
    "updated_at": "2021-08-18T21:31:23Z",
    "author_association": "CONTRIBUTOR",
    "body": "i don't think so :/\r\n\r\nedit: it still feels like an abstraction layer leak, the for loop is inner functionality. Have you given parametrizing by CChainState. a try? ",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901443258/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901726060",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-901726060",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 901726060,
    "node_id": "IC_kwDOABII5841vz9s",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?u=3e27bc6589085f3450be1b0e969d04008cc77565&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-19T08:43:18Z",
    "updated_at": "2021-08-19T08:43:18Z",
    "author_association": "CONTRIBUTOR",
    "body": "@JeremyRubin `CChainState` is what it's currently parametrized by - it's what causes the dependency on validation.h",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901726060/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901941089",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-901941089",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 901941089,
    "node_id": "IC_kwDOABII5841wodh",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?u=3e27bc6589085f3450be1b0e969d04008cc77565&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-19T14:01:00Z",
    "updated_at": "2021-08-19T14:01:00Z",
    "author_association": "CONTRIBUTOR",
    "body": "Ok new approach. I added something similar to the `CConnman.ForEachNode` so we can pass in a lambda that captures what we need from chainstate. Validation isn't looking through `mapTx` anymore. The mempool gets a callable object and applies it to the entries internally.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/901941089/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902258227",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-902258227",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 902258227,
    "node_id": "IC_kwDOABII5841x14z",
    "user": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?u=8cdd8653982252593843d7369ecfebe432b89768&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-08-19T21:24:32Z",
    "updated_at": "2021-08-19T21:24:32Z",
    "author_association": "CONTRIBUTOR",
    "body": "i meant template paramterized by a generic ChainStateProvider type, that way it's clean depedency wise.. will check out the new approach later.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/902258227/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/911839931",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-911839931",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 911839931,
    "node_id": "IC_kwDOABII5842WZK7",
    "user": {
      "login": "michaelfolkson",
      "id": 16323900,
      "node_id": "MDQ6VXNlcjE2MzIzOTAw",
      "avatar_url": "https://avatars.githubusercontent.com/u/16323900?u=e2201a78ad660e42fd175003d02ad749b855e0a9&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/michaelfolkson",
      "html_url": "https://github.com/michaelfolkson",
      "followers_url": "https://api.github.com/users/michaelfolkson/followers",
      "following_url": "https://api.github.com/users/michaelfolkson/following{/other_user}",
      "gists_url": "https://api.github.com/users/michaelfolkson/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/michaelfolkson/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/michaelfolkson/subscriptions",
      "organizations_url": "https://api.github.com/users/michaelfolkson/orgs",
      "repos_url": "https://api.github.com/users/michaelfolkson/repos",
      "events_url": "https://api.github.com/users/michaelfolkson/events{/privacy}",
      "received_events_url": "https://api.github.com/users/michaelfolkson/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-02T16:05:58Z",
    "updated_at": "2021-09-02T17:17:56Z",
    "author_association": "CONTRIBUTOR",
    "body": "What's the latest on this PR? Am I right in thinking that an approach hasn't been settled on to avoid the circular dependency and that #22675 should be reviewed instead?\r\n\r\nedit: I guess this is just a RFC and draft PR so it is here in case an alternative approach is sketched out.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/911839931/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916906730",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-916906730",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 916906730,
    "node_id": "IC_kwDOABII5842puLq",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?u=3e27bc6589085f3450be1b0e969d04008cc77565&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-10T13:31:09Z",
    "updated_at": "2021-09-10T13:31:09Z",
    "author_association": "CONTRIBUTOR",
    "body": "Fixed the CI issue. Ready for review.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916906730/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931290980",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-931290980",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 931290980,
    "node_id": "IC_kwDOABII5843gl9k",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?u=3e27bc6589085f3450be1b0e969d04008cc77565&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-30T12:49:25Z",
    "updated_at": "2021-09-30T12:49:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "I've changed the circular dependency-breaking to be as minimal as possible. The `check()` function is now parametrized by a coins cache and spend height rather than chainstate. The `removeForReorg()` function now takes a callable object to apply to each mempool entry, removing the ones for which it returns true.\r\n\r\nI've also written a bench for these 2 functions and taken the opportunity to speed `check()` up by eliminating the need to check mempool entries more than once. My bench results show a 35% speedup. Hopefully the performance improvement + circular dependency break is good enough to motivate these changes.\r\n\r\nBench at commit when the benchmark is first introduced:\r\n![image](https://user-images.githubusercontent.com/25183001/135457316-3829cabf-10fe-4b18-bf37-f411e24b3011.png)\r\n\r\n\r\nBench at HEAD of this PR:\r\n![image](https://user-images.githubusercontent.com/25183001/135457337-da5bd713-401e-4ef2-a2db-2de37120a910.png)\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931290980/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/932156870",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-932156870",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 932156870,
    "node_id": "IC_kwDOABII5843j5XG",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?u=3e27bc6589085f3450be1b0e969d04008cc77565&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-01T11:44:35Z",
    "updated_at": "2021-10-01T11:44:35Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rebased, addressed @jnewbery's comment, and separated the benches because it's a bit misleading to group them.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/932156870/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/932362098",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-932362098",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 932362098,
    "node_id": "IC_kwDOABII5843krdy",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?u=3e27bc6589085f3450be1b0e969d04008cc77565&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-01T16:09:04Z",
    "updated_at": "2021-10-01T16:09:04Z",
    "author_association": "CONTRIBUTOR",
    "body": "Split the PR up - first half is in #23157.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/932362098/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/950944753",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-950944753",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 950944753,
    "node_id": "IC_kwDOABII5844rkPx",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?u=3e27bc6589085f3450be1b0e969d04008cc77565&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-25T13:44:51Z",
    "updated_at": "2021-10-25T13:44:51Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rebased",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/950944753/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/967232495",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-967232495",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 967232495,
    "node_id": "IC_kwDOABII5845psvv",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?u=0691974eedcc2ab5366cc1080fb1c030e87244c2&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-12T16:08:37Z",
    "updated_at": "2021-11-12T16:08:37Z",
    "author_association": "MEMBER",
    "body": "Needs rebase?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/967232495/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969079001",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-969079001",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 969079001,
    "node_id": "IC_kwDOABII5845wvjZ",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?u=3e27bc6589085f3450be1b0e969d04008cc77565&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-15T16:23:22Z",
    "updated_at": "2021-11-15T16:23:22Z",
    "author_association": "CONTRIBUTOR",
    "body": "Thanks @MarcoFalke! silent merge conflict with #23211. Need to rethink approach since it's no longer possible to modify lockpoints from outside txmempool...",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969079001/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969088560",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-969088560",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 969088560,
    "node_id": "IC_kwDOABII5845wx4w",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?u=0691974eedcc2ab5366cc1080fb1c030e87244c2&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-15T16:33:13Z",
    "updated_at": "2021-11-15T16:33:13Z",
    "author_association": "MEMBER",
    "body": "That was a move-only, so can be reverted if needed. Maybe a `struct update_lock_points;` forward decl is enough?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969088560/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969102524",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-969102524",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 969102524,
    "node_id": "IC_kwDOABII5845w1S8",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?u=3e27bc6589085f3450be1b0e969d04008cc77565&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-15T16:47:59Z",
    "updated_at": "2021-11-15T16:47:59Z",
    "author_association": "CONTRIBUTOR",
    "body": "> That was a move-only, so can be reverted if needed. Maybe a `struct update_lock_points;` forward decl is enough?\r\n\r\nForward decl isn't enough because we need the constructor in order to call `update_lock_points(lp)`.\r\n\r\nCurrently, I'm leaning towards splitting `removeForReorg` into 2 loops: `CheckLockPoints` (leave inside txmempool) and `RemoveNonFinalAndPremature` (move to validation). There shouldn't be a performance penalty.\r\n\r\nReverting is also an option. I'm currently trying to figure out whether that's better. AFAICT, the `update_*` structs help provide an interface to modifying mempool entries while keeping the `txiter` type const (txmempool passes `txiters` and `setEntries`s to outside callers pretty freely). But since all modifications to entries should be done through txmempool's public member functions, perhaps it's better for them to be private. Will investigate further.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/969102524/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982592235",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-982592235",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 982592235,
    "node_id": "IC_kwDOABII5846kSrr",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?u=3e27bc6589085f3450be1b0e969d04008cc77565&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-30T12:30:59Z",
    "updated_at": "2021-11-30T12:30:59Z",
    "author_association": "CONTRIBUTOR",
    "body": "Rebased. If you have time, please take another look @mjdietzx @theStack @MarcoFalke?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982592235/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982876145",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#issuecomment-982876145",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22677",
    "id": 982876145,
    "node_id": "IC_kwDOABII5846lX_x",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?u=13b19d1ff2f5f914e180c41418f451a4ba6f8bd1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-30T17:52:13Z",
    "updated_at": "2021-11-30T17:52:13Z",
    "author_association": "MEMBER",
    "body": "Code review ACK a64078e38563ef3ac5e5ec20c07569441c87eeee",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/982876145/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714068419",
    "pull_request_review_id": 761087292,
    "id": 714068419,
    "node_id": "PRRC_kwDOABII584qj9HD",
    "diff_hunk": "@@ -563,39 +562,11 @@ void CTxMemPool::removeRecursive(const CTransaction &origTx, MemPoolRemovalReaso\n         RemoveStaged(setAllRemoves, false, reason);\n }\n \n-void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n+void CTxMemPool::removeForReorg(const setEntries& txToRemove)",
    "path": "src/txmempool.cpp",
    "position": null,
    "original_position": 13,
    "commit_id": "a64078e38563ef3ac5e5ec20c07569441c87eeee",
    "original_commit_id": "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I wonder if this function should be made more generic, into `RemoveWithDescendants(const setEntries& txToRemove, MemPoolRemovalReason reason)`, and then be called with `MemPoolRemovalReason::REORG` when removing transactions for a reorg. That'd deduplicate some of the code above in `removeRecursive()`.",
    "created_at": "2021-09-22T15:35:18Z",
    "updated_at": "2021-09-22T16:15:26Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714068419",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714068419"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714068419"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714068419/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 565,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714077176",
    "pull_request_review_id": 761087292,
    "id": 714077176,
    "node_id": "PRRC_kwDOABII584qj_P4",
    "diff_hunk": "@@ -366,8 +366,40 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n-    // We also need to remove any now-immature transactions\n-    m_mempool->removeForReorg(*this, STANDARD_LOCKTIME_VERIFY_FLAGS);\n+    // Remove transactions spending a coinbase which are now immature and no-longer-final transactions\n+    const auto filter_immature_nonfinal = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS]\n+        (CTxMemPool::txiter it) EXCLUSIVE_LOCKS_REQUIRED(cs_main, m_mempool->cs)\n+    {\n+        AssertLockHeld(cs_main);\n+        AssertLockHeld(m_mempool->cs);\n+        const CTransaction& tx = it->GetTx();\n+        LockPoints lp = it->GetLockPoints();\n+        bool validLP =  TestLockPointValidity(m_chain, &lp);",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 14,
    "commit_id": "a64078e38563ef3ac5e5ec20c07569441c87eeee",
    "original_commit_id": "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`TestLockPointValidity()` can now be static in validation.cpp, since it's not used outside of that translation unit.",
    "created_at": "2021-09-22T15:44:54Z",
    "updated_at": "2021-09-22T16:15:26Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714077176",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714077176"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714077176"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714077176/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 377,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714078655",
    "pull_request_review_id": 761087292,
    "id": 714078655,
    "node_id": "PRRC_kwDOABII584qj_m_",
    "diff_hunk": "@@ -563,39 +562,11 @@ void CTxMemPool::removeRecursive(const CTransaction &origTx, MemPoolRemovalReaso\n         RemoveStaged(setAllRemoves, false, reason);\n }\n \n-void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n+void CTxMemPool::removeForReorg(const setEntries& txToRemove)\n {\n-    // Remove transactions spending a coinbase which are now immature and no-longer-final transactions\n     AssertLockHeld(cs);\n-    setEntries txToRemove;\n-    for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n-        const CTransaction& tx = it->GetTx();\n-        LockPoints lp = it->GetLockPoints();\n-        bool validLP =  TestLockPointValidity(active_chainstate.m_chain, &lp);\n-        CCoinsViewMemPool view_mempool(&active_chainstate.CoinsTip(), *this);\n-        if (!CheckFinalTx(active_chainstate.m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(active_chainstate.m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            txToRemove.insert(it);",
    "path": "src/txmempool.cpp",
    "position": 54,
    "original_position": 27,
    "commit_id": "a64078e38563ef3ac5e5ec20c07569441c87eeee",
    "original_commit_id": "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This line has now been replaced by `return true;` in the lambda, which means that the `if (!validLP)` conditional below is not executed if we enter this branch. Is that intentional? If so, can you justify why it's safe to make that change?",
    "created_at": "2021-09-22T15:46:45Z",
    "updated_at": "2021-09-22T16:15:26Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714078655",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714078655"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714078655"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714078655/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 633,
    "original_line": 633,
    "side": "LEFT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714080918",
    "pull_request_review_id": 761087292,
    "id": 714080918,
    "node_id": "PRRC_kwDOABII584qkAKW",
    "diff_hunk": "@@ -671,19 +642,9 @@ void CTxMemPool::clear()\n     _clear();\n }\n \n-static void CheckInputsAndUpdateCoins(const CTransaction& tx, CCoinsViewCache& mempoolDuplicate, const int64_t spendheight)\n-{\n-    TxValidationState dummy_state; // Not used. CheckTxInputs() should always pass\n-    CAmount txfee = 0;\n-    bool fCheckResult = tx.IsCoinBase() || Consensus::CheckTxInputs(tx, dummy_state, mempoolDuplicate, spendheight, txfee);\n-    assert(fCheckResult);\n-    UpdateCoins(tx, mempoolDuplicate, std::numeric_limits<int>::max());\n-}\n-\n-void CTxMemPool::check(CChainState& active_chainstate) const\n+void CTxMemPool::check() const\n {\n     if (m_check_ratio == 0) return;\n-\n     if (GetRand(m_check_ratio) >= 1) return;",
    "path": "src/txmempool.cpp",
    "position": null,
    "original_position": 69,
    "commit_id": "a64078e38563ef3ac5e5ec20c07569441c87eeee",
    "original_commit_id": "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This seems like a behaviour change. Since `CTxMemPool::check()` is now called by `CChainState::CheckMempool()`, which itself has `if (GetRand(check_ratio) >= 1) return;`, then these checks will only get run 1/n^2 times.",
    "created_at": "2021-09-22T15:49:13Z",
    "updated_at": "2021-09-22T16:15:26Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714080918",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714080918"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714080918"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714080918/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 731,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714097289",
    "pull_request_review_id": 761087292,
    "id": 714097289,
    "node_id": "PRRC_kwDOABII584qkEKJ",
    "diff_hunk": "@@ -2288,7 +2288,7 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n             break;\n         }\n     }\n-    m_mempool.check(m_chainman.ActiveChainstate());",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "a64078e38563ef3ac5e5ec20c07569441c87eeee",
    "original_commit_id": "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "It'd be nice to remove these calls to mempool.check() from net_processing. It shouldn't be the client's responsibility to call into validation/mempool to check its invariants.\r\n\r\nThe diff is really easy:\r\n\r\n```diff\r\niff --git a/src/net_processing.cpp b/src/net_processing.cpp\r\nindex 80655c61e7..636b4d1102 100644\r\n--- a/src/net_processing.cpp\r\n+++ b/src/net_processing.cpp\r\n@@ -2288,7 +2288,6 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\r\n             break;\r\n         }\r\n     }\r\n-    m_mempool.check(m_chainman.ActiveChainstate());\r\n }\r\n \r\n bool PeerManagerImpl::PrepareBlockFilterRequest(CNode& peer,\r\n@@ -3250,7 +3249,6 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\r\n         const TxValidationState& state = result.m_state;\r\n \r\n         if (result.m_result_type == MempoolAcceptResult::ResultType::VALID) {\r\n-            m_mempool.check(m_chainman.ActiveChainstate());\r\n             // As this version of the transaction was acceptable, we can forget about any\r\n             // requests for it.\r\n             m_txrequest.ForgetTxHash(tx.GetHash());\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 2a66d96f22..8f1f33782b 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -1041,7 +1041,9 @@ static MempoolAcceptResult AcceptToMemoryPoolWithTime(const CChainParams& chainp\r\n MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPool& pool, const CTransactionRef& tx,\r\n                                        bool bypass_limits, bool test_accept)\r\n {\r\n-    return AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\r\n+    auto ret = AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\r\n+    pool.check(active_chainstate);\r\n+    return ret;\r\n }\r\n \r\n PackageMempoolAcceptResult ProcessNewPackage(CChainState& active_chainstate, CTxMemPool& pool,\r\n```\r\nbranch here: https://github.com/jnewbery/bitcoin/tree/2021-09-no-mempool-check-in-net-processing\r\n\r\nThat's a _slight_ behaviour change since check() will get called a little more often, so it doesn't fit inside this PR, but by doing it first, this PR wouldn't need to touch net_processing. Thoughts?",
    "created_at": "2021-09-22T16:07:27Z",
    "updated_at": "2021-09-22T16:15:26Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714097289",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714097289"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r714097289"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/714097289/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2301,
    "side": "LEFT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718853068",
    "pull_request_review_id": 767146915,
    "id": 718853068,
    "node_id": "PRRC_kwDOABII584q2NPM",
    "diff_hunk": "@@ -563,39 +562,11 @@ void CTxMemPool::removeRecursive(const CTransaction &origTx, MemPoolRemovalReaso\n         RemoveStaged(setAllRemoves, false, reason);\n }\n \n-void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n+void CTxMemPool::removeForReorg(const setEntries& txToRemove)\n {\n-    // Remove transactions spending a coinbase which are now immature and no-longer-final transactions\n     AssertLockHeld(cs);\n-    setEntries txToRemove;\n-    for (indexed_transaction_set::const_iterator it = mapTx.begin(); it != mapTx.end(); it++) {\n-        const CTransaction& tx = it->GetTx();\n-        LockPoints lp = it->GetLockPoints();\n-        bool validLP =  TestLockPointValidity(active_chainstate.m_chain, &lp);\n-        CCoinsViewMemPool view_mempool(&active_chainstate.CoinsTip(), *this);\n-        if (!CheckFinalTx(active_chainstate.m_chain.Tip(), tx, flags)\n-            || !CheckSequenceLocks(active_chainstate.m_chain.Tip(), view_mempool, tx, flags, &lp, validLP)) {\n-            // Note if CheckSequenceLocks fails the LockPoints may still be invalid\n-            // So it's critical that we remove the tx and not depend on the LockPoints.\n-            txToRemove.insert(it);",
    "path": "src/txmempool.cpp",
    "position": 54,
    "original_position": 27,
    "commit_id": "a64078e38563ef3ac5e5ec20c07569441c87eeee",
    "original_commit_id": "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Good catch, switched it to be updating a `bool should_remove` and returning at the end instead :)",
    "created_at": "2021-09-29T20:17:42Z",
    "updated_at": "2021-09-29T20:17:42Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718853068",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718853068"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718853068"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718853068/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 633,
    "original_line": 633,
    "side": "LEFT",
    "in_reply_to_id": 714078655
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718853463",
    "pull_request_review_id": 767147448,
    "id": 718853463,
    "node_id": "PRRC_kwDOABII584q2NVX",
    "diff_hunk": "@@ -671,19 +642,9 @@ void CTxMemPool::clear()\n     _clear();\n }\n \n-static void CheckInputsAndUpdateCoins(const CTransaction& tx, CCoinsViewCache& mempoolDuplicate, const int64_t spendheight)\n-{\n-    TxValidationState dummy_state; // Not used. CheckTxInputs() should always pass\n-    CAmount txfee = 0;\n-    bool fCheckResult = tx.IsCoinBase() || Consensus::CheckTxInputs(tx, dummy_state, mempoolDuplicate, spendheight, txfee);\n-    assert(fCheckResult);\n-    UpdateCoins(tx, mempoolDuplicate, std::numeric_limits<int>::max());\n-}\n-\n-void CTxMemPool::check(CChainState& active_chainstate) const\n+void CTxMemPool::check() const\n {\n     if (m_check_ratio == 0) return;\n-\n     if (GetRand(m_check_ratio) >= 1) return;",
    "path": "src/txmempool.cpp",
    "position": null,
    "original_position": 69,
    "commit_id": "a64078e38563ef3ac5e5ec20c07569441c87eeee",
    "original_commit_id": "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "keeping `check_ratio` checking inside the mempool function now",
    "created_at": "2021-09-29T20:18:16Z",
    "updated_at": "2021-09-29T20:18:16Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718853463",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718853463"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718853463"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718853463/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 731,
    "side": "RIGHT",
    "in_reply_to_id": 714080918
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718855206",
    "pull_request_review_id": 767149786,
    "id": 718855206,
    "node_id": "PRRC_kwDOABII584q2Nwm",
    "diff_hunk": "@@ -2288,7 +2288,7 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n             break;\n         }\n     }\n-    m_mempool.check(m_chainman.ActiveChainstate());",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "a64078e38563ef3ac5e5ec20c07569441c87eeee",
    "original_commit_id": "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Didn't end up taking this change, though I tried to at first, because I agree that it _should_ be the mempool, or at the very least, chainstate manager's job to sanity check the mempool, not net processing.\r\n\r\nThe problem is that we call ATMP from the reorg code, and we shouldn't call `check()` then because the mempool can temporarily be in a state where not all inputs are available from the chainstate coins cache. This causes the `check()` assertions to fail.",
    "created_at": "2021-09-29T20:20:49Z",
    "updated_at": "2021-09-29T20:20:49Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718855206",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718855206"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718855206"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718855206/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2301,
    "side": "LEFT",
    "in_reply_to_id": 714097289
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718855938",
    "pull_request_review_id": 767150766,
    "id": 718855938,
    "node_id": "PRRC_kwDOABII584q2N8C",
    "diff_hunk": "@@ -563,39 +562,11 @@ void CTxMemPool::removeRecursive(const CTransaction &origTx, MemPoolRemovalReaso\n         RemoveStaged(setAllRemoves, false, reason);\n }\n \n-void CTxMemPool::removeForReorg(CChainState& active_chainstate, int flags)\n+void CTxMemPool::removeForReorg(const setEntries& txToRemove)",
    "path": "src/txmempool.cpp",
    "position": null,
    "original_position": 13,
    "commit_id": "a64078e38563ef3ac5e5ec20c07569441c87eeee",
    "original_commit_id": "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Agree about consolidating duplicate code, but I don't think it helps much with this PR - maybe for a followup?",
    "created_at": "2021-09-29T20:21:59Z",
    "updated_at": "2021-09-29T20:22:07Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718855938",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718855938"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r718855938"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/718855938/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 565,
    "side": "RIGHT",
    "in_reply_to_id": 714068419
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719508493",
    "pull_request_review_id": 768002466,
    "id": 719508493,
    "node_id": "PRRC_kwDOABII584q4tQN",
    "diff_hunk": "@@ -367,8 +367,42 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n+    const auto check_validity_and_lp = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+        EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n+        bool should_remove = false;\n+        AssertLockHeld(m_mempool->cs);\n+        AssertLockHeld(::cs_main);\n+        const CTransaction& tx = it->GetTx();\n+        LockPoints lp = it->GetLockPoints();\n+        bool validLP = TestLockPointValidity(m_chain, &lp);",
    "path": "src/validation.cpp",
    "position": 36,
    "original_position": 11,
    "commit_id": "a64078e38563ef3ac5e5ec20c07569441c87eeee",
    "original_commit_id": "48a5b1b3eb57c100cc49b58d8f38f2ca7786d837",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`TestLockPointValidity()` can now be static since it's not called from outside this translation unit.",
    "created_at": "2021-09-30T15:13:00Z",
    "updated_at": "2021-09-30T15:13:00Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r719508493",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719508493"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r719508493"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719508493/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 360,
    "original_line": 360,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719513233",
    "pull_request_review_id": 768008993,
    "id": 719513233,
    "node_id": "PRRC_kwDOABII584q4uaR",
    "diff_hunk": "@@ -2288,7 +2288,7 @@ void PeerManagerImpl::ProcessOrphanTx(std::set<uint256>& orphan_work_set)\n             break;\n         }\n     }\n-    m_mempool.check(m_chainman.ActiveChainstate());",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "a64078e38563ef3ac5e5ec20c07569441c87eeee",
    "original_commit_id": "ab3fef71edf2a9e3a36a15c1af6a360cccfa5b30",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> The problem is that we call ATMP from the reorg code, and we shouldn't call check() then because the mempool can temporarily be in a state where not all inputs are available from the chainstate coins cache. This causes the check() assertions to fail.\r\n\r\nYes, I'd forgotten that ATMP could be called while the mempool is in an inconsistent state.\r\n\r\nThe fix is to only call `check()` after ATMP has been called from outside validation. I have a branch that implements a `ChainstateManager.ProcessTransaction()` interface method which does exactly that: https://github.com/jnewbery/bitcoin/tree/2021-09-process-transaction. I'll probably go ahead and PR that soon unless you think it should wait until after this PR.",
    "created_at": "2021-09-30T15:18:10Z",
    "updated_at": "2021-09-30T15:18:10Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r719513233",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719513233"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r719513233"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719513233/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2301,
    "side": "LEFT",
    "in_reply_to_id": 714097289
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720207046",
    "pull_request_review_id": 768904131,
    "id": 720207046,
    "node_id": "PRRC_kwDOABII584q7XzG",
    "diff_hunk": "@@ -367,8 +367,42 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     // the disconnectpool that were added back and cleans up the mempool state.\n     m_mempool->UpdateTransactionsFromBlock(vHashUpdate);\n \n+    const auto check_validity_and_lp = [this, flags=STANDARD_LOCKTIME_VERIFY_FLAGS](CTxMemPool::txiter it)\n+        EXCLUSIVE_LOCKS_REQUIRED(m_mempool->cs, ::cs_main) {\n+        bool should_remove = false;\n+        AssertLockHeld(m_mempool->cs);\n+        AssertLockHeld(::cs_main);\n+        const CTransaction& tx = it->GetTx();\n+        LockPoints lp = it->GetLockPoints();\n+        bool validLP = TestLockPointValidity(m_chain, &lp);",
    "path": "src/validation.cpp",
    "position": 36,
    "original_position": 11,
    "commit_id": "a64078e38563ef3ac5e5ec20c07569441c87eeee",
    "original_commit_id": "48a5b1b3eb57c100cc49b58d8f38f2ca7786d837",
    "user": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done",
    "created_at": "2021-10-01T12:32:40Z",
    "updated_at": "2021-10-01T12:32:40Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r720207046",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720207046"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22677#discussion_r720207046"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22677"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720207046/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 360,
    "original_line": 360,
    "side": "RIGHT",
    "in_reply_to_id": 719508493
  }
]