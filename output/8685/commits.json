[
  {
    "sha": "194343fceb868902e0a0972f2bc9225a83d7db1b",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxOTQzNDNmY2ViODY4OTAyZTBhMDk3MmYyYmM5MjI1YTgzZDdkYjFi",
    "commit": {
      "author": {
        "name": "Johnson Lau",
        "email": "jl2012@xbt.hk",
        "date": "2016-09-08T18:08:01Z"
      },
      "committer": {
        "name": "Johnson Lau",
        "email": "jl2012@xbt.hk",
        "date": "2016-09-08T18:41:57Z"
      },
      "message": "Discourage P2WSH with too big script or stack\n\nThis implements a policy limit for P2WSH, with witnessScript <= 3600 bytes, witness stack item size <= 80 bytes, and witness stack items <= 100",
      "tree": {
        "sha": "a7b3f0c659f6564db7f00b329a6d27f5b052178f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a7b3f0c659f6564db7f00b329a6d27f5b052178f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/194343fceb868902e0a0972f2bc9225a83d7db1b",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/194343fceb868902e0a0972f2bc9225a83d7db1b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/194343fceb868902e0a0972f2bc9225a83d7db1b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/194343fceb868902e0a0972f2bc9225a83d7db1b/comments",
    "author": {
      "login": "jl2012",
      "id": 8403418,
      "node_id": "MDQ6VXNlcjg0MDM0MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8403418?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jl2012",
      "html_url": "https://github.com/jl2012",
      "followers_url": "https://api.github.com/users/jl2012/followers",
      "following_url": "https://api.github.com/users/jl2012/following{/other_user}",
      "gists_url": "https://api.github.com/users/jl2012/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jl2012/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jl2012/subscriptions",
      "organizations_url": "https://api.github.com/users/jl2012/orgs",
      "repos_url": "https://api.github.com/users/jl2012/repos",
      "events_url": "https://api.github.com/users/jl2012/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jl2012/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jl2012",
      "id": 8403418,
      "node_id": "MDQ6VXNlcjg0MDM0MTg=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8403418?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jl2012",
      "html_url": "https://github.com/jl2012",
      "followers_url": "https://api.github.com/users/jl2012/followers",
      "following_url": "https://api.github.com/users/jl2012/following{/other_user}",
      "gists_url": "https://api.github.com/users/jl2012/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jl2012/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jl2012/subscriptions",
      "organizations_url": "https://api.github.com/users/jl2012/orgs",
      "repos_url": "https://api.github.com/users/jl2012/repos",
      "events_url": "https://api.github.com/users/jl2012/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jl2012/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ddc308068d69c6c9aa629ee3c4ce75e1d1cf08b5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ddc308068d69c6c9aa629ee3c4ce75e1d1cf08b5",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ddc308068d69c6c9aa629ee3c4ce75e1d1cf08b5"
      }
    ],
    "stats": {
      "total": 32,
      "additions": 30,
      "deletions": 2
    },
    "files": [
      {
        "sha": "e132815f5a8ad850259414878937d7edc818e9f9",
        "filename": "src/policy/policy.h",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/194343fceb868902e0a0972f2bc9225a83d7db1b/src/policy/policy.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/194343fceb868902e0a0972f2bc9225a83d7db1b/src/policy/policy.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/policy/policy.h?ref=194343fceb868902e0a0972f2bc9225a83d7db1b",
        "patch": "@@ -46,7 +46,8 @@ static const unsigned int STANDARD_SCRIPT_VERIFY_FLAGS = MANDATORY_SCRIPT_VERIFY\n                                                          SCRIPT_VERIFY_CHECKSEQUENCEVERIFY |\n                                                          SCRIPT_VERIFY_LOW_S |\n                                                          SCRIPT_VERIFY_WITNESS |\n-                                                         SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM;\n+                                                         SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM |\n+                                                         SCRIPT_VERIFY_DISCOURAGE_BIG_P2WSH;\n \n /** For convenience, standard but not mandatory verify flags. */\n static const unsigned int STANDARD_NOT_MANDATORY_VERIFY_FLAGS = STANDARD_SCRIPT_VERIFY_FLAGS & ~MANDATORY_SCRIPT_VERIFY_FLAGS;"
      },
      {
        "sha": "0e00feafd8cde05a586af0bd36e65586fcb0c6a2",
        "filename": "src/script/interpreter.cpp",
        "status": "modified",
        "additions": 13,
        "deletions": 0,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/194343fceb868902e0a0972f2bc9225a83d7db1b/src/script/interpreter.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/194343fceb868902e0a0972f2bc9225a83d7db1b/src/script/interpreter.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/interpreter.cpp?ref=194343fceb868902e0a0972f2bc9225a83d7db1b",
        "patch": "@@ -1337,6 +1337,9 @@ static bool VerifyWitnessProgram(const CScriptWitness& witness, int witversion,\n             if (memcmp(hashScriptPubKey.begin(), &program[0], 32)) {\n                 return set_error(serror, SCRIPT_ERR_WITNESS_PROGRAM_MISMATCH);\n             }\n+            if ((flags & SCRIPT_VERIFY_DISCOURAGE_BIG_P2WSH) && witness.stack.back().size() > 3600) {\n+                return set_error(serror, SCRIPT_ERR_DISCOURAGE_BIG_P2WSH); // Policy limit for witnessScript size\n+            }\n         } else if (program.size() == 20) {\n             // Special case for pay-to-pubkeyhash; signature + pubkey in witness\n             if (witness.stack.size() != 2) {\n@@ -1354,6 +1357,16 @@ static bool VerifyWitnessProgram(const CScriptWitness& witness, int witversion,\n         return set_success(serror);\n     }\n \n+    // Policy limit for stack size and stack element size\n+    if (flags & SCRIPT_VERIFY_DISCOURAGE_BIG_P2WSH) {\n+        if (stack.size() > 100)\n+            return set_error(serror, SCRIPT_ERR_DISCOURAGE_BIG_P2WSH);\n+        for (unsigned int i = 0; i < stack.size(); i++) {\n+            if (stack.at(i).size() > 80)\n+                return set_error(serror, SCRIPT_ERR_DISCOURAGE_BIG_P2WSH);\n+        }\n+    }\n+\n     // Disallow stack item size > MAX_SCRIPT_ELEMENT_SIZE in witness stack\n     for (unsigned int i = 0; i < stack.size(); i++) {\n         if (stack.at(i).size() > MAX_SCRIPT_ELEMENT_SIZE)"
      },
      {
        "sha": "45910853d777bc2d16d6128acfa6039a4e4ceadd",
        "filename": "src/script/interpreter.h",
        "status": "modified",
        "additions": 7,
        "deletions": 0,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/194343fceb868902e0a0972f2bc9225a83d7db1b/src/script/interpreter.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/194343fceb868902e0a0972f2bc9225a83d7db1b/src/script/interpreter.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/interpreter.h?ref=194343fceb868902e0a0972f2bc9225a83d7db1b",
        "patch": "@@ -94,6 +94,13 @@ enum\n     // Making v1-v16 witness program non-standard\n     //\n     SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM = (1U << 12),\n+\n+    // Discourage use of too big P2WSH script or stack\n+    //\n+    // This implements a policy limit for P2WSH, with witnessScript <= 3600 bytes,\n+    // witness stack item size <= 80 bytes, and witness stack items <= 100\n+    // Never be a mandatory flag\n+    SCRIPT_VERIFY_DISCOURAGE_BIG_P2WSH = (1U << 15),\n };\n \n bool CheckSignatureEncoding(const std::vector<unsigned char> &vchSig, unsigned int flags, ScriptError* serror);"
      },
      {
        "sha": "7735c631836af1f4bba0864b9d86c58e0456796c",
        "filename": "src/script/script_error.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/194343fceb868902e0a0972f2bc9225a83d7db1b/src/script/script_error.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/194343fceb868902e0a0972f2bc9225a83d7db1b/src/script/script_error.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/script_error.cpp?ref=194343fceb868902e0a0972f2bc9225a83d7db1b",
        "patch": "@@ -81,6 +81,8 @@ const char* ScriptErrorString(const ScriptError serror)\n             return \"Witness requires only-redeemscript scriptSig\";\n         case SCRIPT_ERR_WITNESS_UNEXPECTED:\n             return \"Witness provided for non-witness script\";\n+        case SCRIPT_ERR_DISCOURAGE_BIG_P2WSH:\n+            return \"P2WSH size is beyond policy limit\";\n         case SCRIPT_ERR_UNKNOWN_ERROR:\n         case SCRIPT_ERR_ERROR_COUNT:\n         default: break;"
      },
      {
        "sha": "8ca9064255fc68b7cec7c83d8f0dc5aad9263b44",
        "filename": "src/script/script_error.h",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/194343fceb868902e0a0972f2bc9225a83d7db1b/src/script/script_error.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/194343fceb868902e0a0972f2bc9225a83d7db1b/src/script/script_error.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/script_error.h?ref=194343fceb868902e0a0972f2bc9225a83d7db1b",
        "patch": "@@ -61,6 +61,9 @@ typedef enum ScriptError_t\n     SCRIPT_ERR_WITNESS_MALLEATED_P2SH,\n     SCRIPT_ERR_WITNESS_UNEXPECTED,\n \n+    /* resources policy */\n+    SCRIPT_ERR_DISCOURAGE_BIG_P2WSH,\n+\n     SCRIPT_ERR_ERROR_COUNT\n } ScriptError;\n "
      },
      {
        "sha": "541b00b7f77a2e0bde005a5607e5e30f26b007ad",
        "filename": "src/test/script_tests.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/194343fceb868902e0a0972f2bc9225a83d7db1b/src/test/script_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/194343fceb868902e0a0972f2bc9225a83d7db1b/src/test/script_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/script_tests.cpp?ref=194343fceb868902e0a0972f2bc9225a83d7db1b",
        "patch": "@@ -91,6 +91,7 @@ static ScriptErrorDesc script_errors[]={\n     {SCRIPT_ERR_CLEANSTACK, \"CLEANSTACK\"},\n     {SCRIPT_ERR_DISCOURAGE_UPGRADABLE_NOPS, \"DISCOURAGE_UPGRADABLE_NOPS\"},\n     {SCRIPT_ERR_DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM, \"DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM\"},\n+    {SCRIPT_ERR_DISCOURAGE_BIG_P2WSH, \"DISCOURAGE_BIG_P2WSH\"},\n     {SCRIPT_ERR_WITNESS_PROGRAM_WRONG_LENGTH, \"WITNESS_PROGRAM_WRONG_LENGTH\"},\n     {SCRIPT_ERR_WITNESS_PROGRAM_WITNESS_EMPTY, \"WITNESS_PROGRAM_WITNESS_EMPTY\"},\n     {SCRIPT_ERR_WITNESS_PROGRAM_MISMATCH, \"WITNESS_PROGRAM_MISMATCH\"},"
      },
      {
        "sha": "350ef6b9b7746086ecb4f13341ce38ed6c3d6709",
        "filename": "src/test/transaction_tests.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/194343fceb868902e0a0972f2bc9225a83d7db1b/src/test/transaction_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/194343fceb868902e0a0972f2bc9225a83d7db1b/src/test/transaction_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/transaction_tests.cpp?ref=194343fceb868902e0a0972f2bc9225a83d7db1b",
        "patch": "@@ -53,7 +53,8 @@ static std::map<string, unsigned int> mapFlagNames = boost::assign::map_list_of\n     (string(\"CHECKLOCKTIMEVERIFY\"), (unsigned int)SCRIPT_VERIFY_CHECKLOCKTIMEVERIFY)\n     (string(\"CHECKSEQUENCEVERIFY\"), (unsigned int)SCRIPT_VERIFY_CHECKSEQUENCEVERIFY)\n     (string(\"WITNESS\"), (unsigned int)SCRIPT_VERIFY_WITNESS)\n-    (string(\"DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM\"), (unsigned int)SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM);\n+    (string(\"DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM\"), (unsigned int)SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_WITNESS_PROGRAM)\n+    (string(\"DISCOURAGE_BIG_P2WSH\"), (unsigned int)SCRIPT_VERIFY_DISCOURAGE_BIG_P2WSH);\n \n unsigned int ParseScriptFlags(string strFlags)\n {"
      }
    ]
  }
]