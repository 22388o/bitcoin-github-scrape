[
  {
    "sha": "235b3a789d6c54b042a241ffcfaba4404f6245fa",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyMzViM2E3ODlkNmM1NGIwNDJhMjQxZmZjZmFiYTQ0MDRmNjI0NWZh",
    "commit": {
      "author": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2015-05-14T01:12:04Z"
      },
      "committer": {
        "name": "Cory Fields",
        "email": "cory-nospam-@coryfields.com",
        "date": "2015-05-14T05:33:07Z"
      },
      "message": "depends: sanity-check sources and cached builds\n\nIn some cases (Travis), sources and build caches may be moved around in-between\nbuilds, and we can't necessarily trust that everything is still intact.\n\nThis introduces pre-build checks that verify against stashed checksums.\n\nNote that this will cause all sources to be re-downloaded, since cached sources\nweren't trustworthy before this.",
      "tree": {
        "sha": "3e96e49c64c89b5ad44389268dd5756ee1095560",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3e96e49c64c89b5ad44389268dd5756ee1095560"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/235b3a789d6c54b042a241ffcfaba4404f6245fa",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/235b3a789d6c54b042a241ffcfaba4404f6245fa",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/235b3a789d6c54b042a241ffcfaba4404f6245fa",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/235b3a789d6c54b042a241ffcfaba4404f6245fa/comments",
    "author": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "351f73ecd5d44bf6b80f45ab2e1aaa25a08c5c8c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/351f73ecd5d44bf6b80f45ab2e1aaa25a08c5c8c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/351f73ecd5d44bf6b80f45ab2e1aaa25a08c5c8c"
      }
    ],
    "stats": {
      "total": 59,
      "additions": 49,
      "deletions": 10
    },
    "files": [
      {
        "sha": "ef5a20e6c36aa9c9cbb0fa9334ec8d24824a0bc2",
        "filename": "depends/Makefile",
        "status": "modified",
        "additions": 34,
        "deletions": 6,
        "changes": 40,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/235b3a789d6c54b042a241ffcfaba4404f6245fa/depends/Makefile",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/235b3a789d6c54b042a241ffcfaba4404f6245fa/depends/Makefile",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/depends/Makefile?ref=235b3a789d6c54b042a241ffcfaba4404f6245fa",
        "patch": "@@ -91,12 +91,12 @@ include funcs.mk\n toolchain_path=$($($(host_arch)_$(host_os)_native_toolchain)_prefixbin)\n final_build_id_long+=$(shell $(build_SHA256SUM) config.site.in)\n final_build_id+=$(shell echo -n $(final_build_id_long) | $(build_SHA256SUM) | cut -c-$(HASH_LENGTH))\n-$(host_prefix)/.stamp_$(final_build_id): | $(native_packages) $(packages)\n+$(host_prefix)/.stamp_$(final_build_id): $(native_packages) $(packages)\n \t$(AT)rm -rf $(@D)\n \t$(AT)mkdir -p $(@D)\n-\t$(AT)echo copying packages: $|\n+\t$(AT)echo copying packages: $^\n \t$(AT)echo to: $(@D)\n-\t$(AT)cd $(@D); $(foreach package,$|, tar xf $($(package)_cached); )\n+\t$(AT)cd $(@D); $(foreach package,$^, tar xf $($(package)_cached); )\n \t$(AT)touch $@\n \n $(host_prefix)/share/config.site : config.site.in $(host_prefix)/.stamp_$(final_build_id)\n@@ -121,13 +121,41 @@ $(host_prefix)/share/config.site : config.site.in $(host_prefix)/.stamp_$(final_\n             $< > $@\n \t$(AT)touch $@\n \n-install: $(host_prefix)/share/config.site\n-download-one: $(all_sources)\n+\n+define check_or_remove_cached\n+  mkdir -p $(BASE_CACHE)/$(host)/$(package) && cd $(BASE_CACHE)/$(host)/$(package); \\\n+  $(build_SHA256SUM) -c $($(package)_cached_checksum) >/dev/null 2>/dev/null || \\\n+  ( rm -f $($(package)_cached_checksum); \\\n+    if test -f \"$($(package)_cached)\"; then echo \"Checksum mismatch for $(package). Forcing rebuild..\"; rm -f $($(package)_cached_checksum) $($(package)_cached); fi )\n+endef\n+\n+define check_or_remove_sources\n+  mkdir -p $($(package)_source_dir); cd $($(package)_source_dir); \\\n+  $(build_SHA256SUM) -c $($(package)_fetched) >/dev/null 2>/dev/null || \\\n+    ( if test -f $($(package)_all_sources); then echo \"Checksum missing or mismatched for $(package) source. Forcing re-download.\"; fi; \\\n+      rm -f $($(package)_all_sources) $($(1)_fetched))\n+endef\n+\n+check-packages:\n+\t@$(foreach package,$(all_packages),$(call check_or_remove_cached,$(package));)\n+check-sources:\n+\t@$(foreach package,$(all_packages),$(call check_or_remove_sources,$(package));)\n+\n+$(host_prefix)/share/config.site: check-packages\n+\n+check-packages: check-sources\n+\n+install: check-packages $(host_prefix)/share/config.site\n+\n+\n+download-one: check-sources $(all_sources)\n+\n download-osx:\n \t@$(MAKE) -s HOST=x86_64-apple-darwin11 download-one\n download-linux:\n \t@$(MAKE) -s HOST=x86_64-unknown-linux-gnu download-one\n download-win:\n \t@$(MAKE) -s HOST=x86_64-w64-mingw32 download-one\n download: download-osx download-linux download-win\n-.PHONY: install cached download-one download-osx download-linux download-win download\n+\n+.PHONY: install cached download-one download-osx download-linux download-win download check-packages check-sources"
      },
      {
        "sha": "6d87402ebc1bbc0e89bf91a69ee2613c050f4ace",
        "filename": "depends/README.packages",
        "status": "modified",
        "additions": 3,
        "deletions": 1,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/235b3a789d6c54b042a241ffcfaba4404f6245fa/depends/README.packages",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/235b3a789d6c54b042a241ffcfaba4404f6245fa/depends/README.packages",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/depends/README.packages?ref=235b3a789d6c54b042a241ffcfaba4404f6245fa",
        "patch": "@@ -30,7 +30,9 @@ These variables are optional:\n     Names of any other packages that this one depends on.\n   $(package)_patches:\n     Filenames of any patches needed to build the package\n-\n+  $(package)_extra_sources:\n+    Any extra files that will be fetched via $(package)_fetch_cmds. These are\n+    specified so that they can be fetched and verified via 'make download'.\n \n Build Variables:\n After defining the main identifiers, build variables may be added or customized"
      },
      {
        "sha": "050a9b132137e5aa0a24ff3448abadbe0733dc62",
        "filename": "depends/funcs.mk",
        "status": "modified",
        "additions": 10,
        "deletions": 3,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/235b3a789d6c54b042a241ffcfaba4404f6245fa/depends/funcs.mk",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/235b3a789d6c54b042a241ffcfaba4404f6245fa/depends/funcs.mk",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/depends/funcs.mk?ref=235b3a789d6c54b042a241ffcfaba4404f6245fa",
        "patch": "@@ -53,12 +53,14 @@ $(1)_staging_prefix_dir:=$$($(1)_staging_dir)$($($(1)_type)_prefix)\n $(1)_extract_dir:=$(base_build_dir)/$(host)/$(1)/$($(1)_version)-$($(1)_build_id)\n $(1)_download_dir:=$(base_download_dir)/$(1)-$($(1)_version)\n $(1)_build_dir:=$$($(1)_extract_dir)/$$($(1)_build_subdir)\n+$(1)_cached_checksum:=$(BASE_CACHE)/$(host)/$(1)/$(1)-$($(1)_version)-$($(1)_build_id).tar.gz.hash\n $(1)_patch_dir:=$(base_build_dir)/$(host)/$(1)/$($(1)_version)-$($(1)_build_id)/.patches-$($(1)_build_id)\n $(1)_prefixbin:=$($($(1)_type)_prefix)/bin/\n $(1)_cached:=$(BASE_CACHE)/$(host)/$(1)/$(1)-$($(1)_version)-$($(1)_build_id).tar.gz\n+$(1)_all_sources=$($(1)_file_name) $($(1)_extra_sources)\n \n #stamps\n-$(1)_fetched=$$($(1)_source_dir)/download-stamps/.stamp_fetched-$(1)-$($(1)_file_name)\n+$(1)_fetched=$(SOURCES_PATH)/download-stamps/.stamp_fetched-$(1)-$($(1)_file_name).hash\n $(1)_extracted=$$($(1)_extract_dir)/.stamp_extracted\n $(1)_preprocessed=$$($(1)_extract_dir)/.stamp_preprocessed\n $(1)_cleaned=$$($(1)_extract_dir)/.stamp_cleaned\n@@ -154,7 +156,10 @@ endef\n define int_add_cmds\n $($(1)_fetched):\n \t$(AT)mkdir -p $$(@D) $(SOURCES_PATH)\n+\t$(AT)rm -f $$@\n+\t$(AT)touch $$@\n \t$(AT)cd $$(@D); $(call $(1)_fetch_cmds,$(1))\n+\t$(AT)cd $($(1)_source_dir); $(foreach source,$($(1)_all_sources),$(build_SHA256SUM) $(source) >> $$(@);)\n \t$(AT)touch $$@\n $($(1)_extracted): | $($(1)_fetched)\n \t$(AT)echo Extracting $(1)...\n@@ -195,10 +200,12 @@ $($(1)_cached): | $($(1)_dependencies) $($(1)_postprocessed)\n \t$(AT)rm -rf $$(@D) && mkdir -p $$(@D)\n \t$(AT)mv $$($(1)_staging_dir)/$$(@F) $$(@)\n \t$(AT)rm -rf $($(1)_staging_dir)\n+$($(1)_cached_checksum): $($(1)_cached)\n+\t$(AT)cd $$(@D); $(build_SHA256SUM) $$(<F) > $$(@)\n \n .PHONY: $(1)\n-$(1): | $($(1)_cached)\n-.SECONDARY: $($(1)_postprocessed) $($(1)_staged) $($(1)_built) $($(1)_configured) $($(1)_preprocessed) $($(1)_extracted) $($(1)_fetched)\n+$(1): | $($(1)_cached_checksum)\n+.SECONDARY: $($(1)_cached) $($(1)_postprocessed) $($(1)_staged) $($(1)_built) $($(1)_configured) $($(1)_preprocessed) $($(1)_extracted) $($(1)_fetched)\n \n endef\n "
      },
      {
        "sha": "1c1bcf199a0bd20fcf3c5f0cea83cedeb9cb6d04",
        "filename": "depends/packages/native_cctools.mk",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/235b3a789d6c54b042a241ffcfaba4404f6245fa/depends/packages/native_cctools.mk",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/235b3a789d6c54b042a241ffcfaba4404f6245fa/depends/packages/native_cctools.mk",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/depends/packages/native_cctools.mk?ref=235b3a789d6c54b042a241ffcfaba4404f6245fa",
        "patch": "@@ -9,6 +9,8 @@ $(package)_clang_download_path=http://llvm.org/releases/$($(package)_clang_versi\n $(package)_clang_download_file=clang+llvm-$($(package)_clang_version)-amd64-Ubuntu-12.04.2.tar.gz\n $(package)_clang_file_name=clang-llvm-$($(package)_clang_version)-amd64-Ubuntu-12.04.2.tar.gz\n $(package)_clang_sha256_hash=60d8f69f032d62ef61bf527857ebb933741ec3352d4d328c5516aa520662dab7\n+$(package)_extra_sources=$($(package)_clang_file_name)\n+\n define $(package)_fetch_cmds\n $(call fetch_file,$(package),$($(package)_download_path),$($(package)_download_file),$($(package)_file_name),$($(package)_sha256_hash)) && \\\n $(call fetch_file,$(package),$($(package)_clang_download_path),$($(package)_clang_download_file),$($(package)_clang_file_name),$($(package)_clang_sha256_hash))"
      }
    ]
  }
]