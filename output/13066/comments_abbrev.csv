MarcoFalke,2018-04-24T13:35:01Z,"> The cron job that runs every day would fail because of git checkout a single commit, not a branch.\n\nMind to elaborate why it wouldn't work on a ""single commit""?",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-383932454,383932454,
ken2812221,2018-04-24T13:49:36Z,"`git rev-parse --abbrev-ref HEAD` does not work with commit, it always returns `HEAD`.\nAnd git would not return to latest commit after the script.\nBut I don't know if this is the exact reason. I just test on my PC, the script failed to check signature at random commit.",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-383937635,383937635,
laanwj,2018-04-24T15:27:57Z,"> Also, I modify the current shell script to python, it makes the script speed up a lot.\n> The python code tree_sha512sum was copied from github-merge.py\n\nThanks! Yes, the current implementation has been slow especially the treehash512 checking, my implementation from `github-merge.py` only uses a single call to `ls-tree` which makes it more efficient.\n\nConcept ACK.\n",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-383975065,383975065,
MarcoFalke,2018-04-24T15:35:03Z,"I think we should remove the shell script after this has been converted to python. Objections, @TheBlueMatt ?",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-383977612,383977612,
sipa,2018-04-24T18:17:01Z,"All the unclean merge commits are from 2016 or earlier. Perhaps instead there can just be a threshold that skips the validation below a certain age (say, 1 month)?",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-384030349,384030349,
ken2812221,2018-04-25T06:16:10Z,">All the unclean merge commits are from 2016 or earlier. Perhaps instead there can just be a threshold that skips the validation below a certain age (say, 1 month)?\n\nOr do we need a trusted-clean-merge-root? This can be when that merge policy start.",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-384172308,384172308,
ken2812221,2018-04-25T13:44:13Z,Test for only checking commits in one month: https://travis-ci.org/ken2812221/bitcoin/jobs/371267929,https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-384291527,384291527,
ken2812221,2018-04-25T20:50:08Z,"Squashed and delete shell script.\n\nWe can run the run the script in about 80 seconds, so can we revert fa6f12af6baa97961dc4ae03708bd52cb7918ea0?",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-384429470,384429470,
jonasschnelli,2018-04-26T08:14:43Z,"I think the PR title should be ""Migrate verify-commits script to python, run in travis"" (or similar)",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-384553551,384553551,
ken2812221,2018-04-26T08:17:29Z,@jonasschnelli Thanks,https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-384554279,384554279,
laanwj,2018-04-27T14:04:41Z,"I did a timing comparison locally, this is an impressive win (given that the checks are correct):\n```\ncontrib/verify-commits/verify-commits.py \n(all the way to dc0305d15aa02819cd4763e1efe3876d674faea7, after verifying 2627)\nreal    5m36.844s\nuser    3m52.696s\nsys     1m1.720s\n\ncontrib/verify-commits/verify-commits.sh \n(and it wasn't even completely finished yet, only up to commit",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-384979974,384979974,
laanwj,2018-04-27T14:54:10Z,"IRC discussion:\n> **&lt;wumpus>** ken2812221: so to be clear: the only expected difference in behavior between your python script and the shell script is that your script only verifies merges up to a certain depth?\n> **&lt;wumpus>** (which is a sensible change, as the shell script throws an error there, not allowing it to verify the gpg signatures deeper either)\n>  **&lt;ken2812221>** Yes.\",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-384994840,384994840,
TheBlueMatt,2018-04-27T16:52:37Z,"I'm fine with migrating this to python, but I certainly dont know python well enough to verify something that is intended to be a secure way of checking our git tree, nor maintain it in the future. If this change means I dont have to and others will, however, thats fine.",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-385029649,385029649,
TheBlueMatt,2018-04-27T16:54:51Z,"NACK changing the script to only verify up to N commits instead of up to a trusted root by default. Its fine to do that on travis but that obviously defeats the point of ""checking the git commits come from a trusted source and don't just have a different timestamp on them"".",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-385030243,385030243,
ken2812221,2018-04-27T20:06:01Z,"I have two ways to do this. The first, add allow-unclean-merge-commits. The list is following.\n```\n6052d509105790a26b3ad5df43dd61e7f1b24a12\n3798e5de334c3deb5f71302b782f6b8fbd5087f1\n326ffed09bfcc209a2efd6a2ebc69edf6bd200b5\n97d83739db0631be5d4ba86af3616014652c00ec\n```\nThe second way is add trusted-unclean-merge-commit-root. It would be\n```\n6052d509105790a26b3ad5df43dd61e7f1b24a12\",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-385079930,385079930,
MarcoFalke,2018-04-27T20:10:54Z,"Given that the speedup is just based on skipping verification, I'd slightly prefer to stick around with the bash script for now and do the python transcribe in a follow up pr.",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-385081089,385081089,
ken2812221,2018-04-27T20:16:27Z,"@MarcoFalke If we do the entire verification in python, it still just take 18 mins on travis.",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-385082503,385082503,
ken2812221,2018-05-01T03:37:06Z,"I've re-designed this. Now we verify all the things by default.\n- Add `--disable-tree-check` option, not to check SHA-512 tree\n- Add `--clean-merge NUMBER` option, only verify commits after &lt;NUMBER> days ago\n\nTravis running time:\n\n|option|time|\n|-|-|\n|verify-commits.py|[25m47.02s(1547.02s)](https://travis-ci.org/ken2812221/bitcoin/jobs/373321423)|\n|verify-commits.py --disable-",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-385591669,385591669,
ken2812221,2018-06-12T12:19:33Z,@jnewbery Thanks for your review! I would like to take your nits.,https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-396569061,396569061,
jnewbery,2018-06-12T14:31:53Z,"> I would like to take your nits.\n\nGreat! Feel free to squash the changes into your commit.\n\nI've now tested this and verified that:\n\n- `f8feaa4636260b599294c7285bcf1c8b7737f74e` and `8040ae6fc576e9504186f2ae3ff2c8125de1095c` do have missing/incorrect Tree_SHA512 digests in the git logs, and do not contain malicious code.\n- `6052d509105790a26b3ad5df43dd61e7f1b24a12`, `3798e5de334c3de",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-396611171,396611171,
ken2812221,2018-06-12T14:49:39Z,Squashed,https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-396617529,396617529,
TheBlueMatt,2018-06-12T15:06:15Z,"I'm still wondering why migrate to python? It seems like most of the new code just does the same stuff that the old code did but instead of bash pipes it does a bunch of stdin/out reading, which I find way less readable.\n\nDefinitely Concept ACK the allow-unclean-merge-commits file and just making travis only go back a ways instead of doing a full check.",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-396623553,396623553,
ken2812221,2018-06-12T15:15:41Z,"@TheBlueMatt The major reason I do this PR is that bash script is too slow. It took about three hours to verify commits to trusted git root and unclean merges with bash and took about one hour with python on my PC. \n\nAlso, current bash script only check Tree-SHA512 with commit HEAD, it would take even longer if we check it every commit.",https://github.com/bitcoin/bitcoin/pull/13066#issuecomment-396627068,396627068,
MarcoFalke,2018-04-24T15:40:28Z,Shouldn't this be `INITIAL_COMMIT` instead of `HEAD`?,https://github.com/bitcoin/bitcoin/pull/13066#discussion_r183781782,183781782,contrib/verify-commits/verify-commits.py
laanwj,2018-04-24T15:46:15Z,"It's a direct transcription from the shell script at least:\n```bash\nBRANCH=""$(git rev-parse --abbrev-ref HEAD)""\n```",https://github.com/bitcoin/bitcoin/pull/13066#discussion_r183783951,183783951,contrib/verify-commits/verify-commits.py
ken2812221,2018-04-24T15:49:52Z,"No, it is a string 'HEAD', it would return a branch name. If you put a commit id, it returns nothing.",https://github.com/bitcoin/bitcoin/pull/13066#discussion_r183785186,183785186,contrib/verify-commits/verify-commits.py
MarcoFalke,2018-04-24T16:00:31Z,"> 'HEAD', it would return a branch name. If you put a commit id, it returns nothing.\n\nIt always returns a commit id for me.",https://github.com/bitcoin/bitcoin/pull/13066#discussion_r183789095,183789095,contrib/verify-commits/verify-commits.py
ken2812221,2018-04-25T06:24:53Z,"Well, the git version might be different. I'm using git 2.1.4",https://github.com/bitcoin/bitcoin/pull/13066#discussion_r183951335,183951335,contrib/verify-commits/verify-commits.py
MarcoFalke,2018-04-25T15:13:02Z,"Oh yeah, that's it. To me this seems like a thing to fix (The script shouldn't depends on what version of git you are using)\n\nAlso, I still think that the correct thing to use here is `INITIAL_COMMIT`. I.e. `git log --format=""%H"" -1 ""${INITIAL_COMMIT}""`. Otherwise a comment might be appropriate to say why `HEAD` is used here.",https://github.com/bitcoin/bitcoin/pull/13066#discussion_r184097993,184097993,contrib/verify-commits/verify-commits.py
ken2812221,2018-04-25T17:35:11Z,"I use it just because the original shell script, so I change it to `git show -s --format=""%H"" ${INITIAL_COMMIT}` now, and looks like we don't need to change the travis script.",https://github.com/bitcoin/bitcoin/pull/13066#discussion_r184146078,184146078,contrib/verify-commits/verify-commits.py
jnewbery,2018-05-08T15:16:39Z,"You're already importing subprocess. Suggest you just use `subprocess.PIPE` throughout.\n\nSame for `sys.stderr` below.",https://github.com/bitcoin/bitcoin/pull/13066#discussion_r186765107,186765107,contrib/verify-commits/verify-commits.py
jnewbery,2018-06-11T16:35:57Z,"Please include a copyright notice and module docstring, eg:\n\n```python\n# Copyright (c) 2018 The Bitcoin Core developers\n# Distributed under the MIT software license, see the accompanying\n# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n""""""Verify commits against a trusted keys list.""""""\n```",https://github.com/bitcoin/bitcoin/pull/13066#discussion_r194467943,194467943,contrib/verify-commits/verify-commits.py
jnewbery,2018-06-11T16:38:12Z,Nit: update the comment to say that this is copied from `github-merge.py`,https://github.com/bitcoin/bitcoin/pull/13066#discussion_r194468676,194468676,contrib/verify-commits/verify-commits.py
jnewbery,2018-06-11T16:39:57Z,A few line breaks would be helpful here!,https://github.com/bitcoin/bitcoin/pull/13066#discussion_r194469228,194469228,contrib/verify-commits/verify-commits.py
ryanofsky,2018-06-12T15:52:28Z,"It seems possible this code could hang depending on internals of git or the operating system, if reads from stdin are buffered. I think moving this stdin.close() line up to where the stdin.flush() is could avoid this. Another option is to use https://docs.python.org/3/library/subprocess.html#subprocess.Popen.communicate, which avoids deadlocks of this type.",https://github.com/bitcoin/bitcoin/pull/13066#discussion_r194793674,194793674,contrib/verify-commits/verify-commits.py
ryanofsky,2018-06-12T15:55:36Z,"It's better to move code that has side effects outside of assert statements, because assert statements are stripped out with python's `-O` option.",https://github.com/bitcoin/bitcoin/pull/13066#discussion_r194794892,194794892,contrib/verify-commits/verify-commits.py
