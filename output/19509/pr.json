{
  "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19509",
  "id": 448599640,
  "node_id": "MDExOlB1bGxSZXF1ZXN0NDQ4NTk5NjQw",
  "html_url": "https://github.com/bitcoin/bitcoin/pull/19509",
  "diff_url": "https://github.com/bitcoin/bitcoin/pull/19509.diff",
  "patch_url": "https://github.com/bitcoin/bitcoin/pull/19509.patch",
  "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19509",
  "number": 19509,
  "state": "closed",
  "locked": false,
  "title": "Per-Peer Message Capture",
  "user": {
    "login": "troygiorshev",
    "id": 5553787,
    "node_id": "MDQ6VXNlcjU1NTM3ODc=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5553787?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/troygiorshev",
    "html_url": "https://github.com/troygiorshev",
    "followers_url": "https://api.github.com/users/troygiorshev/followers",
    "following_url": "https://api.github.com/users/troygiorshev/following{/other_user}",
    "gists_url": "https://api.github.com/users/troygiorshev/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/troygiorshev/subscriptions",
    "organizations_url": "https://api.github.com/users/troygiorshev/orgs",
    "repos_url": "https://api.github.com/users/troygiorshev/repos",
    "events_url": "https://api.github.com/users/troygiorshev/events{/privacy}",
    "received_events_url": "https://api.github.com/users/troygiorshev/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "This PR introduces per-peer message capture into Bitcoin Core.  \ud83d\udcd3 \r\n\r\n## Purpose\r\n\r\nThe purpose and scope of this feature is intentionally limited.  It answers a question anyone new to Bitcoin's P2P protocol has had: \"Can I see what messages my node is sending and receiving?\".\r\n\r\n## Functionality\r\n\r\nWhen a new debug-only command line argument `capturemessages` is set, any message that the node receives or sends is captured.  The capture occurs in the MessageHandler thread.  When receiving a message, it is captured as soon as the MessageHandler thread takes the message off of the vProcessMsg queue.  When sending, the message is captured just before the message is pushed onto the vSendMsg queue.\r\n\r\nThe message capture is as minimal as possible to reduce the performance impact on the node.  Messages are captured to a new `message_capture` folder in the datadir.  Each node has their own subfolder named with their IP address and port.  Inside, received and sent messages are captured into two binary files, msgs_recv.dat and msgs_sent.dat, like so:\r\n\r\n```\r\nmessage_capture/203.0.113.7:56072/msgs_recv.dat\r\nmessage_capture/203.0.113.7:56072/msgs_sent.dat\r\n```\r\n\r\nBecause the messages are raw binary dumps, included in this PR is a Python parsing tool to convert the binary files into human-readable JSON.  This script has been placed on its own and out of the way in the new `contrib/message-capture` folder.  Its usage is simple and easily discovered by the autogenerated `-h` option.\r\n\r\n## Future Maintenance\r\n\r\nI sympathize greatly with anyone who says \"the best code is no code\".\r\n\r\nThe future maintenance of this feature will be minimal.  The logic to deserialize the payload of the p2p messages exists in our testing framework.  As long as our testing framework works, so will this tool.\r\n\r\nAdditionally, I hope that the simplicity of this tool will mean that it gets used frequently, so that problems will be discovered and solved when they are small.\r\n\r\n## FAQ\r\n\r\n\"Why not just use Wireshark\"\r\n\r\nYes, Wireshark has the ability to filter and decode Bitcoin messages.  However, the purpose of the message capture added in this PR is to assist with debugging, primarily for new developers looking to improve their knowledge of the Bitcoin Protocol.  This drives the design in a different direction than Wireshark, in two different ways.  First, this tool must be convenient and simple to use.  Using an external tool, like Wireshark, requires setup and interpretation of the results.  To a new user who doesn't necessarily know what to expect, this is unnecessary difficulty.  This tool, on the other hand, \"just works\".  Turn on the command line flag, run your node, run the script, read the JSON.  Second, because this tool is being used for debugging, we want it to be as close to the true behavior of the node as possible.  A lot can happen in the SocketHandler thread that would be missed by Wireshark.\r\n\r\nAdditionally, if we are to use Wireshark, we are at the mercy of whoever it maintaining the protocol in Wireshark, both as to it being accurate and recent.  As can be seen by the **many** previous attempts to include Bitcoin in Wireshark (google \"bitcoin dissector\") this is easier said than done.\r\n\r\nLastly, I truly believe that this tool will be used significantly more by being included in the codebase.  It's just that much more discoverable.",
  "created_at": "2020-07-14T02:10:58Z",
  "updated_at": "2021-03-01T22:16:18Z",
  "closed_at": "2021-02-02T12:12:36Z",
  "merged_at": "2021-02-02T12:12:36Z",
  "merge_commit_sha": "384e090f9345c07fa81ccafa8cd36037f3cd0813",
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [
    {
      "id": 98298007,
      "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
      "name": "P2P",
      "color": "006b75",
      "default": false,
      "description": null
    },
    {
      "id": 241832923,
      "node_id": "MDU6TGFiZWwyNDE4MzI5MjM=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Utils/log/libs",
      "name": "Utils/log/libs",
      "color": "5319e7",
      "default": false,
      "description": ""
    }
  ],
  "milestone": null,
  "draft": false,
  "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19509/commits",
  "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19509/comments",
  "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/19509/comments",
  "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/bff7c66e67aa2f18ef70139338643656a54444fe",
  "head": {
    "label": "troygiorshev:message-dump",
    "ref": "message-dump",
    "sha": "bff7c66e67aa2f18ef70139338643656a54444fe",
    "user": {
      "login": "troygiorshev",
      "id": 5553787,
      "node_id": "MDQ6VXNlcjU1NTM3ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5553787?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/troygiorshev",
      "html_url": "https://github.com/troygiorshev",
      "followers_url": "https://api.github.com/users/troygiorshev/followers",
      "following_url": "https://api.github.com/users/troygiorshev/following{/other_user}",
      "gists_url": "https://api.github.com/users/troygiorshev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/troygiorshev/subscriptions",
      "organizations_url": "https://api.github.com/users/troygiorshev/orgs",
      "repos_url": "https://api.github.com/users/troygiorshev/repos",
      "events_url": "https://api.github.com/users/troygiorshev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/troygiorshev/received_events",
      "type": "User",
      "site_admin": false
    },
    "repo": {
      "id": 265625232,
      "node_id": "MDEwOlJlcG9zaXRvcnkyNjU2MjUyMzI=",
      "name": "bitcoin",
      "full_name": "troygiorshev/bitcoin",
      "private": false,
      "owner": {
        "login": "troygiorshev",
        "id": 5553787,
        "node_id": "MDQ6VXNlcjU1NTM3ODc=",
        "avatar_url": "https://avatars.githubusercontent.com/u/5553787?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/troygiorshev",
        "html_url": "https://github.com/troygiorshev",
        "followers_url": "https://api.github.com/users/troygiorshev/followers",
        "following_url": "https://api.github.com/users/troygiorshev/following{/other_user}",
        "gists_url": "https://api.github.com/users/troygiorshev/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/troygiorshev/subscriptions",
        "organizations_url": "https://api.github.com/users/troygiorshev/orgs",
        "repos_url": "https://api.github.com/users/troygiorshev/repos",
        "events_url": "https://api.github.com/users/troygiorshev/events{/privacy}",
        "received_events_url": "https://api.github.com/users/troygiorshev/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/troygiorshev/bitcoin",
      "description": "Bitcoin Core integration/staging tree",
      "fork": true,
      "url": "https://api.github.com/repos/troygiorshev/bitcoin",
      "forks_url": "https://api.github.com/repos/troygiorshev/bitcoin/forks",
      "keys_url": "https://api.github.com/repos/troygiorshev/bitcoin/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/troygiorshev/bitcoin/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/troygiorshev/bitcoin/teams",
      "hooks_url": "https://api.github.com/repos/troygiorshev/bitcoin/hooks",
      "issue_events_url": "https://api.github.com/repos/troygiorshev/bitcoin/issues/events{/number}",
      "events_url": "https://api.github.com/repos/troygiorshev/bitcoin/events",
      "assignees_url": "https://api.github.com/repos/troygiorshev/bitcoin/assignees{/user}",
      "branches_url": "https://api.github.com/repos/troygiorshev/bitcoin/branches{/branch}",
      "tags_url": "https://api.github.com/repos/troygiorshev/bitcoin/tags",
      "blobs_url": "https://api.github.com/repos/troygiorshev/bitcoin/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/troygiorshev/bitcoin/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/troygiorshev/bitcoin/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/troygiorshev/bitcoin/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/troygiorshev/bitcoin/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/troygiorshev/bitcoin/languages",
      "stargazers_url": "https://api.github.com/repos/troygiorshev/bitcoin/stargazers",
      "contributors_url": "https://api.github.com/repos/troygiorshev/bitcoin/contributors",
      "subscribers_url": "https://api.github.com/repos/troygiorshev/bitcoin/subscribers",
      "subscription_url": "https://api.github.com/repos/troygiorshev/bitcoin/subscription",
      "commits_url": "https://api.github.com/repos/troygiorshev/bitcoin/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/troygiorshev/bitcoin/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/troygiorshev/bitcoin/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/troygiorshev/bitcoin/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/troygiorshev/bitcoin/contents/{+path}",
      "compare_url": "https://api.github.com/repos/troygiorshev/bitcoin/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/troygiorshev/bitcoin/merges",
      "archive_url": "https://api.github.com/repos/troygiorshev/bitcoin/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/troygiorshev/bitcoin/downloads",
      "issues_url": "https://api.github.com/repos/troygiorshev/bitcoin/issues{/number}",
      "pulls_url": "https://api.github.com/repos/troygiorshev/bitcoin/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/troygiorshev/bitcoin/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/troygiorshev/bitcoin/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/troygiorshev/bitcoin/labels{/name}",
      "releases_url": "https://api.github.com/repos/troygiorshev/bitcoin/releases{/id}",
      "deployments_url": "https://api.github.com/repos/troygiorshev/bitcoin/deployments",
      "created_at": "2020-05-20T16:33:16Z",
      "updated_at": "2021-02-16T18:44:50Z",
      "pushed_at": "2021-02-16T18:44:16Z",
      "git_url": "git://github.com/troygiorshev/bitcoin.git",
      "ssh_url": "git@github.com:troygiorshev/bitcoin.git",
      "clone_url": "https://github.com/troygiorshev/bitcoin.git",
      "svn_url": "https://github.com/troygiorshev/bitcoin",
      "homepage": "https://bitcoincore.org/en/download",
      "size": 160214,
      "stargazers_count": 0,
      "watchers_count": 0,
      "language": "C++",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": false,
      "has_wiki": false,
      "has_pages": false,
      "forks_count": 0,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 0,
      "license": {
        "key": "mit",
        "name": "MIT License",
        "spdx_id": "MIT",
        "url": "https://api.github.com/licenses/mit",
        "node_id": "MDc6TGljZW5zZTEz"
      },
      "allow_forking": true,
      "is_template": false,
      "topics": [],
      "visibility": "public",
      "forks": 0,
      "open_issues": 0,
      "watchers": 0,
      "default_branch": "master"
    }
  },
  "base": {
    "label": "bitcoin:master",
    "ref": "master",
    "sha": "32b191fb66e644c690c94cbfdae6ddbc754769d7",
    "user": {
      "login": "bitcoin",
      "id": 528860,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bitcoin",
      "html_url": "https://github.com/bitcoin",
      "followers_url": "https://api.github.com/users/bitcoin/followers",
      "following_url": "https://api.github.com/users/bitcoin/following{/other_user}",
      "gists_url": "https://api.github.com/users/bitcoin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bitcoin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
      "organizations_url": "https://api.github.com/users/bitcoin/orgs",
      "repos_url": "https://api.github.com/users/bitcoin/repos",
      "events_url": "https://api.github.com/users/bitcoin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bitcoin/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 1181927,
      "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
      "name": "bitcoin",
      "full_name": "bitcoin/bitcoin",
      "private": false,
      "owner": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following{/other_user}",
        "gists_url": "https://api.github.com/users/bitcoin/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/bitcoin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events{/privacy}",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin",
      "description": "Bitcoin Core integration/staging tree",
      "fork": false,
      "url": "https://api.github.com/repos/bitcoin/bitcoin",
      "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
      "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
      "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
      "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events{/number}",
      "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
      "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees{/user}",
      "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches{/branch}",
      "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
      "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
      "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
      "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
      "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
      "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
      "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/{+path}",
      "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
      "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
      "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues{/number}",
      "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels{/name}",
      "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases{/id}",
      "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
      "created_at": "2010-12-19T15:16:43Z",
      "updated_at": "2021-12-01T23:48:45Z",
      "pushed_at": "2021-12-02T00:08:59Z",
      "git_url": "git://github.com/bitcoin/bitcoin.git",
      "ssh_url": "git@github.com:bitcoin/bitcoin.git",
      "clone_url": "https://github.com/bitcoin/bitcoin.git",
      "svn_url": "https://github.com/bitcoin/bitcoin",
      "homepage": "https://bitcoincore.org/en/download",
      "size": 188184,
      "stargazers_count": 59729,
      "watchers_count": 59729,
      "language": "C++",
      "has_issues": true,
      "has_projects": true,
      "has_downloads": false,
      "has_wiki": false,
      "has_pages": false,
      "forks_count": 30708,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 1024,
      "license": {
        "key": "mit",
        "name": "MIT License",
        "spdx_id": "MIT",
        "url": "https://api.github.com/licenses/mit",
        "node_id": "MDc6TGljZW5zZTEz"
      },
      "allow_forking": true,
      "is_template": false,
      "topics": [
        "bitcoin",
        "c-plus-plus",
        "cryptocurrency",
        "cryptography",
        "p2p"
      ],
      "visibility": "public",
      "forks": 30708,
      "open_issues": 1024,
      "watchers": 59729,
      "default_branch": "master"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19509"
    },
    "html": {
      "href": "https://github.com/bitcoin/bitcoin/pull/19509"
    },
    "issue": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/issues/19509"
    },
    "comments": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/issues/19509/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19509/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/19509/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/statuses/bff7c66e67aa2f18ef70139338643656a54444fe"
    }
  },
  "author_association": "CONTRIBUTOR",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": true,
  "mergeable": null,
  "rebaseable": null,
  "mergeable_state": "unknown",
  "merged_by": {
    "login": "MarcoFalke",
    "id": 6399679,
    "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/MarcoFalke",
    "html_url": "https://github.com/MarcoFalke",
    "followers_url": "https://api.github.com/users/MarcoFalke/followers",
    "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
    "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
    "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
    "repos_url": "https://api.github.com/users/MarcoFalke/repos",
    "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
    "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
    "type": "User",
    "site_admin": false
  },
  "comments": 74,
  "review_comments": 181,
  "maintainer_can_modify": false,
  "commits": 6,
  "additions": 369,
  "deletions": 16,
  "changed_files": 9
}