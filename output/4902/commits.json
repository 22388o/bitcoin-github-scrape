[
  {
    "sha": "042f46b005625b9c1a017834070b6d807acb1764",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowNDJmNDZiMDA1NjI1YjljMWEwMTc4MzQwNzBiNmQ4MDdhY2IxNzY0",
    "commit": {
      "author": {
        "name": "Bob McElrath",
        "email": "bob_git@mcelrath.org",
        "date": "2014-09-12T13:11:37Z"
      },
      "committer": {
        "name": "Bob McElrath",
        "email": "bob_git@mcelrath.org",
        "date": "2014-09-12T13:11:37Z"
      },
      "message": "port # typo fix",
      "tree": {
        "sha": "bc323cbcd65fa26931b6b871eafae88f7b606d8c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/bc323cbcd65fa26931b6b871eafae88f7b606d8c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/042f46b005625b9c1a017834070b6d807acb1764",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/042f46b005625b9c1a017834070b6d807acb1764",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/042f46b005625b9c1a017834070b6d807acb1764",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/042f46b005625b9c1a017834070b6d807acb1764/comments",
    "author": null,
    "committer": null,
    "parents": [
      {
        "sha": "8040e938c56f65a8e46bc0ad0b6bd35c63185749",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8040e938c56f65a8e46bc0ad0b6bd35c63185749",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/8040e938c56f65a8e46bc0ad0b6bd35c63185749"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 2,
      "deletions": 2
    },
    "files": [
      {
        "sha": "6c6e77594d4e61622fabacb470441d204e718fb3",
        "filename": "src/qt/locale/bitcoin_fa.ts",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/042f46b005625b9c1a017834070b6d807acb1764/src/qt/locale/bitcoin_fa.ts",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/042f46b005625b9c1a017834070b6d807acb1764/src/qt/locale/bitcoin_fa.ts",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/locale/bitcoin_fa.ts?ref=042f46b005625b9c1a017834070b6d807acb1764",
        "patch": "@@ -1640,7 +1640,7 @@ Address: %4\n     </message>\n     <message>\n         <source>Listen for connections on &lt;port&gt; (default: 8333 or testnet: 18333)</source>\n-        <translation>\u067e\u0630\u06cc\u0631\u0634 \u0627\u062a\u0635\u0627\u0644\u0627\u062a \u0631\u0648\u06cc \u067e\u0648\u0631\u062a &lt;port&gt; (\u067e\u06cc\u0634\u200c\u0641\u0631\u0636: 8833 \u06cc\u0627 \u0634\u0628\u06a9\u0647\u0654 \u0622\u0632\u0645\u0627\u06cc\u0634\u06cc: 18333)</translation>\n+        <translation>\u067e\u0630\u06cc\u0631\u0634 \u0627\u062a\u0635\u0627\u0644\u0627\u062a \u0631\u0648\u06cc \u067e\u0648\u0631\u062a &lt;port&gt; (\u067e\u06cc\u0634\u200c\u0641\u0631\u0636: 8333 \u06cc\u0627 \u0634\u0628\u06a9\u0647\u0654 \u0622\u0632\u0645\u0627\u06cc\u0634\u06cc: 18333)</translation>\n     </message>\n     <message>\n         <source>Maintain at most &lt;n&gt; connections to peers (default: 125)</source>\n@@ -1971,4 +1971,4 @@ Address: %4\n         <translation>\u062e\u0637\u0627</translation>\n     </message>\n </context>\n-</TS>\n\\ No newline at end of file\n+</TS>"
      }
    ]
  },
  {
    "sha": "5bb9c12d9d5c230509c087b5778296b178349d4c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1YmI5YzEyZDlkNWMyMzA1MDljMDg3YjU3NzgyOTZiMTc4MzQ5ZDRj",
    "commit": {
      "author": {
        "name": "Bob McElrath",
        "email": "bob_git@mcelrath.org",
        "date": "2014-09-12T13:12:41Z"
      },
      "committer": {
        "name": "Bob McElrath",
        "email": "bob_git@mcelrath.org",
        "date": "2014-09-12T13:12:41Z"
      },
      "message": "Merge branch 'master' of github.com:bitcoin/bitcoin into bob",
      "tree": {
        "sha": "5fd6b1dbf252f4f622d3f705e9e8f143a1219819",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5fd6b1dbf252f4f622d3f705e9e8f143a1219819"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5bb9c12d9d5c230509c087b5778296b178349d4c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5bb9c12d9d5c230509c087b5778296b178349d4c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/5bb9c12d9d5c230509c087b5778296b178349d4c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5bb9c12d9d5c230509c087b5778296b178349d4c/comments",
    "author": null,
    "committer": null,
    "parents": [
      {
        "sha": "042f46b005625b9c1a017834070b6d807acb1764",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/042f46b005625b9c1a017834070b6d807acb1764",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/042f46b005625b9c1a017834070b6d807acb1764"
      },
      {
        "sha": "3fa1c81b945870dfa4cda469083d4b3e2fa8d459",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3fa1c81b945870dfa4cda469083d4b3e2fa8d459",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/3fa1c81b945870dfa4cda469083d4b3e2fa8d459"
      }
    ],
    "stats": {
      "total": 90,
      "additions": 70,
      "deletions": 20
    },
    "files": [
      {
        "sha": "6e47536d38eec86c063ed9c0dd49cf97d4556654",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5bb9c12d9d5c230509c087b5778296b178349d4c/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5bb9c12d9d5c230509c087b5778296b178349d4c/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=5bb9c12d9d5c230509c087b5778296b178349d4c",
        "patch": "@@ -226,6 +226,7 @@ std::string HelpMessage(HelpMessageMode mode)\n     strUsage += \"  -dbcache=<n>           \" + strprintf(_(\"Set database cache size in megabytes (%d to %d, default: %d)\"), nMinDbCache, nMaxDbCache, nDefaultDbCache) + \"\\n\";\n     strUsage += \"  -loadblock=<file>      \" + _(\"Imports blocks from external blk000??.dat file\") + \" \" + _(\"on startup\") + \"\\n\";\n     strUsage += \"  -maxorphanblocks=<n>   \" + strprintf(_(\"Keep at most <n> unconnectable blocks in memory (default: %u)\"), DEFAULT_MAX_ORPHAN_BLOCKS) + \"\\n\";\n+    strUsage += \"  -maxorphantx=<n>       \" + strprintf(_(\"Keep at most <n> unconnectable transactions in memory (default: %u)\"), DEFAULT_MAX_ORPHAN_TRANSACTIONS) + \"\\n\";\n     strUsage += \"  -par=<n>               \" + strprintf(_(\"Set the number of script verification threads (%u to %d, 0 = auto, <0 = leave that many cores free, default: %d)\"), -(int)boost::thread::hardware_concurrency(), MAX_SCRIPTCHECK_THREADS, DEFAULT_SCRIPTCHECK_THREADS) + \"\\n\";\n     strUsage += \"  -pid=<file>            \" + _(\"Specify pid file (default: bitcoind.pid)\") + \"\\n\";\n     strUsage += \"  -reindex               \" + _(\"Rebuild block chain index from current blk000??.dat files\") + \" \" + _(\"on startup\") + \"\\n\";"
      },
      {
        "sha": "f9782549613b176266cec0128df6421d329d8271",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 54,
        "deletions": 14,
        "changes": 68,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5bb9c12d9d5c230509c087b5778296b178349d4c/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5bb9c12d9d5c230509c087b5778296b178349d4c/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=5bb9c12d9d5c230509c087b5778296b178349d4c",
        "patch": "@@ -63,8 +63,13 @@ struct COrphanBlock {\n map<uint256, COrphanBlock*> mapOrphanBlocks;\n multimap<uint256, COrphanBlock*> mapOrphanBlocksByPrev;\n \n-map<uint256, CTransaction> mapOrphanTransactions;\n+struct COrphanTx {\n+    CTransaction tx;\n+    NodeId fromPeer;\n+};\n+map<uint256, COrphanTx> mapOrphanTransactions;\n map<uint256, set<uint256> > mapOrphanTransactionsByPrev;\n+void EraseOrphansFor(NodeId peer);\n \n // Constant stuff for coinbase transactions we create:\n CScript COINBASE_FLAGS;\n@@ -264,6 +269,7 @@ void FinalizeNode(NodeId nodeid) {\n         mapBlocksInFlight.erase(entry.hash);\n     BOOST_FOREACH(const uint256& hash, state->vBlocksToDownload)\n         mapBlocksToDownload.erase(hash);\n+    EraseOrphansFor(nodeid);\n \n     mapNodeState.erase(nodeid);\n }\n@@ -461,7 +467,7 @@ CBlockTreeDB *pblocktree = NULL;\n // mapOrphanTransactions\n //\n \n-bool AddOrphanTx(const CTransaction& tx)\n+bool AddOrphanTx(const CTransaction& tx, NodeId peer)\n {\n     uint256 hash = tx.GetHash();\n     if (mapOrphanTransactions.count(hash))\n@@ -481,21 +487,22 @@ bool AddOrphanTx(const CTransaction& tx)\n         return false;\n     }\n \n-    mapOrphanTransactions[hash] = tx;\n+    mapOrphanTransactions[hash].tx = tx;\n+    mapOrphanTransactions[hash].fromPeer = peer;\n     BOOST_FOREACH(const CTxIn& txin, tx.vin)\n         mapOrphanTransactionsByPrev[txin.prevout.hash].insert(hash);\n \n-    LogPrint(\"mempool\", \"stored orphan tx %s (mapsz %u)\\n\", hash.ToString(),\n-        mapOrphanTransactions.size());\n+    LogPrint(\"mempool\", \"stored orphan tx %s (mapsz %u prevsz %u)\\n\", hash.ToString(),\n+             mapOrphanTransactions.size(), mapOrphanTransactionsByPrev.size());\n     return true;\n }\n \n void static EraseOrphanTx(uint256 hash)\n {\n-    map<uint256, CTransaction>::iterator it = mapOrphanTransactions.find(hash);\n+    map<uint256, COrphanTx>::iterator it = mapOrphanTransactions.find(hash);\n     if (it == mapOrphanTransactions.end())\n         return;\n-    BOOST_FOREACH(const CTxIn& txin, it->second.vin)\n+    BOOST_FOREACH(const CTxIn& txin, it->second.tx.vin)\n     {\n         map<uint256, set<uint256> >::iterator itPrev = mapOrphanTransactionsByPrev.find(txin.prevout.hash);\n         if (itPrev == mapOrphanTransactionsByPrev.end())\n@@ -507,14 +514,31 @@ void static EraseOrphanTx(uint256 hash)\n     mapOrphanTransactions.erase(it);\n }\n \n+void EraseOrphansFor(NodeId peer)\n+{\n+    int nErased = 0;\n+    map<uint256, COrphanTx>::iterator iter = mapOrphanTransactions.begin();\n+    while (iter != mapOrphanTransactions.end())\n+    {\n+        map<uint256, COrphanTx>::iterator maybeErase = iter++; // increment to avoid iterator becoming invalid\n+        if (maybeErase->second.fromPeer == peer)\n+        {\n+            EraseOrphanTx(maybeErase->second.tx.GetHash());\n+            ++nErased;\n+        }\n+    }\n+    if (nErased > 0) LogPrint(\"mempool\", \"Erased %d orphan tx from peer %d\\n\", nErased, peer);\n+}\n+\n+\n unsigned int LimitOrphanTxSize(unsigned int nMaxOrphans)\n {\n     unsigned int nEvicted = 0;\n     while (mapOrphanTransactions.size() > nMaxOrphans)\n     {\n         // Evict a random orphan:\n         uint256 randomhash = GetRandHash();\n-        map<uint256, CTransaction>::iterator it = mapOrphanTransactions.lower_bound(randomhash);\n+        map<uint256, COrphanTx>::iterator it = mapOrphanTransactions.lower_bound(randomhash);\n         if (it == mapOrphanTransactions.end())\n             it = mapOrphanTransactions.begin();\n         EraseOrphanTx(it->first);\n@@ -3777,6 +3801,7 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                 mempool.mapTx.size());\n \n             // Recursively process any orphan transactions that depended on this one\n+            set<NodeId> setMisbehaving;\n             for (unsigned int i = 0; i < vWorkQueue.size(); i++)\n             {\n                 map<uint256, set<uint256> >::iterator itByPrev = mapOrphanTransactionsByPrev.find(vWorkQueue[i]);\n@@ -3787,25 +3812,36 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                      ++mi)\n                 {\n                     const uint256& orphanHash = *mi;\n-                    const CTransaction& orphanTx = mapOrphanTransactions[orphanHash];\n+                    const CTransaction& orphanTx = mapOrphanTransactions[orphanHash].tx;\n+                    NodeId fromPeer = mapOrphanTransactions[orphanHash].fromPeer;\n                     bool fMissingInputs2 = false;\n                     // Use a dummy CValidationState so someone can't setup nodes to counter-DoS based on orphan\n                     // resolution (that is, feeding people an invalid transaction based on LegitTxX in order to get\n                     // anyone relaying LegitTxX banned)\n                     CValidationState stateDummy;\n \n+                    vEraseQueue.push_back(orphanHash);\n+\n+                    if (setMisbehaving.count(fromPeer))\n+                        continue;\n                     if (AcceptToMemoryPool(mempool, stateDummy, orphanTx, true, &fMissingInputs2))\n                     {\n                         LogPrint(\"mempool\", \"   accepted orphan tx %s\\n\", orphanHash.ToString());\n                         RelayTransaction(orphanTx);\n                         mapAlreadyAskedFor.erase(CInv(MSG_TX, orphanHash));\n                         vWorkQueue.push_back(orphanHash);\n-                        vEraseQueue.push_back(orphanHash);\n                     }\n                     else if (!fMissingInputs2)\n                     {\n-                        // invalid or too-little-fee orphan\n-                        vEraseQueue.push_back(orphanHash);\n+                        int nDos = 0;\n+                        if (stateDummy.IsInvalid(nDos) && nDos > 0)\n+                        {\n+                            // Punish peer that gave us an invalid orphan tx\n+                            Misbehaving(fromPeer, nDos);\n+                            setMisbehaving.insert(fromPeer);\n+                            LogPrint(\"mempool\", \"   invalid orphan tx %s\\n\", orphanHash.ToString());\n+                        }\n+                        // too-little-fee orphan\n                         LogPrint(\"mempool\", \"   removed orphan tx %s\\n\", orphanHash.ToString());\n                     }\n                     mempool.check(pcoinsTip);\n@@ -3817,10 +3853,11 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         }\n         else if (fMissingInputs)\n         {\n-            AddOrphanTx(tx);\n+            AddOrphanTx(tx, pfrom->GetId());\n \n             // DoS prevention: do not allow mapOrphanTransactions to grow unbounded\n-            unsigned int nEvicted = LimitOrphanTxSize(MAX_ORPHAN_TRANSACTIONS);\n+            unsigned int nMaxOrphanTx = (unsigned int)std::max((int64_t)0, GetArg(\"-maxorphantx\", DEFAULT_MAX_ORPHAN_TRANSACTIONS));\n+            unsigned int nEvicted = LimitOrphanTxSize(nMaxOrphanTx);\n             if (nEvicted > 0)\n                 LogPrint(\"mempool\", \"mapOrphan overflow, removed %u tx\\n\", nEvicted);\n         } else if (pfrom->fWhitelisted) {\n@@ -4324,7 +4361,9 @@ bool SendMessages(CNode* pto, bool fSendTrickle)\n                 if (pto->addr.IsLocal())\n                     LogPrintf(\"Warning: not banning local peer %s!\\n\", pto->addr.ToString());\n                 else\n+                {\n                     CNode::Ban(pto->addr);\n+                }\n             }\n             state.fShouldBan = false;\n         }\n@@ -4538,5 +4577,6 @@ class CMainCleanup\n \n         // orphan transactions\n         mapOrphanTransactions.clear();\n+        mapOrphanTransactionsByPrev.clear();\n     }\n } instance_of_cmaincleanup;"
      },
      {
        "sha": "d340fd0b6a9b324d1e25e7fd502c15daf55000d5",
        "filename": "src/main.h",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5bb9c12d9d5c230509c087b5778296b178349d4c/src/main.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5bb9c12d9d5c230509c087b5778296b178349d4c/src/main.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.h?ref=5bb9c12d9d5c230509c087b5778296b178349d4c",
        "patch": "@@ -51,8 +51,8 @@ static const unsigned int MAX_BLOCK_SIGOPS = MAX_BLOCK_SIZE/50;\n static const unsigned int MAX_P2SH_SIGOPS = 15;\n /** The maximum number of sigops we're willing to relay/mine in a single tx */\n static const unsigned int MAX_TX_SIGOPS = MAX_BLOCK_SIGOPS/5;\n-/** The maximum number of orphan transactions kept in memory */\n-static const unsigned int MAX_ORPHAN_TRANSACTIONS = MAX_BLOCK_SIZE/100;\n+/** Default for -maxorphantx, maximum number of orphan transactions kept in memory */\n+static const unsigned int DEFAULT_MAX_ORPHAN_TRANSACTIONS = 100;\n /** Default for -maxorphanblocks, maximum number of orphan blocks kept in memory */\n static const unsigned int DEFAULT_MAX_ORPHAN_BLOCKS = 750;\n /** The maximum size of a blk?????.dat file (since 0.8) */"
      },
      {
        "sha": "e0196748168687edae5c7707df5f8b48a596bf16",
        "filename": "src/test/DoS_tests.cpp",
        "status": "modified",
        "additions": 13,
        "deletions": 4,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5bb9c12d9d5c230509c087b5778296b178349d4c/src/test/DoS_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5bb9c12d9d5c230509c087b5778296b178349d4c/src/test/DoS_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/DoS_tests.cpp?ref=5bb9c12d9d5c230509c087b5778296b178349d4c",
        "patch": "@@ -24,7 +24,8 @@\n #include <boost/test/unit_test.hpp>\n \n // Tests this internal-to-main.cpp method:\n-extern bool AddOrphanTx(const CTransaction& tx);\n+extern bool AddOrphanTx(const CTransaction& tx, NodeId peer);\n+extern void EraseOrphansFor(NodeId peer);\n extern unsigned int LimitOrphanTxSize(unsigned int nMaxOrphans);\n extern std::map<uint256, CTransaction> mapOrphanTransactions;\n extern std::map<uint256, std::set<uint256> > mapOrphanTransactionsByPrev;\n@@ -174,7 +175,7 @@ BOOST_AUTO_TEST_CASE(DoS_mapOrphans)\n         tx.vout[0].nValue = 1*CENT;\n         tx.vout[0].scriptPubKey.SetDestination(key.GetPubKey().GetID());\n \n-        AddOrphanTx(tx);\n+        AddOrphanTx(tx, i);\n     }\n \n     // ... and 50 that depend on other orphans:\n@@ -191,7 +192,7 @@ BOOST_AUTO_TEST_CASE(DoS_mapOrphans)\n         tx.vout[0].scriptPubKey.SetDestination(key.GetPubKey().GetID());\n         SignSignature(keystore, txPrev, tx, 0);\n \n-        AddOrphanTx(tx);\n+        AddOrphanTx(tx, i);\n     }\n \n     // This really-big orphan should be ignored:\n@@ -215,7 +216,15 @@ BOOST_AUTO_TEST_CASE(DoS_mapOrphans)\n         for (unsigned int j = 1; j < tx.vin.size(); j++)\n             tx.vin[j].scriptSig = tx.vin[0].scriptSig;\n \n-        BOOST_CHECK(!AddOrphanTx(tx));\n+        BOOST_CHECK(!AddOrphanTx(tx, i));\n+    }\n+\n+    // Test EraseOrphansFor:\n+    for (NodeId i = 0; i < 3; i++)\n+    {\n+        size_t sizeBefore = mapOrphanTransactions.size();\n+        EraseOrphansFor(i);\n+        BOOST_CHECK(mapOrphanTransactions.size() < sizeBefore);\n     }\n \n     // Test LimitOrphanTxSize() function:"
      }
    ]
  }
]