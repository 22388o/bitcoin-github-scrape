[
  {
    "sha": "940669657837e4a247a4d0746c12f52e8662f325",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5NDA2Njk2NTc4MzdlNGEyNDdhNGQwNzQ2YzEyZjUyZTg2NjJmMzI1",
    "commit": {
      "author": {
        "name": "Gavin Andresen",
        "email": "gavinandresen@gmail.com",
        "date": "2011-09-06T17:39:17Z"
      },
      "committer": {
        "name": "Gavin Andresen",
        "email": "gavinandresen@gmail.com",
        "date": "2011-09-07T00:28:15Z"
      },
      "message": "Fix AddAddress cs_mapaddresses/db transaction deadlock",
      "tree": {
        "sha": "c4466c2ac1334eba4c4535d49d61f114050bb081",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c4466c2ac1334eba4c4535d49d61f114050bb081"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/940669657837e4a247a4d0746c12f52e8662f325",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/940669657837e4a247a4d0746c12f52e8662f325",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/940669657837e4a247a4d0746c12f52e8662f325",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/940669657837e4a247a4d0746c12f52e8662f325/comments",
    "author": {
      "login": "gavinandresen",
      "id": 331997,
      "node_id": "MDQ6VXNlcjMzMTk5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/331997?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gavinandresen",
      "html_url": "https://github.com/gavinandresen",
      "followers_url": "https://api.github.com/users/gavinandresen/followers",
      "following_url": "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url": "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gavinandresen/subscriptions",
      "organizations_url": "https://api.github.com/users/gavinandresen/orgs",
      "repos_url": "https://api.github.com/users/gavinandresen/repos",
      "events_url": "https://api.github.com/users/gavinandresen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gavinandresen/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "gavinandresen",
      "id": 331997,
      "node_id": "MDQ6VXNlcjMzMTk5Nw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/331997?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gavinandresen",
      "html_url": "https://github.com/gavinandresen",
      "followers_url": "https://api.github.com/users/gavinandresen/followers",
      "following_url": "https://api.github.com/users/gavinandresen/following{/other_user}",
      "gists_url": "https://api.github.com/users/gavinandresen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gavinandresen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gavinandresen/subscriptions",
      "organizations_url": "https://api.github.com/users/gavinandresen/orgs",
      "repos_url": "https://api.github.com/users/gavinandresen/repos",
      "events_url": "https://api.github.com/users/gavinandresen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gavinandresen/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e39f9256550e3e30965d1d5e6e16d232c3e0e4ac",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e39f9256550e3e30965d1d5e6e16d232c3e0e4ac",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e39f9256550e3e30965d1d5e6e16d232c3e0e4ac"
      }
    ],
    "stats": {
      "total": 36,
      "additions": 21,
      "deletions": 15
    },
    "files": [
      {
        "sha": "509d8905f91d3bb3b1117d40043ecb8c0a5bd203",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 21,
        "deletions": 15,
        "changes": 36,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/940669657837e4a247a4d0746c12f52e8662f325/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/940669657837e4a247a4d0746c12f52e8662f325/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=940669657837e4a247a4d0746c12f52e8662f325",
        "patch": "@@ -443,6 +443,10 @@ bool AddAddress(CAddress addr, int64 nTimePenalty, CAddrDB *pAddrDB)\n     if (addr.ip == addrLocalHost.ip)\n         return false;\n     addr.nTime = max((int64)0, (int64)addr.nTime - nTimePenalty);\n+    bool fUpdated = false;\n+    bool fNew = false;\n+    CAddress addrFound = addr;\n+\n     CRITICAL_BLOCK(cs_mapAddresses)\n     {\n         map<vector<unsigned char>, CAddress>::iterator it = mapAddresses.find(addr.GetKey());\n@@ -451,16 +455,12 @@ bool AddAddress(CAddress addr, int64 nTimePenalty, CAddrDB *pAddrDB)\n             // New address\n             printf(\"AddAddress(%s)\\n\", addr.ToString().c_str());\n             mapAddresses.insert(make_pair(addr.GetKey(), addr));\n-            if (pAddrDB)\n-                pAddrDB->WriteAddress(addr);\n-            else\n-                CAddrDB().WriteAddress(addr);\n-            return true;\n+            fUpdated = true;\n+            fNew = true;\n         }\n         else\n         {\n-            bool fUpdated = false;\n-            CAddress& addrFound = (*it).second;\n+            addrFound = (*it).second;\n             if ((addrFound.nServices | addr.nServices) != addrFound.nServices)\n             {\n                 // Services have been added\n@@ -475,16 +475,22 @@ bool AddAddress(CAddress addr, int64 nTimePenalty, CAddrDB *pAddrDB)\n                 addrFound.nTime = addr.nTime;\n                 fUpdated = true;\n             }\n-            if (fUpdated)\n-            {\n-                if (pAddrDB)\n-                    pAddrDB->WriteAddress(addrFound);\n-                else\n-                    CAddrDB().WriteAddress(addrFound);\n-            }\n         }\n     }\n-    return false;\n+    // There is a nasty deadlock bug if this is done inside the cs_mapAddresses\n+    // CRITICAL_BLOCK:\n+    // Thread 1:  begin db transaction (locks inside-db-mutex)\n+    //            then AddAddress (locks cs_mapAddresses)\n+    // Thread 2:  AddAddress (locks cs_mapAddresses)\n+    //             ... then db operation hangs waiting for inside-db-mutex\n+    if (fUpdated)\n+    {\n+        if (pAddrDB)\n+            pAddrDB->WriteAddress(addrFound);\n+        else\n+            CAddrDB().WriteAddress(addrFound);\n+    }\n+    return fNew;\n }\n \n void AddressCurrentlyConnected(const CAddress& addr)"
      }
    ]
  }
]