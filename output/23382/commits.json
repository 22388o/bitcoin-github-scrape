[
  {
    "sha": "1a8a382787fe969ccf62fca86eb6fe0d3f7be2f3",
    "node_id": "C_kwDOABII59oAKDFhOGEzODI3ODdmZTk2OWNjZjYyZmNhODZlYjZmZTBkM2Y3YmUyZjM",
    "commit": {
      "author": {
        "name": "Vasil Dimov",
        "email": "vd@FreeBSD.org",
        "date": "2021-10-28T13:31:22Z"
      },
      "committer": {
        "name": "Vasil Dimov",
        "email": "vd@FreeBSD.org",
        "date": "2021-10-28T14:40:55Z"
      },
      "message": "addrman: bump peers.dat format version number\n\nAfter 92617b7a758c0425330fba4b886296730567927c\n(https://github.com/bitcoin/bitcoin/pull/23306) we allow multiple entries\nin addrman with the same address that only differ by port.\n\nSuch `peers.dat` trips versions before the above commit and they fail to\nread it with an obscure \"corruption\" error:\n\n```\nCorrupt data. Consistency check failed with code -5\n```\n\nSo, if we detect that there are such \"duplicate\" entries, write the file\nwith a newver format version, so that old software emits:\n\n```\nUnsupported format of addrman database: 4. It is compatible with formats >=4, but the maximum supported by this version of Bitcoin Core is 3.\n```",
      "tree": {
        "sha": "096cdcc9d360df9d6f80cb85e98e3d8b7648ecb4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/096cdcc9d360df9d6f80cb85e98e3d8b7648ecb4"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1a8a382787fe969ccf62fca86eb6fe0d3f7be2f3",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQQzBAABCAAdFiEE5k2NRWFNsHVF2czBVN8G9ktVy78FAmF6togACgkQVN8G9ktV\ny78MUx//fEPi12AFmj4/jEVBavrkT2PWlpVORlX1icEzRj3muMxZo5Y3YZnC6MiA\n1Jv2CoXu+q5eYUS9a2SL7sf7ZllAKHoykekv68JlLngSciW2hucTMbNngtFHtx5L\nUg8LnigJZvTrsgectRj+wxgpga8QinKSrhFf2VIIpRJpPfiuNb5I1bxctxzx+Iuw\nx8I5VCMraI5DGtve3wDW3JPcJ5PswICEV5jYMw+JvhkG/m8hhdf/e0gWnKXnk1wS\n44raI95LcGHofD3KsjG1gRZYc4RTaZ25pLXoErBxNM9GSHxPu1OBYqEfM1AvgdiM\nWLnlBMkYtTFj5N7oPe/Ko/BM7JDPQDyYRRWh3gl4REVqWvnh5wtMfOPTmB5MUB5t\nvphl9ZnlynAyQ/qp3ecXri3L7Y4jDYxn5+8LoWnkNpO22ZAXxOgy4nPkuM24bwuF\nNlju95bmX74x4owQvzCajKxrCraNktSmARiZ7O/U1fttOBYdjiKcMUu7RCCldEwm\nOq1+P5mV3bMtbp9pgLU1Xg3ZQkzRA8KhhO3S7HYg73APgqxA+qyHPLD+Phjmt/Ny\nYf5OjHTRFzg48NSLcgcwCkF2a6D+ytZowqWgoZgLnKLl4agp2D+4BBwph7WQSN//\n5IevIRrKKsEMxNkuA4ly/eZHBA54AyG4n19lf0WVi4o2KSZccgRmLRYrZ0trRTjQ\nlXqKoPUY5785MDQa10wCeqjQqnaatfwKUt86VAA5MnUDn7lgECXUWbj7bVEWr7jt\nTKU+vELaFJwE1YIVF4pTGHEineoXAE3UlqRzM8+oyeh5OKG8RXYI0seosiA8CEF+\nImxAyqGjCe8KeF+YPC1S4Q9Y6MolBDyc0+E6De+/uiN+lrrqzs6WIq7IxCKFTL9q\n7Rk5/A5pe5N5hQoo+Bs03mtSt9L+7oGdHneI3WAY/dOTNdP+YhSw87f42ONDu1q6\n8oKWaFXbe3p7pZF45ZtgziUKujiM+gy1+CmGJ0rAFua7JPxNjQYFgzA7qxXZEaL+\nSSzaRILtYxW0jd+6+nU1w4OdfdTDeD5wl05cWBpvf+bSs2tkLimYjzNghs/ZViq0\nnmrhxaRSW+gulYb4K37NlZa5sY8VWJFKwWpODd1Hc2exY6j65k1GnMeAXdyh516N\nX+li7WuqBhRDdBC8tTJCKSqeLzi2Ue69soPE9e6DEK7GiLssJdSfCGSMKSdOd7va\nk/PRN9UlOl43k7cYIDfXn8j5MfJR5E0gwGcAR5GMwRWPzWOihdL1HdL7138WU7zT\nbv3X8mc/f2Ya1XXNYJnjKM6n+YgwRcpS081hQNvRykClCjq7wNuz9hJk2bwQN8Df\nVV2Odhr4twJ/+MMuWcMAKRmTPSTeuw==\n=e3x/\n-----END PGP SIGNATURE-----",
        "payload": "tree 096cdcc9d360df9d6f80cb85e98e3d8b7648ecb4\nparent ab25ef8c7f767258d5fe44f53b35ad8bd51ed5cd\nauthor Vasil Dimov <vd@FreeBSD.org> 1635427882 +0200\ncommitter Vasil Dimov <vd@FreeBSD.org> 1635432055 +0200\n\naddrman: bump peers.dat format version number\n\nAfter 92617b7a758c0425330fba4b886296730567927c\n(https://github.com/bitcoin/bitcoin/pull/23306) we allow multiple entries\nin addrman with the same address that only differ by port.\n\nSuch `peers.dat` trips versions before the above commit and they fail to\nread it with an obscure \"corruption\" error:\n\n```\nCorrupt data. Consistency check failed with code -5\n```\n\nSo, if we detect that there are such \"duplicate\" entries, write the file\nwith a newver format version, so that old software emits:\n\n```\nUnsupported format of addrman database: 4. It is compatible with formats >=4, but the maximum supported by this version of Bitcoin Core is 3.\n```\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1a8a382787fe969ccf62fca86eb6fe0d3f7be2f3",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1a8a382787fe969ccf62fca86eb6fe0d3f7be2f3",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1a8a382787fe969ccf62fca86eb6fe0d3f7be2f3/comments",
    "author": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ab25ef8c7f767258d5fe44f53b35ad8bd51ed5cd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ab25ef8c7f767258d5fe44f53b35ad8bd51ed5cd",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ab25ef8c7f767258d5fe44f53b35ad8bd51ed5cd"
      }
    ],
    "stats": {
      "total": 13,
      "additions": 11,
      "deletions": 2
    },
    "files": [
      {
        "sha": "823212f8fdb862f9d026c11e55f2042f9eab0501",
        "filename": "src/addrman.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 1,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1a8a382787fe969ccf62fca86eb6fe0d3f7be2f3/src/addrman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1a8a382787fe969ccf62fca86eb6fe0d3f7be2f3/src/addrman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/addrman.cpp?ref=1a8a382787fe969ccf62fca86eb6fe0d3f7be2f3",
        "patch": "@@ -169,9 +169,17 @@ void AddrManImpl::Serialize(Stream& s_) const\n \n     s << static_cast<uint8_t>(FILE_FORMAT);\n \n+    std::set<CNetAddr> dup_guard;\n+    // If we have multiple entries with the same address (and different port).\n+    const bool duplicates_by_addr =\n+        std::any_of(mapAddr.begin(), mapAddr.end(), [&dup_guard](const auto& e) {\n+            return !dup_guard.insert(e.first).second; // insert failure means duplicates\n+        });\n+\n     // Increment `lowest_compatible` iff a newly introduced format is incompatible with\n     // the previous one.\n-    static constexpr uint8_t lowest_compatible = Format::V3_BIP155;\n+    static const uint8_t lowest_compatible =\n+        duplicates_by_addr ? Format::V4_DUPADDR : Format::V3_BIP155;\n     s << static_cast<uint8_t>(INCOMPATIBILITY_BASE + lowest_compatible);\n \n     s << nKey;"
      },
      {
        "sha": "f4d93fa5cd37b7ffeb1bbd945b0130665f6bd6a7",
        "filename": "src/addrman_impl.h",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1a8a382787fe969ccf62fca86eb6fe0d3f7be2f3/src/addrman_impl.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1a8a382787fe969ccf62fca86eb6fe0d3f7be2f3/src/addrman_impl.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/addrman_impl.h?ref=1a8a382787fe969ccf62fca86eb6fe0d3f7be2f3",
        "patch": "@@ -157,14 +157,15 @@ class AddrManImpl\n         V1_DETERMINISTIC = 1, //!< for pre-asmap files\n         V2_ASMAP = 2,         //!< for files including asmap version\n         V3_BIP155 = 3,        //!< same as V2_ASMAP plus addresses are in BIP155 format\n+        V4_DUPADDR = 4,       //!< V3_BIP155 + entries with the same address but different port\n     };\n \n     //! The maximum format this software knows it can unserialize. Also, we always serialize\n     //! in this format.\n     //! The format (first byte in the serialized stream) can be higher than this and\n     //! still this software may be able to unserialize the file - if the second byte\n     //! (see `lowest_compatible` in `Unserialize()`) is less or equal to this.\n-    static constexpr Format FILE_FORMAT = Format::V3_BIP155;\n+    static constexpr Format FILE_FORMAT = Format::V4_DUPADDR;\n \n     //! The initial value of a field that is incremented every time an incompatible format\n     //! change is made (such that old software versions would not be able to parse and"
      }
    ]
  }
]