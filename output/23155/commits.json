[
  {
    "sha": "ffd09281fe26446fcefa0627c220a52706e35227",
    "node_id": "C_kwDOABII59oAKGZmZDA5MjgxZmUyNjQ0NmZjZWZhMDYyN2MyMjBhNTI3MDZlMzUyMjc",
    "commit": {
      "author": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2019-04-25T15:09:57Z"
      },
      "committer": {
        "name": "James O'Beirne",
        "email": "james.obeirne@pm.me",
        "date": "2021-11-30T16:19:26Z"
      },
      "message": "rpc: various fixups for dumptxoutset\n\n- Actually generate an assumeutxo hash and display it\n- Add nchaintx to output (necessary for use in chainparams entry)\n- Add path of serialized UTXO file to output",
      "tree": {
        "sha": "693e6bc20e8b550acb179b4353195138294efb20",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/693e6bc20e8b550acb179b4353195138294efb20"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ffd09281fe26446fcefa0627c220a52706e35227",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCgAdFiEEGNRVI1NPYuZCSIrGepNdrbLETwUFAmGmTxAACgkQepNdrbLE\nTwVhshAAoVZbuKd6sZbRRAiRtyccdDg+S0iMdhBOspIWNOxlEMMiZiPwrkAhzkRN\nHzF93rPrR1TqOFExtE+A5+ulnU0+s+aCdsN0XJ37Z2XOfYX8V0Hcc91cub+xx1El\ntvyS/cV0fqlxqDN8pMbqrVsZMNc4gAI3+ExVp7qug8PvJaYn+ik1Esyxy1gZKCtv\nkfUHAmGryiY+11HJa5CnOjIiK47NWMLpgFhWPnbI/I2FxxPAPx0TfW7kWbgFDidt\nZjxxikuj0zbUtPdgSnsMghFR7QXTJp0HV7IFszRwuvH6b4E5iUBQzGO3QvqPBHvz\nO2Q9FfnzuU232d3tXBHhsiT7gSHE5B/lqZ+MwhQFax39poMk+PrUlbews9IbFJsd\nBdsdyPH1WTeMRrLCaV5dZ6LltqR7CD4AqCSi7QVwr4VYtmUhPJ6jFalxKzxettfv\njOgVbHbjzwzGBEa5soktLEczsU8EjIxUrv1LeBfveGNxGf3AT7VHFPCnY9wUNj2k\n+z8pkkqR2HM+WTmAaqe//0rMLNitCS1+hfg06XMvz8LI/PQhTHytgc/CnStjD+fU\nn+gX/lLW9R4Wm7XuZzVokyPZQwuB6+INgkGwzzQhcoz5hofaLs1seg4KcQ1eP1U2\nuDL/P1H55JE0u2aa76LFkDMZ6YaK32xBuuv/jtI7S+LpOyLmPjs=\n=vCV2\n-----END PGP SIGNATURE-----",
        "payload": "tree 693e6bc20e8b550acb179b4353195138294efb20\nparent ab25ef8c7f767258d5fe44f53b35ad8bd51ed5cd\nauthor James O'Beirne <james.obeirne@gmail.com> 1556204997 -0400\ncommitter James O'Beirne <james.obeirne@pm.me> 1638289166 -0500\n\nrpc: various fixups for dumptxoutset\n\n- Actually generate an assumeutxo hash and display it\n- Add nchaintx to output (necessary for use in chainparams entry)\n- Add path of serialized UTXO file to output\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ffd09281fe26446fcefa0627c220a52706e35227",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ffd09281fe26446fcefa0627c220a52706e35227",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ffd09281fe26446fcefa0627c220a52706e35227/comments",
    "author": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ab25ef8c7f767258d5fe44f53b35ad8bd51ed5cd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ab25ef8c7f767258d5fe44f53b35ad8bd51ed5cd",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ab25ef8c7f767258d5fe44f53b35ad8bd51ed5cd"
      }
    ],
    "stats": {
      "total": 41,
      "additions": 35,
      "deletions": 6
    },
    "files": [
      {
        "sha": "b58b9daffe61cb7e82f148200ed207ed874f96e5",
        "filename": "src/rpc/blockchain.cpp",
        "status": "modified",
        "additions": 22,
        "deletions": 4,
        "changes": 26,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ffd09281fe26446fcefa0627c220a52706e35227/src/rpc/blockchain.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ffd09281fe26446fcefa0627c220a52706e35227/src/rpc/blockchain.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/blockchain.cpp?ref=ffd09281fe26446fcefa0627c220a52706e35227",
        "patch": "@@ -15,10 +15,12 @@\n #include <core_io.h>\n #include <deploymentinfo.h>\n #include <deploymentstatus.h>\n+#include <fs.h>\n #include <hash.h>\n #include <index/blockfilterindex.h>\n #include <index/coinstatsindex.h>\n #include <node/blockstorage.h>\n+#include <logging/timer.h>\n #include <node/coinstats.h>\n #include <node/context.h>\n #include <node/utxo_snapshot.h>\n@@ -2547,6 +2549,8 @@ static RPCHelpMan dumptxoutset()\n                     {RPCResult::Type::STR_HEX, \"base_hash\", \"the hash of the base of the snapshot\"},\n                     {RPCResult::Type::NUM, \"base_height\", \"the height of the base of the snapshot\"},\n                     {RPCResult::Type::STR, \"path\", \"the absolute path that the snapshot was written to\"},\n+                    {RPCResult::Type::STR_HEX, \"txoutset_hash\", \"the hash of the UTXO set contents\"},\n+                    {RPCResult::Type::NUM, \"nchaintx\", \"the number of transactions in the chain up to and including the base block\"},\n                 }\n         },\n         RPCExamples{\n@@ -2569,7 +2573,8 @@ static RPCHelpMan dumptxoutset()\n     FILE* file{fsbridge::fopen(temppath, \"wb\")};\n     CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n     NodeContext& node = EnsureAnyNodeContext(request.context);\n-    UniValue result = CreateUTXOSnapshot(node, node.chainman->ActiveChainstate(), afile);\n+    UniValue result = CreateUTXOSnapshot(\n+        node, node.chainman->ActiveChainstate(), afile, path, temppath);\n     fs::rename(temppath, path);\n \n     result.pushKV(\"path\", path.u8string());\n@@ -2578,10 +2583,15 @@ static RPCHelpMan dumptxoutset()\n     };\n }\n \n-UniValue CreateUTXOSnapshot(NodeContext& node, CChainState& chainstate, CAutoFile& afile)\n+UniValue CreateUTXOSnapshot(\n+    NodeContext& node,\n+    CChainState& chainstate,\n+    CAutoFile& afile,\n+    const fs::path& path,\n+    const fs::path& temppath)\n {\n     std::unique_ptr<CCoinsViewCursor> pcursor;\n-    CCoinsStats stats{CoinStatsHashType::NONE};\n+    CCoinsStats stats{CoinStatsHashType::HASH_SERIALIZED};\n     CBlockIndex* tip;\n \n     {\n@@ -2610,6 +2620,10 @@ UniValue CreateUTXOSnapshot(NodeContext& node, CChainState& chainstate, CAutoFil\n         CHECK_NONFATAL(tip);\n     }\n \n+    LOG_TIME_SECONDS(strprintf(\"writing UTXO snapshot at height %s (%s) to file %s (via %s)\",\n+        tip->nHeight, tip->GetBlockHash().ToString(),\n+        fs::PathToString(path), fs::PathToString(temppath)));\n+\n     SnapshotMetadata metadata{tip->GetBlockHash(), stats.coins_count, tip->nChainTx};\n \n     afile << metadata;\n@@ -2635,7 +2649,11 @@ UniValue CreateUTXOSnapshot(NodeContext& node, CChainState& chainstate, CAutoFil\n     result.pushKV(\"coins_written\", stats.coins_count);\n     result.pushKV(\"base_hash\", tip->GetBlockHash().ToString());\n     result.pushKV(\"base_height\", tip->nHeight);\n-\n+    result.pushKV(\"path\", path.u8string());\n+    result.pushKV(\"txoutset_hash\", stats.hashSerialized.ToString());\n+    // Cast required because univalue doesn't have serialization specified for\n+    // `unsigned int`, nChainTx's type.\n+    result.pushKV(\"nchaintx\", uint64_t{tip->nChainTx});\n     return result;\n }\n "
      },
      {
        "sha": "ad4fb646b3ec1bc0c2dbe139b7117c93375d69ea",
        "filename": "src/rpc/blockchain.h",
        "status": "modified",
        "additions": 7,
        "deletions": 1,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ffd09281fe26446fcefa0627c220a52706e35227/src/rpc/blockchain.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ffd09281fe26446fcefa0627c220a52706e35227/src/rpc/blockchain.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/blockchain.h?ref=ffd09281fe26446fcefa0627c220a52706e35227",
        "patch": "@@ -7,6 +7,7 @@\n \n #include <consensus/amount.h>\n #include <core_io.h>\n+#include <fs.h>\n #include <streams.h>\n #include <sync.h>\n \n@@ -65,6 +66,11 @@ CBlockPolicyEstimator& EnsureAnyFeeEstimator(const std::any& context);\n  * Helper to create UTXO snapshots given a chainstate and a file handle.\n  * @return a UniValue map containing metadata about the snapshot.\n  */\n-UniValue CreateUTXOSnapshot(NodeContext& node, CChainState& chainstate, CAutoFile& afile);\n+UniValue CreateUTXOSnapshot(\n+    NodeContext& node,\n+    CChainState& chainstate,\n+    CAutoFile& afile,\n+    const fs::path& path,\n+    const fs::path& tmppath);\n \n #endif"
      },
      {
        "sha": "e3d2b417c9a22b5146221616c6bbc25cdb0ba9a3",
        "filename": "src/test/util/chainstate.h",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ffd09281fe26446fcefa0627c220a52706e35227/src/test/util/chainstate.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ffd09281fe26446fcefa0627c220a52706e35227/src/test/util/chainstate.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/util/chainstate.h?ref=ffd09281fe26446fcefa0627c220a52706e35227",
        "patch": "@@ -34,7 +34,8 @@ CreateAndActivateUTXOSnapshot(NodeContext& node, const fs::path root, F malleati\n     FILE* outfile{fsbridge::fopen(snapshot_path, \"wb\")};\n     CAutoFile auto_outfile{outfile, SER_DISK, CLIENT_VERSION};\n \n-    UniValue result = CreateUTXOSnapshot(node, node.chainman->ActiveChainstate(), auto_outfile);\n+    UniValue result = CreateUTXOSnapshot(\n+        node, node.chainman->ActiveChainstate(), auto_outfile, snapshot_path, snapshot_path);\n     BOOST_TEST_MESSAGE(\n         \"Wrote UTXO snapshot to \" << fs::PathToString(snapshot_path.make_preferred()) << \": \" << result.write());\n "
      },
      {
        "sha": "4359f4a799f18c6dcb6247ef534687954fd10f5c",
        "filename": "test/functional/rpc_dumptxoutset.py",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ffd09281fe26446fcefa0627c220a52706e35227/test/functional/rpc_dumptxoutset.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ffd09281fe26446fcefa0627c220a52706e35227/test/functional/rpc_dumptxoutset.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_dumptxoutset.py?ref=ffd09281fe26446fcefa0627c220a52706e35227",
        "patch": "@@ -45,6 +45,10 @@ def run_test(self):\n             assert_equal(\n                 digest, '7ae82c986fa5445678d2a21453bb1c86d39e47af13da137640c2b1cf8093691c')\n \n+        assert_equal(\n+            out['txoutset_hash'], 'd4b614f476b99a6e569973bf1c0120d88b1a168076f8ce25691fb41dd1cef149')\n+        assert_equal(out['nchaintx'], 101)\n+\n         # Specifying a path to an existing file will fail.\n         assert_raises_rpc_error(\n             -8, '{} already exists'.format(FILENAME),  node.dumptxoutset, FILENAME)"
      }
    ]
  }
]