[
  {
    "sha": "42f5ce40931402aaa395ef2959deb64e9a9fff02",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0MmY1Y2U0MDkzMTQwMmFhYTM5NWVmMjk1OWRlYjY0ZTlhOWZmZjAy",
    "commit": {
      "author": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2017-01-05T14:10:08Z"
      },
      "committer": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2017-01-06T15:12:05Z"
      },
      "message": "Try to reduce change output to make needed fee in CreateTransaction\n\nOnce we've picked coins and dummy-signed the transaction to calculate fee, if we don't have sufficient fee, then try to meet the fee by reducing change before resorting to picking new coins.",
      "tree": {
        "sha": "650bad83761a48cafdeed51a047fb3a63b559a3c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/650bad83761a48cafdeed51a047fb3a63b559a3c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/42f5ce40931402aaa395ef2959deb64e9a9fff02",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/42f5ce40931402aaa395ef2959deb64e9a9fff02",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/42f5ce40931402aaa395ef2959deb64e9a9fff02",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/42f5ce40931402aaa395ef2959deb64e9a9fff02/comments",
    "author": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f646275b90b1de93bc62b4c4d045d75ac0b96eee",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f646275b90b1de93bc62b4c4d045d75ac0b96eee",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f646275b90b1de93bc62b4c4d045d75ac0b96eee"
      }
    ],
    "stats": {
      "total": 16,
      "additions": 15,
      "deletions": 1
    },
    "files": [
      {
        "sha": "bdf6d3c7a6a4b8ad1e34d45421bddd839358274e",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 12,
        "deletions": 0,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/42f5ce40931402aaa395ef2959deb64e9a9fff02/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/42f5ce40931402aaa395ef2959deb64e9a9fff02/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=42f5ce40931402aaa395ef2959deb64e9a9fff02",
        "patch": "@@ -2537,6 +2537,18 @@ bool CWallet::CreateTransaction(const vector<CRecipient>& vecSend, CWalletTx& wt\n                 if (nFeeRet >= nFeeNeeded)\n                     break; // Done, enough fee included.\n \n+                // Try to reduce change to include necessary fee\n+                if (nChangePosInOut != -1 && nSubtractFeeFromAmount == 0) {\n+                    CAmount additionalFeeNeeded = nFeeNeeded - nFeeRet;\n+                    vector<CTxOut>::iterator change_position = txNew.vout.begin()+nChangePosInOut;\n+                    // Only reduce change if remaining amount is still a large enough output.\n+                    if (change_position->nValue >= MIN_FINAL_CHANGE + additionalFeeNeeded) {\n+                        change_position->nValue -= additionalFeeNeeded;\n+                        nFeeRet += additionalFeeNeeded;\n+                        break; // Done, able to increase fee from change\n+                    }\n+                }\n+\n                 // Include more fee and try again.\n                 nFeeRet = nFeeNeeded;\n                 continue;"
      },
      {
        "sha": "b9fa6bb24b39184ddf95cc4e618482ace2ff566a",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 3,
        "deletions": 1,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/42f5ce40931402aaa395ef2959deb64e9a9fff02/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/42f5ce40931402aaa395ef2959deb64e9a9fff02/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=42f5ce40931402aaa395ef2959deb64e9a9fff02",
        "patch": "@@ -48,8 +48,10 @@ static const CAmount DEFAULT_TRANSACTION_FEE = 0;\n static const CAmount DEFAULT_FALLBACK_FEE = 20000;\n //! -mintxfee default\n static const CAmount DEFAULT_TRANSACTION_MINFEE = 1000;\n-//! minimum change amount\n+//! target minimum change amount\n static const CAmount MIN_CHANGE = CENT;\n+//! final minimum change amount after paying for fees\n+static const CAmount MIN_FINAL_CHANGE = MIN_CHANGE/2;\n //! Default for -spendzeroconfchange\n static const bool DEFAULT_SPEND_ZEROCONF_CHANGE = true;\n //! Default for -sendfreetransactions"
      }
    ]
  },
  {
    "sha": "20449ef09edf8f4f51a3e531d947dd89973c2a31",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyMDQ0OWVmMDllZGY4ZjRmNTFhM2U1MzFkOTQ3ZGQ4OTk3M2MyYTMx",
    "commit": {
      "author": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2017-01-05T14:12:48Z"
      },
      "committer": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2017-01-06T15:18:56Z"
      },
      "message": "Don't overpay fee if we have selected new coins that result in a smaller transaction.\n\nOn repeated calls to SelectCoins we try to meet the fee necessary for the last transaction, the new fee required might be smaller, so increase our change by the difference if we can.",
      "tree": {
        "sha": "7453c2fb8de3e66d2a81dda0c0ffb63951cd21b9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7453c2fb8de3e66d2a81dda0c0ffb63951cd21b9"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/20449ef09edf8f4f51a3e531d947dd89973c2a31",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/20449ef09edf8f4f51a3e531d947dd89973c2a31",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/20449ef09edf8f4f51a3e531d947dd89973c2a31",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/20449ef09edf8f4f51a3e531d947dd89973c2a31/comments",
    "author": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "42f5ce40931402aaa395ef2959deb64e9a9fff02",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/42f5ce40931402aaa395ef2959deb64e9a9fff02",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/42f5ce40931402aaa395ef2959deb64e9a9fff02"
      }
    ],
    "stats": {
      "total": 19,
      "additions": 18,
      "deletions": 1
    },
    "files": [
      {
        "sha": "2775f4def3d0a8241cfda048e725ca977c7ff47c",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 18,
        "deletions": 1,
        "changes": 19,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/20449ef09edf8f4f51a3e531d947dd89973c2a31/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/20449ef09edf8f4f51a3e531d947dd89973c2a31/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=20449ef09edf8f4f51a3e531d947dd89973c2a31",
        "patch": "@@ -2534,8 +2534,25 @@ bool CWallet::CreateTransaction(const vector<CRecipient>& vecSend, CWalletTx& wt\n                     return false;\n                 }\n \n-                if (nFeeRet >= nFeeNeeded)\n+                if (nFeeRet >= nFeeNeeded) {\n+                    // Reduce fee to only the needed amount if we have change\n+                    // output to increase.  This prevents potential overpayment\n+                    // in fees if the coins selected to meet nFeeNeeded result\n+                    // in a transaction that requires less fee than the prior\n+                    // iteration.\n+                    // TODO: The case where nSubtractFeeFromAmount > 0 remains\n+                    // to be addressed because it requires returning the fee to\n+                    // the payees and not the change output.\n+                    // TODO: The case where there is no change output remains\n+                    // to be addressed so we avoid creating too small an output.\n+                    if (nFeeRet > nFeeNeeded && nChangePosInOut != -1 && nSubtractFeeFromAmount == 0) {\n+                        CAmount extraFeePaid = nFeeRet - nFeeNeeded;\n+                        vector<CTxOut>::iterator change_position = txNew.vout.begin()+nChangePosInOut;\n+                        change_position->nValue += extraFeePaid;\n+                        nFeeRet -= extraFeePaid;\n+                    }\n                     break; // Done, enough fee included.\n+                }\n \n                 // Try to reduce change to include necessary fee\n                 if (nChangePosInOut != -1 && nSubtractFeeFromAmount == 0) {"
      }
    ]
  }
]