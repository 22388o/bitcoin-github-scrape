gmaxwell,2014-02-14T02:44:14Z,"Any reason not to just list any transaction with one or more conflicting intput? e.g. generalize it to all double-spends and not just signature mutants?\n\nThis would make it include things like an identically outputted transaction with ANYONECANPAY inputs that has had additional inputs added for fees, for example.\n",https://github.com/bitcoin/bitcoin/pull/3671#issuecomment-35050736,35050736,
apoelstra,2014-02-14T06:36:32Z,"Just tried this patch. It works successfully. I have four types of unconfirmed transactions in my wallet. The first was a malleability dupe (it was a coinjoin which I signed twice). The patch correctly reports it 'conflicted' and shows the confirmed tx under walletconflicts, while the confirmed transaction is still there (labelled 'send' and 'receive', not 'conflicted') and has the unconfirmed tx ",https://github.com/bitcoin/bitcoin/pull/3671#issuecomment-35059984,35059984,
gavinandresen,2014-02-14T14:00:06Z,"@gmaxwell : generalizing to arbitrary double-spends is tricky. If they are a wallet transaction in an old wallet and the double-spend happened long ago and you're not running with -txindex, then the code can know that an input is spent (is not in the UTXO set) but might have no idea which transaction double-spent (the double-spend might not be a wallet transaction-- it might have inputs and output",https://github.com/bitcoin/bitcoin/pull/3671#issuecomment-35085346,35085346,
gavinandresen,2014-02-14T19:51:51Z,"Reworked to use a multimap&lt;COutpoint, uint256&gt; to keep track of conflicts. I still might change this to be more memory-thrifty and store CWalletTx*'s as the values instead of their hashes.\n\nThis will handle most double-spends (if both spends are wallet transactions) in addition to mutated/malleable transactions.\n\nI fixed the bug in getunconfirmedbalance. The logic for uncofirmed balance ",https://github.com/bitcoin/bitcoin/pull/3671#issuecomment-35118286,35118286,
gmaxwell,2014-02-14T20:26:26Z,It's currently counting all generated coin as a conflict. :)\n,https://github.com/bitcoin/bitcoin/pull/3671#issuecomment-35121420,35121420,
apoelstra,2014-02-14T21:30:50Z,"OK, with the new patch I am seeing the same listtransaction behaviour as before, except: the txpair which conflicted because they differed in fee, now show each others' txids under 'walletconflicts'. So everything is good here.\n\ngetbalance returns my (correct) balance. getunconfirmedbalance returns 0, as it should.\n",https://github.com/bitcoin/bitcoin/pull/3671#issuecomment-35126695,35126695,
gavinandresen,2014-02-14T22:34:26Z,"Fixed the generated-coins-counted-as-conflict, but gmaxwell found getbalance '*' is counting immature coinbases...\n\nUPDATE: so does 0.9.0rc1, so I don't feel so bad.  I'll fix.\n",https://github.com/bitcoin/bitcoin/pull/3671#issuecomment-35131818,35131818,
BitcoinPullTester,2014-02-14T23:58:00Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/731b89b8b53cb2ea4d2d5c8f2875def515766ea1 for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/cu",https://github.com/bitcoin/bitcoin/pull/3671#issuecomment-35140408,35140408,
gmaxwell,2014-02-15T00:50:17Z,ACK. (immature coins issue fixed too)\n,https://github.com/bitcoin/bitcoin/pull/3671#issuecomment-35142509,35142509,
laanwj,2014-02-15T08:09:07Z,"ACK code changes, works for me (tested with conflicts, mined transactions and unconfirmed transactions, as well as spending unconfirmed change).\n",https://github.com/bitcoin/bitcoin/pull/3671#issuecomment-35149999,35149999,
laanwj,2014-02-14T07:32:31Z,"~~Before this call, we should detect if there is an existing ""clone"" and if so copy the metadata (at least vOrderForm).~~\nEdit: never mind, you already do that _in_ AddToClones...\n",https://github.com/bitcoin/bitcoin/pull/3671#discussion_r9741072,9741072,src/wallet.cpp
laanwj,2014-02-14T07:38:47Z,"I'm uncertain about doing the metadata copying while loading from the wallet.\nThe wallet transactions aren't loaded in a specific order, so it will basically judge a random one of them to be the 'original clone' and copy that one's metadata. Every time the wallet loads.\n",https://github.com/bitcoin/bitcoin/pull/3671#discussion_r9741144,9741144,src/wallet.cpp
laanwj,2014-02-14T08:18:22Z,Please copy vOrderForm so that we don't lose payment request data and URI 'message' fields\n,https://github.com/bitcoin/bitcoin/pull/3671#discussion_r9741605,9741605,src/wallet.cpp
laanwj,2014-02-14T08:24:06Z,"@sipa Is it safe to use the sipahash(TM) here, or would it be better to use CTxIn.prevout (COutPoint) as you proposed?\n",https://github.com/bitcoin/bitcoin/pull/3671#discussion_r9741677,9741677,src/wallet.h
sipa,2014-02-14T12:45:22Z,No point in using a hash here IMO. I'd just use a multimap from COutPoints to the wallet transacitons they are spent int.\n,https://github.com/bitcoin/bitcoin/pull/3671#discussion_r9747092,9747092,src/wallet.h
gavinandresen,2014-02-14T13:41:39Z,ACK\n,https://github.com/bitcoin/bitcoin/pull/3671#discussion_r9748263,9748263,src/wallet.cpp
gavinandresen,2014-02-14T13:46:37Z,"Good catch, I made a mental note to myself last night to look into how ""tx"" records are ordered in the wallet. I think nOrderPos might give the ordering we want (metadata should always come from the transaction the wallet created, not the mutated one seen later).\n\nDoing the metadata copying while loading the wallet is important for clean recovery; I could bump the wallet version number and run i",https://github.com/bitcoin/bitcoin/pull/3671#discussion_r9748390,9748390,src/wallet.cpp
laanwj,2014-02-14T13:56:38Z,"Defining the one with the lowest orderpos as 'original clone' sounds like a sensible resolution. As we create the transactions in increasing orderpos, that will the one created by the client itself.\n\nEdit: agree on not bumping the wallet version for this. When we need to bump the wallet version for another reason  at some time in the future we can always move it to the upgrader there.\n",https://github.com/bitcoin/bitcoin/pull/3671#discussion_r9748609,9748609,src/wallet.cpp
gavinandresen,2014-02-14T14:26:58Z,@sipa: will do. I got stuck yesterday going down the rabbit-hole of COutPoints to possibly-not-a-wallet-transaction....\n,https://github.com/bitcoin/bitcoin/pull/3671#discussion_r9749351,9749351,src/wallet.h
sipa,2014-02-14T14:30:31Z,"To detect whether a transaction is viable, and possible conflicts, you can rely on the mempool (aka confirmations < 0). You only need the clone/double spend detection to copy metadata I think.\n",https://github.com/bitcoin/bitcoin/pull/3671#discussion_r9749450,9749450,src/wallet.h
