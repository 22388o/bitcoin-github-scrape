[
  {
    "sha": "83743ed6810cfe6a0c0c260fa2477dffbe05950c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4Mzc0M2VkNjgxMGNmZTZhMGMwYzI2MGZhMjQ3N2RmZmJlMDU5NTBj",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2012-04-17T21:03:24Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2012-04-25T22:31:54Z"
      },
      "message": "Make lsn_reset (\"detach databases\") optional and off by default.\n\nAdd an option -detachdb (and entry in OptionDialog), without which no\nlsn_reset is called on addr.dat and blkindex.dat. That means these\nfiles cannot be moved to a new environment, but shutdown can be\nsignificantly faster. The wallet file is always lsn_reset'ed.\n\n-detachdb corresponds to the old behaviour, though it is off by\ndefault now to speed up shutdowns.",
      "tree": {
        "sha": "2b151b9c1453fcdd0da74deb9431ec2db29e15a7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2b151b9c1453fcdd0da74deb9431ec2db29e15a7"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/83743ed6810cfe6a0c0c260fa2477dffbe05950c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/83743ed6810cfe6a0c0c260fa2477dffbe05950c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/83743ed6810cfe6a0c0c260fa2477dffbe05950c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/83743ed6810cfe6a0c0c260fa2477dffbe05950c/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c2e8c8acd8ae0c94c70b59f55169841ad195bb99",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c2e8c8acd8ae0c94c70b59f55169841ad195bb99",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c2e8c8acd8ae0c94c70b59f55169841ad195bb99"
      }
    ],
    "stats": {
      "total": 30,
      "additions": 27,
      "deletions": 3
    },
    "files": [
      {
        "sha": "12647e568aee5d0984dc6726ccd4b428f78871bf",
        "filename": "src/db.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 2,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/83743ed6810cfe6a0c0c260fa2477dffbe05950c/src/db.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/83743ed6810cfe6a0c0c260fa2477dffbe05950c/src/db.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/db.cpp?ref=83743ed6810cfe6a0c0c260fa2477dffbe05950c",
        "patch": "@@ -28,6 +28,7 @@ unsigned int nWalletDBUpdated;\n \n CCriticalSection cs_db;\n static bool fDbEnvInit = false;\n+bool fDetachDB = false;\n DbEnv dbenv(0);\n map<string, int> mapFileUseCount;\n static map<string, Db*> mapDb;\n@@ -307,9 +308,13 @@ void DBFlush(bool fShutdown)\n             {\n                 // Move log data to the dat file\n                 CloseDb(strFile);\n+                printf(\"%s checkpoint\\n\", strFile.c_str());\n                 dbenv.txn_checkpoint(0, 0, 0);\n-                printf(\"%s flush\\n\", strFile.c_str());\n-                dbenv.lsn_reset(strFile.c_str(), 0);\n+                if ((strFile != \"blkindex.dat\" && strFile != \"addr.dat\") || fDetachDB) {\n+                    printf(\"%s detach\\n\", strFile.c_str());\n+                    dbenv.lsn_reset(strFile.c_str(), 0);\n+                }\n+                printf(\"%s closed\\n\", strFile.c_str());\n                 mapFileUseCount.erase(mi++);\n             }\n             else"
      },
      {
        "sha": "3ce8f1758f25ff374877aeeae45cf69687a7622f",
        "filename": "src/db.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/83743ed6810cfe6a0c0c260fa2477dffbe05950c/src/db.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/83743ed6810cfe6a0c0c260fa2477dffbe05950c/src/db.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/db.h?ref=83743ed6810cfe6a0c0c260fa2477dffbe05950c",
        "patch": "@@ -25,6 +25,7 @@ class CWallet;\n class CWalletTx;\n \n extern unsigned int nWalletDBUpdated;\n+extern bool fDetachDB;\n extern DbEnv dbenv;\n \n extern void DBFlush(bool fShutdown);"
      },
      {
        "sha": "0671cd77993ed2b01daa3e1c32dedbf68eb6a2b8",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/83743ed6810cfe6a0c0c260fa2477dffbe05950c/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/83743ed6810cfe6a0c0c260fa2477dffbe05950c/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=83743ed6810cfe6a0c0c260fa2477dffbe05950c",
        "patch": "@@ -200,6 +200,7 @@ bool AppInit2(int argc, char* argv[])\n #else\n             \"  -upnp            \\t  \"   + _(\"Use Universal Plug and Play to map the listening port (default: 0)\") + \"\\n\" +\n #endif\n+            \"  -detachdb        \\t  \"   + _(\"Detach block and address databases. Increases shutdown time (default: 0)\") + \"\\n\" +\n #endif\n             \"  -paytxfee=<amt>  \\t  \"   + _(\"Fee per KB to add to transactions you send\") + \"\\n\" +\n #ifdef QT_GUI\n@@ -255,6 +256,7 @@ bool AppInit2(int argc, char* argv[])\n     }\n \n     fDebug = GetBoolArg(\"-debug\");\n+    fDetachDB = GetBoolArg(\"-detachdb\", false);\n \n #if !defined(WIN32) && !defined(QT_GUI)\n     fDaemon = GetBoolArg(\"-daemon\");"
      },
      {
        "sha": "59c44ac5f90a10e14cbd9a170eb87c6fb11166c9",
        "filename": "src/qt/optionsdialog.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/83743ed6810cfe6a0c0c260fa2477dffbe05950c/src/qt/optionsdialog.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/83743ed6810cfe6a0c0c260fa2477dffbe05950c/src/qt/optionsdialog.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/optionsdialog.cpp?ref=83743ed6810cfe6a0c0c260fa2477dffbe05950c",
        "patch": "@@ -38,6 +38,7 @@ class MainOptionsPage : public QWidget\n     QCheckBox *minimize_on_close;\n #endif\n     QCheckBox *connect_socks4;\n+    QCheckBox *detach_database;\n     QLineEdit *proxy_ip;\n     QLineEdit *proxy_port;\n     BitcoinAmountField *fee_edit;\n@@ -229,6 +230,10 @@ MainOptionsPage::MainOptionsPage(QWidget *parent):\n \n     layout->addLayout(fee_hbox);\n \n+    detach_database = new QCheckBox(tr(\"Detach databases at shutdown\"));\n+    detach_database->setToolTip(tr(\"Detach block and address databases at shutdown. This means they can be moved to another data directory, but it slows down shutdown. The wallet is always detached.\"));\n+    layout->addWidget(detach_database);\n+\n     layout->addStretch(1); // Extra space at bottom\n \n     setLayout(layout);\n@@ -256,6 +261,7 @@ void MainOptionsPage::setMapper(MonitoredDataMapper *mapper)\n     mapper->addMapping(proxy_ip, OptionsModel::ProxyIP);\n     mapper->addMapping(proxy_port, OptionsModel::ProxyPort);\n     mapper->addMapping(fee_edit, OptionsModel::Fee);\n+    mapper->addMapping(detach_database, OptionsModel::DetachDatabases);\n }\n \n DisplayOptionsPage::DisplayOptionsPage(QWidget *parent):"
      },
      {
        "sha": "5bba308cf2166ec2ccd0dd82777093badb15e413",
        "filename": "src/qt/optionsmodel.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 0,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/83743ed6810cfe6a0c0c260fa2477dffbe05950c/src/qt/optionsmodel.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/83743ed6810cfe6a0c0c260fa2477dffbe05950c/src/qt/optionsmodel.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/optionsmodel.cpp?ref=83743ed6810cfe6a0c0c260fa2477dffbe05950c",
        "patch": "@@ -28,6 +28,8 @@ void OptionsModel::Init()\n         SoftSetBoolArg(\"-upnp\", settings.value(\"fUseUPnP\").toBool());\n     if (settings.contains(\"addrProxy\") && settings.value(\"fUseProxy\").toBool())\n         SoftSetArg(\"-proxy\", settings.value(\"addrProxy\").toString().toStdString());\n+    if (settings.contains(\"detachDB\"))\n+        SoftSetBoolArg(\"-detachdb\", settings.value(\"detachDB\").toBool());\n }\n \n bool OptionsModel::Upgrade()\n@@ -121,6 +123,8 @@ QVariant OptionsModel::data(const QModelIndex & index, int role) const\n             return QVariant(nDisplayUnit);\n         case DisplayAddresses:\n             return QVariant(bDisplayAddresses);\n+        case DetachDatabases:\n+            return QVariant(fDetachDB);\n         default:\n             return QVariant();\n         }\n@@ -204,6 +208,11 @@ bool OptionsModel::setData(const QModelIndex & index, const QVariant & value, in\n             settings.setValue(\"bDisplayAddresses\", bDisplayAddresses);\n             }\n             break;\n+        case DetachDatabases: {\n+            fDetachDB = value.toBool();\n+            settings.setValue(\"detachDB\", fDetachDB);\n+            }\n+            break;\n         default:\n             break;\n         }"
      },
      {
        "sha": "da4e86f104017af97fa7e6108f04477bb69de49a",
        "filename": "src/qt/optionsmodel.h",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/83743ed6810cfe6a0c0c260fa2477dffbe05950c/src/qt/optionsmodel.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/83743ed6810cfe6a0c0c260fa2477dffbe05950c/src/qt/optionsmodel.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/optionsmodel.h?ref=83743ed6810cfe6a0c0c260fa2477dffbe05950c",
        "patch": "@@ -26,7 +26,8 @@ class OptionsModel : public QAbstractListModel\n         Fee, // qint64\n         DisplayUnit, // BitcoinUnits::Unit\n         DisplayAddresses, // bool\n-        OptionIDRowCount\n+        DetachDatabases, // bool\n+        OptionIDRowCount,\n     };\n \n     void Init();"
      }
    ]
  }
]