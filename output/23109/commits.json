[
  {
    "sha": "4feafe2c59608c9e600afb41b3a6e7b51b25fa2d",
    "node_id": "C_kwDOABII59oAKDRmZWFmZTJjNTk2MDhjOWU2MDBhZmI0MWIzYTZlN2I1MWIyNWZhMmQ",
    "commit": {
      "author": {
        "name": "Douglas Chimento",
        "email": "dchimento@gmail.com",
        "date": "2021-09-27T17:03:02Z"
      },
      "committer": {
        "name": "Douglas Chimento",
        "email": "dchimento@gmail.com",
        "date": "2021-09-27T18:24:37Z"
      },
      "message": "net: Bypass increasing nMaxOutboundTotalBytesSentInCycle for peers with download permission",
      "tree": {
        "sha": "1ea47c86b770c285edb4bf9185db95665dbf67d9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1ea47c86b770c285edb4bf9185db95665dbf67d9"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4feafe2c59608c9e600afb41b3a6e7b51b25fa2d",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCAAdFiEEFt7wA8cqIHRePmNa0a1maOubxakFAmFSDHUACgkQ0a1maOub\nxalobAv/VLtKVpaSOn1lL/XeiqQEbm+8Sr/Ozu1qwZTM0Q0x7sMUKpIHsVRZt7nt\naZTGefNq1UgyHcHy/omcihUmer3hfqeBWs9IS9+Lcs75YT2mYFjGSvGwzrgGrDTW\nGozno2/nVW459cWgzltIzoi0E3+ye0tkG22TK8QTdMrr7BukRlS3jWuS2hAtvBle\nbfcQszN5hNLSvnS4TUBs8INp6BwyKmycN4YcLySnR2wgS3luLJNyKrDOvSh71mLa\nsvjmhC/YtZ2+3Vzdla1hgiCbUQRXv1rV7yM1E9RtbrIQjy1k8tWwE5ccILQzohn1\nRcFR9K2i3RV5aOoS+Hnz5LGMFUeUSqi18AxeG2IZ+Hh+MLLKc2yPhnLihGzGEbLd\nyxfEHJF3vmoEeX0A3tfJQHMNydj2z4q+wHb65E10NNlOOzAcHRFUulyzpLeCanH/\nmhDIB4/5Ama/FEJQdR/oYjMWtiLT1Lzw32rRyo16GXsPf4XxuasZpD6jB1rYekqK\n6XZZ+JbL\n=Ngd8\n-----END PGP SIGNATURE-----",
        "payload": "tree 1ea47c86b770c285edb4bf9185db95665dbf67d9\nparent f036c35e51fea8cf2a0dc41c10c47e37fc01e999\nauthor Douglas Chimento <dchimento@gmail.com> 1632762182 +0300\ncommitter Douglas Chimento <dchimento@gmail.com> 1632767077 +0300\n\nnet: Bypass increasing nMaxOutboundTotalBytesSentInCycle for peers with download permission\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4feafe2c59608c9e600afb41b3a6e7b51b25fa2d",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/4feafe2c59608c9e600afb41b3a6e7b51b25fa2d",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4feafe2c59608c9e600afb41b3a6e7b51b25fa2d/comments",
    "author": {
      "login": "dougEfresh",
      "id": 976425,
      "node_id": "MDQ6VXNlcjk3NjQyNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/976425?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dougEfresh",
      "html_url": "https://github.com/dougEfresh",
      "followers_url": "https://api.github.com/users/dougEfresh/followers",
      "following_url": "https://api.github.com/users/dougEfresh/following{/other_user}",
      "gists_url": "https://api.github.com/users/dougEfresh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dougEfresh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dougEfresh/subscriptions",
      "organizations_url": "https://api.github.com/users/dougEfresh/orgs",
      "repos_url": "https://api.github.com/users/dougEfresh/repos",
      "events_url": "https://api.github.com/users/dougEfresh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dougEfresh/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "dougEfresh",
      "id": 976425,
      "node_id": "MDQ6VXNlcjk3NjQyNQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/976425?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dougEfresh",
      "html_url": "https://github.com/dougEfresh",
      "followers_url": "https://api.github.com/users/dougEfresh/followers",
      "following_url": "https://api.github.com/users/dougEfresh/following{/other_user}",
      "gists_url": "https://api.github.com/users/dougEfresh/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dougEfresh/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dougEfresh/subscriptions",
      "organizations_url": "https://api.github.com/users/dougEfresh/orgs",
      "repos_url": "https://api.github.com/users/dougEfresh/repos",
      "events_url": "https://api.github.com/users/dougEfresh/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dougEfresh/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f036c35e51fea8cf2a0dc41c10c47e37fc01e999",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f036c35e51fea8cf2a0dc41c10c47e37fc01e999",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f036c35e51fea8cf2a0dc41c10c47e37fc01e999"
      }
    ],
    "stats": {
      "total": 13,
      "additions": 7,
      "deletions": 6
    },
    "files": [
      {
        "sha": "f8872575f009008660f676fd03098a3ee26da6a6",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 5,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4feafe2c59608c9e600afb41b3a6e7b51b25fa2d/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4feafe2c59608c9e600afb41b3a6e7b51b25fa2d/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=4feafe2c59608c9e600afb41b3a6e7b51b25fa2d",
        "patch": "@@ -1601,7 +1601,7 @@ void CConnman::SocketHandler()\n         if (sendSet) {\n             // Send data\n             size_t bytes_sent = WITH_LOCK(pnode->cs_vSend, return SocketSendData(*pnode));\n-            if (bytes_sent) RecordBytesSent(bytes_sent);\n+            if (bytes_sent) RecordBytesSent(bytes_sent, !pnode->HasPermission(NetPermissionFlags::Download));\n         }\n \n         if (InactivityCheck(*pnode)) pnode->fDisconnect = true;\n@@ -2856,7 +2856,7 @@ void CConnman::RecordBytesRecv(uint64_t bytes)\n     nTotalBytesRecv += bytes;\n }\n \n-void CConnman::RecordBytesSent(uint64_t bytes)\n+void CConnman::RecordBytesSent(uint64_t bytes, bool increase_max_outbound)\n {\n     LOCK(cs_totalBytesSent);\n     nTotalBytesSent += bytes;\n@@ -2869,8 +2869,9 @@ void CConnman::RecordBytesSent(uint64_t bytes)\n         nMaxOutboundTotalBytesSentInCycle = 0;\n     }\n \n-    // TODO, exclude peers with download permission\n-    nMaxOutboundTotalBytesSentInCycle += bytes;\n+    if (increase_max_outbound) {\n+        nMaxOutboundTotalBytesSentInCycle += bytes;\n+    }\n }\n \n uint64_t CConnman::GetMaxOutboundTarget() const\n@@ -3026,7 +3027,7 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n         // If write queue empty, attempt \"optimistic write\"\n         if (optimisticSend) nBytesSent = SocketSendData(*pnode);\n     }\n-    if (nBytesSent) RecordBytesSent(nBytesSent);\n+    if (nBytesSent) RecordBytesSent(nBytesSent, !pnode->HasPermission(NetPermissionFlags::Download));\n }\n \n bool CConnman::ForNode(NodeId id, std::function<bool(CNode* pnode)> func)"
      },
      {
        "sha": "75a3753133a3698d0364845f9d69dfaebeeb2add",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4feafe2c59608c9e600afb41b3a6e7b51b25fa2d/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4feafe2c59608c9e600afb41b3a6e7b51b25fa2d/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=4feafe2c59608c9e600afb41b3a6e7b51b25fa2d",
        "patch": "@@ -1015,7 +1015,7 @@ class CConnman\n \n     // Network stats\n     void RecordBytesRecv(uint64_t bytes);\n-    void RecordBytesSent(uint64_t bytes);\n+    void RecordBytesSent(uint64_t bytes, bool increase_max_outbound);\n \n     /**\n      * Return vector of current BLOCK_RELAY peers."
      }
    ]
  }
]