[
  {
    "sha": "e029ae11eaafca0fa8cd7907dbbb02e8f38febf1",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplMDI5YWUxMWVhYWZjYTBmYThjZDc5MDdkYmJiMDJlOGYzOGZlYmYx",
    "commit": {
      "author": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-09-04T18:27:02Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2021-08-29T22:54:56Z"
      },
      "message": "Flush dbcache early if system is under memory pressure\n\nNo point forcing memory to get pushed out to swap just to cache db changes when we can write the db changes out instead",
      "tree": {
        "sha": "2c18e493aa01dcb0b4d528229b6521be3c480710",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2c18e493aa01dcb0b4d528229b6521be3c480710"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1/comments",
    "author": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "42af9596ce85a541988abee54eed8a9b271a46a1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/42af9596ce85a541988abee54eed8a9b271a46a1",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/42af9596ce85a541988abee54eed8a9b271a46a1"
      }
    ],
    "stats": {
      "total": 58,
      "additions": 56,
      "deletions": 2
    },
    "files": [
      {
        "sha": "7e69c9dcf2742df5b3f0b4c86bd18eca35bba809",
        "filename": "configure.ac",
        "status": "modified",
        "additions": 15,
        "deletions": 0,
        "changes": 15,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1/configure.ac",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1/configure.ac",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/configure.ac?ref=e029ae11eaafca0fa8cd7907dbbb02e8f38febf1",
        "patch": "@@ -984,6 +984,21 @@ AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[#include <malloc.h>]],\n  [ AC_MSG_RESULT(no)]\n )\n \n+AC_MSG_CHECKING(for compatible sysinfo call)\n+AC_COMPILE_IFELSE([AC_LANG_PROGRAM([[#include <sys/sysinfo.h>]],\n+ [[\n+  struct sysinfo info;\n+  int rv = sysinfo(&info);\n+  unsigned long test = info.freeram + info.bufferram + info.mem_unit;\n+ ]])],\n+ [\n+  AC_MSG_RESULT(yes);\n+  AC_DEFINE(HAVE_LINUX_SYSINFO, 1, [Define this symbol if you have a Linux-compatible sysinfo call])\n+ ],[\n+  AC_MSG_RESULT(no)\n+ ]\n+)\n+\n dnl Check for posix_fallocate\n AC_MSG_CHECKING(for posix_fallocate)\n AC_COMPILE_IFELSE([AC_LANG_PROGRAM([["
      },
      {
        "sha": "472a84dbd643cd16a3dd7339675d0516e70c01f3",
        "filename": "src/util/system.cpp",
        "status": "modified",
        "additions": 30,
        "deletions": 0,
        "changes": 30,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1/src/util/system.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1/src/util/system.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/system.cpp?ref=e029ae11eaafca0fa8cd7907dbbb02e8f38febf1",
        "patch": "@@ -70,6 +70,10 @@\n #include <malloc.h>\n #endif\n \n+#ifdef HAVE_LINUX_SYSINFO\n+#include <sys/sysinfo.h>\n+#endif\n+\n #include <boost/algorithm/string/replace.hpp>\n #include <thread>\n #include <typeinfo>\n@@ -1403,4 +1407,30 @@ std::pair<int, char**> WinCmdLineArgs::get()\n     return std::make_pair(argc, argv);\n }\n #endif\n+\n+bool SystemNeedsMemoryReleased()\n+{\n+    constexpr size_t low_memory_threshold = 10 * 1024 * 1024 /* 10 MB */;\n+#ifdef WIN32\n+    MEMORYSTATUSEX mem_status;\n+    mem_status.dwLength = sizeof(mem_status);\n+    if (GlobalMemoryStatusEx(&mem_status)) {\n+        if (mem_status.dwMemoryLoad >= 99) return true;\n+        if (mem_status.ullAvailPhys < low_memory_threshold) return true;\n+        if (mem_status.ullAvailVirtual < low_memory_threshold) return true;\n+    }\n+#endif\n+#ifdef HAVE_LINUX_SYSINFO\n+    struct sysinfo sys_info;\n+    if (!sysinfo(&sys_info)) {\n+        // Explicitly 64-bit in case of 32-bit userspace on 64-bit kernel\n+        const uint64_t free_ram = uint64_t(sys_info.freeram) * sys_info.mem_unit;\n+        const uint64_t buffer_ram = uint64_t(sys_info.bufferram) * sys_info.mem_unit;\n+        if (free_ram + buffer_ram < low_memory_threshold) return true;\n+    }\n+#endif\n+    // NOTE: sysconf(_SC_AVPHYS_PAGES) doesn't account for caches on at least Linux, so not safe to use here\n+    return false;\n+}\n+\n } // namespace util"
      },
      {
        "sha": "cc1658a3bdc03def473cfb6979d5bdcfb0881d8d",
        "filename": "src/util/system.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1/src/util/system.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1/src/util/system.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/system.h?ref=e029ae11eaafca0fa8cd7907dbbb02e8f38febf1",
        "patch": "@@ -538,6 +538,8 @@ class WinCmdLineArgs\n };\n #endif\n \n+bool SystemNeedsMemoryReleased();\n+\n } // namespace util\n \n #endif // BITCOIN_UTIL_SYSTEM_H"
      },
      {
        "sha": "94069585d1449209a078c42185a7b55225d65d12",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 2,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=e029ae11eaafca0fa8cd7907dbbb02e8f38febf1",
        "patch": "@@ -2090,8 +2090,15 @@ bool CChainState::FlushStateToDisk(\n         }\n         // The cache is large and we're within 10% and 10 MiB of the limit, but we have time now (not in the middle of a block processing).\n         bool fCacheLarge = mode == FlushStateMode::PERIODIC && cache_state >= CoinsCacheSizeState::LARGE;\n-        // The cache is over the limit, we have to write now.\n-        bool fCacheCritical = mode == FlushStateMode::IF_NEEDED && cache_state >= CoinsCacheSizeState::CRITICAL;\n+        bool fCacheCritical = false;\n+        if (mode == FlushStateMode::IF_NEEDED) {\n+            if (cache_state >= CoinsCacheSizeState::CRITICAL) {\n+                // The cache is over the limit, we have to write now.\n+                fCacheCritical = true;\n+            } else if (util::SystemNeedsMemoryReleased()) {\n+                fCacheCritical = true;\n+            }\n+        }\n         // It's been a while since we wrote the block index to disk. Do this frequently, so we don't need to redownload after a crash.\n         bool fPeriodicWrite = mode == FlushStateMode::PERIODIC && nNow > nLastWrite + DATABASE_WRITE_INTERVAL;\n         // It's been very long since we flushed the cache. Do this infrequently, to optimize cache usage."
      }
    ]
  },
  {
    "sha": "bb29aa9f0627e23be1a9ca6f88a0cbf2bd26e443",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiYjI5YWE5ZjA2MjdlMjNiZTFhOWNhNmY4OGEwY2JmMmJkMjZlNDQz",
    "commit": {
      "author": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-10-24T14:16:00Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2021-08-29T22:54:56Z"
      },
      "message": "util: Log reasoning when returning true from SystemNeedsMemoryReleased",
      "tree": {
        "sha": "3be710bcb0802e1c01a1680c9782087dfd3101b6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3be710bcb0802e1c01a1680c9782087dfd3101b6"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bb29aa9f0627e23be1a9ca6f88a0cbf2bd26e443",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bb29aa9f0627e23be1a9ca6f88a0cbf2bd26e443",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/bb29aa9f0627e23be1a9ca6f88a0cbf2bd26e443",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bb29aa9f0627e23be1a9ca6f88a0cbf2bd26e443/comments",
    "author": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e029ae11eaafca0fa8cd7907dbbb02e8f38febf1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e029ae11eaafca0fa8cd7907dbbb02e8f38febf1"
      }
    ],
    "stats": {
      "total": 14,
      "additions": 10,
      "deletions": 4
    },
    "files": [
      {
        "sha": "946a23b9c2507adb3f6aa86d2f7e5b92b72f0fb2",
        "filename": "src/util/system.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 4,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/bb29aa9f0627e23be1a9ca6f88a0cbf2bd26e443/src/util/system.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/bb29aa9f0627e23be1a9ca6f88a0cbf2bd26e443/src/util/system.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/system.cpp?ref=bb29aa9f0627e23be1a9ca6f88a0cbf2bd26e443",
        "patch": "@@ -1415,9 +1415,12 @@ bool SystemNeedsMemoryReleased()\n     MEMORYSTATUSEX mem_status;\n     mem_status.dwLength = sizeof(mem_status);\n     if (GlobalMemoryStatusEx(&mem_status)) {\n-        if (mem_status.dwMemoryLoad >= 99) return true;\n-        if (mem_status.ullAvailPhys < low_memory_threshold) return true;\n-        if (mem_status.ullAvailVirtual < low_memory_threshold) return true;\n+        if (mem_status.dwMemoryLoad >= 99 ||\n+            mem_status.ullAvailPhys < low_memory_threshold ||\n+            mem_status.ullAvailVirtual < low_memory_threshold) {\n+            LogPrintf(\"%s: YES: %s%% memory load; %s available physical memory; %s available virtual memory\\n\", __func__, int(mem_status.dwMemoryLoad), size_t(mem_status.ullAvailPhys), size_t(mem_status.ullAvailVirtual));\n+            return true;\n+        }\n     }\n #endif\n #ifdef HAVE_LINUX_SYSINFO\n@@ -1426,7 +1429,10 @@ bool SystemNeedsMemoryReleased()\n         // Explicitly 64-bit in case of 32-bit userspace on 64-bit kernel\n         const uint64_t free_ram = uint64_t(sys_info.freeram) * sys_info.mem_unit;\n         const uint64_t buffer_ram = uint64_t(sys_info.bufferram) * sys_info.mem_unit;\n-        if (free_ram + buffer_ram < low_memory_threshold) return true;\n+        if (free_ram + buffer_ram < low_memory_threshold) {\n+            LogPrintf(\"%s: YES: %s free RAM + %s buffer RAM\\n\", __func__, free_ram, buffer_ram);\n+            return true;\n+        }\n     }\n #endif\n     // NOTE: sysconf(_SC_AVPHYS_PAGES) doesn't account for caches on at least Linux, so not safe to use here"
      }
    ]
  },
  {
    "sha": "141a05afe44cd62be6e07dd3f87c55fbc531c7e9",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxNDFhMDVhZmU0NGNkNjJiZTZlMDdkZDNmODdjNTVmYmM1MzFjN2U5",
    "commit": {
      "author": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-10-24T14:43:26Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2021-08-29T22:54:56Z"
      },
      "message": "Make lowmem threshold configurable",
      "tree": {
        "sha": "6917f0a5842386d54fab2e627ee15b1cf21ed2b4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6917f0a5842386d54fab2e627ee15b1cf21ed2b4"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/141a05afe44cd62be6e07dd3f87c55fbc531c7e9",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/141a05afe44cd62be6e07dd3f87c55fbc531c7e9",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/141a05afe44cd62be6e07dd3f87c55fbc531c7e9",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/141a05afe44cd62be6e07dd3f87c55fbc531c7e9/comments",
    "author": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "bb29aa9f0627e23be1a9ca6f88a0cbf2bd26e443",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bb29aa9f0627e23be1a9ca6f88a0cbf2bd26e443",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/bb29aa9f0627e23be1a9ca6f88a0cbf2bd26e443"
      }
    ],
    "stats": {
      "total": 23,
      "additions": 19,
      "deletions": 4
    },
    "files": [
      {
        "sha": "f2c2bfb983104dae8cfdb61fe5f111f0102fe344",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 0,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/141a05afe44cd62be6e07dd3f87c55fbc531c7e9/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/141a05afe44cd62be6e07dd3f87c55fbc531c7e9/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=141a05afe44cd62be6e07dd3f87c55fbc531c7e9",
        "patch": "@@ -389,6 +389,7 @@ void SetupServerArgs(ArgsManager& argsman)\n     argsman.AddArg(\"-dbcache=<n>\", strprintf(\"Maximum database cache size <n> MiB (%d to %d, default: %d). In addition, unused mempool memory is shared for this cache (see -maxmempool).\", nMinDbCache, nMaxDbCache, nDefaultDbCache), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-includeconf=<file>\", \"Specify additional configuration file, relative to the -datadir path (only useable from configuration file, not command line)\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-loadblock=<file>\", \"Imports blocks from external file on startup\", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-lowmem=<n>\", strprintf(\"If system available memory falls below <n> MiB, flush caches (0 to disable, default: %s)\", util::g_low_memory_threshold / 1024 / 1024), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-maxmempool=<n>\", strprintf(\"Keep the transaction memory pool below <n> megabytes (default: %u)\", DEFAULT_MAX_MEMPOOL_SIZE), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-maxorphantx=<n>\", strprintf(\"Keep at most <n> unconnectable transactions in memory (default: %u)\", DEFAULT_MAX_ORPHAN_TRANSACTIONS), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-mempoolexpiry=<n>\", strprintf(\"Do not keep transactions in the mempool longer than <n> hours (default: %u)\", DEFAULT_MEMPOOL_EXPIRY), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n@@ -1335,6 +1336,13 @@ bool AppInitMain(NodeContext& node, interfaces::BlockAndHeaderTipInfo* tip_info)\n     LogPrintf(\"* Using %.1f MiB for chain state database\\n\", nCoinDBCache * (1.0 / 1024 / 1024));\n     LogPrintf(\"* Using %.1f MiB for in-memory UTXO set (plus up to %.1f MiB of unused mempool space)\\n\", nCoinCacheUsage * (1.0 / 1024 / 1024), nMempoolSizeMax * (1.0 / 1024 / 1024));\n \n+    if (gArgs.IsArgSet(\"-lowmem\")) {\n+        util::g_low_memory_threshold = gArgs.GetArg(\"-lowmem\", 0 /* not used */) * 1024 * 1024;\n+    }\n+    if (util::g_low_memory_threshold > 0) {\n+        LogPrintf(\"* Flushing caches if available system memory drops below %s MiB\\n\", util::g_low_memory_threshold / 1024 / 1024);\n+    }\n+\n     bool fLoaded = false;\n     while (!fLoaded && !ShutdownRequested()) {\n         const bool fReset = fReindex;"
      },
      {
        "sha": "e5033ca03723c62d52b8975aaa02bc9fef5dd6da",
        "filename": "src/util/system.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 4,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/141a05afe44cd62be6e07dd3f87c55fbc531c7e9/src/util/system.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/141a05afe44cd62be6e07dd3f87c55fbc531c7e9/src/util/system.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/system.cpp?ref=141a05afe44cd62be6e07dd3f87c55fbc531c7e9",
        "patch": "@@ -1408,16 +1408,21 @@ std::pair<int, char**> WinCmdLineArgs::get()\n }\n #endif\n \n+size_t g_low_memory_threshold = 10 * 1024 * 1024 /* 10 MB */;\n+\n bool SystemNeedsMemoryReleased()\n {\n-    constexpr size_t low_memory_threshold = 10 * 1024 * 1024 /* 10 MB */;\n+    if (g_low_memory_threshold <= 0) {\n+        // Intentionally bypass other metrics when disabled entirely\n+        return false;\n+    }\n #ifdef WIN32\n     MEMORYSTATUSEX mem_status;\n     mem_status.dwLength = sizeof(mem_status);\n     if (GlobalMemoryStatusEx(&mem_status)) {\n         if (mem_status.dwMemoryLoad >= 99 ||\n-            mem_status.ullAvailPhys < low_memory_threshold ||\n-            mem_status.ullAvailVirtual < low_memory_threshold) {\n+            mem_status.ullAvailPhys < g_low_memory_threshold ||\n+            mem_status.ullAvailVirtual < g_low_memory_threshold) {\n             LogPrintf(\"%s: YES: %s%% memory load; %s available physical memory; %s available virtual memory\\n\", __func__, int(mem_status.dwMemoryLoad), size_t(mem_status.ullAvailPhys), size_t(mem_status.ullAvailVirtual));\n             return true;\n         }\n@@ -1429,7 +1434,7 @@ bool SystemNeedsMemoryReleased()\n         // Explicitly 64-bit in case of 32-bit userspace on 64-bit kernel\n         const uint64_t free_ram = uint64_t(sys_info.freeram) * sys_info.mem_unit;\n         const uint64_t buffer_ram = uint64_t(sys_info.bufferram) * sys_info.mem_unit;\n-        if (free_ram + buffer_ram < low_memory_threshold) {\n+        if (free_ram + buffer_ram < g_low_memory_threshold) {\n             LogPrintf(\"%s: YES: %s free RAM + %s buffer RAM\\n\", __func__, free_ram, buffer_ram);\n             return true;\n         }"
      },
      {
        "sha": "636a55df5ae3fad0f944a11d4923ab4384d4662c",
        "filename": "src/util/system.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/141a05afe44cd62be6e07dd3f87c55fbc531c7e9/src/util/system.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/141a05afe44cd62be6e07dd3f87c55fbc531c7e9/src/util/system.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/system.h?ref=141a05afe44cd62be6e07dd3f87c55fbc531c7e9",
        "patch": "@@ -538,6 +538,8 @@ class WinCmdLineArgs\n };\n #endif\n \n+extern size_t g_low_memory_threshold;\n+\n bool SystemNeedsMemoryReleased();\n \n } // namespace util"
      }
    ]
  },
  {
    "sha": "b9da34cec33951c89e25f95b0449e59507da1baf",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiOWRhMzRjZWMzMzk1MWM4OWUyNWY5NWIwNDQ5ZTU5NTA3ZGExYmFm",
    "commit": {
      "author": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-10-24T14:43:51Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2021-08-29T22:55:34Z"
      },
      "message": "Disable lowmem flushing in test that needs determinism",
      "tree": {
        "sha": "677c64980e0ff0dbec4974685c383f2eb9029828",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/677c64980e0ff0dbec4974685c383f2eb9029828"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b9da34cec33951c89e25f95b0449e59507da1baf",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b9da34cec33951c89e25f95b0449e59507da1baf",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b9da34cec33951c89e25f95b0449e59507da1baf",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b9da34cec33951c89e25f95b0449e59507da1baf/comments",
    "author": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "141a05afe44cd62be6e07dd3f87c55fbc531c7e9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/141a05afe44cd62be6e07dd3f87c55fbc531c7e9",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/141a05afe44cd62be6e07dd3f87c55fbc531c7e9"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 5,
      "deletions": 0
    },
    "files": [
      {
        "sha": "fdaf6d1b50b0f143c451c6922673e8b27a80bacc",
        "filename": "src/test/validation_chainstate_tests.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b9da34cec33951c89e25f95b0449e59507da1baf/src/test/validation_chainstate_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b9da34cec33951c89e25f95b0449e59507da1baf/src/test/validation_chainstate_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/validation_chainstate_tests.cpp?ref=b9da34cec33951c89e25f95b0449e59507da1baf",
        "patch": "@@ -22,6 +22,8 @@ BOOST_AUTO_TEST_CASE(validation_chainstate_resize_caches)\n     ChainstateManager manager;\n     CTxMemPool mempool;\n \n+    util::g_low_memory_threshold = 0;  // disable to get deterministic flushing\n+\n     //! Create and add a Coin with DynamicMemoryUsage of 80 bytes to the given view.\n     auto add_coin = [](CCoinsViewCache& coins_view) -> COutPoint {\n         Coin newcoin;"
      },
      {
        "sha": "c8f2312bf38d261cee49f22579ad4b0b1a6c45ae",
        "filename": "src/wallet/test/wallet_tests.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b9da34cec33951c89e25f95b0449e59507da1baf/src/wallet/test/wallet_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b9da34cec33951c89e25f95b0449e59507da1baf/src/wallet/test/wallet_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/test/wallet_tests.cpp?ref=b9da34cec33951c89e25f95b0449e59507da1baf",
        "patch": "@@ -689,6 +689,9 @@ BOOST_FIXTURE_TEST_CASE(wallet_descriptor_test, BasicTestingSetup)\n //! rescanning where new transactions in new blocks could be lost.\n BOOST_FIXTURE_TEST_CASE(CreateWallet, TestChain100Setup)\n {\n+    // FIXME: this test fails for some reason if there's a flush\n+    util::g_low_memory_threshold = 0;\n+\n     gArgs.ForceSetArg(\"-unsafesqlitesync\", \"1\");\n     // Create new wallet with known key and unload it.\n     auto wallet = TestLoadWallet(m_node.chain.get());"
      }
    ]
  }
]