laanwj,2012-05-05T08:03:06Z,"Nice.\n\nSuggestion: when an error occurs while reading the address file, log it but don't escalate it. A corrupted file can easily be rebuilt, after all (and would remove one source of fatal startup errors).\n",https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5525282,5525282,
sipa,2012-05-05T11:36:18Z,"I'd prefer addrman.{cpp,h} to be very self-contained and only have knowledge about the data structure and serialization, not how it's stored and certainly not where. The reason is that this may be useful to other projects (e.g. dns seeds) that don't have the same uti.h (addrman only depends on it because of the locking primitives).\n\nAlso, the IP address table is not critical, so incomplete write",https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5526380,5526380,
jgarzik,2012-05-05T20:45:10Z,"1) Yes, error diagnostic -- particularly for a corrupted or truncated file -- should be expanded, made more verbose.\n\n2) Yes, the code should do something like write to temp file, then rename.  I have said as much on IRC several times.  Windows apparently uses ReplaceFile(), while Unix uses rename().\n\n3) I/O implemented inside CAddrMan was intentionally remaining consistent with CBlock::Read/W",https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5530368,5530368,
sipa,2012-05-05T22:23:25Z,"2) Or boost::filesystem::rename() ?\n3) Ok, that's just a minor design issue; it can always be changed later on in several places to do it in a consistent way.\n",https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5531016,5531016,
jgarzik,2012-05-06T00:07:14Z,"Googling for ""boost filesystem rename atomic"" seems to indicate that overwrite-via-rename is explicitly forbidden in the boost code.  See e.g., http://lists.boost.org/boost-users/2008/01/33451.php\n\nWould be happy to use boost if possible, but I think we will be forced to #ifdef WINDOWS { ReplaceFile() }\n",https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5531569,5531569,
sipa,2012-05-06T00:27:14Z,The first answer here is helpful: http://stackoverflow.com/questions/3156841/boostfilesystemrename-cannot-create-a-file-when-that-file-already-exists\n\nSeems that in boost::filesystem v3 the behaviour is correct. The problem is that we still support v2...\n,https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5531658,5531658,
luke-jr,2012-05-06T18:22:17Z,"First run with this pullreq included, I get ""Error loading ipaddr.dat"" and quit. How can I start it for the first time? :)\n\nEdit: Confirmed ipaddr.dat doesn't exist yet.\n",https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5537982,5537982,
laanwj,2012-05-06T18:34:18Z,"Now, that's what I meant with not escalating the error...\n",https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5538096,5538096,
luke-jr,2012-05-06T19:15:54Z,Should ipaddr.dat (451 KB) be much larger than addr.dat (7.3 KB)?\n,https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5539860,5539860,
jgarzik,2012-05-07T05:47:29Z,"Added fix: do not die, if ipaddr.dat is missing\n",https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5544289,5544289,
jgarzik,2012-05-12T05:21:42Z,"OK, ipaddr.dat is now renamed into place.  All concerns have been addressed in the latest rebase.\n\nAdditional comments?\n",https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5665388,5665388,
sipa,2012-05-12T16:30:12Z,operator<< can fail and throw an exception if the file is not in the correct format (or there's a bug). I think you'll need a try catch in/around addrman.ReadFromDisk.\n,https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5669758,5669758,
jgarzik,2012-05-13T05:10:12Z,"Added a new commit, re-creating CAddrDB.\n",https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5674051,5674051,
sipa,2012-05-16T15:25:32Z,ACK\n,https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5743658,5743658,
jgarzik,2012-05-16T19:47:30Z,"Added commits:\n1. rename to ""peers.dat"", the consensus on IRC\n2. add file header, which includes a magic number (pchMessageStart) and sha256 checksum\n",https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5750053,5750053,
jgarzik,2012-05-16T23:30:19Z,"Rebased, and fixed one final nasty bug.\n",https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5754849,5754849,
jgarzik,2012-05-17T02:13:41Z,Collapsed multiple commits into two.  A couple minor cleanups.\n,https://github.com/bitcoin/bitcoin/pull/1198#issuecomment-5756821,5756821,
sipa,2012-05-13T13:36:14Z,"Without catch block, won't the exception just get thrown further?\n",https://github.com/bitcoin/bitcoin/pull/1198#discussion_r813363,813363,src/db.cpp
jgarzik,2012-05-13T18:51:46Z,I don't understand your question.  The 'catch' statement immediately follows 'try'; scroll down a bit in the diff.\n,https://github.com/bitcoin/bitcoin/pull/1198#discussion_r813659,813659,src/db.cpp
sipa,2012-05-13T18:55:27Z,"Apologies, I misread the diff. Ignore my comment.\n",https://github.com/bitcoin/bitcoin/pull/1198#discussion_r813661,813661,src/db.cpp
