[
  {
    "sha": "29905c092f15bbbc4d4964c2f99dcf12fefd4111",
    "node_id": "C_kwDOABII59oAKDI5OTA1YzA5MmYxNWJiYmM0ZDQ5NjRjMmY5OWRjZjEyZmVmZDQxMTE",
    "commit": {
      "author": {
        "name": "Sebastian Falbesoner",
        "email": "sebastian.falbesoner@gmail.com",
        "date": "2021-08-26T12:39:46Z"
      },
      "committer": {
        "name": "Sebastian Falbesoner",
        "email": "sebastian.falbesoner@gmail.com",
        "date": "2021-11-10T16:12:41Z"
      },
      "message": "refactor: avoid multiple key->metadata lookups in dumpwallet RPC\n\nThis also enables working with a const ScriptPubKeyMan which was\npreviously not possible due to std::map::operator[] not being const.",
      "tree": {
        "sha": "60548598c12b4923fedd433f141985256c25ecd1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/60548598c12b4923fedd433f141985256c25ecd1"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/29905c092f15bbbc4d4964c2f99dcf12fefd4111",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/29905c092f15bbbc4d4964c2f99dcf12fefd4111",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/29905c092f15bbbc4d4964c2f99dcf12fefd4111",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/29905c092f15bbbc4d4964c2f99dcf12fefd4111/comments",
    "author": {
      "login": "theStack",
      "id": 91535,
      "node_id": "MDQ6VXNlcjkxNTM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theStack",
      "html_url": "https://github.com/theStack",
      "followers_url": "https://api.github.com/users/theStack/followers",
      "following_url": "https://api.github.com/users/theStack/following{/other_user}",
      "gists_url": "https://api.github.com/users/theStack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theStack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
      "organizations_url": "https://api.github.com/users/theStack/orgs",
      "repos_url": "https://api.github.com/users/theStack/repos",
      "events_url": "https://api.github.com/users/theStack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theStack/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "theStack",
      "id": 91535,
      "node_id": "MDQ6VXNlcjkxNTM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theStack",
      "html_url": "https://github.com/theStack",
      "followers_url": "https://api.github.com/users/theStack/followers",
      "following_url": "https://api.github.com/users/theStack/following{/other_user}",
      "gists_url": "https://api.github.com/users/theStack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theStack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
      "organizations_url": "https://api.github.com/users/theStack/orgs",
      "repos_url": "https://api.github.com/users/theStack/repos",
      "events_url": "https://api.github.com/users/theStack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theStack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "38b2a0a3f933fef167274851acaad0fd9104302a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/38b2a0a3f933fef167274851acaad0fd9104302a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/38b2a0a3f933fef167274851acaad0fd9104302a"
      }
    ],
    "stats": {
      "total": 7,
      "additions": 5,
      "deletions": 2
    },
    "files": [
      {
        "sha": "ccfb50c37cffeda4c01b67fba7e676c9a4e8fdba",
        "filename": "src/wallet/rpcdump.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 2,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/29905c092f15bbbc4d4964c2f99dcf12fefd4111/src/wallet/rpcdump.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/29905c092f15bbbc4d4964c2f99dcf12fefd4111/src/wallet/rpcdump.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcdump.cpp?ref=29905c092f15bbbc4d4964c2f99dcf12fefd4111",
        "patch": "@@ -809,19 +809,22 @@ RPCHelpMan dumpwallet()\n         std::string strLabel;\n         CKey key;\n         if (spk_man.GetKey(keyid, key)) {\n+            CKeyMetadata metadata;\n+            const auto it{spk_man.mapKeyMetadata.find(keyid)};\n+            if (it != spk_man.mapKeyMetadata.end()) metadata = it->second;\n             file << strprintf(\"%s %s \", EncodeSecret(key), strTime);\n             if (GetWalletAddressesForKey(&spk_man, wallet, keyid, strAddr, strLabel)) {\n                 file << strprintf(\"label=%s\", strLabel);\n             } else if (keyid == seed_id) {\n                 file << \"hdseed=1\";\n             } else if (mapKeyPool.count(keyid)) {\n                 file << \"reserve=1\";\n-            } else if (spk_man.mapKeyMetadata[keyid].hdKeypath == \"s\") {\n+            } else if (metadata.hdKeypath == \"s\") {\n                 file << \"inactivehdseed=1\";\n             } else {\n                 file << \"change=1\";\n             }\n-            file << strprintf(\" # addr=%s%s\\n\", strAddr, (spk_man.mapKeyMetadata[keyid].has_key_origin ? \" hdkeypath=\"+WriteHDKeypath(spk_man.mapKeyMetadata[keyid].key_origin.path) : \"\"));\n+            file << strprintf(\" # addr=%s%s\\n\", strAddr, (metadata.has_key_origin ? \" hdkeypath=\"+WriteHDKeypath(metadata.key_origin.path) : \"\"));\n         }\n     }\n     file << \"\\n\";"
      }
    ]
  },
  {
    "sha": "ec2792d1dc3404d749a43556eeb4b63780ee6d94",
    "node_id": "C_kwDOABII59oAKGVjMjc5MmQxZGMzNDA0ZDc0OWE0MzU1NmVlYjRiNjM3ODBlZTZkOTQ",
    "commit": {
      "author": {
        "name": "Sebastian Falbesoner",
        "email": "sebastian.falbesoner@gmail.com",
        "date": "2021-08-26T13:11:17Z"
      },
      "committer": {
        "name": "Sebastian Falbesoner",
        "email": "sebastian.falbesoner@gmail.com",
        "date": "2021-11-10T16:12:41Z"
      },
      "message": "refactor: use const `LegacyScriptPubKeyMan` references in dump{privkey,wallet} RPCs",
      "tree": {
        "sha": "b89403af31bd5067636f7ea9c55c32b407293dec",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b89403af31bd5067636f7ea9c55c32b407293dec"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ec2792d1dc3404d749a43556eeb4b63780ee6d94",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ec2792d1dc3404d749a43556eeb4b63780ee6d94",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ec2792d1dc3404d749a43556eeb4b63780ee6d94",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ec2792d1dc3404d749a43556eeb4b63780ee6d94/comments",
    "author": {
      "login": "theStack",
      "id": 91535,
      "node_id": "MDQ6VXNlcjkxNTM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theStack",
      "html_url": "https://github.com/theStack",
      "followers_url": "https://api.github.com/users/theStack/followers",
      "following_url": "https://api.github.com/users/theStack/following{/other_user}",
      "gists_url": "https://api.github.com/users/theStack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theStack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
      "organizations_url": "https://api.github.com/users/theStack/orgs",
      "repos_url": "https://api.github.com/users/theStack/repos",
      "events_url": "https://api.github.com/users/theStack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theStack/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "theStack",
      "id": 91535,
      "node_id": "MDQ6VXNlcjkxNTM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theStack",
      "html_url": "https://github.com/theStack",
      "followers_url": "https://api.github.com/users/theStack/followers",
      "following_url": "https://api.github.com/users/theStack/following{/other_user}",
      "gists_url": "https://api.github.com/users/theStack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theStack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
      "organizations_url": "https://api.github.com/users/theStack/orgs",
      "repos_url": "https://api.github.com/users/theStack/repos",
      "events_url": "https://api.github.com/users/theStack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theStack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "29905c092f15bbbc4d4964c2f99dcf12fefd4111",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/29905c092f15bbbc4d4964c2f99dcf12fefd4111",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/29905c092f15bbbc4d4964c2f99dcf12fefd4111"
      }
    ],
    "stats": {
      "total": 16,
      "additions": 13,
      "deletions": 3
    },
    "files": [
      {
        "sha": "2854e52f84a47ee8f53d6673e8f80de3d887ab6b",
        "filename": "src/wallet/rpcdump.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ec2792d1dc3404d749a43556eeb4b63780ee6d94/src/wallet/rpcdump.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ec2792d1dc3404d749a43556eeb4b63780ee6d94/src/wallet/rpcdump.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcdump.cpp?ref=ec2792d1dc3404d749a43556eeb4b63780ee6d94",
        "patch": "@@ -57,7 +57,7 @@ static std::string DecodeDumpString(const std::string &str) {\n     return ret.str();\n }\n \n-static bool GetWalletAddressesForKey(LegacyScriptPubKeyMan* spk_man, const CWallet& wallet, const CKeyID& keyid, std::string& strAddr, std::string& strLabel) EXCLUSIVE_LOCKS_REQUIRED(wallet.cs_wallet)\n+static bool GetWalletAddressesForKey(const LegacyScriptPubKeyMan* spk_man, const CWallet& wallet, const CKeyID& keyid, std::string& strAddr, std::string& strLabel) EXCLUSIVE_LOCKS_REQUIRED(wallet.cs_wallet)\n {\n     bool fLabelFound = false;\n     CKey key;\n@@ -684,7 +684,7 @@ RPCHelpMan dumpprivkey()\n     std::shared_ptr<CWallet> const pwallet = GetWalletForJSONRPCRequest(request);\n     if (!pwallet) return NullUniValue;\n \n-    LegacyScriptPubKeyMan& spk_man = EnsureLegacyScriptPubKeyMan(*pwallet);\n+    const LegacyScriptPubKeyMan& spk_man = EnsureConstLegacyScriptPubKeyMan(*pwallet);\n \n     LOCK2(pwallet->cs_wallet, spk_man.cs_KeyStore);\n \n@@ -735,7 +735,7 @@ RPCHelpMan dumpwallet()\n     if (!pwallet) return NullUniValue;\n \n     CWallet& wallet = *pwallet;\n-    LegacyScriptPubKeyMan& spk_man = EnsureLegacyScriptPubKeyMan(wallet);\n+    const LegacyScriptPubKeyMan& spk_man = EnsureConstLegacyScriptPubKeyMan(wallet);\n \n     // Make sure the results are valid at least up to the most recent block\n     // the user could have gotten from another RPC command prior to now"
      },
      {
        "sha": "babb61b03add1bd55d406a33fea39c71d5e91d60",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 0,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ec2792d1dc3404d749a43556eeb4b63780ee6d94/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ec2792d1dc3404d749a43556eeb4b63780ee6d94/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=ec2792d1dc3404d749a43556eeb4b63780ee6d94",
        "patch": "@@ -150,6 +150,15 @@ LegacyScriptPubKeyMan& EnsureLegacyScriptPubKeyMan(CWallet& wallet, bool also_cr\n     return *spk_man;\n }\n \n+const LegacyScriptPubKeyMan& EnsureConstLegacyScriptPubKeyMan(const CWallet& wallet)\n+{\n+    const LegacyScriptPubKeyMan* spk_man = wallet.GetLegacyScriptPubKeyMan();\n+    if (!spk_man) {\n+        throw JSONRPCError(RPC_WALLET_ERROR, \"This type of wallet does not support this command\");\n+    }\n+    return *spk_man;\n+}\n+\n static void WalletTxToJSON(const CWallet& wallet, const CWalletTx& wtx, UniValue& entry)\n {\n     interfaces::Chain& chain = wallet.chain();"
      },
      {
        "sha": "3a85fc0c64a678025a1f0740c0cd1b175334ef36",
        "filename": "src/wallet/rpcwallet.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ec2792d1dc3404d749a43556eeb4b63780ee6d94/src/wallet/rpcwallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ec2792d1dc3404d749a43556eeb4b63780ee6d94/src/wallet/rpcwallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.h?ref=ec2792d1dc3404d749a43556eeb4b63780ee6d94",
        "patch": "@@ -34,6 +34,7 @@ std::shared_ptr<CWallet> GetWalletForJSONRPCRequest(const JSONRPCRequest& reques\n void EnsureWalletIsUnlocked(const CWallet&);\n WalletContext& EnsureWalletContext(const std::any& context);\n LegacyScriptPubKeyMan& EnsureLegacyScriptPubKeyMan(CWallet& wallet, bool also_create = false);\n+const LegacyScriptPubKeyMan& EnsureConstLegacyScriptPubKeyMan(const CWallet& wallet);\n \n RPCHelpMan getaddressinfo();\n RPCHelpMan signrawtransactionwithwallet();"
      }
    ]
  },
  {
    "sha": "d150fe3ad5ce181511f2d2fd035a10530eaa4203",
    "node_id": "C_kwDOABII59oAKGQxNTBmZTNhZDVjZTE4MTUxMWYyZDJmZDAzNWExMDUzMGVhYTQyMDM",
    "commit": {
      "author": {
        "name": "Sebastian Falbesoner",
        "email": "sebastian.falbesoner@gmail.com",
        "date": "2021-08-26T13:20:12Z"
      },
      "committer": {
        "name": "Sebastian Falbesoner",
        "email": "sebastian.falbesoner@gmail.com",
        "date": "2021-11-10T16:12:41Z"
      },
      "message": "refactor: use `CWallet` const shared pointers in dump{privkey,wallet} RPCs",
      "tree": {
        "sha": "a924f77687d14368f4295272161445b074ecf01a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a924f77687d14368f4295272161445b074ecf01a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d150fe3ad5ce181511f2d2fd035a10530eaa4203",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d150fe3ad5ce181511f2d2fd035a10530eaa4203",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/d150fe3ad5ce181511f2d2fd035a10530eaa4203",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d150fe3ad5ce181511f2d2fd035a10530eaa4203/comments",
    "author": {
      "login": "theStack",
      "id": 91535,
      "node_id": "MDQ6VXNlcjkxNTM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theStack",
      "html_url": "https://github.com/theStack",
      "followers_url": "https://api.github.com/users/theStack/followers",
      "following_url": "https://api.github.com/users/theStack/following{/other_user}",
      "gists_url": "https://api.github.com/users/theStack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theStack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
      "organizations_url": "https://api.github.com/users/theStack/orgs",
      "repos_url": "https://api.github.com/users/theStack/repos",
      "events_url": "https://api.github.com/users/theStack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theStack/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "theStack",
      "id": 91535,
      "node_id": "MDQ6VXNlcjkxNTM1",
      "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theStack",
      "html_url": "https://github.com/theStack",
      "followers_url": "https://api.github.com/users/theStack/followers",
      "following_url": "https://api.github.com/users/theStack/following{/other_user}",
      "gists_url": "https://api.github.com/users/theStack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theStack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
      "organizations_url": "https://api.github.com/users/theStack/orgs",
      "repos_url": "https://api.github.com/users/theStack/repos",
      "events_url": "https://api.github.com/users/theStack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theStack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ec2792d1dc3404d749a43556eeb4b63780ee6d94",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ec2792d1dc3404d749a43556eeb4b63780ee6d94",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ec2792d1dc3404d749a43556eeb4b63780ee6d94"
      }
    ],
    "stats": {
      "total": 6,
      "additions": 3,
      "deletions": 3
    },
    "files": [
      {
        "sha": "403c97868073df29b8abdb6367e6a93a50d4f118",
        "filename": "src/wallet/rpcdump.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d150fe3ad5ce181511f2d2fd035a10530eaa4203/src/wallet/rpcdump.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d150fe3ad5ce181511f2d2fd035a10530eaa4203/src/wallet/rpcdump.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcdump.cpp?ref=d150fe3ad5ce181511f2d2fd035a10530eaa4203",
        "patch": "@@ -681,7 +681,7 @@ RPCHelpMan dumpprivkey()\n                 },\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n {\n-    std::shared_ptr<CWallet> const pwallet = GetWalletForJSONRPCRequest(request);\n+    const std::shared_ptr<const CWallet> pwallet = GetWalletForJSONRPCRequest(request);\n     if (!pwallet) return NullUniValue;\n \n     const LegacyScriptPubKeyMan& spk_man = EnsureConstLegacyScriptPubKeyMan(*pwallet);\n@@ -731,10 +731,10 @@ RPCHelpMan dumpwallet()\n                 },\n         [&](const RPCHelpMan& self, const JSONRPCRequest& request) -> UniValue\n {\n-    std::shared_ptr<CWallet> const pwallet = GetWalletForJSONRPCRequest(request);\n+    const std::shared_ptr<const CWallet> pwallet = GetWalletForJSONRPCRequest(request);\n     if (!pwallet) return NullUniValue;\n \n-    CWallet& wallet = *pwallet;\n+    const CWallet& wallet = *pwallet;\n     const LegacyScriptPubKeyMan& spk_man = EnsureConstLegacyScriptPubKeyMan(wallet);\n \n     // Make sure the results are valid at least up to the most recent block"
      }
    ]
  }
]