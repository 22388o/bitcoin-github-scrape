[
  {
    "sha": "18bacec6c2c8493fd6b7011778446b3c7473bb25",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxOGJhY2VjNmMyYzg0OTNmZDZiNzAxMTc3ODQ0NmIzYzc0NzNiYjI1",
    "commit": {
      "author": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2017-06-08T14:41:19Z"
      },
      "committer": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2017-06-27T18:14:15Z"
      },
      "message": "Make check to distinguish between orphan txs and old txs more efficient.\n\nChecking for the existence in the CCoinsViewCache of the outputs of a new tx\nwill result in a disk hit for every output since they will not be found.  On the\nother hand if those outputs exist already, then the inputs must also have been\nmissing, so we can move this check inside the input existence check so in the\ncommon case of a new tx it doesn't need to run.\n\nThe purpose of the check is to avoid spamming the orphanMap with slightly old\ntxs which we have already seen in a block, but it is already only optimistic\n(depending on the outputs not being spent), so make it even more efficient by\nonly checking the cache and not the entire pcoinsTip.",
      "tree": {
        "sha": "8a6f2be4ec128d74dc9f0add6342a794cafcb1cb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/8a6f2be4ec128d74dc9f0add6342a794cafcb1cb"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/18bacec6c2c8493fd6b7011778446b3c7473bb25",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/18bacec6c2c8493fd6b7011778446b3c7473bb25",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/18bacec6c2c8493fd6b7011778446b3c7473bb25",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/18bacec6c2c8493fd6b7011778446b3c7473bb25/comments",
    "author": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ac52492cd22782d7b09c78c198fb6fd8eb1da57c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ac52492cd22782d7b09c78c198fb6fd8eb1da57c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ac52492cd22782d7b09c78c198fb6fd8eb1da57c"
      }
    ],
    "stats": {
      "total": 20,
      "additions": 8,
      "deletions": 12
    },
    "files": [
      {
        "sha": "c160da64abe4121428dd64b55032ece5775cacf5",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 12,
        "changes": 20,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/18bacec6c2c8493fd6b7011778446b3c7473bb25/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/18bacec6c2c8493fd6b7011778446b3c7473bb25/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=18bacec6c2c8493fd6b7011778446b3c7473bb25",
        "patch": "@@ -491,24 +491,20 @@ static bool AcceptToMemoryPoolWorker(const CChainParams& chainparams, CTxMemPool\n         CCoinsViewMemPool viewMemPool(pcoinsTip, pool);\n         view.SetBackend(viewMemPool);\n \n-        // do we already have it?\n-        for (size_t out = 0; out < tx.vout.size(); out++) {\n-            COutPoint outpoint(hash, out);\n-            bool had_coin_in_cache = pcoinsTip->HaveCoinInCache(outpoint);\n-            if (view.HaveCoin(outpoint)) {\n-                if (!had_coin_in_cache) {\n-                    coins_to_uncache.push_back(outpoint);\n-                }\n-                return state.Invalid(false, REJECT_DUPLICATE, \"txn-already-known\");\n-            }\n-        }\n-\n         // do all inputs exist?\n         for (const CTxIn txin : tx.vin) {\n             if (!pcoinsTip->HaveCoinInCache(txin.prevout)) {\n                 coins_to_uncache.push_back(txin.prevout);\n             }\n             if (!view.HaveCoin(txin.prevout)) {\n+                // Are inputs missing because we already have the tx?\n+                for (size_t out = 0; out < tx.vout.size(); out++) {\n+                    // Optimistically just do efficient check of cache for outputs\n+                    if (pcoinsTip->HaveCoinInCache(COutPoint(hash, out))) {\n+                        return state.Invalid(false, REJECT_DUPLICATE, \"txn-already-known\");\n+                    }\n+                }\n+                // Otherwise assume this might be an orphan tx for which we just haven't seen parents yet\n                 if (pfMissingInputs) {\n                     *pfMissingInputs = true;\n                 }"
      }
    ]
  }
]