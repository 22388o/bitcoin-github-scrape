DrahtBot,2019-02-16T16:51:33Z,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#22834](https://github.com/bitcoin/bitcoin/pull/22834) (net: respect -onlynet= when making outbound connections by vasild",https://github.com/bitcoin/bitcoin/pull/15423#issuecomment-464362197,464362197,
kristapsk,2019-05-14T21:36:43Z,"Agree with @practicalswift comments, apart from that tACK 962f168a014af659feea0a7d6153e4c2b57cf2ed (enabled/disabled 9050 and other ports in `torrc`, compared behaviour between 0.18 and this).",https://github.com/bitcoin/bitcoin/pull/15423#issuecomment-492419231,492419231,
laanwj,2019-06-05T14:59:26Z,"Concept ACK, thanks, this makes sense.",https://github.com/bitcoin/bitcoin/pull/15423#issuecomment-499120541,499120541,
kristapsk,2019-11-13T22:41:31Z,This came up in a twitter discussion with @luke-jr yesterday. What's blocker here? Or just forgot in a long list of unmerged PRs?,https://github.com/bitcoin/bitcoin/pull/15423#issuecomment-553638092,553638092,
Empact,2020-01-06T09:46:00Z,Concept ACK,https://github.com/bitcoin/bitcoin/pull/15423#issuecomment-571073344,571073344,
DrahtBot,2020-03-09T20:34:49Z,"<!--5d09a71f8925f3f132321140b44b946d-->The last travis run for this pull request was 387 days ago and is thus outdated. To trigger a fresh travis build, this pull request should be closed and re-opened.",https://github.com/bitcoin/bitcoin/pull/15423#issuecomment-596765664,596765664,
luke-jr,2021-07-08T22:28:18Z,"Rebased, nits addressed",https://github.com/bitcoin/bitcoin/pull/15423#issuecomment-876785258,876785258,
vasild,2021-08-30T09:02:56Z,"@luke-jr, are you planning to update this PR?",https://github.com/bitcoin/bitcoin/pull/15423#issuecomment-908172014,908172014,
practicalswift,2019-02-16T22:04:20Z,Assert that condition?,https://github.com/bitcoin/bitcoin/pull/15423#discussion_r257479394,257479394,src/torcontrol.cpp
practicalswift,2019-02-17T10:20:33Z,Make sure parameter names match between declaration and definition :-),https://github.com/bitcoin/bitcoin/pull/15423#discussion_r257497807,257497807,src/torcontrol.cpp
luke-jr,2019-02-18T03:07:35Z,I don't agree with that aesthetic.,https://github.com/bitcoin/bitcoin/pull/15423#discussion_r257546401,257546401,src/torcontrol.cpp
laanwj,2019-06-05T15:01:21Z,Not necessary IMO.,https://github.com/bitcoin/bitcoin/pull/15423#discussion_r290785964,290785964,src/torcontrol.cpp
laanwj,2019-06-06T15:17:28Z,"Do you know what is the minimum version of Tor supporting this query? is it newer or older than what we already require?\n(not that it matters much, as I se it'll gracefully fall back to the old behavior; but it might be useful for testing)",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r291236109,291236109,src/torcontrol.cpp
Saibato,2020-06-26T10:38:31Z,"Minor Nit  it does not account for early user -proxy=  settings and would overrule them.\n\nPlease consider the litle patch ff \nThat would also fix finally  #14722 and make #19358  obsolete.\n\n``` Diff\ndiff --git a/src/torcontrol.cpp b/src/torcontrol.cpp\nindex 2871f9030..dff873ce9 100644\n--- a/src/torcontrol.cpp\n+++ b/src/torcontrol.cpp\n@@ -573,7 +573,8 @@ void TorController::auth",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r446106772,446106772,src/torcontrol.cpp
Saibato,2020-06-26T11:06:01Z,"> Do you know what is the minimum version of Tor supporting this query? is it newer or older than what we already require?\n> (not that it matters much, as I se it'll gracefully fall back to the old behavior; but it might be useful for testing)\n\nTyi: This info call /net/listeners/socks is according to tor doku possible since [ 0.2.2.26-beta.]\nI tested with versions 0.2.9.16 and 0.4.3.5\n\",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r446117769,446117769,src/torcontrol.cpp
vasild,2021-03-11T05:38:26Z,"```suggestion\n                for (const auto& portstr : spanparsing::Split(port_list_str, ' ')) {\n```\n",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r592079279,592079279,src/torcontrol.cpp
vasild,2021-03-11T05:40:25Z,"nit: this would accept `""123'` and `'456""`. I guess it is ok, but is also easy to avoid, thus I mention it.",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r592079893,592079893,src/torcontrol.cpp
vasild,2021-03-11T05:46:48Z,"nit: this is somewhat confusing because we assign a `...port....` variable an address, not a port. Maybe `s/socks_port_str/socks_location/`.",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r592081880,592081880,src/torcontrol.cpp
luke-jr,2021-07-08T22:13:19Z,It would be incorrect behaviour.,https://github.com/bitcoin/bitcoin/pull/15423#discussion_r666550686,666550686,src/torcontrol.cpp
luke-jr,2021-07-08T22:17:53Z,"```\ntorcontrol.cpp:340:80: error: no member named 'rbegin' in 'Span<const char>'; did you mean 'begin'?\n                    if ((portstr[0] == '""' || portstr[0] == '\'') && (*portstr.rbegin() == '""' || *portstr.rbegin() == '\'')) {\n                                                                               ^~~~~~\n```",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r666552523,666552523,src/torcontrol.cpp
vasild,2021-07-09T11:39:38Z,"Ah, `Span` has `begin()`, but no `rbegin()`. It has `back()` to lookup the last element, so `*portstr.rbegin()` can be replaced `portstr.back()` if you like it better.",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r666885508,666885508,src/torcontrol.cpp
vasild,2021-07-27T16:44:57Z,"If `portstr` contains just `""` (it is a string with length 1), then this condition will evaluate to true. On the subsequent line `portstr.size() - 2` will be -1 converted to `size_t` (will cause a warning by the integer sanitizer). Then `substr(1, -1)` will return an empty string and it will work as intended - `continue;` will be executed.\n\nBut anyway, I think it is better to add one more cond",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r677626301,677626301,src/torcontrol.cpp
vasild,2021-07-27T16:52:22Z,"Would be good to check the result of `LookupNumeric()` in case some unexpected string was returned by the Tor server.\n\n```suggestion\n    CService resolved(LookupNumeric(socks_location, 9050));\n\n    if (!resolved.IsValid()) {\n        // Fallback to old behaviour\n        resolved = LookupNumeric(""127.0.0.1"", 9050);\n    }\n```",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r677631878,677631878,src/torcontrol.cpp
prayank23,2021-08-07T05:09:50Z,Port 9150 for Windows: https://github.com/bitcoin/bitcoin/pull/22651#discussion_r684460683,https://github.com/bitcoin/bitcoin/pull/15423#discussion_r684585377,684585377,src/torcontrol.cpp
kristapsk,2021-08-30T14:13:50Z,"Is it really Windows default? Not confusing with Tor Browser's default, which is 9150?",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r698524625,698524625,src/torcontrol.cpp
prayank23,2021-08-30T15:02:42Z,"> Not confusing with Tor Browser's default, which is 9150?\n\nYes this is what I normally follow:\n\nWindows: Running Tor browser and using it as proxy\nLinux: Running Tor after installing with command: `sudo apt install tor`\n\nRunning Tor as service on Windows involves some workaround which I am not sure many do or maybe I am not aware of other easier ways to do it: https://superuser.com/",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r698565969,698565969,src/torcontrol.cpp
luke-jr,2021-08-30T15:09:33Z,"9050 here serves two purposes:\n\n1. Fallback to old behaviour. This was always 9050.\n2. Default port if Tor's API returns just an IP. Is there any reason to think it would ever be anything other than 9050?",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r698571479,698571479,src/torcontrol.cpp
lano1106,2021-08-31T06:16:45Z,"Here is my torcfg settings\n\n```\n## Tor opens a SOCKS proxy on port 9050 by default -- even if you don't\n## configure one below. Set ""SOCKSPort 0"" if you plan to run Tor only\n## as a relay, and not make any local application connections yourself.\nSOCKSPort 9050 # Default: Bind to localhost:9050 for local connections.\nSOCKSPort 192.168.1.2:9050 # Bind to this address:port too.\n```\n",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r699014147,699014147,src/torcontrol.cpp
lano1106,2021-09-01T03:22:14Z,"This line did cause me a problem and this is why I created https://github.com/bitcoin/bitcoin/pull/22830\n\nIn a nutshell, you could have the  onion proxy set with the following cmdline:\n-proxy=192.168.1.2:9050 -torcontrol=127.0.0.1:9050\n\nI believe that check the presence of the -onion switch is not the right check because the check as-is overwrite the user settings.\n\nThe code should i",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r699814748,699814748,src/torcontrol.cpp
lano1106,2021-09-01T03:35:48Z,"I have few more thoughts to share to possibly improve further the code of this function. Here is my setup:\n\nI have 1 tor proxy configured on a single machine in my LAN. It is on 192.168.1.2. This allows me to share a single tor proxy instance among all the trusted machines inside my LAN.\n\nBitcoind is running on a different machine: 192.168.1.179.\n\nMy first attempt to make torcontrol av",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r699818729,699818729,src/torcontrol.cpp
vasild,2021-09-02T13:44:47Z,"I tested with\n```\nSOCKSPort 10000\nSOCKSPort 192.168.0.1:20000\nSOCKSPort 0.0.0.0:30000\n```\n\nThe reply from the Tor control daemon is:\n```\nnet/listeners/socks=""127.0.0.1:10000"" ""192.168.0.1:20000"" ""0.0.0.0:30000""\n```\nso it does not return just port. The spec is here: https://github.com/torproject/torspec/blob/845a4d7213e8e28bb039d6925437b5b1c0d607e7/control-spec.txt#L912.\n\n",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r701097810,701097810,src/torcontrol.cpp
lano1106,2021-09-02T14:00:58Z,"Vasil, you have been faster than me... I just tested too this morning:\n`2021-09-02T13:51:22Z tor: reply line: net/listeners/socks=""127.0.0.1:9050"" ""192.168.1.2:9050""`\n\nSo overall this pull request works well. I just think non localhost address should be prefered over 127.0.0.1. This would work with my setup and I don't see any extra benefits of picking 127.0.0.1 in any scenario.\n",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r701113329,701113329,src/torcontrol.cpp
lano1106,2021-09-02T14:38:52Z,"> But anyway - we can't expect the automatic configuration to detect and work in all cases. For this we have the manual override. @lano1106, in your case you can set `-onion=192.168.1.2:9050` which will work with `master` and with this PR.\n\nyou are correct but see my other suggestion below. I did configure the onion proxy with the following options:\n-proxy=192.168.1.2:9050 -torcontrol=127.0.",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r701149240,701149240,src/torcontrol.cpp
luke-jr,2021-09-02T15:03:54Z,">So overall this pull request works well. I just think non localhost address should be prefered over 127.0.0.1. This would work with my setup and I don't see any extra benefits of picking 127.0.0.1 in any scenario.\n\nThe non-localhost address may change or cease to be available?\n\n>because -onion switch is not the only way to configure the onion proxy.\n\nBut it's the only way that should ",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r701172341,701172341,src/torcontrol.cpp
lano1106,2021-09-03T13:36:46Z,"@luke-jr if the non-localhost address may change or cease to be available is a serious and valid concern for not modifying the code behavior then so be it.\n\nI have said everything that I have to say on the topic and I'll conclude by saying that without being aware of the initial problem that motivated this pull request, with the reasonable assumption that the vast majority of tor proxy setups ",https://github.com/bitcoin/bitcoin/pull/15423#discussion_r701897608,701897608,src/torcontrol.cpp
