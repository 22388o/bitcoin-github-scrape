[
  {
    "sha": "46c162df478f3b71bef8217f214ccf202576b733",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0NmMxNjJkZjQ3OGYzYjcxYmVmODIxN2YyMTRjY2YyMDI1NzZiNzMz",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2018-12-06T21:13:53Z"
      },
      "committer": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2018-12-07T16:36:29Z"
      },
      "message": "rpc: Avoid creating non-standard raw transactions\n\nGithub-Pull: #14890\nRebased-From: fa4c8679ed94f215ce895938f7c3c169a2ce101e",
      "tree": {
        "sha": "67f0870b84846c6033dae9d4c9319b5047c04fb2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/67f0870b84846c6033dae9d4c9319b5047c04fb2"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/46c162df478f3b71bef8217f214ccf202576b733",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/46c162df478f3b71bef8217f214ccf202576b733",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/46c162df478f3b71bef8217f214ccf202576b733",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/46c162df478f3b71bef8217f214ccf202576b733/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ef70f9b52b851c7997a9f1a0834714e3eebc1fd8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ef70f9b52b851c7997a9f1a0834714e3eebc1fd8",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ef70f9b52b851c7997a9f1a0834714e3eebc1fd8"
      }
    ],
    "stats": {
      "total": 35,
      "additions": 19,
      "deletions": 16
    },
    "files": [
      {
        "sha": "391e744c904d7fa17e62c5c185b7e9122942b25f",
        "filename": "src/rpc/rawtransaction.cpp",
        "status": "modified",
        "additions": 13,
        "deletions": 3,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/46c162df478f3b71bef8217f214ccf202576b733/src/rpc/rawtransaction.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/46c162df478f3b71bef8217f214ccf202576b733/src/rpc/rawtransaction.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/rawtransaction.cpp?ref=46c162df478f3b71bef8217f214ccf202576b733",
        "patch": "@@ -396,7 +396,6 @@ CMutableTransaction ConstructTransaction(const UniValue& inputs_in, const UniVal\n         rawTx.vin.push_back(in);\n     }\n \n-    std::set<CTxDestination> destinations;\n     if (!outputs_is_obj) {\n         // Translate array of key-value pairs into dict\n         UniValue outputs_dict = UniValue(UniValue::VOBJ);\n@@ -412,8 +411,17 @@ CMutableTransaction ConstructTransaction(const UniValue& inputs_in, const UniVal\n         }\n         outputs = std::move(outputs_dict);\n     }\n+\n+    // Duplicate checking\n+    std::set<CTxDestination> destinations;\n+    bool has_data{false};\n+\n     for (const std::string& name_ : outputs.getKeys()) {\n         if (name_ == \"data\") {\n+            if (has_data) {\n+                throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid parameter, duplicate key: data\");\n+            }\n+            has_data = true;\n             std::vector<unsigned char> data = ParseHexV(outputs[name_].getValStr(), \"Data\");\n \n             CTxOut out(0, CScript() << OP_RETURN << data);\n@@ -465,7 +473,8 @@ static UniValue createrawtransaction(const JSONRPCRequest& request)\n             \"       } \\n\"\n             \"       ,...\\n\"\n             \"     ]\\n\"\n-            \"2. \\\"outputs\\\"               (array, required) a json array with outputs (key-value pairs)\\n\"\n+            \"2. \\\"outputs\\\"               (array, required) a json array with outputs (key-value pairs), where none of the keys are duplicated.\\n\"\n+            \"That is, each address can only appear once and there can only be one 'data' object.\\n\"\n             \"   [\\n\"\n             \"    {\\n\"\n             \"      \\\"address\\\": x.xxx,    (obj, optional) A key-value pair. The key (string) is the bitcoin address, the value (float or string) is the amount in \" + CURRENCY_UNIT + \"\\n\"\n@@ -1690,7 +1699,8 @@ UniValue createpsbt(const JSONRPCRequest& request)\n                             \"       } \\n\"\n                             \"       ,...\\n\"\n                             \"     ]\\n\"\n-                            \"2. \\\"outputs\\\"               (array, required) a json array with outputs (key-value pairs)\\n\"\n+                            \"2. \\\"outputs\\\"               (array, required) a json array with outputs (key-value pairs), where none of the keys are duplicated.\\n\"\n+                            \"That is, each address can only appear once and there can only be one 'data' object.\\n\"\n                             \"   [\\n\"\n                             \"    {\\n\"\n                             \"      \\\"address\\\": x.xxx,    (obj, optional) A key-value pair. The key (string) is the bitcoin address, the value (float or string) is the amount in \" + CURRENCY_UNIT + \"\\n\""
      },
      {
        "sha": "943bbf3137c173000a6ea1e56a78f488c0cd35b7",
        "filename": "src/test/rpc_tests.cpp",
        "status": "modified",
        "additions": 0,
        "deletions": 3,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/46c162df478f3b71bef8217f214ccf202576b733/src/test/rpc_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/46c162df478f3b71bef8217f214ccf202576b733/src/test/rpc_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/rpc_tests.cpp?ref=46c162df478f3b71bef8217f214ccf202576b733",
        "patch": "@@ -122,9 +122,6 @@ BOOST_AUTO_TEST_CASE(rpc_createraw_op_return)\n {\n     BOOST_CHECK_NO_THROW(CallRPC(\"createrawtransaction [{\\\"txid\\\":\\\"a3b807410df0b60fcb9736768df5823938b2f838694939ba45f3c0a1bff150ed\\\",\\\"vout\\\":0}] {\\\"data\\\":\\\"68656c6c6f776f726c64\\\"}\"));\n \n-    // Allow more than one data transaction output\n-    BOOST_CHECK_NO_THROW(CallRPC(\"createrawtransaction [{\\\"txid\\\":\\\"a3b807410df0b60fcb9736768df5823938b2f838694939ba45f3c0a1bff150ed\\\",\\\"vout\\\":0}] {\\\"data\\\":\\\"68656c6c6f776f726c64\\\",\\\"data\\\":\\\"68656c6c6f776f726c64\\\"}\"));\n-\n     // Key not \"data\" (bad address)\n     BOOST_CHECK_THROW(CallRPC(\"createrawtransaction [{\\\"txid\\\":\\\"a3b807410df0b60fcb9736768df5823938b2f838694939ba45f3c0a1bff150ed\\\",\\\"vout\\\":0}] {\\\"somedata\\\":\\\"68656c6c6f776f726c64\\\"}\"), std::runtime_error);\n "
      },
      {
        "sha": "e02171ec40fe6789c3b52f9fd379ad08cd8822a4",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/46c162df478f3b71bef8217f214ccf202576b733/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/46c162df478f3b71bef8217f214ccf202576b733/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=46c162df478f3b71bef8217f214ccf202576b733",
        "patch": "@@ -4680,7 +4680,8 @@ UniValue walletcreatefundedpsbt(const JSONRPCRequest& request)\n                             \"       } \\n\"\n                             \"       ,...\\n\"\n                             \"     ]\\n\"\n-                            \"2. \\\"outputs\\\"               (array, required) a json array with outputs (key-value pairs)\\n\"\n+                            \"2. \\\"outputs\\\"               (array, required) a json array with outputs (key-value pairs), where none of the keys are duplicated.\\n\"\n+                            \"That is, each address can only appear once and there can only be one 'data' object.\\n\"\n                             \"   [\\n\"\n                             \"    {\\n\"\n                             \"      \\\"address\\\": x.xxx,    (obj, optional) A key-value pair. The key (string) is the bitcoin address, the value (float or string) is the amount in \" + CURRENCY_UNIT + \"\\n\""
      },
      {
        "sha": "c62e04fe14754141aae1d5f0ec43622da0c66c17",
        "filename": "test/functional/rpc_rawtransaction.py",
        "status": "modified",
        "additions": 4,
        "deletions": 9,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/46c162df478f3b71bef8217f214ccf202576b733/test/functional/rpc_rawtransaction.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/46c162df478f3b71bef8217f214ccf202576b733/test/functional/rpc_rawtransaction.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_rawtransaction.py?ref=46c162df478f3b71bef8217f214ccf202576b733",
        "patch": "@@ -99,6 +99,8 @@ def run_test(self):\n         assert_raises_rpc_error(-3, \"Amount out of range\", self.nodes[0].createrawtransaction, [], {address: -1})\n         assert_raises_rpc_error(-8, \"Invalid parameter, duplicated address: %s\" % address, self.nodes[0].createrawtransaction, [], multidict([(address, 1), (address, 1)]))\n         assert_raises_rpc_error(-8, \"Invalid parameter, duplicated address: %s\" % address, self.nodes[0].createrawtransaction, [], [{address: 1}, {address: 1}])\n+        assert_raises_rpc_error(-8, \"Invalid parameter, duplicate key: data\", self.nodes[0].createrawtransaction, [], [{\"data\": 'aa'}, {\"data\": \"bb\"}])\n+        assert_raises_rpc_error(-8, \"Invalid parameter, duplicate key: data\", self.nodes[0].createrawtransaction, [], multidict([(\"data\", 'aa'), (\"data\", \"bb\")]))\n         assert_raises_rpc_error(-8, \"Invalid parameter, key-value pair must contain exactly one key\", self.nodes[0].createrawtransaction, [], [{'a': 1, 'b': 2}])\n         assert_raises_rpc_error(-8, \"Invalid parameter, key-value pair not an object as expected\", self.nodes[0].createrawtransaction, [], [['key-value pair1'], ['2']])\n \n@@ -126,19 +128,12 @@ def run_test(self):\n             bytes_to_hex_str(tx.serialize()),\n             self.nodes[2].createrawtransaction(inputs=[{'txid': txid, 'vout': 9}], outputs=[{address: 99}, {address2: 99}]),\n         )\n-        # Two data outputs\n-        tx.deserialize(BytesIO(hex_str_to_bytes(self.nodes[2].createrawtransaction(inputs=[{'txid': txid, 'vout': 9}], outputs=multidict([('data', '99'), ('data', '99')])))))\n-        assert_equal(len(tx.vout), 2)\n-        assert_equal(\n-            bytes_to_hex_str(tx.serialize()),\n-            self.nodes[2].createrawtransaction(inputs=[{'txid': txid, 'vout': 9}], outputs=[{'data': '99'}, {'data': '99'}]),\n-        )\n         # Multiple mixed outputs\n-        tx.deserialize(BytesIO(hex_str_to_bytes(self.nodes[2].createrawtransaction(inputs=[{'txid': txid, 'vout': 9}], outputs=multidict([(address, 99), ('data', '99'), ('data', '99')])))))\n+        tx.deserialize(BytesIO(hex_str_to_bytes(self.nodes[2].createrawtransaction(inputs=[{'txid': txid, 'vout': 9}], outputs=multidict([(address, 99), (address2, 99), ('data', '99')])))))\n         assert_equal(len(tx.vout), 3)\n         assert_equal(\n             bytes_to_hex_str(tx.serialize()),\n-            self.nodes[2].createrawtransaction(inputs=[{'txid': txid, 'vout': 9}], outputs=[{address: 99}, {'data': '99'}, {'data': '99'}]),\n+            self.nodes[2].createrawtransaction(inputs=[{'txid': txid, 'vout': 9}], outputs=[{address: 99}, {address2: 99}, {'data': '99'}]),\n         )\n \n         for type in [\"bech32\", \"p2sh-segwit\", \"legacy\"]:"
      }
    ]
  }
]