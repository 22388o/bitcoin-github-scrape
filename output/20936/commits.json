[
  {
    "sha": "32cbb06676e2957705d3ca7ff5710c9c3ff22c14",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozMmNiYjA2Njc2ZTI5NTc3MDVkM2NhN2ZmNTcxMGM5YzNmZjIyYzE0",
    "commit": {
      "author": {
        "name": "Dan Benjamin",
        "email": "danben@gmail.com",
        "date": "2021-01-24T16:09:24Z"
      },
      "committer": {
        "name": "Dan Benjamin",
        "email": "danben@gmail.com",
        "date": "2021-02-06T00:52:45Z"
      },
      "message": "build: build fuzz tests by default.\n\nThis fixes issue #19388. The changes are as follows:\n  - Add a new flag to configure, --enable-fuzz-binary, which allows building test/fuzz/fuzz regardless of whether we are building to do actual fuzzing\n  - Set -DPROVIDE_MAIN_FUNCTION whenever --enable-fuzz is no\n  - Add the following libraries to FUZZ_SUITE_LD_COMMON:\n    - LIBBITCOIN_WALLET\n    - SQLLITE_LIBS\n    - BDB_LIBS\n    - if necessary, some or all of:\n      - NATPMP_LIBS\n      - MINIUPNPC_LIBS\n      - LIBBITCOIN_ZMQ / ZMQ_LIBS",
      "tree": {
        "sha": "62c70a0957fdb7b6b04acf0f79731af8d9ace135",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/62c70a0957fdb7b6b04acf0f79731af8d9ace135"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/32cbb06676e2957705d3ca7ff5710c9c3ff22c14",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/32cbb06676e2957705d3ca7ff5710c9c3ff22c14",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/32cbb06676e2957705d3ca7ff5710c9c3ff22c14",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/32cbb06676e2957705d3ca7ff5710c9c3ff22c14/comments",
    "author": {
      "login": "danben",
      "id": 253639,
      "node_id": "MDQ6VXNlcjI1MzYzOQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/253639?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/danben",
      "html_url": "https://github.com/danben",
      "followers_url": "https://api.github.com/users/danben/followers",
      "following_url": "https://api.github.com/users/danben/following{/other_user}",
      "gists_url": "https://api.github.com/users/danben/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/danben/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/danben/subscriptions",
      "organizations_url": "https://api.github.com/users/danben/orgs",
      "repos_url": "https://api.github.com/users/danben/repos",
      "events_url": "https://api.github.com/users/danben/events{/privacy}",
      "received_events_url": "https://api.github.com/users/danben/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "danben",
      "id": 253639,
      "node_id": "MDQ6VXNlcjI1MzYzOQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/253639?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/danben",
      "html_url": "https://github.com/danben",
      "followers_url": "https://api.github.com/users/danben/followers",
      "following_url": "https://api.github.com/users/danben/following{/other_user}",
      "gists_url": "https://api.github.com/users/danben/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/danben/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/danben/subscriptions",
      "organizations_url": "https://api.github.com/users/danben/orgs",
      "repos_url": "https://api.github.com/users/danben/repos",
      "events_url": "https://api.github.com/users/danben/events{/privacy}",
      "received_events_url": "https://api.github.com/users/danben/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6c6140846f37de8c132b3b6abf09f3d7940554a7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6c6140846f37de8c132b3b6abf09f3d7940554a7",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6c6140846f37de8c132b3b6abf09f3d7940554a7"
      }
    ],
    "stats": {
      "total": 50,
      "additions": 39,
      "deletions": 11
    },
    "files": [
      {
        "sha": "bbc43cfabdb166919c5d49ba1c437f924e7a40e5",
        "filename": "ci/test/00_setup_env_native_qt5.sh",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/32cbb06676e2957705d3ca7ff5710c9c3ff22c14/ci/test/00_setup_env_native_qt5.sh",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/32cbb06676e2957705d3ca7ff5710c9c3ff22c14/ci/test/00_setup_env_native_qt5.sh",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/ci/test/00_setup_env_native_qt5.sh?ref=32cbb06676e2957705d3ca7ff5710c9c3ff22c14",
        "patch": "@@ -16,4 +16,5 @@ export RUN_UNIT_TESTS_SEQUENTIAL=\"true\"\n export RUN_UNIT_TESTS=\"false\"\n export GOAL=\"install\"\n export PREVIOUS_RELEASES_TO_DOWNLOAD=\"v0.15.2 v0.16.3 v0.17.2 v0.18.1 v0.19.1\"\n-export BITCOIN_CONFIG=\"--enable-zmq --with-libs=no --with-gui=qt5 --enable-glibc-back-compat --enable-reduce-exports --enable-debug CFLAGS=\\\"-g0 -O2 -funsigned-char\\\" CXXFLAGS=\\\"-g0 -O2 -funsigned-char\\\" --with-boost-process\"\n+export BITCOIN_CONFIG=\"--enable-zmq --with-libs=no --with-gui=qt5 --enable-glibc-back-compat --enable-reduce-exports\n+--enable-debug --disable-fuzz-binary  CFLAGS=\\\"-g0 -O2 -funsigned-char\\\" CXXFLAGS=\\\"-g0 -O2 -funsigned-char\\\" --with-boost-process\""
      },
      {
        "sha": "b44ce0036184fb75bf159fa40473c2f84a66659f",
        "filename": "ci/test/00_setup_env_win64.sh",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/32cbb06676e2957705d3ca7ff5710c9c3ff22c14/ci/test/00_setup_env_win64.sh",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/32cbb06676e2957705d3ca7ff5710c9c3ff22c14/ci/test/00_setup_env_win64.sh",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/ci/test/00_setup_env_win64.sh?ref=32cbb06676e2957705d3ca7ff5710c9c3ff22c14",
        "patch": "@@ -13,7 +13,7 @@ export PACKAGES=\"python3 nsis g++-mingw-w64-x86-64 wine-binfmt wine64 file\"\n export RUN_FUNCTIONAL_TESTS=false\n export RUN_SECURITY_TESTS=\"true\"\n export GOAL=\"deploy\"\n-export BITCOIN_CONFIG=\"--enable-reduce-exports --disable-gui-tests --without-boost-process\"\n+export BITCOIN_CONFIG=\"--enable-reduce-exports --disable-fuzz-binary --disable-gui-tests --without-boost-process\"\n \n # Compiler for MinGW-w64 causes false -Wreturn-type warning.\n # See https://sourceforge.net/p/mingw-w64/bugs/306/"
      },
      {
        "sha": "b63cb3d83e9e5d0e8e2675da1d6f3c2f02f0d19c",
        "filename": "configure.ac",
        "status": "modified",
        "additions": 15,
        "deletions": 3,
        "changes": 18,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/32cbb06676e2957705d3ca7ff5710c9c3ff22c14/configure.ac",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/32cbb06676e2957705d3ca7ff5710c9c3ff22c14/configure.ac",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/configure.ac?ref=32cbb06676e2957705d3ca7ff5710c9c3ff22c14",
        "patch": "@@ -184,10 +184,16 @@ AC_ARG_ENABLE([extended-functional-tests],\n \n AC_ARG_ENABLE([fuzz],\n     AS_HELP_STRING([--enable-fuzz],\n-    [enable building of fuzz targets (default no). enabling this will disable all other targets]),\n+    [build for fuzzing (default no). enabling this will disable all other targets and override --{enable,disable}-fuzz-binary]),\n     [enable_fuzz=$enableval],\n     [enable_fuzz=no])\n \n+AC_ARG_ENABLE([fuzz-binary],\n+    AS_HELP_STRING([--enable-fuzz-binary],\n+    [enable building of fuzz binary (default yes).]),\n+    [enable_fuzz_binary=$enableval],\n+    [enable_fuzz_binary=yes])\n+\n AC_ARG_ENABLE([danger_fuzz_link_all],\n     AS_HELP_STRING([--enable-danger-fuzz-link-all],\n     [Danger! Modifies source code. Needs git and gnu sed installed. Link each fuzz target (default no).]),\n@@ -1224,7 +1230,7 @@ AC_DEFUN([SUPPRESS_WARNINGS],\n \n dnl enable-fuzz should disable all other targets\n if test \"x$enable_fuzz\" = \"xyes\"; then\n-  AC_MSG_WARN(enable-fuzz will disable all other targets)\n+  AC_MSG_WARN(enable-fuzz will disable all other targets and force --enable-fuzz-binary=yes)\n   build_bitcoin_utils=no\n   build_bitcoin_cli=no\n   build_bitcoin_tx=no\n@@ -1240,10 +1246,11 @@ if test \"x$enable_fuzz\" = \"xyes\"; then\n   use_upnp=no\n   use_natpmp=no\n   use_zmq=no\n+  enable_fuzz_binary=yes\n \n   AX_CHECK_PREPROC_FLAG([-DABORT_ON_FAILED_ASSUME],[[DEBUG_CPPFLAGS=\"$DEBUG_CPPFLAGS -DABORT_ON_FAILED_ASSUME\"]],,[[$CXXFLAG_WERROR]])\n \n-  AC_MSG_CHECKING([whether main function is needed])\n+  AC_MSG_CHECKING([whether main function is needed for fuzz binary])\n   AX_CHECK_LINK_FLAG(\n     [[-fsanitize=$use_sanitizers]],\n     [AC_MSG_RESULT([no])],\n@@ -1271,6 +1278,8 @@ else\n     QT_DBUS_INCLUDES=SUPPRESS_WARNINGS($QT_DBUS_INCLUDES)\n     QT_TEST_INCLUDES=SUPPRESS_WARNINGS($QT_TEST_INCLUDES)\n   fi\n+\n+  CPPFLAGS=\"$CPPFLAGS -DPROVIDE_MAIN_FUNCTION\"\n fi\n \n if test x$enable_wallet != xno; then\n@@ -1716,6 +1725,7 @@ AM_CONDITIONAL([USE_BDB], [test \"x$use_bdb\" = \"xyes\"])\n AM_CONDITIONAL([ENABLE_TRACING],[test x$have_sdt = xyes])\n AM_CONDITIONAL([ENABLE_TESTS],[test x$BUILD_TEST = xyes])\n AM_CONDITIONAL([ENABLE_FUZZ],[test x$enable_fuzz = xyes])\n+AM_CONDITIONAL([ENABLE_FUZZ_BINARY],[test x$enable_fuzz_binary = xyes])\n AM_CONDITIONAL([ENABLE_FUZZ_LINK_ALL],[test x$enable_danger_fuzz_link_all = xyes])\n AM_CONDITIONAL([ENABLE_QT],[test x$bitcoin_enable_qt = xyes])\n AM_CONDITIONAL([ENABLE_QT_TESTS],[test x$BUILD_TEST_QT = xyes])\n@@ -1732,6 +1742,8 @@ AM_CONDITIONAL([ENABLE_SHANI],[test x$enable_shani = xyes])\n AM_CONDITIONAL([ENABLE_ARM_CRC],[test x$enable_arm_crc = xyes])\n AM_CONDITIONAL([USE_ASM],[test x$use_asm = xyes])\n AM_CONDITIONAL([WORDS_BIGENDIAN],[test x$ac_cv_c_bigendian = xyes])\n+AM_CONDITIONAL([USE_NATPMP],[test x$use_natpmp = xyes])\n+AM_CONDITIONAL([USE_UPNP],[test x$use_upnp = xyes])\n \n AC_DEFINE(CLIENT_VERSION_MAJOR, _CLIENT_VERSION_MAJOR, [Major version])\n AC_DEFINE(CLIENT_VERSION_MINOR, _CLIENT_VERSION_MINOR, [Minor version])"
      },
      {
        "sha": "77cba466ba9a19f7fa651f48fda46fec6637c550",
        "filename": "src/Makefile.test.include",
        "status": "modified",
        "additions": 21,
        "deletions": 6,
        "changes": 27,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/32cbb06676e2957705d3ca7ff5710c9c3ff22c14/src/Makefile.test.include",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/32cbb06676e2957705d3ca7ff5710c9c3ff22c14/src/Makefile.test.include",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/Makefile.test.include?ref=32cbb06676e2957705d3ca7ff5710c9c3ff22c14",
        "patch": "@@ -2,9 +2,11 @@\n # Distributed under the MIT software license, see the accompanying\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n-if ENABLE_FUZZ\n+if ENABLE_FUZZ_BINARY\n noinst_PROGRAMS += test/fuzz/fuzz\n-else\n+endif\n+\n+if !ENABLE_FUZZ\n bin_PROGRAMS += test/test_bitcoin\n endif\n \n@@ -50,6 +52,14 @@ FUZZ_SUITE_LD_COMMON = \\\n  $(EVENT_LIBS) \\\n  $(EVENT_PTHREADS_LIBS)\n \n+if USE_UPNP\n+FUZZ_SUITE_LD_COMMON += $(MINIUPNPC_LIBS)\n+endif\n+\n+if USE_NATPMP\n+FUZZ_SUITE_LD_COMMON += $(NATPMP_LIBS)\n+endif\n+\n # test_bitcoin binary #\n BITCOIN_TESTS =\\\n   test/arith_uint256_tests.cpp \\\n@@ -145,10 +155,16 @@ BITCOIN_TESTS += \\\n   wallet/test/ismine_tests.cpp \\\n   wallet/test/scriptpubkeyman_tests.cpp\n \n+FUZZ_SUITE_LD_COMMON +=\\\n+ $(LIBBITCOIN_WALLET) \\\n+ $(SQLITE_LIBS) \\\n+ $(BDB_LIBS)\n+\n if USE_BDB\n BITCOIN_TESTS += wallet/test/db_tests.cpp\n endif\n \n+\n BITCOIN_TEST_SUITE += \\\n   wallet/test/wallet_test_fixture.cpp \\\n   wallet/test/wallet_test_fixture.h \\\n@@ -172,12 +188,12 @@ test_test_bitcoin_LDFLAGS = $(RELDFLAGS) $(AM_LDFLAGS) $(LIBTOOL_APP_LDFLAGS) $(\n \n if ENABLE_ZMQ\n test_test_bitcoin_LDADD += $(LIBBITCOIN_ZMQ) $(ZMQ_LIBS)\n+FUZZ_SUITE_LD_COMMON += $(LIBBITCOIN_ZMQ) $(ZMQ_LIBS)\n endif\n \n-if ENABLE_FUZZ\n-\n FUZZ_SUITE_LDFLAGS_COMMON = $(RELDFLAGS) $(AM_LDFLAGS) $(LIBTOOL_APP_LDFLAGS) $(PTHREAD_FLAGS)\n \n+if ENABLE_FUZZ_BINARY\n test_fuzz_fuzz_CPPFLAGS = $(AM_CPPFLAGS) $(BITCOIN_INCLUDES)\n test_fuzz_fuzz_CXXFLAGS = $(AM_CXXFLAGS) $(PIE_FLAGS)\n test_fuzz_fuzz_LDADD = $(FUZZ_SUITE_LD_COMMON)\n@@ -278,8 +294,7 @@ test_fuzz_fuzz_SOURCES = \\\n  test/fuzz/tx_in.cpp \\\n  test/fuzz/tx_out.cpp \\\n  test/fuzz/txrequest.cpp\n-\n-endif # ENABLE_FUZZ\n+endif # ENABLE_FUZZ_BINARY\n \n nodist_test_test_bitcoin_SOURCES = $(GENERATED_TEST_FILES)\n "
      }
    ]
  }
]