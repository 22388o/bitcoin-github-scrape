[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315507700",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315507700",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
    "id": 315507700,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTUwNzcwMA==",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?u=63e5c438c242094837a9deeda775d77988b508bf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-15T04:02:06Z",
    "updated_at": "2017-07-15T04:02:06Z",
    "author_association": "CONTRIBUTOR",
    "body": "@pstratem  you might have some interest in reviewing this.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315507700/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315551806",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315551806",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
    "id": 315551806,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTU1MTgwNg==",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?u=7999a16349f0df0fb273fffa18e5a955c9d3f11c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-15T18:06:54Z",
    "updated_at": "2017-07-15T18:06:54Z",
    "author_association": "MEMBER",
    "body": "utACK ff9a291b30d7464c1ff0990b1cab36d6119b2ae5",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315551806/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315555429",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315555429",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
    "id": 315555429,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTU1NTQyOQ==",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-15T19:09:04Z",
    "updated_at": "2017-07-15T19:09:04Z",
    "author_association": "MEMBER",
    "body": "tACK https://github.com/bitcoin/bitcoin/pull/10831/commits/ff9a291b30d7464c1ff0990b1cab36d6119b2ae5\r\n\r\nwith 1000 keypool size, topup went from 20 seconds to 1.6.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315555429/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315570741",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315570741",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
    "id": 315570741,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTU3MDc0MQ==",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-15T23:41:39Z",
    "updated_at": "2017-07-15T23:41:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "utACK ff9a291b30d7464c1ff0990b1cab36d6119b2ae5 (needs rebase, though). ",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315570741/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315572295",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315572295",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
    "id": 315572295,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTU3MjI5NQ==",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?u=63e5c438c242094837a9deeda775d77988b508bf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-16T00:18:24Z",
    "updated_at": "2017-07-16T00:18:24Z",
    "author_association": "CONTRIBUTOR",
    "body": "@TheBlueMatt  rebased, please re-review",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315572295/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315652287",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315652287",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
    "id": 315652287,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTY1MjI4Nw==",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-17T01:17:44Z",
    "updated_at": "2017-07-17T01:17:44Z",
    "author_association": "CONTRIBUTOR",
    "body": "@promag sadly I think it's a bit late for that for 15, it might be a decent change later, however.\n\nOn July 16, 2017 7:05:52 PM EDT, Matt Corallo <notifications@github.com> wrote:\n>TheBlueMatt commented on this pull request.\n>\n>\n>\n>>                                                  \n>secret.GetPrivKey(),\n>                                       mapKeyMetadata[pubkey.GetID()]);\n>     }\n>     return true;\n> }\n> \n>+bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n>+{\n>+    CWalletDB walletdb(*dbw);\n>\n>It seems strange that we're creating a db transaction, only to throw it\n>out in a second. I think its safe, but it might be nicer to let\n>AddKeyPubKeyWithDB create a CWalletDB if it needs one automagically (eg\n>by passing the walletdb in as a pointer).\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315652287/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315687135",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315687135",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
    "id": 315687135,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTY4NzEzNQ==",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?u=4a9af998e1a560b3f49c3827f453e1bcbe6a5cfb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-17T07:45:51Z",
    "updated_at": "2017-07-17T07:45:51Z",
    "author_association": "MEMBER",
    "body": "@TheBlueMatt another PR then.\r\n\r\nutACK 3986271.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315687135/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315690170",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315690170",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
    "id": 315690170,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTY5MDE3MA==",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?u=7999a16349f0df0fb273fffa18e5a955c9d3f11c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-17T08:03:52Z",
    "updated_at": "2017-07-17T08:03:52Z",
    "author_association": "MEMBER",
    "body": "reutACK 3986271c0accfe896c66a48d3ed884a7553b6413",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315690170/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315749702",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315749702",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
    "id": 315749702,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTc0OTcwMg==",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-17T13:05:21Z",
    "updated_at": "2017-07-17T13:05:21Z",
    "author_association": "MEMBER",
    "body": "reACK https://github.com/bitcoin/bitcoin/pull/10831/commits/4f811059fab9a9121befae09f66b9b12244051f0",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315749702/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315753323",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315753323",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
    "id": 315753323,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTc1MzMyMw==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-17T13:20:25Z",
    "updated_at": "2017-07-17T13:20:25Z",
    "author_association": "CONTRIBUTOR",
    "body": "Nice!\r\nutACK 4f811059fab9a9121befae09f66b9b12244051f0.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315753323/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315764720",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315764720",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
    "id": 315764720,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTc2NDcyMA==",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?u=63e5c438c242094837a9deeda775d77988b508bf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-17T14:02:24Z",
    "updated_at": "2017-07-17T14:02:24Z",
    "author_association": "CONTRIBUTOR",
    "body": "(new revisions are just due to adding a comment in the middle of the patch stack)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315764720/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315786724",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#issuecomment-315786724",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/10831",
    "id": 315786724,
    "node_id": "MDEyOklzc3VlQ29tbWVudDMxNTc4NjcyNA==",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2017-07-17T15:19:39Z",
    "updated_at": "2017-07-17T15:19:39Z",
    "author_association": "CONTRIBUTOR",
    "body": "postumous utACK b0e8e2de8408cbaed9d70914c67b4c9f11397cb7 (lets clean up some of this stuff in 16).",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/315786724/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127619405",
    "pull_request_review_id": 50222851,
    "id": 127619405,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzYxOTQwNQ==",
    "diff_hunk": "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,\n                                                  secret.GetPrivKey(),\n                                                  mapKeyMetadata[pubkey.GetID()]);\n     }\n     return true;\n }\n \n+bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+{\n+    CWalletDB walletdb(*dbw);",
    "path": "src/wallet/wallet.cpp",
    "position": 95,
    "original_position": 92,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "3986271c0accfe896c66a48d3ed884a7553b6413",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "It seems strange that we're creating a db transaction, only to throw it out in a second. I think its safe, but it might be nicer to let AddKeyPubKeyWithDB create a CWalletDB if it needs one automagically (eg by passing the walletdb in as a pointer).",
    "created_at": "2017-07-16T23:05:48Z",
    "updated_at": "2017-07-17T13:46:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127619405",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127619405"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127619405"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127619405/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 209,
    "original_line": 209,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622400",
    "pull_request_review_id": 50225909,
    "id": 127622400,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzYyMjQwMA==",
    "diff_hunk": "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,",
    "path": "src/wallet/wallet.cpp",
    "position": 86,
    "original_position": 83,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "3986271c0accfe896c66a48d3ed884a7553b6413",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Another approach is to use `dbw` as the storage of the transaction. For instance, `CWalletDBWrapper` could keep a `CBD` instance, referenced counted by `CWalletDB`. This could be thread safe too.",
    "created_at": "2017-07-17T01:03:21Z",
    "updated_at": "2017-07-17T13:46:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127622400",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622400"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127622400"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622400/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 200,
    "original_line": 200,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622496",
    "pull_request_review_id": 50226004,
    "id": 127622496,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzYyMjQ5Ng==",
    "diff_hunk": "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,",
    "path": "src/wallet/wallet.cpp",
    "position": 86,
    "original_position": 83,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "3986271c0accfe896c66a48d3ed884a7553b6413",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I'm happy to write such alternative if there is interest.",
    "created_at": "2017-07-17T01:06:20Z",
    "updated_at": "2017-07-17T13:46:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127622496",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622496"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127622496"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127622496/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 200,
    "original_line": 200,
    "side": "RIGHT",
    "in_reply_to_id": 127622400
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626915",
    "pull_request_review_id": 50230551,
    "id": 127626915,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzYyNjkxNQ==",
    "diff_hunk": "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,\n                                                  secret.GetPrivKey(),\n                                                  mapKeyMetadata[pubkey.GetID()]);\n     }\n     return true;\n }\n \n+bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+{\n+    CWalletDB walletdb(*dbw);",
    "path": "src/wallet/wallet.cpp",
    "position": 95,
    "original_position": 92,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "3986271c0accfe896c66a48d3ed884a7553b6413",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This isn't called when we don't need one; the case where we already have a dbwallet calls the WithDB version.  (and changing the prototype of the function would mean changing the function it overrides, which a db handle doesn't even make sense for, and 29 callsites) Unless I'm misunderstanding you.",
    "created_at": "2017-07-17T02:57:03Z",
    "updated_at": "2017-07-17T13:46:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127626915",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626915"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127626915"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626915/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 209,
    "original_line": 209,
    "side": "RIGHT",
    "in_reply_to_id": 127619405
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626971",
    "pull_request_review_id": 50230624,
    "id": 127626971,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzYyNjk3MQ==",
    "diff_hunk": "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,",
    "path": "src/wallet/wallet.cpp",
    "position": 86,
    "original_position": 83,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "3986271c0accfe896c66a48d3ed884a7553b6413",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Seems like a reasonable thing to do, but I didn't even want to consider anything that complex-- I wanted to eliminate the complaint that having many keys is 'slow' for 0.15 because of the bad interactions with hd-wallet and rescan when the keypool isn't big.",
    "created_at": "2017-07-17T02:58:23Z",
    "updated_at": "2017-07-17T13:46:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127626971",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626971"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127626971"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127626971/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 200,
    "original_line": 200,
    "side": "RIGHT",
    "in_reply_to_id": 127622400
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127649698",
    "pull_request_review_id": 50254385,
    "id": 127649698,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzY0OTY5OA==",
    "diff_hunk": "@@ -3183,8 +3201,9 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n                 nEnd = std::max(nEnd, *(setExternalKeyPool.rbegin()) + 1);\n             }\n \n-            if (!walletdb.WritePool(nEnd, CKeyPool(GenerateNewKey(internal), internal)))\n+            if (!walletdb.WritePool(nEnd, CKeyPool(GenerateNewKey(walletdb, internal), internal))) {\n                 throw std::runtime_error(std::string(__func__) + \": writing generated key failed\");\n+            }\n \n             if (internal) {\n                 setInternalKeyPool.insert(nEnd);",
    "path": "src/wallet/wallet.cpp",
    "position": 112,
    "original_position": 109,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "3986271c0accfe896c66a48d3ed884a7553b6413",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "If we increase the default keypool size, the `LogPrintf(\"keypool added key %d` message below shouldn't be logged for every key. Or at least moved to a debug category. It's ugly to log that many messages at first run, and it is performance overhead too.",
    "created_at": "2017-07-17T08:04:17Z",
    "updated_at": "2017-07-17T13:46:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127649698",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127649698"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127649698"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127649698/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3212,
    "original_line": 3212,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127662078",
    "pull_request_review_id": 50267883,
    "id": 127662078,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzY2MjA3OA==",
    "diff_hunk": "@@ -100,27 +100,29 @@ CPubKey CWallet::GenerateNewKey(bool internal)\n \n     // use HD key derivation if HD was enabled during wallet creation\n     if (IsHDEnabled()) {\n-        DeriveNewChildKey(metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n+        DeriveNewChildKey(walletdb, metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n     } else {\n         secret.MakeNewKey(fCompressed);\n     }\n \n     // Compressed public keys were introduced in version 0.6.0\n-    if (fCompressed)\n+    if (fCompressed) {",
    "path": "src/wallet/wallet.cpp",
    "position": 21,
    "original_position": 21,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "4f811059fab9a9121befae09f66b9b12244051f0",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Unrelated, unless you want to fix all style issues?",
    "created_at": "2017-07-17T09:16:51Z",
    "updated_at": "2017-07-17T13:46:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127662078",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127662078"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127662078"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127662078/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 109,
    "original_line": 109,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127700902",
    "pull_request_review_id": 50310996,
    "id": 127700902,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzcwMDkwMg==",
    "diff_hunk": "@@ -100,27 +100,29 @@ CPubKey CWallet::GenerateNewKey(bool internal)\n \n     // use HD key derivation if HD was enabled during wallet creation\n     if (IsHDEnabled()) {\n-        DeriveNewChildKey(metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n+        DeriveNewChildKey(walletdb, metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n     } else {\n         secret.MakeNewKey(fCompressed);\n     }\n \n     // Compressed public keys were introduced in version 0.6.0\n-    if (fCompressed)\n+    if (fCompressed) {",
    "path": "src/wallet/wallet.cpp",
    "position": 21,
    "original_position": 21,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "4f811059fab9a9121befae09f66b9b12244051f0",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I don't think we should nit people doing partial style issue fixes unless it affects reviewability.",
    "created_at": "2017-07-17T13:01:54Z",
    "updated_at": "2017-07-17T13:46:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127700902",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127700902"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127700902"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127700902/reactions",
      "total_count": 2,
      "+1": 2,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 109,
    "original_line": 109,
    "side": "RIGHT",
    "in_reply_to_id": 127662078
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127702860",
    "pull_request_review_id": 50313253,
    "id": 127702860,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzcwMjg2MA==",
    "diff_hunk": "@@ -100,27 +100,29 @@ CPubKey CWallet::GenerateNewKey(bool internal)\n \n     // use HD key derivation if HD was enabled during wallet creation\n     if (IsHDEnabled()) {\n-        DeriveNewChildKey(metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n+        DeriveNewChildKey(walletdb, metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n     } else {\n         secret.MakeNewKey(fCompressed);\n     }\n \n     // Compressed public keys were introduced in version 0.6.0\n-    if (fCompressed)\n+    if (fCompressed) {",
    "path": "src/wallet/wallet.cpp",
    "position": 21,
    "original_position": 21,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "4f811059fab9a9121befae09f66b9b12244051f0",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes, this seems to be a \"damned if you do, damned if you don't\" thing.\r\n- If you deliberately make style fixes to code you touch, you get comments that it's unrelated\r\n- If you deliberately don't make style fixes to code you touch, you get questions why you didn't update the code for the style guidelines\r\n\r\nI think both are valid, unless it makes review-ability in which case it could still be done in a separate commit in the same PR.",
    "created_at": "2017-07-17T13:10:34Z",
    "updated_at": "2017-07-17T13:46:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127702860",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127702860"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127702860"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127702860/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 109,
    "original_line": 109,
    "side": "RIGHT",
    "in_reply_to_id": 127662078
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127705930",
    "pull_request_review_id": 50316634,
    "id": 127705930,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzcwNTkzMA==",
    "diff_hunk": "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;",
    "path": "src/wallet/wallet.cpp",
    "position": 69,
    "original_position": 66,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "4f811059fab9a9121befae09f66b9b12244051f0",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I don't understand this code.\r\nGiven that `pwalletdbEncryption` is not used in `CCryptoKeyStore::AddKeyPubKey`, could this code be moved before `if (!CCryptoKeyStore::AddKeyPubKey`? This would avoid some awkward duplication here.\r\nOr is it used indirectly? This looks really sneaky. Please add a comment if you need to keep it at least, so that no one else gets my bad idea.",
    "created_at": "2017-07-17T13:23:28Z",
    "updated_at": "2017-07-17T13:46:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127705930",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127705930"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127705930"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127705930/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 186,
    "original_line": 186,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127709130",
    "pull_request_review_id": 50320377,
    "id": 127709130,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzcwOTEzMA==",
    "diff_hunk": "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;",
    "path": "src/wallet/wallet.cpp",
    "position": 69,
    "original_position": 66,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "4f811059fab9a9121befae09f66b9b12244051f0",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "It's used-- alas,  the whole purpose of that pre-existing terrible variable is because CCryptoKeyStore::AddKeyPubKey  calls AddCryptedKey which on actual wallets is overridden to the function below.  CCryptoKeyStore rightfully has no concept of wallet databases, so the variable is used to tunnel through it, to get it to the AddCryptedKey override below.  This infrastructure was preexisting because the encryption setup needs it.    I can add a comment explaining it.  Some people have suggested larger refactors to remove this knitted maze, but it's clearly out of scope for now. ",
    "created_at": "2017-07-17T13:36:49Z",
    "updated_at": "2017-07-17T13:46:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127709130",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127709130"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127709130"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127709130/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 186,
    "original_line": 186,
    "side": "RIGHT",
    "in_reply_to_id": 127705930
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127711641",
    "pull_request_review_id": 50323222,
    "id": 127711641,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzcxMTY0MQ==",
    "diff_hunk": "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;",
    "path": "src/wallet/wallet.cpp",
    "position": 69,
    "original_position": 66,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "4f811059fab9a9121befae09f66b9b12244051f0",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Added a comment",
    "created_at": "2017-07-17T13:46:37Z",
    "updated_at": "2017-07-17T13:46:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127711641",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127711641"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127711641"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127711641/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 186,
    "original_line": 186,
    "side": "RIGHT",
    "in_reply_to_id": 127705930
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127715298",
    "pull_request_review_id": 50327462,
    "id": 127715298,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzcxNTI5OA==",
    "diff_hunk": "@@ -3183,8 +3201,9 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n                 nEnd = std::max(nEnd, *(setExternalKeyPool.rbegin()) + 1);\n             }\n \n-            if (!walletdb.WritePool(nEnd, CKeyPool(GenerateNewKey(internal), internal)))\n+            if (!walletdb.WritePool(nEnd, CKeyPool(GenerateNewKey(walletdb, internal), internal))) {\n                 throw std::runtime_error(std::string(__func__) + \": writing generated key failed\");\n+            }\n \n             if (internal) {\n                 setInternalKeyPool.insert(nEnd);",
    "path": "src/wallet/wallet.cpp",
    "position": 112,
    "original_position": 109,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "3986271c0accfe896c66a48d3ed884a7553b6413",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Aggregated to a summary line.",
    "created_at": "2017-07-17T14:00:16Z",
    "updated_at": "2017-07-17T14:00:16Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127715298",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127715298"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127715298"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127715298/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3212,
    "original_line": 3212,
    "side": "RIGHT",
    "in_reply_to_id": 127649698
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127715733",
    "pull_request_review_id": 50327936,
    "id": 127715733,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzcxNTczMw==",
    "diff_hunk": "@@ -100,27 +100,29 @@ CPubKey CWallet::GenerateNewKey(bool internal)\n \n     // use HD key derivation if HD was enabled during wallet creation\n     if (IsHDEnabled()) {\n-        DeriveNewChildKey(metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n+        DeriveNewChildKey(walletdb, metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n     } else {\n         secret.MakeNewKey(fCompressed);\n     }\n \n     // Compressed public keys were introduced in version 0.6.0\n-    if (fCompressed)\n+    if (fCompressed) {",
    "path": "src/wallet/wallet.cpp",
    "position": 21,
    "original_position": 21,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "4f811059fab9a9121befae09f66b9b12244051f0",
    "user": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I have been trying to limit them to things that will show up in the same patch hunks, and only changes which I'm pretty sure won't break review.   I'm happy to do what other people want, though I prefer to at least fix braces (because I dislike reviewing the risky looking unbraced code myself)-- but ultimately I just need clear guidance to avoid the damned if/don't.",
    "created_at": "2017-07-17T14:01:56Z",
    "updated_at": "2017-07-17T14:01:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127715733",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127715733"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127715733"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127715733/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 109,
    "original_line": 109,
    "side": "RIGHT",
    "in_reply_to_id": 127662078
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127737165",
    "pull_request_review_id": 50351530,
    "id": 127737165,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDEyNzczNzE2NQ==",
    "diff_hunk": "@@ -162,33 +164,49 @@ void CWallet::DeriveNewChildKey(CKeyMetadata& metadata, CKey& secret, bool inter\n     secret = childKey.key;\n     metadata.hdMasterKeyID = hdChain.masterKeyID;\n     // update the chain model in the database\n-    if (!CWalletDB(*dbw).WriteHDChain(hdChain))\n+    if (!walletdb.WriteHDChain(hdChain))\n         throw std::runtime_error(std::string(__func__) + \": Writing HD chain model failed\");\n }\n \n-bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+bool CWallet::AddKeyPubKeyWithDB(CWalletDB &walletdb, const CKey& secret, const CPubKey &pubkey)\n {\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n-    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n+\n+    bool needsDB = !pwalletdbEncryption;\n+    if (needsDB) {\n+        pwalletdbEncryption = &walletdb;\n+    }\n+    if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey)) {\n+        if (needsDB) pwalletdbEncryption = NULL;\n         return false;\n+    }\n+    if (needsDB) pwalletdbEncryption = NULL;\n \n     // check if we need to remove from watch-only\n     CScript script;\n     script = GetScriptForDestination(pubkey.GetID());\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n     script = GetScriptForRawPubKey(pubkey);\n-    if (HaveWatchOnly(script))\n+    if (HaveWatchOnly(script)) {\n         RemoveWatchOnly(script);\n+    }\n \n     if (!IsCrypted()) {\n-        return CWalletDB(*dbw).WriteKey(pubkey,\n+        return walletdb.WriteKey(pubkey,\n                                                  secret.GetPrivKey(),\n                                                  mapKeyMetadata[pubkey.GetID()]);\n     }\n     return true;\n }\n \n+bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n+{\n+    CWalletDB walletdb(*dbw);",
    "path": "src/wallet/wallet.cpp",
    "position": 95,
    "original_position": 92,
    "commit_id": "b0e8e2de8408cbaed9d70914c67b4c9f11397cb7",
    "original_commit_id": "3986271c0accfe896c66a48d3ed884a7553b6413",
    "user": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I was confused, sorry.",
    "created_at": "2017-07-17T15:17:18Z",
    "updated_at": "2017-07-17T15:17:18Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127737165",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127737165"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/10831#discussion_r127737165"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/10831"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/127737165/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 209,
    "original_line": 209,
    "side": "RIGHT",
    "in_reply_to_id": 127619405
  }
]