[
  {
    "sha": "b1c2370dde9ade180c638e5d9a4797f085322b5b",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiMWMyMzcwZGRlOWFkZTE4MGM2MzhlNWQ5YTQ3OTdmMDg1MzIyYjVi",
    "commit": {
      "author": {
        "name": "Wladimir J. van der Laan",
        "email": "laanwj@gmail.com",
        "date": "2018-02-06T18:27:13Z"
      },
      "committer": {
        "name": "Wladimir J. van der Laan",
        "email": "laanwj@gmail.com",
        "date": "2018-02-06T19:10:09Z"
      },
      "message": "http: Join worker threads before deleting work queue\n\nThis prevents a potential race condition if control flow ends up in\n`ShutdownHTTPServer` before the thread gets to `queue->Run()`,\ndeleting the work queue while workers are still going to use it.\n\nMeant to fix #12362.\n\nSigned-off-by: Wladimir J. van der Laan <laanwj@gmail.com>",
      "tree": {
        "sha": "02ebdb4ac8d4e0903692da747acb4e4b94801b92",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/02ebdb4ac8d4e0903692da747acb4e4b94801b92"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b1c2370dde9ade180c638e5d9a4797f085322b5b",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b1c2370dde9ade180c638e5d9a4797f085322b5b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b1c2370dde9ade180c638e5d9a4797f085322b5b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b1c2370dde9ade180c638e5d9a4797f085322b5b/comments",
    "author": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1462bde767a121233118c04c5629bd9de1ba0f16",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1462bde767a121233118c04c5629bd9de1ba0f16",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1462bde767a121233118c04c5629bd9de1ba0f16"
      }
    ],
    "stats": {
      "total": 8,
      "additions": 6,
      "deletions": 2
    },
    "files": [
      {
        "sha": "a554dcb097166be004e192fd635b81c9d59e1f4b",
        "filename": "src/httpserver.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 2,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b1c2370dde9ade180c638e5d9a4797f085322b5b/src/httpserver.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b1c2370dde9ade180c638e5d9a4797f085322b5b/src/httpserver.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/httpserver.cpp?ref=b1c2370dde9ade180c638e5d9a4797f085322b5b",
        "patch": "@@ -449,6 +449,7 @@ bool UpdateHTTPServerLogging(bool enable) {\n \n std::thread threadHTTP;\n std::future<bool> threadResult;\n+static std::vector<std::thread> g_thread_http_workers;\n \n bool StartHTTPServer()\n {\n@@ -460,8 +461,7 @@ bool StartHTTPServer()\n     threadHTTP = std::thread(std::move(task), eventBase, eventHTTP);\n \n     for (int i = 0; i < rpcThreads; i++) {\n-        std::thread rpc_worker(HTTPWorkQueueRun, workQueue);\n-        rpc_worker.detach();\n+        g_thread_http_workers.emplace_back(HTTPWorkQueueRun, workQueue);\n     }\n     return true;\n }\n@@ -487,6 +487,10 @@ void StopHTTPServer()\n     if (workQueue) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP worker threads to exit\\n\");\n         workQueue->WaitExit();\n+        for (auto& thread: g_thread_http_workers) {\n+            thread.join();\n+        }\n+        g_thread_http_workers.clear();\n         delete workQueue;\n         workQueue = nullptr;\n     }"
      }
    ]
  },
  {
    "sha": "f94665466ed50e868c98b1a1c708ad5767727bb6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmOTQ2NjU0NjZlZDUwZTg2OGM5OGIxYTFjNzA4YWQ1NzY3NzI3YmI2",
    "commit": {
      "author": {
        "name": "Wladimir J. van der Laan",
        "email": "laanwj@gmail.com",
        "date": "2018-02-06T19:32:33Z"
      },
      "committer": {
        "name": "Wladimir J. van der Laan",
        "email": "laanwj@gmail.com",
        "date": "2018-02-06T19:32:51Z"
      },
      "message": "http: Remove WaitExit from WorkQueue\n\nThis function, which waits for all threads to exit, is no longer needed\nnow that threads are joined instead.\n\nSigned-off-by: Wladimir J. van der Laan <laanwj@gmail.com>",
      "tree": {
        "sha": "cd933a3e7b4e3e3930ec37bb6651dc6523ebb3aa",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cd933a3e7b4e3e3930ec37bb6651dc6523ebb3aa"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f94665466ed50e868c98b1a1c708ad5767727bb6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f94665466ed50e868c98b1a1c708ad5767727bb6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/f94665466ed50e868c98b1a1c708ad5767727bb6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f94665466ed50e868c98b1a1c708ad5767727bb6/comments",
    "author": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b1c2370dde9ade180c638e5d9a4797f085322b5b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b1c2370dde9ade180c638e5d9a4797f085322b5b",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b1c2370dde9ade180c638e5d9a4797f085322b5b"
      }
    ],
    "stats": {
      "total": 11,
      "additions": 1,
      "deletions": 10
    },
    "files": [
      {
        "sha": "5000b0e2455df9ae31049903233892539e8d6a8a",
        "filename": "src/httpserver.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 10,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f94665466ed50e868c98b1a1c708ad5767727bb6/src/httpserver.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f94665466ed50e868c98b1a1c708ad5767727bb6/src/httpserver.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/httpserver.cpp?ref=f94665466ed50e868c98b1a1c708ad5767727bb6",
        "patch": "@@ -99,8 +99,7 @@ class WorkQueue\n                                  numThreads(0)\n     {\n     }\n-    /** Precondition: worker threads have all stopped\n-     * (call WaitExit)\n+    /** Precondition: worker threads have all stopped (they have been joined).\n      */\n     ~WorkQueue()\n     {\n@@ -141,13 +140,6 @@ class WorkQueue\n         running = false;\n         cond.notify_all();\n     }\n-    /** Wait for worker threads to exit */\n-    void WaitExit()\n-    {\n-        std::unique_lock<std::mutex> lock(cs);\n-        while (numThreads > 0)\n-            cond.wait(lock);\n-    }\n };\n \n struct HTTPPathHandler\n@@ -486,7 +478,6 @@ void StopHTTPServer()\n     LogPrint(BCLog::HTTP, \"Stopping HTTP server\\n\");\n     if (workQueue) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP worker threads to exit\\n\");\n-        workQueue->WaitExit();\n         for (auto& thread: g_thread_http_workers) {\n             thread.join();\n         }"
      }
    ]
  },
  {
    "sha": "11e01515fe0fbc7823d4111ad6e016a02c485a78",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxMWUwMTUxNWZlMGZiYzc4MjNkNDExMWFkNmUwMTZhMDJjNDg1YTc4",
    "commit": {
      "author": {
        "name": "Wladimir J. van der Laan",
        "email": "laanwj@gmail.com",
        "date": "2018-02-07T08:53:46Z"
      },
      "committer": {
        "name": "Wladimir J. van der Laan",
        "email": "laanwj@gmail.com",
        "date": "2018-02-07T08:53:46Z"
      },
      "message": "http: Remove numThreads and ThreadCounter\n\nThe HTTP worker thread counter, as well as the RAII object that was used\nto maintain it, is unused now, so can be removed.\n\nSigned-off-by: Wladimir J. van der Laan <laanwj@gmail.com>",
      "tree": {
        "sha": "62ec46dc08c97ce9c4c619b9c9b2b2b0e5e32fed",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/62ec46dc08c97ce9c4c619b9c9b2b2b0e5e32fed"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/11e01515fe0fbc7823d4111ad6e016a02c485a78",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/11e01515fe0fbc7823d4111ad6e016a02c485a78",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/11e01515fe0fbc7823d4111ad6e016a02c485a78",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/11e01515fe0fbc7823d4111ad6e016a02c485a78/comments",
    "author": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f94665466ed50e868c98b1a1c708ad5767727bb6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f94665466ed50e868c98b1a1c708ad5767727bb6",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f94665466ed50e868c98b1a1c708ad5767727bb6"
      }
    ],
    "stats": {
      "total": 23,
      "additions": 1,
      "deletions": 22
    },
    "files": [
      {
        "sha": "f78ce13737256da2dc0c23d55716368caef8aa0f",
        "filename": "src/httpserver.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 22,
        "changes": 23,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/11e01515fe0fbc7823d4111ad6e016a02c485a78/src/httpserver.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/11e01515fe0fbc7823d4111ad6e016a02c485a78/src/httpserver.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/httpserver.cpp?ref=11e01515fe0fbc7823d4111ad6e016a02c485a78",
        "patch": "@@ -73,30 +73,10 @@ class WorkQueue\n     std::deque<std::unique_ptr<WorkItem>> queue;\n     bool running;\n     size_t maxDepth;\n-    int numThreads;\n-\n-    /** RAII object to keep track of number of running worker threads */\n-    class ThreadCounter\n-    {\n-    public:\n-        WorkQueue &wq;\n-        explicit ThreadCounter(WorkQueue &w): wq(w)\n-        {\n-            std::lock_guard<std::mutex> lock(wq.cs);\n-            wq.numThreads += 1;\n-        }\n-        ~ThreadCounter()\n-        {\n-            std::lock_guard<std::mutex> lock(wq.cs);\n-            wq.numThreads -= 1;\n-            wq.cond.notify_all();\n-        }\n-    };\n \n public:\n     explicit WorkQueue(size_t _maxDepth) : running(true),\n-                                 maxDepth(_maxDepth),\n-                                 numThreads(0)\n+                                 maxDepth(_maxDepth)\n     {\n     }\n     /** Precondition: worker threads have all stopped (they have been joined).\n@@ -118,7 +98,6 @@ class WorkQueue\n     /** Thread function */\n     void Run()\n     {\n-        ThreadCounter count(*this);\n         while (true) {\n             std::unique_ptr<WorkItem> i;\n             {"
      }
    ]
  }
]