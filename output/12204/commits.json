[
  {
    "sha": "5b8b387752e8c493a8e87795ae6ddb78b45b1a5d",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1YjhiMzg3NzUyZThjNDkzYThlODc3OTVhZTZkZGI3OGI0NWIxYTVk",
    "commit": {
      "author": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2017-10-05T17:43:47Z"
      },
      "committer": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2018-02-15T18:31:45Z"
      },
      "message": "Fix overly eager BIP30 bypass",
      "tree": {
        "sha": "5db4d9f72c9b45ab91457d7c643893086a528ab5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5db4d9f72c9b45ab91457d7c643893086a528ab5"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5b8b387752e8c493a8e87795ae6ddb78b45b1a5d",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5b8b387752e8c493a8e87795ae6ddb78b45b1a5d",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/5b8b387752e8c493a8e87795ae6ddb78b45b1a5d",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5b8b387752e8c493a8e87795ae6ddb78b45b1a5d/comments",
    "author": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "cad504bf4c302f7a72e0a0e191f3fdbafda7340f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/cad504bf4c302f7a72e0a0e191f3fdbafda7340f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/cad504bf4c302f7a72e0a0e191f3fdbafda7340f"
      }
    ],
    "stats": {
      "total": 55,
      "additions": 54,
      "deletions": 1
    },
    "files": [
      {
        "sha": "cf58504eb148a8e50ee28d06289d177744b79ba5",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 54,
        "deletions": 1,
        "changes": 55,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5b8b387752e8c493a8e87795ae6ddb78b45b1a5d/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5b8b387752e8c493a8e87795ae6ddb78b45b1a5d/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=5b8b387752e8c493a8e87795ae6ddb78b45b1a5d",
        "patch": "@@ -1858,12 +1858,65 @@ bool CChainState::ConnectBlock(const CBlock& block, CValidationState& state, CBl\n     // before the first had been spent.  Since those coinbases are sufficiently buried its no longer possible to create further\n     // duplicate transactions descending from the known pairs either.\n     // If we're on the known chain at height greater than where BIP34 activated, we can save the db accesses needed for the BIP30 check.\n+\n+    // BIP34 requires that a block at height X (block X) has its coinbase\n+    // scriptSig start with a CScriptNum of X (indicated height X).  The above\n+    // logic of no longer requiring BIP30 once BIP34 activates is flawed in the\n+    // case that there is a block X before the BIP34 height of 227,931 which has\n+    // an indicated height Y where Y is greater than X.  The coinbase for block\n+    // X would also be a valid coinbase for block Y, which could be a BIP30\n+    // violation.  An exhaustive search of all mainnet coinbases before the\n+    // BIP34 height which have an indicated height greater than the block height\n+    // reveals many occurrences. The 3 lowest indicated heights found are\n+    // 209,921, 490,897, and 1,983,702 and thus coinbases for blocks at these 3\n+    // heights would be the first opportunity for BIP30 to be violated.\n+\n+    // The search reveals a great many blocks which have an indicated height\n+    // greater than 1,983,702, so we simply remove the optimization to skip\n+    // BIP30 checking for blocks at height 1,983,702 or higher.  Before we reach\n+    // that block in another 25 years or so, we should take advantage of a\n+    // future consensus change to do a new and improved version of BIP34 that\n+    // will actually prevent ever creating any duplicate coinbases in the\n+    // future.\n+    static constexpr int BIP34_IMPLIES_BIP30_LIMIT = 1983702;\n+\n+    // There is no potential to create a duplicate coinbase at block 209,921\n+    // because this is still before the BIP34 height and so explicit BIP30\n+    // checking is still active.\n+\n+    // The final case is block 176,684 which has an indicated height of\n+    // 490,897. Unfortunately, this issue was not discovered until about 2 weeks\n+    // before block 490,897 so there was not much opportunity to address this\n+    // case other than to carefully analyze it and determine it would not be a\n+    // problem. Block 490,897 was, in fact, mined with a different coinbase than\n+    // block 176,684, but it is important to note that even if it hadn't been or\n+    // is remined on an alternate fork with a duplicate coinbase, we would still\n+    // not run into a BIP30 violation.  This is because the coinbase for 176,684\n+    // is spent in block 185,956 in transaction\n+    // d4f7fbbf92f4a3014a230b2dc70b8058d02eb36ac06b4a0736d9d60eaa9e8781.  This\n+    // spending transaction can't be duplicated because it also spends coinbase\n+    // 0328dd85c331237f18e781d692c92de57649529bd5edf1d01036daea32ffde29.  This\n+    // coinbase has an indicated height of over 4.2 billion, and wouldn't be\n+    // duplicatable until that height, and it's currently impossible to create a\n+    // chain that long. Nevertheless we may wish to consider a future soft fork\n+    // which retroactively prevents block 490,897 from creating a duplicate\n+    // coinbase. The two historical BIP30 violations often provide a confusing\n+    // edge case when manipulating the UTXO and it would be simpler not to have\n+    // another edge case to deal with.\n+\n+    // testnet3 has no blocks before the BIP34 height with indicated heights\n+    // post BIP34 before approximately height 486,000,000 and presumably will\n+    // be reset before it reaches block 1,983,702 and starts doing unnecessary\n+    // BIP30 checking again.\n     assert(pindex->pprev);\n     CBlockIndex *pindexBIP34height = pindex->pprev->GetAncestor(chainparams.GetConsensus().BIP34Height);\n     //Only continue to enforce if we're below BIP34 activation height or the block hash at that height doesn't correspond.\n     fEnforceBIP30 = fEnforceBIP30 && (!pindexBIP34height || !(pindexBIP34height->GetBlockHash() == chainparams.GetConsensus().BIP34Hash));\n \n-    if (fEnforceBIP30) {\n+    // TODO: Remove BIP30 checking from block height 1,983,702 on, once we have a\n+    // consensus change that ensures coinbases at those heights can not\n+    // duplicate earlier coinbases.\n+    if (fEnforceBIP30 || pindex->nHeight >= BIP34_IMPLIES_BIP30_LIMIT) {\n         for (const auto& tx : block.vtx) {\n             for (size_t o = 0; o < tx->vout.size(); o++) {\n                 if (view.HaveCoin(COutPoint(tx->GetHash(), o))) {"
      }
    ]
  }
]