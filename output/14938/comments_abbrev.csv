Sjors,2018-12-12T17:14:44Z,"Some context:\n* https://github.com/bitcoin/bitcoin/pull/14075#issuecomment-446547958 ""Import watch only pubkeys to the keypool if private keys are disabled"" currently has `importmulti` add stuff to the keypool \n* I had difficulty creating a test for handling PSBT in watch-only wallets, where I wanted to mock the signed PSBT by importing the same private private keys into a second wallet and si",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-446667738,446667738,
DrahtBot,2018-12-12T21:31:40Z,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#15226](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15226.html) (Allow creating blank (empty) wallets (alter",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-446751804,446751804,
hebasto,2018-12-13T06:19:41Z,Concept ACK.,https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-446855488,446855488,
laanwj,2018-12-13T09:50:51Z,"Concept ACK\n\n@jonasschnelli is this in line with your idea of supporting hardware wallets?",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-446907141,446907141,
Sjors,2018-12-13T18:39:12Z,"It's definitely in line with _my_ idea of adding hardware wallets :-)\n\nSee also #14145.",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-447074688,447074688,
jonasschnelli,2018-12-13T19:23:30Z,"I'm not opposed against this,... but this seems not to be in line with hardware wallet support (yet). Because `sethdseed` does set the secret master key rather than the extended public account key.\nExposing the seed defeats the purpose of a hardware wallet.\n\nBut once this is turned into ""watch-only-HD""/ public-key-derivation, then I guess this is useful.\n\nThe question then would be, if w",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-447089007,447089007,
achow101,2018-12-19T19:21:34Z,"Calling `encryptwallet` on an empty wallet does not work. I'm getting;\n\n    DeriveNewSeed: AddKeyPubKey failed\n\nI would expect either that we can't encrypt an empty wallet (bummer, because then we can't have a wallet encrypted from the very beginning), or that it would encrypt and have a newly generated seed (which is what I think you were trying to do).\n\nEdit: https://github.com/achow",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-448713598,448713598,
Sjors,2018-12-20T15:31:59Z,"@achow101 thanks, I see you included that commit in #15006\n\nAddressed @promag's, @practicalswift 's and @achow101's comments.\n\nRebased because Travis was going nuts.\n",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-449037025,449037025,
jnewbery,2018-12-20T19:28:50Z,"Concept ACK. Had a *very* quick skim and changes look sensible.\n\nWill review once Travis is happy.",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-449110017,449110017,
Sjors,2018-12-21T16:51:13Z,"Travis is happy now.\n\nAdded `LOCK(cs_wallet)` to `IsHDEnabled` because it uses `CanSupportFeature` which has an `AssertLockHeld`.\n\nI added a new wallet version `FEATURE_ALLOW_EMPTY` which is set as the minimum when creating an empty wallet. When creating a non-empty wallet we stick to `FEATURE_PRE_SPLIT_KEYPOOL` as the minimum version.",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-449439702,449439702,
achow101,2018-12-24T15:32:58Z,"I don't think it is necessary to set different version numbers depending on whether the wallet can be empty. This is effectively reintroducing the optional version stuff that we had done for HD wallets and HD chain split, and reconciling those was a major pain. I don't see why it is necessary to do that again.",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-449747081,449747081,
Sjors,2018-12-25T16:23:45Z,"What do you mean by ""optional version stuff""?\n\nThe alternative seems to be to disallow <= v0.17 nodes from opening a v0.18 wallet, even though only a minitory of users need the empty wallet feature.",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-449861408,449861408,
achow101,2018-12-25T16:43:57Z,"> What do you mean by ""optional version stuff""?\n\nThe original HD wallet stuff was optional and the option was determined by the wallet version number. Non-HD wallets had a lower version number than HD wallets. So an optional feature was determined by the version number. But later when a change to the wallet affected both non-HD and HD wallets and required a version number bump, this optional f",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-449862397,449862397,
laanwj,2019-01-02T12:54:34Z,"Concept ACK as this is a dependency for #15006\n\nutACK 8ce17c0fb0ea51e8047db3d5a23bef747bbedf3a",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-450856400,450856400,
promag,2019-01-03T19:11:14Z,Should this option be exposed in the GUI (after #13100)?,https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-451245899,451245899,
achow101,2019-01-03T19:35:30Z,@promag I think it should,https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-451252802,451252802,
jonasschnelli,2019-01-03T20:05:21Z,"Tested a bit.\nIf I create an empty `createwallet dummy false true` and generate an address via GUI I get this (invalid) state:\n<img width=""599"" alt=""bildschirmfoto 2019-01-03 um 10 03 24"" src=""https://user-images.githubusercontent.com/178464/50658885-d526f580-0f3e-11e9-9962-a7d1c92484b2.png"">\n\n`getnewaddress` gives me `Error: Keypool ran out, please call keypoolrefill first (code -12)` but",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-451261046,451261046,
Sjors,2019-01-07T15:08:56Z,"@jonasschnelli an empty wallet does not have an HD seed, so there is no way to refill the keypool. Calling `sethdseed` will add such a seed.\n\nI'm surprised the GUI doesn't handle this correctly, since the keypool could already run out before this change. Normally it just greys out the new address button. I'll try to reproduce.\n\n",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-451965106,451965106,
Sjors,2019-01-09T13:35:38Z,"@achow101 wrote inline:\n\n> I think instead of using a version number you should use a wallet flag that is required. The flag can be unset once the wallet is no longer empty. This would remove the need for a new version number while still preventing older software from opening the wallet.\n\nI'm happy with either option. Mandatory flags explicitly say what a wallet can't do, which is arguably",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-452698376,452698376,
laanwj,2019-01-16T12:49:13Z,"> I'm surprised the GUI doesn't handle this correctly, since the keypool could already run out before this change. Normally it just greys out the new address button. I'll try to reproduce.\n\nRight—apparently the GUI doesn't do correct error handling here, it should handle the case where it's impossible to generate an address.",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-454767420,454767420,
achow101,2019-01-21T19:31:11Z,"> I'm surprised the GUI doesn't handle this correctly, since the keypool could already run out before this change. Normally it just greys out the new address button. I'll try to reproduce.\n\nThis error is because the grey out condition is that private keys are disable.",https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-456178504,456178504,
Sjors,2019-01-22T17:15:32Z,Closing in favour of #15226.,https://github.com/bitcoin/bitcoin/pull/14938#issuecomment-456483152,456483152,
promag,2018-12-12T22:01:01Z,"nit\n```\n- The RPC `createwallet` has now the optional `empty` argument that allows to create empty wallets.\n```",https://github.com/bitcoin/bitcoin/pull/14938#discussion_r241201484,241201484,doc/release-notes-14936.md
promag,2018-12-12T22:02:56Z,"nit, could use named arguments.",https://github.com/bitcoin/bitcoin/pull/14938#discussion_r241201986,241201986,test/functional/wallet_createwallet.py
promag,2018-12-12T22:07:05Z,"nit\n```cpp\nif (!HasHDSeed()) throw std::runtime_error(std::string(__func__) + "": No HD Seed"");\n\nDeriveNewChildKey(batch, metadata, secret, (CanSupportFeature(FEATURE_HD_SPLIT) ? internal : false));\n```",https://github.com/bitcoin/bitcoin/pull/14938#discussion_r241203267,241203267,src/wallet/wallet.cpp
promag,2018-12-12T22:08:48Z,"nit, `create_empty`.",https://github.com/bitcoin/bitcoin/pull/14938#discussion_r241203782,241203782,src/wallet/rpcwallet.cpp
practicalswift,2018-12-14T10:10:26Z,"Missing whitespace after `,` – applies throughout this PR :-)",https://github.com/bitcoin/bitcoin/pull/14938#discussion_r241702874,241702874,test/functional/wallet_createwallet.py
Sjors,2018-12-14T17:32:04Z,Thanks @practicalswift. What Python linter are you running that Travis isn't?,https://github.com/bitcoin/bitcoin/pull/14938#discussion_r241832335,241832335,test/functional/wallet_createwallet.py
practicalswift,2018-12-14T17:45:55Z,"@Sjors We run `flake8` in Travis but the rule `E231` (""missing whitespace after ','"") isn't enabled. Please consider opening a PR fixing that :-)",https://github.com/bitcoin/bitcoin/pull/14938#discussion_r241836272,241836272,test/functional/wallet_createwallet.py
achow101,2018-12-19T17:44:16Z,Call `HasHDSeed` instead of doing the same check here,https://github.com/bitcoin/bitcoin/pull/14938#discussion_r243012488,243012488,src/wallet/wallet.cpp
achow101,2018-12-19T17:46:40Z,"Instead of an empty else if block, change the else to be `else if (!create_empty)`.",https://github.com/bitcoin/bitcoin/pull/14938#discussion_r243013303,243013303,src/wallet/wallet.cpp
Sjors,2018-12-20T15:17:20Z,Good idea,https://github.com/bitcoin/bitcoin/pull/14938#discussion_r243307924,243307924,test/functional/wallet_createwallet.py
Sjors,2018-12-20T17:03:16Z,@jnewbery this test fails with `--usecli` if I use a boolean `True` rather than a string `'true'`. Is that by design? Two of the Travis machines don't seem to like this syntax either.,https://github.com/bitcoin/bitcoin/pull/14938#discussion_r243347539,243347539,test/functional/wallet_createwallet.py
jnewbery,2018-12-20T19:27:00Z,"Looks like this is a variation of the issue fixed here: https://github.com/bitcoin/bitcoin/commit/a3fa4d6a6acf19d640a1d5879a00aa1f059e2380 but for named arguments. Fix it with something like:\n\n```\ndiff --git a/test/functional/test_framework/test_node.py b/test/functional/test_framework/test_node.py\nindex 031a8824b..8225992c2 100755\n--- a/test/functional/test_framework/test_node.py\n+++ ",https://github.com/bitcoin/bitcoin/pull/14938#discussion_r243390546,243390546,test/functional/wallet_createwallet.py
Empact,2018-12-20T22:26:57Z,"Why not stay with FEATURE_LATEST here? It is currently equal to FEATURE_PRE_SPLIT_KEYPOOL, and presumably we will want to stick with current feature support when we make the next breaking change.",https://github.com/bitcoin/bitcoin/pull/14938#discussion_r243437464,243437464,src/wallet/wallet.cpp
Sjors,2018-12-21T12:58:09Z,"@Empact ~in an earlier version I added a new feature version for this, but then I realized it wasn't necessary. Forgot to remove this bit. Fixed.~ On second thought I'm worried that previous versions would treat this as a non-HD wallet and upgrade it, which may not be what the user intended. So it seems safer to add a new version number.",https://github.com/bitcoin/bitcoin/pull/14938#discussion_r243574309,243574309,src/wallet/wallet.cpp
laanwj,2019-01-02T12:49:05Z,"maybe roll this logic (which is repeated below) into a function `IsEmpty()`?\n\nEdit: hmm I guess empty is a bad name here as it could also imply that the wallet has no transactions, or no funds…",https://github.com/bitcoin/bitcoin/pull/14938#discussion_r244727885,244727885,src/wallet/wallet.cpp
achow101,2019-01-07T16:19:10Z,I think instead of using a version number you should use a wallet flag that is required. The flag can be unset once the wallet is no longer empty. This would remove the need for a new version number while still preventing older software from opening the wallet.,https://github.com/bitcoin/bitcoin/pull/14938#discussion_r245711115,245711115,src/wallet/wallet.cpp
ryanofsky,2019-01-18T16:59:04Z,"Why do you need to check create_empty here if TopUpKeyPool already returns true when there's no seed? I think you should add a code comment here if checking create_empty is necessary for some reason, and probably drop it otherwise to simplify this code and be consistent with other TopUpKeyPool calls.",https://github.com/bitcoin/bitcoin/pull/14938#discussion_r249115411,249115411,src/wallet/wallet.cpp
