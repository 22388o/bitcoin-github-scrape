jonatack,2020-09-13 10:56:04,Thanks to @Saibato for setting me straight on this in #19946 and to @michaelfolkson for looking at that PR.,https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-691656011,691656011,
michaelfolkson,2020-09-13 11:22:36,Concept ACK. Will follow the above steps before ACKing the commit.,https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-691658695,691658695,
jonatack,2020-09-13 12:01:01,"I don't know why the travis xenial and macOS GUI/no depends are failing. All the other CI jobs pass on travis, cirrus, appveyor ones and bitcoin_builds.org.",https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-691662576,691662576,
Saibato,2020-09-13 13:39:43,"> I don't know why the travis xenial and macOS GUI/no depends are failing. All the other CI jobs pass on travis, cirrus, appveyor ones and bitcoin_builds.org.\n\n BOOST_CHECK_EQUAL(addr.ToString(), ipv6_addr); ipv6 with % != ?\n```\ntest/net_tests.cpp:259: error: in ""net_tests/cnetaddr_basic"": check addr.ToString() == scoped_addr has failed [1122:3344:5566:7788:9900:aabb:ccdd:eeff != 1122:3344",https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-691672777,691672777,
practicalswift,2020-09-13 13:55:32,"Concept ACK\n\nThanks for adding tests! ❤️ ",https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-691674599,691674599,
sipa,2020-09-13 17:09:42,"I don't think scope ids are intended to be portable.\n\nThey're a way for a user, on their local system, to specify what interface to use if you have multiple and are using a link-local address.\n\nBut in the end it's just a string that's passed to the OS for parsing. What interfaces exist, how they're named, and in what situation they're accepted is entirely up to it.\n\nOne idea that may make it",https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-691697651,691697651,
jonatack,2020-09-13 21:07:59,"> One idea that may make it more portable is restricting these scopes in tests to link-local addresses (inside fe80::/10), as the OS may refuse them outside that range.\n\nThis suggestion solved the Travis Xenial job and stabilized the macOS no-depends one enough to enable a workaround. Thank you, @sipa!\n\nCI is now green; ready for review.",https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-691725611,691725611,
eriknylund,2020-09-14 15:47:29,"ACK 88b6f85419b65122d5a4469a8585b276960bbb1e I built the PR on macOS Catalina 10.15.6 and ran both tests and functional tests - all pass. I've reviewed the two commits and I think the changes look good.\n\nI also repeated the test instructions to verify that the tests break accordingly (a bit different now because of the modified test):\n```\ntest/net_tests.cpp:258: error: in ""net_tests/cnetad",https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-692145375,692145375,
Saibato,2020-09-14 16:51:56,"btw: That macOS  edge case results from` std::string CNetAddr::ToStringIP() const ` in src/netaddress.cpp\nif we can not  GetSockAddr(... and result there in fallback.\n \nIf we convert the addr boost or https://tools.ietf.org/html/rfc4291 style we do not need the special addr representation string fe80:0:0:0:0:0:0:1""\n\nThat patch would do the trick?\n\n``` Diff\ndiff --git a/src/test/net",https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-692181543,692181543,
eriknylund,2020-09-15 05:28:06,"> btw: That macOS edge case results from`std::string CNetAddr::ToStringIP() const` in src/netaddress.cpp\n> if we can not GetSockAddr(... and result there in fallback.\n> \n> If we convert the addr boost or https://tools.ietf.org/html/rfc4291 style we do not need the special addr representation string fe80:0:0:0:0:0:0:1""\n> \n> That patch would do the trick?\n> \n> ```diff\n> diff --git a/",https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-692473356,692473356,
jonatack,2020-09-15 05:47:17,"Thanks @Saibato for the idea and @eriknylund for testing. MacOS 10.14+ seems to be a special case either way and I'd rather test what our code in `ToStringIP()` actually returns, so leaving this as-is for now.",https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-692479556,692479556,
michaelfolkson,2020-09-15 10:26:18,"Replicated steps @eriknylund followed [here](https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-692145375) and got the same results on Mac OS Catalina 10.15.6. All tests passed and the single test failed with the broken feature.\n\nCode changes excluding the test changes are clearly fine.\n\nAnything else one could do before ACKing the commit? Running the old tests (tests before they w",https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-692624944,692624944,
jonatack,2020-10-02 12:09:06,Up for grabs.,https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-702698354,702698354,
laanwj,2020-10-02 14:09:24,"FWIW, I still think this is worth doing.",https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-702755867,702755867,
jonatack,2020-10-02 14:35:45,"Rebased for the merged `addrv2` changes, and updated to remove an unneeded include from an earlier push here and update a comment. Diff: `git range-diff df2129a 88b6f85 f36887f`\n```diff\n/src/test/net_tests.cpp\n \n #include <string>\n-#include <vector>\n \n@@ -256,7 +255,7 @@ BOOST_AUTO_TEST_CASE(cnetaddr_basic)\n     BOOST_CHECK(!addr.IsBindAny());\n     const std::string addr_str{addr",https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-702770371,702770371,
laanwj,2020-10-02 15:02:25,ACK f36887fa47b42af60f8a06a3995baca7c73ca310,https://github.com/bitcoin/bitcoin/pull/19951#issuecomment-702785783,702785783,
eriknylund,2020-09-14 09:56:59,"I tested this locally on macOS Catalina 10.15.6 and I get an error on this line:\n```\ntest/net_tests.cpp:261: error: in ""net_tests/cnetaddr_basic"": check addr_str == scoped_addr || addr_str == link_local_edge_case has failed\n```\n\nUpdate: It fails on scope 8 and 21, but not on 32.",https://github.com/bitcoin/bitcoin/pull/19951#discussion_r487792199,487792199,src/test/net_tests.cpp
jonatack,2020-09-14 10:38:44,"Thanks @eriknylund! If you don't mind, can you give the output of rebuilding and running the test after adding these 2 lines?\n```diff\n         const std::string addr_str{addr.ToString()};\n+        BOOST_TEST_MESSAGE(scoped_addr);\n+        BOOST_TEST_MESSAGE(addr_str);\n         BOOST_CHECK(addr_str == scoped_addr || addr_str == link_local_edge_case);\n     }\n```",https://github.com/bitcoin/bitcoin/pull/19951#discussion_r487815516,487815516,src/test/net_tests.cpp
jonatack,2020-09-14 10:43:06,"(ISTM the lower scope values are often used by the local machine, so higher values may indeed make the test more agnostic.)",https://github.com/bitcoin/bitcoin/pull/19951#discussion_r487817788,487817788,src/test/net_tests.cpp
eriknylund,2020-09-14 10:53:46,"> (ISTM the lower scope values are often used by the local machine, so higher values may indeed make the test more agnostic.)\n\nThat seems to be the issue, en2 and vmnet8 are two network interfaces on my local machine:\n```\nfe80::1%8\nfe80::1%en2\ntest/net_tests.cpp:264: error: in ""net_tests/cnetaddr_basic"": check addr_str == scoped_addr || addr_str == link_local_edge_case has failed\nfe8",https://github.com/bitcoin/bitcoin/pull/19951#discussion_r487823231,487823231,src/test/net_tests.cpp
jonatack,2020-09-14 11:16:04,"Perfect, thanks. Simplified the test to only the 32 and 0 values. No need for more than that.",https://github.com/bitcoin/bitcoin/pull/19951#discussion_r487834588,487834588,src/test/net_tests.cpp
jonatack,2020-10-02 13:07:35,"This line is left over from an earlier push and should be removed.\n\nOther than that, I think this PR was finished, provided missing coverage+context, and just needed some review begging or sales effort.",https://github.com/bitcoin/bitcoin/pull/19951#discussion_r498809387,498809387,src/test/net_tests.cpp
jonatack,2020-10-02 13:09:44,"Maybe ""macOS 10.14/10.15"" -> ""macOS 10.14+""",https://github.com/bitcoin/bitcoin/pull/19951#discussion_r498810471,498810471,src/test/net_tests.cpp
ryanofsky,2021-04-11 22:57:28,"I saw this check fail in a recent cirrus run `[previous releases, uses qt5 dev package and some depends packages] [unsigned char] [bionic]`:\n\nhttps://cirrus-ci.com/task/5950587750580224?logs=ci#L4679\n\nI'm restarting the test, will see if happens again.",https://github.com/bitcoin/bitcoin/pull/19951#discussion_r611257547,611257547,src/test/net_tests.cpp
jonatack,2021-04-12 18:22:08,"Thanks for reporting. It may be hitting a reserved id; have had it happen on occasion locally and bumping the `32` to a higher value resolved it. What happened after restarting?\n```cpp\n    // Test with a fairly-high value, e.g. 32, to avoid locally reserved ids.\n    const std::string link_local{""fe80::1""};\n    const std::string scoped_addr{link_local + ""%32""};\n```\n",https://github.com/bitcoin/bitcoin/pull/19951#discussion_r611855776,611855776,src/test/net_tests.cpp
ryanofsky,2021-04-12 18:45:26,"Thanks, interesting! (I don't know what a reserved id is and googling didn't seem to turn up anything helpful, so I'd be curious for any pointers.)\n\nBut test passed on restart so it is an intermittent issue like you suggested. Maybe the test can be written so the check is less strict and just depends on parsing behavior not OS behavior. But it doesn't seem too urgent if this is a known infrequ",https://github.com/bitcoin/bitcoin/pull/19951#discussion_r611870353,611870353,src/test/net_tests.cpp
jonatack,2021-04-14 18:25:39,My bad for ambiguous wording! `s/reserved id/id in use/`...will fix issue and wording.,https://github.com/bitcoin/bitcoin/pull/19951#discussion_r613482942,613482942,src/test/net_tests.cpp
