[
  {
    "sha": "707fde7b9ba522c22179e2db0ed7b462c65138d9",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3MDdmZGU3YjliYTUyMmMyMjE3OWUyZGIwZWQ3YjQ2MmM2NTEzOGQ5",
    "commit": {
      "author": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2019-03-28T16:08:32Z"
      },
      "committer": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2019-10-29T17:55:10Z"
      },
      "message": "add unused SnapshotMetadata class",
      "tree": {
        "sha": "dd74c30b7d19b9807765d6945ce8c0465151e87b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/dd74c30b7d19b9807765d6945ce8c0465151e87b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/707fde7b9ba522c22179e2db0ed7b462c65138d9",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/707fde7b9ba522c22179e2db0ed7b462c65138d9",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/707fde7b9ba522c22179e2db0ed7b462c65138d9",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/707fde7b9ba522c22179e2db0ed7b462c65138d9/comments",
    "author": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6a97e8a060f7632bbaee27d3de8035dc6ebe3895",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6a97e8a060f7632bbaee27d3de8035dc6ebe3895",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6a97e8a060f7632bbaee27d3de8035dc6ebe3895"
      }
    ],
    "stats": {
      "total": 52,
      "additions": 52,
      "deletions": 0
    },
    "files": [
      {
        "sha": "19d41b78cbc9487c28ac9689cc181e2d818c6359",
        "filename": "src/Makefile.am",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/707fde7b9ba522c22179e2db0ed7b462c65138d9/src/Makefile.am",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/707fde7b9ba522c22179e2db0ed7b462c65138d9/src/Makefile.am",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/Makefile.am?ref=707fde7b9ba522c22179e2db0ed7b462c65138d9",
        "patch": "@@ -159,6 +159,7 @@ BITCOIN_CORE_H = \\\n   node/coinstats.h \\\n   node/psbt.h \\\n   node/transaction.h \\\n+  node/utxo_snapshot.h \\\n   noui.h \\\n   optional.h \\\n   outputtype.h \\"
      },
      {
        "sha": "702a0cbe5364649a4a9f11b39b24d94b490438ee",
        "filename": "src/node/utxo_snapshot.h",
        "status": "added",
        "additions": 50,
        "deletions": 0,
        "changes": 50,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/707fde7b9ba522c22179e2db0ed7b462c65138d9/src/node/utxo_snapshot.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/707fde7b9ba522c22179e2db0ed7b462c65138d9/src/node/utxo_snapshot.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/node/utxo_snapshot.h?ref=707fde7b9ba522c22179e2db0ed7b462c65138d9",
        "patch": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2009-2010 Satoshi Nakamoto\n+// Copyright (c) 2009-2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_NODE_UTXO_SNAPSHOT_H\n+#define BITCOIN_NODE_UTXO_SNAPSHOT_H\n+\n+#include <uint256.h>\n+#include <serialize.h>\n+\n+//! Metadata describing a serialized version of a UTXO set from which an\n+//! assumeutxo CChainState can be constructed.\n+class SnapshotMetadata\n+{\n+public:\n+    //! The hash of the block that reflects the tip of the chain for the\n+    //! UTXO set contained in this snapshot.\n+    uint256 m_base_blockhash;\n+\n+    //! The number of coins in the UTXO set contained in this snapshot. Used\n+    //! during snapshot load to estimate progress of UTXO set reconstruction.\n+    uint64_t m_coins_count = 0;\n+\n+    //! Necessary to \"fake\" the base nChainTx so that we can estimate progress during\n+    //! initial block download for the assumeutxo chainstate.\n+    unsigned int m_nchaintx = 0;\n+\n+    SnapshotMetadata() { }\n+    SnapshotMetadata(\n+        const uint256& base_blockhash,\n+        uint64_t coins_count,\n+        unsigned int nchaintx) :\n+            m_base_blockhash(base_blockhash),\n+            m_coins_count(coins_count),\n+            m_nchaintx(nchaintx) { }\n+\n+    ADD_SERIALIZE_METHODS;\n+\n+    template <typename Stream, typename Operation>\n+    inline void SerializationOp(Stream& s, Operation ser_action)\n+    {\n+        READWRITE(m_base_blockhash);\n+        READWRITE(m_coins_count);\n+        READWRITE(m_nchaintx);\n+    }\n+\n+};\n+\n+#endif // BITCOIN_NODE_UTXO_SNAPSHOT_H"
      },
      {
        "sha": "a539ab5465b1a2a7bb3a4ce7dec5332eacaabf73",
        "filename": "src/validation.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/707fde7b9ba522c22179e2db0ed7b462c65138d9/src/validation.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/707fde7b9ba522c22179e2db0ed7b462c65138d9/src/validation.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.h?ref=707fde7b9ba522c22179e2db0ed7b462c65138d9",
        "patch": "@@ -21,6 +21,7 @@\n #include <txmempool.h> // For CTxMemPool::cs\n #include <txdb.h>\n #include <versionbits.h>\n+#include <serialize.h>\n \n #include <algorithm>\n #include <atomic>"
      }
    ]
  },
  {
    "sha": "92fafb3a7da66f737e960e541fcfbcadedf6043a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5MmZhZmIzYTdkYTY2ZjczN2U5NjBlNTQxZmNmYmNhZGVkZjYwNDNh",
    "commit": {
      "author": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2019-03-28T16:09:06Z"
      },
      "committer": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2019-11-05T15:54:00Z"
      },
      "message": "coinstats: add coins_count\n\nAlso changes existing CCoinsStats attributes to be C++11 initialized.",
      "tree": {
        "sha": "dfb8740306736532fb514f1e0076d5716d673e7f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/dfb8740306736532fb514f1e0076d5716d673e7f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/92fafb3a7da66f737e960e541fcfbcadedf6043a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/92fafb3a7da66f737e960e541fcfbcadedf6043a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/92fafb3a7da66f737e960e541fcfbcadedf6043a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/92fafb3a7da66f737e960e541fcfbcadedf6043a/comments",
    "author": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "707fde7b9ba522c22179e2db0ed7b462c65138d9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/707fde7b9ba522c22179e2db0ed7b462c65138d9",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/707fde7b9ba522c22179e2db0ed7b462c65138d9"
      }
    ],
    "stats": {
      "total": 23,
      "additions": 13,
      "deletions": 10
    },
    "files": [
      {
        "sha": "23269cd4b0d126313d623c29b8adb2b84fdab581",
        "filename": "src/node/coinstats.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/92fafb3a7da66f737e960e541fcfbcadedf6043a/src/node/coinstats.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/92fafb3a7da66f737e960e541fcfbcadedf6043a/src/node/coinstats.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/node/coinstats.cpp?ref=92fafb3a7da66f737e960e541fcfbcadedf6043a",
        "patch": "@@ -38,6 +38,7 @@ static void ApplyStats(CCoinsStats &stats, CHashWriter& ss, const uint256& hash,\n //! Calculate statistics about the unspent transaction output set\n bool GetUTXOStats(CCoinsView *view, CCoinsStats &stats)\n {\n+    stats = CCoinsStats();\n     std::unique_ptr<CCoinsViewCursor> pcursor(view->Cursor());\n     assert(pcursor);\n \n@@ -61,6 +62,7 @@ bool GetUTXOStats(CCoinsView *view, CCoinsStats &stats)\n             }\n             prevkey = key.hash;\n             outputs[key.n] = std::move(coin);\n+            stats.coins_count++;\n         } else {\n             return error(\"%s: unable to read value\", __func__);\n         }"
      },
      {
        "sha": "a19af0fd1b2f625b72eeb8a5a2d9877903debd01",
        "filename": "src/node/coinstats.h",
        "status": "modified",
        "additions": 11,
        "deletions": 10,
        "changes": 21,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/92fafb3a7da66f737e960e541fcfbcadedf6043a/src/node/coinstats.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/92fafb3a7da66f737e960e541fcfbcadedf6043a/src/node/coinstats.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/node/coinstats.h?ref=92fafb3a7da66f737e960e541fcfbcadedf6043a",
        "patch": "@@ -15,16 +15,17 @@ class CCoinsView;\n \n struct CCoinsStats\n {\n-    int nHeight;\n-    uint256 hashBlock;\n-    uint64_t nTransactions;\n-    uint64_t nTransactionOutputs;\n-    uint64_t nBogoSize;\n-    uint256 hashSerialized;\n-    uint64_t nDiskSize;\n-    CAmount nTotalAmount;\n-\n-    CCoinsStats() : nHeight(0), nTransactions(0), nTransactionOutputs(0), nBogoSize(0), nDiskSize(0), nTotalAmount(0) {}\n+    int nHeight{0};\n+    uint256 hashBlock{};\n+    uint64_t nTransactions{0};\n+    uint64_t nTransactionOutputs{0};\n+    uint64_t nBogoSize{0};\n+    uint256 hashSerialized{};\n+    uint64_t nDiskSize{0};\n+    CAmount nTotalAmount{0};\n+\n+    //! The number of coins contained.\n+    uint64_t coins_count{0};\n };\n \n //! Calculate statistics about the unspent transaction output set"
      }
    ]
  },
  {
    "sha": "57cf74c9918d10c69a46e6ceb3cb1a5e04edf5bc",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1N2NmNzRjOTkxOGQxMGM2OWE0NmU2Y2ViM2NiMWE1ZTA0ZWRmNWJj",
    "commit": {
      "author": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2019-03-28T16:10:33Z"
      },
      "committer": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2019-11-05T18:35:57Z"
      },
      "message": "rpc: add dumptxoutset\n\nAllows the creation of a UTXO snapshot to disk.",
      "tree": {
        "sha": "b87e9094c1aff0d469f61a186928b76b57ffb951",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b87e9094c1aff0d469f61a186928b76b57ffb951"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/57cf74c9918d10c69a46e6ceb3cb1a5e04edf5bc",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/57cf74c9918d10c69a46e6ceb3cb1a5e04edf5bc",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/57cf74c9918d10c69a46e6ceb3cb1a5e04edf5bc",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/57cf74c9918d10c69a46e6ceb3cb1a5e04edf5bc/comments",
    "author": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "92fafb3a7da66f737e960e541fcfbcadedf6043a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/92fafb3a7da66f737e960e541fcfbcadedf6043a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/92fafb3a7da66f737e960e541fcfbcadedf6043a"
      }
    ],
    "stats": {
      "total": 109,
      "additions": 109,
      "deletions": 0
    },
    "files": [
      {
        "sha": "de5649de2feba14c179a23301e6b336b4b1bac74",
        "filename": "src/rpc/blockchain.cpp",
        "status": "modified",
        "additions": 109,
        "deletions": 0,
        "changes": 109,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/57cf74c9918d10c69a46e6ceb3cb1a5e04edf5bc/src/rpc/blockchain.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/57cf74c9918d10c69a46e6ceb3cb1a5e04edf5bc/src/rpc/blockchain.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/blockchain.cpp?ref=57cf74c9918d10c69a46e6ceb3cb1a5e04edf5bc",
        "patch": "@@ -15,6 +15,7 @@\n #include <hash.h>\n #include <index/blockfilterindex.h>\n #include <node/coinstats.h>\n+#include <node/utxo_snapshot.h>\n #include <policy/feerate.h>\n #include <policy/policy.h>\n #include <policy/rbf.h>\n@@ -2245,6 +2246,113 @@ static UniValue getblockfilter(const JSONRPCRequest& request)\n     return ret;\n }\n \n+/**\n+ * Serialize the UTXO set to a file for loading elsewhere.\n+ *\n+ * @see SnapshotMetadata\n+ */\n+UniValue dumptxoutset(const JSONRPCRequest& request)\n+{\n+    RPCHelpMan{\n+        \"dumptxoutset\",\n+        \"\\nWrite the serialized UTXO set to disk.\\n\"\n+        \"Incidentally flushes the latest coinsdb (leveldb) to disk.\\n\",\n+        {\n+            {\"path\",\n+                RPCArg::Type::STR,\n+                RPCArg::Optional::NO,\n+                /* default_val */ \"\",\n+                \"path to the output file. If relative, will be prefixed by datadir.\"},\n+        },\n+        RPCResult{\n+            \"{\\n\"\n+            \"  \\\"coins_written\\\": n,   (numeric) the number of coins written in the snapshot\\n\"\n+            \"  \\\"base_hash\\\": \\\"...\\\",   (string) the hash of the base of the snapshot\\n\"\n+            \"  \\\"base_height\\\": n,     (string) the height of the base of the snapshot\\n\"\n+            \"  \\\"path\\\": \\\"...\\\"         (string) the absolute path that the snapshot was written to\\n\"\n+            \"]\\n\"\n+        },\n+        RPCExamples{\n+            HelpExampleCli(\"dumptxoutset\", \"utxo.dat\")\n+        }\n+    }.Check(request);\n+\n+    fs::path path = fs::absolute(request.params[0].get_str(), GetDataDir());\n+    // Write to a temporary path and then move into `path` on completion\n+    // to avoid confusion due to an interruption.\n+    fs::path temppath = fs::absolute(request.params[0].get_str() + \".incomplete\", GetDataDir());\n+\n+    if (fs::exists(path)) {\n+        throw JSONRPCError(\n+            RPC_INVALID_PARAMETER,\n+            path.string() + \" already exists. If you are sure this is what you want, \"\n+            \"move it out of the way first\");\n+    }\n+\n+    FILE* file{fsbridge::fopen(temppath, \"wb\")};\n+    CAutoFile afile{file, SER_DISK, CLIENT_VERSION};\n+    std::unique_ptr<CCoinsViewCursor> pcursor;\n+    CCoinsStats stats;\n+    CBlockIndex* tip;\n+\n+    {\n+        // We need to lock cs_main to ensure that the coinsdb isn't written to\n+        // between (i) flushing coins cache to disk (coinsdb), (ii) getting stats\n+        // based upon the coinsdb, and (iii) constructing a cursor to the\n+        // coinsdb for use below this block.\n+        //\n+        // Cursors returned by leveldb iterate over snapshots, so the contents\n+        // of the pcursor will not be affected by simultaneous writes during\n+        // use below this block.\n+        //\n+        // See discussion here:\n+        //   https://github.com/bitcoin/bitcoin/pull/15606#discussion_r274479369\n+        //\n+        LOCK(::cs_main);\n+\n+        ::ChainstateActive().ForceFlushStateToDisk();\n+\n+        if (!GetUTXOStats(&::ChainstateActive().CoinsDB(), stats)) {\n+            throw JSONRPCError(RPC_INTERNAL_ERROR, \"Unable to read UTXO set\");\n+        }\n+\n+        pcursor = std::unique_ptr<CCoinsViewCursor>(::ChainstateActive().CoinsDB().Cursor());\n+        tip = LookupBlockIndex(stats.hashBlock);\n+        CHECK_NONFATAL(tip);\n+    }\n+\n+    SnapshotMetadata metadata{tip->GetBlockHash(), stats.coins_count, tip->nChainTx};\n+\n+    afile << metadata;\n+\n+    COutPoint key;\n+    Coin coin;\n+    unsigned int iter{0};\n+\n+    while (pcursor->Valid()) {\n+        if (iter % 5000 == 0 && !IsRPCRunning()) {\n+            throw JSONRPCError(RPC_CLIENT_NOT_CONNECTED, \"Shutting down\");\n+        }\n+        ++iter;\n+        if (pcursor->GetKey(key) && pcursor->GetValue(coin)) {\n+            afile << key;\n+            afile << coin;\n+        }\n+\n+        pcursor->Next();\n+    }\n+\n+    afile.fclose();\n+    fs::rename(temppath, path);\n+\n+    UniValue result(UniValue::VOBJ);\n+    result.pushKV(\"coins_written\", stats.coins_count);\n+    result.pushKV(\"base_hash\", tip->GetBlockHash().ToString());\n+    result.pushKV(\"base_height\", tip->nHeight);\n+    result.pushKV(\"path\", path.string());\n+    return result;\n+}\n+\n // clang-format off\n static const CRPCCommand commands[] =\n { //  category              name                      actor (function)         argNames\n@@ -2281,6 +2389,7 @@ static const CRPCCommand commands[] =\n     { \"hidden\",             \"waitforblock\",           &waitforblock,           {\"blockhash\",\"timeout\"} },\n     { \"hidden\",             \"waitforblockheight\",     &waitforblockheight,     {\"height\",\"timeout\"} },\n     { \"hidden\",             \"syncwithvalidationinterfacequeue\", &syncwithvalidationinterfacequeue, {} },\n+    { \"hidden\",             \"dumptxoutset\",           &dumptxoutset,           {\"path\"} },\n };\n // clang-format on\n "
      }
    ]
  },
  {
    "sha": "c1ccbc3ddef931896a7e9dcfa6704e305a69fbff",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjMWNjYmMzZGRlZjkzMTg5NmE3ZTlkY2ZhNjcwNGUzMDVhNjlmYmZm",
    "commit": {
      "author": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2019-04-25T19:32:09Z"
      },
      "committer": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2019-11-05T18:36:04Z"
      },
      "message": "devtools: add utxo_snapshot.sh\n\nto allow easy (if not time-consuming) generation and verification of\nsnapshots.",
      "tree": {
        "sha": "4db20e0e966f21b3240856489a742ec4f344206a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4db20e0e966f21b3240856489a742ec4f344206a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c1ccbc3ddef931896a7e9dcfa6704e305a69fbff",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c1ccbc3ddef931896a7e9dcfa6704e305a69fbff",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c1ccbc3ddef931896a7e9dcfa6704e305a69fbff",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c1ccbc3ddef931896a7e9dcfa6704e305a69fbff/comments",
    "author": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "57cf74c9918d10c69a46e6ceb3cb1a5e04edf5bc",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/57cf74c9918d10c69a46e6ceb3cb1a5e04edf5bc",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/57cf74c9918d10c69a46e6ceb3cb1a5e04edf5bc"
      }
    ],
    "stats": {
      "total": 44,
      "additions": 44,
      "deletions": 0
    },
    "files": [
      {
        "sha": "dee25ff67b61e3b798cf56f53657536e496cfef8",
        "filename": "contrib/devtools/utxo_snapshot.sh",
        "status": "added",
        "additions": 44,
        "deletions": 0,
        "changes": 44,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c1ccbc3ddef931896a7e9dcfa6704e305a69fbff/contrib/devtools/utxo_snapshot.sh",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c1ccbc3ddef931896a7e9dcfa6704e305a69fbff/contrib/devtools/utxo_snapshot.sh",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/contrib/devtools/utxo_snapshot.sh?ref=c1ccbc3ddef931896a7e9dcfa6704e305a69fbff",
        "patch": "@@ -0,0 +1,44 @@\n+#!/usr/bin/env bash\n+#\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#\n+export LC_ALL=C\n+\n+set -ueo pipefail\n+\n+if (( $# < 3 )); then\n+  echo 'Usage: utxo_snapshot.sh <generate-at-height> <snapshot-out-path> <bitcoin-cli-call ...>'\n+  echo\n+  echo \"  if <snapshot-out-path> is '-', don't produce a snapshot file but instead print the \"\n+  echo \"  expected assumeutxo hash\"\n+  echo\n+  echo 'Examples:'\n+  echo\n+  echo \"  ./contrib/devtools/utxo_snapshot.sh 570000 utxo.dat ./src/bitcoin-cli -datadir=\\$(pwd)/testdata\"\n+  echo '  ./contrib/devtools/utxo_snapshot.sh 570000 - ./src/bitcoin-cli'\n+  exit 1\n+fi\n+\n+GENERATE_AT_HEIGHT=\"${1}\"; shift;\n+OUTPUT_PATH=\"${1}\"; shift;\n+# Most of the calls we make take a while to run, so pad with a lengthy timeout.\n+BITCOIN_CLI_CALL=\"${*} -rpcclienttimeout=9999999\"\n+\n+# Block we'll invalidate/reconsider to rewind/fast-forward the chain.\n+PIVOT_BLOCKHASH=$($BITCOIN_CLI_CALL getblockhash $(( GENERATE_AT_HEIGHT + 1 )) )\n+\n+(>&2 echo \"Rewinding chain back to height ${GENERATE_AT_HEIGHT} (by invalidating ${PIVOT_BLOCKHASH}); this may take a while\")\n+${BITCOIN_CLI_CALL} invalidateblock \"${PIVOT_BLOCKHASH}\"\n+\n+if [[ \"${OUTPUT_PATH}\" = \"-\" ]]; then\n+  (>&2 echo \"Generating txoutset info...\")\n+  ${BITCOIN_CLI_CALL} gettxoutsetinfo | grep hash_serialized_2 | sed 's/^.*: \"\\(.\\+\\)\\+\",/\\1/g'\n+else\n+  (>&2 echo \"Generating UTXO snapshot...\")\n+  ${BITCOIN_CLI_CALL} dumptxoutset \"${OUTPUT_PATH}\"\n+fi\n+\n+(>&2 echo \"Restoring chain to original height; this may take a while\")\n+${BITCOIN_CLI_CALL} reconsiderblock \"${PIVOT_BLOCKHASH}\""
      }
    ]
  },
  {
    "sha": "92b2f5306ba0b3f031293cb8f415b67cb002c2f1",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5MmIyZjUzMDZiYTBiM2YwMzEyOTNjYjhmNDE1YjY3Y2IwMDJjMmYx",
    "commit": {
      "author": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2019-09-17T14:57:46Z"
      },
      "committer": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2019-11-05T18:36:04Z"
      },
      "message": "test: add dumptxoutset RPC test",
      "tree": {
        "sha": "6da8a0178a52400a309db6a16db305780579ef4a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6da8a0178a52400a309db6a16db305780579ef4a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/92b2f5306ba0b3f031293cb8f415b67cb002c2f1",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/92b2f5306ba0b3f031293cb8f415b67cb002c2f1",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/92b2f5306ba0b3f031293cb8f415b67cb002c2f1",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/92b2f5306ba0b3f031293cb8f415b67cb002c2f1/comments",
    "author": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c1ccbc3ddef931896a7e9dcfa6704e305a69fbff",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c1ccbc3ddef931896a7e9dcfa6704e305a69fbff",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c1ccbc3ddef931896a7e9dcfa6704e305a69fbff"
      }
    ],
    "stats": {
      "total": 52,
      "additions": 52,
      "deletions": 0
    },
    "files": [
      {
        "sha": "7527bdfb08f13412cf6db4a4a636441d52380065",
        "filename": "test/functional/rpc_dumptxoutset.py",
        "status": "added",
        "additions": 51,
        "deletions": 0,
        "changes": 51,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/92b2f5306ba0b3f031293cb8f415b67cb002c2f1/test/functional/rpc_dumptxoutset.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/92b2f5306ba0b3f031293cb8f415b67cb002c2f1/test/functional/rpc_dumptxoutset.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_dumptxoutset.py?ref=92b2f5306ba0b3f031293cb8f415b67cb002c2f1",
        "patch": "@@ -0,0 +1,51 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the generation of UTXO snapshots using `dumptxoutset`.\n+\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, assert_raises_rpc_error\n+\n+import hashlib\n+from pathlib import Path\n+\n+\n+class DumptxoutsetTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        \"\"\"Test a trivial usage of the dumptxoutset RPC command.\"\"\"\n+        node = self.nodes[0]\n+        mocktime = node.getblockheader(node.getblockhash(0))['time'] + 1\n+        node.setmocktime(mocktime)\n+        node.generate(100)\n+\n+        FILENAME = 'txoutset.dat'\n+        out = node.dumptxoutset(FILENAME)\n+        expected_path = Path(node.datadir) / 'regtest' / FILENAME\n+\n+        assert expected_path.is_file()\n+\n+        assert_equal(out['coins_written'], 100)\n+        assert_equal(out['base_height'], 100)\n+        assert_equal(out['path'], str(expected_path))\n+        # Blockhash should be deterministic based on mocked time.\n+        assert_equal(\n+            out['base_hash'],\n+            '6fd417acba2a8738b06fee43330c50d58e6a725046c3d843c8dd7e51d46d1ed6')\n+\n+        with open(str(expected_path), 'rb') as f:\n+            digest = hashlib.sha256(f.read()).hexdigest()\n+            # UTXO snapshot hash should be deterministic based on mocked time.\n+            assert_equal(\n+                digest, 'be032e5f248264ba08e11099ac09dbd001f6f87ffc68bf0f87043d8146d50664')\n+\n+        # Specifying a path to an existing file will fail.\n+        assert_raises_rpc_error(\n+            -8, '{} already exists'.format(FILENAME),  node.dumptxoutset, FILENAME)\n+\n+if __name__ == '__main__':\n+    DumptxoutsetTest().main()"
      },
      {
        "sha": "2938c54a359635f0a7c4c7aae79eb07b200d76e1",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/92b2f5306ba0b3f031293cb8f415b67cb002c2f1/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/92b2f5306ba0b3f031293cb8f415b67cb002c2f1/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=92b2f5306ba0b3f031293cb8f415b67cb002c2f1",
        "patch": "@@ -190,6 +190,7 @@\n     'rpc_uptime.py',\n     'wallet_resendwallettransactions.py',\n     'wallet_fallbackfee.py',\n+    'rpc_dumptxoutset.py',\n     'feature_minchainwork.py',\n     'rpc_getblockstats.py',\n     'wallet_create_tx.py',"
      }
    ]
  }
]