achow101,2017-11-14T04:38:55Z,"I resolved the hanging issue, but now there's another issue.\n\nThe hanging issue was because I forgot to set the CWallet pointers `walletmodel`, `addresstablemodel`, and `transactiontablemodel` to the new CWallet pointers that were created from reopening the wallet. So they were trying to lock on a `cs_KeyStore` that no longer existed.\n\n~~~The new issue is that the address book tables and t",https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-344144417,344144417,
achow101,2017-11-14T05:16:08Z,Resolved the other issue too. I forgot to also reset the signals to use the new wallets too. No longer WIP.,https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-344149106,344149106,
promag,2017-11-14T14:05:48Z,"Concept ACK.\n\nI get `SIGABRT` when I call `encryptwallet` from the debug window console. Here is the stack trace:\n```\n2017-11-14 14:02:32 Encrypting Wallet with an nDeriveIterations of 188608\n2017-11-14 14:02:33 GUI: NotifyKeyStoreStatusChanged\n2017-11-14 14:02:33 GUI: NotifyKeyStoreStatusChanged\n2017-11-14 14:02:34 keypool added 2000 keys (1000 internal), size=2000 (1000 internal)\",https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-344268956,344268956,
achow101,2017-11-14T20:04:27Z,"> but it doesn't seem right that every wallet should be closed and reopened when one wallet is encrypted.\n\nThis was easier to do since there are some things in the GUI that look specifically for `vpwallets[0]`, so to close and reopen a wallet would require remove the pointer from that position in `vpwallets` and then replacing it with the newly opened wallet. That seemed to be more complicated",https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-344381057,344381057,
jonasschnelli,2017-11-14T20:19:48Z,"Concept ACK.\nMy two worries:\n* let's hope no keys remain unencrypted in memory (I guess our approach is okay here)\n* concurrency especially with reduction of cs_main and the upcoming dynamic wallet loading (haven't checked the code) ",https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-344385251,344385251,
jonasschnelli,2017-11-29T23:23:02Z,Needs rebase,https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-348030515,348030515,
achow101,2017-11-30T16:21:31Z,Rebased.,https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-348239662,348239662,
achow101,2018-01-10T21:14:23Z,"Rebased this.\n\nThe issue that @promag pointed out is because the GUI does not reset the walletmodel as it needs to when reloading the wallet when the rpc console is used to give the command. I'm not quite sure what the best approach for enabling that is though.",https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-356738674,356738674,
achow101,2018-02-14T05:39:23Z,"Rebased.\n\nI believe I fixed the issue mentioned earlier, although it is an extremely ugly hack that involves string comparisons. If anyone has a better suggestion, I'm all ears.",https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-365501951,365501951,
promag,2018-02-14T08:52:03Z,Will test.,https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-365536135,365536135,
achow101,2018-02-20T03:04:23Z,Closing this so I can implement it the right way.,https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-366854359,366854359,
ryanofsky,2018-02-20T13:07:41Z,"> I don't even see a reason why the wallet that is being encrypted needs have all it's in-memory state thrown away and then the same data reloaded from disk.\n\n>> I thought that there were still some in-memory things that needed to be discarded (e.g. unencrypted keys) to ensure security of the wallet.\n\nI think before anything else, we should figure out exactly what needs to be cleared. For ",https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-366971694,366971694,
achow101,2018-02-20T15:44:24Z,"@ryanofsky The problem is described here: https://bitcointalk.org/index.php?topic=51474.0\n\nI think the approach I was using works since it closes the wallets, resets the database environment, and then reopens the wallets. Specifically, I think the key part is the `bitdb.Reset()` call.\n\nI wrote and used this script to check if there were any private keys being written to the log files: http",https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-367019249,367019249,
ryanofsky,2018-02-20T18:33:57Z,"> @ryanofsky The problem is described here: https://bitcointalk.org/index.php?topic=51474.0\n\n@achow101, then what were you referring to when you wrote ""I thought that there were still some in-memory things that needed to be discarded""? I'd be interested to know why encryption can't be handled at the db/wallet layer instead of involving qt, rpc, hooks, callbacks, shared pointers or whatever els",https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-367074262,367074262,
achow101,2018-02-20T18:46:13Z,"@ryanofsky \n\n> then what were you referring to when you wrote ""I thought that there were still some in-memory things that needed to be discarded""?\n\nI was mistaken.\n\n> I'd be interested to know why encryption can't be handled at the db/wallet layer instead of involving qt, rpc, hooks, callbacks, shared pointers or whatever else might be entailed in a new effort to ""implement it the righ",https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-367078002,367078002,
ryanofsky,2018-02-20T18:51:28Z,"> it has to be done externally instead of within the db/wallet itself.\n\nWould adding a method to close and reopen the database environment not work? This is what I was trying to suggest here: https://github.com/bitcoin/bitcoin/pull/11678#pullrequestreview-76464511. I don't see what the problem would be. It would seem to require some interaction with the flush thread but otherwise could just be",https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-367079551,367079551,
achow101,2018-02-20T19:57:13Z,"> Would adding a method to close and reopen the database environment not work?\n\nI'm not sure that that would work. The `CDB` objects for each wallet would need to learn of the new `Db` pointer that was created on the reopen, but the `CDBEnv` doesn't know about the `CDB` objects nor does it need to (I think).\n\nI can try that approach and see if I get anywhere with it.",https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-367099949,367099949,
achow101,2018-02-20T20:26:33Z,@ryanofsky I think it actually is possible to do that. I'll try it and make a PR if it works. It appears that I have misunderstood how the wallet handles Db stuff.,https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-367107872,367107872,
ryanofsky,2018-02-20T21:06:20Z,"Sounds good. I think you probably already found this, but the CDB objects are temporary, so you could just wait for them to be closed with `mapFileUseCount`. `CDBEnv::Flush` is kind of doing something like this already, although that code is messy and just gives up if the count is not 0.",https://github.com/bitcoin/bitcoin/pull/11678#issuecomment-367119243,367119243,
meshcollider,2017-11-14T00:43:43Z,"Above on line 2347 it says `""Note that this will shutdown the server.\n""` which should be removed now",https://github.com/bitcoin/bitcoin/pull/11678#discussion_r150709010,150709010,src/wallet/rpcwallet.cpp
achow101,2017-11-14T04:36:59Z,Done,https://github.com/bitcoin/bitcoin/pull/11678#discussion_r150735731,150735731,src/wallet/rpcwallet.cpp
