promag,2017-10-12T22:35:36Z,"> has slightly changed behavior if the mockdb set_flags call fails\n\nActually 2nd commit is also a fix since it doesn't `++env->mapFileUseCount[strFile]` if `set_flags` fails. I'll amend.",https://github.com/bitcoin/bitcoin/pull/11492#issuecomment-336296936,336296936,
promag,2017-10-13T15:30:29Z,@ryanofsky now with `unique_ptr` but the release is before. I would squash the 3 commits before merge.,https://github.com/bitcoin/bitcoin/pull/11492#issuecomment-336486404,336486404,
promag,2017-10-14T22:59:33Z,Squashed and added a detailed description in the commit message.,https://github.com/bitcoin/bitcoin/pull/11492#issuecomment-336673172,336673172,
laanwj,2017-10-18T13:39:35Z,utACK 7104de8,https://github.com/bitcoin/bitcoin/pull/11492#issuecomment-337593463,337593463,
ryanofsky,2017-10-12T22:46:21Z,Maybe another way you could fix this without adding a delete call would be to declare pdb as a unique_ptr in the header? This would also let you remove the other deletes below.,https://github.com/bitcoin/bitcoin/pull/11492#discussion_r144428862,144428862,src/wallet/db.cpp
promag,2017-10-12T23:18:13Z,"And in `std::map<std::string, Db*> CDBEnv::mapDb`?",https://github.com/bitcoin/bitcoin/pull/11492#discussion_r144433459,144433459,src/wallet/db.cpp
ryanofsky,2017-10-13T14:15:45Z,"> And in std::map\<std::string, Db*> CDBEnv::mapDb?\n\nOops, sorry. The pdb member should _not_ be a unique_ptr because the pointer is actually owned (deleted) by mapdb, not the cdb class.\n\nIf you wanted to do a minimal fix you could declare a unique_ptr\<Db> temp_db here and then do pdb = temp_db.release() at the end of this function.\n\nIf you wanted to go further, you could change mapDb",https://github.com/bitcoin/bitcoin/pull/11492#discussion_r144565794,144565794,src/wallet/db.cpp
promag,2017-10-13T14:44:48Z,I wouldn't go that further in a bugfix. But I'll probably do that in a different PR.,https://github.com/bitcoin/bitcoin/pull/11492#discussion_r144573785,144573785,src/wallet/db.cpp
ryanofsky,2017-10-13T15:15:54Z,"Ok, 0d3ec0c3a15e7afde42b3b98e369d989a6d9e7f7 is the minimal fix for reference.",https://github.com/bitcoin/bitcoin/pull/11492#discussion_r144582187,144582187,src/wallet/db.cpp
promag,2017-10-13T15:16:15Z,"Anyway, the calls `Exists` and `Write` below use `pdb` internally. I believe this is the minimal fix.",https://github.com/bitcoin/bitcoin/pull/11492#discussion_r144582295,144582295,src/wallet/db.cpp
promag,2017-10-13T15:18:47Z,"> Ok, 0d3ec0c is the minimal fix for reference.\n\nHad the same, but see my previous comment.",https://github.com/bitcoin/bitcoin/pull/11492#discussion_r144582958,144582958,src/wallet/db.cpp
promag,2017-10-13T15:20:25Z,"Also, I thought of not doing `pdb = nullptr` but if this code is moved to some member function then that can a problem.",https://github.com/bitcoin/bitcoin/pull/11492#discussion_r144583408,144583408,src/wallet/db.cpp
promag,2017-10-13T15:24:38Z,"Well, I can `.release()` before `Exists()`.",https://github.com/bitcoin/bitcoin/pull/11492#discussion_r144584581,144584581,src/wallet/db.cpp
