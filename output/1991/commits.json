[
  {
    "sha": "36d24ae3a2805bca1d54bf309e156e9293f1cb58",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozNmQyNGFlM2EyODA1YmNhMWQ1NGJmMzA5ZTE1NmU5MjkzZjFjYjU4",
    "commit": {
      "author": {
        "name": "Znort 987",
        "email": "znort987@yahoo.com",
        "date": "2012-11-06T09:53:05Z"
      },
      "committer": {
        "name": "Znort 987",
        "email": "znort987@yahoo.com",
        "date": "2012-11-06T09:53:05Z"
      },
      "message": "Add the fixwalletdates RPC\n\n    When the client has been off for a while and gets restarted,\n    new transactions are received via blockchain updates and get\n    tagged with the current time, which bear little to no correlation\n    with the time at which the TX was broadcast by the sender.\n\n    As a substitute, the \"fixwalletdates\" RPC re-tags all wallet\n    transactions with the timestamp of the block they are included\n    in (if any).\n\n    One minor downside of calling this RPC is that TX that were\n    actually received via broadcast will see their \"broadcast date\"\n    be replaced by the time they got included in a block.\n\n    In practice, I've found this not to be a problem. In fact,\n    seeing all TXs tagged with the time at which they get included\n    in the blockchain makes more sense : in a way, it's the time the\n    TX became valid, and if we have to pick one canonically representative\n    time for a TX, first block inclusion time is better than first\n    broadcast time.",
      "tree": {
        "sha": "d0e846da8cebcdd9c33af791d89e86682767259f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d0e846da8cebcdd9c33af791d89e86682767259f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/36d24ae3a2805bca1d54bf309e156e9293f1cb58",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/36d24ae3a2805bca1d54bf309e156e9293f1cb58",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/36d24ae3a2805bca1d54bf309e156e9293f1cb58",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/36d24ae3a2805bca1d54bf309e156e9293f1cb58/comments",
    "author": null,
    "committer": null,
    "parents": [
      {
        "sha": "86406daeca0390b13457cc4f8d5f24fa5bf54557",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/86406daeca0390b13457cc4f8d5f24fa5bf54557",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/86406daeca0390b13457cc4f8d5f24fa5bf54557"
      }
    ],
    "stats": {
      "total": 59,
      "additions": 57,
      "deletions": 2
    },
    "files": [
      {
        "sha": "8f13b0f2249cd9f0987413d92119e77b017039cc",
        "filename": "src/bitcoinrpc.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/36d24ae3a2805bca1d54bf309e156e9293f1cb58/src/bitcoinrpc.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/36d24ae3a2805bca1d54bf309e156e9293f1cb58/src/bitcoinrpc.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bitcoinrpc.cpp?ref=36d24ae3a2805bca1d54bf309e156e9293f1cb58",
        "patch": "@@ -223,6 +223,7 @@ static const CRPCCommand vRPCCommands[] =\n     { \"listreceivedbyaddress\",  &listreceivedbyaddress,  false,  false },\n     { \"listreceivedbyaccount\",  &listreceivedbyaccount,  false,  false },\n     { \"backupwallet\",           &backupwallet,           true,   false },\n+    { \"fixwalletdates\",         &fixwalletdates,         false,  false },\n     { \"keypoolrefill\",          &keypoolrefill,          true,   false },\n     { \"walletpassphrase\",       &walletpassphrase,       true,   false },\n     { \"walletpassphrasechange\", &walletpassphrasechange, false,  false },"
      },
      {
        "sha": "40cc6c0e8e81a5ea397d723fc839be8545ea6916",
        "filename": "src/bitcoinrpc.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/36d24ae3a2805bca1d54bf309e156e9293f1cb58/src/bitcoinrpc.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/36d24ae3a2805bca1d54bf309e156e9293f1cb58/src/bitcoinrpc.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bitcoinrpc.h?ref=36d24ae3a2805bca1d54bf309e156e9293f1cb58",
        "patch": "@@ -167,6 +167,7 @@ extern json_spirit::Value listaccounts(const json_spirit::Array& params, bool fH\n extern json_spirit::Value listsinceblock(const json_spirit::Array& params, bool fHelp);\n extern json_spirit::Value gettransaction(const json_spirit::Array& params, bool fHelp);\n extern json_spirit::Value backupwallet(const json_spirit::Array& params, bool fHelp);\n+extern json_spirit::Value fixwalletdates(const json_spirit::Array& params, bool fHelp);\n extern json_spirit::Value keypoolrefill(const json_spirit::Array& params, bool fHelp);\n extern json_spirit::Value walletpassphrase(const json_spirit::Array& params, bool fHelp);\n extern json_spirit::Value walletpassphrasechange(const json_spirit::Array& params, bool fHelp);"
      },
      {
        "sha": "01d29e0dc991417f631b5590f06ebe02f1e2116d",
        "filename": "src/rpcwallet.cpp",
        "status": "modified",
        "additions": 13,
        "deletions": 0,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/36d24ae3a2805bca1d54bf309e156e9293f1cb58/src/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/36d24ae3a2805bca1d54bf309e156e9293f1cb58/src/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpcwallet.cpp?ref=36d24ae3a2805bca1d54bf309e156e9293f1cb58",
        "patch": "@@ -1234,6 +1234,19 @@ Value backupwallet(const Array& params, bool fHelp)\n }\n \n \n+Value fixwalletdates(const Array& params, bool fHelp)\n+{\n+    if (fHelp || params.size() != 0)\n+        throw runtime_error(\n+            \"fixwalletdates\\n\"\n+            \"Reset wallet transactions date to that of the block they appear in.\");\n+\n+    std::string result;\n+    bool ok = pwalletMain->ResetTransactionTime(result);\n+    return result + (ok ? \"ok\\n\" : \"failed\\n\");\n+}\n+\n+\n Value keypoolrefill(const Array& params, bool fHelp)\n {\n     if (fHelp || params.size() > 0)"
      },
      {
        "sha": "529244da57b30ec4240d1e5867ac1bb10839f117",
        "filename": "src/wallet.cpp",
        "status": "modified",
        "additions": 41,
        "deletions": 2,
        "changes": 43,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/36d24ae3a2805bca1d54bf309e156e9293f1cb58/src/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/36d24ae3a2805bca1d54bf309e156e9293f1cb58/src/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet.cpp?ref=36d24ae3a2805bca1d54bf309e156e9293f1cb58",
        "patch": "@@ -764,6 +764,47 @@ int CWallet::ScanForWalletTransactions(CBlockIndex* pindexStart, bool fUpdate)\n     return ret;\n }\n \n+// Change the date of each transaction in the wallet to the\n+// timestamp of the block the transactions appears in. The\n+// time of TXs not yet appearing in a block remain unchanged.\n+bool CWallet::ResetTransactionTime(std::string &result)\n+{\n+    printf(\"ResetTransactionTime()\\n\");\n+    {\n+        LOCK(cs_wallet);\n+        BOOST_FOREACH(PAIRTYPE(const uint256, CWalletTx)& item, mapWallet) {\n+            const uint256 &hash = item.first;\n+            CWalletTx &tx = item.second;\n+            if (tx.IsInMainChain()) {\n+                CBlockIndex *index;\n+                int depth = tx.GetDepthInMainChain(index);\n+                if (0<depth) {\n+                    int64 txTime = tx.GetTxTime();\n+                    unsigned int blockTime = index->nTime;\n+                    if (blockTime != txTime) {\n+                        tx.nTimeReceived = blockTime;\n+                        tx.MarkDirty();\n+                        tx.WriteToDisk();\n+\n+                        NotifyTransactionChanged(this, hash, CT_UPDATED);\n+\n+                        char buf[1024];\n+                        sprintf(\n+                            buf,\n+                            \"TX=%s OLDTIME=%d NEWTIME=%d\\n\",\n+                            hash.ToString().c_str(),\n+                            (int)txTime,\n+                            (int)blockTime\n+                        );\n+                        result += buf;\n+                    }\n+                }\n+            }\n+        }\n+    }\n+    return true;\n+}\n+\n void CWallet::ReacceptWalletTransactions()\n {\n     bool fRepeat = true;\n@@ -880,8 +921,6 @@ void CWallet::ResendWalletTransactions()\n \n \n \n-\n-\n //////////////////////////////////////////////////////////////////////////////\n //\n // Actions"
      },
      {
        "sha": "12c011baab11d6c7746d0df82bdca0dfc5bd3937",
        "filename": "src/wallet.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/36d24ae3a2805bca1d54bf309e156e9293f1cb58/src/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/36d24ae3a2805bca1d54bf309e156e9293f1cb58/src/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet.h?ref=36d24ae3a2805bca1d54bf309e156e9293f1cb58",
        "patch": "@@ -166,6 +166,7 @@ class CWallet : public CCryptoKeyStore\n     bool EraseFromWallet(uint256 hash);\n     void WalletUpdateSpent(const CTransaction& prevout);\n     int ScanForWalletTransactions(CBlockIndex* pindexStart, bool fUpdate = false);\n+    bool ResetTransactionTime(std::string &result);\n     void ReacceptWalletTransactions();\n     void ResendWalletTransactions();\n     int64 GetBalance() const;"
      }
    ]
  },
  {
    "sha": "e148e8e6c459ec66929e4da5c1424efd10c77f08",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplMTQ4ZThlNmM0NTllYzY2OTI5ZTRkYTVjMTQyNGVmZDEwYzc3ZjA4",
    "commit": {
      "author": {
        "name": "Znort 987",
        "email": "znort987@yahoo.com",
        "date": "2012-11-06T14:33:12Z"
      },
      "committer": {
        "name": "Znort 987",
        "email": "znort987@yahoo.com",
        "date": "2012-11-06T14:33:12Z"
      },
      "message": "Force UI refresh on rpc-induced wallet changes.",
      "tree": {
        "sha": "65a5e2f85c943546d91955d44208463e453028c0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/65a5e2f85c943546d91955d44208463e453028c0"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e148e8e6c459ec66929e4da5c1424efd10c77f08",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e148e8e6c459ec66929e4da5c1424efd10c77f08",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e148e8e6c459ec66929e4da5c1424efd10c77f08",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e148e8e6c459ec66929e4da5c1424efd10c77f08/comments",
    "author": null,
    "committer": null,
    "parents": [
      {
        "sha": "36d24ae3a2805bca1d54bf309e156e9293f1cb58",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/36d24ae3a2805bca1d54bf309e156e9293f1cb58",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/36d24ae3a2805bca1d54bf309e156e9293f1cb58"
      }
    ],
    "stats": {
      "total": 55,
      "additions": 37,
      "deletions": 18
    },
    "files": [
      {
        "sha": "032a9c392264ccac4920b701ed73c1645c7ac8fd",
        "filename": "src/qt/transactiontablemodel.cpp",
        "status": "modified",
        "additions": 15,
        "deletions": 7,
        "changes": 22,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e148e8e6c459ec66929e4da5c1424efd10c77f08/src/qt/transactiontablemodel.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e148e8e6c459ec66929e4da5c1424efd10c77f08/src/qt/transactiontablemodel.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/transactiontablemodel.cpp?ref=e148e8e6c459ec66929e4da5c1424efd10c77f08",
        "patch": "@@ -68,15 +68,17 @@ class TransactionTablePriv\n     void refreshWallet()\n     {\n         OutputDebugStringF(\"refreshWallet\\n\");\n-        cachedWallet.clear();\n-        {\n-            LOCK(wallet->cs_wallet);\n-            for(std::map<uint256, CWalletTx>::iterator it = wallet->mapWallet.begin(); it != wallet->mapWallet.end(); ++it)\n+        parent->beginResetModel();\n+            cachedWallet.clear();\n             {\n-                if(TransactionRecord::showTransaction(it->second))\n-                    cachedWallet.append(TransactionRecord::decomposeTransaction(wallet, it->second));\n+                LOCK(wallet->cs_wallet);\n+                for(std::map<uint256, CWalletTx>::iterator it = wallet->mapWallet.begin(); it != wallet->mapWallet.end(); ++it)\n+                {\n+                    if(TransactionRecord::showTransaction(it->second))\n+                        cachedWallet.append(TransactionRecord::decomposeTransaction(wallet, it->second));\n+                }\n             }\n-        }\n+        parent->endResetModel();\n     }\n \n     /* Update our model of the wallet incrementally, to synchronize our model of the wallet\n@@ -86,6 +88,12 @@ class TransactionTablePriv\n      */\n     void updateWallet(const uint256 &hash, int status)\n     {\n+        if(CT_REBUILD_ALL == status)\n+        {\n+            refreshWallet();\n+            return;\n+        }\n+\n         OutputDebugStringF(\"updateWallet %s %i\\n\", hash.ToString().c_str(), status);\n         {\n             LOCK(wallet->cs_wallet);"
      },
      {
        "sha": "1a5dee93bddeae3a6f14830b7d7e5e14913baade",
        "filename": "src/rpcwallet.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 2,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e148e8e6c459ec66929e4da5c1424efd10c77f08/src/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e148e8e6c459ec66929e4da5c1424efd10c77f08/src/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpcwallet.cpp?ref=e148e8e6c459ec66929e4da5c1424efd10c77f08",
        "patch": "@@ -1242,8 +1242,16 @@ Value fixwalletdates(const Array& params, bool fHelp)\n             \"Reset wallet transactions date to that of the block they appear in.\");\n \n     std::string result;\n-    bool ok = pwalletMain->ResetTransactionTime(result);\n-    return result + (ok ? \"ok\\n\" : \"failed\\n\");\n+    int changedCount = pwalletMain->ResetTransactionTime(result);\n+    if (changedCount < 0) {\n+        result += \"failed.\\n\";\n+    }\n+    else {\n+        char buf[128];\n+        sprintf(buf, \"%d transactions were updated.\\n\", changedCount);\n+        result += buf;\n+    }\n+    return result;\n }\n \n "
      },
      {
        "sha": "7f71d7dc234ed2ea9b85c8b1915330d9ea9a612c",
        "filename": "src/ui_interface.h",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e148e8e6c459ec66929e4da5c1424efd10c77f08/src/ui_interface.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e148e8e6c459ec66929e4da5c1424efd10c77f08/src/ui_interface.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/ui_interface.h?ref=e148e8e6c459ec66929e4da5c1424efd10c77f08",
        "patch": "@@ -19,7 +19,8 @@ enum ChangeType\n {\n     CT_NEW,\n     CT_UPDATED,\n-    CT_DELETED\n+    CT_DELETED,\n+    CT_REBUILD_ALL\n };\n \n /** Signals for UI communication. */"
      },
      {
        "sha": "489d5f90d3b241d4542e88e7011ac7fb6a8f8472",
        "filename": "src/wallet.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 7,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e148e8e6c459ec66929e4da5c1424efd10c77f08/src/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e148e8e6c459ec66929e4da5c1424efd10c77f08/src/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet.cpp?ref=e148e8e6c459ec66929e4da5c1424efd10c77f08",
        "patch": "@@ -767,28 +767,29 @@ int CWallet::ScanForWalletTransactions(CBlockIndex* pindexStart, bool fUpdate)\n // Change the date of each transaction in the wallet to the\n // timestamp of the block the transactions appears in. The\n // time of TXs not yet appearing in a block remain unchanged.\n-bool CWallet::ResetTransactionTime(std::string &result)\n+int CWallet::ResetTransactionTime(std::string &result)\n {\n+    uint256 hash;\n+    int changedCount = 0;\n     printf(\"ResetTransactionTime()\\n\");\n     {\n         LOCK(cs_wallet);\n         BOOST_FOREACH(PAIRTYPE(const uint256, CWalletTx)& item, mapWallet) {\n-            const uint256 &hash = item.first;\n             CWalletTx &tx = item.second;\n             if (tx.IsInMainChain()) {\n                 CBlockIndex *index;\n                 int depth = tx.GetDepthInMainChain(index);\n                 if (0<depth) {\n                     int64 txTime = tx.GetTxTime();\n                     unsigned int blockTime = index->nTime;\n-                    if (blockTime != txTime) {\n-                        tx.nTimeReceived = blockTime;\n+                    if (blockTime != (unsigned int)txTime) {\n+                        tx.nTimeReceived = tx.nTimeSmart = blockTime;\n                         tx.MarkDirty();\n                         tx.WriteToDisk();\n-\n-                        NotifyTransactionChanged(this, hash, CT_UPDATED);\n+                        ++changedCount;\n \n                         char buf[1024];\n+                        hash = item.first;\n                         sprintf(\n                             buf,\n                             \"TX=%s OLDTIME=%d NEWTIME=%d\\n\",\n@@ -802,7 +803,8 @@ bool CWallet::ResetTransactionTime(std::string &result)\n             }\n         }\n     }\n-    return true;\n+    if (0<changedCount) NotifyTransactionChanged(this, hash, CT_REBUILD_ALL);\n+    return changedCount;\n }\n \n void CWallet::ReacceptWalletTransactions()"
      },
      {
        "sha": "28bd2b89235638531216762bd168cf380e4197a0",
        "filename": "src/wallet.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e148e8e6c459ec66929e4da5c1424efd10c77f08/src/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e148e8e6c459ec66929e4da5c1424efd10c77f08/src/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet.h?ref=e148e8e6c459ec66929e4da5c1424efd10c77f08",
        "patch": "@@ -166,7 +166,7 @@ class CWallet : public CCryptoKeyStore\n     bool EraseFromWallet(uint256 hash);\n     void WalletUpdateSpent(const CTransaction& prevout);\n     int ScanForWalletTransactions(CBlockIndex* pindexStart, bool fUpdate = false);\n-    bool ResetTransactionTime(std::string &result);\n+    int ResetTransactionTime(std::string &result);\n     void ReacceptWalletTransactions();\n     void ResendWalletTransactions();\n     int64 GetBalance() const;"
      }
    ]
  }
]