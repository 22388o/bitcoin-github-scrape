{
  "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044",
  "id": 369668879,
  "node_id": "MDExOlB1bGxSZXF1ZXN0MzY5NjY4ODc5",
  "html_url": "https://github.com/bitcoin/bitcoin/pull/18044",
  "diff_url": "https://github.com/bitcoin/bitcoin/pull/18044.diff",
  "patch_url": "https://github.com/bitcoin/bitcoin/pull/18044.patch",
  "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18044",
  "number": 18044,
  "state": "closed",
  "locked": false,
  "title": "Use wtxid for transaction relay",
  "user": {
    "login": "sdaftuar",
    "id": 7463573,
    "node_id": "MDQ6VXNlcjc0NjM1NzM=",
    "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/sdaftuar",
    "html_url": "https://github.com/sdaftuar",
    "followers_url": "https://api.github.com/users/sdaftuar/followers",
    "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
    "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
    "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
    "repos_url": "https://api.github.com/users/sdaftuar/repos",
    "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
    "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
    "type": "User",
    "site_admin": false
  },
  "body": "Using txids (a transaction's hash, without witness) for transaction relay is problematic, post-segwit -- if a peer gives us a segwit transaction that fails policy checks, it could be because the txid associated with the transaction is definitely unacceptable to our node (regardless of the witness), or it could be that the transaction was malleated and with a different witness, the txid could be accepted to our mempool.\r\n\r\nWe have a bloom filter of recently rejected transactions, whose purpose is to help us avoid redownloading and revalidating transactions that fail to be accepted, but because of this potential for witness malleability to interfere with relay of valid transactions, we do not use the filter for segwit transactions.  This issue is discussed at some length in #8279.  The effect of this is that whenever a segwit transaction that fails policy checks is relayed, a node would download that transaction from every peer announcing it, because it has no way presently to cache failure.  Historically this hasn't been a big problem, but if/when policy for accepting segwit transactions were to change (eg taproot, or any other change), we could expect older nodes talking to newer nodes to be wasting bandwidth because of this.\r\n\r\nAs discussed in that issue, switching to wtxid-based relay solves this problem -- by using an identifier for a transaction that commits to all the data in our relay protocol, we can be certain if a transaction that a peer is announcing is one that we've already tried to process, or if it's something new.  This PR introduces support for wtxid-based relay with peers that support it (and remains backwards compatible with peers that use txids for relay, of course).\r\n\r\nApart from code correctness, one issue to be aware of is that by downloading from old and new peers alike, we should expect there to be some bandwidth wasted, because sometimes we might download the same transaction via txid-relay as well as wtxid-relay.  The last commit in this PR implements a heuristic I want to analyze, which is to just delay relay from txid-relay peers by 2 seconds, if we have at least 1 wtxid-based peer.  I've just started running a couple nodes with this heuristic so I can measure how well it works, but I'm open to other ideas for minimizing that issue.  In the long run, I think this will be essentially a non-issue, so I don't think it's too big a concern, we just need to bite the bullet and deal with it during upgrade.\r\n\r\nFinally, this proposal would need a simple BIP describing the changes, which I haven't yet drafted.  However, review and testing of this code in the interim would be welcome.\r\n\r\nTo do items:\r\n- [x] Write BIP explaining the spec here (1 new p2p message for negotiating wtxid-based relay, along with a new INV type)\r\n- [ ] Measure and evaluate a heuristic for minimizing how often a node downloads the same transaction twice, when connected to old and new nodes.",
  "created_at": "2020-01-31T16:42:02Z",
  "updated_at": "2020-10-15T19:18:30Z",
  "closed_at": "2020-07-22T19:00:22Z",
  "merged_at": "2020-07-22T19:00:22Z",
  "merge_commit_sha": "ccef10261efc235c8fcc8aad54556615b0cc23be",
  "assignee": null,
  "assignees": [],
  "requested_reviewers": [],
  "requested_teams": [],
  "labels": [
    {
      "id": 98298007,
      "node_id": "MDU6TGFiZWw5ODI5ODAwNw==",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/P2P",
      "name": "P2P",
      "color": "006b75",
      "default": false,
      "description": null
    },
    {
      "id": 164208572,
      "node_id": "MDU6TGFiZWwxNjQyMDg1NzI=",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Mempool",
      "name": "Mempool",
      "color": "fef2c0",
      "default": false,
      "description": null
    },
    {
      "id": 1648013533,
      "node_id": "MDU6TGFiZWwxNjQ4MDEzNTMz",
      "url": "https://api.github.com/repos/bitcoin/bitcoin/labels/Review%20club",
      "name": "Review club",
      "color": "0052cc",
      "default": false,
      "description": ""
    }
  ],
  "milestone": null,
  "draft": false,
  "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044/commits",
  "review_comments_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044/comments",
  "review_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments{/number}",
  "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/18044/comments",
  "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
  "head": {
    "label": "sdaftuar:2020-01-wtxid-inv",
    "ref": "2020-01-wtxid-inv",
    "sha": "0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb",
    "user": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "repo": {
      "id": 28761781,
      "node_id": "MDEwOlJlcG9zaXRvcnkyODc2MTc4MQ==",
      "name": "bitcoin",
      "full_name": "sdaftuar/bitcoin",
      "private": false,
      "owner": {
        "login": "sdaftuar",
        "id": 7463573,
        "node_id": "MDQ6VXNlcjc0NjM1NzM=",
        "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sdaftuar",
        "html_url": "https://github.com/sdaftuar",
        "followers_url": "https://api.github.com/users/sdaftuar/followers",
        "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
        "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
        "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
        "repos_url": "https://api.github.com/users/sdaftuar/repos",
        "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
        "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/sdaftuar/bitcoin",
      "description": "Bitcoin Core integration/staging tree",
      "fork": true,
      "url": "https://api.github.com/repos/sdaftuar/bitcoin",
      "forks_url": "https://api.github.com/repos/sdaftuar/bitcoin/forks",
      "keys_url": "https://api.github.com/repos/sdaftuar/bitcoin/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/sdaftuar/bitcoin/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/sdaftuar/bitcoin/teams",
      "hooks_url": "https://api.github.com/repos/sdaftuar/bitcoin/hooks",
      "issue_events_url": "https://api.github.com/repos/sdaftuar/bitcoin/issues/events{/number}",
      "events_url": "https://api.github.com/repos/sdaftuar/bitcoin/events",
      "assignees_url": "https://api.github.com/repos/sdaftuar/bitcoin/assignees{/user}",
      "branches_url": "https://api.github.com/repos/sdaftuar/bitcoin/branches{/branch}",
      "tags_url": "https://api.github.com/repos/sdaftuar/bitcoin/tags",
      "blobs_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/sdaftuar/bitcoin/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/sdaftuar/bitcoin/languages",
      "stargazers_url": "https://api.github.com/repos/sdaftuar/bitcoin/stargazers",
      "contributors_url": "https://api.github.com/repos/sdaftuar/bitcoin/contributors",
      "subscribers_url": "https://api.github.com/repos/sdaftuar/bitcoin/subscribers",
      "subscription_url": "https://api.github.com/repos/sdaftuar/bitcoin/subscription",
      "commits_url": "https://api.github.com/repos/sdaftuar/bitcoin/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/sdaftuar/bitcoin/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/sdaftuar/bitcoin/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/sdaftuar/bitcoin/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/sdaftuar/bitcoin/contents/{+path}",
      "compare_url": "https://api.github.com/repos/sdaftuar/bitcoin/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/sdaftuar/bitcoin/merges",
      "archive_url": "https://api.github.com/repos/sdaftuar/bitcoin/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/sdaftuar/bitcoin/downloads",
      "issues_url": "https://api.github.com/repos/sdaftuar/bitcoin/issues{/number}",
      "pulls_url": "https://api.github.com/repos/sdaftuar/bitcoin/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/sdaftuar/bitcoin/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/sdaftuar/bitcoin/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/sdaftuar/bitcoin/labels{/name}",
      "releases_url": "https://api.github.com/repos/sdaftuar/bitcoin/releases{/id}",
      "deployments_url": "https://api.github.com/repos/sdaftuar/bitcoin/deployments",
      "created_at": "2015-01-04T02:52:13Z",
      "updated_at": "2018-08-21T18:58:53Z",
      "pushed_at": "2021-07-19T17:01:21Z",
      "git_url": "git://github.com/sdaftuar/bitcoin.git",
      "ssh_url": "git@github.com:sdaftuar/bitcoin.git",
      "clone_url": "https://github.com/sdaftuar/bitcoin.git",
      "svn_url": "https://github.com/sdaftuar/bitcoin",
      "homepage": "https://bitcoin.org/en/download",
      "size": 195711,
      "stargazers_count": 0,
      "watchers_count": 0,
      "language": "C++",
      "has_issues": false,
      "has_projects": true,
      "has_downloads": false,
      "has_wiki": false,
      "has_pages": false,
      "forks_count": 1,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 1,
      "license": {
        "key": "mit",
        "name": "MIT License",
        "spdx_id": "MIT",
        "url": "https://api.github.com/licenses/mit",
        "node_id": "MDc6TGljZW5zZTEz"
      },
      "allow_forking": true,
      "is_template": false,
      "topics": [],
      "visibility": "public",
      "forks": 1,
      "open_issues": 1,
      "watchers": 0,
      "default_branch": "master"
    }
  },
  "base": {
    "label": "bitcoin:master",
    "ref": "master",
    "sha": "090d87716074434bdc6c7656ec44d049197a793a",
    "user": {
      "login": "bitcoin",
      "id": 528860,
      "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/bitcoin",
      "html_url": "https://github.com/bitcoin",
      "followers_url": "https://api.github.com/users/bitcoin/followers",
      "following_url": "https://api.github.com/users/bitcoin/following{/other_user}",
      "gists_url": "https://api.github.com/users/bitcoin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/bitcoin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
      "organizations_url": "https://api.github.com/users/bitcoin/orgs",
      "repos_url": "https://api.github.com/users/bitcoin/repos",
      "events_url": "https://api.github.com/users/bitcoin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/bitcoin/received_events",
      "type": "Organization",
      "site_admin": false
    },
    "repo": {
      "id": 1181927,
      "node_id": "MDEwOlJlcG9zaXRvcnkxMTgxOTI3",
      "name": "bitcoin",
      "full_name": "bitcoin/bitcoin",
      "private": false,
      "owner": {
        "login": "bitcoin",
        "id": 528860,
        "node_id": "MDEyOk9yZ2FuaXphdGlvbjUyODg2MA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/528860?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/bitcoin",
        "html_url": "https://github.com/bitcoin",
        "followers_url": "https://api.github.com/users/bitcoin/followers",
        "following_url": "https://api.github.com/users/bitcoin/following{/other_user}",
        "gists_url": "https://api.github.com/users/bitcoin/gists{/gist_id}",
        "starred_url": "https://api.github.com/users/bitcoin/starred{/owner}{/repo}",
        "subscriptions_url": "https://api.github.com/users/bitcoin/subscriptions",
        "organizations_url": "https://api.github.com/users/bitcoin/orgs",
        "repos_url": "https://api.github.com/users/bitcoin/repos",
        "events_url": "https://api.github.com/users/bitcoin/events{/privacy}",
        "received_events_url": "https://api.github.com/users/bitcoin/received_events",
        "type": "Organization",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin/bitcoin",
      "description": "Bitcoin Core integration/staging tree",
      "fork": false,
      "url": "https://api.github.com/repos/bitcoin/bitcoin",
      "forks_url": "https://api.github.com/repos/bitcoin/bitcoin/forks",
      "keys_url": "https://api.github.com/repos/bitcoin/bitcoin/keys{/key_id}",
      "collaborators_url": "https://api.github.com/repos/bitcoin/bitcoin/collaborators{/collaborator}",
      "teams_url": "https://api.github.com/repos/bitcoin/bitcoin/teams",
      "hooks_url": "https://api.github.com/repos/bitcoin/bitcoin/hooks",
      "issue_events_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/events{/number}",
      "events_url": "https://api.github.com/repos/bitcoin/bitcoin/events",
      "assignees_url": "https://api.github.com/repos/bitcoin/bitcoin/assignees{/user}",
      "branches_url": "https://api.github.com/repos/bitcoin/bitcoin/branches{/branch}",
      "tags_url": "https://api.github.com/repos/bitcoin/bitcoin/tags",
      "blobs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/blobs{/sha}",
      "git_tags_url": "https://api.github.com/repos/bitcoin/bitcoin/git/tags{/sha}",
      "git_refs_url": "https://api.github.com/repos/bitcoin/bitcoin/git/refs{/sha}",
      "trees_url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees{/sha}",
      "statuses_url": "https://api.github.com/repos/bitcoin/bitcoin/statuses/{sha}",
      "languages_url": "https://api.github.com/repos/bitcoin/bitcoin/languages",
      "stargazers_url": "https://api.github.com/repos/bitcoin/bitcoin/stargazers",
      "contributors_url": "https://api.github.com/repos/bitcoin/bitcoin/contributors",
      "subscribers_url": "https://api.github.com/repos/bitcoin/bitcoin/subscribers",
      "subscription_url": "https://api.github.com/repos/bitcoin/bitcoin/subscription",
      "commits_url": "https://api.github.com/repos/bitcoin/bitcoin/commits{/sha}",
      "git_commits_url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits{/sha}",
      "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/comments{/number}",
      "issue_comment_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments{/number}",
      "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/{+path}",
      "compare_url": "https://api.github.com/repos/bitcoin/bitcoin/compare/{base}...{head}",
      "merges_url": "https://api.github.com/repos/bitcoin/bitcoin/merges",
      "archive_url": "https://api.github.com/repos/bitcoin/bitcoin/{archive_format}{/ref}",
      "downloads_url": "https://api.github.com/repos/bitcoin/bitcoin/downloads",
      "issues_url": "https://api.github.com/repos/bitcoin/bitcoin/issues{/number}",
      "pulls_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls{/number}",
      "milestones_url": "https://api.github.com/repos/bitcoin/bitcoin/milestones{/number}",
      "notifications_url": "https://api.github.com/repos/bitcoin/bitcoin/notifications{?since,all,participating}",
      "labels_url": "https://api.github.com/repos/bitcoin/bitcoin/labels{/name}",
      "releases_url": "https://api.github.com/repos/bitcoin/bitcoin/releases{/id}",
      "deployments_url": "https://api.github.com/repos/bitcoin/bitcoin/deployments",
      "created_at": "2010-12-19T15:16:43Z",
      "updated_at": "2021-12-02T06:25:25Z",
      "pushed_at": "2021-12-02T06:16:37Z",
      "git_url": "git://github.com/bitcoin/bitcoin.git",
      "ssh_url": "git@github.com:bitcoin/bitcoin.git",
      "clone_url": "https://github.com/bitcoin/bitcoin.git",
      "svn_url": "https://github.com/bitcoin/bitcoin",
      "homepage": "https://bitcoincore.org/en/download",
      "size": 188182,
      "stargazers_count": 59735,
      "watchers_count": 59735,
      "language": "C++",
      "has_issues": true,
      "has_projects": true,
      "has_downloads": false,
      "has_wiki": false,
      "has_pages": false,
      "forks_count": 30710,
      "mirror_url": null,
      "archived": false,
      "disabled": false,
      "open_issues_count": 1023,
      "license": {
        "key": "mit",
        "name": "MIT License",
        "spdx_id": "MIT",
        "url": "https://api.github.com/licenses/mit",
        "node_id": "MDc6TGljZW5zZTEz"
      },
      "allow_forking": true,
      "is_template": false,
      "topics": [
        "bitcoin",
        "c-plus-plus",
        "cryptocurrency",
        "cryptography",
        "p2p"
      ],
      "visibility": "public",
      "forks": 30710,
      "open_issues": 1023,
      "watchers": 59735,
      "default_branch": "master"
    }
  },
  "_links": {
    "self": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044"
    },
    "html": {
      "href": "https://github.com/bitcoin/bitcoin/pull/18044"
    },
    "issue": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/issues/18044"
    },
    "comments": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/issues/18044/comments"
    },
    "review_comments": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044/comments"
    },
    "review_comment": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments{/number}"
    },
    "commits": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/18044/commits"
    },
    "statuses": {
      "href": "https://api.github.com/repos/bitcoin/bitcoin/statuses/0a4f1422cd1c20e12a05d7ff1a2ef1d5e7c654bb"
    }
  },
  "author_association": "MEMBER",
  "auto_merge": null,
  "active_lock_reason": null,
  "merged": true,
  "mergeable": null,
  "rebaseable": null,
  "mergeable_state": "unknown",
  "merged_by": {
    "login": "laanwj",
    "id": 126646,
    "node_id": "MDQ6VXNlcjEyNjY0Ng==",
    "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/laanwj",
    "html_url": "https://github.com/laanwj",
    "followers_url": "https://api.github.com/users/laanwj/followers",
    "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
    "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
    "organizations_url": "https://api.github.com/users/laanwj/orgs",
    "repos_url": "https://api.github.com/users/laanwj/repos",
    "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
    "received_events_url": "https://api.github.com/users/laanwj/received_events",
    "type": "User",
    "site_admin": false
  },
  "comments": 44,
  "review_comments": 178,
  "maintainer_can_modify": false,
  "commits": 18,
  "additions": 450,
  "deletions": 114,
  "changed_files": 18
}