[
  {
    "sha": "4894e368fa61cbae1370a8b83581533b0b223f45",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0ODk0ZTM2OGZhNjFjYmFlMTM3MGE4YjgzNTgxNTMzYjBiMjIzZjQ1",
    "commit": {
      "author": {
        "name": "Evan Klitzke",
        "email": "evan@eklitzke.org",
        "date": "2018-03-15T13:54:11Z"
      },
      "committer": {
        "name": "Evan Klitzke",
        "email": "evan@eklitzke.org",
        "date": "2018-03-15T16:46:11Z"
      },
      "message": "Fix possible data race when committing block files\n\nIt was recently pointed out to me that calling fsync() or fdatasync() on a new\nfile is not sufficient to ensure it's persisted to disk, a the existence of the\nfile itself is stored in the directory inode. This means that ensuring that a\nnew file is actually committed also requires an fsync() on the parent directory.\n\nThis change ensures that we call fsync() on the blocks directory after\ncommitting new block files.",
      "tree": {
        "sha": "30ac5f029e1de530351db1beb44cdb2dcc08752c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/30ac5f029e1de530351db1beb44cdb2dcc08752c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4894e368fa61cbae1370a8b83581533b0b223f45",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEr5FzGLjELREnIWJdFX78rLxkhCIFAlqqo1sACgkQFX78rLxk\nhCKRwQ//azXB8P0RkiTspwaf/ojJy2oweEN/vQa+rz/9iRTk0FB8i63G987qFVgh\nz8iz5QmE+yspM/n3L5wWsqWJ4lKlwVMVdNgScDlN/+Am4SvYLzQLYQkLvtt78AY5\ni8SHHLkpO7nEUucdr3ZPpSWASfZniCn1XpSawSa27/BLyZgcE/ddEeKRcujtAGOr\nLY5Dsp7mp1GhSiArODDmR2UscYF1c4eY5rM+v24zlPuPRawIVJ19Mbh1pykAdYwQ\nYUdRxIXtojlEOtajbniGZPs3wmBOvwjEA+45og+iZMS6gWuQ5HkjhueU2Ybj+Me3\nug4EyldWh9122WmL8i1wlSKM/vKy9UV+JA7g1vuQu1R3CmrtZI9iB2kSAMxaEzMb\nCNrg/E9mruXBHgMl4C5AcgPOtD9f7Y07p+vxgkvzGL/Ys84wJxo917VNw05HnNVg\nyHko/llL0xZAq+xwBfSWgsw7ieUzhWyDvKFoH9Rm+YNtc2/ig78ALuYXlsdn2HJO\nCFdP6XIuQiHD/gCH9DeiirNtZZa9lb7lwAMMgwbGZwj5N7XG1eUpRgUwlPAzgX42\nADF0VJB76HXUJugUHixeaR1QaYm+QNbVvK6qpxEZ140DcE9dQWHQzmC4U33/mveU\nQV0eF18gu6WNgATp+Ic54YcjWIM3Y8ezf6sziMQSn6YV5b9opws=\n=UYiZ\n-----END PGP SIGNATURE-----",
        "payload": "tree 30ac5f029e1de530351db1beb44cdb2dcc08752c\nparent e057589dc67f25da6779b60d0e247a3730adbc6d\nauthor Evan Klitzke <evan@eklitzke.org> 1521122051 -0700\ncommitter Evan Klitzke <evan@eklitzke.org> 1521132371 -0700\n\nFix possible data race when committing block files\n\nIt was recently pointed out to me that calling fsync() or fdatasync() on a new\nfile is not sufficient to ensure it's persisted to disk, a the existence of the\nfile itself is stored in the directory inode. This means that ensuring that a\nnew file is actually committed also requires an fsync() on the parent directory.\n\nThis change ensures that we call fsync() on the blocks directory after\ncommitting new block files.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4894e368fa61cbae1370a8b83581533b0b223f45",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/4894e368fa61cbae1370a8b83581533b0b223f45",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4894e368fa61cbae1370a8b83581533b0b223f45/comments",
    "author": {
      "login": "eklitzke",
      "id": 2734,
      "node_id": "MDQ6VXNlcjI3MzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2734?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eklitzke",
      "html_url": "https://github.com/eklitzke",
      "followers_url": "https://api.github.com/users/eklitzke/followers",
      "following_url": "https://api.github.com/users/eklitzke/following{/other_user}",
      "gists_url": "https://api.github.com/users/eklitzke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eklitzke/subscriptions",
      "organizations_url": "https://api.github.com/users/eklitzke/orgs",
      "repos_url": "https://api.github.com/users/eklitzke/repos",
      "events_url": "https://api.github.com/users/eklitzke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eklitzke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "eklitzke",
      "id": 2734,
      "node_id": "MDQ6VXNlcjI3MzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2734?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eklitzke",
      "html_url": "https://github.com/eklitzke",
      "followers_url": "https://api.github.com/users/eklitzke/followers",
      "following_url": "https://api.github.com/users/eklitzke/following{/other_user}",
      "gists_url": "https://api.github.com/users/eklitzke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eklitzke/subscriptions",
      "organizations_url": "https://api.github.com/users/eklitzke/orgs",
      "repos_url": "https://api.github.com/users/eklitzke/repos",
      "events_url": "https://api.github.com/users/eklitzke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eklitzke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e057589dc67f25da6779b60d0e247a3730adbc6d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e057589dc67f25da6779b60d0e247a3730adbc6d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e057589dc67f25da6779b60d0e247a3730adbc6d"
      }
    ],
    "stats": {
      "total": 33,
      "additions": 27,
      "deletions": 6
    },
    "files": [
      {
        "sha": "a29e56f7fba4b802b8438aec98277a1d5b207d71",
        "filename": "configure.ac",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4894e368fa61cbae1370a8b83581533b0b223f45/configure.ac",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4894e368fa61cbae1370a8b83581533b0b223f45/configure.ac",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/configure.ac?ref=4894e368fa61cbae1370a8b83581533b0b223f45",
        "patch": "@@ -623,6 +623,7 @@ if test x$TARGET_OS = xdarwin; then\n fi\n \n AC_CHECK_HEADERS([endian.h sys/endian.h byteswap.h stdio.h stdlib.h unistd.h strings.h sys/types.h sys/stat.h sys/select.h sys/prctl.h])\n+AC_CHECK_FUNCS([fdatasync])\n \n AC_CHECK_DECLS([strnlen])\n "
      },
      {
        "sha": "ab928f12352e44faa40da11323956ed64f442235",
        "filename": "src/util.cpp",
        "status": "modified",
        "additions": 13,
        "deletions": 6,
        "changes": 19,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4894e368fa61cbae1370a8b83581533b0b223f45/src/util.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4894e368fa61cbae1370a8b83581533b0b223f45/src/util.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util.cpp?ref=4894e368fa61cbae1370a8b83581533b0b223f45",
        "patch": "@@ -732,14 +732,21 @@ void FileCommit(FILE *file)\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);\n-#else\n-    #if defined(__linux__) || defined(__NetBSD__)\n-    fdatasync(fileno(file));\n-    #elif defined(__APPLE__) && defined(F_FULLFSYNC)\n+#elif defined(__APPLE__) && defined(F_FULLFSYNC)\n     fcntl(fileno(file), F_FULLFSYNC, 0);\n-    #else\n+#elif HAVE_FDATASYNC\n+    fdatasync(fileno(file));\n+#else\n+    fsync(fileno(file));\n+#endif\n+}\n+\n+void DirectoryCommit(const fs::path &dirname)\n+{\n+#ifndef WIN32\n+    FILE* file = fsbridge::fopen(dirname, \"r\");\n     fsync(fileno(file));\n-    #endif\n+    fclose(file);\n #endif\n }\n "
      },
      {
        "sha": "90bcf7ac126f901577a04abc761453abd081bd8e",
        "filename": "src/util.h",
        "status": "modified",
        "additions": 12,
        "deletions": 0,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4894e368fa61cbae1370a8b83581533b0b223f45/src/util.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4894e368fa61cbae1370a8b83581533b0b223f45/src/util.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util.h?ref=4894e368fa61cbae1370a8b83581533b0b223f45",
        "patch": "@@ -168,7 +168,19 @@ bool error(const char* fmt, const Args&... args)\n }\n \n void PrintExceptionContinue(const std::exception *pex, const char* pszThread);\n+\n+/**\n+ * Ensure file contents are fully committed to disk, using a platform-specific\n+ * feature analogous to fsync().\n+ */\n void FileCommit(FILE *file);\n+\n+/**\n+ * Sync directory contents. This is required on some environments to ensure that\n+ * newly created files are committed to disk.\n+ */\n+void DirectoryCommit(const fs::path &dirname);\n+\n bool TruncateFile(FILE *file, unsigned int length);\n int RaiseFileDescriptorLimit(int nMinFD);\n void AllocateFileRange(FILE *file, unsigned int offset, unsigned int length);"
      },
      {
        "sha": "8c12067c05b1b8f1b60f86962c8669d5b9b0cf3d",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4894e368fa61cbae1370a8b83581533b0b223f45/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4894e368fa61cbae1370a8b83581533b0b223f45/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=4894e368fa61cbae1370a8b83581533b0b223f45",
        "patch": "@@ -1614,6 +1614,7 @@ void static FlushBlockFile(bool fFinalize = false)\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);\n         FileCommit(fileOld);\n+        DirectoryCommit(GetDataDir() / \"blocks\");\n         fclose(fileOld);\n     }\n "
      }
    ]
  }
]