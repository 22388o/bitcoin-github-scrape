[
  {
    "sha": "02e1e4eff6cda0bfc24b455a7c1583394cbff6eb",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowMmUxZTRlZmY2Y2RhMGJmYzI0YjQ1NWE3YzE1ODMzOTRjYmZmNmVi",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-11-20T17:52:15Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-11-23T16:54:22Z"
      },
      "message": "rpc: Add wait argument to stop",
      "tree": {
        "sha": "237289b00a226826bf8a34b05e59fd228bd193e0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/237289b00a226826bf8a34b05e59fd228bd193e0"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/02e1e4eff6cda0bfc24b455a7c1583394cbff6eb",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/02e1e4eff6cda0bfc24b455a7c1583394cbff6eb",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/02e1e4eff6cda0bfc24b455a7c1583394cbff6eb",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/02e1e4eff6cda0bfc24b455a7c1583394cbff6eb/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "59f05d1161698dcca6eaf719422d4ec3401f2954",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/59f05d1161698dcca6eaf719422d4ec3401f2954",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/59f05d1161698dcca6eaf719422d4ec3401f2954"
      }
    ],
    "stats": {
      "total": 9,
      "additions": 8,
      "deletions": 1
    },
    "files": [
      {
        "sha": "6f1bfb03d15f089dc5eee79aa8798b65622e8611",
        "filename": "src/rpc/client.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/02e1e4eff6cda0bfc24b455a7c1583394cbff6eb/src/rpc/client.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/02e1e4eff6cda0bfc24b455a7c1583394cbff6eb/src/rpc/client.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/client.cpp?ref=02e1e4eff6cda0bfc24b455a7c1583394cbff6eb",
        "patch": "@@ -162,6 +162,7 @@ static const CRPCConvertParam vRPCConvertParams[] =\n     { \"rescanblockchain\", 1, \"stop_height\"},\n     { \"createwallet\", 1, \"disable_private_keys\"},\n     { \"getnodeaddresses\", 0, \"count\"},\n+    { \"stop\", 0, \"wait\" },\n };\n // clang-format on\n "
      },
      {
        "sha": "865d343eb27b6b7e705c4695bcec59b0fbc2050b",
        "filename": "src/rpc/server.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 1,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/02e1e4eff6cda0bfc24b455a7c1583394cbff6eb/src/rpc/server.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/02e1e4eff6cda0bfc24b455a7c1583394cbff6eb/src/rpc/server.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/server.cpp?ref=02e1e4eff6cda0bfc24b455a7c1583394cbff6eb",
        "patch": "@@ -227,6 +227,9 @@ UniValue help(const JSONRPCRequest& jsonRequest)\n UniValue stop(const JSONRPCRequest& jsonRequest)\n {\n     // Accept the deprecated and ignored 'detach' boolean argument\n+    // Also accept the hidden 'wait' integer argument (milliseconds)\n+    // For instance, 'stop 1000' makes the call wait 1 second before returning\n+    // to the client (intended for testing)\n     if (jsonRequest.fHelp || jsonRequest.params.size() > 1)\n         throw std::runtime_error(\n             RPCHelpMan{\"stop\",\n@@ -235,6 +238,9 @@ UniValue stop(const JSONRPCRequest& jsonRequest)\n     // Event loop will exit after current HTTP requests have been handled, so\n     // this reply will get back to the client.\n     StartShutdown();\n+    if (jsonRequest.params[0].isNum()) {\n+        MilliSleep(jsonRequest.params[0].get_int());\n+    }\n     return \"Bitcoin server stopping\";\n }\n \n@@ -264,7 +270,7 @@ static const CRPCCommand vRPCCommands[] =\n   //  --------------------- ------------------------  -----------------------  ----------\n     /* Overall control/query calls */\n     { \"control\",            \"help\",                   &help,                   {\"command\"}  },\n-    { \"control\",            \"stop\",                   &stop,                   {}  },\n+    { \"control\",            \"stop\",                   &stop,                   {\"wait\"}  },\n     { \"control\",            \"uptime\",                 &uptime,                 {}  },\n };\n // clang-format on"
      }
    ]
  },
  {
    "sha": "18e968581697078c36a3c3818f8906cf134ccadd",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxOGU5Njg1ODE2OTcwNzhjMzZhM2MzODE4Zjg5MDZjZjEzNGNjYWRk",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-11-07T09:08:56Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-11-23T16:54:22Z"
      },
      "message": "http: Send \"Connection: close\" header if shutdown is requested\n\nSending the header \"Connection: close\" makes libevent close persistent\nconnections (implicit with HTTP 1.1) which cleans the event base when\nshutdown is requested.",
      "tree": {
        "sha": "7d35027438359b4d24581257c408eb2c35db89c2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7d35027438359b4d24581257c408eb2c35db89c2"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/18e968581697078c36a3c3818f8906cf134ccadd",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/18e968581697078c36a3c3818f8906cf134ccadd",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/18e968581697078c36a3c3818f8906cf134ccadd",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/18e968581697078c36a3c3818f8906cf134ccadd/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "02e1e4eff6cda0bfc24b455a7c1583394cbff6eb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/02e1e4eff6cda0bfc24b455a7c1583394cbff6eb",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/02e1e4eff6cda0bfc24b455a7c1583394cbff6eb"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 4,
      "deletions": 0
    },
    "files": [
      {
        "sha": "342956f7a301f7a9588b85f2f00e1cb0adba8d4d",
        "filename": "src/httpserver.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/18e968581697078c36a3c3818f8906cf134ccadd/src/httpserver.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/18e968581697078c36a3c3818f8906cf134ccadd/src/httpserver.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/httpserver.cpp?ref=18e968581697078c36a3c3818f8906cf134ccadd",
        "patch": "@@ -10,6 +10,7 @@\n #include <util/strencodings.h>\n #include <netbase.h>\n #include <rpc/protocol.h> // For HTTP status codes\n+#include <shutdown.h>\n #include <sync.h>\n #include <ui_interface.h>\n \n@@ -583,6 +584,9 @@ void HTTPRequest::WriteHeader(const std::string& hdr, const std::string& value)\n void HTTPRequest::WriteReply(int nStatus, const std::string& strReply)\n {\n     assert(!replySent && req);\n+    if (ShutdownRequested()) {\n+        WriteHeader(\"Connection\", \"close\");\n+    }\n     // Send event to main http thread to send reply message\n     struct evbuffer* evb = evhttp_request_get_output_buffer(req);\n     assert(evb);"
      }
    ]
  },
  {
    "sha": "6b13580f4e3842c11abd9b8bee7255fb2472b6fe",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2YjEzNTgwZjRlMzg0MmMxMWFiZDliOGJlZTcyNTVmYjI0NzJiNmZl",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-11-07T09:10:07Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-11-23T16:54:22Z"
      },
      "message": "http: Unlisten sockets after all workers quit\n\nThis (almost) move only ensures the event base loop doesn't exit before\nHTTP worker threads exit. This way events registered by HTTP workers are\nprocessed and not discarded.",
      "tree": {
        "sha": "25be2a420acdc03d64ff89a256cbaffa6b6a2c55",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/25be2a420acdc03d64ff89a256cbaffa6b6a2c55"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6b13580f4e3842c11abd9b8bee7255fb2472b6fe",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6b13580f4e3842c11abd9b8bee7255fb2472b6fe",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/6b13580f4e3842c11abd9b8bee7255fb2472b6fe",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6b13580f4e3842c11abd9b8bee7255fb2472b6fe/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "18e968581697078c36a3c3818f8906cf134ccadd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/18e968581697078c36a3c3818f8906cf134ccadd",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/18e968581697078c36a3c3818f8906cf134ccadd"
      }
    ],
    "stats": {
      "total": 10,
      "additions": 6,
      "deletions": 4
    },
    "files": [
      {
        "sha": "0ab9d966dc8b8912ce053c461537789e1a243954",
        "filename": "src/httpserver.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 4,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6b13580f4e3842c11abd9b8bee7255fb2472b6fe/src/httpserver.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6b13580f4e3842c11abd9b8bee7255fb2472b6fe/src/httpserver.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/httpserver.cpp?ref=6b13580f4e3842c11abd9b8bee7255fb2472b6fe",
        "patch": "@@ -443,10 +443,6 @@ void InterruptHTTPServer()\n {\n     LogPrint(BCLog::HTTP, \"Interrupting HTTP server\\n\");\n     if (eventHTTP) {\n-        // Unlisten sockets\n-        for (evhttp_bound_socket *socket : boundSockets) {\n-            evhttp_del_accept_socket(eventHTTP, socket);\n-        }\n         // Reject requests on current connections\n         evhttp_set_gencb(eventHTTP, http_reject_request_cb, nullptr);\n     }\n@@ -466,6 +462,12 @@ void StopHTTPServer()\n         delete workQueue;\n         workQueue = nullptr;\n     }\n+    // Unlisten sockets, these are what make the event loop running, which means\n+    // that after this and all connections are closed the event loop will quit.\n+    for (evhttp_bound_socket *socket : boundSockets) {\n+        evhttp_del_accept_socket(eventHTTP, socket);\n+    }\n+    boundSockets.clear();\n     if (eventBase) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n         // Exit the event loop as soon as there are no active events."
      }
    ]
  },
  {
    "sha": "e98a9eede2fb48ff33a020acc888cbcd83e24bbf",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplOThhOWVlZGUyZmI0OGZmMzNhMDIwYWNjODg4Y2JjZDgzZTI0YmJm",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-11-07T09:11:16Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-11-23T16:54:22Z"
      },
      "message": "http: Remove unnecessary event_base_loopexit call\n\nLet event base loop exit cleanly by processing all active and pending\nevents. The call is no longer necessary because closing persistent\nconnections is now properly handled.",
      "tree": {
        "sha": "54a36b55f9ed1cec4defb689ef0bf44691e93788",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/54a36b55f9ed1cec4defb689ef0bf44691e93788"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e98a9eede2fb48ff33a020acc888cbcd83e24bbf",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e98a9eede2fb48ff33a020acc888cbcd83e24bbf",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e98a9eede2fb48ff33a020acc888cbcd83e24bbf",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e98a9eede2fb48ff33a020acc888cbcd83e24bbf/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6b13580f4e3842c11abd9b8bee7255fb2472b6fe",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6b13580f4e3842c11abd9b8bee7255fb2472b6fe",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6b13580f4e3842c11abd9b8bee7255fb2472b6fe"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 0,
      "deletions": 2
    },
    "files": [
      {
        "sha": "2cc83eecdca1d246b895648e8b22cb1c86c3ddb3",
        "filename": "src/httpserver.cpp",
        "status": "modified",
        "additions": 0,
        "deletions": 2,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e98a9eede2fb48ff33a020acc888cbcd83e24bbf/src/httpserver.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e98a9eede2fb48ff33a020acc888cbcd83e24bbf/src/httpserver.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/httpserver.cpp?ref=e98a9eede2fb48ff33a020acc888cbcd83e24bbf",
        "patch": "@@ -470,8 +470,6 @@ void StopHTTPServer()\n     boundSockets.clear();\n     if (eventBase) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        // Exit the event loop as soon as there are no active events.\n-        event_base_loopexit(eventBase, nullptr);\n         // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n         // Before this was solved with event_base_loopexit, but that didn't work as expected in\n         // at least libevent 2.0.21 and always introduced a delay. In libevent"
      }
    ]
  },
  {
    "sha": "8d3f46ec3938e2ba17654fecacd1d2629f9915fd",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4ZDNmNDZlYzM5MzhlMmJhMTc2NTRmZWNhY2QxZDI2MjlmOTkxNWZk",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-11-07T09:13:36Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-11-23T16:54:22Z"
      },
      "message": "http: Remove timeout to exit event loop\n\nLet HTTP connections to timeout due to inactivity.\nLet all remaning connections finish sending the response and close.",
      "tree": {
        "sha": "cef894f455148a38d77d20b525c0e4cd6954d115",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cef894f455148a38d77d20b525c0e4cd6954d115"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8d3f46ec3938e2ba17654fecacd1d2629f9915fd",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8d3f46ec3938e2ba17654fecacd1d2629f9915fd",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/8d3f46ec3938e2ba17654fecacd1d2629f9915fd",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8d3f46ec3938e2ba17654fecacd1d2629f9915fd/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e98a9eede2fb48ff33a020acc888cbcd83e24bbf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e98a9eede2fb48ff33a020acc888cbcd83e24bbf",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e98a9eede2fb48ff33a020acc888cbcd83e24bbf"
      }
    ],
    "stats": {
      "total": 16,
      "additions": 1,
      "deletions": 15
    },
    "files": [
      {
        "sha": "cb8578927a46be78145638b9eeda5c11be713c83",
        "filename": "src/httpserver.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 15,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8d3f46ec3938e2ba17654fecacd1d2629f9915fd/src/httpserver.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8d3f46ec3938e2ba17654fecacd1d2629f9915fd/src/httpserver.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/httpserver.cpp?ref=8d3f46ec3938e2ba17654fecacd1d2629f9915fd",
        "patch": "@@ -22,7 +22,6 @@\n #include <sys/types.h>\n #include <sys/stat.h>\n #include <signal.h>\n-#include <future>\n \n #include <event2/thread.h>\n #include <event2/buffer.h>\n@@ -422,17 +421,14 @@ bool UpdateHTTPServerLogging(bool enable) {\n }\n \n std::thread threadHTTP;\n-std::future<bool> threadResult;\n static std::vector<std::thread> g_thread_http_workers;\n \n void StartHTTPServer()\n {\n     LogPrint(BCLog::HTTP, \"Starting HTTP server\\n\");\n     int rpcThreads = std::max((long)gArgs.GetArg(\"-rpcthreads\", DEFAULT_HTTP_THREADS), 1L);\n     LogPrintf(\"HTTP: starting %d worker threads\\n\", rpcThreads);\n-    std::packaged_task<bool(event_base*)> task(ThreadHTTP);\n-    threadResult = task.get_future();\n-    threadHTTP = std::thread(std::move(task), eventBase);\n+    threadHTTP = std::thread(ThreadHTTP, eventBase);\n \n     for (int i = 0; i < rpcThreads; i++) {\n         g_thread_http_workers.emplace_back(HTTPWorkQueueRun, workQueue);\n@@ -470,16 +466,6 @@ void StopHTTPServer()\n     boundSockets.clear();\n     if (eventBase) {\n         LogPrint(BCLog::HTTP, \"Waiting for HTTP event thread to exit\\n\");\n-        // Give event loop a few seconds to exit (to send back last RPC responses), then break it\n-        // Before this was solved with event_base_loopexit, but that didn't work as expected in\n-        // at least libevent 2.0.21 and always introduced a delay. In libevent\n-        // master that appears to be solved, so in the future that solution\n-        // could be used again (if desirable).\n-        // (see discussion in https://github.com/bitcoin/bitcoin/pull/6990)\n-        if (threadResult.valid() && threadResult.wait_for(std::chrono::milliseconds(2000)) == std::future_status::timeout) {\n-            LogPrintf(\"HTTP event loop did not exit within allotted time, sending loopbreak\\n\");\n-            event_base_loopbreak(eventBase);\n-        }\n         threadHTTP.join();\n     }\n     if (eventHTTP) {"
      }
    ]
  },
  {
    "sha": "28479f926f21f2a91bec5a06671c60e5b0c55532",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyODQ3OWY5MjZmMjFmMmE5MWJlYzVhMDY2NzFjNjBlNWIwYzU1NTMy",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-11-20T17:59:07Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2018-11-23T16:54:22Z"
      },
      "message": "qa: Test bitcond shutdown",
      "tree": {
        "sha": "6b986bb8b54cde9fd0ff999fba4235711b290ebf",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6b986bb8b54cde9fd0ff999fba4235711b290ebf"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/28479f926f21f2a91bec5a06671c60e5b0c55532",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/28479f926f21f2a91bec5a06671c60e5b0c55532",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/28479f926f21f2a91bec5a06671c60e5b0c55532",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/28479f926f21f2a91bec5a06671c60e5b0c55532/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "8d3f46ec3938e2ba17654fecacd1d2629f9915fd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8d3f46ec3938e2ba17654fecacd1d2629f9915fd",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/8d3f46ec3938e2ba17654fecacd1d2629f9915fd"
      }
    ],
    "stats": {
      "total": 41,
      "additions": 35,
      "deletions": 6
    },
    "files": [
      {
        "sha": "b633fabb1fac7a8e2898094946d008362519d2e0",
        "filename": "test/functional/feature_shutdown.py",
        "status": "added",
        "additions": 28,
        "deletions": 0,
        "changes": 28,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/28479f926f21f2a91bec5a06671c60e5b0c55532/test/functional/feature_shutdown.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/28479f926f21f2a91bec5a06671c60e5b0c55532/test/functional/feature_shutdown.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/feature_shutdown.py?ref=28479f926f21f2a91bec5a06671c60e5b0c55532",
        "patch": "@@ -0,0 +1,28 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2018 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test bitcoind shutdown.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import assert_equal, get_rpc_proxy\n+from threading import Thread\n+\n+def test_long_call(node):\n+    block = node.waitfornewblock()\n+    assert_equal(block['height'], 0)\n+\n+class ShutdownTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        node = get_rpc_proxy(self.nodes[0].url, 1, timeout=600, coveragedir=self.nodes[0].coverage_dir)\n+        Thread(target=test_long_call, args=(node,)).start()\n+        # wait 1 second to ensure event loop waits for current connections to close\n+        self.stop_node(0, wait=1000)\n+\n+if __name__ == '__main__':\n+    ShutdownTest().main()"
      },
      {
        "sha": "ded070540093a294a268c0b123da1cb220f40c45",
        "filename": "test/functional/test_framework/test_framework.py",
        "status": "modified",
        "additions": 4,
        "deletions": 4,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/28479f926f21f2a91bec5a06671c60e5b0c55532/test/functional/test_framework/test_framework.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/28479f926f21f2a91bec5a06671c60e5b0c55532/test/functional/test_framework/test_framework.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_framework/test_framework.py?ref=28479f926f21f2a91bec5a06671c60e5b0c55532",
        "patch": "@@ -325,16 +325,16 @@ def start_nodes(self, extra_args=None, *args, **kwargs):\n             for node in self.nodes:\n                 coverage.write_all_rpc_commands(self.options.coveragedir, node.rpc)\n \n-    def stop_node(self, i, expected_stderr=''):\n+    def stop_node(self, i, expected_stderr='', wait=0):\n         \"\"\"Stop a bitcoind test node\"\"\"\n-        self.nodes[i].stop_node(expected_stderr)\n+        self.nodes[i].stop_node(expected_stderr, wait=wait)\n         self.nodes[i].wait_until_stopped()\n \n-    def stop_nodes(self):\n+    def stop_nodes(self, wait=0):\n         \"\"\"Stop multiple bitcoind test nodes\"\"\"\n         for node in self.nodes:\n             # Issue RPC to stop nodes\n-            node.stop_node()\n+            node.stop_node(wait=wait)\n \n         for node in self.nodes:\n             # Wait for nodes to stop"
      },
      {
        "sha": "be90535526e87c5101534aa786d2ac3558bd7edf",
        "filename": "test/functional/test_framework/test_node.py",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/28479f926f21f2a91bec5a06671c60e5b0c55532/test/functional/test_framework/test_node.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/28479f926f21f2a91bec5a06671c60e5b0c55532/test/functional/test_framework/test_node.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_framework/test_node.py?ref=28479f926f21f2a91bec5a06671c60e5b0c55532",
        "patch": "@@ -228,13 +228,13 @@ def get_wallet_rpc(self, wallet_name):\n             wallet_path = \"wallet/{}\".format(urllib.parse.quote(wallet_name))\n             return self.rpc / wallet_path\n \n-    def stop_node(self, expected_stderr=''):\n+    def stop_node(self, expected_stderr='', wait=0):\n         \"\"\"Stop the node.\"\"\"\n         if not self.running:\n             return\n         self.log.debug(\"Stopping node\")\n         try:\n-            self.stop()\n+            self.stop(wait=wait)\n         except http.client.CannotSendRequest:\n             self.log.exception(\"Unable to stop node.\")\n "
      },
      {
        "sha": "2dc3abcfe6bc89b05db7d572da92e62b7edf3fa6",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/28479f926f21f2a91bec5a06671c60e5b0c55532/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/28479f926f21f2a91bec5a06671c60e5b0c55532/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=28479f926f21f2a91bec5a06671c60e5b0c55532",
        "patch": "@@ -185,6 +185,7 @@\n     'feature_config_args.py',\n     'rpc_help.py',\n     'feature_help.py',\n+    'feature_shutdown.py',\n     # Don't append tests at the end to avoid merge conflicts\n     # Put them in a random line within the section that fits their approximate run-time\n ]"
      }
    ]
  }
]