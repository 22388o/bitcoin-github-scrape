[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752116855",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752116855",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 752116855,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjExNjg1NQ==",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?u=0691974eedcc2ab5366cc1080fb1c030e87244c2&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-29T15:16:48Z",
    "updated_at": "2020-12-29T15:16:48Z",
    "author_association": "MEMBER",
    "body": "> Segwit was activated in August 2017, and providing non-witness blocks to peers is no longer useful\r\n\r\nI think there may be some edge-case scenarios where a peer skips the download of witnesses because they are never read (due to an assumevalid setting), but that has nothing to do with compact blocks. So:\r\n\r\nConcept ACK on removing code that doesn't serve any use case in practice.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752116855/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752197637",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752197637",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 752197637,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjE5NzYzNw==",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?u=7999a16349f0df0fb273fffa18e5a955c9d3f11c&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-29T18:35:44Z",
    "updated_at": "2020-12-29T18:35:44Z",
    "author_association": "MEMBER",
    "body": "Concept ACK on removing non-witness cmpctblock support. IIRC its only purpose is serving Bitcoin Core v0.13.0 nodes (0.12.x didn't have compact blocks; 0.13.1 added segwit activation parameters).\r\n\r\nThe first commit here seems to mix removal of functionality with some refactoring. Is it possible to separate those more cleanly into separate commits?",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752197637/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752208058",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752208058",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 752208058,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjIwODA1OA==",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?u=71263a00d1269c7f0ed6660aa0c15c894df78a88&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-29T19:06:41Z",
    "updated_at": "2020-12-29T19:06:41Z",
    "author_association": "MEMBER",
    "body": "> The first commit here seems to mix removal of functionality with some refactoring. Is it possible to separate those more cleanly into separate commits?\r\n\r\nYes, I'll see what I can do to split it up a bit more.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752208058/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752227632",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752227632",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 752227632,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjIyNzYzMg==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-29T20:17:04Z",
    "updated_at": "2021-11-28T08:48:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23127](https://github.com/bitcoin/bitcoin/pull/23127) (tests: Use test framework utils where possible by vincenzopalazzo)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752227632/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752233903",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-752233903",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 752233903,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MjIzMzkwMw==",
    "user": {
      "login": "practicalswift",
      "id": 7826565,
      "node_id": "MDQ6VXNlcjc4MjY1NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7826565?u=5ff13e375b40ea55ecd3c108337dd6a23f68eddf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/practicalswift",
      "html_url": "https://github.com/practicalswift",
      "followers_url": "https://api.github.com/users/practicalswift/followers",
      "following_url": "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url": "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
      "organizations_url": "https://api.github.com/users/practicalswift/orgs",
      "repos_url": "https://api.github.com/users/practicalswift/repos",
      "events_url": "https://api.github.com/users/practicalswift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/practicalswift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2020-12-29T20:39:16Z",
    "updated_at": "2020-12-29T20:39:16Z",
    "author_association": "CONTRIBUTOR",
    "body": "Concept ACK",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/752233903/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753459870",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-753459870",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 753459870,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MzQ1OTg3MA==",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-02T11:01:32Z",
    "updated_at": "2021-01-02T11:01:32Z",
    "author_association": "MEMBER",
    "body": "Concept ACK, looks like a good simplification. Worth reviewing the diffs with `-w` in some parts.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753459870/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753492261",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-753492261",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 753492261,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc1MzQ5MjI2MQ==",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?u=71263a00d1269c7f0ed6660aa0c15c894df78a88&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-02T16:15:55Z",
    "updated_at": "2021-01-02T16:15:55Z",
    "author_association": "MEMBER",
    "body": "Rebased and broken up the first commit.\r\n\r\nI've also dropped the last two commits (_Clean up PeerManager::BlockChecked()_ and _Clean up MaybeSetPeerAsAnnouncingHeaderAndIDs()_). There's already enough happening in this PR.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/753492261/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/766089490",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-766089490",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 766089490,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc2NjA4OTQ5MA==",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?u=348c27f90b6fff8fd72fa27232272651436a2ff0&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-01-23T14:40:30Z",
    "updated_at": "2021-01-23T14:40:30Z",
    "author_association": "CONTRIBUTOR",
    "body": "Concept ACK",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/766089490/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/772394673",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-772394673",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 772394673,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3MjM5NDY3Mw==",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?u=71263a00d1269c7f0ed6660aa0c15c894df78a88&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-03T10:14:16Z",
    "updated_at": "2021-02-03T10:14:16Z",
    "author_association": "MEMBER",
    "body": "Thanks for the review @jonatack @ariard @sipa @MarcoFalke . I think I've addresses all review comments now.\r\n\r\nThis PR is probably easier to review if rebased after #21009 is merged. That PR always sets `NODE_WITNESS` in local services, and so removes all the `pfrom->GetLocalServices() & NODE_WITNESS` calls in net_processing.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/772394673/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/774280869",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-774280869",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 774280869,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3NDI4MDg2OQ==",
    "user": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?u=65406da0f40524c00b8b647f916d31cbbb449edb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-05T20:49:07Z",
    "updated_at": "2021-02-05T20:49:07Z",
    "author_association": "CONTRIBUTOR",
    "body": "#21009 was split into #21009 and #21090. #21090 now sets `NODE_WITNESS` in local services, and so removes all the `pfrom->GetLocalServices() & NODE_WITNESS` calls in net_processing.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/774280869/reactions",
      "total_count": 1,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 1,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779176581",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-779176581",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 779176581,
    "node_id": "MDEyOklzc3VlQ29tbWVudDc3OTE3NjU4MQ==",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?u=71263a00d1269c7f0ed6660aa0c15c894df78a88&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-02-15T12:01:28Z",
    "updated_at": "2021-02-15T12:01:28Z",
    "author_association": "MEMBER",
    "body": "Marking this as draft. It's a smaller and cleaner change once #21090 is merged, so let's wait for that to land first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/779176581/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/827522553",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-827522553",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 827522553,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyNzUyMjU1Mw==",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?u=71263a00d1269c7f0ed6660aa0c15c894df78a88&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-27T11:05:48Z",
    "updated_at": "2021-04-27T11:05:48Z",
    "author_association": "MEMBER",
    "body": "I've rebased this on top of #21090. I'll still leave it as draft since we need that PR to be merged first, but this is ready for review if people are interested.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/827522553/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/829483684",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-829483684",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 829483684,
    "node_id": "MDEyOklzc3VlQ29tbWVudDgyOTQ4MzY4NA==",
    "user": {
      "login": "dhruv",
      "id": 856960,
      "node_id": "MDQ6VXNlcjg1Njk2MA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/856960?u=65406da0f40524c00b8b647f916d31cbbb449edb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/dhruv",
      "html_url": "https://github.com/dhruv",
      "followers_url": "https://api.github.com/users/dhruv/followers",
      "following_url": "https://api.github.com/users/dhruv/following{/other_user}",
      "gists_url": "https://api.github.com/users/dhruv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/dhruv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/dhruv/subscriptions",
      "organizations_url": "https://api.github.com/users/dhruv/orgs",
      "repos_url": "https://api.github.com/users/dhruv/repos",
      "events_url": "https://api.github.com/users/dhruv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/dhruv/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-04-29T18:18:21Z",
    "updated_at": "2021-04-29T18:18:21Z",
    "author_association": "CONTRIBUTOR",
    "body": "Reviewers interested in this PR, might also be interested in #21090 which is now ready for review.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/829483684/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/885080007",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-885080007",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 885080007,
    "node_id": "IC_kwDOABII5840wT_H",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?u=71263a00d1269c7f0ed6660aa0c15c894df78a88&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-07-22T17:18:26Z",
    "updated_at": "2021-07-22T17:18:26Z",
    "author_association": "MEMBER",
    "body": "#21090 has been merged, so I've rebased this on master. This is now ready for review.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/885080007/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/928991600",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-928991600",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 928991600,
    "node_id": "IC_kwDOABII5843X0lw",
    "user": {
      "login": "naumenkogs",
      "id": 7975071,
      "node_id": "MDQ6VXNlcjc5NzUwNzE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7975071?u=06eb9ae4f9b3f954056098860decccbf1340e40f&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/naumenkogs",
      "html_url": "https://github.com/naumenkogs",
      "followers_url": "https://api.github.com/users/naumenkogs/followers",
      "following_url": "https://api.github.com/users/naumenkogs/following{/other_user}",
      "gists_url": "https://api.github.com/users/naumenkogs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/naumenkogs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/naumenkogs/subscriptions",
      "organizations_url": "https://api.github.com/users/naumenkogs/orgs",
      "repos_url": "https://api.github.com/users/naumenkogs/repos",
      "events_url": "https://api.github.com/users/naumenkogs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/naumenkogs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-28T08:54:24Z",
    "updated_at": "2021-09-28T08:54:24Z",
    "author_association": "MEMBER",
    "body": "ACK ef698b6eb3a684f52cbd2414ffc07893bbf69bbd\r\n\r\nThe PR seems ready to get rid of pre-segwit compact blocks, which makes sense now that segwit is used.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/928991600/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931960457",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-931960457",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 931960457,
    "node_id": "IC_kwDOABII5843jJaJ",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-01T06:57:48Z",
    "updated_at": "2021-10-01T06:57:48Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--cf906140f33d8803c4a75a2196329ecb-->\n\ud83d\udc19 This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).\n\n<sub>Want to unsubscribe from rebase notifications on this pull request? Just convert this pull request to a \"draft\".</sub>",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/931960457/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937779377",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-937779377",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 937779377,
    "node_id": "IC_kwDOABII58435WCx",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?u=71263a00d1269c7f0ed6660aa0c15c894df78a88&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-07T13:12:39Z",
    "updated_at": "2021-10-07T13:12:39Z",
    "author_association": "MEMBER",
    "body": "rebased on master",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937779377/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937839641",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-937839641",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 937839641,
    "node_id": "IC_kwDOABII58435kwZ",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?u=71263a00d1269c7f0ed6660aa0c15c894df78a88&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-07T14:18:52Z",
    "updated_at": "2021-10-07T14:18:52Z",
    "author_association": "MEMBER",
    "body": "fixed silent merge conflict in p2p_compactblocks_blocksonly.py",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937839641/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/961086143",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-961086143",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 961086143,
    "node_id": "IC_kwDOABII5845SQK_",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?u=71263a00d1269c7f0ed6660aa0c15c894df78a88&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-04T14:44:30Z",
    "updated_at": "2021-11-04T14:44:30Z",
    "author_association": "MEMBER",
    "body": "Thanks for the review @theuni. I believe I've addressed all of your review comments.\r\n\r\n> I'm a little hazy on now NODE_WITNESS factors into these changes other than \"one kinda seems to imply the other\".\r\n\r\nYou're right. I've removed those changes.\r\n\r\nAlso rebased on master.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/961086143/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/961115511",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-961115511",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 961115511,
    "node_id": "IC_kwDOABII5845SXV3",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-04T14:58:30Z",
    "updated_at": "2021-11-04T14:58:30Z",
    "author_association": "MEMBER",
    "body": "> > I'm a little hazy on now NODE_WITNESS factors into these changes other than \"one kinda seems to imply the other\".\r\n> \r\n> You're right. I've removed those changes.\r\n\r\nThanks. To be clear though, these are seemingly reasonable changes worth evaluating separately. Just not necessary here for dropping v1 support.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/961115511/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/963389577",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#issuecomment-963389577",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/20799",
    "id": 963389577,
    "node_id": "IC_kwDOABII5845bCiJ",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?u=71263a00d1269c7f0ed6660aa0c15c894df78a88&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-08T17:25:45Z",
    "updated_at": "2021-11-08T17:25:45Z",
    "author_association": "MEMBER",
    "body": "Thanks for the re-review Cory. I've responded to your review comments.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/963389577/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549893599",
    "pull_request_review_id": 559744334,
    "id": 549893599,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTg5MzU5OQ==",
    "diff_hunk": "@@ -534,33 +519,31 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n-        // Never ask from peers who can't provide witnesses.\n-        return;\n-    }\n-    if (nodestate->fProvidesHeaderAndIDs) {\n+    if (!nodestate) return;\n+    if (nodestate->m_sendcmpct) {\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\n             if (*it == nodeid) {\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\n                 lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\n                 return;\n             }\n         }\n+\n+        if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n+            // As per BIP152, we only get 3 of our peers to announce\n+            // blocks using compact encodings.\n+            connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman](CNode* pnodeStop){\n+                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ false, /* version= */ uint64_t{2}));\n+                // save BIP152 bandwidth state: we select peer to be low-bandwidth\n+                pnodeStop->m_bip152_highbandwidth_to = false;\n+                return true;\n+            });\n+            lNodesAnnouncingHeaderAndIDs.pop_front();\n+        }\n+\n         connman.ForNode(nodeid, [&connman](CNode* pfrom) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n             AssertLockHeld(::cs_main);\n-            uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n-            if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n-                // As per BIP152, we only get 3 of our peers to announce\n-                // blocks using compact encodings.\n-                connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, nCMPCTBLOCKVersion](CNode* pnodeStop){\n-                    connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/false, nCMPCTBLOCKVersion));\n-                    // save BIP152 bandwidth state: we select peer to be low-bandwidth\n-                    pnodeStop->m_bip152_highbandwidth_to = false;\n-                    return true;\n-                });\n-                lNodesAnnouncingHeaderAndIDs.pop_front();\n-            }\n-            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\n+            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ true, /* version= */ uint64_t{2}));",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 86,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "58083b6dd0263d92811f10c5d79e3384efccf34e",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Maybe a static const int CMPCTBLOCK_VERSION? It sounds non-ambiguous, after this PR we only support one version.",
    "created_at": "2020-12-30T00:11:56Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r549893599",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549893599"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r549893599"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/549893599/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 546,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550212340",
    "pull_request_review_id": 560068745,
    "id": 550212340,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDIxMjM0MA==",
    "diff_hunk": "@@ -534,33 +519,31 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n-        // Never ask from peers who can't provide witnesses.\n-        return;\n-    }\n-    if (nodestate->fProvidesHeaderAndIDs) {\n+    if (!nodestate) return;\n+    if (nodestate->m_sendcmpct) {\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\n             if (*it == nodeid) {\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\n                 lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\n                 return;\n             }\n         }\n+\n+        if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n+            // As per BIP152, we only get 3 of our peers to announce\n+            // blocks using compact encodings.\n+            connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman](CNode* pnodeStop){\n+                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ false, /* version= */ uint64_t{2}));\n+                // save BIP152 bandwidth state: we select peer to be low-bandwidth\n+                pnodeStop->m_bip152_highbandwidth_to = false;\n+                return true;\n+            });\n+            lNodesAnnouncingHeaderAndIDs.pop_front();\n+        }\n+\n         connman.ForNode(nodeid, [&connman](CNode* pfrom) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n             AssertLockHeld(::cs_main);\n-            uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n-            if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n-                // As per BIP152, we only get 3 of our peers to announce\n-                // blocks using compact encodings.\n-                connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, nCMPCTBLOCKVersion](CNode* pnodeStop){\n-                    connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/false, nCMPCTBLOCKVersion));\n-                    // save BIP152 bandwidth state: we select peer to be low-bandwidth\n-                    pnodeStop->m_bip152_highbandwidth_to = false;\n-                    return true;\n-                });\n-                lNodesAnnouncingHeaderAndIDs.pop_front();\n-            }\n-            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\n+            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ true, /* version= */ uint64_t{2}));",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 86,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "58083b6dd0263d92811f10c5d79e3384efccf34e",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Good idea! I'll add.",
    "created_at": "2020-12-30T14:26:41Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r550212340",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550212340"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r550212340"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550212340/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 546,
    "side": "RIGHT",
    "in_reply_to_id": 549893599
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550895939",
    "pull_request_review_id": 560643137,
    "id": 550895939,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDg5NTkzOQ==",
    "diff_hunk": "@@ -534,33 +519,31 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n-        // Never ask from peers who can't provide witnesses.\n-        return;\n-    }\n-    if (nodestate->fProvidesHeaderAndIDs) {\n+    if (!nodestate) return;\n+    if (nodestate->m_sendcmpct) {\n         for (std::list<NodeId>::iterator it = lNodesAnnouncingHeaderAndIDs.begin(); it != lNodesAnnouncingHeaderAndIDs.end(); it++) {\n             if (*it == nodeid) {\n                 lNodesAnnouncingHeaderAndIDs.erase(it);\n                 lNodesAnnouncingHeaderAndIDs.push_back(nodeid);\n                 return;\n             }\n         }\n+\n+        if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n+            // As per BIP152, we only get 3 of our peers to announce\n+            // blocks using compact encodings.\n+            connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman](CNode* pnodeStop){\n+                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ false, /* version= */ uint64_t{2}));\n+                // save BIP152 bandwidth state: we select peer to be low-bandwidth\n+                pnodeStop->m_bip152_highbandwidth_to = false;\n+                return true;\n+            });\n+            lNodesAnnouncingHeaderAndIDs.pop_front();\n+        }\n+\n         connman.ForNode(nodeid, [&connman](CNode* pfrom) EXCLUSIVE_LOCKS_REQUIRED(::cs_main) {\n             AssertLockHeld(::cs_main);\n-            uint64_t nCMPCTBLOCKVersion = (pfrom->GetLocalServices() & NODE_WITNESS) ? 2 : 1;\n-            if (lNodesAnnouncingHeaderAndIDs.size() >= 3) {\n-                // As per BIP152, we only get 3 of our peers to announce\n-                // blocks using compact encodings.\n-                connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman, nCMPCTBLOCKVersion](CNode* pnodeStop){\n-                    connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/false, nCMPCTBLOCKVersion));\n-                    // save BIP152 bandwidth state: we select peer to be low-bandwidth\n-                    pnodeStop->m_bip152_highbandwidth_to = false;\n-                    return true;\n-                });\n-                lNodesAnnouncingHeaderAndIDs.pop_front();\n-            }\n-            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, nCMPCTBLOCKVersion));\n+            connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT,  /* high_bandwidth= */ true, /* version= */ uint64_t{2}));",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 86,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "58083b6dd0263d92811f10c5d79e3384efccf34e",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done",
    "created_at": "2021-01-02T16:14:38Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r550895939",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550895939"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r550895939"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/550895939/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 546,
    "side": "RIGHT",
    "in_reply_to_id": 549893599
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552274108",
    "pull_request_review_id": 562228454,
    "id": 552274108,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjI3NDEwOA==",
    "diff_hunk": "@@ -535,7 +528,7 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n+    if (!nodestate || !nodestate->fProvidesHeadersAndIDs) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 32,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "5ca83df9ac1f9f1454ebe7fd93c3b79012df104c",
    "user": {
      "login": "mzumsande",
      "id": 48763452,
      "node_id": "MDQ6VXNlcjQ4NzYzNDUy",
      "avatar_url": "https://avatars.githubusercontent.com/u/48763452?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mzumsande",
      "html_url": "https://github.com/mzumsande",
      "followers_url": "https://api.github.com/users/mzumsande/followers",
      "following_url": "https://api.github.com/users/mzumsande/following{/other_user}",
      "gists_url": "https://api.github.com/users/mzumsande/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mzumsande/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mzumsande/subscriptions",
      "organizations_url": "https://api.github.com/users/mzumsande/orgs",
      "repos_url": "https://api.github.com/users/mzumsande/repos",
      "events_url": "https://api.github.com/users/mzumsande/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mzumsande/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: typo in 5ca83df9ac1f9f1454ebe7fd93c3b79012df104c (should be fProvidesHeade**rA**ndIDs) here and in two other spots. It is fixed in the next commit but this intermediate one won't compile.",
    "created_at": "2021-01-06T00:08:38Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552274108",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552274108"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552274108"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552274108/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 531,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552799786",
    "pull_request_review_id": 562871514,
    "id": 552799786,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjc5OTc4Ng==",
    "diff_hunk": "@@ -535,7 +528,7 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n+    if (!nodestate || !nodestate->fProvidesHeadersAndIDs) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 32,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "5ca83df9ac1f9f1454ebe7fd93c3b79012df104c",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": ":flushed: Thanks!",
    "created_at": "2021-01-06T16:49:49Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552799786",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552799786"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552799786"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552799786/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 531,
    "side": "RIGHT",
    "in_reply_to_id": 552274108
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552897452",
    "pull_request_review_id": 562955246,
    "id": 552897452,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Mjg5NzQ1Mg==",
    "diff_hunk": "@@ -535,7 +528,7 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\n {\n     AssertLockHeld(cs_main);\n     CNodeState* nodestate = State(nodeid);\n-    if (!nodestate || !nodestate->fSupportsDesiredCmpctVersion) {\n+    if (!nodestate || !nodestate->fProvidesHeadersAndIDs) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 32,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "5ca83df9ac1f9f1454ebe7fd93c3b79012df104c",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "fixed",
    "created_at": "2021-01-06T18:45:15Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552897452",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552897452"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r552897452"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/552897452/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 531,
    "side": "RIGHT",
    "in_reply_to_id": 552274108
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563790168",
    "pull_request_review_id": 575483137,
    "id": 563790168,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Mzc5MDE2OA==",
    "diff_hunk": "@@ -141,21 +138,16 @@ def make_utxos(self):\n     #   made with compact blocks.\n     # - If sendcmpct is then sent with boolean 1, then new block announcements\n     #   are made with compact blocks.\n-    # If old_node is passed in, request compact blocks with version=preferred-1",
    "path": "test/functional/p2p_compactblocks.py",
    "position": 49,
    "original_position": 37,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "652c6f8 in line 136 just above, `preferred_version` no longer exists in this test after this commit; perhaps update that line",
    "created_at": "2021-01-25T15:01:38Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563790168",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563790168"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563790168"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563790168/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 194,
    "original_line": 194,
    "side": "LEFT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563801319",
    "pull_request_review_id": 575483137,
    "id": 563801319,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgwMTMxOQ==",
    "diff_hunk": "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "d0f352eb `uint8_t` (range 0-255) would suffice for now?\r\n\r\n```text\r\nBIP152\r\n====sendcmpct====\r\n# The sendcmpct message is defined as a message containing a 1-byte integer followed by a 8-byte integer where pchCommand == \"sendcmpct\".\r\n# The first integer SHALL be interpreted as a boolean (and MUST have a value of either 1 or 0)\r\n# The second integer SHALL be interpreted as a little-endian version number. Nodes sending a sendcmpct message MUST currently set this value to 1.\r\n```\r\n\r\n```diff\r\n@@ -147,7 +147,7 @@ static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\r\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\r\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\r\n /** The compactblocks version we support. See BIP 152. */\r\n-static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;\r\n+static constexpr uint8_t CMPCTBLOCKS_VERSION = 2;\r\n \r\n struct COrphanTx {\r\n     // When modifying, adapt the copy of this definition in tests/DoS_tests.\r\n@@ -2494,7 +2494,7 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\r\n \r\n     if (msg_type == NetMsgType::SENDCMPCT) {\r\n         bool sendcmpct_hb{false};\r\n-        uint64_t sendcmpct_version{0};\r\n+        uint8_t sendcmpct_version{0};\r\n         vRecv >> sendcmpct_hb >> sendcmpct_version;\r\n```\r\n",
    "created_at": "2021-01-25T15:15:32Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563801319",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563801319"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563801319"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563801319/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 155,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563811150",
    "pull_request_review_id": 575483137,
    "id": 563811150,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgxMTE1MA==",
    "diff_hunk": "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 223,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "d0f352eb can we avoid locking the mutex (and order dependance on `fHaveWitness` being set) with\r\n```diff\r\n- if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\r\n-     WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\r\n+ if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION && (pfrom.nServices & NODE_WITNESS)) {\r\n```\r\nor\r\n```diff\r\n- if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\r\n-     WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\r\n+ if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION && (pfrom.GetLocalServices() & NODE_WITNESS)) {\r\n```\r\n?",
    "created_at": "2021-01-25T15:27:37Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563811150",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563811150"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563811150"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563811150/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2714,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563818143",
    "pull_request_review_id": 575483137,
    "id": 563818143,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MzgxODE0Mw==",
    "diff_hunk": "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\n+            // Tell our peer we are willing to provide version 2 cmpctblocks.\n             // However, we do not request new block announcements using\n             // cmpctblock messages.\n             // We send this to non-NODE NETWORK peers as well, because\n             // they may wish to request compact blocks from us\n-            bool fAnnounceUsingCMPCTBLOCK = false;\n-            uint64_t nCMPCTBLOCKVersion = 2;\n-            if (pfrom.GetLocalServices() & NODE_WITNESS)\n-                m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n-            nCMPCTBLOCKVersion = 1;\n-            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n+            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */ false, /* version= */ CMPCTBLOCKS_VERSION));",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 235,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "d0f352e if you go with `/* high_bandwidth= */` here, maybe update the remaining 2 lines that use `fAnnounceUsingCMPCTBLOCK`\r\n\r\n```diff\r\n@@ -718,14 +718,14 @@ static void MaybeSetPeerAsAnnouncingHeaderAndIDs(NodeId nodeid, CConnman& connma\r\n             // As per BIP152, we only get 3 of our peers to announce\r\n             // blocks using compact encodings.\r\n             connman.ForNode(lNodesAnnouncingHeaderAndIDs.front(), [&connman](CNode* pnodeStop){\r\n-                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/false, CMPCTBLOCKS_VERSION));\r\n+                connman.PushMessage(pnodeStop, CNetMsgMaker(pnodeStop->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */false, CMPCTBLOCKS_VERSION));\r\n                 // save BIP152 bandwidth state: we select peer to be low-bandwidth\r\n                 pnodeStop->m_bip152_highbandwidth_to = false;\r\n                 return true;\r\n             });\r\n             lNodesAnnouncingHeaderAndIDs.pop_front();\r\n         }\r\n-        connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /*fAnnounceUsingCMPCTBLOCK=*/true, CMPCTBLOCKS_VERSION));\r\n+        connman.PushMessage(pfrom, CNetMsgMaker(pfrom->GetCommonVersion()).Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */true, CMPCTBLOCKS_VERSION));\r\n         // save BIP152 bandwidth state: we select peer to be high-bandwidth\r\n```\r\n\r\n",
    "created_at": "2021-01-25T15:36:14Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563818143",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563818143"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r563818143"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/563818143/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2484,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565513529",
    "pull_request_review_id": 577606090,
    "id": 565513529,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTUxMzUyOQ==",
    "diff_hunk": "@@ -141,19 +138,16 @@ def make_utxos(self):\n     #   made with compact blocks.\n     # - If sendcmpct is then sent with boolean 1, then new block announcements\n     #   are made with compact blocks.\n-    # If old_node is passed in, request compact blocks with version=preferred-1\n-    # and verify that it receives block announcements via compact block.\n-    def test_sendcmpct(self, test_node, old_node=None):\n-        preferred_version = test_node.cmpct_version\n+    def test_sendcmpct(self, test_node):\n         node = self.nodes[0]\n \n         # Make sure we get a SENDCMPCT message from our peer\n         def received_sendcmpct():\n             return (len(test_node.last_sendcmpct) > 0)\n         test_node.wait_until(received_sendcmpct, timeout=30)\n         with p2p_lock:\n-            # Check that the first version received is the preferred one\n-            assert_equal(test_node.last_sendcmpct[0].version, preferred_version)\n+            # Check that the first version received is version 2\n+            assert_equal(test_node.last_sendcmpct[0].version, 2)",
    "path": "test/functional/p2p_compactblocks.py",
    "position": 66,
    "original_position": 52,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "652c6f838809a5b277665704f816b527c7874cb6",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Constify test value same as `net_processing`, CMPCTBLOCKS_VERSION ?",
    "created_at": "2021-01-27T17:52:19Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565513529",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565513529"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565513529"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565513529/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 198,
    "original_line": 198,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565647594",
    "pull_request_review_id": 577606090,
    "id": 565647594,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY0NzU5NA==",
    "diff_hunk": "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 223,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Maybe we can rename SHORT_IDS_BLOCK_VERSION to SENDCMPCT_VERSION ? A block of short-txn-ids is better known as a compact block or do we have ambiguity here ?",
    "created_at": "2021-01-27T21:30:23Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565647594",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565647594"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565647594"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565647594/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2714,
    "side": "RIGHT",
    "in_reply_to_id": 563811150
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565653239",
    "pull_request_review_id": 577606090,
    "id": 565653239,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY1MzIzOQ==",
    "diff_hunk": "@@ -2496,18 +2498,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\n+            // Tell our peer we are willing to provide version 2 cmpctblocks.\n             // However, we do not request new block announcements using",
    "path": "src/net_processing.cpp",
    "position": 237,
    "original_position": 18,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "d0f352eb21acaec1f8e470133cec5dc393328ed7",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "AFAIU this comment tries to hint the double opt-in for CB to be bidirectional, maybe it can be clearer. \"However, we request new block announcements using CMPCTBLOCK only after receiving a SENDCMPCT from peer.\"",
    "created_at": "2021-01-27T21:40:17Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565653239",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565653239"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565653239"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565653239/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 2716,
    "original_line": 2716,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565664781",
    "pull_request_review_id": 577606090,
    "id": 565664781,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY2NDc4MQ==",
    "diff_hunk": "@@ -2521,25 +2521,27 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || ((pfrom.GetLocalServices() & NODE_WITNESS) && nCMPCTBLOCKVersion == 2)) {\n-            LOCK(cs_main);\n-            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n-            if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-                State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-                State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n-            }\n-            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n-                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-                // save whether peer selects us as BIP152 high-bandwidth peer\n-                // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-                pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-            }\n-            if (!State(pfrom.GetId())->fSupportsDesiredCmpctVersion) {\n-                if (pfrom.GetLocalServices() & NODE_WITNESS)\n-                    State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 2);\n-                else\n-                    State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 1);\n-            }\n+\n+        // Only support compact block relay with witnesses\n+        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 25,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "55c9231dc31f454d10d04994ec1ca7ea6b23f349",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think we should keep to verify NODE_WITNESS existence among peer services, that's a different network namespace than SENDCMPCT, they might diverge. \r\n\r\nI believe that's an oversight compared to \"Specification for version 2\" but at least should avoid to promote a buggy peer as a CB one ?\r\n\r\nEdit: reestablished at 06ab570, you should modify 55c9231 message to warn reviewers",
    "created_at": "2021-01-27T21:56:45Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565664781",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565664781"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565664781"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565664781/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2526,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565693959",
    "pull_request_review_id": 577606090,
    "id": 565693959,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY5Mzk1OQ==",
    "diff_hunk": "@@ -321,18 +321,12 @@ struct CNodeState {\n     bool fPreferHeaderAndIDs;\n     /**\n       * Whether this peer will send us cmpctblocks if we request them.\n-      * This is not used to gate request logic, as we really only care about fSupportsDesiredCmpctVersion,\n-      * but is used as a flag to \"lock in\" the version of compact blocks (fWantsCmpctWitness) we send.\n       */\n     bool fProvidesHeaderAndIDs;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 7,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "7b9c9eef61177a77c54341e5264580a3d6161fe4",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Current usage of `fProvidersHeaderAndIDs` is confusing to me. \r\n\r\nWe latched it to `true` at SENCMPCT reception, following this comment, it does mean this peer has signaled its availability to serve CMPCTBLOCKS.\r\n\r\nBut per-BIP152 , \"Upon receipt of a \"sendcmpct\" message with the first and second integers set to 1, the node SHOULD announce new blocks by sending a cmpctblock message.\", so a SENDCMPCT reception should only modify our behavior and doesn't constitute a commitment of the peer to send us CMPCTBLOCKS ?\r\n\r\n",
    "created_at": "2021-01-27T22:53:34Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565693959",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565693959"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565693959"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565693959/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 325,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565696618",
    "pull_request_review_id": 577606090,
    "id": 565696618,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY5NjYxOA==",
    "diff_hunk": "@@ -2507,25 +2507,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n     }\n \n     if (msg_type == NetMsgType::SENDCMPCT) {\n-        bool fAnnounceUsingCMPCTBLOCK = false;\n-        uint64_t nCMPCTBLOCKVersion = 0;\n-        vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n+        bool sendcmpct_hb{false};\n+        uint64_t sendcmpct_version{0};\n+        vRecv >> sendcmpct_hb >> sendcmpct_version;\n \n         // Only support compact block relay with witness peers\n         if (WITH_LOCK(cs_main, {return !State(pfrom.GetId())->fHaveWitness;})) return;\n         // Only support compact block relay with witnesses\n-        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;\n+        if (sendcmpct_version != CMPCTBLOCKS_VERSION) return;\n \n         LOCK(cs_main);\n-        if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-            State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-        }\n-        if (State(pfrom.GetId())->fProvidesHeaderAndIDs == true) { // ignore later version announces\n-            State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-            // save whether peer selects us as BIP152 high-bandwidth peer\n-            // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-            pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-        }\n+        CNodeState* nodestate = State(pfrom.GetId());\n+        nodestate->fProvidesHeaderAndIDs = true;\n+        nodestate->fPreferHeaderAndIDs = sendcmpct_hb;\n+        // save whether peer selects us as BIP152 high-bandwidth peer\n+        // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n+        pfrom.m_bip152_highbandwidth_from = sendcmpct_hb;",
    "path": "src/net_processing.cpp",
    "position": 287,
    "original_position": 32,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "019db79d7cd3679f44bd1c4dd375cb5e0690f5ff",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think this variable should be better named `m_bip152_bandwidth_mode`, right now when it sets to false it means low-bandwidth, which is counter-intuitive given variable name and comment (`src/net.h`, L533).",
    "created_at": "2021-01-27T22:58:58Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565696618",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565696618"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565696618"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565696618/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 2746,
    "original_line": 2746,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565698050",
    "pull_request_review_id": 577606090,
    "id": 565698050,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTY5ODA1MA==",
    "diff_hunk": "@@ -317,12 +317,10 @@ struct CNodeState {\n     bool fPreferredDownload;\n     //! Whether this peer wants invs or headers (when possible) for block announcements.\n     bool fPreferHeaders;\n-    //! Whether this peer wants invs or cmpctblocks (when possible) for block announcements.\n-    bool fPreferHeaderAndIDs;\n-    /**\n-      * Whether this peer will send us cmpctblocks if we request them.\n-      */\n-    bool fProvidesHeaderAndIDs;\n+    /** Whether this peer wants cmpctblocks (when possible) for block announcements. */\n+    bool m_sendcmpct_hb{false};",
    "path": "src/net_processing.cpp",
    "position": 22,
    "original_position": 11,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "c30fcbb959d7fced5e1b3e2487129df18fea0fe3",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "IMO `m_prefercmcpt`  better, otherwise name collusion is too close.",
    "created_at": "2021-01-27T23:02:11Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565698050",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565698050"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r565698050"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/565698050/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 701,
    "original_line": 701,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569244269",
    "pull_request_review_id": 582143471,
    "id": 569244269,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI0NDI2OQ==",
    "diff_hunk": "@@ -141,21 +138,16 @@ def make_utxos(self):\n     #   made with compact blocks.\n     # - If sendcmpct is then sent with boolean 1, then new block announcements\n     #   are made with compact blocks.\n-    # If old_node is passed in, request compact blocks with version=preferred-1",
    "path": "test/functional/p2p_compactblocks.py",
    "position": 49,
    "original_position": 37,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Good catch. Fixed!",
    "created_at": "2021-02-03T09:09:31Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569244269",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569244269"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569244269"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569244269/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 194,
    "original_line": 194,
    "side": "LEFT",
    "in_reply_to_id": 563790168
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569246726",
    "pull_request_review_id": 582146893,
    "id": 569246726,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI0NjcyNg==",
    "diff_hunk": "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The version field needs to be 8 bytes (uint64_t). If we change this const to a uint8_t, then the message serialized here:\r\n\r\n```\r\n            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */ false, /* version= */ CMPCTBLOCKS_VERSION));\r\n```\r\n\r\nwould have a payload size of 2 (1 byte for high_bandwidth, and 1 byte for version). That would fail to be parsed by other clients.",
    "created_at": "2021-02-03T09:13:07Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569246726",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569246726"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569246726"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569246726/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 155,
    "side": "RIGHT",
    "in_reply_to_id": 563801319
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569249275",
    "pull_request_review_id": 582150246,
    "id": 569249275,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI0OTI3NQ==",
    "diff_hunk": "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "That's a bit brittle in any case. Perhaps put `uint64_t{CMPCTBLOCKS_VERSION}` there instead?",
    "created_at": "2021-02-03T09:16:53Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569249275",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569249275"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569249275"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569249275/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 155,
    "side": "RIGHT",
    "in_reply_to_id": 563801319
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569254177",
    "pull_request_review_id": 582156776,
    "id": 569254177,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI1NDE3Nw==",
    "diff_hunk": "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "\"followed by a 8-byte integer\" -> I misread, thanks",
    "created_at": "2021-02-03T09:24:10Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569254177",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569254177"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569254177"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569254177/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 155,
    "side": "RIGHT",
    "in_reply_to_id": 563801319
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569255983",
    "pull_request_review_id": 582159141,
    "id": 569255983,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI1NTk4Mw==",
    "diff_hunk": "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 223,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> can we avoid locking the mutex\r\n\r\nVery nice observation, although I think this is ok for now. We take cs_main when processing almost all messages in net_processing (although I agree with you that it'd be slightly nicer if we didn't have to). In the new code, we're only sending `sendcmpct` if the peer has told us that they support witness serialization. That's indicated by fHaveWitness or pfrom.nServices (pfrom.GetLocalServices() is something different - it's the services we offered to the peer).\r\n\r\nfHaveWitness will move into Peer very soon as part of #19398, at which point it'll no longer be guarded by cs_main.\r\n\r\n> (and order dependance on fHaveWitness being set)\r\n\r\n`fHaveWitness` can only be set once in version handling, and this code in verack handling can only be hit after that.",
    "created_at": "2021-02-03T09:26:41Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569255983",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569255983"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569255983"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569255983/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2714,
    "side": "RIGHT",
    "in_reply_to_id": 563811150
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569262771",
    "pull_request_review_id": 582167957,
    "id": 569262771,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI2Mjc3MQ==",
    "diff_hunk": "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "or perhaps:\r\n\r\n```\r\n            static_assert(sizeof(CMPCTBLOCKS_VERSION) == sizeof(uint64_t), \"sendcmpct version field must be 8 bytes\");\r\n            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */ false, /* version= */ CMPCTBLOCKS_VERSION));\r\n```\r\n\r\n(why check at runtime what you can test at compile time?)",
    "created_at": "2021-02-03T09:36:11Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569262771",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569262771"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569262771"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569262771/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 155,
    "side": "RIGHT",
    "in_reply_to_id": 563801319
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569268859",
    "pull_request_review_id": 582176019,
    "id": 569268859,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI2ODg1OQ==",
    "diff_hunk": "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 223,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> Maybe we can rename SHORT_IDS_BLOCK_VERSION to SENDCMPCT_VERSION\r\n\r\nI do have a branch somewhere that does that, but it's out of scope for this PR.",
    "created_at": "2021-02-03T09:44:40Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569268859",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569268859"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569268859"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569268859/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2714,
    "side": "RIGHT",
    "in_reply_to_id": 563811150
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569271895",
    "pull_request_review_id": 582179720,
    "id": 569271895,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3MTg5NQ==",
    "diff_hunk": "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\n+            // Tell our peer we are willing to provide version 2 cmpctblocks.\n             // However, we do not request new block announcements using\n             // cmpctblock messages.\n             // We send this to non-NODE NETWORK peers as well, because\n             // they may wish to request compact blocks from us\n-            bool fAnnounceUsingCMPCTBLOCK = false;\n-            uint64_t nCMPCTBLOCKVersion = 2;\n-            if (pfrom.GetLocalServices() & NODE_WITNESS)\n-                m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n-            nCMPCTBLOCKVersion = 1;\n-            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, fAnnounceUsingCMPCTBLOCK, nCMPCTBLOCKVersion));\n+            m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDCMPCT, /* high_bandwidth= */ false, /* version= */ CMPCTBLOCKS_VERSION));",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 235,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Good suggestion. Done.",
    "created_at": "2021-02-03T09:48:39Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569271895",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569271895"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569271895"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569271895/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2484,
    "side": "RIGHT",
    "in_reply_to_id": 563818143
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569272914",
    "pull_request_review_id": 582181001,
    "id": 569272914,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3MjkxNA==",
    "diff_hunk": "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`uint64_t{CMPCTBLOCKS_VERSION}` is a compile time check ;)",
    "created_at": "2021-02-03T09:50:07Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569272914",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569272914"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569272914"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569272914/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 155,
    "side": "RIGHT",
    "in_reply_to_id": 563801319
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274044",
    "pull_request_review_id": 582182369,
    "id": 569274044,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3NDA0NA==",
    "diff_hunk": "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 223,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> I do have a branch somewhere that does that, but it's out of scope for this PR.\r\n\r\nHere you go: https://github.com/jnewbery/bitcoin/commit/82372335cc3cf8fa238678629dda6a2f465e6005. Feel free to PR that commit if you think it's worth it.",
    "created_at": "2021-02-03T09:51:37Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569274044",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274044"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569274044"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274044/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2714,
    "side": "RIGHT",
    "in_reply_to_id": 563811150
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274427",
    "pull_request_review_id": 582182924,
    "id": 569274427,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3NDQyNw==",
    "diff_hunk": "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I've added the static_assert.",
    "created_at": "2021-02-03T09:52:15Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569274427",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274427"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569274427"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569274427/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 155,
    "side": "RIGHT",
    "in_reply_to_id": 563801319
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569275855",
    "pull_request_review_id": 582184722,
    "id": 569275855,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3NTg1NQ==",
    "diff_hunk": "@@ -141,19 +138,16 @@ def make_utxos(self):\n     #   made with compact blocks.\n     # - If sendcmpct is then sent with boolean 1, then new block announcements\n     #   are made with compact blocks.\n-    # If old_node is passed in, request compact blocks with version=preferred-1\n-    # and verify that it receives block announcements via compact block.\n-    def test_sendcmpct(self, test_node, old_node=None):\n-        preferred_version = test_node.cmpct_version\n+    def test_sendcmpct(self, test_node):\n         node = self.nodes[0]\n \n         # Make sure we get a SENDCMPCT message from our peer\n         def received_sendcmpct():\n             return (len(test_node.last_sendcmpct) > 0)\n         test_node.wait_until(received_sendcmpct, timeout=30)\n         with p2p_lock:\n-            # Check that the first version received is the preferred one\n-            assert_equal(test_node.last_sendcmpct[0].version, preferred_version)\n+            # Check that the first version received is version 2\n+            assert_equal(test_node.last_sendcmpct[0].version, 2)",
    "path": "test/functional/p2p_compactblocks.py",
    "position": 66,
    "original_position": 52,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "652c6f838809a5b277665704f816b527c7874cb6",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I'm not sure if that adds to the readability here. Leaving for now.",
    "created_at": "2021-02-03T09:54:09Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569275855",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569275855"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569275855"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569275855/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 198,
    "original_line": 198,
    "side": "RIGHT",
    "in_reply_to_id": 565513529
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569279145",
    "pull_request_review_id": 582188794,
    "id": 569279145,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI3OTE0NQ==",
    "diff_hunk": "@@ -2496,18 +2498,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {\n+            // Tell our peer we are willing to provide version 2 cmpctblocks.\n             // However, we do not request new block announcements using",
    "path": "src/net_processing.cpp",
    "position": 237,
    "original_position": 18,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "d0f352eb21acaec1f8e470133cec5dc393328ed7",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This comment is saying that we don't request hb mode from the peer. We only add the peer to one of our three hb peers once it provides us with a block.\r\n\r\nIn any case, this comment is unchanged by this PR, so I'm going to leave it.",
    "created_at": "2021-02-03T09:58:23Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569279145",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569279145"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569279145"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569279145/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 2716,
    "original_line": 2716,
    "side": "RIGHT",
    "in_reply_to_id": 565653239
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569281077",
    "pull_request_review_id": 582191308,
    "id": 569281077,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4MTA3Nw==",
    "diff_hunk": "@@ -2521,25 +2521,27 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || ((pfrom.GetLocalServices() & NODE_WITNESS) && nCMPCTBLOCKVersion == 2)) {\n-            LOCK(cs_main);\n-            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n-            if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-                State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-                State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n-            }\n-            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n-                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-                // save whether peer selects us as BIP152 high-bandwidth peer\n-                // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-                pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-            }\n-            if (!State(pfrom.GetId())->fSupportsDesiredCmpctVersion) {\n-                if (pfrom.GetLocalServices() & NODE_WITNESS)\n-                    State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 2);\n-                else\n-                    State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 1);\n-            }\n+\n+        // Only support compact block relay with witnesses\n+        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 25,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "55c9231dc31f454d10d04994ec1ca7ea6b23f349",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`(pfrom.GetLocalServices() & NODE_WITNESS)` is always true (unless running on regtest with `-segwitheight=-1`). Perhaps this will be clearer after #21009 is merged.",
    "created_at": "2021-02-03T10:01:06Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569281077",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569281077"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569281077"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569281077/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2526,
    "side": "RIGHT",
    "in_reply_to_id": 565664781
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283130",
    "pull_request_review_id": 582194179,
    "id": 569283130,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4MzEzMA==",
    "diff_hunk": "@@ -321,18 +321,12 @@ struct CNodeState {\n     bool fPreferHeaderAndIDs;\n     /**\n       * Whether this peer will send us cmpctblocks if we request them.\n-      * This is not used to gate request logic, as we really only care about fSupportsDesiredCmpctVersion,\n-      * but is used as a flag to \"lock in\" the version of compact blocks (fWantsCmpctWitness) we send.\n       */\n     bool fProvidesHeaderAndIDs;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 7,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "7b9c9eef61177a77c54341e5264580a3d6161fe4",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes, these parameters are currently confusing (hence this PR to clean them up!)\r\n\r\n`fProvidersHeaderAndIDs` is currently used to make sure that the compact blocks version doesn't change after negotiation. If a peer sends `sendcmpct(version=2)`, then any future `sendcmpct` messages where version!=2 have no effect. The peer can change hb mode by sending `sendcmpct(version=2, hb_mode={true|false})`.\r\n\r\nThis is going away with this PR because the software will only recognize version 2 sendcmpct messages from now on.",
    "created_at": "2021-02-03T10:04:13Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569283130",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283130"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569283130"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283130/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 325,
    "side": "RIGHT",
    "in_reply_to_id": 565693959
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283877",
    "pull_request_review_id": 582195234,
    "id": 569283877,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4Mzg3Nw==",
    "diff_hunk": "@@ -2507,25 +2507,22 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n     }\n \n     if (msg_type == NetMsgType::SENDCMPCT) {\n-        bool fAnnounceUsingCMPCTBLOCK = false;\n-        uint64_t nCMPCTBLOCKVersion = 0;\n-        vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n+        bool sendcmpct_hb{false};\n+        uint64_t sendcmpct_version{0};\n+        vRecv >> sendcmpct_hb >> sendcmpct_version;\n \n         // Only support compact block relay with witness peers\n         if (WITH_LOCK(cs_main, {return !State(pfrom.GetId())->fHaveWitness;})) return;\n         // Only support compact block relay with witnesses\n-        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;\n+        if (sendcmpct_version != CMPCTBLOCKS_VERSION) return;\n \n         LOCK(cs_main);\n-        if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-            State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-        }\n-        if (State(pfrom.GetId())->fProvidesHeaderAndIDs == true) { // ignore later version announces\n-            State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-            // save whether peer selects us as BIP152 high-bandwidth peer\n-            // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-            pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-        }\n+        CNodeState* nodestate = State(pfrom.GetId());\n+        nodestate->fProvidesHeaderAndIDs = true;\n+        nodestate->fPreferHeaderAndIDs = sendcmpct_hb;\n+        // save whether peer selects us as BIP152 high-bandwidth peer\n+        // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n+        pfrom.m_bip152_highbandwidth_from = sendcmpct_hb;",
    "path": "src/net_processing.cpp",
    "position": 287,
    "original_position": 32,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "019db79d7cd3679f44bd1c4dd375cb5e0690f5ff",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This is unchanged by this PR. Eventually both of these fields should be moved to the `Peer` structure.",
    "created_at": "2021-02-03T10:05:21Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569283877",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283877"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569283877"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569283877/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 2746,
    "original_line": 2746,
    "side": "RIGHT",
    "in_reply_to_id": 565696618
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569285463",
    "pull_request_review_id": 582197243,
    "id": 569285463,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4NTQ2Mw==",
    "diff_hunk": "@@ -317,12 +317,10 @@ struct CNodeState {\n     bool fPreferredDownload;\n     //! Whether this peer wants invs or headers (when possible) for block announcements.\n     bool fPreferHeaders;\n-    //! Whether this peer wants invs or cmpctblocks (when possible) for block announcements.\n-    bool fPreferHeaderAndIDs;\n-    /**\n-      * Whether this peer will send us cmpctblocks if we request them.\n-      */\n-    bool fProvidesHeaderAndIDs;\n+    /** Whether this peer wants cmpctblocks (when possible) for block announcements. */\n+    bool m_sendcmpct_hb{false};",
    "path": "src/net_processing.cpp",
    "position": 22,
    "original_position": 11,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "c30fcbb959d7fced5e1b3e2487129df18fea0fe3",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "`m_prefercmpct` is not as precise. The peer might 'prefer' to fetch blocks using getdata(CMPCT), which is not what this means. `m_sendcmpct_hb` unambiguously means \"send blocks to this peer using BIP 152 high bandwidth mode\".",
    "created_at": "2021-02-03T10:07:33Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569285463",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569285463"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569285463"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569285463/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 701,
    "original_line": 701,
    "side": "RIGHT",
    "in_reply_to_id": 565698050
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569288431",
    "pull_request_review_id": 582201017,
    "id": 569288431,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTI4ODQzMQ==",
    "diff_hunk": "@@ -146,6 +146,8 @@ static constexpr uint32_t MAX_GETCFILTERS_SIZE = 1000;\n static constexpr uint32_t MAX_GETCFHEADERS_SIZE = 2000;\n /** the maximum percentage of addresses from our addrman to return in response to a getaddr message. */\n static constexpr size_t MAX_PCT_ADDR_TO_SEND = 23;\n+/** The compactblocks version we support. See BIP 152. */\n+static constexpr uint64_t CMPCTBLOCKS_VERSION = 2;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> uint64_t{CMPCTBLOCKS_VERSION} is a compile time check ;)\r\n\r\n`uint64_t{CMPCTBLOCKS_VERSION}` initializes a new `uint64_t` from `CMPCTBLOCKS_VERSION` at runtime, no? But I guess the compiler will optimize that away?\r\n\r\nIn any case, I've removed the static assert and replaced with `uint64_t{CMPCTBLOCKS_VERSION}`.",
    "created_at": "2021-02-03T10:11:48Z",
    "updated_at": "2021-04-27T11:04:57Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569288431",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569288431"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r569288431"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/569288431/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 155,
    "side": "RIGHT",
    "in_reply_to_id": 563801319
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742205681",
    "pull_request_review_id": 796924418,
    "id": 742205681,
    "node_id": "PRRC_kwDOABII584sPSjx",
    "diff_hunk": "@@ -258,22 +251,14 @@ def check_announcement_of_new_block(node, peer, predicate):\n         test_node.send_and_ping(msg_sendheaders())\n         check_announcement_of_new_block(node, test_node, lambda p: \"cmpctblock\" in p.last_message)\n \n-        # Try one more time, after sending a version-1, announce=false message.\n-        test_node.send_and_ping(msg_sendcmpct(announce=False, version=preferred_version-1))\n+        # Try one more time, after sending a version=1, announce=false message.\n+        test_node.send_and_ping(msg_sendcmpct(announce=False, version=1))\n         check_announcement_of_new_block(node, test_node, lambda p: \"cmpctblock\" in p.last_message)\n \n         # Now turn off announcements\n-        test_node.send_and_ping(msg_sendcmpct(announce=False, version=preferred_version))\n+        test_node.send_and_ping(msg_sendcmpct(announce=False, version=2))\n         check_announcement_of_new_block(node, test_node, lambda p: \"cmpctblock\" not in p.last_message and \"headers\" in p.last_message)\n \n-        if old_node is not None:",
    "path": "test/functional/p2p_compactblocks.py",
    "position": 118,
    "original_position": 105,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "10ad4150379d3d43fd63e3b9b928ba653fadf5fb",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "If I'm reading correctly, I think we want to keep this test but reverse the expected outcome? That way we test that v1 doesn't work anymore as opposed to assuming it doesn't.\r\n\r\nDisregard if I'm missing something else that exercises this.",
    "created_at": "2021-11-03T18:04:24Z",
    "updated_at": "2021-11-03T18:47:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742205681",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742205681"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742205681"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742205681/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 269,
    "original_line": 269,
    "side": "LEFT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742213653",
    "pull_request_review_id": 796924418,
    "id": 742213653,
    "node_id": "PRRC_kwDOABII584sPUgV",
    "diff_hunk": "@@ -2496,18 +2473,14 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 223,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "befb06801eca94986a196c49e84c291ab7a4d87b",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Agree with @jonatack about taking from `(pfrom.nServices & NODE_WITNESS)` rather than `State(pfrom.GetId())->fHaveWitness;})` just because it's easier to not have to worry about where the latter comes from.\r\n\r\nUnderstood that it's moot as it's changing soon anyway, so not a big deal.",
    "created_at": "2021-11-03T18:15:21Z",
    "updated_at": "2021-11-03T18:47:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742213653",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742213653"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742213653"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742213653/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2714,
    "side": "RIGHT",
    "in_reply_to_id": 563811150
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742216163",
    "pull_request_review_id": 796924418,
    "id": 742216163,
    "node_id": "PRRC_kwDOABII584sPVHj",
    "diff_hunk": "@@ -2728,17 +2730,14 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 33,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "8511a0841c267c7df0bc510c843a69c3d81adbbc",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Also, is this a behavioral change? It's not clear to me why the `fHaveWitness` check was added here.\r\nEdit: Rather, why _wasn't_ it there before?\r\nEdit2: Ok, so witness data is required now, but this still looks like a new enforcement for v2.",
    "created_at": "2021-11-03T18:18:43Z",
    "updated_at": "2021-11-03T18:49:19Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742216163",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742216163"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742216163"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742216163/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2734,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742222937",
    "pull_request_review_id": 796924418,
    "id": 742222937,
    "node_id": "PRRC_kwDOABII584sPWxZ",
    "diff_hunk": "@@ -2761,17 +2761,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n         if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n             State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+            State(pfrom.GetId())->fWantsCmpctWitness = true;\n         }\n-        if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n+        if (State(pfrom.GetId())->fWantsCmpctWitness) { // ignore later version announces",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 8,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "aa78fbbab28db5cb9b4cd87033bc9fa1ce860e55",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Comment no longer makes sense here.",
    "created_at": "2021-11-03T18:27:48Z",
    "updated_at": "2021-11-03T18:47:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742222937",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742222937"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742222937"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742222937/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2766,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742235143",
    "pull_request_review_id": 796924418,
    "id": 742235143,
    "node_id": "PRRC_kwDOABII584sPZwH",
    "diff_hunk": "@@ -2758,6 +2757,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;\n \n         LOCK(cs_main);\n+        // Only support compact block relay with witness peers\n+        if (!State(pfrom.GetId())->fHaveWitness) return;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 15,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "d2e90fae0f694b24844cbee243dbe0f98d1f3dcb",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "According to BIP144, `NODE_WITNESS` means \r\n\r\n> A node will signal that it can provide witnesses using the following service bit\r\n\r\nSo I'm not sure this is strictly necessary. As a general theme though, I'm not sure bundling this logic with the value of NODE_WITNESS is necessary/correct.",
    "created_at": "2021-11-03T18:44:25Z",
    "updated_at": "2021-11-03T18:47:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742235143",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742235143"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742235143"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742235143/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2761,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906463",
    "pull_request_review_id": 797838866,
    "id": 742906463,
    "node_id": "PRRC_kwDOABII584sR9pf",
    "diff_hunk": "@@ -2758,6 +2757,9 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;\n \n         LOCK(cs_main);\n+        // Only support compact block relay with witness peers\n+        if (!State(pfrom.GetId())->fHaveWitness) return;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 15,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "d2e90fae0f694b24844cbee243dbe0f98d1f3dcb",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Agree. I've now removed it.",
    "created_at": "2021-11-04T14:44:38Z",
    "updated_at": "2021-11-04T14:44:38Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906463",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906463"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906463"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906463/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2761,
    "side": "RIGHT",
    "in_reply_to_id": 742235143
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906485",
    "pull_request_review_id": 797838895,
    "id": 742906485,
    "node_id": "PRRC_kwDOABII584sR9p1",
    "diff_hunk": "@@ -2761,17 +2761,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n         if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n             State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+            State(pfrom.GetId())->fWantsCmpctWitness = true;\n         }\n-        if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n+        if (State(pfrom.GetId())->fWantsCmpctWitness) { // ignore later version announces",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 8,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "aa78fbbab28db5cb9b4cd87033bc9fa1ce860e55",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "removed!",
    "created_at": "2021-11-04T14:44:39Z",
    "updated_at": "2021-11-04T14:44:39Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906485",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906485"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906485"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906485/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2766,
    "side": "RIGHT",
    "in_reply_to_id": 742222937
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906519",
    "pull_request_review_id": 797838929,
    "id": 742906519,
    "node_id": "PRRC_kwDOABII584sR9qX",
    "diff_hunk": "@@ -2728,17 +2730,14 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n             // nodes)\n             m_connman.PushMessage(&pfrom, msgMaker.Make(NetMsgType::SENDHEADERS));\n         }\n-        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION) {\n-            // Tell our peer we are willing to provide version 1 or 2 cmpctblocks\n+        if (pfrom.GetCommonVersion() >= SHORT_IDS_BLOCKS_VERSION &&\n+            WITH_LOCK(cs_main, {return State(pfrom.GetId())->fHaveWitness;})) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 33,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "8511a0841c267c7df0bc510c843a69c3d81adbbc",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I've removed the new check since it's not necessary.",
    "created_at": "2021-11-04T14:44:41Z",
    "updated_at": "2021-11-04T14:44:41Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906519",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906519"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906519"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906519/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2734,
    "side": "RIGHT",
    "in_reply_to_id": 742216163
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906656",
    "pull_request_review_id": 797839090,
    "id": 742906656,
    "node_id": "PRRC_kwDOABII584sR9sg",
    "diff_hunk": "@@ -258,22 +251,14 @@ def check_announcement_of_new_block(node, peer, predicate):\n         test_node.send_and_ping(msg_sendheaders())\n         check_announcement_of_new_block(node, test_node, lambda p: \"cmpctblock\" in p.last_message)\n \n-        # Try one more time, after sending a version-1, announce=false message.\n-        test_node.send_and_ping(msg_sendcmpct(announce=False, version=preferred_version-1))\n+        # Try one more time, after sending a version=1, announce=false message.\n+        test_node.send_and_ping(msg_sendcmpct(announce=False, version=1))\n         check_announcement_of_new_block(node, test_node, lambda p: \"cmpctblock\" in p.last_message)\n \n         # Now turn off announcements\n-        test_node.send_and_ping(msg_sendcmpct(announce=False, version=preferred_version))\n+        test_node.send_and_ping(msg_sendcmpct(announce=False, version=2))\n         check_announcement_of_new_block(node, test_node, lambda p: \"cmpctblock\" not in p.last_message and \"headers\" in p.last_message)\n \n-        if old_node is not None:",
    "path": "test/functional/p2p_compactblocks.py",
    "position": 118,
    "original_position": 105,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "10ad4150379d3d43fd63e3b9b928ba653fadf5fb",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "No, that's a good point. I've added the test in commit _[net processing] Only accept SENDCMPCT with version = 2_",
    "created_at": "2021-11-04T14:44:48Z",
    "updated_at": "2021-11-04T14:44:48Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906656",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906656"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r742906656"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/742906656/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 269,
    "original_line": 269,
    "side": "LEFT",
    "in_reply_to_id": 742205681
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743024991",
    "pull_request_review_id": 798007564,
    "id": 743024991,
    "node_id": "PRRC_kwDOABII584sSalf",
    "diff_hunk": "@@ -2752,22 +2752,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {",
    "path": "src/net_processing.cpp",
    "position": 257,
    "original_position": 4,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "255c528a0fabae8aac4d93e75867ab4a172cedb5",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Was there a reason for switching this to an early return, or is that now an artifact of old changes and rebases?\r\n\r\nJust for readability, it's more clear imo wrapped in a `if` for the version check. I missed the early return when re-reviewing and was confused about why this change is safe.",
    "created_at": "2021-11-04T16:48:03Z",
    "updated_at": "2021-11-04T16:48:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743024991",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743024991"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743024991"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743024991/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 2758,
    "original_line": 2755,
    "side": "LEFT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743034501",
    "pull_request_review_id": 798020174,
    "id": 743034501,
    "node_id": "PRRC_kwDOABII584sSc6F",
    "diff_hunk": "@@ -2752,22 +2752,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {",
    "path": "src/net_processing.cpp",
    "position": 257,
    "original_position": 4,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "255c528a0fabae8aac4d93e75867ab4a172cedb5",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think this is just personal taste. I _much_ prefer early returns where they're possible, especially compared with some of the very deeply nested if statements that we have in the code.",
    "created_at": "2021-11-04T16:58:21Z",
    "updated_at": "2021-11-04T16:58:22Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743034501",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743034501"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743034501"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743034501/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 2758,
    "original_line": 2755,
    "side": "LEFT",
    "in_reply_to_id": 743024991
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743037859",
    "pull_request_review_id": 798024926,
    "id": 743037859,
    "node_id": "PRRC_kwDOABII584sSduj",
    "diff_hunk": "@@ -2760,17 +2760,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n         if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n             State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+            State(pfrom.GetId())->fWantsCmpctWitness = true;\n         }\n-        if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n+        if (State(pfrom.GetId())->fWantsCmpctWitness) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 8,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "fe4a59efa77bf6da2694688a35c904699c6b03a7",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "We could've previously fallen into this if `fWantsCmpctWitness == false && nCMPCTBLOCKVersion != 2`, but we won't now. I'm not sure what the consequence of that is.",
    "created_at": "2021-11-04T17:02:16Z",
    "updated_at": "2021-11-04T17:02:16Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743037859",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743037859"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743037859"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743037859/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2765,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743052831",
    "pull_request_review_id": 798045776,
    "id": 743052831,
    "node_id": "PRRC_kwDOABII584sShYf",
    "diff_hunk": "@@ -2752,22 +2752,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {\n-            LOCK(cs_main);\n-            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n-            if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-                State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-                State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n-            }\n-            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n-                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-                // save whether peer selects us as BIP152 high-bandwidth peer\n-                // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-                pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-            }\n-            if (!State(pfrom.GetId())->fSupportsDesiredCmpctVersion) {\n-                State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 2);\n-            }\n+\n+        // Only support compact block relay with witnesses\n+        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 22,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "255c528a0fabae8aac4d93e75867ab4a172cedb5",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I believe this is a behavioral change in a pathological case:\r\n```\r\nSENDCMPCT true 2\r\nSENDCMPCT false 1\r\n```\r\nBefore this would have turned off announcements, but now it looks like it won't.\r\nAgain, I'm unsure of the consequence.",
    "created_at": "2021-11-04T17:21:02Z",
    "updated_at": "2021-11-04T17:21:02Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743052831",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743052831"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r743052831"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/743052831/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2757,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744939428",
    "pull_request_review_id": 800407576,
    "id": 744939428,
    "node_id": "PRRC_kwDOABII584sZt-k",
    "diff_hunk": "@@ -2760,17 +2760,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n         if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n             State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+            State(pfrom.GetId())->fWantsCmpctWitness = true;\n         }\n-        if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n+        if (State(pfrom.GetId())->fWantsCmpctWitness) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 8,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "fe4a59efa77bf6da2694688a35c904699c6b03a7",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This if block is handling subsequent `sendcmpct` messages from the peer. The idea is that we'll ignore any subsequent `sendcmpct` message where the version doesn't match the version in the first received `sendcmpct` message, i.e. if we receive:\r\n\r\n```\r\nsendcmpct false 2\r\nsendcmpct true 2\r\n```\r\n\r\nThen the first `sendcmpct` announces support for compact blocks and the second `sendcmpct` enables high-bandwidth mode. However, if we receive:\r\n\r\n```\r\nsendcmpct false 2\r\nsendcmpct true 1\r\n```\r\n\r\nthe second `sendcmpct` is ignored and we don't enable high-bandwidth mode.\r\n\r\nThis PR is removing all support for `sendcmcpt <true|false> 1`, so this specialized logic is no longer required.",
    "created_at": "2021-11-08T17:23:38Z",
    "updated_at": "2021-11-08T17:23:38Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r744939428",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744939428"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r744939428"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744939428/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2765,
    "side": "RIGHT",
    "in_reply_to_id": 743037859
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744940956",
    "pull_request_review_id": 800409494,
    "id": 744940956,
    "node_id": "PRRC_kwDOABII584sZuWc",
    "diff_hunk": "@@ -2752,22 +2752,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {\n-            LOCK(cs_main);\n-            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n-            if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-                State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-                State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n-            }\n-            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n-                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-                // save whether peer selects us as BIP152 high-bandwidth peer\n-                // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-                pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-            }\n-            if (!State(pfrom.GetId())->fSupportsDesiredCmpctVersion) {\n-                State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 2);\n-            }\n+\n+        // Only support compact block relay with witnesses\n+        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 22,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "255c528a0fabae8aac4d93e75867ab4a172cedb5",
    "user": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> Before this would have turned off announcements, but now it looks like it won't.\r\n\r\nI don't think this is true for the reason in https://github.com/bitcoin/bitcoin/pull/20799#discussion_r744939428. The second `sendcmpct` would not turn off announcements, since the if statement here:\r\n\r\n```\r\n            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\r\n```\r\n\r\nwould not be true, so the logic to turn off hb announcements here:\r\n\r\n```\r\n                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\r\n```\r\n\r\nwould not be hit.",
    "created_at": "2021-11-08T17:25:27Z",
    "updated_at": "2021-11-08T17:25:28Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r744940956",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744940956"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r744940956"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/744940956/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2757,
    "side": "RIGHT",
    "in_reply_to_id": 743052831
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749520836",
    "pull_request_review_id": 806333234,
    "id": 749520836,
    "node_id": "PRRC_kwDOABII584srMfE",
    "diff_hunk": "@@ -2752,22 +2752,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {",
    "path": "src/net_processing.cpp",
    "position": 257,
    "original_position": 4,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "255c528a0fabae8aac4d93e75867ab4a172cedb5",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This is nitty and not related to the code change, but I disagree with this. Deeply nested code, ugly as it may be, demonstrates the complexity of the logic in-place. Early returns don't simplify the logic, they just add sneaky trap-doors that aren't visible in diffs (In this case I misread the intent of the code because github didn't show enough context)",
    "created_at": "2021-11-15T17:04:34Z",
    "updated_at": "2021-11-15T17:04:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749520836",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749520836"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749520836"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749520836/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 2758,
    "original_line": 2755,
    "side": "LEFT",
    "in_reply_to_id": 743024991
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749548849",
    "pull_request_review_id": 806371752,
    "id": 749548849,
    "node_id": "PRRC_kwDOABII584srTUx",
    "diff_hunk": "@@ -2752,22 +2752,24 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         bool fAnnounceUsingCMPCTBLOCK = false;\n         uint64_t nCMPCTBLOCKVersion = 0;\n         vRecv >> fAnnounceUsingCMPCTBLOCK >> nCMPCTBLOCKVersion;\n-        if (nCMPCTBLOCKVersion == 1 || nCMPCTBLOCKVersion == 2) {\n-            LOCK(cs_main);\n-            // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n-            if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n-                State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-                State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n-            }\n-            if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n-                State(pfrom.GetId())->fPreferHeaderAndIDs = fAnnounceUsingCMPCTBLOCK;\n-                // save whether peer selects us as BIP152 high-bandwidth peer\n-                // (receiving sendcmpct(1) signals high-bandwidth, sendcmpct(0) low-bandwidth)\n-                pfrom.m_bip152_highbandwidth_from = fAnnounceUsingCMPCTBLOCK;\n-            }\n-            if (!State(pfrom.GetId())->fSupportsDesiredCmpctVersion) {\n-                State(pfrom.GetId())->fSupportsDesiredCmpctVersion = (nCMPCTBLOCKVersion == 2);\n-            }\n+\n+        // Only support compact block relay with witnesses\n+        if (nCMPCTBLOCKVersion != CMPCTBLOCKS_VERSION) return;",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 22,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "255c528a0fabae8aac4d93e75867ab4a172cedb5",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I agree with this now, thanks for explaining!",
    "created_at": "2021-11-15T17:41:55Z",
    "updated_at": "2021-11-15T17:41:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749548849",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749548849"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749548849"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749548849/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2757,
    "side": "RIGHT",
    "in_reply_to_id": 743052831
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749559852",
    "pull_request_review_id": 806386404,
    "id": 749559852,
    "node_id": "PRRC_kwDOABII584srWAs",
    "diff_hunk": "@@ -2760,17 +2760,15 @@ void PeerManagerImpl::ProcessMessage(CNode& pfrom, const std::string& msg_type,\n         // fProvidesHeaderAndIDs is used to \"lock in\" version of compact blocks we send (fWantsCmpctWitness)\n         if (!State(pfrom.GetId())->fProvidesHeaderAndIDs) {\n             State(pfrom.GetId())->fProvidesHeaderAndIDs = true;\n-            State(pfrom.GetId())->fWantsCmpctWitness = nCMPCTBLOCKVersion == 2;\n+            State(pfrom.GetId())->fWantsCmpctWitness = true;\n         }\n-        if (State(pfrom.GetId())->fWantsCmpctWitness == (nCMPCTBLOCKVersion == 2)) { // ignore later version announces\n+        if (State(pfrom.GetId())->fWantsCmpctWitness) {",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 8,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "fe4a59efa77bf6da2694688a35c904699c6b03a7",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes, I see now. Thanks.",
    "created_at": "2021-11-15T17:57:38Z",
    "updated_at": "2021-11-15T17:57:39Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749559852",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749559852"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749559852"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749559852/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 2765,
    "side": "RIGHT",
    "in_reply_to_id": 743037859
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573420",
    "pull_request_review_id": 806404469,
    "id": 749573420,
    "node_id": "PRRC_kwDOABII584srZUs",
    "diff_hunk": "@@ -317,12 +317,10 @@ struct CNodeState {\n     bool fPreferredDownload;\n     //! Whether this peer wants invs or headers (when possible) for block announcements.\n     bool fPreferHeaders;\n-    //! Whether this peer wants invs or cmpctblocks (when possible) for block announcements.\n-    bool fPreferHeaderAndIDs;\n-    /**\n-      * Whether this peer will send us cmpctblocks if we request them.\n-      */\n-    bool fProvidesHeaderAndIDs;\n+    /** Whether this peer wants cmpctblocks (when possible) for block announcements. */\n+    bool m_sendcmpct_hb{false};",
    "path": "src/net_processing.cpp",
    "position": 22,
    "original_position": 11,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "c30fcbb959d7fced5e1b3e2487129df18fea0fe3",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Could you add the \"high bandwidth\" part of that to the comment so the _hb makes more sense?",
    "created_at": "2021-11-15T18:17:35Z",
    "updated_at": "2021-11-15T18:17:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749573420",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573420"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749573420"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749573420/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 701,
    "original_line": 701,
    "side": "RIGHT",
    "in_reply_to_id": 565698050
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749590232",
    "pull_request_review_id": 806427287,
    "id": 749590232,
    "node_id": "PRRC_kwDOABII584srdbY",
    "diff_hunk": "@@ -1515,18 +1514,18 @@ void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::sha\n         return;\n     nHighestFastAnnounce = pindex->nHeight;\n \n-    bool fWitnessEnabled = DeploymentActiveAt(*pindex, m_chainparams.GetConsensus(), Consensus::DEPLOYMENT_SEGWIT);\n+    if (!DeploymentActiveAt(*pindex, m_chainparams.GetConsensus(), Consensus::DEPLOYMENT_SEGWIT)) return;",
    "path": "src/net_processing.cpp",
    "position": 146,
    "original_position": 13,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "1e814a9e5048718e1b1ff0794197994a9ff63835",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Could you help me get confident that none of the side-effects below are still necessary?\r\nNamely:\r\n- `most_recent_* = bar`\r\n- `ForEachNode(ProcessBlockAvailability())`\r\n\r\nSome justification in the commit message would be helpful.",
    "created_at": "2021-11-15T18:43:36Z",
    "updated_at": "2021-11-15T19:06:04Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749590232",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749590232"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749590232"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749590232/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1516,
    "original_line": 1517,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749598237",
    "pull_request_review_id": 806427287,
    "id": 749598237,
    "node_id": "PRRC_kwDOABII584srfYd",
    "diff_hunk": "@@ -1536,8 +1535,7 @@ void PeerManagerImpl::NewPoWValidBlock(const CBlockIndex *pindex, const std::sha\n         CNodeState &state = *State(pnode->GetId());\n         // If the peer has, or we announced to them the previous block already,\n         // but we don't think they have this one, go ahead and announce it\n-        if (state.m_sendcmpct_hb && (!fWitnessEnabled || state.m_sendcmpct) &&",
    "path": "src/net_processing.cpp",
    "position": null,
    "original_position": 34,
    "commit_id": "387c48fafb77caeb8ff7ffccacee8cfc79750b6e",
    "original_commit_id": "1e814a9e5048718e1b1ff0794197994a9ff63835",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Could you explain what `(!fWitnessEnabled || state.m_sendcmpct)` represented before? I'm having trouble understanding how it used to work before even unpacking whether the change is safe :)",
    "created_at": "2021-11-15T18:55:39Z",
    "updated_at": "2021-11-15T19:06:04Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749598237",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749598237"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/20799#discussion_r749598237"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/20799"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/749598237/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1539,
    "side": "LEFT"
  }
]