practicalswift,2017-11-22T14:23:16Z,"@promag `m_last_block_processed` is guarded by `cs_main` according to this comment in `wallet.h`:\n\nhttps://github.com/bitcoin/bitcoin/blob/3c098a8aa0780009c11b66b1a5d488a928629ebf/src/wallet/wallet.h#L732-L734",https://github.com/bitcoin/bitcoin/pull/11749#issuecomment-346364122,346364122,
promag,2017-11-22T14:56:42Z,"IMO it should be guarded by `cs_wallet`, it's a wallet thing. `m_last_block_processed` is changed in:\nhttps://github.com/bitcoin/bitcoin/blob/3c098a8aa0780009c11b66b1a5d488a928629ebf/src/wallet/wallet.cpp#L1236-L1237\n\nAnd as you can see both `cs_main` and `cs_wallet` are held.\n\nThen, here `cs_wallet` should be locked too:\nhttps://github.com/bitcoin/bitcoin/blob/3c098a8aa0780009c11b66b1",https://github.com/bitcoin/bitcoin/pull/11749#issuecomment-346373900,346373900,
practicalswift,2017-11-22T15:40:15Z,@promag Sounds reasonable! I'll update once we get @TheBlueMatt's clarification :-),https://github.com/bitcoin/bitcoin/pull/11749#issuecomment-346387695,346387695,
practicalswift,2017-11-22T16:34:57Z,"@promag Would replacing the current commit with the following be in line with your suggestion? :-)\n\n```diff\ndiff --git a/src/wallet/wallet.cpp b/src/wallet/wallet.cpp\nindex 29eabd1..7aa7293 100644\n--- a/src/wallet/wallet.cpp\n+++ b/src/wallet/wallet.cpp\n@@ -1272,10 +1272,7 @@ void CWallet::BlockUntilSyncedToCurrentChain() {\n     {\n         // Skip the queue-draining stuff if we kn",https://github.com/bitcoin/bitcoin/pull/11749#issuecomment-346404722,346404722,
TheBlueMatt,2017-11-22T19:25:02Z,"Ugh, this is set fine in the place CWallets are created, I agree it should be initialized, but it's not a bug and going back and forth on stuff like this is just a waste of time. Most importantly, this obviously doesn't need a cs_main, is there really some static analyser that wants that there?\n\nOn November 22, 2017 7:40:24 AM PST, practicalswift <notifications@github.com> wrote:\n>@promag Sound",https://github.com/bitcoin/bitcoin/pull/11749#issuecomment-346450058,346450058,
practicalswift,2017-11-22T20:27:23Z,"@TheBlueMatt \n\nI agree that fixing static analyzer warnings in mature old code is not worth it, but I think the case could be made that we can be more liberal in accepting fixes for static analyzer warnings introduced by brand new code (such as this - merged only days ago). Sounds reasonable?\n\nI don't have any strong feelings about the initialization fix (beyond the warm fuzzy feeling of s",https://github.com/bitcoin/bitcoin/pull/11749#issuecomment-346464511,346464511,
TheBlueMatt,2017-11-22T20:31:05Z,"My point was not that we shouldn't accept simple static analysis fixes, but more that we should keep them simple and avoid review burden by making them as minimal as possible and not going back and forth on them. Static analysis shouldn't complain about variables in a constructor, and adding an extern cs_main in wallet.h just sucks - either move SetNull to the .cpp or move the setting to the const",https://github.com/bitcoin/bitcoin/pull/11749#issuecomment-346465314,346465314,
practicalswift,2017-11-22T20:35:17Z,"@TheBlueMatt I agree that adding an extern `cs_main` in `wallet.h` sucks â€“ the locking annotation `GUARDED_BY(cs_main)` is obviously incorrect :-)\n\nIs â€¦\n\n```\nconst CBlockIndex* m_last_block_processed GUARDED_BY(cs_wallet);\n```\n\nâ€¦ the correct locking annotation for `m_last_block_processed`?",https://github.com/bitcoin/bitcoin/pull/11749#issuecomment-346466211,346466211,
TheBlueMatt,2017-11-22T20:39:51Z,"I believe that is (currently) correct, though we may be able to change it. I think it's time to think harder about wallet cs_main locking, especially with @ryanosky's work, I believe there's an opportunity to rethink a bunch of it when adding annotations.\n\nEither way, can we avoid ugly patches that result in a bunch of time wasted going back and forth just to fix (incorrect) static analysis warn",https://github.com/bitcoin/bitcoin/pull/11749#issuecomment-346467169,346467169,
promag,2017-11-22T14:16:54Z,`cs_main`? ðŸ™„,https://github.com/bitcoin/bitcoin/pull/11749#discussion_r152576780,152576780,src/wallet/wallet.h
