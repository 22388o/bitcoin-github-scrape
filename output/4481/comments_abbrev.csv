petertodd,2014-07-08T04:25:17Z,"I think this is acceptable so long as you add a ""-allowpruned"" option that disables the ""we have all blocks"" check on startup and unsets the NODE_NETWORK service bit. (meaning we act like a SPV client)\n\nYou could argue with that you might as well _not_ disconnect peers that ask for blocks you don't have, as you aren't advertising that you have any blocks at all. That might be useful for some typ",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48270826,48270826,
laanwj,2014-07-08T07:18:50Z,"Agree with @petertodd here. If you don't run a full node, you should not have it advertise NODE_NETWORK. The P2P protocol at this point does not support advertising availability of only ranges of blocks, and disconnecting anyone that happens to request a block that's missing seems very crude.\n\nAlso: `-allowpruned` should imply `-disablewallet`, as the wallet currently relies on being able to res",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48279693,48279693,
petertodd,2014-07-08T08:23:52Z,"@laanwj Good point. You could make pruning just disable some wallet functionality, but disabling all wallet functionality is simpler for now - we might not have the wallet in the future anyway.\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48284534,48284534,
rdponticelli,2014-07-09T00:01:42Z,"Thanks for the feedback. Pull updated, addressing the input.\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48414813,48414813,
laanwj,2014-07-09T06:20:26Z,"I like the idea of an UTXO-only, non-archival node.\n- Excluding the wallet, we still need to test the rest of the RPC API for robustness against missing block data. How does this interact with gettransaction (w/ possible txindex), for example?\n- Ideally this would be accompanied with an option to not write blocks to disk at all. I think the current expectation is that some external program does ",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48434030,48434030,
rdponticelli,2014-07-10T01:12:26Z,"@ashleyholman: I guess we should try and test fully what happens unsetting the flag, but that looks like the sensible thing to do.\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48554867,48554867,
gmaxwell,2014-07-10T13:28:40Z,It should also check that so much hasn't been removed that it can't survive realistic reorganizations... a bunch of nodes that just refuse to reorg would be fairly harmful to the network (not to mention their users!).  I'd suggest the check go back 288 blocks from tip since thats our default for the extensive checkblocks.\n\nThis also needs at least a modest testplan to check that none of the expo,https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48603819,48603819,
gmaxwell,2014-07-10T13:33:55Z,We may also want to leave this out of usage until it's had a fair amount of testing (e.g. in the first release with it)... esp I'd worry that there may be additional network triggerable misbehavior from places where this violates assumptions.\n,https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48604426,48604426,
gmaxwell,2014-07-10T16:21:10Z,"So after giving this more though, instead of allowprunedâ€” why not just go all the way and have a pruned=1 ... with the logic that if our validated height is >100k and a blockfiles highest block is <tip-288, just delete the block file?  This would allow you to sync up without much free disk space (the first 119k blocks are small and fit in the first block file).\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48627909,48627909,
gmaxwell,2014-07-10T20:44:04Z,"(Sipa pointed out to me that the rational for the 100k limit was not obvious.  The reason I proposed that was because without it if someone gave you a 400 block reorg during the very early initial block download you would not recover.  The 100k limit gets the difficulty to a non-completely-trivial level, and is also few enough that its still in a single block file, so there would be no peak usage ",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48661471,48661471,
rdponticelli,2014-07-11T11:53:50Z,"So, there are several possible modes of operation after we allow pruning. @laanwj's utxosonly, @gmaxwell's autoprune are both interesting, and there could be more...\n\nShould I modify this patch to allow setting them as options, or would that add too much unneeded complexity?\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48721813,48721813,
gmaxwell,2014-07-11T12:43:14Z,UTXO only cannot be done without substantial work because the node would be unable to reorganize.\n,https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48725579,48725579,
rdponticelli,2014-07-11T12:59:16Z,"Yeah, obviously autoprune is a way lower hanging fruit.\n\nMaybe after #4468 utxoonly can be possible, but yes, at a significantly cost.\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48726963,48726963,
laanwj,2014-07-11T13:00:08Z,"Right, I did not think about reorganizations. A node that would fall over on even a small reorganization would be pointless. And storing a few blocks isn't a problem.\n\n@gmaxwell's idea about keeping only the recent N>288 blocks when height>100k sounds great, and is how auto-pruning should work. \n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48727034,48727034,
gmaxwell,2014-07-11T13:17:31Z,"WRT UTXO-only, we'd also need to add code to hash the undo files, and add network code to fetch them (and make the undo datastructure normative along the way)... Or, just don't delete the undo files but this is unattractive since there is currently about 2gb of undo data.\n\nSo I think for now we should just do the autopruned which disables the wallet and txindex and keeps enough blocks that reorg",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48728602,48728602,
wtogami,2014-07-12T09:28:11Z,Shouldn't this also disable UPNP as the only reason it is used is to allow incoming connections to possibly sync from your node?\n,https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48806776,48806776,
petertodd,2014-07-12T09:58:46Z,"I wouldn't bother, as we'll want to let nodes advertise useful services beyond the blockchain, e.g. tx relaying. \n\nOn 12 July 2014 10:28:41 BST, Warren Togami notifications@github.com wrote:\n\n> Shouldn't this also disable UPNP as the only reason it is used is to\n> allow incoming connections to possibly sync from your node?\n> \n> ---\n> \n> Reply to this email directly or view it on GitHub:\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48807337,48807337,
gmaxwell,2014-07-12T12:32:28Z,"We don't want to disable listening or UPNP because you may want to use the node with p2pool or the like, but we should probably suppress address messages when we're not node-network. I think that should just wait until another pull though.\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48810117,48810117,
petertodd,2014-07-12T12:36:51Z,"@gmaxwell Sounds good to me. \n\nOn 12 July 2014 13:32:58 GMT+01:00, Gregory Maxwell notifications@github.com wrote:\n\n> We don't want to disable listening or UPNP because you may want to use\n> the node with p2pool or the like, but we should probably suppress\n> address messages when we're not node-network. I think that should just\n> wait until another pull though.\n> \n> ---\n> \n> Reply to th",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48810217,48810217,
jgarzik,2014-07-14T00:06:40Z,"Looks mostly OK, modulo nits.\n\nDo we want to be able to find pruned nodes?  Seems like allocating a NODE_xxx service bit in this PR is appropriate.\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48855829,48855829,
gmaxwell,2014-07-14T04:16:50Z,"The bit ought to depend on willingness to at least relay the most recent N transactions from the tip. N=288 by definition sounds good to me, but if it's in the bit definition perhaps it needs more shed painting, which is why I didn't recommend this above (for this pull, e.g. we could do it in a separate one).\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48864180,48864180,
jgarzik,2014-07-14T04:36:08Z,"@gmaxwell To forestall shed painting, I observe that NODE_NETWORK behavior has varied over time; only it's general definition ""a full node!"" has remained static.\n\nAs such, it seems reasonable to add NODE_PRUNED or whatever we want to call the high level attribute being advertised.  If it's only minor tweaks to find a good value for N, that seems like something that could be performed in-tree bef",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48864816,48864816,
laanwj,2014-07-14T06:48:47Z,"What about adding a service bit NODE_UTXO? And then having full nodes advertise it as well? This has been proposed before and I think that was a good suggestion (by @maaku?). Pruned nodes would only advertise NODE_UTXO.\n\nThis would give NODE_NETWORK - starting from version X - the meaning of 'can serve blocks', and NODE_UTXO the meaning of 'tracks UTXO and can validate transactions'.\n\nThis way",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48870016,48870016,
sipa,2014-07-14T12:03:28Z,"I would move the meaning of block-servavility out of NODE_NETWORK, not the\ncomplement. Reason: we don't really know in what ways the remainder of the\nfunctionality will be split off in the future, while the ability to serve\nblocks is well defined. Let NODE_NETWORK remain the kitchen sink, and give\nnew bits a well defined meaning.\n\nAs to the meaning itself, I have previously proposed to use 2",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48891966,48891966,
gmaxwell,2014-07-14T12:37:32Z,I was trying to avoid the granularity rathole here. :)  Can we please put the new flag in a subsequent pull to avoid delaying this based on that?  The approach of removing node network on a pruning node is safe if far from perfect... and will suffice until the extra behavior is hammered out.\n,https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48894529,48894529,
jgarzik,2014-07-14T12:46:56Z,"I see that shed painting was not forestalled, @gmaxwell  :)\n\nACK\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48895275,48895275,
rdponticelli,2014-07-14T22:46:56Z,"Most nits has been addressed, and I added a branch in my repository for anybody willing to test the rejection instead of disconnecting case:\n\nhttps://github.com/Criptomonedas/bitcoin/tree/prunedreject\n\nIt seems to work pretty fine, just a little more resource wasteful than disconnecting.\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-48970073,48970073,
sipa,2014-07-15T17:37:14Z,utACK\n,https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-49066446,49066446,
maaku,2014-07-15T17:45:42Z,ut?\n,https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-49067485,49067485,
sipa,2014-07-15T17:46:03Z,untested\n,https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-49067538,49067538,
gmaxwell,2014-07-15T17:54:48Z,NAK. Important nits remain:  This must not allow a node to start which cannot reorg.\n\nPlease change the test in LoadBlockIndexDB() to check that all of the last 288 blocks are available. (then I'll test and ACK)\n,https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-49068696,49068696,
sipa,2014-07-15T17:56:40Z,Undo ACK. Agree with @gmaxwell \n,https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-49068933,49068933,
jgarzik,2014-07-15T17:57:13Z,+1\n,https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-49069014,49069014,
maaku,2014-07-15T21:40:31Z,"You would want to serve not just the most recent blocks, but also a\nrange of past blocks. Otherwise it would be very difficult to perform an\ninitial block download in a scenario where most nodes are pruning.\nAdding a field to CAddress seems the more compatible approach with this\nrequirement.\n\nOn 07/14/2014 08:03 AM, Pieter Wuille wrote:\n\n> I would move the meaning of block-servavility out ",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-49096621,49096621,
gmaxwell,2014-07-15T22:37:30Z,"@maaku  absolutely, but I think we should do that as part of a pull that turns back on network services bits. This pull just turns the node into a client, and the only reason to keep any blocks at all is otherwise a reorg leaves the node stuck and it needs a total (30gbyte) reinit, and while it's stuck it's forked and potentially following a losing chain.\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-49102307,49102307,
sipa,2014-08-03T18:25:35Z,"@jgarzik Please, let's not make this dependent on how to expose this functionality to the network yet, that can come later. All we need for now is something that disables full node functionality when running pruned.\n\nEDIT: Oh, you mean just modifying nLocalServices from init? That seems fine too.\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-50998456,50998456,
jgarzik,2014-08-03T18:45:50Z,"@sipa Correct, that's all I meant.  Local service configuration will ultimately be multi-step, and can be handled directly from init.\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-50999008,50999008,
BitcoinPullTester,2014-08-26T20:06:57Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4481_d00a934cc05301d6a08f8d686428c4fd704ed76b/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-te",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-53481213,53481213,
BitcoinPullTester,2014-08-27T18:42:50Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4481_eae33b1af4f866257a84bcb438a1768fff07a63e/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-te",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-53620742,53620742,
sipa,2014-08-27T18:46:33Z,Untested ACK.\n,https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-53621264,53621264,
sipa,2014-08-27T18:48:34Z,"There are a few changes I'd like to make, but let's do that post-merge:\n- Merge the block/undo data file handling; for now, it seems they will be deleted simultaneously anyway.\n- Make the pruning depth configurable.\n- Abstract the deletion code out of the startup routine, and into something that can run regularly.\n\nEDIT: this is actually about #4701.\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-53621551,53621551,
rdponticelli,2014-08-28T14:17:58Z,"Added incompatibility with -txindex, as requested.\n",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-53725908,53725908,
BitcoinPullTester,2014-08-28T14:28:45Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4481_9045aa715c2a043af244d14170fc11b84f986dcb/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-te",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-53727573,53727573,
BitcoinPullTester,2014-09-12T23:41:23Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/p4481_efbf886cbe560950f432b5af78f63d4a57c81b51/ for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-te",https://github.com/bitcoin/bitcoin/pull/4481#issuecomment-55473499,55473499,
Diapolo,2014-07-16T13:48:26Z,Those checks and the message don't belong here but in `Step 2: parameter interactions` in init.\n,https://github.com/bitcoin/bitcoin/pull/4481#discussion_r14997809,14997809,src/init.cpp
Diapolo,2014-07-16T13:49:51Z,Why the `Readable` at the end?\n,https://github.com/bitcoin/bitcoin/pull/4481#discussion_r14997895,14997895,src/main.cpp
Diapolo,2014-07-16T13:53:29Z,Should this be an assert or can we handle this a little nicer?\n,https://github.com/bitcoin/bitcoin/pull/4481#discussion_r14998112,14998112,src/main.cpp
jgarzik,2014-07-16T13:55:27Z,"At a minimum, assert() is wrong for runtime conditions such as disk errors or out-of-space conditions.\n",https://github.com/bitcoin/bitcoin/pull/4481#discussion_r14998221,14998221,src/main.cpp
rdponticelli,2014-07-16T14:06:15Z,Because they're used to store that condition about the files.\n,https://github.com/bitcoin/bitcoin/pull/4481#discussion_r14998876,14998876,src/main.cpp
rdponticelli,2014-07-16T14:08:21Z,"It was an assert in the original code. Maybe it should be changed, but I would left that for another pull, later.\n",https://github.com/bitcoin/bitcoin/pull/4481#discussion_r14999013,14999013,src/main.cpp
laanwj,2014-07-16T14:15:16Z,Using AbortNode would make sense here (though I agree it's out of scope for this pull)\n,https://github.com/bitcoin/bitcoin/pull/4481#discussion_r14999455,14999455,src/main.cpp
sipa,2014-07-16T15:29:17Z,"This needs to be chainActive.Height(), not mapBlockIndex.size() (which may include stale branches).\n",https://github.com/bitcoin/bitcoin/pull/4481#discussion_r15004531,15004531,src/main.cpp
sipa,2014-07-16T15:29:52Z,Index has nothing to do with it? We're just missing undo data.\n,https://github.com/bitcoin/bitcoin/pull/4481#discussion_r15004572,15004572,src/main.cpp
rdponticelli,2014-07-16T18:12:57Z,chainActive.Height() is returning -1. I suppose it isn't initialized at startup.\n,https://github.com/bitcoin/bitcoin/pull/4481#discussion_r15016772,15016772,src/main.cpp
sipa,2014-07-16T19:18:16Z,"That's a problem, because it means we don't know the height yet.\n",https://github.com/bitcoin/bitcoin/pull/4481#discussion_r15021092,15021092,src/main.cpp
rdponticelli,2014-07-16T19:31:00Z,"I'll search for a workaround. Meanwhile, maybe increasing MIN_BLOCKS_TO_KEEP, as a safety net, would allow to keep testing this. What would be a sensible number?\n",https://github.com/bitcoin/bitcoin/pull/4481#discussion_r15021803,15021803,src/main.cpp
sipa,2014-07-16T19:35:44Z,chainActive is initialized at the end of this function. Just move the test down.\n,https://github.com/bitcoin/bitcoin/pull/4481#discussion_r15022040,15022040,src/main.cpp
sipa,2014-08-03T09:45:17Z,"This really doesn't belong in util.\n\nI'd say main, but apparently you need it inside net, which feels wrong. Feel like moving the pnodeLocalHost code to init?\n",https://github.com/bitcoin/bitcoin/pull/4481#discussion_r15733699,15733699,src/util.cpp
rdponticelli,2014-08-03T17:16:07Z,"What about passing an extra parameter to StartNode to allow setting the service bits from the caller in init? Would that be a correct solution? It would seem to be simpler and less invasive, wouldn't it?\n",https://github.com/bitcoin/bitcoin/pull/4481#discussion_r15735434,15735434,src/util.cpp
sipa,2014-08-03T18:02:14Z,Sounds good to me.\n,https://github.com/bitcoin/bitcoin/pull/4481#discussion_r15735703,15735703,src/util.cpp
jgarzik,2014-08-03T18:22:47Z,"Agree it does not belong in util, but also a parameter to StartNode does not seem appropriate.  See NODE_EXT_SERVICES in the following WIP branch at https://github.com/jgarzik/bitcoin/tree/2014_ext_services\n",https://github.com/bitcoin/bitcoin/pull/4481#discussion_r15735802,15735802,src/util.cpp
