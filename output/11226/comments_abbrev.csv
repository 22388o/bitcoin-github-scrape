sipa,2017-09-04T00:21:02Z,"Awesome, I'm very happy to see someone work on this again.",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-326841879,326841879,
sipa,2017-09-04T09:00:02Z,"You must have introduced a lock inversion, based on the Travis output.",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-326906921,326906921,
promag,2017-09-04T09:24:09Z,Squash commits `Add GUARDED_BY(cs_KeyStore)` and also `Add GUARDED_BY(cs) annotation`.,https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-326912914,326912914,
practicalswift,2017-09-04T15:25:54Z,@sipa Thanks for letting me know! I've now removed the commit with the incorrectly added `LOCK(walletInstance->cs_KeyStore)` in `wallet.cpp` that caused the lock inversion. Do you which variables `cs_KeyStore` is meant to guard?,https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-326987651,326987651,
practicalswift,2017-09-04T15:28:56Z,"@promag Fixed! :-) Regarding the repeated `GUARDED_BY(cs)` commit messages - these actually refer to different `cs`:es. To make things less confusing I've now disambiguated them by adding the class names in the commit message.\n\nFurthermore I've added an commit which renames renames `CAddrMan.cs` to `CAddrMan.cs_addrMan`, and `CTxMemPool.cs` to `CTxMemPool.cs_txMemPool`.",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-326988190,326988190,
TheBlueMatt,2017-09-04T20:17:19Z,"Concept ACK. This will generate some turbulence in terms of needing to rebase a ton of existing PRs, so maybe it makes sense to break this into several PRs which only touch given modules? In any case, excited to see this stuff happen.",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-327023365,327023365,
laanwj,2017-09-06T22:28:28Z,"Concept ACK. Though I'm not sure what a good time to merge a huge, spread-out (though low-risk) change like this is. Maybe just before the 0.16 split?",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-327629626,327629626,
practicalswift,2017-09-11T08:34:47Z,"@laanwj Good point! When is the 0.16 split expected to happen?\n\nThe smaller PR #10866 lays the groundwork for the subsequent thread-safety-analysis annotation work. Having that PR merged a bit earlier would help a lot :-)",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-328458741,328458741,
practicalswift,2017-09-11T08:40:19Z,"@TheBlueMatt Sure, I can split this PR into multiple parts to ease reviewing! Just let me know which parts/modules to split it on :-) To avoid duplicating the commits in #10866 we should probably wait until #10866 is merged before splitting this PR up. Sounds reasonable?",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-328460258,328460258,
practicalswift,2017-09-11T09:13:39Z,"@sipa @TheBlueMatt @laanwj Thanks for reviewing and thanks for the encouragement! Do you happen to know which core developers that would be appropriate reviewers for this work (on a deeper `GUARDED_BY(…)` level for each module)?\n\nThe types of errors I might need some help from reviewers to avoid:\n* False positives: Too restrictive lock requirements. Requiring a lock where a lock is not neede",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-328469429,328469429,
practicalswift,2017-09-13T20:39:19Z,"The code base contains 37 locks and in the process of documenting them I compiled this list of the initial creators of each lock. These lock introducers would likely be the best possible reviewers for the `GUARDED_BY(…)`:s in this PR for ""their"" respective locks :-)\n\n## Bitcoin locks hall of fame\n\nLocks introduced by currently active core devs:\n* @TheBlueMatt (10 locks): `cs_filter, cs_a",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-329289991,329289991,
practicalswift,2017-09-14T20:27:50Z,"I'm now down to only four remaining `AssertLockHeld(…)`:s for which I'm unable to identify which specific variable the lock in question is being a guard for.\n\nThese are the four cases I need help with:\n\n* [[validation.cpp] GetBlockScriptFlags(...)](https://github.com/bitcoin/bitcoin/blob/ea729d55b4dbd17a53ced474a8457d4759cfb5a5/src/validation.cpp#L1588-L1589) – `AssertLockHeld(cs_main);`\",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-329599474,329599474,
practicalswift,2017-09-15T09:17:58Z,"I've now documented the five places where I'm opting out of thread-safety analysis for various reasons (using the `NO_THREAD_SAFETY_ANALYSIS` annotation): b72ad1f43d96b6f63e7a4046f31af085da4e86db\n\nPlease let me know if there is a way to remove any of these opt-outs.",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-329728351,329728351,
TheBlueMatt,2017-09-15T18:25:55Z,"@practicalswift \n\n* GetBlockScriptFlags() needs cs_main for versionbitscache (maybe others, but probably just that?)\n* AcceptBlockHeader is mostly for mapBlockIndex it looks like\n* RemoveWatchOnly looks like it may need to be an atomic operation, but I haven't dug into it too much. It may very well be the case that you'd miss a NotifyWatchonlyChanged fire if you have an AddWatchOnly and a ",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-329863375,329863375,
practicalswift,2017-09-15T18:48:58Z,@TheBlueMatt Thanks! I'll look into the suggested fixes.,https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-329868802,329868802,
practicalswift,2017-09-16T14:22:15Z,"@jonasschnelli @TheBlueMatt In `CDB::PeriodicFlush(CWalletDBWrapper& dbw)` ([code](https://github.com/bitcoin/bitcoin/blob/39ae41389a8694ec1ab9059117ed2cdd2003d0d3/src/wallet/db.cpp#L604-L612)) we are currently trying to lock `bitdb.cs_db` – shouldn't that lock be on `env->cs_db` instead (`CDBEnv *env = dbw.env`)? Or am I reading it wrong? :-)\n\n",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-329971393,329971393,
practicalswift,2017-09-16T18:12:00Z,"@laanwj, after some digging I found your `bitdb` reference cleanup commit be9e1a968debbb7ede8ed50e9288a62ff15d1e1e, perhaps you know the answer to the question about the `bitdb.cs_db` lock above? :-)",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-329985651,329985651,
practicalswift,2017-10-02T14:33:42Z,Rebased!,https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-333552872,333552872,
ryanofsky,2017-11-02T15:20:16Z,"This change is great, but I might suggest breaking off and grouping the ADD_LOCK commits into a few separate PRs. That way the runtime changes can be more easily and carefully vetted, and this PR can exclusively focus on adding compiler annotations and also be more easily reviewed.",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-341455991,341455991,
practicalswift,2017-11-02T16:47:02Z,@ryanofsky Very good point! I'll do that! Thanks.,https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-341484866,341484866,
practicalswift,2017-11-02T17:16:13Z,"@ryanofsky One slight problem is that this PR won't compile cleanly unless the locks are added. But you thinking was that the individual ""add locks""-PR should be merged before this PR gets merged (and hence no need for add locks in this PR when it is time to merge it)? That works for me :-)",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-341494112,341494112,
ryanofsky,2017-11-02T17:24:55Z,"Yeah, I was thinking there would be a handful of other prs which this would depend on since the LOCKs are in different parts of the code, and different people might want to review them. Those PRs would all have their own branches, and the branch for this PR could just `git merge` in those branches until they get merged to master.",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-341496939,341496939,
practicalswift,2017-11-02T17:42:07Z,@ryanofsky Excellent! That'll be our plan!,https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-341502401,341502401,
TheBlueMatt,2017-11-10T01:00:40Z,"Alright, with the depends, it seems like time to start breaking this up, no? There is no way this is going to get merged in one go, though its been great to see this keep getting rebased since it has caught a few errors already :).",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-343342388,343342388,
ryanofsky,2017-11-10T01:06:45Z,"Pretty sure this is already happening. There have been a bunch of new prs adding locking. As they are merged, the ""ADD LOCK"" commits here can go away and this will shrink, only adding annotations without changing behaviour.",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-343343387,343343387,
TheBlueMatt,2017-11-10T03:13:25Z,"@ryanofsky I was referring to adding the annotations - as far as I've seen the only @practicalswift PRs in the locking space have been adding missing locks detected by the annotations, not actually adding the annotations.\n\nOn November 9, 2017 8:06:51 PM EST, Russell Yanofsky <notifications@github.com> wrote:\n>Pretty sure this is already happening. There have been a bunch of new\n>prs adding loc",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-343362978,343362978,
ryanofsky,2017-11-10T03:39:47Z,"Since annotations don't change behaviour, it seems to me that having one PR that *just* adds annotations is fine and probably easier to review than lots of different PRs adding annotations.\n\nAdding new locks is much more dicey, and changes that add new locks should be smaller and get more careful review. This is happening now with #11634, #11623, #11596, etc, and I'm assuming there will be mor",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-343366242,343366242,
TheBlueMatt,2017-11-10T04:06:50Z,"I tend to disagree - if we add annotations and get them wrong we're\nlikely to fool ourselves in the future on locking changes - making sure\nthat a function which doesn't access variables which need locks but\nwhich needs results from two other function calls to be consistent has\nthe appropriate annotation may end up pretty important. Even better, we\nshould take this as an opportunity to fix ob",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-343369453,343369453,
practicalswift,2017-11-10T19:16:24Z,"@ryanofsky @TheBlueMatt What about doing both: I start by submitting the `LOCK(…)`:s as separate PR:s and when these are merged I continue by submitting the annotations (`GUARDED_BY(…)`/`EXCLUSIVE_LOCKS_REQUIRED(…)`) in separate PR:s. All while keeping this PR updated with both types of changes. Sounds good?\n\nRegarding the latter, should I submit the annotation PR:s on a per-lock basis (i.e. o",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-343561308,343561308,
MarcoFalke,2018-01-10T14:24:49Z,"Needs rebase.\nFor the purpose of easing review and speeding up merge: What about submitting a subset of this that only renames the comments `// protected by ${cs}` to `GUARDED_BY(${cs})`. Assuming that the existing comments are reviewed such a subset should be refactoring-only and easier to merge.",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-356616856,356616856,
practicalswift,2018-01-31T16:22:26Z,"@MarcoFalke Do you mean a new PR with the `GUARDED_BY(…)`:s in this PR added instead as comments `// GUARDED_BY(…)`? Sure, confirm and I'll do that.\n\nRegarding rebasing – I suggest we merge (or close in the case of NACK) the locking related [PR:s I currently have open](https://github.com/bitcoin/bitcoin/pulls/practicalswift) and I'll rebase this PR on top of `master` after that. Makes sense?",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-361985753,361985753,
MarcoFalke,2018-02-02T23:38:09Z,"Something like e7f4866d499c4f1a5c17fa140be090da7c940c86, but at this point I am not sure if it is going to help review a lot.",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-362741639,362741639,
practicalswift,2018-02-22T21:46:15Z,Closing. Will split this into subsets and submit as separate PR:s.,https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-367833103,367833103,
practicalswift,2018-03-12T22:37:04Z,"To facilitate reviewing the most important parts of this thread-safety PR (milestone 0.17.0) have been submitted as individual PR:s –\n\n* #12665 – Add compile time checking for all run time locking assertions\n* #11795 – Avoid locking cs_vNodes twice when calling FindNode(...)\n* #11762 – Avoid locking mutexes that are already held by the same thread\n* #11694 – Add missing cs_main lock in g",https://github.com/bitcoin/bitcoin/pull/11226#issuecomment-372485811,372485811,
