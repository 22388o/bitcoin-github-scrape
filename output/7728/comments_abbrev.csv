jtimon,2016-03-29T13:05:52Z,"Ping, should I remove constant PRECISION_MULTIPLIER (just use KB for now) as suggested by @MarcoFalke ?\nIs there anything else that I should change before merging?\n",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-202882839,202882839,
MarcoFalke,2016-03-29T17:53:00Z,"Yes, either remove `PRECISION_MULTIPLIER` or rename `nSatoshisPerK` to `nSatoshis` or `nSatoshisRate`.\n",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-203025491,203025491,
MarcoFalke,2016-03-31T13:25:08Z,"Also you may add the tests to https://github.com/bitcoin/bitcoin/blob/28ad4d9fc2be102786a8c6c32ebecb466b2a03dd/src/test/amount_tests.cpp, so they are not ""hidden"" inside the mempool tests.\n",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-203934606,203934606,
jtimon,2016-03-31T13:45:12Z,"@MarcoFalke Mhmm, you mean something like:\n\n```\nBOOST_CHECK_EQUAL(feeRate.GetFee(X), 1557);\nBOOST_CHECK_EQUAL(feeRate.GetFee(Y), 1000);\nBOOST_CHECK_EQUAL(feeRate.GetFee(Z), 0);\n```\n\nor something more dynamic? Sounds like a good idea, in principle.\nI can take a look, but if you have something very clear in mind, please, I'm happy to take another commit (unless it is preferred to leave it f",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-203945954,203945954,
MarcoFalke,2016-03-31T13:50:11Z,"What I meant was to also test the `CFeeRate::CFeeRate(const CAmount& nFeePaid, size_t nSize)` constructor and then do two or three `GetFee()` on the instance.\n",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-203949182,203949182,
jtimon,2016-03-31T14:49:37Z,"Updated, hopefully solving nits.\nThe latest tests added (last commit) are probably overkill, but if it's going to take a lot of back and forth in review, I would rather leave it for another PR.\n",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-203972258,203972258,
jtimon,2016-04-02T10:54:36Z,"I'm not renaming nSatoshisPerK in this PR. I said that I was happy with either renaming or removing the constant and I thought renaming was enough. Please @MarcoFalke @laanwj can you decide one or the other? I don't care enough to discuss about it, but I cannot have the constant and not have it at the same time.\n",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-204693610,204693610,
laanwj,2016-04-03T13:27:17Z,"> I'm not renaming nSatoshisPerK in this PR\n\nI tend to agree that renaming the `GetFeePerK` _method_ has a much larger diff impact, and should not be done here. Let's leave this to a pull that would actually change `PRECISION_MULTIPLIER` from 1000. I am sure there will be other work to do as well at call-sites that expect a number per K.\n\nSame for renaming the member variable `nSatoshisPerK`, ",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-204975812,204975812,
jtimon,2016-04-03T13:33:53Z,"So the simplest options are still to leave the constant a is or to also leave the constant for later (which is what @MarcoFalke prefers). My preference would be to leave it as it is, but I'm happy removing the constant for now as well.\n",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-204977839,204977839,
laanwj,2016-04-03T13:38:38Z,I'm fine with leaving the constant.\nI'd say add an `assert(PRECISION_MULTIPLIER==1000);` to `GetFeePerK()` make this concern concrete.\n,https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-204978570,204978570,
jtimon,2016-04-06T11:57:12Z,I don't think the assert is necessary and I would prefer to just leave the the constant for later than adding it.\n,https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-206336242,206336242,
MarcoFalke,2016-04-06T15:52:44Z,"Agree that the assert is overkill. Maybe just add a comment, but it seems there is too much discussion about this; Please fix the amount tests, so we can move forward with this.\n",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-206439123,206439123,
jtimon,2016-04-14T14:35:33Z,"Rebased (1) after #7796.\nAlso added the comment on PRECISION_MULTIPLIER and stopped using KB for amounts in amount_tests.cpp.\n\nSurprisingly enough, #7796 makes the introduction of PRECISION_MULTIPLIER fail. I separated the failing change on the last commit labelled with ERROR ( https://github.com/bitcoin/bitcoin/pull/7728/commits/5ca24733d08ac57e01c521ded864fd516448f351 ) but I really don't und",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-209973917,209973917,
jtimon,2016-04-14T17:34:01Z,Removed the PRECISION_MULTIPLIER=KB constant.\n,https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-210068330,210068330,
sipa,2016-06-03T10:37:26Z,"Concept ACK (the test test exact precision, which is something that can change without problems, but the tests are marked as such).\n",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-223547128,223547128,
jtimon,2016-08-30T13:09:10Z,ping\n,https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-243432768,243432768,
MarcoFalke,2016-09-09T11:30:46Z,"Sorry for letting this sit around for so long. Though, I'd prefer to have at least an utACK on the `mempool_tests.cpp` changes, as I am still not convinced that the changes make the tests easier to read nor that this is the right place to test this logic.\n\nPreferably one of the authors of `mempool_tests.cpp` can jump in to provide feedback.\n",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-245888502,245888502,
luke-jr,2016-09-10T06:19:00Z,"utACK everything _except_ mempool_tests (but no objection to it either; sorry, I didn't understand what was going on there)\n",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-246093264,246093264,
MarcoFalke,2016-09-11T11:08:21Z,> I didn't understand what was going on there\n\nIn which case we probably shouldn't interwind mempool checks with internal precision checks of CFeeRate.\n,https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-246174716,246174716,
jtimon,2016-09-11T16:32:15Z,"To remind people, the initial PR contained ONLY the changes in mempool_tests. When/if we change internal precision, we will have to make this kind of changes to the mempool tests. Those tests are inherently intertwined with the feerate internal precission. We can wait for when/if we change the precision. Then marcoFalke asked for adding tests to amount_tests, which I did. Since then more tests hav",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-246189364,246189364,
morcos,2016-09-12T16:36:08Z,"I'm not sure we're ever going to change feerate internal precision.  But yes, lets leave it until we do to change the mempool_tests.  They are already annoyingly complicated enough as is (sorry), no reason to make them more convoluted; the next change should make them easier to understand.\n\nI don't object to the other changes, but I'm not sure they're worth bothering with.\n",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-246407352,246407352,
jtimon,2016-09-12T20:38:56Z,"> I don't object to the other changes, but I'm not sure they're worth bothering with.\n\nI tend to agree, as said new tests were added after  I added those tests and now these seem kind of redundant (ie #7727 would now fail the tests as it should).\n\nSince people don't seem to like the changes on mempool, I'm leaning towards closing.\n",https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-246484521,246484521,
MarcoFalke,2016-09-13T16:01:29Z,Closing for now per above discussion.\n,https://github.com/bitcoin/bitcoin/pull/7728#issuecomment-246732148,246732148,
MarcoFalke,2016-03-21T16:17:34Z,"You can't call this `nSatoshisPerK` anymore. If you ""break"" something, change its name.\n",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r56850261,56850261,src/amount.cpp
jtimon,2016-03-21T17:18:45Z,"Yeah, please let me follow up this with an ""only for discussion"" (#7731). The name nSatoshisPerK is definitely part of what I don't like about CFeeRate and related to the point I want to make in that PR.\n\nMaybe I should have left the constant `PRECISION_MULTIPLIER = KB` for that branch, but given that changing that  `PRECISION_MULTIPLIER = KB+1` will make the new test (among others) fail, I didn",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r56860024,56860024,src/amount.cpp
MarcoFalke,2016-03-21T17:21:54Z,"`PRECISION_MULTIPLIER` only makes sense being a multiple of `KB`, imo.\n",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r56860441,56860441,src/amount.cpp
jtimon,2016-03-21T19:59:26Z,"Yeah, see #7731 . GetFee is over complicated there, but if you assert `assert(PRECISION_MULTIPLIER % KB == 0)` that code can be simplified. I mean, it can be simplified by more means, for example, removing the special case from https://github.com/bitcoin/bitcoin/pull/7705#discussion_r56851706 (although that will be greatly disruptive outside of the class).\n",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r56886419,56886419,src/amount.cpp
laanwj,2016-03-31T13:08:54Z,"This name is too general, people will confuse this with something innate to bitcoin (like COIN). `FEERATE_PRECISION_MULTIPLIER` maybe? \nEdit: Or even better, make it a constant inside `class CFeeRate`?\n",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r58049811,58049811,src/amount.h
jtimon,2016-03-31T13:34:22Z,"Yeah, FEERATE_PRECISION_MULTIPLIER is much more clear (I think I started with that before confusing myself with 2 _PRECISION_MULTIPLIER constants).\nAbout making it a static const attribute in CFeeRate...I would like to avoid that.\nUnless I'm missing something, such a constant would need to be initialized in the cpp. That is, for example, what I dislike about https://github.com/bitcoin/bitcoin/bl",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r58053477,58053477,src/amount.h
laanwj,2016-03-31T13:42:47Z,"Then we agree that it's confusing. Please do rename it for this pull.\n\n> Unless I'm missing something, such a constant would need to be initialized in the cpp. That is, for example, what I dislike about\n\nNot true, try to compile the following:\n\n``` c++\n#include <stdio.h>\nclass TestClass {\npublic:\n    static const int SubValue = 12345;\n};\nint main()\n{\n    printf(""%i\n"", TestClass::Sub",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r58054806,58054806,src/amount.h
jtimon,2016-03-31T13:52:01Z,"Oh, I see, this is not a problem for basic types (I always forget strings are not a basic type in C++). Then I'm happy with either FEERATE_PRECISION_MULTIPLIER or CFeeRate::PRECISION_MULTIPLIER.\n\nOfftopic: back to the chainparams petname strings. Would it make sense to eventually (and probably very slowly to minimize disruption) replace those static strings with macros (so that ""main"" and friend",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r58056263,58056263,src/amount.h
MarcoFalke,2016-03-31T15:15:32Z,Lets not confuse people by saying I paid a fee of (KB) satoshis.\n,https://github.com/bitcoin/bitcoin/pull/7728#discussion_r58071849,58071849,src/test/amount_tests.cpp
jtimon,2016-03-31T23:52:59Z,"Please, improve and bike-shed the commit at will and I will probably squash. I warned about this, didn't I?\n",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r58146186,58146186,src/test/amount_tests.cpp
MarcoFalke,2016-04-02T10:40:40Z,I still think this commit is not ready to merge. You can not introduce a new internal precision multiplier (which happens to default to 1k) and then not adjust the name of the variable it affects.\n\nSomone will change the prec. multiplier to MB one day and no one will notice that the meaning of `nSatoshisPerK` changed.\n,https://github.com/bitcoin/bitcoin/pull/7728#discussion_r58291674,58291674,src/amount.h
jtimon,2016-04-02T10:49:31Z,"See #7731. You cannot *2 without disruption. *10 requires more disruption, etc. Besides, this includes new tests that would fail when changed. Nobody will change the constant ""without noticing"".\n",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r58291751,58291751,src/amount.h
MarcoFalke,2016-04-02T11:05:13Z,"Fine, then just remove `PRECISION_MULTIPLIER`.\n",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r58291875,58291875,src/amount.h
laanwj,2016-04-03T13:20:29Z,"Tend to agree here. Only use the KB constant for sizes, not for amounts. If you want a constant for 1000 satoshis, that's fine, define a differently-named one (only for the test, probably).\n",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r58310175,58310175,src/test/amount_tests.cpp
MarcoFalke,2016-04-14T15:17:28Z,This won't work. `PRECISION_MULTIPLIER` is unsigned (either 32-bit or 64-bit) as of your current implementation  and cpp will convert all other integers to unsigned 64-bit in this line on 64-bit platforms.\n,https://github.com/bitcoin/bitcoin/pull/7728#discussion_r59736152,59736152,src/amount.cpp
jtimon,2016-04-14T17:19:45Z,"Yes, it seems that was it, https://github.com/bitcoin/bitcoin/pull/7728/commits/4cb815a8f7c5422a6c5f4d020f027aefe7ffe172 seems to solve it (although it feels wrong for PRECISION_MULTIPLIER not to be size_t).\n\nI will definitely remove it (that's what I should have done the first you complained, instead of moving it around to keep discussing about it), but since half of the PR discussion ended up ",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r59755986,59755986,src/amount.cpp
MarcoFalke,2016-04-29T19:23:02Z,nit: typo\n,https://github.com/bitcoin/bitcoin/pull/7728#discussion_r61632058,61632058,src/test/mempool_tests.cpp
MarcoFalke,2016-04-29T19:23:04Z,What is the meaning of 2KB here? You mean CAmount(2000)?\n\nEdit: At least add a comment why the loop is necessary in the mempool tests to check the precision of CFeeRate...\n,https://github.com/bitcoin/bitcoin/pull/7728#discussion_r61632060,61632060,src/test/mempool_tests.cpp
jtimon,2016-04-29T19:38:40Z,"It wa clearer when it was CFeeRate::INTERNAL_PRECISION than now that it's KB...\nI can add comments, suggested comments always preferred, otherwise I'll come up with something myself ...There's one comment about the internal prevision below, but maybe that's not clear enough.\n",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r61633904,61633904,src/test/mempool_tests.cpp
MarcoFalke,2016-05-02T18:38:20Z,"Hmm, what I mean is that you are modifying `src/test/mempool_tests.cpp`, which goal should be to test mempool logic. However, you are trying to add fee/feerate/amount tests, which seem orthogonal to mempool tests. Personally I find it harder to read the mempool test now. So if it is really required to modify the mempool test, you'd need to add a comment why it is being done here. Otherwise, I'd su",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r61782049,61782049,src/test/mempool_tests.cpp
jtimon,2016-05-20T10:06:34Z,"I added tests to amount_tests.cpp just because you asked for them.\nIf we ever increase CFeeRate internal precission, the changes in mempool_tests.cpp will help. With these changes, the mempool tests will also fail if #7727 (although with your latest additions to amount_tests, it #7727 should already fail).\nSee outdated and closed #7731 .\n",https://github.com/bitcoin/bitcoin/pull/7728#discussion_r64018189,64018189,src/test/mempool_tests.cpp
