theuni,2017-10-05T15:33:28Z,"> In order to prevent this change from preventing connection to\n-connect= nodes which have !WITNESS, -connect nodes are now\ngiven the ""addnode"" flag.\n\nI really disliked that flag anyway, as it's not obvious who should care and why. This change makes sense imo. Mind renaming this to ""m_manual_connection"", or ""!m_from_addrman"" (or hopefully something better) ?",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-334503051,334503051,
TheBlueMatt,2017-10-05T15:50:23Z,"@theuni done in a new commit, that is much more descriptive, indeed.",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-334508259,334508259,
gmaxwell,2017-10-05T17:06:28Z,"I was thinking of opening a PR soon to require WITNESS for outbounds in any case, so ACK on that.",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-334529534,334529534,
TheBlueMatt,2017-10-05T22:06:55Z,"Rewrote the function description. Sufficiently descriptive, @jimpo?",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-334605613,334605613,
JeremyRubin,2017-10-06T16:05:38Z,"Concept Ack and a light CR-Ack. \n\nI agree with @ryanofsky about naming -- I didn't find the new function names you introduced to be particularly elucidating, so maybe you can pick something better.\n\nAlso, I don't think we want to introduce new hungarian notation member variables (unless the m_ stands for 'matt_' ;) ).",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-334798836,334798836,
TheBlueMatt,2017-10-06T16:07:11Z,"@ryanofsky I'm not sure what your comment about -connect is about. The help text still reads correct to me (it still limits you to only that one connection), the only thing it changes is that previously we would disconnect-on-VERSION-message for -connect peers which do not set NODE_NETWORK, now we will keep it connected just the same as -addnode peers. If you think thats a critical change to docum",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-334799262,334799262,
ryanofsky,2017-10-06T17:37:29Z,"Yeah, I wasn't saying the help text is incorrect, I was saying it was incomplete. Help text says `-connect` does one thing (limit which peers will be connected to) but actually `-connect` does two things (limit peers, and also loosen requirements for those peers). Feel free to leave it alone if you don't think it's worth mentioning, but it seemed like an omission.",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-334822166,334822166,
TheBlueMatt,2017-10-06T21:31:27Z,"OK, addressed all the feedback except the desire to rename Relevant to something else. I'm not a fan of Required or RequiredForOutbound, as neither really caputures its full user (its also used in eviction logic). I admit Relevant isnt so descriptive either, but it also doesn't give a false impression (and is documented), so I'm open to other suggestions but not a fan of the current options.",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-334875155,334875155,
TheBlueMatt,2017-10-06T21:57:55Z,"Changed to ""Desirable"" instead of ""Relevant"" at @JeremyRubin's suggestion.",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-334879999,334879999,
theuni,2017-10-10T19:02:34Z,"Concept ACK. Though, I believe that these lines demonstrate why ""Desirable"" is so awkward:\n```c++\nif (!fFeeler && !HasAllDesirableServiceFlags(addr.nServices)) {\n    continue;\n    } else if (fFeeler && !MayHaveUsefulAddressDB(addr.nServices)) {\n    continue;\n}\n```\n```MayHaveUsefulAddressDB()``` is explicit in what it's checking, but ```HasAllDesirableServiceFlags()``` is not.\n\n",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-335575012,335575012,
TheBlueMatt,2017-10-10T19:42:22Z,"The goal with the naming was to allow the place that owns network logic to have a function which captures whether a peer is interesting to us. Point being you want some function which captures everything net wants to avoid knowing about, even if that's some crazy wrapper for MayServe*WitnessBlocks, that wrapper should still exist outside of CConnman/net. Ideally, eventually, this will be in net_pr",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-335585421,335585421,
sipa,2017-10-10T20:04:19Z,"The reason for `CNode::nExpected` wasn't so much enforcing services, but checking whether we're connecting out to the right node.\n\nMany of our assumptions on partition resistance and privacy are based on the fact that outgoing connections are more under our control. If we're making an outgoing connection, and the node we end up connecting to has different service flags than what we expect - ev",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-335591283,335591283,
theuni,2017-10-10T20:41:40Z,"@sipa I think this logic would roughly mimic that of nExpected, as we only attempt connections with preferred flags anyway.\n\nThough disconnecting upon receiving preferred but not expected flags would mean that if a node goes from full -> pruned (or the reverse), it would see a bunch of disconnects for a while. Post bip159, that is.\n\nI think it would also open us up to issues if someone was",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-335601357,335601357,
sipa,2017-10-11T22:25:40Z,"@theuni My view is that at connection time, we're making a certain determination of what to connect to, with biases based on (among other things) the service flags of all things in addrman. Disconnecting if you see that what you connected to was based on wrong information just gives everything a new chance (including the peer you just connected to). In the end, what node you end up connecting to h",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-335966576,335966576,
sipa,2017-10-12T23:18:52Z,"Commit 'Rename fAddnode to a more-descriptive ""manual_connection""': convert to scripted diff?",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-336307320,336307320,
sipa,2017-10-12T23:22:52Z,utACK after fixing the incorrect `HasAllDesirableServiceFlags` logic. One nit.,https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-336307908,336307908,
TheBlueMatt,2017-10-13T17:30:35Z,"Fixed missing `!`, making the fAnnode -> manul_connection commit scripted isnt trivial given some of them are m_manual_connection but some are manul_connection in function parameters. Its a pretty simple commit anyway so I'll just leave it unless you have strong objections.",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-336517182,336517182,
theuni,2017-10-13T20:05:29Z,"@ryanofsky nice spot.\n\nI'm still not a big fan of keeping the relevant concept around, but this is an improvement regardless.\n\nutACK 15f5d3b17298be96c6c684c195c02ac249ffd392.",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-336554242,336554242,
sipa,2017-10-13T20:06:54Z,">  making the fAnnode -> manul_connection commit scripted isnt trivial given some of them are m_manual_connection but some are manul_connection in function parameters\n\nI missed that. The change looks fine without.",https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-336554576,336554576,
sipa,2017-10-13T22:18:53Z,utACK 15f5d3b17298be96c6c684c195c02ac249ffd392,https://github.com/bitcoin/bitcoin/pull/11456#issuecomment-336580811,336580811,
jimpo,2017-10-05T16:08:57Z,Can you document what the parameter represents? Hard to tell since it's unused. I assume it's for future compatibility.,https://github.com/bitcoin/bitcoin/pull/11456#discussion_r142984466,142984466,src/protocol.h
TheBlueMatt,2017-10-05T16:27:57Z,"Indeed, its for use in #10387. Will it be clearer when the function reads\n```\nGetRelevantServiceFlags(services) {\n    if (services & NODE_NETWORK_LIMITED && !in_ibd) return NODE_NETWORK_LIMITED | NODE_WITNESS;\n    return NODE_NETWORK | NODE_WITNESS;\n```\nor should I document it further?",https://github.com/bitcoin/bitcoin/pull/11456#discussion_r142989057,142989057,src/protocol.h
jimpo,2017-10-05T16:50:08Z,"Yeah, parameter documentation would be nice because I still find its purpose confusing. Especially since as a parameter of `HasAllRelevantServiceFlags` it represents both the service flags you want to test and a modifier on what you want to test against. Like, why is the future code not just:\n\n```c++\nGetRelevantServiceFlags() {\n    if (!in_ibd) return NODE_NETWORK_LIMITED | NODE_WITNESS;\",https://github.com/bitcoin/bitcoin/pull/11456#discussion_r142994437,142994437,src/protocol.h
ryanofsky,2017-10-06T14:13:59Z,"I like jimpo's suggestion above for getting rid of the service argument, since this code seems more vague and confusing than it needs to be. Other suggestions for making it clearer could be:\n\n- Rename ""Relevant"" to ""Required"" or ""RequiredForOutbound."" ""Relevant"" doesn't suggest what the return value will be used for, while ""Required"" does.\n- Rename ""services"" argument to ""peer_service_flags""",https://github.com/bitcoin/bitcoin/pull/11456#discussion_r143200547,143200547,src/protocol.h
ryanofsky,2017-10-06T14:24:31Z,"""Relevant"" doesn't seem like the right word here either, because it doesn't imply anything about the addressdb. Maybe ""Robust""? ""Good""? ""Usable""?",https://github.com/bitcoin/bitcoin/pull/11456#discussion_r143203308,143203308,src/protocol.h
ryanofsky,2017-10-06T14:35:24Z,"Again could consider ""Required"" / ""peer_service_flags"" renames suggested above.",https://github.com/bitcoin/bitcoin/pull/11456#discussion_r143206195,143206195,src/protocol.h
TheBlueMatt,2017-10-06T15:24:10Z,"You need the NODE_NETWORK_LIMITED check as a proxy for whether the node is new - eg if the node announces NODE_NETWORK_LIMITED (and you're out of IBD) then you're fine with NODE_NETWORK_LIMITED, but if the node only announces NODE_NETWORK they may be an 0.15.X node and you're perfectly OK with them having only NODE_NETWORK and not NODE_NETWORK_LIMITED.",https://github.com/bitcoin/bitcoin/pull/11456#discussion_r143219778,143219778,src/protocol.h
ryanofsky,2017-10-06T15:31:30Z,"Oh, ok, I figured that would work because NODE_NETWORK would be a superset of NODE_NETWORK_LIMITED. But if NODE_NETWORK without NODE_NETWORK_LIMITED is a meaningful flag combination then it makes sense that you need the services argument.\n\nIn any case, I mostly wanted to suggest the renames here.",https://github.com/bitcoin/bitcoin/pull/11456#discussion_r143221802,143221802,src/protocol.h
TheBlueMatt,2017-10-06T16:04:39Z,"NODE_NETWORK without NODE_NETWORK_LIMITED is not meaningful generally, but old nodes will (obviously) be using that, so it is important that we still treat it correctly.",https://github.com/bitcoin/bitcoin/pull/11456#discussion_r143229920,143229920,src/protocol.h
jimpo,2017-10-06T17:18:18Z,nit: we are*,https://github.com/bitcoin/bitcoin/pull/11456#discussion_r143247408,143247408,src/protocol.h
theuni,2017-10-06T18:43:27Z,"I think services are just acting as a proxy here. Since we enforce service checking for (non-manual) outgoing connections already, and should probably consider incoming nodes as insignificant for the sake of this check, don't we really just want to tally ```fSuccessfullyConnected && !fInbound && !m_manual_connection``` ?",https://github.com/bitcoin/bitcoin/pull/11456#discussion_r143267453,143267453,src/net.cpp
TheBlueMatt,2017-10-06T20:47:37Z,"Agreed, though I went ahead and added OneShot and Feeler into the mix.",https://github.com/bitcoin/bitcoin/pull/11456#discussion_r143290913,143290913,src/net.cpp
ryanofsky,2017-10-06T21:39:59Z,and are,https://github.com/bitcoin/bitcoin/pull/11456#discussion_r143300105,143300105,src/rpc/net.cpp
promag,2017-10-07T08:26:57Z,"Nit, unused services, comment?",https://github.com/bitcoin/bitcoin/pull/11456#discussion_r143326023,143326023,src/protocol.h
promag,2017-10-07T08:31:44Z,inline?,https://github.com/bitcoin/bitcoin/pull/11456#discussion_r143326070,143326070,src/protocol.h
TheBlueMatt,2017-10-08T04:04:14Z,"See https://github.com/bitcoin/bitcoin/pull/11456#discussion_r142989057, this function should get much more complicated soon, and hopefully move out of protocol.h at the same time.",https://github.com/bitcoin/bitcoin/pull/11456#discussion_r143345814,143345814,src/protocol.h
sipa,2017-10-12T00:49:07Z,Slightly easier expression `!(GetDesirableServiceFlags(services) & ~services)`.,https://github.com/bitcoin/bitcoin/pull/11456#discussion_r144172194,144172194,src/protocol.h
TheBlueMatt,2017-10-12T00:59:08Z,Fixed.,https://github.com/bitcoin/bitcoin/pull/11456#discussion_r144173175,144173175,src/protocol.h
sipa,2017-10-12T01:04:37Z,Are you sure you wouldn't want `MayHaveUsefulAddressDB` at least here?,https://github.com/bitcoin/bitcoin/pull/11456#discussion_r144173735,144173735,src/net.cpp
TheBlueMatt,2017-10-12T03:26:49Z,fSuccessfullyConnected && !special_peer_flag implies the peer is useful (and really want to have as few service-bit-aware pieces of logic in net as possible).,https://github.com/bitcoin/bitcoin/pull/11456#discussion_r144186991,144186991,src/net.cpp
ryanofsky,2017-10-12T19:46:11Z,Missing `!`,https://github.com/bitcoin/bitcoin/pull/11456#discussion_r144391264,144391264,src/protocol.h
sipa,2017-10-12T23:21:59Z,Got it.,https://github.com/bitcoin/bitcoin/pull/11456#discussion_r144434000,144434000,src/net.cpp
