[
  {
    "sha": "54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1NGFiYjdiMWEwYjI0YTg5YmJkYTNhOWRkNGNlYTJhMjM2ZTQyNDNj",
    "commit": {
      "author": {
        "name": "Ivan Pustogarov",
        "email": "ivanpustogarov@users.noreply.github.com",
        "date": "2014-08-12T15:52:28Z"
      },
      "committer": {
        "name": "Ivan Pustogarov",
        "email": "ivanpustogarov@users.noreply.github.com",
        "date": "2014-11-20T17:41:04Z"
      },
      "message": "Add new command line option '-maxoutbound'\n\nWhile there is a command line option to limit the total number of\nconnections ('-maxconnections'), the number of outbound connections is\ncontrolled by a hard-coded constant 'MAX_OUTBOUND_CONNECTIONS=8'.\nThis number (8) of connections has a bad impact on user's privacy. Let's\nkeep the default number of outbound connections (of 8) but allow a user\nto have more privacy by reducing this number (to 3 or 4) using\n'-maxoutbound'.\n\nExplanation: transactions that are first relayed by these 8 entry nodes\nmost probably belong to the same user. In fact, even a subset of these 8\nentry nodes can uniquely identify a user. There is a cheap way for an\nattacker to learn this set of entry nodes and the user's public IP and\nuse it to deanonymize the user (note that users by default advertise\ntheir public IP addresses even when behind NAT).  If the user has 3-4\noutbound connection the success rate of the attack becomes quite low.",
      "tree": {
        "sha": "ac746b1d9b60211d41e3b6afbb0ed3a7a4da3d8b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ac746b1d9b60211d41e3b6afbb0ed3a7a4da3d8b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c/comments",
    "author": {
      "login": "ivanpustogarov",
      "id": 8126617,
      "node_id": "MDQ6VXNlcjgxMjY2MTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8126617?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ivanpustogarov",
      "html_url": "https://github.com/ivanpustogarov",
      "followers_url": "https://api.github.com/users/ivanpustogarov/followers",
      "following_url": "https://api.github.com/users/ivanpustogarov/following{/other_user}",
      "gists_url": "https://api.github.com/users/ivanpustogarov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ivanpustogarov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ivanpustogarov/subscriptions",
      "organizations_url": "https://api.github.com/users/ivanpustogarov/orgs",
      "repos_url": "https://api.github.com/users/ivanpustogarov/repos",
      "events_url": "https://api.github.com/users/ivanpustogarov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ivanpustogarov/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ivanpustogarov",
      "id": 8126617,
      "node_id": "MDQ6VXNlcjgxMjY2MTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8126617?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ivanpustogarov",
      "html_url": "https://github.com/ivanpustogarov",
      "followers_url": "https://api.github.com/users/ivanpustogarov/followers",
      "following_url": "https://api.github.com/users/ivanpustogarov/following{/other_user}",
      "gists_url": "https://api.github.com/users/ivanpustogarov/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ivanpustogarov/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ivanpustogarov/subscriptions",
      "organizations_url": "https://api.github.com/users/ivanpustogarov/orgs",
      "repos_url": "https://api.github.com/users/ivanpustogarov/repos",
      "events_url": "https://api.github.com/users/ivanpustogarov/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ivanpustogarov/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "5c4dffd188bf82c1965871bdf013b18a61e3d7d0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5c4dffd188bf82c1965871bdf013b18a61e3d7d0",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/5c4dffd188bf82c1965871bdf013b18a61e3d7d0"
      }
    ],
    "stats": {
      "total": 22,
      "additions": 18,
      "deletions": 4
    },
    "files": [
      {
        "sha": "47c230e89241ac2481fe3cc05b0d80dac448617f",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 13,
        "deletions": 0,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c",
        "patch": "@@ -70,6 +70,7 @@ enum BindFlags {\n \n static const char* FEE_ESTIMATES_FILENAME=\"fee_estimates.dat\";\n CClientUIInterface uiInterface;\n+const int OUTBOUND_CONNECTIONS_UPPER_LIMIT = 8;\n \n //////////////////////////////////////////////////////////////////////////////\n //\n@@ -261,6 +262,7 @@ std::string HelpMessage(HelpMessageMode mode)\n     strUsage += \"  -forcednsseed          \" + strprintf(_(\"Always query for peer addresses via DNS lookup (default: %u)\"), 0) + \"\\n\";\n     strUsage += \"  -listen                \" + _(\"Accept connections from outside (default: 1 if no -proxy or -connect)\") + \"\\n\";\n     strUsage += \"  -maxconnections=<n>    \" + strprintf(_(\"Maintain at most <n> connections to peers (default: %u)\"), 125) + \"\\n\";\n+    strUsage += \"  -maxoutbound=<n>       \" + strprintf(_(\"Establish at most <n> _outbound_ connections to peers (default: %u)\"),8) + \"\\n\";\n     strUsage += \"  -maxreceivebuffer=<n>  \" + strprintf(_(\"Maximum per-connection receive buffer, <n>*1000 bytes (default: %u)\"), 5000) + \"\\n\";\n     strUsage += \"  -maxsendbuffer=<n>     \" + strprintf(_(\"Maximum per-connection send buffer, <n>*1000 bytes (default: %u)\"), 1000) + \"\\n\";\n     strUsage += \"  -onion=<ip:port>       \" + strprintf(_(\"Use separate SOCKS5 proxy to reach peers via Tor hidden services (default: %s)\"), \"-proxy\") + \"\\n\";\n@@ -616,6 +618,17 @@ bool AppInit2(boost::thread_group& threadGroup)\n     if (nFD - MIN_CORE_FILEDESCRIPTORS < nMaxConnections)\n         nMaxConnections = nFD - MIN_CORE_FILEDESCRIPTORS;\n \n+    // Change the default number of outbound connections.  Setting it to more\n+    // than 8 is a bad idea. The number of peers that are able to accept\n+    // incoming connections is about 8,000 ('servers'). The number of peers that\n+    // are behind NAT is about 100,000. If every NATed peer has 8 outgoing\n+    // connections then each server will have 100+8 connections in average.\n+    // This is close to maximum of 125. Increasing '-maxoutbound' to e.g. 10 at\n+    // each client will result in that Bitcoin users will have problems\n+    // connecting to the Bitcoin network.\n+    nMaxOutboundConnections = GetArg(\"-maxoutbound\", 8);\n+    nMaxOutboundConnections = std::max(std::min(OUTBOUND_CONNECTIONS_UPPER_LIMIT,std::min(nMaxOutboundConnections, nMaxConnections)),0);\n+\n     // ********************************************************* Step 3: parameter-to-internal-flags\n \n     fDebug = !mapMultiArgs[\"-debug\"].empty();"
      },
      {
        "sha": "396f793dcd0b63d392ff39db91c0e0c287615016",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 4,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c",
        "patch": "@@ -53,7 +53,6 @@ using namespace boost;\n using namespace std;\n \n namespace {\n-    const int MAX_OUTBOUND_CONNECTIONS = 8;\n \n     struct ListenSocket {\n         SOCKET socket;\n@@ -78,6 +77,7 @@ uint64_t nLocalHostNonce = 0;\n static std::vector<ListenSocket> vhListenSocket;\n CAddrMan addrman;\n int nMaxConnections = 125;\n+int nMaxOutboundConnections = 8;\n bool fAddressesInitialized = false;\n \n vector<CNode*> vNodes;\n@@ -860,7 +860,7 @@ void ThreadSocketHandler()\n                     if (nErr != WSAEWOULDBLOCK)\n                         LogPrintf(\"socket error accept failed: %s\\n\", NetworkErrorString(nErr));\n                 }\n-                else if (nInbound >= nMaxConnections - MAX_OUTBOUND_CONNECTIONS)\n+                else if (nInbound >= nMaxConnections - nMaxOutboundConnections)\n                 {\n                     CloseSocket(hSocket);\n                 }\n@@ -1619,7 +1619,7 @@ void StartNode(boost::thread_group& threadGroup)\n \n     if (semOutbound == NULL) {\n         // initialize semaphore\n-        int nMaxOutbound = min(MAX_OUTBOUND_CONNECTIONS, nMaxConnections);\n+        int nMaxOutbound = min(nMaxOutboundConnections, nMaxConnections);\n         semOutbound = new CSemaphore(nMaxOutbound);\n     }\n \n@@ -1661,7 +1661,7 @@ bool StopNode()\n     LogPrintf(\"StopNode()\\n\");\n     MapPort(false);\n     if (semOutbound)\n-        for (int i=0; i<MAX_OUTBOUND_CONNECTIONS; i++)\n+        for (int i=0; i<nMaxOutboundConnections; i++)\n             semOutbound->post();\n \n     if (fAddressesInitialized)"
      },
      {
        "sha": "303fabbc4f7e5cac4d23ba64ba29b19c71d7cc3b",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=54abb7b1a0b24a89bbda3a9dd4cea2a236e4243c",
        "patch": "@@ -122,6 +122,7 @@ extern uint64_t nLocalServices;\n extern uint64_t nLocalHostNonce;\n extern CAddrMan addrman;\n extern int nMaxConnections;\n+extern int nMaxOutboundConnections;\n \n extern std::vector<CNode*> vNodes;\n extern CCriticalSection cs_vNodes;"
      }
    ]
  }
]