[
  {
    "sha": "0165a56f20bf0666c9a0850d5634bf5547cee29b",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowMTY1YTU2ZjIwYmYwNjY2YzlhMDg1MGQ1NjM0YmY1NTQ3Y2VlMjli",
    "commit": {
      "author": {
        "name": "Jonas Schnelli",
        "email": "dev@jonasschnelli.ch",
        "date": "2016-11-12T09:53:18Z"
      },
      "committer": {
        "name": "Jonas Schnelli",
        "email": "dev@jonasschnelli.ch",
        "date": "2017-01-24T13:25:42Z"
      },
      "message": "Refactor ZapWalletTxes to avoid layer vialotions",
      "tree": {
        "sha": "34a5bc0379c56bc056d6e1421c3c9bebca89bc89",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/34a5bc0379c56bc056d6e1421c3c9bebca89bc89"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0165a56f20bf0666c9a0850d5634bf5547cee29b",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "expired_key",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEMu5cTD+hXMrbRqvlKdS8tkFvU+wFAliHVdcACgkQKdS8tkFv\nU+x9dw/7BGS/eFqcvHqMfDouYl0mA3mwkgiC7sF84WyySb2JdX7ZUEKZ4APLMyGQ\nAH3GMUb7OdjgrwsRzL5ACNQuaGQSFSAuoGfwFKKdZpISKpkOsUXLX+3LuDqb3M7x\nNLxW2rLn4XkFt0vLrGNS3U7D2aSGsU8B+zJXvfjhnXWXYwvlJTd/IbPQWTFrvP/s\n+1Dd0c5nysoQJeazJzm7wkWaZOOyln1k7wO4kBbwzT6det9sYiaWBbwtRzpkSBb3\nc+Z1I2zvwNIzDGYaC/AaRbG9tzj1zeqT0uhUfm9kXyhm+gvW21yPKqki9UYhPYQ3\nKlYwKy1/1GQJ8wKvf8UcuXa9Go11argjk5k/4/bsXT9AOdcO3zqykXqCroEiQrnO\nBDuB2G1Hc4rYW9zGCIchfuCwr/ZwfTKZeI/xUZkeivIlPJcFsJilft1mZFFoqI2O\nhomwgeUfe8rmi2bifmv9TSkw3dXA/zKWTqrBnxa7tacYRWJeBsG/aeLOoKPmEPLe\nFW48dAsnVEDDRTgRkD6kj6JjktQdWb/7kAymbulB2cqbSj22C0I+U46qsgloqQF4\n/4ThyovOuAHZDPlcscNdfxuViWisY95gUsP+ii4MpOT6tBjhnIeJcqmMSmoePZqT\nkdzkRKGZA6TJtUibF+UMuPGU6TL1f5Ir3S5N90gd4gK2Rv1qm3U=\n=sxsY\n-----END PGP SIGNATURE-----",
        "payload": "tree 34a5bc0379c56bc056d6e1421c3c9bebca89bc89\nparent 71148b8947fe8b4d756822420a7f31c380159425\nauthor Jonas Schnelli <dev@jonasschnelli.ch> 1478944398 +0100\ncommitter Jonas Schnelli <dev@jonasschnelli.ch> 1485264342 +0100\n\nRefactor ZapWalletTxes to avoid layer vialotions\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0165a56f20bf0666c9a0850d5634bf5547cee29b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/0165a56f20bf0666c9a0850d5634bf5547cee29b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0165a56f20bf0666c9a0850d5634bf5547cee29b/comments",
    "author": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "71148b8947fe8b4d756822420a7f31c380159425",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/71148b8947fe8b4d756822420a7f31c380159425",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/71148b8947fe8b4d756822420a7f31c380159425"
      }
    ],
    "stats": {
      "total": 31,
      "additions": 16,
      "deletions": 15
    },
    "files": [
      {
        "sha": "50e5e2a685eb7ce787fb21a4854d43c2fd9aefb7",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 3,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0165a56f20bf0666c9a0850d5634bf5547cee29b/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0165a56f20bf0666c9a0850d5634bf5547cee29b/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=0165a56f20bf0666c9a0850d5634bf5547cee29b",
        "patch": "@@ -2846,12 +2846,16 @@ DBErrors CWallet::ZapSelectTx(vector<uint256>& vHashIn, vector<uint256>& vHashOu\n {\n     if (!fFileBacked)\n         return DB_LOAD_OK;\n-    DBErrors nZapSelectTxRet = CWalletDB(strWalletFile,\"cr+\").ZapSelectTx(this, vHashIn, vHashOut);\n+    AssertLockHeld(cs_wallet); // mapWallet\n+    vchDefaultKey = CPubKey();\n+    DBErrors nZapSelectTxRet = CWalletDB(strWalletFile,\"cr+\").ZapSelectTx(vHashIn, vHashOut);\n+    for (uint256 hash : vHashOut)\n+        mapWallet.erase(hash);\n+\n     if (nZapSelectTxRet == DB_NEED_REWRITE)\n     {\n         if (CDB::Rewrite(strWalletFile, \"\\x04pool\"))\n         {\n-            LOCK(cs_wallet);\n             setKeyPool.clear();\n             // Note: can't top-up keypool here, because wallet is locked.\n             // User will be prompted to unlock wallet the next operation\n@@ -2872,7 +2876,8 @@ DBErrors CWallet::ZapWalletTx(std::vector<CWalletTx>& vWtx)\n {\n     if (!fFileBacked)\n         return DB_LOAD_OK;\n-    DBErrors nZapWalletTxRet = CWalletDB(strWalletFile,\"cr+\").ZapWalletTx(this, vWtx);\n+    vchDefaultKey = CPubKey();\n+    DBErrors nZapWalletTxRet = CWalletDB(strWalletFile,\"cr+\").ZapWalletTx(vWtx);\n     if (nZapWalletTxRet == DB_NEED_REWRITE)\n     {\n         if (CDB::Rewrite(strWalletFile, \"\\x04pool\"))"
      },
      {
        "sha": "e67b7f2c58aa15d9f4531d7782d430bbfb020357",
        "filename": "src/wallet/walletdb.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 9,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0165a56f20bf0666c9a0850d5634bf5547cee29b/src/wallet/walletdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0165a56f20bf0666c9a0850d5634bf5547cee29b/src/wallet/walletdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.cpp?ref=0165a56f20bf0666c9a0850d5634bf5547cee29b",
        "patch": "@@ -646,20 +646,17 @@ DBErrors CWalletDB::LoadWallet(CWallet* pwallet)\n     return result;\n }\n \n-DBErrors CWalletDB::FindWalletTx(CWallet* pwallet, vector<uint256>& vTxHash, vector<CWalletTx>& vWtx)\n+DBErrors CWalletDB::FindWalletTx(vector<uint256>& vTxHash, vector<CWalletTx>& vWtx)\n {\n-    pwallet->vchDefaultKey = CPubKey();\n     bool fNoncriticalErrors = false;\n     DBErrors result = DB_LOAD_OK;\n \n     try {\n-        LOCK(pwallet->cs_wallet);\n         int nMinVersion = 0;\n         if (Read((string)\"minversion\", nMinVersion))\n         {\n             if (nMinVersion > CLIENT_VERSION)\n                 return DB_TOO_NEW;\n-            pwallet->LoadMinVersion(nMinVersion);\n         }\n \n         // Get cursor\n@@ -712,12 +709,12 @@ DBErrors CWalletDB::FindWalletTx(CWallet* pwallet, vector<uint256>& vTxHash, vec\n     return result;\n }\n \n-DBErrors CWalletDB::ZapSelectTx(CWallet* pwallet, vector<uint256>& vTxHashIn, vector<uint256>& vTxHashOut)\n+DBErrors CWalletDB::ZapSelectTx(vector<uint256>& vTxHashIn, vector<uint256>& vTxHashOut)\n {\n     // build list of wallet TXs and hashes\n     vector<uint256> vTxHash;\n     vector<CWalletTx> vWtx;\n-    DBErrors err = FindWalletTx(pwallet, vTxHash, vWtx);\n+    DBErrors err = FindWalletTx(vTxHash, vWtx);\n     if (err != DB_LOAD_OK) {\n         return err;\n     }\n@@ -736,7 +733,6 @@ DBErrors CWalletDB::ZapSelectTx(CWallet* pwallet, vector<uint256>& vTxHashIn, ve\n             break;\n         }\n         else if ((*it) == hash) {\n-            pwallet->mapWallet.erase(hash);\n             if(!EraseTx(hash)) {\n                 LogPrint(\"db\", \"Transaction was found for deletion but returned database error: %s\\n\", hash.GetHex());\n                 delerror = true;\n@@ -751,11 +747,11 @@ DBErrors CWalletDB::ZapSelectTx(CWallet* pwallet, vector<uint256>& vTxHashIn, ve\n     return DB_LOAD_OK;\n }\n \n-DBErrors CWalletDB::ZapWalletTx(CWallet* pwallet, vector<CWalletTx>& vWtx)\n+DBErrors CWalletDB::ZapWalletTx(vector<CWalletTx>& vWtx)\n {\n     // build list of wallet TXs\n     vector<uint256> vTxHash;\n-    DBErrors err = FindWalletTx(pwallet, vTxHash, vWtx);\n+    DBErrors err = FindWalletTx(vTxHash, vWtx);\n     if (err != DB_LOAD_OK)\n         return err;\n "
      },
      {
        "sha": "6040372d9b76c8ddf795263b24fb5f09f75d430e",
        "filename": "src/wallet/walletdb.h",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0165a56f20bf0666c9a0850d5634bf5547cee29b/src/wallet/walletdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0165a56f20bf0666c9a0850d5634bf5547cee29b/src/wallet/walletdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.h?ref=0165a56f20bf0666c9a0850d5634bf5547cee29b",
        "patch": "@@ -167,9 +167,9 @@ class CWalletDB : public CDB\n     void ListAccountCreditDebit(const std::string& strAccount, std::list<CAccountingEntry>& acentries);\n \n     DBErrors LoadWallet(CWallet* pwallet);\n-    DBErrors FindWalletTx(CWallet* pwallet, std::vector<uint256>& vTxHash, std::vector<CWalletTx>& vWtx);\n-    DBErrors ZapWalletTx(CWallet* pwallet, std::vector<CWalletTx>& vWtx);\n-    DBErrors ZapSelectTx(CWallet* pwallet, std::vector<uint256>& vHashIn, std::vector<uint256>& vHashOut);\n+    DBErrors FindWalletTx(std::vector<uint256>& vTxHash, std::vector<CWalletTx>& vWtx);\n+    DBErrors ZapWalletTx(std::vector<CWalletTx>& vWtx);\n+    DBErrors ZapSelectTx(std::vector<uint256>& vHashIn, std::vector<uint256>& vHashOut);\n     static bool Recover(CDBEnv& dbenv, const std::string& filename, bool fOnlyKeys);\n     static bool Recover(CDBEnv& dbenv, const std::string& filename);\n "
      }
    ]
  }
]