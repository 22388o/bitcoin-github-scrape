[
  {
    "sha": "3c61abbbc847d725f30d169278d84655571407c1",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozYzYxYWJiYmM4NDdkNzI1ZjMwZDE2OTI3OGQ4NDY1NTU3MTQwN2Mx",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2020-04-07T02:06:29Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2020-04-07T19:53:40Z"
      },
      "message": "Do not clear validationinterface entries being executed\n\nThe previous code for MainSignalsInstance::Clear would decrement the reference\ncount of every interface, including ones that were already Unregister()ed but\nstill being executed.",
      "tree": {
        "sha": "addf0aeae4621a4aa0ff06898afe76317151493f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/addf0aeae4621a4aa0ff06898afe76317151493f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3c61abbbc847d725f30d169278d84655571407c1",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3c61abbbc847d725f30d169278d84655571407c1",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/3c61abbbc847d725f30d169278d84655571407c1",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3c61abbbc847d725f30d169278d84655571407c1/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1b151e3ffce7c1a2ee46bf280cc1d96775d1f91e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1b151e3ffce7c1a2ee46bf280cc1d96775d1f91e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1b151e3ffce7c1a2ee46bf280cc1d96775d1f91e"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 2,
      "deletions": 2
    },
    "files": [
      {
        "sha": "11000774c09da26012a56a9ff599a0874361e919",
        "filename": "src/validationinterface.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/3c61abbbc847d725f30d169278d84655571407c1/src/validationinterface.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/3c61abbbc847d725f30d169278d84655571407c1/src/validationinterface.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validationinterface.cpp?ref=3c61abbbc847d725f30d169278d84655571407c1",
        "patch": "@@ -67,8 +67,8 @@ struct MainSignalsInstance {\n     void Clear()\n     {\n         LOCK(m_mutex);\n-        for (auto it = m_list.begin(); it != m_list.end();) {\n-            it = --it->count ? std::next(it) : m_list.erase(it);\n+        for (const auto& entry : m_map) {\n+            if (!--entry.second->count) m_list.erase(entry.second);\n         }\n         m_map.clear();\n     }"
      }
    ]
  },
  {
    "sha": "2276339a176f83ffe8ceefb3e41ecca8601aa13b",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyMjc2MzM5YTE3NmY4M2ZmZThjZWVmYjNlNDFlY2NhODYwMWFhMTNi",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2020-04-07T12:03:39Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2020-04-07T19:54:41Z"
      },
      "message": "Add test for UnregisterAllValidationInterfaces bug\n\nBug in MainSignalsInstance::Clear could cause validation interface callbacks to\nbe deleted during execution if UnregisterAllValidationInterfaces was called\nmore than once.\n\nBug was introduced in https://github.com/bitcoin/bitcoin/pull/18524 and is\nfixed by https://github.com/bitcoin/bitcoin/pull/18551",
      "tree": {
        "sha": "fe4e86b7ebe0b2aa3f24c9f5250e827e55b736fe",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/fe4e86b7ebe0b2aa3f24c9f5250e827e55b736fe"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2276339a176f83ffe8ceefb3e41ecca8601aa13b",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2276339a176f83ffe8ceefb3e41ecca8601aa13b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/2276339a176f83ffe8ceefb3e41ecca8601aa13b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2276339a176f83ffe8ceefb3e41ecca8601aa13b/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "3c61abbbc847d725f30d169278d84655571407c1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3c61abbbc847d725f30d169278d84655571407c1",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/3c61abbbc847d725f30d169278d84655571407c1"
      }
    ],
    "stats": {
      "total": 64,
      "additions": 64,
      "deletions": 0
    },
    "files": [
      {
        "sha": "3443ee089d45cfac6853cdd4f23fa044e6affe6b",
        "filename": "src/Makefile.test.include",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2276339a176f83ffe8ceefb3e41ecca8601aa13b/src/Makefile.test.include",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2276339a176f83ffe8ceefb3e41ecca8601aa13b/src/Makefile.test.include",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/Makefile.test.include?ref=2276339a176f83ffe8ceefb3e41ecca8601aa13b",
        "patch": "@@ -239,6 +239,7 @@ BITCOIN_TESTS =\\\n   test/util_tests.cpp \\\n   test/validation_block_tests.cpp \\\n   test/validation_flush_tests.cpp \\\n+  test/validationinterface_tests.cpp \\\n   test/versionbits_tests.cpp\n \n if ENABLE_WALLET"
      },
      {
        "sha": "b4aa2f0f3a086cd2b1ad2c7e42d6b3cfa4baa5fc",
        "filename": "src/test/validationinterface_tests.cpp",
        "status": "added",
        "additions": 63,
        "deletions": 0,
        "changes": 63,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2276339a176f83ffe8ceefb3e41ecca8601aa13b/src/test/validationinterface_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2276339a176f83ffe8ceefb3e41ecca8601aa13b/src/test/validationinterface_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/validationinterface_tests.cpp?ref=2276339a176f83ffe8ceefb3e41ecca8601aa13b",
        "patch": "@@ -0,0 +1,63 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <boost/test/unit_test.hpp>\n+\n+#include <consensus/validation.h>\n+#include <primitives/block.h>\n+#include <scheduler.h>\n+#include <util/check.h>\n+#include <validationinterface.h>\n+\n+BOOST_AUTO_TEST_SUITE(validationinterface_tests)\n+\n+class TestInterface : public CValidationInterface\n+{\n+public:\n+    TestInterface(std::function<void()> on_call = nullptr, std::function<void()> on_destroy = nullptr)\n+        : m_on_call(std::move(on_call)), m_on_destroy(std::move(on_destroy))\n+    {\n+    }\n+    virtual ~TestInterface()\n+    {\n+        if (m_on_destroy) m_on_destroy();\n+    }\n+    void BlockChecked(const CBlock& block, const BlockValidationState& state) override\n+    {\n+        if (m_on_call) m_on_call();\n+    }\n+    static void Call()\n+    {\n+        CBlock block;\n+        BlockValidationState state;\n+        GetMainSignals().BlockChecked(block, state);\n+    }\n+    std::function<void()> m_on_call;\n+    std::function<void()> m_on_destroy;\n+};\n+\n+// Regression test to ensure UnregisterAllValidationInterfaces calls don't\n+// destroy a validation interface while it is being called. Bug:\n+// https://github.com/bitcoin/bitcoin/pull/18551\n+BOOST_AUTO_TEST_CASE(unregister_all_during_call)\n+{\n+    bool destroyed = false;\n+\n+    CScheduler scheduler;\n+    GetMainSignals().RegisterBackgroundSignalScheduler(scheduler);\n+    RegisterSharedValidationInterface(std::make_shared<TestInterface>(\n+        [&] {\n+            // First call should decrements reference count 2 -> 1\n+            UnregisterAllValidationInterfaces();\n+            BOOST_CHECK(!destroyed);\n+            // Second call should not decrement reference count 1 -> 0\n+            UnregisterAllValidationInterfaces();\n+            BOOST_CHECK(!destroyed);\n+        },\n+        [&] { destroyed = true; }));\n+    TestInterface::Call();\n+    BOOST_CHECK(destroyed);\n+}\n+\n+BOOST_AUTO_TEST_SUITE_END()"
      }
    ]
  }
]