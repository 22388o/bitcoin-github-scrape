[
  {
    "sha": "c5a89196602e43ebb1cdc9cd4f08d153419c13e1",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjNWE4OTE5NjYwMmU0M2ViYjFjZGM5Y2Q0ZjA4ZDE1MzQxOWMxM2Ux",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2020-12-03T22:59:27Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2020-12-07T17:13:57Z"
      },
      "message": "Don't send 'sendaddrv2' to pre-70016 software",
      "tree": {
        "sha": "44dd6d98cc93ca25a56f27a461012008ef66d823",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/44dd6d98cc93ca25a56f27a461012008ef66d823"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c5a89196602e43ebb1cdc9cd4f08d153419c13e1",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c5a89196602e43ebb1cdc9cd4f08d153419c13e1",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c5a89196602e43ebb1cdc9cd4f08d153419c13e1",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c5a89196602e43ebb1cdc9cd4f08d153419c13e1/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "5c4911e7e7523fb7643da209254bbc2ef7898d2e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5c4911e7e7523fb7643da209254bbc2ef7898d2e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/5c4911e7e7523fb7643da209254bbc2ef7898d2e"
      }
    ],
    "stats": {
      "total": 8,
      "additions": 7,
      "deletions": 1
    },
    "files": [
      {
        "sha": "667c5fa5a3e02520145555bd5553f3132a49ad33",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 1,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c5a89196602e43ebb1cdc9cd4f08d153419c13e1/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c5a89196602e43ebb1cdc9cd4f08d153419c13e1/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=c5a89196602e43ebb1cdc9cd4f08d153419c13e1",
        "patch": "@@ -2365,7 +2365,13 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         m_connman.PushMessage(&pfrom, msg_maker.Make(NetMsgType::VERACK));\n \n         // Signal ADDRv2 support (BIP155).\n-        m_connman.PushMessage(&pfrom, msg_maker.Make(NetMsgType::SENDADDRV2));\n+        if (greatest_common_version >= 70016) {\n+            // BIP155 defines addrv2 and sendaddrv2 for all protocol versions, but some\n+            // implementations reject messages they don't know. As a courtesy, don't send\n+            // it to nodes with a version before 70016, as no software is known to support\n+            // BIP155 that doesn't announce at least that protocol version number.\n+            m_connman.PushMessage(&pfrom, msg_maker.Make(NetMsgType::SENDADDRV2));\n+        }\n \n         pfrom.nServices = nServices;\n         pfrom.SetAddrLocal(addrMe);"
      }
    ]
  },
  {
    "sha": "1583498fb6781c01ca2f33c09319ed793964c574",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxNTgzNDk4ZmI2NzgxYzAxY2EyZjMzYzA5MzE5ZWQ3OTM5NjRjNTc0",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2020-12-07T17:12:37Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter@wuille.net",
        "date": "2020-12-08T17:40:10Z"
      },
      "message": "Send and require SENDADDRV2 before VERACK\n\nSee the corresponding BIP change: https://github.com/bitcoin/bips/pull/1043",
      "tree": {
        "sha": "57683e6e79390368a173545f1b693467618c54d0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/57683e6e79390368a173545f1b693467618c54d0"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1583498fb6781c01ca2f33c09319ed793964c574",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1583498fb6781c01ca2f33c09319ed793964c574",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1583498fb6781c01ca2f33c09319ed793964c574",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1583498fb6781c01ca2f33c09319ed793964c574/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c5a89196602e43ebb1cdc9cd4f08d153419c13e1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c5a89196602e43ebb1cdc9cd4f08d153419c13e1",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c5a89196602e43ebb1cdc9cd4f08d153419c13e1"
      }
    ],
    "stats": {
      "total": 22,
      "additions": 14,
      "deletions": 8
    },
    "files": [
      {
        "sha": "287f9c186c9180b5c6962e143a6eaa68cb0dbf99",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 13,
        "deletions": 7,
        "changes": 20,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1583498fb6781c01ca2f33c09319ed793964c574/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1583498fb6781c01ca2f33c09319ed793964c574/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=1583498fb6781c01ca2f33c09319ed793964c574",
        "patch": "@@ -2362,8 +2362,6 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             m_connman.PushMessage(&pfrom, msg_maker.Make(NetMsgType::WTXIDRELAY));\n         }\n \n-        m_connman.PushMessage(&pfrom, msg_maker.Make(NetMsgType::VERACK));\n-\n         // Signal ADDRv2 support (BIP155).\n         if (greatest_common_version >= 70016) {\n             // BIP155 defines addrv2 and sendaddrv2 for all protocol versions, but some\n@@ -2373,6 +2371,8 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n             m_connman.PushMessage(&pfrom, msg_maker.Make(NetMsgType::SENDADDRV2));\n         }\n \n+        m_connman.PushMessage(&pfrom, msg_maker.Make(NetMsgType::VERACK));\n+\n         pfrom.nServices = nServices;\n         pfrom.SetAddrLocal(addrMe);\n         {\n@@ -2541,6 +2541,17 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n+    if (msg_type == NetMsgType::SENDADDRV2) {\n+        if (pfrom.fSuccessfullyConnected) {\n+            // Disconnect peers that send SENDADDRV2 message after VERACK; this\n+            // must be negotiated between VERSION and VERACK.\n+            pfrom.fDisconnect = true;\n+            return;\n+        }\n+        pfrom.m_wants_addrv2 = true;\n+        return;\n+    }\n+\n     if (!pfrom.fSuccessfullyConnected) {\n         LogPrint(BCLog::NET, \"Unsupported message \\\"%s\\\" prior to verack from peer=%d\\n\", SanitizeString(msg_type), pfrom.GetId());\n         return;\n@@ -2608,11 +2619,6 @@ void PeerManager::ProcessMessage(CNode& pfrom, const std::string& msg_type, CDat\n         return;\n     }\n \n-    if (msg_type == NetMsgType::SENDADDRV2) {\n-        pfrom.m_wants_addrv2 = true;\n-        return;\n-    }\n-\n     if (msg_type == NetMsgType::SENDHEADERS) {\n         LOCK(cs_main);\n         State(pfrom.GetId())->fPreferHeaders = true;"
      },
      {
        "sha": "8b79a4dc2ff9198c2dcfbe975f27b843bd96f1fb",
        "filename": "test/functional/test_framework/p2p.py",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1583498fb6781c01ca2f33c09319ed793964c574/test/functional/test_framework/p2p.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1583498fb6781c01ca2f33c09319ed793964c574/test/functional/test_framework/p2p.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_framework/p2p.py?ref=1583498fb6781c01ca2f33c09319ed793964c574",
        "patch": "@@ -396,9 +396,9 @@ def on_version(self, message):\n         assert message.nVersion >= MIN_VERSION_SUPPORTED, \"Version {} received. Test framework only supports versions greater than {}\".format(message.nVersion, MIN_VERSION_SUPPORTED)\n         if message.nVersion >= 70016:\n             self.send_message(msg_wtxidrelay())\n-        self.send_message(msg_verack())\n         if self.support_addrv2:\n             self.send_message(msg_sendaddrv2())\n+        self.send_message(msg_verack())\n         self.nServices = message.nServices\n \n     # Connection helper methods"
      }
    ]
  }
]