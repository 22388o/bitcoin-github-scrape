gmaxwell,2016-04-26T01:28:29Z,hmph. peppering cs_main in the middle of functions sounds like a formula for lock inversion.  Perhaps Misbehaving() should get its own lock internally and not depend on cs_main?\n,https://github.com/bitcoin/bitcoin/pull/7942#issuecomment-214580366,214580366,
kazcw,2016-04-26T05:24:35Z,"A separate nodestate cs is definitely doable; there's a fair amount of code that would need to hold cs_main and nodestate, but no new locks ever need to be acquired within the scope of a cs_nodestate lock. I'll draft a refactor.\n",https://github.com/bitcoin/bitcoin/pull/7942#issuecomment-214619395,214619395,
kazcw,2016-04-27T01:46:58Z,"I created a separate mutex, cs_misbehavior. cs_misbehavior is only locked either directly inside a cs_main lock or along with no other locks, so there shouldn't be any deadlocks (and DEBUG_LOCKORDER isn't complaining). cs_misbehavior is the sole mutex guarding the nMisbehavior and fShouldBan fields; modifications to the mapBlockSource container are guarded by both cs_main and cs_misbehavior so tha",https://github.com/bitcoin/bitcoin/pull/7942#issuecomment-214940851,214940851,
sipa,2016-06-02T14:41:46Z,"@kazcw I don't see your cs_misbehaviour, but I think the code here is fine as is. We certainly need a separate lock for node states, but I would delay that until the net refactors are done.\n",https://github.com/bitcoin/bitcoin/pull/7942#issuecomment-223313130,223313130,
sipa,2016-06-02T14:46:08Z,utACK 719de56ab2c8e5bc6ce9f67c7bf159adc242d49b\n,https://github.com/bitcoin/bitcoin/pull/7942#issuecomment-223314497,223314497,
dcousens,2016-06-02T15:03:14Z,"utACK 719de56,  and I concur that I do not see `cs_misbehavior`\n",https://github.com/bitcoin/bitcoin/pull/7942#issuecomment-223319845,223319845,
laanwj,2016-06-03T13:29:23Z,"utACK 719de56\nGoing to merge this, the nit can be done later.\n",https://github.com/bitcoin/bitcoin/pull/7942#issuecomment-223578717,223578717,
sipa,2016-05-17T06:52:18Z,You can use pindexNewTip->nHeight instead of creating an extra variable.\n,https://github.com/bitcoin/bitcoin/pull/7942#discussion_r63471821,63471821,src/main.cpp
jonasschnelli,2016-06-02T19:47:10Z,> You can use pindexNewTip->nHeight instead of creating an extra variable.\n\nping @kazcw \n,https://github.com/bitcoin/bitcoin/pull/7942#discussion_r65605904,65605904,src/main.cpp
