sipa,2020-10-13 03:11:13,"@kallewoof I agree that that would be the way to go if there was actually a feature change. There isn't. The serialization format was just gratuitously broken, and this reverts it.",https://github.com/bitcoin/bitcoin/pull/20140#issuecomment-707456444,707456444,
DrahtBot,2020-10-13 03:25:05,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19825 (rpc: simplify setban and consolidate BanMan functions by dhruv)\n\nIf you consider this pull request important, pl",https://github.com/bitcoin/bitcoin/pull/20140#issuecomment-707460726,707460726,
practicalswift,2020-10-13 09:20:29,Concept ACK,https://github.com/bitcoin/bitcoin/pull/20140#issuecomment-707612028,707612028,
sipa,2020-10-13 16:00:57,"@vasild Agree that there is no strong requirement to deal with files created/modified using unreleased code. But as it's perhaps a generally useful change (it guarantees that regardless of the file's contents, you'll never end up in a situation where there are entries in `listbanned` that cannot be remvoed using `setban`), perhaps it's useful to keep it in?",https://github.com/bitcoin/bitcoin/pull/20140#issuecomment-707842643,707842643,
vasild,2020-10-13 16:06:43,Yes!,https://github.com/bitcoin/bitcoin/pull/20140#issuecomment-707846535,707846535,
laanwj,2020-10-14 08:19:17,"Thanks for the quick fix!\nCode review ACK 886be97af5d4aba338b23a7b20b8560be8156231\n\n> Maybe we don't need to ignore the entries that have the IPv4 mask in the first 4 bytes (second commit) because this code was not released?\n\nI agree about this train of thought. I'm fine with keeping that sanity check if it also serves another purpose, but also understand the argument to not clutter the ",https://github.com/bitcoin/bitcoin/pull/20140#issuecomment-708241861,708241861,
gmaxwell,2020-10-14 19:11:19,"I would suggest that it assert on any wonky-mask, except then you'd create a crash for anyone that had bans from current git master.  You really don't want those in memory, esp if later the ban lookup is changed to a patricia trie they'll turn into memory corruption bugs (unless the author of that code remembers this possibility and inserts the sanitization there).\n\nPerhaps an alternative is t",https://github.com/bitcoin/bitcoin/pull/20140#issuecomment-708604695,708604695,
sipa,2020-10-14 19:13:16,"@gmaxwell This deletes the wonky-mask ones immediately after loading, FWIW. The deserializer constructs them as entries with valid=false, which are then immediately pruned.",https://github.com/bitcoin/bitcoin/pull/20140#issuecomment-708605739,708605739,
gmaxwell,2020-10-14 19:37:42,"sorry, I was intending to respond to @laanwj  who seemed to not like the deleting that much!",https://github.com/bitcoin/bitcoin/pull/20140#issuecomment-708617558,708617558,
sipa,2020-10-14 19:40:11,"Oh, I missed that.\n\n@laanwj I'm thinking that this sanity check should probably stay in the code. It isn't specific to the incompatbility here - any other damage to your banlist.dat file could also mean you end up with unremovable entries, so it seems like a generic improvement to protect against that.",https://github.com/bitcoin/bitcoin/pull/20140#issuecomment-708618755,708618755,
vasild,2020-10-15 07:37:31,"> stop storing masks and instead store prefix lengths, so that the insane values are just not representable\n\nJust to note that even if we store prefix lengths (CIDR), that would be stored in 1 byte and it is still possible to have insane values, e.g. 150.",https://github.com/bitcoin/bitcoin/pull/20140#issuecomment-708962391,708962391,
laanwj,2020-10-15 09:21:28,"It's good to ward against corrupted data files, especially relatively unimportant ones like the ban list, but at some point, disk is a trusted interface. There are tons of ways disk corruption can crash the daemon. And sometimes it should, so that users are aware of what is happening, making things easier to diagnose (weird behavior like undeletable bans is worse, but also impossible to avoid in g",https://github.com/bitcoin/bitcoin/pull/20140#issuecomment-709031654,709031654,
