[
  {
    "sha": "b4b1baf864bfe9443eb6f84603bed49c943b9077",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiNGIxYmFmODY0YmZlOTQ0M2ViNmY4NDYwM2JlZDQ5Yzk0M2I5MDc3",
    "commit": {
      "author": {
        "name": "Martin Ankerl",
        "email": "martin.ankerl@gmail.com",
        "date": "2019-10-05T19:43:19Z"
      },
      "committer": {
        "name": "Martin Ankerl",
        "email": "martin.ankerl@gmail.com",
        "date": "2019-10-05T20:39:02Z"
      },
      "message": "use boost test framework for benchmarks",
      "tree": {
        "sha": "d734b4b34ed0d9d8461e6afbb944632c944e8418",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d734b4b34ed0d9d8461e6afbb944632c944e8418"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b4b1baf864bfe9443eb6f84603bed49c943b9077",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b4b1baf864bfe9443eb6f84603bed49c943b9077",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b4b1baf864bfe9443eb6f84603bed49c943b9077",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b4b1baf864bfe9443eb6f84603bed49c943b9077/comments",
    "author": {
      "login": "martinus",
      "id": 14386,
      "node_id": "MDQ6VXNlcjE0Mzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/martinus",
      "html_url": "https://github.com/martinus",
      "followers_url": "https://api.github.com/users/martinus/followers",
      "following_url": "https://api.github.com/users/martinus/following{/other_user}",
      "gists_url": "https://api.github.com/users/martinus/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/martinus/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
      "organizations_url": "https://api.github.com/users/martinus/orgs",
      "repos_url": "https://api.github.com/users/martinus/repos",
      "events_url": "https://api.github.com/users/martinus/events{/privacy}",
      "received_events_url": "https://api.github.com/users/martinus/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "martinus",
      "id": 14386,
      "node_id": "MDQ6VXNlcjE0Mzg2",
      "avatar_url": "https://avatars.githubusercontent.com/u/14386?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/martinus",
      "html_url": "https://github.com/martinus",
      "followers_url": "https://api.github.com/users/martinus/followers",
      "following_url": "https://api.github.com/users/martinus/following{/other_user}",
      "gists_url": "https://api.github.com/users/martinus/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/martinus/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/martinus/subscriptions",
      "organizations_url": "https://api.github.com/users/martinus/orgs",
      "repos_url": "https://api.github.com/users/martinus/repos",
      "events_url": "https://api.github.com/users/martinus/events{/privacy}",
      "received_events_url": "https://api.github.com/users/martinus/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "7b701fef58f627956d597817a1f9422edd890cdc",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7b701fef58f627956d597817a1f9422edd890cdc",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/7b701fef58f627956d597817a1f9422edd890cdc"
      }
    ],
    "stats": {
      "total": 76,
      "additions": 76,
      "deletions": 0
    },
    "files": [
      {
        "sha": "47b94f1f388080a899bf93d649e2e39086eb636b",
        "filename": "src/Makefile.test.include",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b4b1baf864bfe9443eb6f84603bed49c943b9077/src/Makefile.test.include",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b4b1baf864bfe9443eb6f84603bed49c943b9077/src/Makefile.test.include",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/Makefile.test.include?ref=b4b1baf864bfe9443eb6f84603bed49c943b9077",
        "patch": "@@ -94,6 +94,7 @@ BITCOIN_TESTS =\\\n   test/blockfilter_tests.cpp \\\n   test/blockfilter_index_tests.cpp \\\n   test/bloom_tests.cpp \\\n+  test/boost_bench.h \\\n   test/bswap_tests.cpp \\\n   test/checkqueue_tests.cpp \\\n   test/coins_tests.cpp \\"
      },
      {
        "sha": "a3b21d9bb36e92a9539c02dfef162c4a4f02b644",
        "filename": "src/test/boost_bench.h",
        "status": "added",
        "additions": 53,
        "deletions": 0,
        "changes": 53,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b4b1baf864bfe9443eb6f84603bed49c943b9077/src/test/boost_bench.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b4b1baf864bfe9443eb6f84603bed49c943b9077/src/test/boost_bench.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/boost_bench.h?ref=b4b1baf864bfe9443eb6f84603bed49c943b9077",
        "patch": "@@ -0,0 +1,53 @@\n+// Copyright (c) 2019 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TEST_BOOST_BENCH_H\n+#define BITCOIN_TEST_BOOST_BENCH_H\n+\n+#include <chrono>\n+#include <iostream>\n+#include <string>\n+\n+#define BENCHMARK(testname) BOOST_AUTO_TEST_CASE(testname, *::boost::unit_test::label(\"benchmark\") * ::boost::unit_test::disabled())\n+\n+class Benchmark\n+{\n+    using Clock = std::chrono::high_resolution_clock;\n+\n+    std::string m_name;\n+    size_t m_batch{1};\n+    size_t m_iters{1};\n+\n+public:\n+    explicit Benchmark(std::string name)\n+        : m_name(std::move(name)) {}\n+\n+    Benchmark& Batch(size_t batch)\n+    {\n+        m_batch = batch;\n+        return *this;\n+    }\n+\n+    Benchmark& Iters(size_t iters)\n+    {\n+        m_iters = iters;\n+        return *this;\n+    }\n+\n+    template <typename Op>\n+    void Run(Op op) const\n+    {\n+        size_t n = m_iters;\n+        auto before = Clock::now();\n+        while (n > 0) {\n+            op();\n+            --n;\n+        }\n+        auto after = Clock::now();\n+        auto elapsed = std::chrono::duration_cast<std::chrono::duration<double>>(after - before).count();\n+        std::cout << (1e9 * elapsed / (m_batch * m_iters)) << \" ns for \" << m_name << \" (\" << elapsed << \" s total)\" << std::endl;\n+    }\n+};\n+\n+#endif"
      },
      {
        "sha": "fa35385e9f7e11e3e3412779cf4ea1dcaf49d07b",
        "filename": "src/test/prevector_tests.cpp",
        "status": "modified",
        "additions": 22,
        "deletions": 0,
        "changes": 22,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b4b1baf864bfe9443eb6f84603bed49c943b9077/src/test/prevector_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b4b1baf864bfe9443eb6f84603bed49c943b9077/src/test/prevector_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/prevector_tests.cpp?ref=b4b1baf864bfe9443eb6f84603bed49c943b9077",
        "patch": "@@ -13,6 +13,8 @@\n \n #include <boost/test/unit_test.hpp>\n \n+#include <test/boost_bench.h>\n+\n BOOST_FIXTURE_TEST_SUITE(prevector_tests, TestingSetup)\n \n template<unsigned int N, typename T>\n@@ -292,4 +294,24 @@ BOOST_AUTO_TEST_CASE(PrevectorTestInt)\n     }\n }\n \n+// This is just a boost test with the label \"benchmark\", and defaults to disabled.\n+BENCHMARK(prevector_resize)\n+{\n+    // Run a benchmark called \"resize\", where each iteration consists of a batch of 1000*4 operations.\n+    // Perform a total of 20000 iterations. Once the loop has finish, show timing results.\n+    Benchmark(\"resize\").Batch(1000 * 4).Iters(20000).Run([] {\n+        prevector<28, int> t0;\n+        prevector<28, int> t1;\n+        for (auto x = 0; x < 1000; ++x) {\n+            t0.resize(28);\n+            t0.resize(0);\n+            t1.resize(29);\n+            t1.resize(0);\n+        }\n+    });\n+\n+    // When the loop has finished, it prints the benchmark results, something like this:\n+    // 4.35599 ns for resize (0.348479 s total)\n+}\n+\n BOOST_AUTO_TEST_SUITE_END()"
      }
    ]
  }
]