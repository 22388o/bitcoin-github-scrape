[
  {
    "sha": "fddc9000659ae15d4ce2639ececa9b651c200b2e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmZGRjOTAwMDY1OWFlMTVkNGNlMjYzOWVjZWNhOWI2NTFjMjAwYjJl",
    "commit": {
      "author": {
        "name": "Larry Ruane",
        "email": "larryruane@gmail.com",
        "date": "2021-08-13T21:53:39Z"
      },
      "committer": {
        "name": "Larry Ruane",
        "email": "larryruane@gmail.com",
        "date": "2021-08-13T21:53:39Z"
      },
      "message": "add FormatISO8601DateTimeBasic()\n\nSee https://en.wikipedia.org/wiki/ISO_8601#Times\nThis is needed because log file rotation filenames are constructed using\nthis \"basic\" format, because it has no \":\" (colon) characters, which\nWindows does not allow.",
      "tree": {
        "sha": "7e89c177ef6bb924b215bfa8604fd05899a88a7c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7e89c177ef6bb924b215bfa8604fd05899a88a7c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fddc9000659ae15d4ce2639ececa9b651c200b2e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fddc9000659ae15d4ce2639ececa9b651c200b2e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/fddc9000659ae15d4ce2639ececa9b651c200b2e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fddc9000659ae15d4ce2639ececa9b651c200b2e/comments",
    "author": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "3e306ee1d5c79eda64eb991fb2696bf530f0b30d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3e306ee1d5c79eda64eb991fb2696bf530f0b30d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/3e306ee1d5c79eda64eb991fb2696bf530f0b30d"
      }
    ],
    "stats": {
      "total": 14,
      "additions": 14,
      "deletions": 0
    },
    "files": [
      {
        "sha": "631e7e403572b9e25b9be27b774329fef3dca30a",
        "filename": "src/util/time.cpp",
        "status": "modified",
        "additions": 13,
        "deletions": 0,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fddc9000659ae15d4ce2639ececa9b651c200b2e/src/util/time.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fddc9000659ae15d4ce2639ececa9b651c200b2e/src/util/time.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/time.cpp?ref=fddc9000659ae15d4ce2639ececa9b651c200b2e",
        "patch": "@@ -142,6 +142,19 @@ std::string FormatISO8601DateTime(int64_t nTime) {\n     return strprintf(\"%04i-%02i-%02iT%02i:%02i:%02iZ\", ts.tm_year + 1900, ts.tm_mon + 1, ts.tm_mday, ts.tm_hour, ts.tm_min, ts.tm_sec);\n }\n \n+std::string FormatISO8601DateTimeBasic(int64_t nTime) {\n+    struct tm ts;\n+    time_t time_val = nTime;\n+#ifdef HAVE_GMTIME_R\n+    if (gmtime_r(&time_val, &ts) == nullptr) {\n+#else\n+    if (gmtime_s(&ts, &time_val) != 0) {\n+#endif\n+        return {};\n+    }\n+    return strprintf(\"%04i-%02i-%02iT%02i%02i%02iZ\", ts.tm_year + 1900, ts.tm_mon + 1, ts.tm_mday, ts.tm_hour, ts.tm_min, ts.tm_sec);\n+}\n+\n std::string FormatISO8601Date(int64_t nTime) {\n     struct tm ts;\n     time_t time_val = nTime;"
      },
      {
        "sha": "9a4d34771cd8ff45f6fa4bf4e13f82d7fdf75e46",
        "filename": "src/util/time.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fddc9000659ae15d4ce2639ececa9b651c200b2e/src/util/time.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fddc9000659ae15d4ce2639ececa9b651c200b2e/src/util/time.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/time.h?ref=fddc9000659ae15d4ce2639ececa9b651c200b2e",
        "patch": "@@ -73,6 +73,7 @@ T GetTime();\n  * helper functions if possible.\n  */\n std::string FormatISO8601DateTime(int64_t nTime);\n+std::string FormatISO8601DateTimeBasic(int64_t nTime);\n std::string FormatISO8601Date(int64_t nTime);\n int64_t ParseISO8601DateTime(const std::string& str);\n "
      }
    ]
  },
  {
    "sha": "4f510dc1938dec405955292ccf54cc0cb75b8057",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0ZjUxMGRjMTkzOGRlYzQwNTk1NTI5MmNjZjU0Y2MwY2I3NWI4MDU3",
    "commit": {
      "author": {
        "name": "Larry Ruane",
        "email": "larryruane@gmail.com",
        "date": "2021-08-13T22:10:12Z"
      },
      "committer": {
        "name": "Larry Ruane",
        "email": "larryruane@gmail.com",
        "date": "2021-08-13T23:04:24Z"
      },
      "message": "Logger::StartLogging() returns an error string instead of bool\n\nNo functional change.",
      "tree": {
        "sha": "7c32ac0aa6853f9a3407dd473b23af1cad3953d9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7c32ac0aa6853f9a3407dd473b23af1cad3953d9"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4f510dc1938dec405955292ccf54cc0cb75b8057",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4f510dc1938dec405955292ccf54cc0cb75b8057",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/4f510dc1938dec405955292ccf54cc0cb75b8057",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4f510dc1938dec405955292ccf54cc0cb75b8057/comments",
    "author": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "fddc9000659ae15d4ce2639ececa9b651c200b2e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fddc9000659ae15d4ce2639ececa9b651c200b2e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/fddc9000659ae15d4ce2639ececa9b651c200b2e"
      }
    ],
    "stats": {
      "total": 18,
      "additions": 10,
      "deletions": 8
    },
    "files": [
      {
        "sha": "f2045e2594692ccf731dc6c8ee65412386920341",
        "filename": "src/init/common.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 3,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4f510dc1938dec405955292ccf54cc0cb75b8057/src/init/common.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4f510dc1938dec405955292ccf54cc0cb75b8057/src/init/common.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init/common.cpp?ref=4f510dc1938dec405955292ccf54cc0cb75b8057",
        "patch": "@@ -126,9 +126,11 @@ bool StartLogging(const ArgsManager& args)\n             LogInstance().ShrinkDebugFile();\n         }\n     }\n-    if (!LogInstance().StartLogging()) {\n-            return InitError(strprintf(Untranslated(\"Could not open debug log file %s\"),\n-                LogInstance().m_file_path.string()));\n+    {\n+        const std::string err_msg = LogInstance().StartLogging();\n+        if (!err_msg.empty()) {\n+            return InitError(Untranslated(err_msg));\n+        }\n     }\n \n     if (!LogInstance().m_log_timestamps)"
      },
      {
        "sha": "da8cd5516abf0d5fb2a2206a5a705a3fed1c2356",
        "filename": "src/logging.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4f510dc1938dec405955292ccf54cc0cb75b8057/src/logging.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4f510dc1938dec405955292ccf54cc0cb75b8057/src/logging.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/logging.cpp?ref=4f510dc1938dec405955292ccf54cc0cb75b8057",
        "patch": "@@ -40,7 +40,7 @@ static int FileWriteStr(const std::string &str, FILE *fp)\n     return fwrite(str.data(), 1, str.size(), fp);\n }\n \n-bool BCLog::Logger::StartLogging()\n+std::string BCLog::Logger::StartLogging()\n {\n     StdLockGuard scoped_lock(m_cs);\n \n@@ -51,7 +51,7 @@ bool BCLog::Logger::StartLogging()\n         assert(!m_file_path.empty());\n         m_fileout = fsbridge::fopen(m_file_path, \"a\");\n         if (!m_fileout) {\n-            return false;\n+            return strprintf(\"Could not open debug log file %s\", m_file_path.string());\n         }\n \n         setbuf(m_fileout, nullptr); // unbuffered\n@@ -76,7 +76,7 @@ bool BCLog::Logger::StartLogging()\n     }\n     if (m_print_to_console) fflush(stdout);\n \n-    return true;\n+    return {};\n }\n \n void BCLog::Logger::DisconnectTestLogger()"
      },
      {
        "sha": "2f376b20ab0d2dda3ee996bc31ff762e02ffa204",
        "filename": "src/logging.h",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4f510dc1938dec405955292ccf54cc0cb75b8057/src/logging.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4f510dc1938dec405955292ccf54cc0cb75b8057/src/logging.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/logging.h?ref=4f510dc1938dec405955292ccf54cc0cb75b8057",
        "patch": "@@ -123,8 +123,8 @@ namespace BCLog {\n             m_print_callbacks.erase(it);\n         }\n \n-        /** Start logging (and flush all buffered messages) */\n-        bool StartLogging();\n+        /** Start logging (and flush all buffered messages), return error string (empty if none) */\n+        std::string StartLogging();\n         /** Only for testing */\n         void DisconnectTestLogger();\n "
      }
    ]
  },
  {
    "sha": "9fb0529a9a0fbf2a4555a511b4dadb36a045678a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5ZmIwNTI5YTlhMGZiZjJhNDU1NWE1MTFiNGRhZGIzNmEwNDU2Nzhh",
    "commit": {
      "author": {
        "name": "Larry Ruane",
        "email": "larryruane@gmail.com",
        "date": "2021-08-13T22:23:34Z"
      },
      "committer": {
        "name": "Larry Ruane",
        "email": "larryruane@gmail.com",
        "date": "2021-08-13T23:05:06Z"
      },
      "message": "add log file rotation configuration arguments\n\n-debuglogrotatekeep: number of rotated log files to keep\n-debugloglimit: debug.log size (in MB) before it is rotated\n\nThe default -debuglogrotatekeep value is 0, which disables rotation.",
      "tree": {
        "sha": "4f17fa791c5859779cd7432b117201a1a9b1c7c2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4f17fa791c5859779cd7432b117201a1a9b1c7c2"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9fb0529a9a0fbf2a4555a511b4dadb36a045678a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9fb0529a9a0fbf2a4555a511b4dadb36a045678a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/9fb0529a9a0fbf2a4555a511b4dadb36a045678a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9fb0529a9a0fbf2a4555a511b4dadb36a045678a/comments",
    "author": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "4f510dc1938dec405955292ccf54cc0cb75b8057",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4f510dc1938dec405955292ccf54cc0cb75b8057",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/4f510dc1938dec405955292ccf54cc0cb75b8057"
      }
    ],
    "stats": {
      "total": 10,
      "additions": 10,
      "deletions": 0
    },
    "files": [
      {
        "sha": "4854f54bbddb882d1a327f72a86cc975b0d58932",
        "filename": "src/init/common.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9fb0529a9a0fbf2a4555a511b4dadb36a045678a/src/init/common.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9fb0529a9a0fbf2a4555a511b4dadb36a045678a/src/init/common.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init/common.cpp?ref=9fb0529a9a0fbf2a4555a511b4dadb36a045678a",
        "patch": "@@ -61,6 +61,8 @@ bool SanityChecks()\n void AddLoggingArgs(ArgsManager& argsman)\n {\n     argsman.AddArg(\"-debuglogfile=<file>\", strprintf(\"Specify location of debug log file. Relative paths will be prefixed by a net-specific datadir location. (-nodebuglogfile to disable; default: %s)\", DEFAULT_DEBUGLOGFILE), ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-debuglogrotatekeep=count\", strprintf(\"The number of rotated (old) debug log files (0 to disable; default: %d)\", DEFAULT_DEBUGLOG_ROTATE_KEEP), ArgsManager::ALLOW_INT, OptionsCategory::OPTIONS);\n+    argsman.AddArg(\"-debugloglimit=size\", strprintf(\"The (approximate) size (integer MB) debug log reaches before log rotation; default: %d)\", DEFAULT_DEBUGLOG_SIZE_LIMIT_MB), ArgsManager::ALLOW_INT, OptionsCategory::OPTIONS);\n     argsman.AddArg(\"-debug=<category>\", \"Output debugging information (default: -nodebug, supplying <category> is optional). \"\n         \"If <category> is not supplied or if <category> = 1, output all debugging information. <category> can be: \" + LogInstance().LogCategoriesString() + \". This option can be specified multiple times to output multiple categories.\",\n         ArgsManager::ALLOW_ANY, OptionsCategory::DEBUG_TEST);\n@@ -89,6 +91,8 @@ void SetLoggingOptions(const ArgsManager& args)\n     LogInstance().m_log_threadnames = args.GetBoolArg(\"-logthreadnames\", DEFAULT_LOGTHREADNAMES);\n #endif\n     LogInstance().m_log_sourcelocations = args.GetBoolArg(\"-logsourcelocations\", DEFAULT_LOGSOURCELOCATIONS);\n+    LogInstance().m_rotate_keep = args.GetArg(\"-debuglogrotatekeep\", DEFAULT_DEBUGLOG_ROTATE_KEEP);\n+    LogInstance().m_file_size_limit = args.GetArg(\"-debugloglimit\", DEFAULT_DEBUGLOG_SIZE_LIMIT_MB);\n \n     fLogIPs = args.GetBoolArg(\"-logips\", DEFAULT_LOGIPS);\n }"
      },
      {
        "sha": "6bc7e9b800410acf15b4f61c32a0928f1019f4d1",
        "filename": "src/logging.h",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9fb0529a9a0fbf2a4555a511b4dadb36a045678a/src/logging.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9fb0529a9a0fbf2a4555a511b4dadb36a045678a/src/logging.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/logging.h?ref=9fb0529a9a0fbf2a4555a511b4dadb36a045678a",
        "patch": "@@ -24,6 +24,8 @@ static const bool DEFAULT_LOGTIMESTAMPS = true;\n static const bool DEFAULT_LOGTHREADNAMES = false;\n static const bool DEFAULT_LOGSOURCELOCATIONS = false;\n extern const char * const DEFAULT_DEBUGLOGFILE;\n+static const int DEFAULT_DEBUGLOG_ROTATE_KEEP = 0; // log file rotation must be explicitly enabled\n+static const int DEFAULT_DEBUGLOG_SIZE_LIMIT_MB = 10;\n \n extern bool fLogIPs;\n \n@@ -96,6 +98,10 @@ namespace BCLog {\n         bool m_log_sourcelocations = DEFAULT_LOGSOURCELOCATIONS;\n \n         fs::path m_file_path;\n+        /** debug.log file size before being rotated (units are MB) */\n+        int m_file_size_limit;\n+        /** The number of old (rotated) debug.log files to retain */\n+        int m_rotate_keep;\n         std::atomic<bool> m_reopen_file{false};\n \n         /** Send a string to the log output */"
      }
    ]
  },
  {
    "sha": "1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxZmQ5ZGUxNjkyMmUwYTA2ZTllZTQ4OTBlY2ZkYmI1YzFjY2M2NTdl",
    "commit": {
      "author": {
        "name": "Larry Ruane",
        "email": "larryruane@gmail.com",
        "date": "2021-08-13T22:53:41Z"
      },
      "committer": {
        "name": "Larry Ruane",
        "email": "larryruane@gmail.com",
        "date": "2021-08-16T05:08:37Z"
      },
      "message": "Implement debug.log file rotation\n\nNo functional change by default. Add support for log file rotation.\nIf enabled, then when the debug.log file reaches a certain size\n(default, 10MB), rename it to a file within a separate directory,\ndebug-rotate, named according to the current date and time, and\nrestart (truncate) debug.log. This keeps debug.log from growing\nunbounded. Retain a limited number of rotated files.",
      "tree": {
        "sha": "16ff6f90ad1a15a2de3428901da0f43a439a8002",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/16ff6f90ad1a15a2de3428901da0f43a439a8002"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e/comments",
    "author": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "9fb0529a9a0fbf2a4555a511b4dadb36a045678a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9fb0529a9a0fbf2a4555a511b4dadb36a045678a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/9fb0529a9a0fbf2a4555a511b4dadb36a045678a"
      }
    ],
    "stats": {
      "total": 135,
      "additions": 132,
      "deletions": 3
    },
    "files": [
      {
        "sha": "8e17b2cd51816854e713f0b9a8f3f39d5aa86662",
        "filename": "src/logging.cpp",
        "status": "modified",
        "additions": 92,
        "deletions": 3,
        "changes": 95,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e/src/logging.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e/src/logging.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/logging.cpp?ref=1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e",
        "patch": "@@ -12,6 +12,9 @@\n \n const char * const DEFAULT_DEBUGLOGFILE = \"debug.log\";\n \n+/** This directory will be in the same directory as the debug.log file. */\n+constexpr char DEBUG_ROTATED_DIR[] = \"debug-rotated\";\n+\n BCLog::Logger& LogInstance()\n {\n /**\n@@ -54,6 +57,29 @@ std::string BCLog::Logger::StartLogging()\n             return strprintf(\"Could not open debug log file %s\", m_file_path.string());\n         }\n \n+        // Special files (e.g. device nodes) may not have a size.\n+        m_file_size = 0;\n+        try {\n+            m_file_size = fs::file_size(m_file_path);\n+        } catch (const fs::filesystem_error& e) {\n+            // We can't do log rotation if it's not a regular file.\n+            if (m_rotate_keep > 0) {\n+                return strprintf(\n+                    \"The debug log file %s does not appear to be a regular file; \"\n+                    \"this prevents log rotation, error: %s\",\n+                    m_file_path.string(), e.what());\n+            }\n+        }\n+        if (m_rotate_keep > 0) {\n+            if (m_file_size_limit <= 0) {\n+                return strprintf(\n+                    \"The debug log file %s size limit in MB must be greater than zero.\",\n+                    m_file_path.string());\n+            }\n+            std::string err = StartRotate();\n+            if (!err.empty()) return err;\n+        }\n+\n         setbuf(m_fileout, nullptr); // unbuffered\n \n         // Add newlines to the logfile to distinguish this execution from the\n@@ -79,6 +105,36 @@ std::string BCLog::Logger::StartLogging()\n     return {};\n }\n \n+std::string BCLog::Logger::StartRotate()\n+{\n+    m_rotated_dir = m_file_path.parent_path() / DEBUG_ROTATED_DIR;\n+    try {\n+        fs::create_directories(m_rotated_dir);\n+    } catch (const fs::filesystem_error& e) {\n+        return strprintf(\"Could not create rotated debug file directory %s: %s\", m_rotated_dir.string(), e.what());\n+    }\n+    for (fs::directory_iterator it(m_rotated_dir); it != fs::directory_iterator(); ++it) {\n+        m_rotated_files.push_back(it->path());\n+    }\n+    std::sort(m_rotated_files.begin(), m_rotated_files.end());\n+\n+    // There may be extra rotation files if the m_rotate_keep config decreased.\n+    RemoveRotated();\n+    return {};\n+}\n+\n+// Remove the oldest rotated files if there are too many.\n+void BCLog::Logger::RemoveRotated()\n+{\n+    while (static_cast<int>(m_rotated_files.size()) > m_rotate_keep) {\n+        try {\n+            fs::remove(m_rotated_files.front());\n+        } catch (const fs::filesystem_error&) {\n+        }\n+        m_rotated_files.pop_front();\n+    }\n+}\n+\n void BCLog::Logger::DisconnectTestLogger()\n {\n     StdLockGuard scoped_lock(m_cs);\n@@ -270,9 +326,7 @@ void BCLog::Logger::LogPrintStr(const std::string& str, const std::string& loggi\n     for (const auto& cb : m_print_callbacks) {\n         cb(str_prefixed);\n     }\n-    if (m_print_to_file) {\n-        assert(m_fileout != nullptr);\n-\n+    if (m_print_to_file && m_fileout) {\n         // reopen the log file, if requested\n         if (m_reopen_file) {\n             m_reopen_file = false;\n@@ -284,11 +338,46 @@ void BCLog::Logger::LogPrintStr(const std::string& str, const std::string& loggi\n             }\n         }\n         FileWriteStr(str_prefixed, m_fileout);\n+        m_file_size += str_prefixed.size();\n+\n+        // If debug.log is large, rotate it (rename and recreate).\n+        if (m_rotate_keep > 0 && m_file_size > m_file_size_limit * 1e6 && m_started_new_line) {\n+            // Rename debug.log to a name like debug-2021-06-25T22:57:54.log\n+            int64_t now = GetTimeSeconds();\n+            // Don't rotate within the same second to avoid name conflict.\n+            if (m_last_rotate_time < now) {\n+                m_last_rotate_time = now;\n+\n+                // Close the existing debug.log (rename may require this)\n+                fclose(m_fileout);\n+                m_fileout = nullptr;\n+\n+                // Rename debug.log to debug-rotated/<date-time>\n+                fs::path rotated_file_path = m_rotated_dir / FormatISO8601DateTimeBasic(now);\n+                try {\n+                    fs::rename(m_file_path, rotated_file_path);\n+                } catch (const fs::filesystem_error&) {\n+                }\n+                m_rotated_files.push_back(rotated_file_path);\n+                RemoveRotated();\n+\n+                // Create a new debug.log file\n+                FILE* new_fileout = fsbridge::fopen(m_file_path, \"a\");\n+                if (new_fileout) {\n+                    setbuf(new_fileout, nullptr); // unbuffered\n+                    m_fileout = new_fileout;\n+                }\n+                m_file_size = 0;\n+            }\n+        }\n     }\n }\n \n void BCLog::Logger::ShrinkDebugFile()\n {\n+    // File rotation makes this unnecessary.\n+    if (m_rotate_keep > 0) return;\n+\n     // Amount of debug.log to save at end when shrinking (must fit in memory)\n     constexpr size_t RECENT_DEBUG_HISTORY_SIZE = 10 * 1000000;\n "
      },
      {
        "sha": "9879c69b568134195fd603cd1d9118b51e29f5af",
        "filename": "src/logging.h",
        "status": "modified",
        "additions": 15,
        "deletions": 0,
        "changes": 15,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e/src/logging.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e/src/logging.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/logging.h?ref=1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e",
        "patch": "@@ -13,6 +13,7 @@\n \n #include <atomic>\n #include <cstdint>\n+#include <deque>\n #include <list>\n #include <mutex>\n #include <string>\n@@ -73,6 +74,15 @@ namespace BCLog {\n         std::list<std::string> m_msgs_before_open GUARDED_BY(m_cs);\n         bool m_buffering GUARDED_BY(m_cs) = true; //!< Buffer messages before logging can be started.\n \n+        /** Current debug.log file size (bytes) */\n+        size_t m_file_size GUARDED_BY(m_cs);\n+        /** The list of rotated debug.log files, oldest at the front */\n+        std::deque<fs::path> m_rotated_files GUARDED_BY(m_cs);\n+        /** The time (seconds) of the most recent log rotation */\n+        int64_t m_last_rotate_time GUARDED_BY(m_cs){0};\n+        /** The directory path where rotated log files are stored */\n+        fs::path m_rotated_dir;\n+\n         /**\n          * m_started_new_line is a state variable that will suppress printing of\n          * the timestamp when multiple calls are made that don't end in a\n@@ -131,6 +141,11 @@ namespace BCLog {\n \n         /** Start logging (and flush all buffered messages), return error string (empty if none) */\n         std::string StartLogging();\n+        /** Initialize debug.log rotation */\n+        std::string StartRotate() EXCLUSIVE_LOCKS_REQUIRED(m_cs);\n+        /** Remove (delete) excess debug.log rotation files */\n+        void RemoveRotated() EXCLUSIVE_LOCKS_REQUIRED(m_cs);\n+\n         /** Only for testing */\n         void DisconnectTestLogger();\n "
      },
      {
        "sha": "9f64a7a4b72cc9f9c4fa008919a24e324c8549c1",
        "filename": "test/functional/feature_logging.py",
        "status": "modified",
        "additions": 25,
        "deletions": 0,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e/test/functional/feature_logging.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e/test/functional/feature_logging.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/feature_logging.py?ref=1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e",
        "patch": "@@ -8,6 +8,7 @@\n \n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.test_node import ErrorMatch\n+from test_framework.util import assert_equal\n \n \n class LoggingTest(BitcoinTestFramework):\n@@ -69,6 +70,30 @@ def run_test(self):\n         # just sanity check no crash here\n         self.restart_node(0, [\"-debuglogfile=%s\" % os.devnull])\n \n+        # debug log file rotation\n+        self.log.info(\"Log file rotation\")\n+        self.stop_node(0)\n+        self.start_node(0, [\"-debuglogfile=altname-debug.log\", \"-debuglogrotatekeep=2\", \"-debugloglimit=1\"])\n+        self.log.info(\"Generating many log messages\")\n+        # Each getblockcount RPC logs 251 bytes, so 13k of them generates\n+        # more than 3 MB of logging, which will test that one of the\n+        # rotated log files gets deleted.\n+        for _ in range(13000):\n+            self.nodes[0].getblockcount()\n+        n_debugfiles = 0\n+        with os.scandir(os.path.join(self.nodes[0].datadir, 'regtest', 'debug-rotated')) as it:\n+            for entry in it:\n+                # rotated log files' names should be like 2021-07-09T014959Z\n+                assert len(entry.name) == len(\"2021-07-09T014959Z\")\n+                assert_equal(entry.name[10], 'T')\n+                assert_equal(entry.name[17], 'Z')\n+                # rotated files should have sizes slightly more than 1 MB\n+                assert entry.stat().st_size > 1000000\n+                assert entry.stat().st_size < int(1000000 * 1.01)\n+                n_debugfiles += 1\n+        # There should be and two rotated files\n+        assert_equal(n_debugfiles, 2)\n+\n \n if __name__ == '__main__':\n     LoggingTest().main()"
      }
    ]
  },
  {
    "sha": "13511cec51599fc5c95c6ececef0345aea6e6fcc",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxMzUxMWNlYzUxNTk5ZmM1Yzk1YzZlY2VjZWYwMzQ1YWVhNmU2ZmNj",
    "commit": {
      "author": {
        "name": "Larry Ruane",
        "email": "larryruane@gmail.com",
        "date": "2021-08-13T23:36:13Z"
      },
      "committer": {
        "name": "Larry Ruane",
        "email": "larryruane@gmail.com",
        "date": "2021-08-16T05:09:19Z"
      },
      "message": "add release note",
      "tree": {
        "sha": "0876d9936ddb7077f22fa2a6698768524f83c4a3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0876d9936ddb7077f22fa2a6698768524f83c4a3"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/13511cec51599fc5c95c6ececef0345aea6e6fcc",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/13511cec51599fc5c95c6ececef0345aea6e6fcc",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/13511cec51599fc5c95c6ececef0345aea6e6fcc",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/13511cec51599fc5c95c6ececef0345aea6e6fcc/comments",
    "author": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1fd9de16922e0a06e9ee4890ecfdbb5c1ccc657e"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 5,
      "deletions": 0
    },
    "files": [
      {
        "sha": "6dcdc804b02167363190038359e0f84c707751b1",
        "filename": "doc/release-notes-22350.md",
        "status": "added",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/13511cec51599fc5c95c6ececef0345aea6e6fcc/doc/release-notes-22350.md",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/13511cec51599fc5c95c6ececef0345aea6e6fcc/doc/release-notes-22350.md",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/doc/release-notes-22350.md?ref=13511cec51599fc5c95c6ececef0345aea6e6fcc",
        "patch": "@@ -0,0 +1,5 @@\n+New settings\n+------------\n+\n+- Add the option to rotate the `debug.log` file so it doesn't\n+  grow without limit, consuming too much local disk space. (#22350)"
      }
    ]
  }
]