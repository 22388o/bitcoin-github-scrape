[
  {
    "sha": "7d341f0f8eaa0febc56919b872833cbddb4d37b2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3ZDM0MWYwZjhlYWEwZmViYzU2OTE5Yjg3MjgzM2NiZGRiNGQzN2Iy",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-07-20T11:12:43Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-07-20T11:13:30Z"
      },
      "message": "Improve handling of obscure reorganizations\n\nThis fixes some weird reorganization issues that probably don't normally\noccur, but can be triggered when blacklisting arbitrary blocks is enabled.",
      "tree": {
        "sha": "72231ccaac5818d5d0fe03dc57977e2e3aedd936",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/72231ccaac5818d5d0fe03dc57977e2e3aedd936"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7d341f0f8eaa0febc56919b872833cbddb4d37b2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7d341f0f8eaa0febc56919b872833cbddb4d37b2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/7d341f0f8eaa0febc56919b872833cbddb4d37b2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7d341f0f8eaa0febc56919b872833cbddb4d37b2/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "4eab2dcc8158860d2575bb26ee46c29bd0672968",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4eab2dcc8158860d2575bb26ee46c29bd0672968",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/4eab2dcc8158860d2575bb26ee46c29bd0672968"
      }
    ],
    "stats": {
      "total": 21,
      "additions": 18,
      "deletions": 3
    },
    "files": [
      {
        "sha": "5e31d4b3197400acd6d3c7ccd5570fbb9b2b96f0",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 16,
        "deletions": 3,
        "changes": 19,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7d341f0f8eaa0febc56919b872833cbddb4d37b2/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7d341f0f8eaa0febc56919b872833cbddb4d37b2/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=7d341f0f8eaa0febc56919b872833cbddb4d37b2",
        "patch": "@@ -1402,12 +1402,21 @@ void static InvalidChainFound(CBlockIndex* pindexNew)\n         printf(\"InvalidChainFound: Warning: Displayed transactions may not be correct! You may need to upgrade, or other nodes may need to upgrade.\\n\");\n }\n \n-void static InvalidBlockFound(CBlockIndex *pindex) {\n+void InvalidBlockFound(CBlockIndex *pindex) {\n     pindex->nStatus |= BLOCK_FAILED_VALID;\n     pblocktree->WriteBlockIndex(CDiskBlockIndex(pindex));\n     setBlockIndexValid.erase(pindex);\n     InvalidChainFound(pindex);\n+    CBlockIndex *pindexWalk = pindex;\n+    do {\n+        CBlockIndex *pindexNext = pindexWalk->GetNextInMainChain();\n+        if (!pindexNext) break;\n+        pindexWalk = pindexNext;\n+        pindexWalk->nStatus |= BLOCK_FAILED_CHILD;\n+        printf(\"Marked %s as descending from invalid\\n\", pindexWalk->GetBlockHash().ToString().c_str());\n+    } while(true);\n     if (pindex->GetNextInMainChain()) {\n+        setBlockIndexValid.insert(pindex->pprev);\n         CValidationState stateDummy;\n         ConnectBestBlock(stateDummy); // reorganise away from the failed block\n     }\n@@ -1419,12 +1428,16 @@ bool ConnectBestBlock(CValidationState &state) {\n \n         {\n             std::set<CBlockIndex*,CBlockIndexWorkComparator>::reverse_iterator it = setBlockIndexValid.rbegin();\n+            while (it != setBlockIndexValid.rend() && (*it)->nStatus & BLOCK_FAILED_MASK) {\n+                printf(\"Not considering failed %s (%i)\\n\", (*it)->GetBlockHash().ToString().c_str(), (*it)->nHeight);\n+                it++;\n+            }\n             if (it == setBlockIndexValid.rend())\n                 return true;\n             pindexNewBest = *it;\n         }\n \n-        if (pindexNewBest == pindexBest || (pindexBest && pindexNewBest->nChainWork == pindexBest->nChainWork))\n+        if ((pindexNewBest == pindexBest || (pindexBest && pindexNewBest->nChainWork == pindexBest->nChainWork)) && !(pindexBest->nStatus & BLOCK_FAILED_MASK))\n             return true; // nothing to do\n \n         // check ancestry\n@@ -1444,7 +1457,7 @@ bool ConnectBestBlock(CValidationState &state) {\n                 break;\n             }\n \n-            if (pindexBest == NULL || pindexTest->nChainWork > pindexBest->nChainWork)\n+            if (pindexBest == NULL || pindexTest->nChainWork > pindexBest->nChainWork || (pindexBest->nStatus & BLOCK_FAILED_MASK))\n                 vAttach.push_back(pindexTest);\n \n             if (pindexTest->pprev == NULL || pindexTest->GetNextInMainChain()) {"
      },
      {
        "sha": "54deffb30f825a659fbfc42ad5bdff227a455a6d",
        "filename": "src/main.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7d341f0f8eaa0febc56919b872833cbddb4d37b2/src/main.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7d341f0f8eaa0febc56919b872833cbddb4d37b2/src/main.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.h?ref=7d341f0f8eaa0febc56919b872833cbddb4d37b2",
        "patch": "@@ -194,6 +194,8 @@ CBlockIndex * InsertBlockIndex(uint256 hash);\n bool VerifySignature(const CCoins& txFrom, const CTransaction& txTo, unsigned int nIn, unsigned int flags, int nHashType);\n /** Abort with a message */\n bool AbortNode(const std::string &msg);\n+/** Mark a block as invalid, and reorganize away from it if necessary */\n+void InvalidBlockFound(CBlockIndex *pindex);\n \n \n "
      }
    ]
  },
  {
    "sha": "9fe9d788a9eaf40cc5dd1171807b24c9bd170104",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5ZmU5ZDc4OGE5ZWFmNDBjYzVkZDExNzE4MDdiMjRjOWJkMTcwMTA0",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-07-20T11:13:17Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2013-07-20T11:14:35Z"
      },
      "message": "Add blacklistblock RPC\n\nAs this is a fairly dangerous operation, it is normally disabled when\nbuilding. Define ENABLE_BLOCK_BLACKLISTING to enable compiling it in.",
      "tree": {
        "sha": "64fdc92e3992bbac730a8aaea7fb96229ced043a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/64fdc92e3992bbac730a8aaea7fb96229ced043a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9fe9d788a9eaf40cc5dd1171807b24c9bd170104",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9fe9d788a9eaf40cc5dd1171807b24c9bd170104",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/9fe9d788a9eaf40cc5dd1171807b24c9bd170104",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9fe9d788a9eaf40cc5dd1171807b24c9bd170104/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "7d341f0f8eaa0febc56919b872833cbddb4d37b2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7d341f0f8eaa0febc56919b872833cbddb4d37b2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/7d341f0f8eaa0febc56919b872833cbddb4d37b2"
      }
    ],
    "stats": {
      "total": 25,
      "additions": 25,
      "deletions": 0
    },
    "files": [
      {
        "sha": "9c6e7d48ba4deff68f3519f1522bf807f6a5125d",
        "filename": "src/bitcoinrpc.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9fe9d788a9eaf40cc5dd1171807b24c9bd170104/src/bitcoinrpc.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9fe9d788a9eaf40cc5dd1171807b24c9bd170104/src/bitcoinrpc.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bitcoinrpc.cpp?ref=9fe9d788a9eaf40cc5dd1171807b24c9bd170104",
        "patch": "@@ -232,6 +232,9 @@ static const CRPCCommand vRPCCommands[] =\n     { \"getrawmempool\",          &getrawmempool,          true,      false },\n     { \"getblock\",               &getblock,               false,     false },\n     { \"getblockhash\",           &getblockhash,           false,     false },\n+#ifdef ENABLE_BLOCK_BLACKLISTING\n+    { \"blacklistblock\",         &blacklistblock,         true,      false },\n+#endif\n     { \"gettransaction\",         &gettransaction,         false,     false },\n     { \"listtransactions\",       &listtransactions,       false,     false },\n     { \"listaddressgroupings\",   &listaddressgroupings,   false,     false },"
      },
      {
        "sha": "e7af18283514710fb7ef3609a6b3378552d14f49",
        "filename": "src/bitcoinrpc.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9fe9d788a9eaf40cc5dd1171807b24c9bd170104/src/bitcoinrpc.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9fe9d788a9eaf40cc5dd1171807b24c9bd170104/src/bitcoinrpc.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bitcoinrpc.h?ref=9fe9d788a9eaf40cc5dd1171807b24c9bd170104",
        "patch": "@@ -207,6 +207,7 @@ extern json_spirit::Value settxfee(const json_spirit::Array& params, bool fHelp)\n extern json_spirit::Value getrawmempool(const json_spirit::Array& params, bool fHelp);\n extern json_spirit::Value getblockhash(const json_spirit::Array& params, bool fHelp);\n extern json_spirit::Value getblock(const json_spirit::Array& params, bool fHelp);\n+extern json_spirit::Value blacklistblock(const json_spirit::Array& params, bool fHelp);\n extern json_spirit::Value gettxoutsetinfo(const json_spirit::Array& params, bool fHelp);\n extern json_spirit::Value gettxout(const json_spirit::Array& params, bool fHelp);\n extern json_spirit::Value verifychain(const json_spirit::Array& params, bool fHelp);"
      },
      {
        "sha": "8d1d9dc8ffb012f0749790ba655607e51627dd7c",
        "filename": "src/rpcblockchain.cpp",
        "status": "modified",
        "additions": 21,
        "deletions": 0,
        "changes": 21,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9fe9d788a9eaf40cc5dd1171807b24c9bd170104/src/rpcblockchain.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9fe9d788a9eaf40cc5dd1171807b24c9bd170104/src/rpcblockchain.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpcblockchain.cpp?ref=9fe9d788a9eaf40cc5dd1171807b24c9bd170104",
        "patch": "@@ -207,6 +207,27 @@ Value gettxoutsetinfo(const Array& params, bool fHelp)\n     return ret;\n }\n \n+Value blacklistblock(const Array &params, bool fHelp)\n+{\n+    if (fHelp || params.size() < 1)\n+        throw runtime_error(\n+            \"blacklistblock <blkid>\\n\"\n+            \"Blacklist a block, and reorganize away from it.\\n\"\n+            \"WARNING: USE ONLY IN EMERGENCY SITUATIONS.\\n\");\n+\n+    std::string strHash = params[0].get_str();\n+    uint256 hash(strHash);\n+    \n+    if (mapBlockIndex.count(hash) == 0)\n+        throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Block not found\");\n+\n+    CBlockIndex* pblockindex = mapBlockIndex[hash];\n+\n+    InvalidBlockFound(pblockindex);\n+\n+    return Value::null;\n+}\n+\n Value gettxout(const Array& params, bool fHelp)\n {\n     if (fHelp || params.size() < 2 || params.size() > 3)"
      }
    ]
  }
]