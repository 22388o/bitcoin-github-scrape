[
  {
    "sha": "369244f654c9e36b803e841eb30fd0aa2960087a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozNjkyNDRmNjU0YzllMzZiODAzZTg0MWViMzBmZDBhYTI5NjAwODdh",
    "commit": {
      "author": {
        "name": "Chun Kuan Lee",
        "email": "ken2812221@gmail.com",
        "date": "2018-10-07T16:24:20Z"
      },
      "committer": {
        "name": "Chun Kuan Lee",
        "email": "ken2812221@gmail.com",
        "date": "2018-10-18T18:29:25Z"
      },
      "message": "utils: Fix broken Windows filelock",
      "tree": {
        "sha": "cc74ae7e3a5c7ae7f463bd409f0492491e25e33b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cc74ae7e3a5c7ae7f463bd409f0492491e25e33b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/369244f654c9e36b803e841eb30fd0aa2960087a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/369244f654c9e36b803e841eb30fd0aa2960087a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/369244f654c9e36b803e841eb30fd0aa2960087a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/369244f654c9e36b803e841eb30fd0aa2960087a/comments",
    "author": {
      "login": "ken2812221",
      "id": 11154118,
      "node_id": "MDQ6VXNlcjExMTU0MTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/11154118?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ken2812221",
      "html_url": "https://github.com/ken2812221",
      "followers_url": "https://api.github.com/users/ken2812221/followers",
      "following_url": "https://api.github.com/users/ken2812221/following{/other_user}",
      "gists_url": "https://api.github.com/users/ken2812221/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ken2812221/subscriptions",
      "organizations_url": "https://api.github.com/users/ken2812221/orgs",
      "repos_url": "https://api.github.com/users/ken2812221/repos",
      "events_url": "https://api.github.com/users/ken2812221/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ken2812221/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ken2812221",
      "id": 11154118,
      "node_id": "MDQ6VXNlcjExMTU0MTE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/11154118?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ken2812221",
      "html_url": "https://github.com/ken2812221",
      "followers_url": "https://api.github.com/users/ken2812221/followers",
      "following_url": "https://api.github.com/users/ken2812221/following{/other_user}",
      "gists_url": "https://api.github.com/users/ken2812221/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ken2812221/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ken2812221/subscriptions",
      "organizations_url": "https://api.github.com/users/ken2812221/orgs",
      "repos_url": "https://api.github.com/users/ken2812221/repos",
      "events_url": "https://api.github.com/users/ken2812221/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ken2812221/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "fe23553edd84b0247e05ec3de023944c558afd54",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fe23553edd84b0247e05ec3de023944c558afd54",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/fe23553edd84b0247e05ec3de023944c558afd54"
      }
    ],
    "stats": {
      "total": 40,
      "additions": 39,
      "deletions": 1
    },
    "files": [
      {
        "sha": "3c8f4c02472dd775e4b02c6992feec375b6774ef",
        "filename": "src/fs.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/369244f654c9e36b803e841eb30fd0aa2960087a/src/fs.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/369244f654c9e36b803e841eb30fd0aa2960087a/src/fs.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/fs.cpp?ref=369244f654c9e36b803e841eb30fd0aa2960087a",
        "patch": "@@ -3,6 +3,7 @@\n #ifndef WIN32\n #include <fcntl.h>\n #else\n+#define NOMINMAX\n #include <codecvt>\n #include <windows.h>\n #endif\n@@ -89,7 +90,7 @@ bool FileLock::TryLock()\n         return false;\n     }\n     _OVERLAPPED overlapped = {0};\n-    if (!LockFileEx(hFile, LOCKFILE_EXCLUSIVE_LOCK | LOCKFILE_FAIL_IMMEDIATELY, 0, 0, 0, &overlapped)) {\n+    if (!LockFileEx(hFile, LOCKFILE_EXCLUSIVE_LOCK | LOCKFILE_FAIL_IMMEDIATELY, 0, std::numeric_limits<DWORD>::max(), std::numeric_limits<DWORD>::max(), &overlapped)) {\n         reason = GetErrorReason();\n         return false;\n     }"
      },
      {
        "sha": "9fb0d35a68f3810b313faf404dec3505ed2d6fcb",
        "filename": "test/functional/feature_filelock.py",
        "status": "added",
        "additions": 36,
        "deletions": 0,
        "changes": 36,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/369244f654c9e36b803e841eb30fd0aa2960087a/test/functional/feature_filelock.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/369244f654c9e36b803e841eb30fd0aa2960087a/test/functional/feature_filelock.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/feature_filelock.py?ref=369244f654c9e36b803e841eb30fd0aa2960087a",
        "patch": "@@ -0,0 +1,36 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2018 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Check that it's not possible to start a second bitcoind instance using the same datadir or wallet.\"\"\"\n+import os\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.test_node import ErrorMatch\n+\n+class FilelockTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+\n+    def setup_network(self):\n+        self.add_nodes(self.num_nodes, extra_args=None)\n+        self.nodes[0].start([])\n+        self.nodes[0].wait_for_rpc_connection()\n+\n+    def run_test(self):\n+        datadir = os.path.join(self.nodes[0].datadir, 'regtest')\n+        self.log.info(\"Using datadir {}\".format(datadir))\n+\n+        self.log.info(\"Check that we can't start a second bitcoind instance using the same datadir\")\n+        expected_msg = \"Error: Cannot obtain a lock on data directory {}. Bitcoin Core is probably already running.\".format(datadir)\n+        self.nodes[1].assert_start_raises_init_error(extra_args=['-datadir={}'.format(self.nodes[0].datadir), '-noserver'], expected_msg=expected_msg)\n+\n+        if self.is_wallet_compiled():\n+            wallet_dir = os.path.join(datadir, 'wallets')\n+            self.log.info(\"Check that we can't start a second bitcoind instance using the same wallet\")\n+            expected_msg = \"Error: Error initializing wallet database environment\"\n+            self.nodes[1].assert_start_raises_init_error(extra_args=['-walletdir={}'.format(wallet_dir), '-noserver'], expected_msg=expected_msg, match=ErrorMatch.PARTIAL_REGEX)\n+\n+if __name__ == '__main__':\n+    FilelockTest().main()"
      },
      {
        "sha": "3f990924ec73a5a5be57b82b7a55624782cdcb05",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/369244f654c9e36b803e841eb30fd0aa2960087a/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/369244f654c9e36b803e841eb30fd0aa2960087a/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=369244f654c9e36b803e841eb30fd0aa2960087a",
        "patch": "@@ -174,6 +174,7 @@\n     'rpc_getblockstats.py',\n     'p2p_fingerprint.py',\n     'feature_uacomment.py',\n+    'feature_filelock.py',\n     'p2p_unrequested_blocks.py',\n     'feature_includeconf.py',\n     'rpc_scantxoutset.py',"
      }
    ]
  }
]