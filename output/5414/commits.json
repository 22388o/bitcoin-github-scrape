[
  {
    "sha": "01c16abf9b184a76094a77b840cbaea76d7cc6ec",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowMWMxNmFiZjliMTg0YTc2MDk0YTc3Yjg0MGNiYWVhNzZkN2NjNmVj",
    "commit": {
      "author": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2014-12-03T07:40:49Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2014-12-03T07:40:49Z"
      },
      "message": "getblocktemplate: use_cache extension parameter to allow override of whether the template cache is used",
      "tree": {
        "sha": "9a956eec201642c4d8834208fd6f2147f8aef057",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9a956eec201642c4d8834208fd6f2147f8aef057"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/01c16abf9b184a76094a77b840cbaea76d7cc6ec",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/01c16abf9b184a76094a77b840cbaea76d7cc6ec",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/01c16abf9b184a76094a77b840cbaea76d7cc6ec",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/01c16abf9b184a76094a77b840cbaea76d7cc6ec/comments",
    "author": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "8a20cd3c516c1134905d943861d506213e33e90e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8a20cd3c516c1134905d943861d506213e33e90e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/8a20cd3c516c1134905d943861d506213e33e90e"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 4,
      "deletions": 1
    },
    "files": [
      {
        "sha": "2b5a93446f017c88d1def7e8cbda5c1bbdc07351",
        "filename": "src/rpcmining.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 1,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/01c16abf9b184a76094a77b840cbaea76d7cc6ec/src/rpcmining.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/01c16abf9b184a76094a77b840cbaea76d7cc6ec/src/rpcmining.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpcmining.cpp?ref=01c16abf9b184a76094a77b840cbaea76d7cc6ec",
        "patch": "@@ -381,6 +381,7 @@ Value getblocktemplate(const Array& params, bool fHelp)\n \n     std::string strMode = \"template\";\n     Value lpval = Value::null;\n+    Value use_cache = Value::null;\n     if (params.size() > 0)\n     {\n         const Object& oparam = params[0].get_obj();\n@@ -424,6 +425,7 @@ Value getblocktemplate(const Array& params, bool fHelp)\n             TestBlockValidity(state, block, pindexPrev, false, true);\n             return BIP22ValidationResult(state);\n         }\n+        use_cache = find_value(oparam, \"use_cache\");\n     }\n \n     if (strMode != \"template\")\n@@ -495,8 +497,9 @@ Value getblocktemplate(const Array& params, bool fHelp)\n     static CBlockIndex* pindexPrev;\n     static int64_t nStart;\n     static CBlockTemplate* pblocktemplate;\n-    if (pindexPrev != chainActive.Tip() ||\n+    if ((use_cache.type() == null_type) ? (pindexPrev != chainActive.Tip() ||\n         (mempool.GetTransactionsUpdated() != nTransactionsUpdatedLast && GetTime() - nStart > 5))\n+        : (!use_cache.get_bool()))\n     {\n         // Clear pindexPrev so future calls make a new block, despite any failures from here on\n         pindexPrev = NULL;"
      }
    ]
  },
  {
    "sha": "5e2d238befc34a5e4f72e960358a34eac0fb877f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1ZTJkMjM4YmVmYzM0YTVlNGY3MmU5NjAzNThhMzRlYWMwZmI4Nzdm",
    "commit": {
      "author": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2014-12-03T08:36:51Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2014-12-03T08:36:51Z"
      },
      "message": "getblocktemplate: Include user-adjusted tx fee/priority in transactions list",
      "tree": {
        "sha": "d6d37da46a72a7d66f3d4ac9e50d75ecc4a26b76",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d6d37da46a72a7d66f3d4ac9e50d75ecc4a26b76"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5e2d238befc34a5e4f72e960358a34eac0fb877f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5e2d238befc34a5e4f72e960358a34eac0fb877f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/5e2d238befc34a5e4f72e960358a34eac0fb877f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5e2d238befc34a5e4f72e960358a34eac0fb877f/comments",
    "author": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "01c16abf9b184a76094a77b840cbaea76d7cc6ec",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/01c16abf9b184a76094a77b840cbaea76d7cc6ec",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/01c16abf9b184a76094a77b840cbaea76d7cc6ec"
      }
    ],
    "stats": {
      "total": 13,
      "additions": 13,
      "deletions": 0
    },
    "files": [
      {
        "sha": "5f639dfb576da35088bb94c5dcf58a38ef49fd4b",
        "filename": "src/main.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5e2d238befc34a5e4f72e960358a34eac0fb877f/src/main.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5e2d238befc34a5e4f72e960358a34eac0fb877f/src/main.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.h?ref=5e2d238befc34a5e4f72e960358a34eac0fb877f",
        "patch": "@@ -627,6 +627,8 @@ struct CBlockTemplate\n     CBlock block;\n     std::vector<CAmount> vTxFees;\n     std::vector<int64_t> vTxSigOps;\n+    std::vector<CAmount> vTxFeesAdjusted;\n+    std::vector<double> vTxPrioritiesAdjusted;\n };\n \n "
      },
      {
        "sha": "47b3eefa36e650f2f3ff2a8e7f392d22b950b51a",
        "filename": "src/miner.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 0,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5e2d238befc34a5e4f72e960358a34eac0fb877f/src/miner.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5e2d238befc34a5e4f72e960358a34eac0fb877f/src/miner.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/miner.cpp?ref=5e2d238befc34a5e4f72e960358a34eac0fb877f",
        "patch": "@@ -112,6 +112,8 @@ CBlockTemplate* CreateNewBlock(const CScript& scriptPubKeyIn)\n     pblock->vtx.push_back(CTransaction());\n     pblocktemplate->vTxFees.push_back(-1); // updated at end\n     pblocktemplate->vTxSigOps.push_back(-1); // updated at end\n+    pblocktemplate->vTxFeesAdjusted.push_back(-1);  // updated at end\n+    pblocktemplate->vTxPrioritiesAdjusted.push_back(0);\n \n     // Largest block you're willing to create:\n     unsigned int nBlockMaxSize = GetArg(\"-blockmaxsize\", DEFAULT_BLOCK_MAX_SIZE);\n@@ -286,6 +288,13 @@ CBlockTemplate* CreateNewBlock(const CScript& scriptPubKeyIn)\n             pblock->vtx.push_back(tx);\n             pblocktemplate->vTxFees.push_back(nTxFees);\n             pblocktemplate->vTxSigOps.push_back(nTxSigOps);\n+            {\n+                CAmount nTxFeesAdj = nTxFees;\n+                double dummy;\n+                mempool.ApplyDeltas(hash, dummy, nTxFeesAdj);\n+                pblocktemplate->vTxFeesAdjusted.push_back(nTxFeesAdj);\n+            }\n+            pblocktemplate->vTxPrioritiesAdjusted.push_back(dPriority);\n             nBlockSize += nTxSize;\n             ++nBlockTx;\n             nBlockSigOps += nTxSigOps;"
      },
      {
        "sha": "a0bc62ba0e29c5522871b057f815564ad08e2dc0",
        "filename": "src/rpcmining.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5e2d238befc34a5e4f72e960358a34eac0fb877f/src/rpcmining.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5e2d238befc34a5e4f72e960358a34eac0fb877f/src/rpcmining.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpcmining.cpp?ref=5e2d238befc34a5e4f72e960358a34eac0fb877f",
        "patch": "@@ -559,6 +559,8 @@ Value getblocktemplate(const Array& params, bool fHelp)\n         int index_in_template = i - 1;\n         entry.push_back(Pair(\"fee\", pblocktemplate->vTxFees[index_in_template]));\n         entry.push_back(Pair(\"sigops\", pblocktemplate->vTxSigOps[index_in_template]));\n+        entry.push_back(Pair(\"fee_adjusted\", pblocktemplate->vTxFeesAdjusted[index_in_template]));\n+        entry.push_back(Pair(\"priority_adjusted\", pblocktemplate->vTxPrioritiesAdjusted[index_in_template]));\n \n         transactions.push_back(entry);\n     }"
      }
    ]
  },
  {
    "sha": "ae44a0eab26c955917812221ee6f70c38a7a6b8f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphZTQ0YTBlYWIyNmM5NTU5MTc4MTIyMjFlZTZmNzBjMzhhN2E2Yjhm",
    "commit": {
      "author": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2014-12-03T08:38:00Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2014-12-03T08:38:00Z"
      },
      "message": "qa/rpc-tests: Test prioritisetransaction",
      "tree": {
        "sha": "97287a80bccf4eb86e4d87809e3555d46205d42b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/97287a80bccf4eb86e4d87809e3555d46205d42b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ae44a0eab26c955917812221ee6f70c38a7a6b8f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ae44a0eab26c955917812221ee6f70c38a7a6b8f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ae44a0eab26c955917812221ee6f70c38a7a6b8f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ae44a0eab26c955917812221ee6f70c38a7a6b8f/comments",
    "author": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "5e2d238befc34a5e4f72e960358a34eac0fb877f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5e2d238befc34a5e4f72e960358a34eac0fb877f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/5e2d238befc34a5e4f72e960358a34eac0fb877f"
      }
    ],
    "stats": {
      "total": 69,
      "additions": 69,
      "deletions": 0
    },
    "files": [
      {
        "sha": "b29f6059bae2d1c6444c628fda6425b7085c06a4",
        "filename": "qa/rpc-tests/prioritisetransaction.py",
        "status": "added",
        "additions": 69,
        "deletions": 0,
        "changes": 69,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ae44a0eab26c955917812221ee6f70c38a7a6b8f/qa/rpc-tests/prioritisetransaction.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ae44a0eab26c955917812221ee6f70c38a7a6b8f/qa/rpc-tests/prioritisetransaction.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/prioritisetransaction.py?ref=ae44a0eab26c955917812221ee6f70c38a7a6b8f",
        "patch": "@@ -0,0 +1,69 @@\n+#!/usr/bin/env python2\n+# Copyright (c) 2014 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework import BitcoinTestFramework\n+from bitcoinrpc.authproxy import AuthServiceProxy, JSONRPCException\n+from util import *\n+\n+def fresh_gbt(anode):\n+    tmpl = anode.getblocktemplate({\"use_cache\": False})\n+    return tmpl\n+\n+def tmpl_tx(tmpl, txid):\n+    for tx in tmpl['transactions']:\n+        if tx['hash'] == txid:\n+            return tx\n+\n+class PrioritiseTransactionTest(BitcoinTestFramework):\n+    '''\n+    Test prioritisetransaction with getblocktemplate.\n+    '''\n+\n+    def run_test(self):\n+        node = self.nodes[0]\n+\n+        node.setgenerate(True, 10)\n+\n+        (txid_a, txhex, fee) = random_transaction(self.nodes, Decimal(\"1.1\"), 1, 0, 20)\n+        (txid_b, txhex, fee) = random_transaction(self.nodes, Decimal(\"1.1\"), 2, 0, 20)\n+        sync_blocks(self.nodes)\n+        sync_mempools(self.nodes)\n+\n+        # Put both transactions at the same base priority/fee level\n+        tmpl = fresh_gbt(node)\n+        prio_a = tmpl_tx(tmpl, txid_a)['priority_adjusted']\n+        prio_b = tmpl_tx(tmpl, txid_b)['priority_adjusted']\n+        base_prio = max(prio_a, prio_b) + 1000000\n+        assert(node.prioritisetransaction(txid_a, base_prio - prio_a, 200000000))\n+        assert(node.prioritisetransaction(txid_b, base_prio - prio_b, 100000000))\n+\n+        if len(fresh_gbt(node)['transactions']) != 2:\n+            raise AssertionError('Unexpected transaction count in template')\n+\n+        def testadj(txid, prio, fee):\n+            assert(node.prioritisetransaction(txid, prio, fee))\n+            tmpl = fresh_gbt(node)\n+            tx = tmpl_tx(tmpl, txid)\n+            assert(tx['fee_adjusted'] == 300000000 + fee)\n+            assert(tx['priority_adjusted'] == base_prio + prio)\n+            # NOTE: Fees don't actually affect block ordering\n+            if prio and tmpl['transactions'][0]['hash'] != txid:\n+                raise AssertionError('Higher priority ignored')\n+            assert(node.prioritisetransaction(txid, -prio * 2, -fee * 2))\n+            tmpl = fresh_gbt(node)\n+            tx = tmpl_tx(tmpl, txid)\n+            assert(tx['fee_adjusted'] == 300000000 - fee)\n+            assert(tx['priority_adjusted'] == base_prio - prio)\n+            if prio and tmpl['transactions'][0]['hash'] == txid:\n+                raise AssertionError('Lower priority ignored')\n+            assert(node.prioritisetransaction(txid, prio, fee))\n+\n+        testadj(txid_a, 1, 0)\n+        testadj(txid_b, 1, 0)\n+        testadj(txid_a, 0, 1)\n+        testadj(txid_b, 0, 1)\n+\n+if __name__ == '__main__':\n+    PrioritiseTransactionTest().main()"
      }
    ]
  }
]