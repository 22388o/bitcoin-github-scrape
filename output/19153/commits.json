[
  {
    "sha": "16d4b3fd6d5aad18ebb731a5006a15180d3661ef",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxNmQ0YjNmZDZkNWFhZDE4ZWJiNzMxYTUwMDZhMTUxODBkMzY2MWVm",
    "commit": {
      "author": {
        "name": "Ivan Metlushko",
        "email": "metlushko@gmail.com",
        "date": "2020-06-03T08:56:08Z"
      },
      "committer": {
        "name": "Ivan Metlushko",
        "email": "metlushko@gmail.com",
        "date": "2020-06-10T04:06:03Z"
      },
      "message": "test: mempool.dat compatibility between versions",
      "tree": {
        "sha": "5b3e85c5f89f5e7eb7421f6763fdbfe90ac073ed",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5b3e85c5f89f5e7eb7421f6763fdbfe90ac073ed"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/16d4b3fd6d5aad18ebb731a5006a15180d3661ef",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/16d4b3fd6d5aad18ebb731a5006a15180d3661ef",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/16d4b3fd6d5aad18ebb731a5006a15180d3661ef",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/16d4b3fd6d5aad18ebb731a5006a15180d3661ef/comments",
    "author": {
      "login": "S3RK",
      "id": 1466284,
      "node_id": "MDQ6VXNlcjE0NjYyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1466284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/S3RK",
      "html_url": "https://github.com/S3RK",
      "followers_url": "https://api.github.com/users/S3RK/followers",
      "following_url": "https://api.github.com/users/S3RK/following{/other_user}",
      "gists_url": "https://api.github.com/users/S3RK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/S3RK/subscriptions",
      "organizations_url": "https://api.github.com/users/S3RK/orgs",
      "repos_url": "https://api.github.com/users/S3RK/repos",
      "events_url": "https://api.github.com/users/S3RK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/S3RK/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "S3RK",
      "id": 1466284,
      "node_id": "MDQ6VXNlcjE0NjYyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1466284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/S3RK",
      "html_url": "https://github.com/S3RK",
      "followers_url": "https://api.github.com/users/S3RK/followers",
      "following_url": "https://api.github.com/users/S3RK/following{/other_user}",
      "gists_url": "https://api.github.com/users/S3RK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/S3RK/subscriptions",
      "organizations_url": "https://api.github.com/users/S3RK/orgs",
      "repos_url": "https://api.github.com/users/S3RK/repos",
      "events_url": "https://api.github.com/users/S3RK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/S3RK/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f8364df25070cea08f0fb5bbbb212f1ff72f9d21",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f8364df25070cea08f0fb5bbbb212f1ff72f9d21",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f8364df25070cea08f0fb5bbbb212f1ff72f9d21"
      }
    ],
    "stats": {
      "total": 79,
      "additions": 79,
      "deletions": 0
    },
    "files": [
      {
        "sha": "eb2fee11aeca4601dc440f36cb480f1f868a3908",
        "filename": "test/functional/mempool_compatibility.py",
        "status": "added",
        "additions": 78,
        "deletions": 0,
        "changes": 78,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/16d4b3fd6d5aad18ebb731a5006a15180d3661ef/test/functional/mempool_compatibility.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/16d4b3fd6d5aad18ebb731a5006a15180d3661ef/test/functional/mempool_compatibility.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/mempool_compatibility.py?ref=16d4b3fd6d5aad18ebb731a5006a15180d3661ef",
        "patch": "@@ -0,0 +1,78 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017-2020 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that mempool.dat is both backward and forward compatible between versions\n+\n+NOTE: The test is designed to prevent cases when compatibility is broken accidentally.\n+In case we need to break mempool compatibility we can continue to use the test by just bumping the version number.\n+\n+Download node binaries:\n+contrib/devtools/previous_release.sh -b v0.19.1 v0.18.1 v0.17.1 v0.16.3 v0.15.2\n+\n+Only v0.15.2 is required by this test. The rest is used in other backwards compatibility tests.\n+\"\"\"\n+\n+import os\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    adjust_bitcoin_conf_for_pre_17\n+)\n+\n+class MempoolCompatibilityTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+        self.skip_if_no_previous_releases()\n+\n+    def setup_network(self):\n+        self.add_nodes(self.num_nodes, versions=[\n+            150200, # oldest version supported by the test framework\n+            None,\n+        ])\n+        adjust_bitcoin_conf_for_pre_17(self.nodes[0].bitcoinconf)\n+        self.start_nodes()\n+        self.import_deterministic_coinbase_privkeys()\n+\n+    def run_test(self):\n+        self.log.info(\"Test that mempool.dat is compatible between versions\")\n+\n+        old_node = self.nodes[0]\n+        new_node = self.nodes[1]\n+        recipient = old_node.getnewaddress()\n+        self.stop_node(1)\n+\n+        self.log.info(\"Add a transaction to mempool on old node and shutdown\")\n+        old_tx_hash = old_node.sendtoaddress(recipient, 0.0001)\n+        assert old_tx_hash in old_node.getrawmempool()\n+        self.stop_node(0)\n+\n+        self.log.info(\"Move mempool.dat from old to new node\")\n+        old_node_mempool = os.path.join(old_node.datadir, self.chain, 'mempool.dat')\n+        new_node_mempool = os.path.join(new_node.datadir, self.chain, 'mempool.dat')\n+        os.rename(old_node_mempool, new_node_mempool)\n+\n+        self.log.info(\"Start new node and verify mempool contains the tx\")\n+        self.start_node(1)\n+        assert old_tx_hash in new_node.getrawmempool()\n+\n+        self.log.info(\"Add unbroadcasted tx to mempool on new node and shutdown\")\n+        unbroadcasted_tx_hash = new_node.sendtoaddress(recipient, 0.0001)\n+        assert unbroadcasted_tx_hash in new_node.getrawmempool()\n+        mempool = new_node.getrawmempool(True)\n+        assert mempool[unbroadcasted_tx_hash]['unbroadcast']\n+        self.stop_node(1)\n+\n+        self.log.info(\"Move mempool.dat from new to old node\")\n+        os.rename(new_node_mempool, old_node_mempool)\n+\n+        self.log.info(\"Start old node again and verify mempool contains both txs\")\n+        self.start_node(0, ['-nowallet'])\n+        assert old_tx_hash in old_node.getrawmempool()\n+        assert unbroadcasted_tx_hash in old_node.getrawmempool()\n+\n+if __name__ == \"__main__\":\n+    MempoolCompatibilityTest().main()"
      },
      {
        "sha": "e92252d04ff28d763e5b8813667e3f4bc94745fe",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/16d4b3fd6d5aad18ebb731a5006a15180d3661ef/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/16d4b3fd6d5aad18ebb731a5006a15180d3661ef/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=16d4b3fd6d5aad18ebb731a5006a15180d3661ef",
        "patch": "@@ -232,6 +232,7 @@\n     'feature_includeconf.py',\n     'feature_asmap.py',\n     'mempool_unbroadcast.py',\n+    'mempool_compatibility.py',\n     'rpc_deriveaddresses.py',\n     'rpc_deriveaddresses.py --usecli',\n     'rpc_scantxoutset.py',"
      }
    ]
  }
]