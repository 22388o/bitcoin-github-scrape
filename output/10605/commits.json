[
  {
    "sha": "545e85eccc2441c6d7745bb90d88dc14718455a2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1NDVlODVlY2NjMjQ0MWM2ZDc3NDViYjkwZDg4ZGMxNDcxODQ1NWEy",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2017-06-15T18:56:35Z"
      },
      "committer": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2018-04-11T14:45:47Z"
      },
      "message": "Add AssertLockHeld assertions in CWallet::ListCoins",
      "tree": {
        "sha": "bb7836d6ed3c296b139b41b568bad2c1af56a8b0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/bb7836d6ed3c296b139b41b568bad2c1af56a8b0"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/545e85eccc2441c6d7745bb90d88dc14718455a2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/545e85eccc2441c6d7745bb90d88dc14718455a2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/545e85eccc2441c6d7745bb90d88dc14718455a2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/545e85eccc2441c6d7745bb90d88dc14718455a2/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "3cf76c23fbfc8500fa494f8cef8068a67a1388c3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3cf76c23fbfc8500fa494f8cef8068a67a1388c3",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/3cf76c23fbfc8500fa494f8cef8068a67a1388c3"
      }
    ],
    "stats": {
      "total": 28,
      "additions": 15,
      "deletions": 13
    },
    "files": [
      {
        "sha": "10e6da8b13e05c594bbd99640e72e73d3a71087e",
        "filename": "src/wallet/test/wallet_tests.cpp",
        "status": "modified",
        "additions": 13,
        "deletions": 3,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/545e85eccc2441c6d7745bb90d88dc14718455a2/src/wallet/test/wallet_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/545e85eccc2441c6d7745bb90d88dc14718455a2/src/wallet/test/wallet_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/test/wallet_tests.cpp?ref=545e85eccc2441c6d7745bb90d88dc14718455a2",
        "patch": "@@ -317,7 +317,11 @@ BOOST_FIXTURE_TEST_CASE(ListCoins, ListCoinsTestingSetup)\n \n     // Confirm ListCoins initially returns 1 coin grouped under coinbaseKey\n     // address.\n-    auto list = wallet->ListCoins();\n+    std::map<CTxDestination, std::vector<COutput>> list;\n+    {\n+        LOCK2(cs_main, wallet->cs_wallet);\n+        list = wallet->ListCoins();\n+    }\n     BOOST_CHECK_EQUAL(list.size(), 1U);\n     BOOST_CHECK_EQUAL(boost::get<CKeyID>(list.begin()->first).ToString(), coinbaseAddress);\n     BOOST_CHECK_EQUAL(list.begin()->second.size(), 1U);\n@@ -330,7 +334,10 @@ BOOST_FIXTURE_TEST_CASE(ListCoins, ListCoinsTestingSetup)\n     // coinbaseKey pubkey, even though the change address has a different\n     // pubkey.\n     AddTx(CRecipient{GetScriptForRawPubKey({}), 1 * COIN, false /* subtract fee */});\n-    list = wallet->ListCoins();\n+    {\n+        LOCK2(cs_main, wallet->cs_wallet);\n+        list = wallet->ListCoins();\n+    }\n     BOOST_CHECK_EQUAL(list.size(), 1U);\n     BOOST_CHECK_EQUAL(boost::get<CKeyID>(list.begin()->first).ToString(), coinbaseAddress);\n     BOOST_CHECK_EQUAL(list.begin()->second.size(), 2U);\n@@ -356,7 +363,10 @@ BOOST_FIXTURE_TEST_CASE(ListCoins, ListCoinsTestingSetup)\n     }\n     // Confirm ListCoins still returns same result as before, despite coins\n     // being locked.\n-    list = wallet->ListCoins();\n+    {\n+        LOCK2(cs_main, wallet->cs_wallet);\n+        list = wallet->ListCoins();\n+    }\n     BOOST_CHECK_EQUAL(list.size(), 1U);\n     BOOST_CHECK_EQUAL(boost::get<CKeyID>(list.begin()->first).ToString(), coinbaseAddress);\n     BOOST_CHECK_EQUAL(list.begin()->second.size(), 2U);"
      },
      {
        "sha": "40ff0631051f5cf67e310c3436db20bc4758f66b",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 10,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/545e85eccc2441c6d7745bb90d88dc14718455a2/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/545e85eccc2441c6d7745bb90d88dc14718455a2/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=545e85eccc2441c6d7745bb90d88dc14718455a2",
        "patch": "@@ -2364,20 +2364,12 @@ void CWallet::AvailableCoins(std::vector<COutput> &vCoins, bool fOnlySafe, const\n \n std::map<CTxDestination, std::vector<COutput>> CWallet::ListCoins() const\n {\n-    // TODO: Add AssertLockHeld(cs_wallet) here.\n-    //\n-    // Because the return value from this function contains pointers to\n-    // CWalletTx objects, callers to this function really should acquire the\n-    // cs_wallet lock before calling it. However, the current caller doesn't\n-    // acquire this lock yet. There was an attempt to add the missing lock in\n-    // https://github.com/bitcoin/bitcoin/pull/10340, but that change has been\n-    // postponed until after https://github.com/bitcoin/bitcoin/pull/10244 to\n-    // avoid adding some extra complexity to the Qt code.\n+    AssertLockHeld(cs_main);\n+    AssertLockHeld(cs_wallet);\n \n     std::map<CTxDestination, std::vector<COutput>> result;\n     std::vector<COutput> availableCoins;\n \n-    LOCK2(cs_main, cs_wallet);\n     AvailableCoins(availableCoins);\n \n     for (auto& coin : availableCoins) {"
      }
    ]
  },
  {
    "sha": "62b6f0f21e24ff367d096c80ebdf398de4a98163",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2MmI2ZjBmMjFlMjRmZjM2N2QwOTZjODBlYmRmMzk4ZGU0YTk4MTYz",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2018-08-31T12:11:01Z"
      },
      "committer": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2018-08-31T12:11:01Z"
      },
      "message": "Add EXCLUSIVE_LOCKS_REQUIRED to CWallet::ListCoins\n\nSuggested by MarcoFalke <falke.marco@gmail.com> in\nhttps://github.com/bitcoin/bitcoin/pull/10605#issuecomment-417643535",
      "tree": {
        "sha": "d14dbaefecf3a9cd8a0f17f591d440947daaf777",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d14dbaefecf3a9cd8a0f17f591d440947daaf777"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/62b6f0f21e24ff367d096c80ebdf398de4a98163",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/62b6f0f21e24ff367d096c80ebdf398de4a98163",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/62b6f0f21e24ff367d096c80ebdf398de4a98163",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/62b6f0f21e24ff367d096c80ebdf398de4a98163/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "545e85eccc2441c6d7745bb90d88dc14718455a2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/545e85eccc2441c6d7745bb90d88dc14718455a2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/545e85eccc2441c6d7745bb90d88dc14718455a2"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 1,
      "deletions": 1
    },
    "files": [
      {
        "sha": "c8d5e6a781cb21b83a9f8dbd796a6a8394990b4f",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/62b6f0f21e24ff367d096c80ebdf398de4a98163/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/62b6f0f21e24ff367d096c80ebdf398de4a98163/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=62b6f0f21e24ff367d096c80ebdf398de4a98163",
        "patch": "@@ -821,7 +821,7 @@ class CWallet final : public CCryptoKeyStore, public CValidationInterface\n     /**\n      * Return list of available coins and locked coins grouped by non-change output address.\n      */\n-    std::map<CTxDestination, std::vector<COutput>> ListCoins() const;\n+    std::map<CTxDestination, std::vector<COutput>> ListCoins() const EXCLUSIVE_LOCKS_REQUIRED(cs_main, cs_wallet);\n \n     /**\n      * Find non-change parent output."
      }
    ]
  }
]