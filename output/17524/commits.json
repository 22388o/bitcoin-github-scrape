[
  {
    "sha": "638e40cb6080800c7b0a7f4028f63326acbe4700",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2MzhlNDBjYjYwODA4MDBjN2IwYTdmNDAyOGY2MzMyNmFjYmU0NzAw",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2019-11-19T19:35:14Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2019-11-19T19:54:08Z"
      },
      "message": "Have a PSBTAnalysis state that indicates invalid PSBT\n\nInvalid PSBTs need to be re-created, so the next role is the\nCreator (new PSBTRole). Additionally, we need to know what went\nwrong so an error field was added to PSBTAnalysis.\n\nA PSBTAnalysis indicating invalid will have empty everything,\nnext will be set to PSBTRole::CREATOR, and an error message.",
      "tree": {
        "sha": "05b8025aa1b573e974911096731aac3db2e28af6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/05b8025aa1b573e974911096731aac3db2e28af6"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/638e40cb6080800c7b0a7f4028f63326acbe4700",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/638e40cb6080800c7b0a7f4028f63326acbe4700",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/638e40cb6080800c7b0a7f4028f63326acbe4700",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/638e40cb6080800c7b0a7f4028f63326acbe4700/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b4a1da9ef8e4b673c290d5b882527e627ae1b43a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b4a1da9ef8e4b673c290d5b882527e627ae1b43a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b4a1da9ef8e4b673c290d5b882527e627ae1b43a"
      }
    ],
    "stats": {
      "total": 19,
      "additions": 18,
      "deletions": 1
    },
    "files": [
      {
        "sha": "7384dc415cca8734ebfba64f91bddffb59f1ab74",
        "filename": "src/node/psbt.h",
        "status": "modified",
        "additions": 11,
        "deletions": 0,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/638e40cb6080800c7b0a7f4028f63326acbe4700/src/node/psbt.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/638e40cb6080800c7b0a7f4028f63326acbe4700/src/node/psbt.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/node/psbt.h?ref=638e40cb6080800c7b0a7f4028f63326acbe4700",
        "patch": "@@ -30,6 +30,17 @@ struct PSBTAnalysis {\n     Optional<CAmount> fee;                 //!< Amount of fee being paid by the transaction\n     std::vector<PSBTInputAnalysis> inputs; //!< More information about the individual inputs of the transaction\n     PSBTRole next;                         //!< Which of the BIP 174 roles needs to handle the transaction next\n+    std::string error;                     //!< Error message\n+\n+    void SetInvalid(std::string err_msg)\n+    {\n+        estimated_vsize = nullopt;\n+        estimated_feerate = nullopt;\n+        fee = nullopt;\n+        inputs.clear();\n+        next = PSBTRole::CREATOR;\n+        error = err_msg;\n+    }\n };\n \n /**"
      },
      {
        "sha": "9ede62efdf50291c8041b205e797e2b5fa6d0372",
        "filename": "src/psbt.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/638e40cb6080800c7b0a7f4028f63326acbe4700/src/psbt.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/638e40cb6080800c7b0a7f4028f63326acbe4700/src/psbt.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/psbt.cpp?ref=638e40cb6080800c7b0a7f4028f63326acbe4700",
        "patch": "@@ -348,6 +348,7 @@ TransactionError CombinePSBTs(PartiallySignedTransaction& out, const std::vector\n \n std::string PSBTRoleName(PSBTRole role) {\n     switch (role) {\n+    case PSBTRole::CREATOR: return \"creator\";\n     case PSBTRole::UPDATER: return \"updater\";\n     case PSBTRole::SIGNER: return \"signer\";\n     case PSBTRole::FINALIZER: return \"finalizer\";"
      },
      {
        "sha": "6842c60ce55317c41b7a37efcfe92cb892922448",
        "filename": "src/psbt.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/638e40cb6080800c7b0a7f4028f63326acbe4700/src/psbt.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/638e40cb6080800c7b0a7f4028f63326acbe4700/src/psbt.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/psbt.h?ref=638e40cb6080800c7b0a7f4028f63326acbe4700",
        "patch": "@@ -560,6 +560,7 @@ struct PartiallySignedTransaction\n };\n \n enum class PSBTRole {\n+    CREATOR,\n     UPDATER,\n     SIGNER,\n     FINALIZER,"
      },
      {
        "sha": "3ec7f0bc5fd16c00731d133eace2f66eb902130e",
        "filename": "src/rpc/rawtransaction.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 1,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/638e40cb6080800c7b0a7f4028f63326acbe4700/src/rpc/rawtransaction.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/638e40cb6080800c7b0a7f4028f63326acbe4700/src/rpc/rawtransaction.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/rawtransaction.cpp?ref=638e40cb6080800c7b0a7f4028f63326acbe4700",
        "patch": "@@ -1672,6 +1672,7 @@ UniValue analyzepsbt(const JSONRPCRequest& request)\n                 \"  \\\"estimated_feerate\\\" : feerate   (numeric, optional) Estimated feerate of the final signed transaction in \" + CURRENCY_UNIT + \"/kB. Shown only if all UTXO slots in the PSBT have been filled.\\n\"\n                 \"  \\\"fee\\\" : fee                     (numeric, optional) The transaction fee paid. Shown only if all UTXO slots in the PSBT have been filled.\\n\"\n                 \"  \\\"next\\\" : \\\"role\\\"                 (string) Role of the next person that this psbt needs to go to\\n\"\n+                \"  \\\"error\\\" : \\\"error\\\"               (string) Error message if there is one\"\n                 \"}\\n\"\n             },\n             RPCExamples {\n@@ -1724,7 +1725,7 @@ UniValue analyzepsbt(const JSONRPCRequest& request)\n         }\n         inputs_result.push_back(input_univ);\n     }\n-    result.pushKV(\"inputs\", inputs_result);\n+    if (!inputs_result.empty()) result.pushKV(\"inputs\", inputs_result);\n \n     if (psbta.estimated_vsize != nullopt) {\n         result.pushKV(\"estimated_vsize\", (int)*psbta.estimated_vsize);\n@@ -1736,6 +1737,9 @@ UniValue analyzepsbt(const JSONRPCRequest& request)\n         result.pushKV(\"fee\", ValueFromAmount(*psbta.fee));\n     }\n     result.pushKV(\"next\", PSBTRoleName(psbta.next));\n+    if (!psbta.error.empty()) {\n+        result.pushKV(\"error\", psbta.error);\n+    }\n \n     return result;\n }"
      }
    ]
  },
  {
    "sha": "773d4572a4864ab7b6380858d07d9579ff6dd9a2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3NzNkNDU3MmE0ODY0YWI3YjYzODA4NThkMDdkOTU3OWZmNmRkOWEy",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2019-11-19T19:54:13Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2019-11-19T19:54:13Z"
      },
      "message": "Mark PSBTs spending unspendable outputs as invalid in analysis",
      "tree": {
        "sha": "42a12df2265d2a9b3f1c92a51e96c0ab5641ac68",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/42a12df2265d2a9b3f1c92a51e96c0ab5641ac68"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/773d4572a4864ab7b6380858d07d9579ff6dd9a2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/773d4572a4864ab7b6380858d07d9579ff6dd9a2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/773d4572a4864ab7b6380858d07d9579ff6dd9a2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/773d4572a4864ab7b6380858d07d9579ff6dd9a2/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "638e40cb6080800c7b0a7f4028f63326acbe4700",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/638e40cb6080800c7b0a7f4028f63326acbe4700",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/638e40cb6080800c7b0a7f4028f63326acbe4700"
      }
    ],
    "stats": {
      "total": 11,
      "additions": 11,
      "deletions": 0
    },
    "files": [
      {
        "sha": "9a30c3f08303ef05927f5bff365a5f8eac2f7f6b",
        "filename": "src/node/psbt.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/773d4572a4864ab7b6380858d07d9579ff6dd9a2/src/node/psbt.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/773d4572a4864ab7b6380858d07d9579ff6dd9a2/src/node/psbt.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/node/psbt.cpp?ref=773d4572a4864ab7b6380858d07d9579ff6dd9a2",
        "patch": "@@ -7,6 +7,7 @@\n #include <node/psbt.h>\n #include <policy/policy.h>\n #include <policy/settings.h>\n+#include <tinyformat.h>\n \n #include <numeric>\n \n@@ -39,6 +40,11 @@ PSBTAnalysis AnalyzePSBT(PartiallySignedTransaction psbtx)\n             calc_fee = false;\n         }\n \n+        if (!utxo.IsNull() && utxo.scriptPubKey.IsUnspendable()) {\n+            result.SetInvalid(strprintf(\"PSBT is not valid. Input %u spends unspendable output\", i));\n+            return result;\n+        }\n+\n         // Check if it is final\n         if (!utxo.IsNull() && !PSBTInputSigned(input)) {\n             input_analysis.is_final = false;"
      },
      {
        "sha": "57333955b263e7dfc7c10ce03463fd74cb0bfd82",
        "filename": "test/functional/rpc_psbt.py",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/773d4572a4864ab7b6380858d07d9579ff6dd9a2/test/functional/rpc_psbt.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/773d4572a4864ab7b6380858d07d9579ff6dd9a2/test/functional/rpc_psbt.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_psbt.py?ref=773d4572a4864ab7b6380858d07d9579ff6dd9a2",
        "patch": "@@ -416,5 +416,10 @@ def test_psbt_input_keys(psbt_input, keys):\n         analyzed = self.nodes[0].analyzepsbt(signed)\n         assert analyzed['inputs'][0]['has_utxo'] and analyzed['inputs'][0]['is_final'] and analyzed['next'] == 'extractor'\n \n+        self.log.info(\"PSBT spending unspendable outputs should have error message and Creator as next\")\n+        analysis = self.nodes[0].analyzepsbt('cHNidP8BAJoCAAAAAljoeiG1ba8MI76OcHBFbDNvfLqlyHV5JPVFiHuyq911AAAAAAD/////g40EJ9DsZQpoqka7CwmK6kQiwHGyyng1Kgd5WdB86h0BAAAAAP////8CcKrwCAAAAAAWAEHYXCtx0AYLCcmIauuBXlCZHdoSTQDh9QUAAAAAFv8/wADXYP/7//////8JxOh0LR2HAI8AAAAAAAEBIADC6wsAAAAAF2oUt/X69ELjeX2nTof+fZ10l+OyAokDAQcJAwEHEAABAACAAAEBIADC6wsAAAAAF2oUt/X69ELjeX2nTof+fZ10l+OyAokDAQcJAwEHENkMak8AAAAA')\n+        assert_equal(analysis['next'], 'creator')\n+        assert_equal(analysis['error'], 'PSBT is not valid. Input 0 spends unspendable output')\n+\n if __name__ == '__main__':\n     PSBTTest().main()"
      }
    ]
  }
]