[
  {
    "sha": "65e91f5edf555691d0e5809d441cff7fa63ba722",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2NWU5MWY1ZWRmNTU1NjkxZDBlNTgwOWQ0NDFjZmY3ZmE2M2JhNzIy",
    "commit": {
      "author": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2017-11-18T08:48:34Z"
      },
      "committer": {
        "name": "James O'Beirne",
        "email": "james.obeirne@gmail.com",
        "date": "2017-11-18T08:48:34Z"
      },
      "message": "[tests] Test that mempool rejects coinbase transactions",
      "tree": {
        "sha": "9a725eebb6bc41e6208f1cf46a9167d2d861dd9b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9a725eebb6bc41e6208f1cf46a9167d2d861dd9b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/65e91f5edf555691d0e5809d441cff7fa63ba722",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/65e91f5edf555691d0e5809d441cff7fa63ba722",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/65e91f5edf555691d0e5809d441cff7fa63ba722",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/65e91f5edf555691d0e5809d441cff7fa63ba722/comments",
    "author": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "142913296f006650127b7a2ef03954e46bfd585c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/142913296f006650127b7a2ef03954e46bfd585c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/142913296f006650127b7a2ef03954e46bfd585c"
      }
    ],
    "stats": {
      "total": 62,
      "additions": 62,
      "deletions": 0
    },
    "files": [
      {
        "sha": "06175be3fc77f73a3f1e4247db050c30f578e7be",
        "filename": "src/Makefile.test.include",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/65e91f5edf555691d0e5809d441cff7fa63ba722/src/Makefile.test.include",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/65e91f5edf555691d0e5809d441cff7fa63ba722/src/Makefile.test.include",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/Makefile.test.include?ref=65e91f5edf555691d0e5809d441cff7fa63ba722",
        "patch": "@@ -80,6 +80,7 @@ BITCOIN_TESTS =\\\n   test/timedata_tests.cpp \\\n   test/torcontrol_tests.cpp \\\n   test/transaction_tests.cpp \\\n+  test/txvalidation_tests.cpp \\\n   test/txvalidationcache_tests.cpp \\\n   test/versionbits_tests.cpp \\\n   test/uint256_tests.cpp \\"
      },
      {
        "sha": "d6abe3e5a9973fcdc8ad6e1bc51529339df6dc29",
        "filename": "src/test/txvalidation_tests.cpp",
        "status": "added",
        "additions": 61,
        "deletions": 0,
        "changes": 61,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/65e91f5edf555691d0e5809d441cff7fa63ba722/src/test/txvalidation_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/65e91f5edf555691d0e5809d441cff7fa63ba722/src/test/txvalidation_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/txvalidation_tests.cpp?ref=65e91f5edf555691d0e5809d441cff7fa63ba722",
        "patch": "@@ -0,0 +1,61 @@\n+// Copyright (c) 2017 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <validation.h>\n+#include <txmempool.h>\n+#include <amount.h>\n+#include <consensus/validation.h>\n+#include <primitives/transaction.h>\n+#include <script/script.h>\n+#include <test/test_bitcoin.h>\n+\n+#include <boost/test/unit_test.hpp>\n+\n+\n+BOOST_AUTO_TEST_SUITE(txvalidation_tests)\n+\n+/**\n+ * Ensure that the mempool won't accept coinbase transactions.\n+ */\n+BOOST_FIXTURE_TEST_CASE(tx_mempool_reject_coinbase, TestChain100Setup)\n+{\n+    CScript scriptPubKey = CScript() << ToByteVector(coinbaseKey.GetPubKey()) << OP_CHECKSIG;\n+    CMutableTransaction coinbaseTx;\n+\n+    coinbaseTx.nVersion = 1;\n+    coinbaseTx.vin.resize(1);\n+    coinbaseTx.vout.resize(1);\n+    coinbaseTx.vin[0].scriptSig = CScript() << OP_11 << OP_EQUAL;\n+    coinbaseTx.vout[0].nValue = 1 * CENT;\n+    coinbaseTx.vout[0].scriptPubKey = scriptPubKey;\n+\n+    assert(CTransaction(coinbaseTx).IsCoinBase());\n+\n+    CValidationState state;\n+\n+    LOCK(cs_main);\n+\n+    unsigned int initialPoolSize = mempool.size();\n+\n+    BOOST_CHECK_EQUAL(\n+            false,\n+            AcceptToMemoryPool(mempool, state, MakeTransactionRef(coinbaseTx),\n+                nullptr /* pfMissingInputs */,\n+                nullptr /* plTxnReplaced */,\n+                true /* bypass_limits */,\n+                0 /* nAbsurdFee */));\n+\n+    // Check that the transaction hasn't been added to mempool.\n+    BOOST_CHECK_EQUAL(mempool.size(), initialPoolSize);\n+\n+    // Check that the validation state reflects the unsuccesful attempt.\n+    BOOST_CHECK(state.IsInvalid());\n+    BOOST_CHECK_EQUAL(state.GetRejectReason(), \"coinbase\");\n+\n+    int nDoS;\n+    BOOST_CHECK_EQUAL(state.IsInvalid(nDoS), true);\n+    BOOST_CHECK_EQUAL(nDoS, 100);\n+}\n+\n+BOOST_AUTO_TEST_SUITE_END()"
      }
    ]
  }
]