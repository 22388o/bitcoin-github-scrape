achow101,2021-06-14 20:13:45,"ACK ee5fb1f8dcdca66af992f05081c71703aa43fdff\n\nReviewed code and checked that the test fails on master but not on this PR.",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-860962286,860962286,
sipa,2021-06-14 21:55:06,~~utACK ee5fb1f8dcdca66af992f05081c71703aa43fdff~~,https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-861021033,861021033,
jnewbery,2021-06-15 09:52:55,ACK ee5fb1f8dcdca66af992f05081c71703aa43fdff,https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-861359211,861359211,
amitiuttarwar,2021-06-15 15:32:20,"thank you for the reviews! I force pushed to address [marco's comment](https://github.com/bitcoin/bitcoin/pull/22245#discussion_r651510247). the [diff](https://github.com/bitcoin/bitcoin/compare/ee5fb1f8dcdca66af992f05081c71703aa43fdff..89524b25efc397b9fb89536d827df3a600b6fbdf) is very small, so hopefully should be very easy to reACK. ",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-861602046,861602046,
MarcoFalke,2021-06-15 15:48:16,"easy re-ACK 89524b25efc397b9fb89536d827df3a600b6fbdf üè≥\n\n<details><summary>Show signature and timestamp</summary>\n\nSignature:\n\n```\n-----BEGIN PGP SIGNED MESSAGE-----\nHash: SHA512\n\neasy re-ACK 89524b25efc397b9fb89536d827df3a600b6fbdf üè≥\n-----BEGIN PGP SIGNATURE-----\n\niQGzBAEBCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\npUi0MAv/YQTTCEElYXs2V3M0yc4sL22r/0V9G0RBxJ",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-861614629,861614629,
jnewbery,2021-06-15 15:53:14,ACK 89524b25efc397b9fb89536d827df3a600b6fbdf,https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-861618500,861618500,
laanwj,2021-06-15 15:55:45,"We might want to update BIP155 for this (@vasild what do you think?). How I've always interpreted is that in principle, the `sendaddrv2` message means that the sending node supports v2 addr messages. This is orthogonal to whether it wants to receive address messages in the first place.\n\nI'm not opposed to combining these, though it's not clear to me how a node would signal it doesn't want to r",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-861620517,861620517,
jnewbery,2021-06-15 17:10:23,ACK 7c141b77764359dedc8815ce8484f42f87727dbe,https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-861677283,861677283,
amitiuttarwar,2021-06-15 17:14:52,"@MarcoFalke, @jnewbery - thanks for the quick re-reviews! \n\nsorry to have force-pushed again, but looking at #22243 made me realize I was introducing potential for a race here, so I added acquiring `p2p_lock` to the new tests. \n\n@laanwj \n> We might want to update BIP155 for this... \n\nAre you thinking something like ""Clients are NOT RECOMMENDED to send a `sendaddrv2` message if they a",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-861680794,861680794,
achow101,2021-06-15 22:14:03,"~~re-ACK 7c141b77764359dedc8815ce8484f42f87727dbe~~\n\nRescinding this as it seems this change is contentious.",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-861871032,861871032,
benthecarman,2021-06-15 22:34:20,re-ACK 7c141b77764359dedc8815ce8484f42f87727dbe,https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-861879181,861879181,
jonatack,2021-06-16 05:11:21,"The current implemented behavior of sendaddrv2 is a clean binary signal: BIP155 addrv2 format support true/false.  It may be good to update BIP155 to clarify that.\n\nConsequences of the proposed widening of sendaddrv2 semantics (if my thinking isn't muddled):\n\n- loss of signal: we can no longer know if a block-relay peer does not support addrv2\n\n- irreversibility: once propagated across",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-862044403,862044403,
jnewbery,2021-06-16 10:34:04,"@jonatack this was discussed briefly in the p2p irc meeting last night: https://www.erisian.com.au/bitcoin-core-dev/log-2021-06-15.html#l-284\n\nI agree with what @sipa said in that meeting:\n\n```\n304 2021-06-15T21:16:13  <sipa> if you don't care about addresses, sending sendaddrv2 is just irrelevant\n```\n\nBIP 155 is explicit about [what the sendaddrv2 message](https://github.com/bitco",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-862246086,862246086,
vasild,2021-06-16 10:53:12,"The `sendaddrv2` message has a very clear purpose - to announce that the peer who emitted it supports the `addrv2` format (and obviously prefers to receive `addrv2` instead of `addr`). This is [documented in BIP155](https://github.com/bitcoin/bips/blob/master/bip-0155.mediawiki#signaling-support-and-compatibility). If the semantic of `sendaddrv2` is to be changed, that should start by modifying BI",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-862279099,862279099,
vasild,2021-06-16 11:02:16,"> BIP 155 is explicit about [what the sendaddrv2 message](https://github.com/bitcoin/bips/blob/master/bip-0155.mediawiki#signaling-support-and-compatibility) means:\n> \n> > Introduce a new message type sendaddrv2. Sending such a message indicates that a node can understand and prefers to receive addrv2 messages instead of addr messages. I.e. ""Send me addrv2"".\n> \n> If a node doesn't wish to ",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-862284713,862284713,
mzumsande,2021-06-16 13:23:20,"I don't think that #21528 is strictly dependent on this PR, in that it would work less well without including SENDADDRV2 in the list of messages indicating willingness to participate in addr relay. There would still be  ADDR/ADDRV2 and GETADDR left as an indication.\n \nIn the short term, it might even work more precisely, because black-hole peers that  send out SENDADDRV2 without an intent to p",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-862376493,862376493,
jnewbery,2021-06-16 13:41:26,"> If the semantic of sendaddrv2 is to be changed, that should start by modifying BIP155\n\nThis PR is not changing the semantics of BIP155. It's simply changing the Bitcoin Core node behavior to not send a message that is irrelevant. If we ignore all addr messages on a connection, then there's absolutely no point in sending a message on that connection which says ""please send addrs in such-and-s",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-862390602,862390602,
vasild,2021-06-16 16:45:16,"The semantic of `sendaddrv2` is to announce support for the `addrv2` format (if you find the text in BIP155 vague, refer to the code - it does exactly that and the code not vague).\n\n> > If the semantic of sendaddrv2 is to be changed, that should start by modifying BIP155\n> \n> This PR is not changing the semantics of BIP155.\n\nThis PR+https://github.com/bitcoin/bitcoin/pull/21528 change ",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-862539375,862539375,
sipa,2021-06-16 19:33:25,"@vasild Am I correct in interpreting your position this way: address gossip is considered to be a well-defined aspect of the P2P protocol, and given that #21528 is changing the semantics of a number of messages, including `sendaddrv2`, that change matters. It's not specifically this PR you're concerned about, but the fact that 21528 is changing semantics (which this PR relies on), and those semant",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-862657075,862657075,
sdaftuar,2021-06-17 01:17:23,"> Would it ease your concerns if the interaction with `sendaddrv2` was removed (i.e., this PR closed, and `sendaddrv2` removed from triggering gossip in #21528)? My understanding is that it is only added for consistency reasons to 21528, and that that necessitates this PR. \n\nMy take is that the approach in #21528 ‚Äî of inferring addr relay heuristics from observed messages to improve network be",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-862839610,862839610,
ariard,2021-06-17 02:37:30,"> I do think the lack of clarity in the situation is unfortunate, and could be improved if someone wants to put in the work of analyzing the goals and expectations of address gossip, by writing up a specification for messages for explicitly opting in or out of address relay. That would supersede all this. I don't think it's necessary to formalize this aspect of the protocol before being able to ma",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-862870697,862870697,
sipa,2021-06-17 04:25:15,Another advantage of the exclude-sendaddrv2 approach is that it removes the pressure to get this PR in for 22.0 (or at all).,https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-862912847,862912847,
sipa,2021-06-17 21:43:48,"Given the discussion above, I'm retracting my ACK here. There just isn't much of a need to do this if we go the direction of dropping sendaddrv2 from triggering gossip in #21528.",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-863583586,863583586,
amitiuttarwar,2021-06-17 22:01:08,"I agree that this PR is not essential to achieving the aims of #21528, closing  this & will remove `sendaddrv2` as signal from that PR. ",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-863590937,863590937,
vasild,2021-06-18 09:54:03,"Everybody, thanks for your comments! I read everything carefully, slept over this and the following scenario came to my mind:\n\n`A` (outbound, blocks only) -> `B` (inbound)\n\n* `A` does not send `sendaddrv2` (because it is blocks-only, due to this PR)\n* `A` does not send `getaddr` (because it is blocks-only, as in `master`)\n* `B` sends `sendaddrv2`\n\nSo `B` thinks that `A` does not su",https://github.com/bitcoin/bitcoin/pull/22245#issuecomment-863914659,863914659,
MarcoFalke,2021-06-15 07:12:01,"question in ee5fb1f8dcdca66af992f05081c71703aa43fdff:\n\nIs there a reason for the sync_with_ping's? Ideally the `add_outbound_p2p_connection` helper should fully setup the connection (including handshake). And it seems it does do that, as there is a `p2p_conn.wait_for_verack()` and `p2p_conn.sync_with_ping()` inside.",https://github.com/bitcoin/bitcoin/pull/22245#discussion_r651510247,651510247,test/functional/p2p_addrv2_relay.py
amitiuttarwar,2021-06-15 15:16:23,"ah, agree its not necessary. I missed that there's already a `sync_with_ping()` inside `add_outbound_p2p_connection`, so I was adding buffer.",https://github.com/bitcoin/bitcoin/pull/22245#discussion_r651895231,651895231,test/functional/p2p_addrv2_relay.py
amitiuttarwar,2021-06-15 15:31:14,removed ,https://github.com/bitcoin/bitcoin/pull/22245#discussion_r651909326,651909326,test/functional/p2p_addrv2_relay.py
