[
  {
    "sha": "367a22fbe5060520f35af0290d29a423870d1638",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozNjdhMjJmYmU1MDYwNTIwZjM1YWYwMjkwZDI5YTQyMzg3MGQxNjM4",
    "commit": {
      "author": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-04-18T00:15:03Z"
      },
      "committer": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-04-18T00:15:03Z"
      },
      "message": "lock in on timeout",
      "tree": {
        "sha": "a841a20b1c00e34ceb97c13025aa66f42daec799",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a841a20b1c00e34ceb97c13025aa66f42daec799"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/367a22fbe5060520f35af0290d29a423870d1638",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/367a22fbe5060520f35af0290d29a423870d1638",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/367a22fbe5060520f35af0290d29a423870d1638",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/367a22fbe5060520f35af0290d29a423870d1638/comments",
    "author": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "329eafa7f4536524a569a9a14c7ca7fc02fad539",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/329eafa7f4536524a569a9a14c7ca7fc02fad539",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/329eafa7f4536524a569a9a14c7ca7fc02fad539"
      }
    ],
    "stats": {
      "total": 9,
      "additions": 8,
      "deletions": 1
    },
    "files": [
      {
        "sha": "74d9acf4795ad7a4f9cf5425f530e15004f18011",
        "filename": "src/consensus/params.h",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/367a22fbe5060520f35af0290d29a423870d1638/src/consensus/params.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/367a22fbe5060520f35af0290d29a423870d1638/src/consensus/params.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/consensus/params.h?ref=367a22fbe5060520f35af0290d29a423870d1638",
        "patch": "@@ -35,6 +35,11 @@ struct BIP9Deployment {\n      */\n     int min_activation_height{0};\n \n+    /** If the timeout is reached, should the deployment proceed to LOCKED_IN (true) or FAILED\n+     * (false).\n+     */\n+    bool flag_day_on_timeout{false};\n+\n     /** Constant for nTimeout very far in the future. */\n     static constexpr int64_t NO_TIMEOUT = std::numeric_limits<int64_t>::max();\n "
      },
      {
        "sha": "1fb6403e749fb94459ee91c855728353312449e9",
        "filename": "src/versionbits.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/367a22fbe5060520f35af0290d29a423870d1638/src/versionbits.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/367a22fbe5060520f35af0290d29a423870d1638/src/versionbits.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/versionbits.cpp?ref=367a22fbe5060520f35af0290d29a423870d1638",
        "patch": "@@ -75,7 +75,7 @@ ThresholdState AbstractThresholdConditionChecker::GetStateFor(const CBlockIndex*\n                 if (count >= nThreshold) {\n                     stateNext = ThresholdState::LOCKED_IN;\n                 } else if (pindexPrev->GetMedianTimePast() >= nTimeTimeout) {\n-                    stateNext = ThresholdState::FAILED;\n+                    stateNext = OnTimeout(params);\n                 }\n                 break;\n             }\n@@ -174,6 +174,7 @@ class VersionBitsConditionChecker : public AbstractThresholdConditionChecker {\n protected:\n     int64_t BeginTime(const Consensus::Params& params) const override { return params.vDeployments[id].nStartTime; }\n     int64_t EndTime(const Consensus::Params& params) const override { return params.vDeployments[id].nTimeout; }\n+    ThresholdState OnTimeout(const Consensus::Params& params) const override { return params.vDeployments[id].flag_day_on_timeout ? ThresholdState::LOCKED_IN : ThresholdState::FAILED; }\n     int MinActivationHeight(const Consensus::Params& params) const override { return params.vDeployments[id].min_activation_height; }\n     int Period(const Consensus::Params& params) const override { return params.nMinerConfirmationWindow; }\n     int Threshold(const Consensus::Params& params) const override { return params.nRuleChangeActivationThreshold; }"
      },
      {
        "sha": "d1b1d5d83572a178d12fe5449558878cd549de91",
        "filename": "src/versionbits.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/367a22fbe5060520f35af0290d29a423870d1638/src/versionbits.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/367a22fbe5060520f35af0290d29a423870d1638/src/versionbits.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/versionbits.h?ref=367a22fbe5060520f35af0290d29a423870d1638",
        "patch": "@@ -57,6 +57,7 @@ class AbstractThresholdConditionChecker {\n     virtual bool Condition(const CBlockIndex* pindex, const Consensus::Params& params) const =0;\n     virtual int64_t BeginTime(const Consensus::Params& params) const =0;\n     virtual int64_t EndTime(const Consensus::Params& params) const =0;\n+    virtual ThresholdState OnTimeout(const Consensus::Params& params) const { return ThresholdState::FAILED; }\n     virtual int MinActivationHeight(const Consensus::Params& params) const { return 0; }\n     virtual int Period(const Consensus::Params& params) const =0;\n     virtual int Threshold(const Consensus::Params& params) const =0;"
      }
    ]
  },
  {
    "sha": "5a030812dd6061a478c85d3da0967232ae9479a9",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1YTAzMDgxMmRkNjA2MWE0NzhjODVkM2RhMDk2NzIzMmFlOTQ3OWE5",
    "commit": {
      "author": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-04-18T00:45:00Z"
      },
      "committer": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-04-18T00:52:41Z"
      },
      "message": "add optional mandatory signalling",
      "tree": {
        "sha": "7d83843266d83205e96cc42e2e0af8f376a8a9b4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7d83843266d83205e96cc42e2e0af8f376a8a9b4"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5a030812dd6061a478c85d3da0967232ae9479a9",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5a030812dd6061a478c85d3da0967232ae9479a9",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/5a030812dd6061a478c85d3da0967232ae9479a9",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5a030812dd6061a478c85d3da0967232ae9479a9/comments",
    "author": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "367a22fbe5060520f35af0290d29a423870d1638",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/367a22fbe5060520f35af0290d29a423870d1638",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/367a22fbe5060520f35af0290d29a423870d1638"
      }
    ],
    "stats": {
      "total": 16,
      "additions": 16,
      "deletions": 0
    },
    "files": [
      {
        "sha": "30b24c37e66e7b7384ecb3ddcbaa59d70c113bc2",
        "filename": "src/consensus/params.h",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5a030812dd6061a478c85d3da0967232ae9479a9/src/consensus/params.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5a030812dd6061a478c85d3da0967232ae9479a9/src/consensus/params.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/consensus/params.h?ref=5a030812dd6061a478c85d3da0967232ae9479a9",
        "patch": "@@ -40,6 +40,10 @@ struct BIP9Deployment {\n      */\n     bool flag_day_on_timeout{false};\n \n+    /** When we are locked in does signaling become required until we are ACTIVE\n+     */\n+    bool mandatory_signaling_during_locked_in{false};\n+\n     /** Constant for nTimeout very far in the future. */\n     static constexpr int64_t NO_TIMEOUT = std::numeric_limits<int64_t>::max();\n "
      },
      {
        "sha": "b05971c81ceb04e95765c5d9a52520fb248fec8d",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 12,
        "deletions": 0,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5a030812dd6061a478c85d3da0967232ae9479a9/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5a030812dd6061a478c85d3da0967232ae9479a9/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=5a030812dd6061a478c85d3da0967232ae9479a9",
        "patch": "@@ -3531,6 +3531,18 @@ static bool ContextualCheckBlockHeader(const CBlockHeader& block, BlockValidatio\n             return state.Invalid(BlockValidationResult::BLOCK_INVALID_HEADER, strprintf(\"bad-version(0x%08x)\", block.nVersion),\n                                  strprintf(\"rejected nVersion=0x%08x block\", block.nVersion));\n \n+    auto consensus = params.GetConsensus();\n+    for (int deployment = 0; deployment < (int)Consensus::MAX_VERSION_BITS_DEPLOYMENTS; deployment++) {\n+        if (!consensus.vDeployments[deployment].mandatory_signaling_during_locked_in) continue;\n+        auto pos = static_cast<Consensus::DeploymentPos>(deployment);\n+        ThresholdState vbit_state = VersionBitsState(pindexPrev, consensus, pos, versionbitscache);\n+        if (vbit_state != ThresholdState::LOCKED_IN) continue;\n+        if (block.nVersion & VersionBitsMask(consensus, pos)) continue;\n+\n+        return state.Invalid(BlockValidationResult::BLOCK_INVALID_HEADER, strprintf(\"bad-version(0x%08x)\", block.nVersion),\n+                             strprintf(\"rejected nVersion=0x%08x block\", block.nVersion));\n+    }\n+\n     return true;\n }\n "
      }
    ]
  }
]