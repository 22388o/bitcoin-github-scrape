[
  {
    "sha": "0fd599767d2dabf25ac8c3543cb586cfc4b9d816",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowZmQ1OTk3NjdkMmRhYmYyNWFjOGMzNTQzY2I1ODZjZmM0YjlkODE2",
    "commit": {
      "author": {
        "name": "Patrick Strateman",
        "email": "patrick.strateman@gmail.com",
        "date": "2016-05-09T07:15:12Z"
      },
      "committer": {
        "name": "Patrick Strateman",
        "email": "patrick.strateman@gmail.com",
        "date": "2016-05-09T07:20:17Z"
      },
      "message": "Fix insanity of CWalletDB::WriteTx and CWalletTx::WriteToDisk",
      "tree": {
        "sha": "13c6a9ce0048dd662d98136caf0774a81619859e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/13c6a9ce0048dd662d98136caf0774a81619859e"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0fd599767d2dabf25ac8c3543cb586cfc4b9d816",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0fd599767d2dabf25ac8c3543cb586cfc4b9d816",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/0fd599767d2dabf25ac8c3543cb586cfc4b9d816",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0fd599767d2dabf25ac8c3543cb586cfc4b9d816/comments",
    "author": {
      "login": "pstratem",
      "id": 620611,
      "node_id": "MDQ6VXNlcjYyMDYxMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/620611?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pstratem",
      "html_url": "https://github.com/pstratem",
      "followers_url": "https://api.github.com/users/pstratem/followers",
      "following_url": "https://api.github.com/users/pstratem/following{/other_user}",
      "gists_url": "https://api.github.com/users/pstratem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pstratem/subscriptions",
      "organizations_url": "https://api.github.com/users/pstratem/orgs",
      "repos_url": "https://api.github.com/users/pstratem/repos",
      "events_url": "https://api.github.com/users/pstratem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pstratem/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "pstratem",
      "id": 620611,
      "node_id": "MDQ6VXNlcjYyMDYxMQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/620611?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pstratem",
      "html_url": "https://github.com/pstratem",
      "followers_url": "https://api.github.com/users/pstratem/followers",
      "following_url": "https://api.github.com/users/pstratem/following{/other_user}",
      "gists_url": "https://api.github.com/users/pstratem/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pstratem/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pstratem/subscriptions",
      "organizations_url": "https://api.github.com/users/pstratem/orgs",
      "repos_url": "https://api.github.com/users/pstratem/repos",
      "events_url": "https://api.github.com/users/pstratem/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pstratem/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "fbd84788e676c9cbd126f6236ec46bb2f342bd00",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fbd84788e676c9cbd126f6236ec46bb2f342bd00",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/fbd84788e676c9cbd126f6236ec46bb2f342bd00"
      }
    ],
    "stats": {
      "total": 28,
      "additions": 10,
      "deletions": 18
    },
    "files": [
      {
        "sha": "d6895b80f53bc224358e3f80a970229223d42b58",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 10,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0fd599767d2dabf25ac8c3543cb586cfc4b9d816/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0fd599767d2dabf25ac8c3543cb586cfc4b9d816/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=0fd599767d2dabf25ac8c3543cb586cfc4b9d816",
        "patch": "@@ -729,7 +729,7 @@ bool CWallet::AddToWallet(const CWalletTx& wtxIn, bool fFromLoadWallet, CWalletD\n \n         // Write to disk\n         if (fInsertedNew || fUpdated)\n-            if (!wtx.WriteToDisk(pwalletdb))\n+            if (!pwalletdb->WriteTx(wtx))\n                 return false;\n \n         // Break debit/credit balance caches:\n@@ -829,7 +829,7 @@ bool CWallet::AbandonTransaction(const uint256& hashTx)\n             wtx.nIndex = -1;\n             wtx.setAbandoned();\n             wtx.MarkDirty();\n-            wtx.WriteToDisk(&walletdb);\n+            walletdb.WriteTx(wtx);\n             NotifyTransactionChanged(this, wtx.GetHash(), CT_UPDATED);\n             // Iterate over all its outputs, and mark transactions in the wallet that spend them abandoned too\n             TxSpends::const_iterator iter = mapTxSpends.lower_bound(COutPoint(hashTx, 0));\n@@ -891,7 +891,7 @@ void CWallet::MarkConflicted(const uint256& hashBlock, const uint256& hashTx)\n             wtx.nIndex = -1;\n             wtx.hashBlock = hashBlock;\n             wtx.MarkDirty();\n-            wtx.WriteToDisk(&walletdb);\n+            walletdb.WriteTx(wtx);\n             // Iterate over all its outputs, and mark transactions in the wallet that spend them conflicted too\n             TxSpends::const_iterator iter = mapTxSpends.lower_bound(COutPoint(now, 0));\n             while (iter != mapTxSpends.end() && iter->first.hash == now) {\n@@ -1186,12 +1186,6 @@ void CWalletTx::GetAccountAmounts(const string& strAccount, CAmount& nReceived,\n     }\n }\n \n-\n-bool CWalletTx::WriteToDisk(CWalletDB *pwalletdb)\n-{\n-    return pwalletdb->WriteTx(GetHash(), *this);\n-}\n-\n /**\n  * Scan the block chain (starting in pindexStart) for transactions\n  * from or to us. If fUpdate is true, found transactions that already\n@@ -3194,7 +3188,7 @@ bool CWallet::InitLoadWallet()\n                     copyTo->fFromMe = copyFrom->fFromMe;\n                     copyTo->strFromAccount = copyFrom->strFromAccount;\n                     copyTo->nOrderPos = copyFrom->nOrderPos;\n-                    copyTo->WriteToDisk(&walletdb);\n+                    walletdb.WriteTx(*copyTo);\n                 }\n             }\n         }"
      },
      {
        "sha": "cc568c3749b7c8e9f1e4242131c186db10343ee6",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 0,
        "deletions": 2,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0fd599767d2dabf25ac8c3543cb586cfc4b9d816/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0fd599767d2dabf25ac8c3543cb586cfc4b9d816/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=0fd599767d2dabf25ac8c3543cb586cfc4b9d816",
        "patch": "@@ -394,8 +394,6 @@ class CWalletTx : public CMerkleTx\n     bool InMempool() const;\n     bool IsTrusted() const;\n \n-    bool WriteToDisk(CWalletDB *pwalletdb);\n-\n     int64_t GetTxTime() const;\n     int GetRequestCount() const;\n "
      },
      {
        "sha": "48579b2821e8e83ddfb9e14d596b0a92ff902b2c",
        "filename": "src/wallet/walletdb.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 5,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0fd599767d2dabf25ac8c3543cb586cfc4b9d816/src/wallet/walletdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0fd599767d2dabf25ac8c3543cb586cfc4b9d816/src/wallet/walletdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.cpp?ref=0fd599767d2dabf25ac8c3543cb586cfc4b9d816",
        "patch": "@@ -55,10 +55,10 @@ bool CWalletDB::ErasePurpose(const string& strPurpose)\n     return Erase(make_pair(string(\"purpose\"), strPurpose));\n }\n \n-bool CWalletDB::WriteTx(uint256 hash, const CWalletTx& wtx)\n+bool CWalletDB::WriteTx(const CWalletTx& wtx)\n {\n     nWalletDBUpdated++;\n-    return Write(std::make_pair(std::string(\"tx\"), hash), wtx);\n+    return Write(std::make_pair(std::string(\"tx\"), wtx.GetHash()), wtx);\n }\n \n bool CWalletDB::EraseTx(uint256 hash)\n@@ -291,7 +291,7 @@ DBErrors CWalletDB::ReorderTransactions(CWallet* pwallet)\n \n             if (pwtx)\n             {\n-                if (!WriteTx(pwtx->GetHash(), *pwtx))\n+                if (!WriteTx(*pwtx))\n                     return DB_LOAD_FAIL;\n             }\n             else\n@@ -315,7 +315,7 @@ DBErrors CWalletDB::ReorderTransactions(CWallet* pwallet)\n             // Since we're changing the order, write it back\n             if (pwtx)\n             {\n-                if (!WriteTx(pwtx->GetHash(), *pwtx))\n+                if (!WriteTx(*pwtx))\n                     return DB_LOAD_FAIL;\n             }\n             else\n@@ -698,7 +698,7 @@ DBErrors CWalletDB::LoadWallet(CWallet* pwallet)\n         pwallet->nTimeFirstKey = 1; // 0 would be considered 'no value'\n \n     BOOST_FOREACH(uint256 hash, wss.vWalletUpgrade)\n-        WriteTx(hash, pwallet->mapWallet[hash]);\n+        WriteTx(pwallet->mapWallet[hash]);\n \n     // Rewrite encrypted wallets of versions 0.4.0 and 0.5.0rc:\n     if (wss.fIsEncrypted && (wss.nFileVersion == 40000 || wss.nFileVersion == 50000))"
      },
      {
        "sha": "5345c0907e9cd00e2159a7b9a451fe69190c1c25",
        "filename": "src/wallet/walletdb.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0fd599767d2dabf25ac8c3543cb586cfc4b9d816/src/wallet/walletdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0fd599767d2dabf25ac8c3543cb586cfc4b9d816/src/wallet/walletdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.h?ref=0fd599767d2dabf25ac8c3543cb586cfc4b9d816",
        "patch": "@@ -87,7 +87,7 @@ class CWalletDB : public CDB\n     bool WritePurpose(const std::string& strAddress, const std::string& purpose);\n     bool ErasePurpose(const std::string& strAddress);\n \n-    bool WriteTx(uint256 hash, const CWalletTx& wtx);\n+    bool WriteTx(const CWalletTx& wtx);\n     bool EraseTx(uint256 hash);\n \n     bool WriteKey(const CPubKey& vchPubKey, const CPrivKey& vchPrivKey, const CKeyMetadata &keyMeta);"
      }
    ]
  }
]