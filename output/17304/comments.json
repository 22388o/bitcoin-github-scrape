[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547606545",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-547606545",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
    "id": 547606545,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0NzYwNjU0NQ==",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-29T20:07:47Z",
    "updated_at": "2019-11-02T01:35:46Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#17283](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17283.html) (rpc: improve getaddressinfo test coverage, help, code docs by jonatack)\n* [#17237](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/17237.html) (wallet: LearnRelatedScripts only if KeepDestination by promag)\n* [#16946](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16946.html) (wallet: include a checksum of encrypted private keys by achow101)\n* [#16910](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16910.html) (wallet: reduce loading time by using unordered maps by achow101)\n* [#16224](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/16224.html) (gui: Bilingual GUI error messages by hebasto)\n* [#15761](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15761.html) (Replace -upgradewallet startup option with upgradewallet RPC by achow101)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547606545/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547660167",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-547660167",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
    "id": 547660167,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0NzY2MDE2Nw==",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-29T22:37:44Z",
    "updated_at": "2019-10-29T22:37:44Z",
    "author_association": "CONTRIBUTOR",
    "body": "Not sure what your preference is @achow101, but it might be a good idea to replace #17261 with #17304 on the high priority review list https://github.com/bitcoin/bitcoin/projects/8, since #17261 builds on #17304.\r\n\r\nThis PR is also just making small and mostly obvious changes, so it should be more approachable for reviewers.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547660167/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547665962",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-547665962",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
    "id": 547665962,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0NzY2NTk2Mg==",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?u=9791e96cd4268d48e3517bac41eaf2b1d09759fd&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-29T22:58:10Z",
    "updated_at": "2019-10-29T22:58:10Z",
    "author_association": "MEMBER",
    "body": "> Not sure what your preference is @achow101, but it might be a good idea to replace #17261 with #17304 on the high priority review list https://github.com/bitcoin/bitcoin/projects/8, since #17261 builds on #17304.\r\n\r\nYeah, it should replace that. #17261 was added to the list before I made this pr.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547665962/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547956698",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-547956698",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
    "id": 547956698,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0Nzk1NjY5OA==",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-30T15:13:49Z",
    "updated_at": "2019-10-30T15:13:49Z",
    "author_association": "MEMBER",
    "body": "mac build errors\r\n```\r\nMakefile:8720: recipe for target 'wallet/libbitcoin_wallet_a-scriptpubkeyman.o' failed\r\nwallet/scriptpubkeyman.cpp:399:9: error: calling function 'MarkPreSplitKeys' requires holding mutex 'cs_wallet' exclusively [-Werror,-Wthread-safety-analysis]\r\n        MarkPreSplitKeys();\r\n        ^\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/547956698/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548374757",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-548374757",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
    "id": 548374757,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0ODM3NDc1Nw==",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-31T13:28:48Z",
    "updated_at": "2019-10-31T13:28:48Z",
    "author_association": "CONTRIBUTOR",
    "body": "This PR has 18 commits, so it could be useful to get some Approach ACKS here on whether it's a reasonable size, or should be made smaller by dropping some number of commits, or dropping particular commits that seem more difficult to review. All of the commits should be small and straightforward, but it is also easily possible to scale back this PR if necessary.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548374757/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548486346",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-548486346",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
    "id": 548486346,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0ODQ4NjM0Ng==",
    "user": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url": "https://api.github.com/users/Sjors/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-31T17:32:52Z",
    "updated_at": "2019-10-31T17:32:52Z",
    "author_association": "MEMBER",
    "body": "I'm going through these commits now. I've seen this code a few times before, but if others want to eject one or more commits to get it merged faster, that could make sense. ",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548486346/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548548719",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-548548719",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
    "id": 548548719,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0ODU0ODcxOQ==",
    "user": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url": "https://api.github.com/users/Sjors/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-10-31T20:11:09Z",
    "updated_at": "2019-11-01T16:16:17Z",
    "author_association": "MEMBER",
    "body": "Code review ACK up to b04a526aea91ba4caddbde1a1313a1dbf46bc5e5.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/548548719/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/549034165",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-549034165",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
    "id": 549034165,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0OTAzNDE2NQ==",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?u=13b19d1ff2f5f914e180c41418f451a4ba6f8bd1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-11-02T11:17:02Z",
    "updated_at": "2019-11-02T11:17:02Z",
    "author_association": "MEMBER",
    "body": "code review ACK 152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/549034165/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/549064296",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-549064296",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
    "id": 549064296,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0OTA2NDI5Ng==",
    "user": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url": "https://api.github.com/users/Sjors/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-11-02T17:27:04Z",
    "updated_at": "2019-11-02T17:27:04Z",
    "author_association": "MEMBER",
    "body": "re-ACK 152b0a00d8e681dd098f6b548447b82ab54ebe3c\r\n\r\nIf you can append a commit to get rid of `unused variable` warnings in rpcdump.cpp that would be nice though (see #17338 by @jonatack).\r\n\r\n```\r\n wallet/rpcdump.cpp:137:28: error: unused variable 'spk_man' [-Werror,-Wunused-variable]\r\n    LegacyScriptPubKeyMan& spk_man = GetLegacyScriptPubKeyMan(*wallet);\r\n```",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/549064296/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/549184711",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#issuecomment-549184711",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/17304",
    "id": 549184711,
    "node_id": "MDEyOklzc3VlQ29tbWVudDU0OTE4NDcxMQ==",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?u=4a9af998e1a560b3f49c3827f453e1bcbe6a5cfb&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2019-11-03T22:15:35Z",
    "updated_at": "2019-11-03T22:15:35Z",
    "author_association": "MEMBER",
    "body": "Code review ACK 152b0a00d8e681dd098f6b548447b82ab54ebe3c.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/549184711/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340280978",
    "pull_request_review_id": 308776012,
    "id": 340280978,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDI4MDk3OA==",
    "diff_hunk": "@@ -320,8 +320,7 @@ void LegacyScriptPubKeyMan::UpgradeKeyMetadata()\n             }\n         }\n     }\n-    batch.reset(); //write before setting the flag\n-    m_storage.SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);\n+    batch.reset();",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": null,
    "original_position": 6,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "a5ca4664e74201a08cef1d147ed4446fd74784f8",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Refactor: Move SetWalletFlag out of LegacyScriptPubKeyMan::UpgradeKeyMetadata\" (a5ca4664e74201a08cef1d147ed4446fd74784f8)\r\n\r\nCould drop this reset line since batch is going out of scope anyway.",
    "created_at": "2019-10-29T19:26:40Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340280978",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340280978"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340280978"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340280978/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 323,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340285227",
    "pull_request_review_id": 308776012,
    "id": 340285227,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDI4NTIyNw==",
    "diff_hunk": "@@ -320,8 +320,7 @@ void LegacyScriptPubKeyMan::UpgradeKeyMetadata()\n             }\n         }\n     }\n-    batch.reset(); //write before setting the flag\n-    m_storage.SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 74,
    "original_position": 5,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "a5ca4664e74201a08cef1d147ed4446fd74784f8",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Refactor: Move SetWalletFlag out of LegacyScriptPubKeyMan::UpgradeKeyMetadata\" (a5ca4664e74201a08cef1d147ed4446fd74784f8):\r\n\r\nWould it be possible to drop the WalletStorage SetWalletFlag method entirely after this? I don't see another call even in #17261",
    "created_at": "2019-10-29T19:37:10Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340285227",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340285227"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340285227"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340285227/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 302,
    "original_line": 302,
    "side": "LEFT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340290082",
    "pull_request_review_id": 308776012,
    "id": 340290082,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDI5MDA4Mg==",
    "diff_hunk": "@@ -874,7 +874,8 @@ void LegacyScriptPubKeyMan::SetHDSeed(const CPubKey& seed)\n     newHdChain.seed_id = seed.GetID();\n     SetHDChain(newHdChain, false);\n     NotifyCanGetAddressesChanged();\n-    m_wallet.UnsetWalletFlag(WALLET_FLAG_BLANK_WALLET);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    m_storage.UnsetWalletFlagWithDB(batch, WALLET_FLAG_BLANK_WALLET);",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": null,
    "original_position": 6,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "d35a98b6e04a3750c48bf21af64d0375fe2ae395",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Refactor: Remove UnsetWalletFlag call from LegacyScriptPubKeyMan::SetHDSeed\" (d35a98b6e04a3750c48bf21af64d0375fe2ae395)\r\n\r\nAll the UnsetWalletFlagWithDB calls are just unsetting `WALLET_FLAG_BLANK_WALLET`. Maybe WalletStorage should just have a specific `UnsetBlankWalletFlag` method and not expose more general flag set/unset methods. With multiple key managers per wallet, it might be safer if individual key managers don't have ability to arbitrarily set flags shared with other key managers.",
    "created_at": "2019-10-29T19:48:42Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340290082",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340290082"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340290082"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340290082/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 878,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340291130",
    "pull_request_review_id": 308776012,
    "id": 340291130,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDI5MTEzMA==",
    "diff_hunk": "@@ -1401,9 +1401,17 @@ bool CWallet::ImportScriptPubKeys(const std::string& label, const std::set<CScri\n         return false;\n     }\n     AssertLockHeld(spk_man->cs_wallet);\n-    if (!spk_man->ImportScriptPubKeys(label, script_pub_keys, have_solving_data, apply_label, timestamp)) {\n+    if (!spk_man->ImportScriptPubKeys(script_pub_keys, have_solving_data, timestamp)) {\n         return false;\n     }\n+    WalletBatch batch(*database);",
    "path": "src/wallet/wallet.cpp",
    "position": null,
    "original_position": 8,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "974d7749f1d9e55a01a2e30db2bdf6b89c18baff",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Refactor: Move SetAddressBookWithDB call out of LegacyScriptPubKeyMan::ImportScriptPubKeys\" (974d7749f1d9e55a01a2e30db2bdf6b89c18baff)\r\n\r\nCould skip this whole block of code if `apply_label` is false",
    "created_at": "2019-10-29T19:51:00Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340291130",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340291130"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340291130"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340291130/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1407,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340296308",
    "pull_request_review_id": 308776012,
    "id": 340296308,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDI5NjMwOA==",
    "diff_hunk": "@@ -3756,26 +3756,24 @@ UniValue getaddressinfo(const JSONRPCRequest& request)\n         ret.pushKV(\"label\", pwallet->mapAddressBook[dest].name);\n     }\n     ret.pushKV(\"ischange\", pwallet->IsChange(scriptPubKey));\n-    const CKeyMetadata* meta = nullptr;\n-    CKeyID key_id = GetKeyForDestination(*provider, dest);\n-    if (!key_id.IsNull()) {\n-        auto it = pwallet->mapKeyMetadata.find(key_id);\n-        if (it != pwallet->mapKeyMetadata.end()) {\n-            meta = &it->second;\n+\n+    ScriptPubKeyMan* spk_man = pwallet->GetScriptPubKeyMan();\n+    if (spk_man) {\n+        CKeyID key_id = GetKeyForDestination(*provider, dest);\n+        const CKeyMetadata* meta = nullptr;\n+        if (!key_id.IsNull()) {\n+            meta = spk_man->GetMetadata(key_id);\n         }\n-    }\n-    if (!meta) {\n-        auto it = pwallet->m_script_metadata.find(CScriptID(scriptPubKey));\n-        if (it != pwallet->m_script_metadata.end()) {\n-            meta = &it->second;\n+        if (!meta) {\n+            meta = spk_man->GetMetadata(CScriptID(scriptPubKey));",
    "path": "src/wallet/rpcwallet.cpp",
    "position": 24,
    "original_position": 24,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "bdb538d2fa8b171f1a96580a0f0a7395d52b336e",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Refactor: Move GetMetadata code out of getaddressinfo\" (bdb538d2fa8b171f1a96580a0f0a7395d52b336e)\r\n\r\nIt doesn't seem strictly true that this commit doesn't change behavior. Before the code was looking up `key_id` only in `mapKeyMetadata` and `CScriptID(scriptPubKey)` only in `m_script_metadata`. Now it is looking up both values in both maps, which I guess is fine, but maybe more confusing and less efficient.\r\n\r\nI think it'd probably be clearer and more type-safe to have separate `GetKeyMetadata` and `GetScriptMetadata` methods.",
    "created_at": "2019-10-29T20:02:42Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340296308",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340296308"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340296308"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340296308/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3768,
    "original_line": 3768,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340299078",
    "pull_request_review_id": 308776012,
    "id": 340299078,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDI5OTA3OA==",
    "diff_hunk": "@@ -287,6 +287,23 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int size)\n     return TopUpKeyPool(size);\n }\n \n+void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    AssertLockHeld(cs_wallet);",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 51,
    "original_position": 6,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "8c47cb9202e27a86609d7b3af91dee1f09468125",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Refactor: Move MarkUnusedAddresses code out of CWallet::AddToWalletIfInvolvingMe\" (8c47cb9202e27a86609d7b3af91dee1f09468125)\r\n\r\nNote for other reviews: lock assert added here is needed to satisfy clang lock annotations and be able to call `MarkReserveKeysAsUsed` below. This line will be replaced by `LOCK(cs_KeyStore);` later in commit \"Locking: Lock cs_KeyStore instead of cs_main in legacy keyman\" 87cc2282b278d3891fc59823d883eef112606da9 from #17261",
    "created_at": "2019-10-29T20:09:20Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340299078",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340299078"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340299078"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340299078/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 292,
    "original_line": 292,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340307903",
    "pull_request_review_id": 308776012,
    "id": 340307903,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDMwNzkwMw==",
    "diff_hunk": "@@ -287,6 +287,23 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int size)\n     return TopUpKeyPool(size);\n }\n \n+void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    AssertLockHeld(cs_wallet);\n+    // extract addresses and check if they match with an unused keypool key\n+    for (const auto& keyid : GetAffectedKeys(script, *this)) {\n+        std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n+        if (mi != m_pool_key_to_index.end()) {\n+            WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool key up to this key as used\\n\", __func__);\n+            MarkReserveKeysAsUsed(mi->second);\n+\n+            if (!TopUpKeyPool()) {",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 59,
    "original_position": 14,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "8c47cb9202e27a86609d7b3af91dee1f09468125",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Refactor: Move MarkUnusedAddresses code out of CWallet::AddToWalletIfInvolvingMe\" (8c47cb9202e27a86609d7b3af91dee1f09468125)\r\n\r\nNote for other reviewers: The `LegacyScriptPubKeyMan::TopUp` call in the previous code is changed to a `LegacyScriptPubKeyMan::TopUpKeyPool` call here. The two methods will do the exact same thing even after all the other changes in #17261, so there is no difference in behavior.\r\n\r\nIt seems like the pattern is just to always call `TopUp()` externally and always call `TopUpKeyPool()` internally, but it's not clear why the two methods are separate and I think it probably would clearer to combine them.",
    "created_at": "2019-10-29T20:28:43Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340307903",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340307903"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340307903"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340307903/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 300,
    "original_line": 300,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340311958",
    "pull_request_review_id": 308776012,
    "id": 340311958,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDMxMTk1OA==",
    "diff_hunk": "@@ -265,6 +265,31 @@ bool LegacyScriptPubKeyMan::EncryptKeys(CKeyingMaterial& vMasterKeyIn)\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool)\n+{\n+    {\n+        if (!ReserveKeyFromKeyPool(index, keypool, internal)) {\n+            return false;\n+        }\n+    }\n+    return true;\n+}\n+\n+void LegacyScriptPubKeyMan::KeepDestination(int64_t index)\n+{\n+    KeepKey(index);\n+}\n+\n+void LegacyScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, const CPubKey& pubkey)\n+{\n+    ReturnKey(index, internal, pubkey);\n+}",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 42,
    "original_position": 22,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "80a44800f35c3183edd8fc0914ed8edbd5c5887b",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Refactor: Add new ScriptPubKeyMan virtual methods\" (80a44800f35c3183edd8fc0914ed8edbd5c5887b)\r\n\r\nNote for other reviewers: after future changes in #17261 there are some differences in functionality between the Reserve/Keep/Return **destination** methods and the Reserve/Keep/Return **key** methods, and they are called from different places, so there's some justification for keeping them separate, though I think ideally we could follow up by combining them, or at least making clear what the differences in behavior are supposed to be between the two sets of functions.",
    "created_at": "2019-10-29T20:37:41Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340311958",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340311958"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340311958"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340311958/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": 265,
    "original_start_line": 268,
    "start_side": "RIGHT",
    "line": 283,
    "original_line": 283,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340314846",
    "pull_request_review_id": 308776012,
    "id": 340314846,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDMxNDg0Ng==",
    "diff_hunk": "@@ -362,6 +362,41 @@ bool LegacyScriptPubKeyMan::CanGetAddresses(bool internal)\n     return keypool_has_keys;\n }\n \n+bool LegacyScriptPubKeyMan::Upgrade(int prev_version, std::string& error)\n+{\n+    AssertLockHeld(cs_wallet);",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 97,
    "original_position": 6,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "3814d7550ca2d53a9aa1613d61f79dc72b95770b",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Refactor: Move Upgrade code out of CWallet::CreateWalletFromFile\" (3814d7550ca2d53a9aa1613d61f79dc72b95770b)\r\n\r\nI think this added lock assert line is not actually necessary and could be dropped. Clang compiler seems fine without out it as of this commit.",
    "created_at": "2019-10-29T20:43:34Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340314846",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340314846"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340314846"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340314846/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 379,
    "original_line": 379,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340321878",
    "pull_request_review_id": 308776012,
    "id": 340321878,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDMyMTg3OA==",
    "diff_hunk": "@@ -3794,8 +3794,12 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         // No need to read and scan block if block was created before\n         // our wallet birthday (as adjusted for block time variability)\n-        if (walletInstance->nTimeFirstKey) {\n-            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(walletInstance->nTimeFirstKey - TIMESTAMP_WINDOW, rescan_height, nullptr)) {\n+        int64_t time_first_key = std::numeric_limits<int64_t>::max();\n+        if (auto spk_man = walletInstance->m_spk_man.get()) {\n+            time_first_key = std::min(time_first_key, spk_man->GetTimeFirstKey());\n+        }\n+        if (time_first_key) {\n+            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(time_first_key - TIMESTAMP_WINDOW, rescan_height, nullptr)) {",
    "path": "src/wallet/wallet.cpp",
    "position": null,
    "original_position": 11,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "e1b1702449a9172185d4bfb5e9043748328132ee",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Refactor: Move nTimeFirstKey accesses out of CWallet\" (e1b1702449a9172185d4bfb5e9043748328132ee)\r\n\r\nI think the numeric_limits approach is not the clearest here, because if wallet doesn't have any key managers, the code winds up calling `findFirstBlock` with an strange `0x7fffffffffffffff - TIMESTAMP_WINDOW` value.\r\n\r\nBetter I think to use optional instead:\r\n\r\n```c++\r\nOptional<int64_t> first_time;\r\nif (auto spk_man = walletInstance->m_spk_man.get()) {\r\n    int64_t time = spk_man->GetTimeFirstKey();\r\n    if (!first_time || time < *first_time) first_time = time;\r\n}\r\nif (time_first_key) {\r\n    if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(*first_time - TIMESTAMP_WINDOW, rescan_height, nullptr)) {\r\n        rescan_height = *first_block;\r\n    }\r\n}\r\n```",
    "created_at": "2019-10-29T20:58:42Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340321878",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340321878"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340321878"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340321878/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 3797,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 3802,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340326092",
    "pull_request_review_id": 308776012,
    "id": 340326092,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDMyNjA5Mg==",
    "diff_hunk": "@@ -3623,15 +3625,12 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         walletInstance->SetWalletFlags(wallet_creation_flags, false);\n         if (!(wallet_creation_flags & (WALLET_FLAG_DISABLE_PRIVATE_KEYS | WALLET_FLAG_BLANK_WALLET))) {\n-            // generate a new seed\n-            CPubKey seed = walletInstance->m_spk_man->GenerateNewSeed();\n-            walletInstance->m_spk_man->SetHDSeed(seed);\n-        }\n-\n-        // Top up the keypool\n-        if (walletInstance->m_spk_man->CanGenerateKeys() && !walletInstance->m_spk_man->TopUp()) {",
    "path": "src/wallet/wallet.cpp",
    "position": null,
    "original_position": 41,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "f95750d52a21a69ad55db8422f10c563fb9e08ac",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Refactor: Move SetupGeneration code out of CWallet\" (f95750d52a21a69ad55db8422f10c563fb9e08ac)\r\n\r\nNote for other reviews: Previous code was calling TopUp, while new code is calling SetupGeneration which calls NewKeyPool which calls TopUpKeyPool. I think the effect is basically the same because fFirstRun is true here so the additional ErasePool calls in NewKeyPool should have no effect.",
    "created_at": "2019-10-29T21:07:57Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340326092",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340326092"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340326092"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340326092/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3632,
    "side": "LEFT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340329325",
    "pull_request_review_id": 308776012,
    "id": 340329325,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDMyOTMyNQ==",
    "diff_hunk": "@@ -210,9 +210,11 @@ WalletCreationStatus CreateWallet(interfaces::Chain& chain, const SecureString&\n             }\n \n             // Set a seed for the wallet\n-            CPubKey master_pub_key = wallet->m_spk_man->GenerateNewSeed();\n-            wallet->m_spk_man->SetHDSeed(master_pub_key);\n-            wallet->m_spk_man->NewKeyPool();\n+            {\n+                if (auto spk_man = wallet->m_spk_man.get()) {\n+                    spk_man->SetupGeneration();",
    "path": "src/wallet/wallet.cpp",
    "position": null,
    "original_position": 9,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "f95750d52a21a69ad55db8422f10c563fb9e08ac",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Refactor: Move SetupGeneration code out of CWallet\" (f95750d52a21a69ad55db8422f10c563fb9e08ac)\r\n\r\nShould this be checking the return code from SetupGeneration and setting an error if it fails? Old code wasn't checking the return value from NewKeyPool either, but that doesn't seem right.",
    "created_at": "2019-10-29T21:15:26Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340329325",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340329325"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340329325"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340329325/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 215,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340345745",
    "pull_request_review_id": 308860327,
    "id": 340345745,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM0NTc0NQ==",
    "diff_hunk": "@@ -3756,26 +3756,24 @@ UniValue getaddressinfo(const JSONRPCRequest& request)\n         ret.pushKV(\"label\", pwallet->mapAddressBook[dest].name);\n     }\n     ret.pushKV(\"ischange\", pwallet->IsChange(scriptPubKey));\n-    const CKeyMetadata* meta = nullptr;\n-    CKeyID key_id = GetKeyForDestination(*provider, dest);\n-    if (!key_id.IsNull()) {\n-        auto it = pwallet->mapKeyMetadata.find(key_id);\n-        if (it != pwallet->mapKeyMetadata.end()) {\n-            meta = &it->second;\n+\n+    ScriptPubKeyMan* spk_man = pwallet->GetScriptPubKeyMan();\n+    if (spk_man) {\n+        CKeyID key_id = GetKeyForDestination(*provider, dest);\n+        const CKeyMetadata* meta = nullptr;\n+        if (!key_id.IsNull()) {\n+            meta = spk_man->GetMetadata(key_id);\n         }\n-    }\n-    if (!meta) {\n-        auto it = pwallet->m_script_metadata.find(CScriptID(scriptPubKey));\n-        if (it != pwallet->m_script_metadata.end()) {\n-            meta = &it->second;\n+        if (!meta) {\n+            meta = spk_man->GetMetadata(CScriptID(scriptPubKey));",
    "path": "src/wallet/rpcwallet.cpp",
    "position": 24,
    "original_position": 24,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "bdb538d2fa8b171f1a96580a0f0a7395d52b336e",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "From the ScriptPubKeyMan design view, it doesn't make sense to have different metadata for keys and scripts, at least exposed publicly to the wallet. It should really be `GetMetadata` that takes a scriptPubKey, but it fit better to use uint160 for right now.",
    "created_at": "2019-10-29T21:57:30Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340345745",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340345745"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340345745"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340345745/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3768,
    "original_line": 3768,
    "side": "RIGHT",
    "in_reply_to_id": 340296308
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340349757",
    "pull_request_review_id": 308865371,
    "id": 340349757,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM0OTc1Nw==",
    "diff_hunk": "@@ -320,8 +320,7 @@ void LegacyScriptPubKeyMan::UpgradeKeyMetadata()\n             }\n         }\n     }\n-    batch.reset(); //write before setting the flag\n-    m_storage.SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);\n+    batch.reset();",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": null,
    "original_position": 6,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "a5ca4664e74201a08cef1d147ed4446fd74784f8",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done",
    "created_at": "2019-10-29T22:09:29Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340349757",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340349757"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340349757"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340349757/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 323,
    "side": "RIGHT",
    "in_reply_to_id": 340280978
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340349989",
    "pull_request_review_id": 308865694,
    "id": 340349989,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM0OTk4OQ==",
    "diff_hunk": "@@ -320,8 +320,7 @@ void LegacyScriptPubKeyMan::UpgradeKeyMetadata()\n             }\n         }\n     }\n-    batch.reset(); //write before setting the flag\n-    m_storage.SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 74,
    "original_position": 5,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "a5ca4664e74201a08cef1d147ed4446fd74784f8",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Added a commit dropping SetWalletFlag. Also checked it isn't being used in Descriptor wallets.",
    "created_at": "2019-10-29T22:10:21Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340349989",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340349989"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340349989"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340349989/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 302,
    "original_line": 302,
    "side": "LEFT",
    "in_reply_to_id": 340285227
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350744",
    "pull_request_review_id": 308866623,
    "id": 340350744,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM1MDc0NA==",
    "diff_hunk": "@@ -874,7 +874,8 @@ void LegacyScriptPubKeyMan::SetHDSeed(const CPubKey& seed)\n     newHdChain.seed_id = seed.GetID();\n     SetHDChain(newHdChain, false);\n     NotifyCanGetAddressesChanged();\n-    m_wallet.UnsetWalletFlag(WALLET_FLAG_BLANK_WALLET);\n+    WalletBatch batch(m_storage.GetDatabase());\n+    m_storage.UnsetWalletFlagWithDB(batch, WALLET_FLAG_BLANK_WALLET);",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": null,
    "original_position": 6,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "d35a98b6e04a3750c48bf21af64d0375fe2ae395",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Added a commit changing those to UnsetBlankWalletFlag. Also checked DescriptorScriptPubKeyMan doesn't use UnsetWalletFlag.",
    "created_at": "2019-10-29T22:12:35Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350744",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350744"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350744"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350744/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 878,
    "side": "RIGHT",
    "in_reply_to_id": 340290082
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350776",
    "pull_request_review_id": 308866655,
    "id": 340350776,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM1MDc3Ng==",
    "diff_hunk": "@@ -1401,9 +1401,17 @@ bool CWallet::ImportScriptPubKeys(const std::string& label, const std::set<CScri\n         return false;\n     }\n     AssertLockHeld(spk_man->cs_wallet);\n-    if (!spk_man->ImportScriptPubKeys(label, script_pub_keys, have_solving_data, apply_label, timestamp)) {\n+    if (!spk_man->ImportScriptPubKeys(script_pub_keys, have_solving_data, timestamp)) {\n         return false;\n     }\n+    WalletBatch batch(*database);",
    "path": "src/wallet/wallet.cpp",
    "position": null,
    "original_position": 8,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "974d7749f1d9e55a01a2e30db2bdf6b89c18baff",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done",
    "created_at": "2019-10-29T22:12:41Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350776",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350776"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350776"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350776/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1407,
    "side": "RIGHT",
    "in_reply_to_id": 340291130
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350809",
    "pull_request_review_id": 308866704,
    "id": 340350809,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM1MDgwOQ==",
    "diff_hunk": "@@ -362,6 +362,41 @@ bool LegacyScriptPubKeyMan::CanGetAddresses(bool internal)\n     return keypool_has_keys;\n }\n \n+bool LegacyScriptPubKeyMan::Upgrade(int prev_version, std::string& error)\n+{\n+    AssertLockHeld(cs_wallet);",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 97,
    "original_position": 6,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "3814d7550ca2d53a9aa1613d61f79dc72b95770b",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Removed",
    "created_at": "2019-10-29T22:12:48Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350809",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350809"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350809"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350809/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 379,
    "original_line": 379,
    "side": "RIGHT",
    "in_reply_to_id": 340314846
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350852",
    "pull_request_review_id": 308866769,
    "id": 340350852,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM1MDg1Mg==",
    "diff_hunk": "@@ -3794,8 +3794,12 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         // No need to read and scan block if block was created before\n         // our wallet birthday (as adjusted for block time variability)\n-        if (walletInstance->nTimeFirstKey) {\n-            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(walletInstance->nTimeFirstKey - TIMESTAMP_WINDOW, rescan_height, nullptr)) {\n+        int64_t time_first_key = std::numeric_limits<int64_t>::max();\n+        if (auto spk_man = walletInstance->m_spk_man.get()) {\n+            time_first_key = std::min(time_first_key, spk_man->GetTimeFirstKey());\n+        }\n+        if (time_first_key) {\n+            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(time_first_key - TIMESTAMP_WINDOW, rescan_height, nullptr)) {",
    "path": "src/wallet/wallet.cpp",
    "position": null,
    "original_position": 11,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "e1b1702449a9172185d4bfb5e9043748328132ee",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Made it an optional",
    "created_at": "2019-10-29T22:12:56Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350852",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350852"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340350852"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340350852/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 3797,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 3802,
    "side": "RIGHT",
    "in_reply_to_id": 340321878
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340351629",
    "pull_request_review_id": 308867696,
    "id": 340351629,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDM1MTYyOQ==",
    "diff_hunk": "@@ -210,9 +210,11 @@ WalletCreationStatus CreateWallet(interfaces::Chain& chain, const SecureString&\n             }\n \n             // Set a seed for the wallet\n-            CPubKey master_pub_key = wallet->m_spk_man->GenerateNewSeed();\n-            wallet->m_spk_man->SetHDSeed(master_pub_key);\n-            wallet->m_spk_man->NewKeyPool();\n+            {\n+                if (auto spk_man = wallet->m_spk_man.get()) {\n+                    spk_man->SetupGeneration();",
    "path": "src/wallet/wallet.cpp",
    "position": null,
    "original_position": 9,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "f95750d52a21a69ad55db8422f10c563fb9e08ac",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "It should. Done.",
    "created_at": "2019-10-29T22:15:12Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340351629",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340351629"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340351629"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340351629/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 215,
    "side": "RIGHT",
    "in_reply_to_id": 340329325
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340580879",
    "pull_request_review_id": 309156187,
    "id": 340580879,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDU4MDg3OQ==",
    "diff_hunk": "@@ -362,6 +362,41 @@ bool LegacyScriptPubKeyMan::CanGetAddresses(bool internal)\n     return keypool_has_keys;\n }\n \n+bool LegacyScriptPubKeyMan::Upgrade(int prev_version, std::string& error)\n+{\n+    AssertLockHeld(cs_wallet);",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 97,
    "original_position": 6,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "3814d7550ca2d53a9aa1613d61f79dc72b95770b",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "re: https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340314846\r\n\r\n> Removed\r\n\r\nThe lock assert probably needs to be added back. I'm not sure why clang for me wasn't showing the same error, but clang on travis legitimately errors that it needs the assert to call `MarkPreSplitKeys():\r\n\r\n```\r\nwallet/scriptpubkeyman.cpp:399:9: error: calling function 'MarkPreSplitKeys' requires holding mutex 'cs_wallet' exclusively [-Werror,-Wthread-safety-analysis]\r\n        MarkPreSplitKeys();\r\n```",
    "created_at": "2019-10-30T12:20:14Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340580879",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340580879"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340580879"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340580879/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 379,
    "original_line": 379,
    "side": "RIGHT",
    "in_reply_to_id": 340314846
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340688363",
    "pull_request_review_id": 309298572,
    "id": 340688363,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MDY4ODM2Mw==",
    "diff_hunk": "@@ -362,6 +362,41 @@ bool LegacyScriptPubKeyMan::CanGetAddresses(bool internal)\n     return keypool_has_keys;\n }\n \n+bool LegacyScriptPubKeyMan::Upgrade(int prev_version, std::string& error)\n+{\n+    AssertLockHeld(cs_wallet);",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 97,
    "original_position": 6,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "3814d7550ca2d53a9aa1613d61f79dc72b95770b",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Added it back in.",
    "created_at": "2019-10-30T15:29:13Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340688363",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340688363"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340688363"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/340688363/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 379,
    "original_line": 379,
    "side": "RIGHT",
    "in_reply_to_id": 340314846
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341194391",
    "pull_request_review_id": 309955208,
    "id": 341194391,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTE5NDM5MQ==",
    "diff_hunk": "@@ -265,6 +265,31 @@ bool LegacyScriptPubKeyMan::EncryptKeys(CKeyingMaterial& vMasterKeyIn)\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool)\n+{\n+    {",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 26,
    "original_position": 6,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "80a44800f35c3183edd8fc0914ed8edbd5c5887b",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "why the scope here?",
    "created_at": "2019-10-31T15:09:22Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341194391",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341194391"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341194391"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341194391/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 267,
    "original_line": 267,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341210205",
    "pull_request_review_id": 309955208,
    "id": 341210205,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTIxMDIwNQ==",
    "diff_hunk": "@@ -3804,8 +3804,13 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         // No need to read and scan block if block was created before\n         // our wallet birthday (as adjusted for block time variability)\n-        if (walletInstance->nTimeFirstKey) {\n-            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(walletInstance->nTimeFirstKey - TIMESTAMP_WINDOW, rescan_height, nullptr)) {\n+        Optional<int64_t> time_first_key;\n+        if (auto spk_man = walletInstance->m_spk_man.get()) {\n+            int64_t time = spk_man->GetTimeFirstKey();\n+            if (!time_first_key || time < *time_first_key) time_first_key = time;",
    "path": "src/wallet/wallet.cpp",
    "position": 320,
    "original_position": 9,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I realize this is stopping mid-way, but this was slightly confusing. Add a comment saying this is temporarily going to always be true until a loop is introduced?",
    "created_at": "2019-10-31T15:35:38Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341210205",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341210205"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341210205"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341210205/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3810,
    "original_line": 3810,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341229485",
    "pull_request_review_id": 310001130,
    "id": 341229485,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTIyOTQ4NQ==",
    "diff_hunk": "@@ -265,6 +265,31 @@ bool LegacyScriptPubKeyMan::EncryptKeys(CKeyingMaterial& vMasterKeyIn)\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool)\n+{\n+    {",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 26,
    "original_position": 6,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "80a44800f35c3183edd8fc0914ed8edbd5c5887b",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "A lock is going to be added in the next step",
    "created_at": "2019-10-31T16:08:04Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341229485",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341229485"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341229485"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341229485/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 267,
    "original_line": 267,
    "side": "RIGHT",
    "in_reply_to_id": 341194391
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341230007",
    "pull_request_review_id": 310001828,
    "id": 341230007,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTIzMDAwNw==",
    "diff_hunk": "@@ -3804,8 +3804,13 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         // No need to read and scan block if block was created before\n         // our wallet birthday (as adjusted for block time variability)\n-        if (walletInstance->nTimeFirstKey) {\n-            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(walletInstance->nTimeFirstKey - TIMESTAMP_WINDOW, rescan_height, nullptr)) {\n+        Optional<int64_t> time_first_key;\n+        if (auto spk_man = walletInstance->m_spk_man.get()) {\n+            int64_t time = spk_man->GetTimeFirstKey();\n+            if (!time_first_key || time < *time_first_key) time_first_key = time;",
    "path": "src/wallet/wallet.cpp",
    "position": 320,
    "original_position": 9,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "That generally applies throughout this PR. So I guess a note to reviewers in the thread should be good enough?",
    "created_at": "2019-10-31T16:09:00Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341230007",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341230007"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341230007"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341230007/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3810,
    "original_line": 3810,
    "side": "RIGHT",
    "in_reply_to_id": 341210205
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341233720",
    "pull_request_review_id": 310006783,
    "id": 341233720,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTIzMzcyMA==",
    "diff_hunk": "@@ -3804,8 +3804,13 @@ std::shared_ptr<CWallet> CWallet::CreateWalletFromFile(interfaces::Chain& chain,\n \n         // No need to read and scan block if block was created before\n         // our wallet birthday (as adjusted for block time variability)\n-        if (walletInstance->nTimeFirstKey) {\n-            if (Optional<int> first_block = locked_chain->findFirstBlockWithTimeAndHeight(walletInstance->nTimeFirstKey - TIMESTAMP_WINDOW, rescan_height, nullptr)) {\n+        Optional<int64_t> time_first_key;\n+        if (auto spk_man = walletInstance->m_spk_man.get()) {\n+            int64_t time = spk_man->GetTimeFirstKey();\n+            if (!time_first_key || time < *time_first_key) time_first_key = time;",
    "path": "src/wallet/wallet.cpp",
    "position": 320,
    "original_position": 9,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "b04a526aea91ba4caddbde1a1313a1dbf46bc5e5",
    "user": {
      "login": "instagibbs",
      "id": 5767891,
      "node_id": "MDQ6VXNlcjU3Njc4OTE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5767891?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/instagibbs",
      "html_url": "https://github.com/instagibbs",
      "followers_url": "https://api.github.com/users/instagibbs/followers",
      "following_url": "https://api.github.com/users/instagibbs/following{/other_user}",
      "gists_url": "https://api.github.com/users/instagibbs/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/instagibbs/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/instagibbs/subscriptions",
      "organizations_url": "https://api.github.com/users/instagibbs/orgs",
      "repos_url": "https://api.github.com/users/instagibbs/repos",
      "events_url": "https://api.github.com/users/instagibbs/events{/privacy}",
      "received_events_url": "https://api.github.com/users/instagibbs/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "ok! Consider this your note, future reviewers ",
    "created_at": "2019-10-31T16:15:35Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341233720",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341233720"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341233720"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341233720/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3810,
    "original_line": 3810,
    "side": "RIGHT",
    "in_reply_to_id": 341210205
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341258866",
    "pull_request_review_id": 310040055,
    "id": 341258866,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTI1ODg2Ng==",
    "diff_hunk": "@@ -265,6 +265,31 @@ bool LegacyScriptPubKeyMan::EncryptKeys(CKeyingMaterial& vMasterKeyIn)\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool)\n+{\n+    {",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 26,
    "original_position": 6,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "80a44800f35c3183edd8fc0914ed8edbd5c5887b",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> A lock is going to be added in the next step\r\n\r\nThe scope isn't needed even with the lock and all other changes from #17261:\r\n\r\nhttps://github.com/bitcoin/bitcoin/blob/35b0f7b5447bce4eef360c7e4237a928bb0eba3c/src/wallet/scriptpubkeyman.cpp#L275-L290\r\n\r\nBut I don't think it's a big deal. Could clean this up later if reservekey and reservedestination methods are merged later (https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340311958)",
    "created_at": "2019-10-31T17:03:17Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341258866",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341258866"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341258866"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341258866/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 267,
    "original_line": 267,
    "side": "RIGHT",
    "in_reply_to_id": 341194391
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341280713",
    "pull_request_review_id": 310068608,
    "id": 341280713,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTI4MDcxMw==",
    "diff_hunk": "@@ -265,6 +265,31 @@ bool LegacyScriptPubKeyMan::EncryptKeys(CKeyingMaterial& vMasterKeyIn)\n     return true;\n }\n \n+bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool)\n+{\n+    {",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 26,
    "original_position": 6,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "80a44800f35c3183edd8fc0914ed8edbd5c5887b",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I'll just leave this as is so it can get merged sooner :)",
    "created_at": "2019-10-31T17:46:14Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341280713",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341280713"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341280713"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341280713/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 267,
    "original_line": 267,
    "side": "RIGHT",
    "in_reply_to_id": 341194391
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341286026",
    "pull_request_review_id": 310075600,
    "id": 341286026,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTI4NjAyNg==",
    "diff_hunk": "@@ -561,11 +566,11 @@ bool CWallet::EncryptWallet(const SecureString& strWalletPassphrase)\n         Unlock(strWalletPassphrase);\n \n         // if we are using HD, replace the HD seed with a new one\n-        if (m_spk_man->IsHDEnabled()) {\n-            m_spk_man->SetHDSeed(m_spk_man->GenerateNewSeed());\n+        if (auto spk_man = m_spk_man.get()) {\n+            if (spk_man->IsHDEnabled()) {\n+                spk_man->SetupGeneration(true);",
    "path": "src/wallet/wallet.cpp",
    "position": 51,
    "original_position": 26,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "ef97f0b5451e4959c0d0bf649a71eec9b226210e",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"Refactor: Move SetupGeneration code out of CWallet\" (ef97f0b5451e4959c0d0bf649a71eec9b226210e)\r\n\r\nNo need to change now, but it seems like it'd probably be a good idea to check for an error from SetupGeneration here as well.",
    "created_at": "2019-10-31T17:56:29Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341286026",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341286026"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341286026"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341286026/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 575,
    "original_line": 575,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341296610",
    "pull_request_review_id": 310089570,
    "id": 341296610,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTI5NjYxMA==",
    "diff_hunk": "@@ -287,6 +287,23 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int size)\n     return TopUpKeyPool(size);\n }\n \n+void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    AssertLockHeld(cs_wallet);\n+    // extract addresses and check if they match with an unused keypool key\n+    for (const auto& keyid : GetAffectedKeys(script, *this)) {\n+        std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n+        if (mi != m_pool_key_to_index.end()) {\n+            WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool key up to this key as used\\n\", __func__);\n+            MarkReserveKeysAsUsed(mi->second);\n+\n+            if (!TopUpKeyPool()) {",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 59,
    "original_position": 14,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "8c47cb9202e27a86609d7b3af91dee1f09468125",
    "user": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url": "https://api.github.com/users/Sjors/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I'm also a bit confused about the distinction between `TopUpKeyPool()` and `Topup()`. In the native descriptor wallet PR there's an internal call to `Topup()` inside `DescriptorScriptPubKeyMan::GetNewDestination` and `DescriptorScriptPubKeyMan::MarkUnusedAddresses`: https://github.com/bitcoin/bitcoin/pull/16528/files#diff-5462ceb8a760a507152ab8b76bd48774R1459",
    "created_at": "2019-10-31T18:17:49Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341296610",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341296610"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341296610"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341296610/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 300,
    "original_line": 300,
    "side": "RIGHT",
    "in_reply_to_id": 340307903
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341304705",
    "pull_request_review_id": 310100328,
    "id": 341304705,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTMwNDcwNQ==",
    "diff_hunk": "@@ -287,6 +287,23 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int size)\n     return TopUpKeyPool(size);\n }\n \n+void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    AssertLockHeld(cs_wallet);\n+    // extract addresses and check if they match with an unused keypool key\n+    for (const auto& keyid : GetAffectedKeys(script, *this)) {\n+        std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n+        if (mi != m_pool_key_to_index.end()) {\n+            WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool key up to this key as used\\n\", __func__);\n+            MarkReserveKeysAsUsed(mi->second);\n+\n+            if (!TopUpKeyPool()) {",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 59,
    "original_position": 14,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "8c47cb9202e27a86609d7b3af91dee1f09468125",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In `LegacyScriptPubKeyMan`, `TopUp()` and `TopUpKeyPool()` are the same. Since `TopUpKeyPool` was already being used throughout existing `CWallet` code that was moved into `LegacyScriptPubKeyMan`, I decided to let those calls just keep using `TopUpKeyPool`. But for the `ScriptPubKeyMan` interface itself, I wanted it to be named `TopUp` because that conceptually made more sense than calling it `TopUpKeyPool`.",
    "created_at": "2019-10-31T18:35:05Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341304705",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341304705"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341304705"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341304705/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 300,
    "original_line": 300,
    "side": "RIGHT",
    "in_reply_to_id": 340307903
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341309043",
    "pull_request_review_id": 310106196,
    "id": 341309043,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTMwOTA0Mw==",
    "diff_hunk": "@@ -287,6 +287,23 @@ bool LegacyScriptPubKeyMan::TopUp(unsigned int size)\n     return TopUpKeyPool(size);\n }\n \n+void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+{\n+    AssertLockHeld(cs_wallet);\n+    // extract addresses and check if they match with an unused keypool key\n+    for (const auto& keyid : GetAffectedKeys(script, *this)) {\n+        std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n+        if (mi != m_pool_key_to_index.end()) {\n+            WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool key up to this key as used\\n\", __func__);\n+            MarkReserveKeysAsUsed(mi->second);\n+\n+            if (!TopUpKeyPool()) {",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 59,
    "original_position": 14,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "8c47cb9202e27a86609d7b3af91dee1f09468125",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Any reason you would not want to rename TopUpKeyPool method to TopUp and call it everywhere instead of having two LegacyScriptPubKeyMan methods that do the same thing?",
    "created_at": "2019-10-31T18:44:56Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341309043",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341309043"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341309043"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341309043/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 300,
    "original_line": 300,
    "side": "RIGHT",
    "in_reply_to_id": 340307903
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341790747",
    "pull_request_review_id": 310745877,
    "id": 341790747,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTc5MDc0Nw==",
    "diff_hunk": "@@ -282,6 +296,7 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n     //! Fetches a pubkey from mapWatchKeys if it exists there\n     bool GetWatchPubKey(const CKeyID &address, CPubKey &pubkey_out) const;\n \n+    /* SigningProvider overrides */",
    "path": "src/wallet/scriptpubkeyman.h",
    "position": 272,
    "original_position": 52,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "8bdac65e4c705f9f55c93b43792d036229cc9d5a",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "8bdac65e4c705f9f55c93b43792d036229cc9d5a\r\n\r\nSorry for nit picking here, but is this really necessary? What should be the rule of thumb?",
    "created_at": "2019-11-02T00:42:52Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341790747",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341790747"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341790747"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341790747/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 349,
    "original_line": 349,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341791285",
    "pull_request_review_id": 310745877,
    "id": 341791285,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTc5MTI4NQ==",
    "diff_hunk": "@@ -3038,12 +3038,17 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n \n bool CWallet::GetNewDestination(const OutputType type, const std::string label, CTxDestination& dest, std::string& error)\n {\n+    LOCK(cs_wallet);\n     error.clear();\n     bool result = false;\n     auto spk_man = m_spk_man.get();\n     if (spk_man) {\n-        result = spk_man->GetNewDestination(type, label, dest, error);\n+        result = spk_man->GetNewDestination(type, dest, error);\n+    }\n+    if (result) {",
    "path": "src/wallet/wallet.cpp",
    "position": 196,
    "original_position": 12,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "bf5f6c5214706ef61f80c46063061a624c3d505b",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "bf5f6c5214706ef61f80c46063061a624c3d505b\r\n\r\nThis should be in the above `if`?",
    "created_at": "2019-11-02T00:50:03Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341791285",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341791285"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341791285"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341791285/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3059,
    "original_line": 3059,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341791687",
    "pull_request_review_id": 310745877,
    "id": 341791687,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTc5MTY4Nw==",
    "diff_hunk": "@@ -253,6 +253,7 @@ void CWallet::UpgradeKeyMetadata()\n     if (m_spk_man) {\n         m_spk_man->UpgradeKeyMetadata();\n     }\n+    SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);",
    "path": "src/wallet/wallet.cpp",
    "position": 39,
    "original_position": 4,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "2590266c193d27c979ad6287d72555ca3df630bc",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "2590266c193d27c979ad6287d72555ca3df630bc\r\n\r\nWhat if `IsLocked()`?",
    "created_at": "2019-11-02T00:55:26Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341791687",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341791687"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341791687"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341791687/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 263,
    "original_line": 263,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341792533",
    "pull_request_review_id": 310745877,
    "id": 341792533,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTc5MjUzMw==",
    "diff_hunk": "@@ -1406,9 +1406,19 @@ bool CWallet::ImportScriptPubKeys(const std::string& label, const std::set<CScri\n         return false;\n     }\n     AssertLockHeld(spk_man->cs_wallet);\n-    if (!spk_man->ImportScriptPubKeys(label, script_pub_keys, have_solving_data, apply_label, timestamp)) {\n+    if (!spk_man->ImportScriptPubKeys(script_pub_keys, have_solving_data, timestamp)) {\n         return false;\n     }\n+    if (apply_label) {\n+        WalletBatch batch(*database);",
    "path": "src/wallet/wallet.cpp",
    "position": 100,
    "original_position": 9,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "26fef3a525fd98f8205fd2f859f476fbf2cc6fcd",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "26fef3a525fd98f8205fd2f859f476fbf2cc6fcd\r\n\r\nJust noting that there's actually a behavior change here - now if `LegacyScriptPubKeyMan::ImportScriptPubKeys` fails __no label is applied__.\r\n\r\nAlso, another change, which I think is harmless, is that now 2 batches are always used - easily \"reverted\" by passing the batch to `LegacyScriptPubKeyMan::ImportScriptPubKeys` from this method.",
    "created_at": "2019-11-02T01:06:35Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341792533",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341792533"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341792533"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341792533/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1411,
    "original_line": 1411,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796022",
    "pull_request_review_id": 310752018,
    "id": 341796022,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTc5NjAyMg==",
    "diff_hunk": "@@ -253,6 +253,7 @@ void CWallet::UpgradeKeyMetadata()\n     if (m_spk_man) {\n         m_spk_man->UpgradeKeyMetadata();\n     }\n+    SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);",
    "path": "src/wallet/wallet.cpp",
    "position": 39,
    "original_position": 4,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "2590266c193d27c979ad6287d72555ca3df630bc",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "re: https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341791687\r\n\r\n> [2590266](https://github.com/bitcoin/bitcoin/commit/2590266c193d27c979ad6287d72555ca3df630bc)\r\n> \r\n> What if `IsLocked()`?\r\n\r\nNice catch! This seems like a bug. I think either the `m_storage.IsLocked() || m_storage.IsWalletFlagSet(WALLET_FLAG_KEY_ORIGIN_METADATA)` check should move from `LegacyScriptPubKeyMan::UpgradeKeyMetadata` to\r\n`CWallet::UpgradeKeyMetadata`, or preferably, the`SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA)` call should move back in the other direction.\r\n\r\nIt's also unclear why `UpgradeKeyMetadata` shoud be a virtual method instead of being specific to the LegacyScriptPubKeyMan class. It doesn't seem like non-legacy keyman types should implement this upgrade function or be accessing this wallet flag.",
    "created_at": "2019-11-02T02:34:51Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341796022",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796022"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341796022"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796022/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 263,
    "original_line": 263,
    "side": "RIGHT",
    "in_reply_to_id": 341791687
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796248",
    "pull_request_review_id": 310752322,
    "id": 341796248,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTc5NjI0OA==",
    "diff_hunk": "@@ -253,6 +253,7 @@ void CWallet::UpgradeKeyMetadata()\n     if (m_spk_man) {\n         m_spk_man->UpgradeKeyMetadata();\n     }\n+    SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);",
    "path": "src/wallet/wallet.cpp",
    "position": 39,
    "original_position": 4,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "2590266c193d27c979ad6287d72555ca3df630bc",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "It seems like the `CWallet::UpgradeKeyMetadata()` and `ScriptPubKeyMan::::UpgradeKeyMetadata()` methods could both be dropped and `walletdb.cpp` could call `pwallet->GetLegacyScriptPubKeyMan()` and `LegacyScriptPubKeyMan::UpgradeKeyMetadata` directly for compatibility.",
    "created_at": "2019-11-02T02:42:12Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341796248",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796248"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341796248"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796248/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 263,
    "original_line": 263,
    "side": "RIGHT",
    "in_reply_to_id": 341791687
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796317",
    "pull_request_review_id": 310752437,
    "id": 341796317,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTc5NjMxNw==",
    "diff_hunk": "@@ -282,6 +296,7 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n     //! Fetches a pubkey from mapWatchKeys if it exists there\n     bool GetWatchPubKey(const CKeyID &address, CPubKey &pubkey_out) const;\n \n+    /* SigningProvider overrides */",
    "path": "src/wallet/scriptpubkeyman.h",
    "position": 272,
    "original_position": 52,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "8bdac65e4c705f9f55c93b43792d036229cc9d5a",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Is what necessary?",
    "created_at": "2019-11-02T02:44:57Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341796317",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796317"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341796317"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796317/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 349,
    "original_line": 349,
    "side": "RIGHT",
    "in_reply_to_id": 341790747
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796358",
    "pull_request_review_id": 310752483,
    "id": 341796358,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTc5NjM1OA==",
    "diff_hunk": "@@ -3038,12 +3038,17 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n \n bool CWallet::GetNewDestination(const OutputType type, const std::string label, CTxDestination& dest, std::string& error)\n {\n+    LOCK(cs_wallet);\n     error.clear();\n     bool result = false;\n     auto spk_man = m_spk_man.get();\n     if (spk_man) {\n-        result = spk_man->GetNewDestination(type, label, dest, error);\n+        result = spk_man->GetNewDestination(type, dest, error);\n+    }\n+    if (result) {",
    "path": "src/wallet/wallet.cpp",
    "position": 196,
    "original_position": 12,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "bf5f6c5214706ef61f80c46063061a624c3d505b",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Does it really matter?",
    "created_at": "2019-11-02T02:46:14Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341796358",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796358"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341796358"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796358/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3059,
    "original_line": 3059,
    "side": "RIGHT",
    "in_reply_to_id": 341791285
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796453",
    "pull_request_review_id": 310752608,
    "id": 341796453,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTc5NjQ1Mw==",
    "diff_hunk": "@@ -1406,9 +1406,19 @@ bool CWallet::ImportScriptPubKeys(const std::string& label, const std::set<CScri\n         return false;\n     }\n     AssertLockHeld(spk_man->cs_wallet);\n-    if (!spk_man->ImportScriptPubKeys(label, script_pub_keys, have_solving_data, apply_label, timestamp)) {\n+    if (!spk_man->ImportScriptPubKeys(script_pub_keys, have_solving_data, timestamp)) {\n         return false;\n     }\n+    if (apply_label) {\n+        WalletBatch batch(*database);",
    "path": "src/wallet/wallet.cpp",
    "position": 100,
    "original_position": 9,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "26fef3a525fd98f8205fd2f859f476fbf2cc6fcd",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Those are harmless. `ImportScriptPubKeys` only fails when writing to the database fails, so you'll have bigger problems if that happens.",
    "created_at": "2019-11-02T02:49:37Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341796453",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796453"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341796453"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796453/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1411,
    "original_line": 1411,
    "side": "RIGHT",
    "in_reply_to_id": 341792533
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796623",
    "pull_request_review_id": 310752853,
    "id": 341796623,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTc5NjYyMw==",
    "diff_hunk": "@@ -253,6 +253,7 @@ void CWallet::UpgradeKeyMetadata()\n     if (m_spk_man) {\n         m_spk_man->UpgradeKeyMetadata();\n     }\n+    SetWalletFlag(WALLET_FLAG_KEY_ORIGIN_METADATA);",
    "path": "src/wallet/wallet.cpp",
    "position": 39,
    "original_position": 4,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "2590266c193d27c979ad6287d72555ca3df630bc",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Changed to be non-virtual and moved that check out to CWallet.",
    "created_at": "2019-11-02T02:55:55Z",
    "updated_at": "2019-11-02T03:00:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341796623",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796623"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341796623"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341796623/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 263,
    "original_line": 263,
    "side": "RIGHT",
    "in_reply_to_id": 341791687
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341805525",
    "pull_request_review_id": 310764148,
    "id": 341805525,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTgwNTUyNQ==",
    "diff_hunk": "@@ -282,6 +296,7 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n     //! Fetches a pubkey from mapWatchKeys if it exists there\n     bool GetWatchPubKey(const CKeyID &address, CPubKey &pubkey_out) const;\n \n+    /* SigningProvider overrides */",
    "path": "src/wallet/scriptpubkeyman.h",
    "position": 272,
    "original_position": 52,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "8bdac65e4c705f9f55c93b43792d036229cc9d5a",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "The category comment.",
    "created_at": "2019-11-02T10:02:38Z",
    "updated_at": "2019-11-02T10:02:39Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341805525",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341805525"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341805525"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341805525/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 349,
    "original_line": 349,
    "side": "RIGHT",
    "in_reply_to_id": 341790747
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341805626",
    "pull_request_review_id": 310764274,
    "id": 341805626,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM0MTgwNTYyNg==",
    "diff_hunk": "@@ -3038,12 +3038,17 @@ bool CWallet::TopUpKeyPool(unsigned int kpSize)\n \n bool CWallet::GetNewDestination(const OutputType type, const std::string label, CTxDestination& dest, std::string& error)\n {\n+    LOCK(cs_wallet);\n     error.clear();\n     bool result = false;\n     auto spk_man = m_spk_man.get();\n     if (spk_man) {\n-        result = spk_man->GetNewDestination(type, label, dest, error);\n+        result = spk_man->GetNewDestination(type, dest, error);\n+    }\n+    if (result) {",
    "path": "src/wallet/wallet.cpp",
    "position": 196,
    "original_position": 12,
    "commit_id": "152b0a00d8e681dd098f6b548447b82ab54ebe3c",
    "original_commit_id": "bf5f6c5214706ef61f80c46063061a624c3d505b",
    "user": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "No, just that it looks like a leftover where before result could be changed in between. \r\n\r\nActually I think this would look better without the result variable.\r\n\r\nYou can resolve this.",
    "created_at": "2019-11-02T10:06:47Z",
    "updated_at": "2019-11-02T10:06:47Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341805626",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341805626"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341805626"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/17304"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/341805626/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3059,
    "original_line": 3059,
    "side": "RIGHT",
    "in_reply_to_id": 341791285
  }
]