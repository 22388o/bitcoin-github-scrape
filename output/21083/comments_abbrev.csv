DrahtBot,2021-02-05 07:59:26,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21207 (MOVEONLY: CWallet transaction code out of wallet.cpp/.h by ryanofsky)\n* #17526 (Use Single Random Draw In additio",https://github.com/bitcoin/bitcoin/pull/21083#issuecomment-773864616,773864616,
jonatack,2021-02-06 18:08:18,"Concept ACK, was thinking about this as well",https://github.com/bitcoin/bitcoin/pull/21083#issuecomment-774517656,774517656,
meshcollider,2021-02-16 22:02:35,Concept / light-look-through ACK,https://github.com/bitcoin/bitcoin/pull/21083#issuecomment-780146178,780146178,
fjahr,2021-03-14 02:03:10,"Code review ACK 7b4b48f6aa186d878984ae14727e5fa203f0d9b6\n\nThe code is definitely an improvement and can be merged as-is.\n\nLooking at #19229 I was skeptical initially that this would fix it fully because, even though nobody said It explicitly, I assume some people have tried running the command multiple times. It sounded like it was a particular tx that caused these issues, rather than it j",https://github.com/bitcoin/bitcoin/pull/21083#issuecomment-798819608,798819608,
chappjc,2021-03-15 16:17:38,"> even though nobody said It explicitly, I assume some people have tried running the command multiple times\n\nThat's correct, @fjahr, we have observed that a retry can still be met with the error.  Bad luck maybe?\n\nIf a 0.21 backport branch were available, I might be able to try this out.",https://github.com/bitcoin/bitcoin/pull/21083#issuecomment-799549600,799549600,
achow101,2021-03-16 17:43:43,@chappjc Here is a branch of this PR backported to 0.21: https://github.com/achow101/bitcoin/tree/0.21-createtx-same-feerate,https://github.com/bitcoin/bitcoin/pull/21083#issuecomment-800473457,800473457,
glozow,2021-03-16 21:35:12,"reACK https://github.com/bitcoin/bitcoin/commit/f9cd2bfbccb7a2b8ff07cec5f6d2adbeca5f07c3\n\nChanges since last review:\n- Rename effective_fee to m_effective_feerate\n- Remove unnecessary `CFeeRate(0)`s in declaration\n- Grab long term target from `longStats` instead of hard-coding 1008",https://github.com/bitcoin/bitcoin/pull/21083#issuecomment-800621854,800621854,
fjahr,2021-03-16 22:04:40,"Code review re-ACK f9cd2bfbccb7a2b8ff07cec5f6d2adbeca5f07c3\n\nChecked range-diff since last review.",https://github.com/bitcoin/bitcoin/pull/21083#issuecomment-800644001,800644001,
fjahr,2021-03-18 00:01:56,"> > even though nobody said It explicitly, I assume some people have tried running the command multiple times\n> \n> That's correct, @fjahr, we have observed that a retry can still be met with the error. Bad luck maybe?\n> \n> If a 0.21 backport branch were available, I might be able to try this out.\n\n@chappjc please let us still know how it's going. Thanks!",https://github.com/bitcoin/bitcoin/pull/21083#issuecomment-801518792,801518792,
chappjc,2021-03-18 19:58:08,"I haven't been able to test in our use case, but incidentally the error has been rare lately even with release.  I will provide feed back when possible.",https://github.com/bitcoin/bitcoin/pull/21083#issuecomment-802247047,802247047,
fanquake,2021-03-24 04:13:38,"> Here is a branch of this PR backported to 0.21: https://github.com/achow101/bitcoin/tree/0.21-createtx-same-feerate\n\n@achow101 did you want to open a PR to 0.21 with this branch?",https://github.com/bitcoin/bitcoin/pull/21083#issuecomment-805473538,805473538,
achow101,2021-03-24 04:50:48,"> @achow101 did you want to open a PR to 0.21 with this branch?\n\nDone in #21520",https://github.com/bitcoin/bitcoin/pull/21083#issuecomment-805493325,805493325,
ryanofsky,2021-02-17 22:21:36,"In commit ""wallet: Use existing feerate instead of getting a new one"" (81b6a6b12b46ee351a293ae4928e815c37f193d3)\n\nReview note: this assignment is equivalent to previous `GetMinimumFee` assignment because `GetMinimumFeeRate` is always assigned to `nFeeRateNeeded` line 2810, and `nFeeRateNeeded` is always assigned to `coin_selection_params.effective_fee` on line 2896 (thanks to `pick_new_inputs`",https://github.com/bitcoin/bitcoin/pull/21083#discussion_r577986291,577986291,src/wallet/wallet.cpp
ryanofsky,2021-02-17 22:25:18,"In commit ""wallet: Use existing feerate instead of getting a new one"" (81b6a6b12b46ee351a293ae4928e815c37f193d3)\n\nIt appears there is a change behavior here. ""Fee estimation failed"" error will now take priority over ""insufficient funds"", ""Signing transaction failed"", and other errors. It would be good to mention this in the commit message or at least say that this isn't a pure refactoring like",https://github.com/bitcoin/bitcoin/pull/21083#discussion_r577988119,577988119,src/wallet/wallet.cpp
ryanofsky,2021-02-17 22:39:00,"In commit ""wallet: Replace nFeeRateNeeded with effective_fee"" (befa7ef609c977e6baa609900cedf3d41da12e53)\n\nReview notes: It is safe to set `coin_selection_params.effective_fee` here, because there is no other code except `SelectCoins` called on line 2897 and the `nFeeRet >= nFeeNeeded` branch line 2959 below which ever read `effective_fee`, and both of these pieces of code come after the place ",https://github.com/bitcoin/bitcoin/pull/21083#discussion_r577995228,577995228,src/wallet/wallet.cpp
ryanofsky,2021-02-17 23:01:16,"In commit ""wallet: Move long term feerate setting to CreateTransaction"" (d3191194a8ced53ae511551dce1321c0416d9e6d)\n\nIn this commit and next commit, usage of SelectCoins is now more error prone because caller is responsible for setting `m_long_term_feerate` and `m_discard_feerate` variables in some cases (in other cases they are apparently never used), and there's not documentation about when t",https://github.com/bitcoin/bitcoin/pull/21083#discussion_r578005262,578005262,src/wallet/wallet.h
achow101,2021-02-19 20:28:45,The constructor parameters are more to make the tests easier to implement.,https://github.com/bitcoin/bitcoin/pull/21083#discussion_r579457178,579457178,src/wallet/wallet.h
achow101,2021-02-19 20:29:18,Will update the commit message if I have to retouch.,https://github.com/bitcoin/bitcoin/pull/21083#discussion_r579457462,579457462,src/wallet/wallet.cpp
achow101,2021-02-19 20:29:22,Will update the commit message if I have to retouch.,https://github.com/bitcoin/bitcoin/pull/21083#discussion_r579457502,579457502,src/wallet/wallet.cpp
luke-jr,2021-03-01 02:43:06,"I suggest not expanding the monster constructor here. Overall code readability seems to improve just assigning the new members after construction.\n\n(Also much cleaner to backport...)",https://github.com/bitcoin/bitcoin/pull/21083#discussion_r584415074,584415074,src/wallet/wallet.h
achow101,2021-03-04 18:21:07,See https://github.com/bitcoin/bitcoin/pull/21083#discussion_r579457178,https://github.com/bitcoin/bitcoin/pull/21083#discussion_r587709004,587709004,src/wallet/wallet.h
jnewbery,2021-03-16 13:47:36,"re https://github.com/bitcoin/bitcoin/pull/21083/files#r584415074 and https://github.com/bitcoin/bitcoin/pull/21083#discussion_r579457178:\n\nI agree with @ryanofsky and @luke-jr that expanding this very large ctor signature makes the code less readable. Russ's suggestion of using std::optionals is good. Alternatively, I think these small changes would make things more readable:\n\n- add line ",https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595184535,595184535,src/wallet/wallet.h
achow101,2021-03-16 17:01:36,I've tried to make it more readable. However I also think that setting all of these things should be set in the constructor and that the current thing where we set all the parameters ad-hoc is not a good design.,https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595368439,595368439,src/wallet/wallet.h
achow101,2021-03-16 17:01:50,Updated the commit message,https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595368636,595368636,src/wallet/wallet.cpp
achow101,2021-03-16 17:01:54,Updated the commit message,https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595368700,595368700,src/wallet/wallet.cpp
Xekyo,2021-03-16 19:07:43,"It seems to me that `effective_fee` is a feerate, not a fee.",https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595466605,595466605,src/wallet/wallet.cpp
glozow,2021-03-16 19:21:36,"Since you're touching this, seems appropriate to have magic numbers like this be `static const`",https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595475319,595475319,src/wallet/wallet.cpp
glozow,2021-03-16 19:31:30,"`CFeeRate` default constructor gives it a 0, so this is not needed in the declaration\n```suggestion\n    CFeeRate m_long_term_feerate;\n    CFeeRate m_discard_feerate;\n```",https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595481639,595481639,src/wallet/wallet.h
achow101,2021-03-16 20:39:03,Renamed to `m_effective_feerate`.,https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595523524,595523524,src/wallet/wallet.cpp
achow101,2021-03-16 20:39:25,Changed to use the function we have to fetch the maximum confirmation target.,https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595523754,595523754,src/wallet/wallet.cpp
achow101,2021-03-16 20:39:31,done,https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595523832,595523832,src/wallet/wallet.h
glozow,2021-03-16 21:14:40,"missed one 👀 \n```suggestion\n                                          /* change_spend_size= */ 0, /* effective_feerate= */ CFeeRate(0),\n```",https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595545012,595545012,src/wallet/test/coinselector_tests.cpp
achow101,2021-03-16 21:17:09,Oops. Fixed.,https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595546489,595546489,src/wallet/test/coinselector_tests.cpp
Xekyo,2021-03-16 21:28:48,Should perhaps all of these now start with `m_`?,https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595553340,595553340,src/wallet/wallet.h
glozow,2021-03-16 21:34:38,👍 Good for followup?,https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595556579,595556579,src/wallet/wallet.h
achow101,2021-03-16 21:35:08,"They should, but that's an unrelated change. The newly added members use `m_`.",https://github.com/bitcoin/bitcoin/pull/21083#discussion_r595556867,595556867,src/wallet/wallet.h
