[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383082826",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#issuecomment-383082826",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/13039",
    "id": 383082826,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MzA4MjgyNg==",
    "user": {
      "login": "practicalswift",
      "id": 7826565,
      "node_id": "MDQ6VXNlcjc4MjY1NjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7826565?u=5ff13e375b40ea55ecd3c108337dd6a23f68eddf&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/practicalswift",
      "html_url": "https://github.com/practicalswift",
      "followers_url": "https://api.github.com/users/practicalswift/followers",
      "following_url": "https://api.github.com/users/practicalswift/following{/other_user}",
      "gists_url": "https://api.github.com/users/practicalswift/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/practicalswift/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/practicalswift/subscriptions",
      "organizations_url": "https://api.github.com/users/practicalswift/orgs",
      "repos_url": "https://api.github.com/users/practicalswift/repos",
      "events_url": "https://api.github.com/users/practicalswift/events{/privacy}",
      "received_events_url": "https://api.github.com/users/practicalswift/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-04-20T12:39:24Z",
    "updated_at": "2018-04-20T12:39:24Z",
    "author_association": "CONTRIBUTOR",
    "body": "Strong concept ACK! Nice!",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383082826/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383548455",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#issuecomment-383548455",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/13039",
    "id": 383548455,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MzU0ODQ1NQ==",
    "user": {
      "login": "jonasschnelli",
      "id": 178464,
      "node_id": "MDQ6VXNlcjE3ODQ2NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/178464?u=eab5d0cdbb6cc25087cb61d4ca4a6f85255f42a7&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonasschnelli",
      "html_url": "https://github.com/jonasschnelli",
      "followers_url": "https://api.github.com/users/jonasschnelli/followers",
      "following_url": "https://api.github.com/users/jonasschnelli/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonasschnelli/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonasschnelli/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonasschnelli/subscriptions",
      "organizations_url": "https://api.github.com/users/jonasschnelli/orgs",
      "repos_url": "https://api.github.com/users/jonasschnelli/repos",
      "events_url": "https://api.github.com/users/jonasschnelli/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonasschnelli/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-04-23T11:52:17Z",
    "updated_at": "2018-04-23T11:52:17Z",
    "author_association": "CONTRIBUTOR",
    "body": "utACK 36424a4f09de38e1ab54381aa7844781688f5c75 (squash recommended).",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383548455/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383556753",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#issuecomment-383556753",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/13039",
    "id": 383556753,
    "node_id": "MDEyOklzc3VlQ29tbWVudDM4MzU1Njc1Mw==",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?u=13b19d1ff2f5f914e180c41418f451a4ba6f8bd1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2018-04-23T12:25:52Z",
    "updated_at": "2018-04-23T12:26:06Z",
    "author_association": "MEMBER",
    "body": "squashed 36424a4  \u2192 cf0277928fa8d955d75f661021845789194dfff7",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/383556753/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183072136",
    "pull_request_review_id": 114004572,
    "id": 183072136,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA3MjEzNg==",
    "diff_hunk": "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);",
    "path": "src/util.cpp",
    "position": null,
    "original_position": 14,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This value should probably be checked as well: https://msdn.microsoft.com/en-us/library/windows/desktop/aa364439(v=vs.85).aspx",
    "created_at": "2018-04-20T14:40:23Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183072136",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183072136"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183072136"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183072136/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 799,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183074012",
    "pull_request_review_id": 114004572,
    "id": 183074012,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA3NDAxMg==",
    "diff_hunk": "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);\n #else\n     #if defined(__linux__) || defined(__NetBSD__)\n-    fdatasync(fileno(file));\n+    if (fdatasync(fileno(file)) != 0 && errno != EINVAL) { // Ignore EINVAL for filesystems that don't support sync\n+        LogPrintf(\"%s: fdatasync failed: %d\\n\", __func__, errno);",
    "path": "src/util.cpp",
    "position": 23,
    "original_position": 19,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I can't come up with a specific reason other than \"gut feeling\", but potentially logging to the same disk that just failed to sync feels icky.",
    "created_at": "2018-04-20T14:46:48Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183074012",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183074012"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183074012"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183074012/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 806,
    "original_line": 806,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183075035",
    "pull_request_review_id": 114004572,
    "id": 183075035,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA3NTAzNQ==",
    "diff_hunk": "@@ -1615,22 +1615,27 @@ void static FlushBlockFile(bool fFinalize = false)\n     LOCK(cs_LastBlockFile);\n \n     CDiskBlockPos posOld(nLastBlockFile, 0);\n+    bool flush_failed = false;\n \n     FILE *fileOld = OpenBlockFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);\n         fclose(fileOld);\n     }\n \n     fileOld = OpenUndoFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nUndoSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 20,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "|=",
    "created_at": "2018-04-20T14:50:02Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183075035",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183075035"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183075035"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183075035/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1632,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183075554",
    "pull_request_review_id": 114004572,
    "id": 183075554,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA3NTU1NA==",
    "diff_hunk": "@@ -1615,22 +1615,27 @@ void static FlushBlockFile(bool fFinalize = false)\n     LOCK(cs_LastBlockFile);\n \n     CDiskBlockPos posOld(nLastBlockFile, 0);\n+    bool flush_failed = false;\n \n     FILE *fileOld = OpenBlockFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);\n         fclose(fileOld);\n     }\n \n     fileOld = OpenUndoFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nUndoSize);",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 18,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Wouldn't hurt to check the return value here too, but I guess it's not crucial since any error would just propagate to the sync.",
    "created_at": "2018-04-20T14:51:40Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183075554",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183075554"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183075554"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183075554/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1631,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078031",
    "pull_request_review_id": 114004572,
    "id": 183078031,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA3ODAzMQ==",
    "diff_hunk": "@@ -49,7 +49,8 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n \n     // Serialize\n     if (!SerializeDB(fileout, data)) return false;\n-    FileCommit(fileout.Get());\n+    if (!FileCommit(fileout.Get()))\n+        return error(\"%s: Failed to flush file %s\", __func__, pathTmp.string());\n     fileout.fclose();",
    "path": "src/addrdb.cpp",
    "position": 7,
    "original_position": 7,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Should this attempt to close before returning? I assume we're in bad shape already if we get here, but I'm afraid that some one-off sync failure could lead to multiple copies open and weird fd behavior.",
    "created_at": "2018-04-20T14:58:50Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183078031",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078031"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183078031"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078031/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 54,
    "original_line": 54,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078393",
    "pull_request_review_id": 114004572,
    "id": 183078393,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA3ODM5Mw==",
    "diff_hunk": "@@ -1615,22 +1615,27 @@ void static FlushBlockFile(bool fFinalize = false)\n     LOCK(cs_LastBlockFile);\n \n     CDiskBlockPos posOld(nLastBlockFile, 0);\n+    bool flush_failed = false;\n \n     FILE *fileOld = OpenBlockFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 11,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "See fclose comment above.",
    "created_at": "2018-04-20T14:59:47Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183078393",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078393"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183078393"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078393/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1624,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078606",
    "pull_request_review_id": 114004572,
    "id": 183078606,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA3ODYwNg==",
    "diff_hunk": "@@ -4760,7 +4765,8 @@ bool DumpMempool(void)\n         }\n \n         file << mapDeltas;\n-        FileCommit(file.Get());\n+        if (!FileCommit(file.Get()))\n+            throw std::runtime_error(\"FileCommit failed\");\n         file.fclose();",
    "path": "src/validation.cpp",
    "position": 39,
    "original_position": 37,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "~~aaand here~~ :)",
    "created_at": "2018-04-20T15:00:14Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183078606",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078606"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183078606"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183078606/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 4770,
    "original_line": 4770,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183080978",
    "pull_request_review_id": 114015709,
    "id": 183080978,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA4MDk3OA==",
    "diff_hunk": "@@ -1615,22 +1615,27 @@ void static FlushBlockFile(bool fFinalize = false)\n     LOCK(cs_LastBlockFile);\n \n     CDiskBlockPos posOld(nLastBlockFile, 0);\n+    bool flush_failed = false;\n \n     FILE *fileOld = OpenBlockFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);\n         fclose(fileOld);\n     }\n \n     fileOld = OpenUndoFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nUndoSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 20,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Whoops, and the logic for these is backwards. They should be:\r\n```c++\r\n flush_failed |= !FileCommit(fileOld);\r\n```",
    "created_at": "2018-04-20T15:07:47Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183080978",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183080978"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183080978"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183080978/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1632,
    "side": "RIGHT",
    "in_reply_to_id": 183075035
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183088864",
    "pull_request_review_id": 114025306,
    "id": 183088864,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA4ODg2NA==",
    "diff_hunk": "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);\n #else\n     #if defined(__linux__) || defined(__NetBSD__)\n-    fdatasync(fileno(file));\n+    if (fdatasync(fileno(file)) != 0 && errno != EINVAL) { // Ignore EINVAL for filesystems that don't support sync",
    "path": "src/util.cpp",
    "position": null,
    "original_position": 18,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Interestingly, leveldb does not compare the result to EINVAL. Which makes sense for a database, as if writes can't be synchronized at any point, the db can't really ever be trusted.\r\n\r\nI think we might want to operate the same way. If a FlushBlockFile() fails due to a disk/filesystem that can't sync, do we really want to continue with updating the index db?",
    "created_at": "2018-04-20T15:32:51Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183088864",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183088864"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183088864"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183088864/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 805,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183089712",
    "pull_request_review_id": 114026330,
    "id": 183089712,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA4OTcxMg==",
    "diff_hunk": "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);\n #else\n     #if defined(__linux__) || defined(__NetBSD__)\n-    fdatasync(fileno(file));\n+    if (fdatasync(fileno(file)) != 0 && errno != EINVAL) { // Ignore EINVAL for filesystems that don't support sync\n+        LogPrintf(\"%s: fdatasync failed: %d\\n\", __func__, errno);",
    "path": "src/util.cpp",
    "position": 23,
    "original_position": 19,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "That's not *necessarily* the case, e.g. they might be logging to stdout, or piping the log to something else over the network. Logging the error is extremely important for troubleshooting in any case, even if it might fail.",
    "created_at": "2018-04-20T15:35:25Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183089712",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183089712"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183089712"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183089712/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 806,
    "original_line": 806,
    "side": "RIGHT",
    "in_reply_to_id": 183074012
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183089814",
    "pull_request_review_id": 114026453,
    "id": 183089814,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA4OTgxNA==",
    "diff_hunk": "@@ -1615,22 +1615,27 @@ void static FlushBlockFile(bool fFinalize = false)\n     LOCK(cs_LastBlockFile);\n \n     CDiskBlockPos posOld(nLastBlockFile, 0);\n+    bool flush_failed = false;\n \n     FILE *fileOld = OpenBlockFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);\n         fclose(fileOld);\n     }\n \n     fileOld = OpenUndoFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nUndoSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 20,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Ah yes this should be flush_ok",
    "created_at": "2018-04-20T15:35:43Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183089814",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183089814"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183089814"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183089814/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1632,
    "side": "RIGHT",
    "in_reply_to_id": 183075035
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183090593",
    "pull_request_review_id": 114027423,
    "id": 183090593,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA5MDU5Mw==",
    "diff_hunk": "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);\n #else\n     #if defined(__linux__) || defined(__NetBSD__)\n-    fdatasync(fileno(file));\n+    if (fdatasync(fileno(file)) != 0 && errno != EINVAL) { // Ignore EINVAL for filesystems that don't support sync",
    "path": "src/util.cpp",
    "position": null,
    "original_position": 18,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "leveldb does compare against EINVAL, we had this issue a long time ago where leveldb didn't work with certain filesystems (e.g. NTFS mounted from Linux). This was eventually fixed by adding the compare against EINVAL.\r\nWe certainly don't want to repeat this issue with the block files!\r\n```\r\n$ git grep fsync\r\nutil/env_posix.cc:        if (fsync(fd) < 0 && errno != EINVAL) {\r\n``",
    "created_at": "2018-04-20T15:38:10Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183090593",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183090593"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183090593"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183090593/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 805,
    "side": "RIGHT",
    "in_reply_to_id": 183088864
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183091501",
    "pull_request_review_id": 114028549,
    "id": 183091501,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA5MTUwMQ==",
    "diff_hunk": "@@ -49,7 +49,8 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n \n     // Serialize\n     if (!SerializeDB(fileout, data)) return false;\n-    FileCommit(fileout.Get());\n+    if (!FileCommit(fileout.Get()))\n+        return error(\"%s: Failed to flush file %s\", __func__, pathTmp.string());\n     fileout.fclose();",
    "path": "src/addrdb.cpp",
    "position": 7,
    "original_position": 7,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Doesn't CAutofile destructor take care of this?",
    "created_at": "2018-04-20T15:41:21Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183091501",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183091501"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183091501"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183091501/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 54,
    "original_line": 54,
    "side": "RIGHT",
    "in_reply_to_id": 183078031
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183092652",
    "pull_request_review_id": 114029930,
    "id": 183092652,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA5MjY1Mg==",
    "diff_hunk": "@@ -1615,22 +1615,27 @@ void static FlushBlockFile(bool fFinalize = false)\n     LOCK(cs_LastBlockFile);\n \n     CDiskBlockPos posOld(nLastBlockFile, 0);\n+    bool flush_failed = false;\n \n     FILE *fileOld = OpenBlockFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nSize);\n-        FileCommit(fileOld);\n+        flush_failed = FileCommit(fileOld);\n         fclose(fileOld);\n     }\n \n     fileOld = OpenUndoFile(posOld);\n     if (fileOld) {\n         if (fFinalize)\n             TruncateFile(fileOld, vinfoBlockFile[nLastBlockFile].nUndoSize);",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 18,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Will do",
    "created_at": "2018-04-20T15:45:05Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183092652",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183092652"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183092652"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183092652/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1631,
    "side": "RIGHT",
    "in_reply_to_id": 183075554
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183093281",
    "pull_request_review_id": 114030650,
    "id": 183093281,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA5MzI4MQ==",
    "diff_hunk": "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);",
    "path": "src/util.cpp",
    "position": null,
    "original_position": 14,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Ok",
    "created_at": "2018-04-20T15:47:04Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183093281",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183093281"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183093281"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183093281/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 799,
    "side": "RIGHT",
    "in_reply_to_id": 183072136
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183093591",
    "pull_request_review_id": 114031021,
    "id": 183093591,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA5MzU5MQ==",
    "diff_hunk": "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);\n #else\n     #if defined(__linux__) || defined(__NetBSD__)\n-    fdatasync(fileno(file));\n+    if (fdatasync(fileno(file)) != 0 && errno != EINVAL) { // Ignore EINVAL for filesystems that don't support sync",
    "path": "src/util.cpp",
    "position": null,
    "original_position": 18,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Hmm. leveldb checks the fsync() in SyncDirIfManifest() against EINVAL, but not the fdatasync() in Sync().\r\n\r\nI have no knowledge of the past issue though, so I'll defer to you on that.",
    "created_at": "2018-04-20T15:48:02Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183093591",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183093591"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183093591"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183093591/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 805,
    "side": "RIGHT",
    "in_reply_to_id": 183088864
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183094458",
    "pull_request_review_id": 114032034,
    "id": 183094458,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA5NDQ1OA==",
    "diff_hunk": "@@ -49,7 +49,8 @@ bool SerializeFileDB(const std::string& prefix, const fs::path& path, const Data\n \n     // Serialize\n     if (!SerializeDB(fileout, data)) return false;\n-    FileCommit(fileout.Get());\n+    if (!FileCommit(fileout.Get()))\n+        return error(\"%s: Failed to flush file %s\", __func__, pathTmp.string());\n     fileout.fclose();",
    "path": "src/addrdb.cpp",
    "position": 7,
    "original_position": 7,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "theuni",
      "id": 417043,
      "node_id": "MDQ6VXNlcjQxNzA0Mw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/417043?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/theuni",
      "html_url": "https://github.com/theuni",
      "followers_url": "https://api.github.com/users/theuni/followers",
      "following_url": "https://api.github.com/users/theuni/following{/other_user}",
      "gists_url": "https://api.github.com/users/theuni/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/theuni/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/theuni/subscriptions",
      "organizations_url": "https://api.github.com/users/theuni/orgs",
      "repos_url": "https://api.github.com/users/theuni/repos",
      "events_url": "https://api.github.com/users/theuni/events{/privacy}",
      "received_events_url": "https://api.github.com/users/theuni/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "yep, nevermind missed that this was a CAutofile.",
    "created_at": "2018-04-20T15:50:51Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183094458",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183094458"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183094458"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183094458/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 54,
    "original_line": 54,
    "side": "RIGHT",
    "in_reply_to_id": 183078031
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183094671",
    "pull_request_review_id": 114032283,
    "id": 183094671,
    "node_id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDE4MzA5NDY3MQ==",
    "diff_hunk": "@@ -788,21 +788,34 @@ bool TryCreateDirectories(const fs::path& p)\n     return false;\n }\n \n-void FileCommit(FILE *file)\n+bool FileCommit(FILE *file)\n {\n-    fflush(file); // harmless if redundantly called\n+    if (fflush(file) != 0) { // harmless if redundantly called\n+        LogPrintf(\"%s: fflush failed: %d\\n\", __func__, errno);\n+        return false;\n+    }\n #ifdef WIN32\n     HANDLE hFile = (HANDLE)_get_osfhandle(_fileno(file));\n     FlushFileBuffers(hFile);\n #else\n     #if defined(__linux__) || defined(__NetBSD__)\n-    fdatasync(fileno(file));\n+    if (fdatasync(fileno(file)) != 0 && errno != EINVAL) { // Ignore EINVAL for filesystems that don't support sync",
    "path": "src/util.cpp",
    "position": null,
    "original_position": 18,
    "commit_id": "cf0277928fa8d955d75f661021845789194dfff7",
    "original_commit_id": "5657cc51624a61d70a402ef353632e3034609432",
    "user": {
      "login": "laanwj",
      "id": 126646,
      "node_id": "MDQ6VXNlcjEyNjY0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/126646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/laanwj",
      "html_url": "https://github.com/laanwj",
      "followers_url": "https://api.github.com/users/laanwj/followers",
      "following_url": "https://api.github.com/users/laanwj/following{/other_user}",
      "gists_url": "https://api.github.com/users/laanwj/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/laanwj/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/laanwj/subscriptions",
      "organizations_url": "https://api.github.com/users/laanwj/orgs",
      "repos_url": "https://api.github.com/users/laanwj/repos",
      "events_url": "https://api.github.com/users/laanwj/events{/privacy}",
      "received_events_url": "https://api.github.com/users/laanwj/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> as if writes can't be synchronized at any point, the db can't really ever be trusted.\r\n\r\nI don't agree. When shutting down bitcoind and the OS cleanly, `f(data)sync` is a no-op. It's only an issue if there are sudden crashes or power outages. In which case the user will just have to accept potential corruption on crashes when choosing to use a filesystem that doesn't support these things. Certainly for the block files, which are huge and more commonly hosted externally.\r\n\r\nMy intent here is not to break any current usecases.",
    "created_at": "2018-04-20T15:51:37Z",
    "updated_at": "2018-04-23T12:26:03Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183094671",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183094671"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/13039#discussion_r183094671"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/13039"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/183094671/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 805,
    "side": "RIGHT",
    "in_reply_to_id": 183088864
  }
]