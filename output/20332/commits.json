[
  {
    "sha": "fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmYTQyMzRkODc3ZWEzMTkzYmZkMGUxOGZmNjhkY2I4ZmI4NGI0N2I1",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2020-11-06T14:03:51Z"
      },
      "committer": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2020-11-07T06:50:59Z"
      },
      "message": "test: Mock IBD in net_processing fuzzers",
      "tree": {
        "sha": "cf51fc278cdb89124594f03a2557e116670fdf47",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cf51fc278cdb89124594f03a2557e116670fdf47"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unknown_key",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\npUjWtgv/fwNazysx245M1EKfphuSAAtKKgLliVIG97l1H8zTJpkFBjTj8hpWZKIS\nLywwSesOZc6ot9cIsHnR+5TQ8YNjIVdXgHNGvj5d4FeoVnx9ow7/RBmgS/QBKTN+\nxVOyxpkcA3e6lpuyINwnH3MmfeUcDBSaWuVP0c9xsqQdEKodGaRNPfBQc/OJ4azv\neX8bCcyGT5sPNRUcBt/naxOcppj8FsZNkMVwTKZOGg3w01KFEQvnEtRY7DF0Ai6i\n46kAcTbWtZCwW8nJbMJLn3JsuTT5T9E0gt8YBvtXPZKN4fQfyuBYB0sNr6zEw68g\nJOUUbnQJUpoPT9S7jgOBP7HGaGqKUX8jLubAKhNTCkMj5WvaMDdypE7Zg2bMmbPH\ncFOJowr4fuMls+waerbMsszrY4z144UJ0w8BI8dDuzYlwY4/rXG6aqoYo2SFKEKm\n1jaU4g1GjxwholgseJ5BFMLgaYFtwC3eyBjGQhgGsthPIxt+1LwnJB3G1dkhjSU6\n57TZR2C5\n=OvGc\n-----END PGP SIGNATURE-----",
        "payload": "tree cf51fc278cdb89124594f03a2557e116670fdf47\nparent c51c2753a4ff34413f7369e9cf0282f64a5e38de\nauthor MarcoFalke <falke.marco@gmail.com> 1604671431 +0100\ncommitter MarcoFalke <falke.marco@gmail.com> 1604731859 +0100\n\ntest: Mock IBD in net_processing fuzzers\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c51c2753a4ff34413f7369e9cf0282f64a5e38de",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c51c2753a4ff34413f7369e9cf0282f64a5e38de",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c51c2753a4ff34413f7369e9cf0282f64a5e38de"
      }
    ],
    "stats": {
      "total": 60,
      "additions": 56,
      "deletions": 4
    },
    "files": [
      {
        "sha": "0621da8ddf6304aaec7882e3bf520b4bf6a9912d",
        "filename": "src/Makefile.test_util.include",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5/src/Makefile.test_util.include",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5/src/Makefile.test_util.include",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/Makefile.test_util.include?ref=fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5",
        "patch": "@@ -15,6 +15,7 @@ TEST_UTIL_H = \\\n     test/util/setup_common.h \\\n     test/util/str.h \\\n     test/util/transaction_utils.h \\\n+    test/util/validation.h \\\n     test/util/wallet.h\n \n libtest_util_a_CPPFLAGS = $(AM_CPPFLAGS) $(BITCOIN_INCLUDES) $(MINIUPNPC_CPPFLAGS) $(EVENT_CFLAGS) $(EVENT_PTHREADS_CFLAGS)\n@@ -27,6 +28,7 @@ libtest_util_a_SOURCES = \\\n   test/util/setup_common.cpp \\\n   test/util/str.cpp \\\n   test/util/transaction_utils.cpp \\\n+  test/util/validation.cpp \\\n   test/util/wallet.cpp \\\n   $(TEST_UTIL_H)\n "
      },
      {
        "sha": "93903998783ef9f83ecbb611d91a66f1445b3069",
        "filename": "src/test/fuzz/process_message.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 1,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5/src/test/fuzz/process_message.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5/src/test/fuzz/process_message.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/fuzz/process_message.cpp?ref=fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5",
        "patch": "@@ -16,6 +16,7 @@\n #include <test/util/mining.h>\n #include <test/util/net.h>\n #include <test/util/setup_common.h>\n+#include <test/util/validation.h>\n #include <util/memory.h>\n #include <validationinterface.h>\n #include <version.h>\n@@ -63,10 +64,14 @@ void test_one_input(const std::vector<uint8_t>& buffer)\n {\n     FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n     ConnmanTestMsg& connman = *(ConnmanTestMsg*)g_setup->m_node.connman.get();\n+    TestChainState& chainstate = *(TestChainState*)&g_setup->m_node.chainman->ActiveChainstate();\n+    chainstate.ResetIbd();\n     const std::string random_message_type{fuzzed_data_provider.ConsumeBytesAsString(CMessageHeader::COMMAND_SIZE).c_str()};\n     if (!LIMIT_TO_MESSAGE_TYPE.empty() && random_message_type != LIMIT_TO_MESSAGE_TYPE) {\n         return;\n     }\n+    const bool jump_out_of_ibd{fuzzed_data_provider.ConsumeBool()};\n+    if (jump_out_of_ibd) chainstate.JumpOutOfIbd();\n     CDataStream random_bytes_data_stream{fuzzed_data_provider.ConsumeRemainingBytes<unsigned char>(), SER_NETWORK, PROTOCOL_VERSION};\n     CNode& p2p_node = *MakeUnique<CNode>(0, ServiceFlags(NODE_NETWORK | NODE_WITNESS | NODE_BLOOM), 0, INVALID_SOCKET, CAddress{CService{in_addr{0x0100007f}, 7777}, NODE_NETWORK}, 0, 0, CAddress{}, std::string{}, ConnectionType::OUTBOUND_FULL_RELAY).release();\n     p2p_node.fSuccessfullyConnected = true;\n@@ -76,7 +81,7 @@ void test_one_input(const std::vector<uint8_t>& buffer)\n     g_setup->m_node.peerman->InitializeNode(&p2p_node);\n     try {\n         g_setup->m_node.peerman->ProcessMessage(p2p_node, random_message_type, random_bytes_data_stream,\n-                                                   GetTime<std::chrono::microseconds>(), std::atomic<bool>{false});\n+                                                GetTime<std::chrono::microseconds>(), std::atomic<bool>{false});\n     } catch (const std::ios_base::failure&) {\n     }\n     SyncWithValidationInterfaceQueue();"
      },
      {
        "sha": "19ea92b750d08906c7cc938552f8ccfb02e2c89d",
        "filename": "src/test/fuzz/process_messages.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5/src/test/fuzz/process_messages.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5/src/test/fuzz/process_messages.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/fuzz/process_messages.cpp?ref=fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5",
        "patch": "@@ -12,6 +12,7 @@\n #include <test/util/mining.h>\n #include <test/util/net.h>\n #include <test/util/setup_common.h>\n+#include <test/util/validation.h>\n #include <util/memory.h>\n #include <validation.h>\n #include <validationinterface.h>\n@@ -39,7 +40,10 @@ void test_one_input(const std::vector<uint8_t>& buffer)\n     FuzzedDataProvider fuzzed_data_provider(buffer.data(), buffer.size());\n \n     ConnmanTestMsg& connman = *(ConnmanTestMsg*)g_setup->m_node.connman.get();\n+    TestChainState& chainstate = *(TestChainState*)&g_setup->m_node.chainman->ActiveChainstate();\n+    chainstate.ResetIbd();\n     std::vector<CNode*> peers;\n+    bool jump_out_of_ibd{false};\n \n     const auto num_peers_to_add = fuzzed_data_provider.ConsumeIntegralInRange(1, 3);\n     for (int i = 0; i < num_peers_to_add; ++i) {\n@@ -58,6 +62,8 @@ void test_one_input(const std::vector<uint8_t>& buffer)\n     }\n \n     while (fuzzed_data_provider.ConsumeBool()) {\n+        if (!jump_out_of_ibd) jump_out_of_ibd = fuzzed_data_provider.ConsumeBool();\n+        if (jump_out_of_ibd && chainstate.IsInitialBlockDownload()) chainstate.JumpOutOfIbd();\n         const std::string random_message_type{fuzzed_data_provider.ConsumeBytesAsString(CMessageHeader::COMMAND_SIZE).c_str()};\n \n         CSerializedNetMsg net_msg;"
      },
      {
        "sha": "1aed492c3c037a0d1eca4ef6df1fb4ee45e94f28",
        "filename": "src/test/util/validation.cpp",
        "status": "added",
        "additions": 22,
        "deletions": 0,
        "changes": 22,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5/src/test/util/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5/src/test/util/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/util/validation.cpp?ref=fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5",
        "patch": "@@ -0,0 +1,22 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <test/util/validation.h>\n+\n+#include <util/check.h>\n+#include <util/time.h>\n+#include <validation.h>\n+\n+void TestChainState::ResetIbd()\n+{\n+    m_cached_finished_ibd = false;\n+    assert(IsInitialBlockDownload());\n+}\n+\n+void TestChainState::JumpOutOfIbd()\n+{\n+    Assert(IsInitialBlockDownload());\n+    m_cached_finished_ibd = true;\n+    Assert(!IsInitialBlockDownload());\n+}"
      },
      {
        "sha": "b13aa0be60d5533f3c541b385e357153bba1380d",
        "filename": "src/test/util/validation.h",
        "status": "added",
        "additions": 17,
        "deletions": 0,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5/src/test/util/validation.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5/src/test/util/validation.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/util/validation.h?ref=fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5",
        "patch": "@@ -0,0 +1,17 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_TEST_UTIL_VALIDATION_H\n+#define BITCOIN_TEST_UTIL_VALIDATION_H\n+\n+#include <validation.h>\n+\n+struct TestChainState : public CChainState {\n+    /** Reset the ibd cache to its initial state */\n+    void ResetIbd();\n+    /** Toggle IsInitialBlockDownload from true to false */\n+    void JumpOutOfIbd();\n+};\n+\n+#endif // BITCOIN_TEST_UTIL_VALIDATION_H"
      },
      {
        "sha": "ffb038ad75f0da86bc91eac66db1bf3f92a67902",
        "filename": "src/validation.h",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5/src/validation.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5/src/validation.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.h?ref=fa4234d877ea3193bfd0e18ff68dcb8fb84b47b5",
        "patch": "@@ -503,9 +503,9 @@ enum class CoinsCacheSizeState\n  * whereas block information and metadata independent of the current tip is\n  * kept in `BlockMetadataManager`.\n  */\n-class CChainState {\n-private:\n-\n+class CChainState\n+{\n+protected:\n     /**\n      * Every received block is assigned a unique and increasing identifier, so we\n      * know which one to give priority in case of a fork."
      }
    ]
  }
]