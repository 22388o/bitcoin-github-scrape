laanwj,2012-06-11T06:13:51Z,"I appreciate that you're trying to improve the naming, but be careful that this does change behaviour in the case of bitcoind.\n\nPreviously, QueueShutdown (in non-ui context) started Shutdown in a new thread, to make sure that execution returns immediately. This means that an RPC command such as ""quit"" got the chance to return a reply. It now calls Shutdown directly, which shuts down bitcoin in t",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6236275,6236275,
Diapolo,2012-06-11T07:22:29Z,"@laanwj Updated to reflect your suggestions. Can you explain, why noui.cpp is not added in bitcoin-qt.pro? I found it quite strange to not be able to edit that file directly somehow.\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6238254,6238254,
laanwj,2012-06-11T07:27:42Z,"Looks good now.\n\nWell, it used to be that noui.cpp conflicted with some functions in the UI. If this is no longer the case due to using boost::signals now, it could be added in bitcoin-qt.pro too... (or otherwise you could add it under ""other"" files)\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6238317,6238317,
Diapolo,2012-06-11T07:35:23Z,"Fine and at least on my local build it compiles just fine with noui.cpp added to the .pro. Could you verify, if this would break the official Gitian build process before I update the pull?\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6238420,6238420,
laanwj,2012-06-11T07:43:10Z,"I'm unable to test gitian right now.\n\nMaybe it's better to leave that for another (more trivial) pull. Focus this one on shutdown functionality, this is quite a big fish to fry, and needs heavy testing.\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6238531,6238531,
Diapolo,2012-06-11T07:56:27Z,"Okay, so let's see what other devs think.\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6238713,6238713,
laanwj,2012-06-11T08:08:54Z,"BTW, does this solve the original issue with exit() in Shutdown? I don't see it in the diff.\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6238888,6238888,
TheBlueMatt,2012-06-11T13:10:58Z,"If the one non-compiling change is reverted, ACK\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6243873,6243873,
Diapolo,2012-06-11T13:30:54Z,"I'm asking myself, if the change in net.cpp is correct, but as net.cpp is used by the Qt version and bitcoind it should be a StartShutdown() call.\n\n@TheBlueMatt I reverted the changes that don't compile, they now use `Shutdown(NULL);` again, which should be fine for a non Qt version.\n\n@laanwj The `exit()` call in Shutdown() is not an issue anymore for the Qt version, as Shutdown() was moved do",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6244279,6244279,
TheBlueMatt,2012-06-11T13:36:59Z,ACK\n,https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6244421,6244421,
Diapolo,2012-06-11T13:47:49Z,"@TheBlueMatt One last thing that bothers me, should the 2 `Shutdown(NULL);` calls in init.cpp be converted to `StartShutdown();`, which could be considered the default function to call, when a shutdown is needed. It would end up with Shutdown() via a thread, but fits better to the rest of the shutdown code and usage.\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6244659,6244659,
TheBlueMatt,2012-06-11T13:51:05Z,"No, in those two cases, shutdown needs to happen immediately, so launching a shutdown thread instead could cause errors.\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6244743,6244743,
Diapolo,2012-06-11T13:53:47Z,"Understood, thanks :).\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6244813,6244813,
laanwj,2012-06-11T13:54:50Z,"@diapolo ok, that's also a possibility, as it appears that nothing else can ""fall through"" to there\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6244847,6244847,
laanwj,2012-06-11T13:56:49Z,"It does create another issue, though: the icon disappears _before_ the shutdown starts, instead of after it ends. That's one of the things we were trying to prevent. It's useful to keep the icon until the program actually exits, to tell the user that something is running.\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6244923,6244923,
Diapolo,2012-06-11T14:21:03Z,@laanwj Seems rather hard to ensure a clean shutdown and wanting to keep the tray-icon till the very end. Leaving the Qt Shutdown(NULL) were it was before leads to killing Qt objects. this looks much more sane now. So any further idea (perhaps in another pull if this requires additional re-work on the GUI)?\n,https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6245559,6245559,
Diapolo,2012-06-11T14:25:22Z,Perhaps move the Shutdown() back to where it was and re-add the #ifdef QT_GUI around the exit() in Shutdown(). This would make Bitcoin-Qt exit via the last return 0 in bitcoin.cpp.\n,https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6245679,6245679,
laanwj,2012-06-11T14:36:32Z,"Yeah - IMO, the idea to not call exit() at the end of the Shutdown() function in the case of the UI was good. This allows it to wind things down afterward instead of before.\n(which will eventually also allow it to show some ""Warning - do not shutdown computer while Bitcoin is shutting down"" warning).\n\n**Edit:** or even better: make it explicit and save an #ifdef. Create a ShutdownAndExit() func",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6245977,6245977,
Diapolo,2012-06-11T20:12:30Z,"@laanwj I see 2 problems with your last suggestion.\n1. Shutdown() calls `CreateThread(ExitTimeout, NULL);` which seems to be a 5 second timer, before the process get's killed anyway, so the Shutdown() function still somehow exits / kills the client.\n2. I think an #ifdef is easier / cleaner than another function in this case.\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6254673,6254673,
Diapolo,2012-06-11T20:36:25Z,"Updated to ensure tray-icon is kept until Bitcoin-Qt exits, no further changes for no UI client.\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6255255,6255255,
TheBlueMatt,2012-06-11T20:39:30Z,"Well, it ended up with more ifdefs than I thought it would need, but it still looks better than it was imho, ACK.\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6255314,6255314,
laanwj,2012-06-12T05:18:24Z,ACK\n,https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6263152,6263152,
TheBlueMatt,2012-06-13T00:10:24Z,"Note for whoever merges, close #1182, as this fixes it.\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6288245,6288245,
laanwj,2012-06-13T07:18:30Z,"I think we should aim to merge this asap, but as this affects critical functionality Gavin or Sipa should probably take a look at it for a sanity check.\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6294457,6294457,
sipa,2012-06-13T12:10:30Z,"ACK on the changes to core; The exit(0) in Shutdown inside ifndef qt is a bit ugly though, imho.\n",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6299186,6299186,
laanwj,2012-06-13T12:32:13Z,"Well, IMO the problem is that ""shutdown bitcoin"" and ""exit program"" are essentially different actions.\n\nThat's why I proposed adding a ShutdownAndExit function, and using that where appropriate: in StartShutdown [ifndef QT_GUI] and AppInit. The name would also clearly signal to the programmer that the function never returns. The normal Shutdown function would shut down bitcoin and return.\n\nDia",https://github.com/bitcoin/bitcoin/pull/1439#issuecomment-6299599,6299599,
laanwj,2012-06-11T06:15:17Z,"I don't like the name ""FinishShutdown"" much. This is not finishing the shutdown, it is the only real shutdown functionality, the other functions are just queuing it to happen.\n",https://github.com/bitcoin/bitcoin/pull/1439#discussion_r957971,957971,src/init.cpp
laanwj,2012-06-11T06:15:55Z,"See my  comment about changed functionality, this should be \n\n```\n// Without UI, FinishShutdown can simply be started in a new thread\nCreateThread(FinishShutdown, NULL);\n```\n",https://github.com/bitcoin/bitcoin/pull/1439#discussion_r957973,957973,src/init.cpp
laanwj,2012-06-11T06:17:07Z,This would be no longer used\n,https://github.com/bitcoin/bitcoin/pull/1439#discussion_r957976,957976,src/noui.cpp
laanwj,2012-06-11T06:18:00Z,Maybe StartShutdown()? The current name doesn't make clear that the actual shutdown happens later / in another thread asynchronously.\n,https://github.com/bitcoin/bitcoin/pull/1439#discussion_r957977,957977,src/init.cpp
Diapolo,2012-06-11T06:24:41Z,"ACK, the naming should be more clear StartShutdown or InitShutdown()?\n",https://github.com/bitcoin/bitcoin/pull/1439#discussion_r957990,957990,src/init.cpp
Diapolo,2012-06-11T06:26:16Z,"So when I change the final Shutdown-call for no GUI to create a thread this function can be removed then, right?\n",https://github.com/bitcoin/bitcoin/pull/1439#discussion_r957993,957993,src/noui.cpp
Diapolo,2012-06-11T06:27:08Z,"If we call Shutdown() Start- or InitShutdown() this can be Shutdown() again, which would be fine then.\n",https://github.com/bitcoin/bitcoin/pull/1439#discussion_r957995,957995,src/init.cpp
Diapolo,2012-06-11T06:28:13Z,ACK\n,https://github.com/bitcoin/bitcoin/pull/1439#discussion_r957997,957997,src/init.cpp
laanwj,2012-06-11T08:15:27Z,"Yes, that's much more clear\n",https://github.com/bitcoin/bitcoin/pull/1439#discussion_r958293,958293,src/init.cpp
TheBlueMatt,2012-06-11T13:00:42Z,This and the previous change do not compile.\n,https://github.com/bitcoin/bitcoin/pull/1439#discussion_r959436,959436,src/init.cpp
Diapolo,2012-06-11T13:18:03Z,"Ah I missed that, because it's in an #ifdef, which my compiler ignores, because I compile the GUI version. It should be a Shutdown(NULL).\n",https://github.com/bitcoin/bitcoin/pull/1439#discussion_r959533,959533,src/init.cpp
laanwj,2012-06-12T05:18:04Z,This comment is no longer needed :)\n,https://github.com/bitcoin/bitcoin/pull/1439#discussion_r965010,965010,src/qt/bitcoin.cpp
Diapolo,2012-06-12T05:21:55Z,"A final update, which only removes this line was pushed ^^.\n",https://github.com/bitcoin/bitcoin/pull/1439#discussion_r965020,965020,src/qt/bitcoin.cpp
