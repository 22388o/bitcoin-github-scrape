[
  {
    "sha": "fae43a97ca947cd0802392e9bb86d9d0572c0fba",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmYWU0M2E5N2NhOTQ3Y2QwODAyMzkyZTliYjg2ZDlkMDU3MmMwZmJh",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2019-09-26T13:14:19Z"
      },
      "committer": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2019-10-09T15:20:12Z"
      },
      "message": "test: Seed test RNG context for each test case, print seed",
      "tree": {
        "sha": "ef72f69f145352b6c0a0a03cc5401711321e1e1b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ef72f69f145352b6c0a0a03cc5401711321e1e1b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fae43a97ca947cd0802392e9bb86d9d0572c0fba",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unknown_key",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\npUiL7wv8C8OZANLF5iD1ldS5x51u8W+pp7KHsyonQ4Y2IeIUhxgTbOLggKV+qfnN\nbYzVQCVnZoW42gercmnGw0suuyypJTRX95j0Ic0RZyjerivRCMdsOHjBwvhvGY+T\nrD+vnGAQD2725aeKd5dDatkJBbrHD5xGPsVmGNlMmzfV2GJ6+qCW9seyuXDO5KzF\nYiB031bOQRTr4AEsowm+6uS7gYlZq1x7z7DAbx62RCGWeQzeVzENGOY7gvdu2AL2\nk/FIc707Vo4FSPrPjcQKutmN7J9AuWApwHcR2k018vOZalmJMxCLRFwDFaOU0hVC\nQqvaQyC8SLv2Xt2fLhyC5jfz7PV/MllZfM51mTkvbw7eiP5dG+rOaZdvYdn5tTev\n4AAdov4mig86XAJ2F9dKcx50U6+qblOLiUvbE7YhoDn0Eiogl48n6knkaWSuwBXG\nzB9vD5H5wPBO4C1Dtd0Jj5Ol+/9Wc0Kej33ufKAVpfgwyHom9howXApCLtLfyPEo\n4MxYydXO\n=Mmay\n-----END PGP SIGNATURE-----",
        "payload": "tree ef72f69f145352b6c0a0a03cc5401711321e1e1b\nparent ab765c2ec7db042142298cdd6ca9c2f04cca8598\nauthor MarcoFalke <falke.marco@gmail.com> 1569503659 -0400\ncommitter MarcoFalke <falke.marco@gmail.com> 1570634412 -0400\n\ntest: Seed test RNG context for each test case, print seed\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fae43a97ca947cd0802392e9bb86d9d0572c0fba",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/fae43a97ca947cd0802392e9bb86d9d0572c0fba",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fae43a97ca947cd0802392e9bb86d9d0572c0fba/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ab765c2ec7db042142298cdd6ca9c2f04cca8598",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ab765c2ec7db042142298cdd6ca9c2f04cca8598",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ab765c2ec7db042142298cdd6ca9c2f04cca8598"
      }
    ],
    "stats": {
      "total": 61,
      "additions": 46,
      "deletions": 15
    },
    "files": [
      {
        "sha": "8ab6da3ce11126a4d2493c429dd74f966ffd3067",
        "filename": "src/test/bloom_tests.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/bloom_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/bloom_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/bloom_tests.cpp?ref=fae43a97ca947cd0802392e9bb86d9d0572c0fba",
        "patch": "@@ -461,7 +461,7 @@ static std::vector<unsigned char> RandomData()\n \n BOOST_AUTO_TEST_CASE(rolling_bloom)\n {\n-    SeedInsecureRand(/* deterministic */ true);\n+    SeedInsecureRand(SeedRand::ZEROS);\n     g_mock_deterministic_tests = true;\n \n     // last-100-entry, 1% false positive:"
      },
      {
        "sha": "f9682b1d56e04ce4c349033051307b48d1b9b7cd",
        "filename": "src/test/coins_tests.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/coins_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/coins_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/coins_tests.cpp?ref=fae43a97ca947cd0802392e9bb86d9d0572c0fba",
        "patch": "@@ -279,7 +279,7 @@ UtxoData::iterator FindRandomFrom(const std::set<COutPoint> &utxoSet) {\n // has the expected effect (the other duplicate is overwritten at all cache levels)\n BOOST_AUTO_TEST_CASE(updatecoins_simulation_test)\n {\n-    SeedInsecureRand(/* deterministic */ true);\n+    SeedInsecureRand(SeedRand::ZEROS);\n     g_mock_deterministic_tests = true;\n \n     bool spent_a_duplicate_coinbase = false;"
      },
      {
        "sha": "abae05a1901e7b580bbaa1dcf5f134071743628c",
        "filename": "src/test/cuckoocache_tests.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 5,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/cuckoocache_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/cuckoocache_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/cuckoocache_tests.cpp?ref=fae43a97ca947cd0802392e9bb86d9d0572c0fba",
        "patch": "@@ -29,7 +29,7 @@ BOOST_AUTO_TEST_SUITE(cuckoocache_tests);\n  */\n BOOST_AUTO_TEST_CASE(test_cuckoocache_no_fakes)\n {\n-    SeedInsecureRand(true);\n+    SeedInsecureRand(SeedRand::ZEROS);\n     CuckooCache::cache<uint256, SignatureCacheHasher> cc{};\n     size_t megabytes = 4;\n     cc.setup_bytes(megabytes << 20);\n@@ -47,7 +47,7 @@ BOOST_AUTO_TEST_CASE(test_cuckoocache_no_fakes)\n template <typename Cache>\n static double test_cache(size_t megabytes, double load)\n {\n-    SeedInsecureRand(true);\n+    SeedInsecureRand(SeedRand::ZEROS);\n     std::vector<uint256> hashes;\n     Cache set{};\n     size_t bytes = megabytes * (1 << 20);\n@@ -118,7 +118,7 @@ template <typename Cache>\n static void test_cache_erase(size_t megabytes)\n {\n     double load = 1;\n-    SeedInsecureRand(true);\n+    SeedInsecureRand(SeedRand::ZEROS);\n     std::vector<uint256> hashes;\n     Cache set{};\n     size_t bytes = megabytes * (1 << 20);\n@@ -181,7 +181,7 @@ template <typename Cache>\n static void test_cache_erase_parallel(size_t megabytes)\n {\n     double load = 1;\n-    SeedInsecureRand(true);\n+    SeedInsecureRand(SeedRand::ZEROS);\n     std::vector<uint256> hashes;\n     Cache set{};\n     size_t bytes = megabytes * (1 << 20);\n@@ -285,7 +285,7 @@ static void test_cache_generations()\n     // iterations with non-deterministic values, so it isn't \"overfit\" to the\n     // specific entropy in FastRandomContext(true) and implementation of the\n     // cache.\n-    SeedInsecureRand(true);\n+    SeedInsecureRand(SeedRand::ZEROS);\n \n     // block_activity models a chunk of network activity. n_insert elements are\n     // added to the cache. The first and last n/4 are stored for removal later"
      },
      {
        "sha": "b886b512e8e9d8d84c78169e0e2af65450a8a4ad",
        "filename": "src/test/pmt_tests.cpp",
        "status": "modified",
        "additions": 0,
        "deletions": 1,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/pmt_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/pmt_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/pmt_tests.cpp?ref=fae43a97ca947cd0802392e9bb86d9d0572c0fba",
        "patch": "@@ -30,7 +30,6 @@ BOOST_FIXTURE_TEST_SUITE(pmt_tests, BasicTestingSetup)\n \n BOOST_AUTO_TEST_CASE(pmt_test1)\n {\n-    SeedInsecureRand(false);\n     static const unsigned int nTxCounts[] = {1, 4, 7, 17, 56, 100, 127, 256, 312, 513, 1000, 4095};\n \n     for (int i = 0; i < 12; i++) {"
      },
      {
        "sha": "46aef0cc8c101426a62d9efa635cb332e3800908",
        "filename": "src/test/setup_common.cpp",
        "status": "modified",
        "additions": 23,
        "deletions": 1,
        "changes": 24,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/setup_common.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/setup_common.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/setup_common.cpp?ref=fae43a97ca947cd0802392e9bb86d9d0572c0fba",
        "patch": "@@ -33,6 +33,27 @@\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n \n FastRandomContext g_insecure_rand_ctx;\n+/** Random context to get unique temp data dirs. Separate from g_insecure_rand_ctx, which can be seeded from a const env var */\n+static FastRandomContext g_insecure_rand_ctx_temp_path;\n+\n+/** Return the unsigned from the environment var if available, otherwise 0 */\n+static uint256 GetUintFromEnv(const std::string& env_name)\n+{\n+    const char* num = std::getenv(env_name.c_str());\n+    if (!num) return {};\n+    return uint256S(num);\n+}\n+\n+void Seed(FastRandomContext& ctx)\n+{\n+    // Should be enough to get the seed once for the process\n+    static uint256 seed{};\n+    static const std::string RANDOM_CTX_SEED{\"RANDOM_CTX_SEED\"};\n+    if (seed.IsNull()) seed = GetUintFromEnv(RANDOM_CTX_SEED);\n+    if (seed.IsNull()) seed = GetRandHash();\n+    LogPrintf(\"%s: Setting random seed for current tests to %s=%s\\n\", __func__, RANDOM_CTX_SEED, seed.GetHex());\n+    ctx = FastRandomContext(seed);\n+}\n \n std::ostream& operator<<(std::ostream& os, const uint256& num)\n {\n@@ -41,12 +62,13 @@ std::ostream& operator<<(std::ostream& os, const uint256& num)\n }\n \n BasicTestingSetup::BasicTestingSetup(const std::string& chainName)\n-    : m_path_root(fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / strprintf(\"%lu_%i\", (unsigned long)GetTime(), (int)(InsecureRandRange(1 << 30))))\n+    : m_path_root{fs::temp_directory_path() / \"test_common_\" PACKAGE_NAME / std::to_string(g_insecure_rand_ctx_temp_path.rand32())}\n {\n     fs::create_directories(m_path_root);\n     gArgs.ForceSetArg(\"-datadir\", m_path_root.string());\n     ClearDatadirCache();\n     SelectParams(chainName);\n+    SeedInsecureRand();\n     gArgs.ForceSetArg(\"-printtoconsole\", \"0\");\n     InitLogging();\n     LogInstance().StartLogging();"
      },
      {
        "sha": "f9f7bcdcc910b20d15de306105c7e60df4b3d834",
        "filename": "src/test/setup_common.h",
        "status": "modified",
        "additions": 14,
        "deletions": 2,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/setup_common.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/setup_common.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/setup_common.h?ref=fae43a97ca947cd0802392e9bb86d9d0572c0fba",
        "patch": "@@ -38,9 +38,21 @@ extern FastRandomContext g_insecure_rand_ctx;\n  */\n extern bool g_mock_deterministic_tests;\n \n-static inline void SeedInsecureRand(bool deterministic = false)\n+enum class SeedRand {\n+    ZEROS, //!< Seed with a compile time constant of zeros\n+    SEED,  //!< Call the Seed() helper\n+};\n+\n+/** Seed the given random ctx or use the seed passed in via an environment var */\n+void Seed(FastRandomContext& ctx);\n+\n+static inline void SeedInsecureRand(SeedRand seed = SeedRand::SEED)\n {\n-    g_insecure_rand_ctx = FastRandomContext(deterministic);\n+    if (seed == SeedRand::ZEROS) {\n+        g_insecure_rand_ctx = FastRandomContext(/* deterministic */ true);\n+    } else {\n+        Seed(g_insecure_rand_ctx);\n+    }\n }\n \n static inline uint32_t InsecureRand32() { return g_insecure_rand_ctx.rand32(); }"
      },
      {
        "sha": "64f59aa06da48284fa8b93b17338fbc43183fa3a",
        "filename": "src/test/sighash_tests.cpp",
        "status": "modified",
        "additions": 0,
        "deletions": 2,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/sighash_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/sighash_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/sighash_tests.cpp?ref=fae43a97ca947cd0802392e9bb86d9d0572c0fba",
        "patch": "@@ -119,8 +119,6 @@ BOOST_FIXTURE_TEST_SUITE(sighash_tests, BasicTestingSetup)\n \n BOOST_AUTO_TEST_CASE(sighash_test)\n {\n-    SeedInsecureRand(false);\n-\n     #if defined(PRINT_SIGHASH_JSON)\n     std::cout << \"[\\n\";\n     std::cout << \"\\t[\\\"raw_transaction, script, input_index, hashType, signature_hash (result)\\\"],\\n\";"
      },
      {
        "sha": "83903ca11239de3d8e3f713152a200264e3c9927",
        "filename": "src/test/streams_tests.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/streams_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/streams_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/streams_tests.cpp?ref=fae43a97ca947cd0802392e9bb86d9d0572c0fba",
        "patch": "@@ -339,7 +339,7 @@ BOOST_AUTO_TEST_CASE(streams_buffered_file)\n BOOST_AUTO_TEST_CASE(streams_buffered_file_rand)\n {\n     // Make this test deterministic.\n-    SeedInsecureRand(true);\n+    SeedInsecureRand(SeedRand::ZEROS);\n \n     for (int rep = 0; rep < 50; ++rep) {\n         FILE* file = fsbridge::fopen(\"streams_test_tmp\", \"w+b\");"
      },
      {
        "sha": "d18db86a5c547c40db64ad5997914506b7260f27",
        "filename": "src/test/util_tests.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/util_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fae43a97ca947cd0802392e9bb86d9d0572c0fba/src/test/util_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/util_tests.cpp?ref=fae43a97ca947cd0802392e9bb86d9d0572c0fba",
        "patch": "@@ -1036,7 +1036,7 @@ BOOST_AUTO_TEST_CASE(util_IsHexNumber)\n \n BOOST_AUTO_TEST_CASE(util_seed_insecure_rand)\n {\n-    SeedInsecureRand(true);\n+    SeedInsecureRand(SeedRand::ZEROS);\n     for (int mod=2;mod<11;mod++)\n     {\n         int mask = 1;"
      }
    ]
  }
]