[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916060454",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#issuecomment-916060454",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22929",
    "id": 916060454,
    "node_id": "IC_kwDOABII5842mfkm",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-09T12:48:28Z",
    "updated_at": "2021-11-30T00:48:02Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23019](https://github.com/bitcoin/bitcoin/pull/23019) (rpc, wallet: Add listaddresses RPC by lsilva01)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/916060454/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/926898556",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#issuecomment-926898556",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/22929",
    "id": 926898556,
    "node_id": "IC_kwDOABII5843P1l8",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?u=9791e96cd4268d48e3517bac41eaf2b1d09759fd&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-09-24T20:23:21Z",
    "updated_at": "2021-09-24T20:23:21Z",
    "author_association": "MEMBER",
    "body": "ACK c97c2a99bf5aed073cc28967c5d47a33ec618752",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/926898556/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710464748",
    "pull_request_review_id": 756785367,
    "id": 710464748,
    "node_id": "PRRC_kwDOABII584qWNTs",
    "diff_hunk": "@@ -481,9 +493,13 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n     void LearnAllRelatedScripts(const CPubKey& key);\n \n     /**\n-     * Marks all keys in the keypool up to and including reserve_key as used.\n+     * Marks all keys in the keypool up to and including the provided key as used.\n+     *\n+     * @param keypool_id determines the last key to makr as used",
    "path": "src/wallet/scriptpubkeyman.h",
    "position": null,
    "original_position": 46,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In fec5ded232ca37b8a965ce09a3940ccb6ce43249 \"Return used destinations from ScriptPubKeyMan::MarkUnusedAddresses\"\r\n\r\ntypo: makr - > mark\r\n\r\n```suggestion\r\n     * @param keypool_id determines the last key to mark as used\r\n```",
    "created_at": "2021-09-16T20:45:34Z",
    "updated_at": "2021-09-16T20:58:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710464748",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710464748"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710464748"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710464748/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 498,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710466168",
    "pull_request_review_id": 756785367,
    "id": 710466168,
    "node_id": "PRRC_kwDOABII584qWNp4",
    "diff_hunk": "@@ -354,15 +354,22 @@ bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t i\n     return true;\n }\n \n-void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+std::vector<WalletDestination> LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     LOCK(cs_KeyStore);\n+    std::vector<WalletDestination> result;\n     // extract addresses and check if they match with an unused keypool key\n     for (const auto& keyid : GetAffectedKeys(script, *this)) {\n         std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n         if (mi != m_pool_key_to_index.end()) {\n             WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool keys up to this key as used\\n\", __func__);\n-            MarkReserveKeysAsUsed(mi->second);\n+            for (const auto& keypool : MarkReserveKeysAsUsed(mi->second)) {\n+                // derive all possible destinations as any of them could have been used\n+                for (const auto& type: LEGACY_OUTPUT_TYPES) {",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": null,
    "original_position": 17,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In fec5ded232ca37b8a965ce09a3940ccb6ce43249 \"Return used destinations from ScriptPubKeyMan::MarkUnusedAddresses\"\r\n\r\nnit: space before `:`\r\n\r\n```suggestion\r\n                for (const auto& type : LEGACY_OUTPUT_TYPES) {\r\n```",
    "created_at": "2021-09-16T20:47:04Z",
    "updated_at": "2021-09-16T20:58:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710466168",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710466168"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710466168"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710466168/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 368,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710472000",
    "pull_request_review_id": 756785367,
    "id": 710472000,
    "node_id": "PRRC_kwDOABII584qWPFA",
    "diff_hunk": "@@ -1059,7 +1059,19 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n             for (const CTxOut& txout: tx.vout) {\n                 const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);\n                 if (!spk_man) continue;\n-                spk_man->MarkUnusedAddresses(txout.scriptPubKey);\n+                for (auto& dest : spk_man->MarkUnusedAddresses(txout.scriptPubKey)) {\n+                    // If internal flag is not defined try to infer it from the ScriptPubKeyMan\n+                    if (!dest.internal.has_value()) {\n+                        dest.internal = IsInternalScriptPubKeyMan(spk_man);\n+                    }\n+\n+                    // If this is a receiving address and it's not in the address book yet\n+                    // (e.g. it wasn't generated on this node or we're restoring from backup)\n+                    // add it to the address book for proper transaction accounting\n+                    if (!dest.internal.value_or(true) && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {",
    "path": "src/wallet/wallet.cpp",
    "position": null,
    "original_position": 14,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "cbb90fbc00e345100587cd47926c6c7fc5487628",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In cbb90fbc00e345100587cd47926c6c7fc5487628 \"Automatically add labels to detected receiving addresses\"\r\n\r\nShouldn't we be marking everything that doesn't have `dest.internal` as a receiving address? i.e.\r\n\r\n```suggestion\r\n                   if (!dest.internal.value_or(false) && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {\r\n```",
    "created_at": "2021-09-16T20:53:24Z",
    "updated_at": "2021-09-16T20:58:45Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710472000",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710472000"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r710472000"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/710472000/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1071,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910861",
    "pull_request_review_id": 758292045,
    "id": 711910861,
    "node_id": "PRRC_kwDOABII584qbuXN",
    "diff_hunk": "@@ -481,9 +493,13 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n     void LearnAllRelatedScripts(const CPubKey& key);\n \n     /**\n-     * Marks all keys in the keypool up to and including reserve_key as used.\n+     * Marks all keys in the keypool up to and including the provided key as used.\n+     *\n+     * @param keypool_id determines the last key to makr as used",
    "path": "src/wallet/scriptpubkeyman.h",
    "position": null,
    "original_position": 46,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
    "user": {
      "login": "S3RK",
      "id": 1466284,
      "node_id": "MDQ6VXNlcjE0NjYyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1466284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/S3RK",
      "html_url": "https://github.com/S3RK",
      "followers_url": "https://api.github.com/users/S3RK/followers",
      "following_url": "https://api.github.com/users/S3RK/following{/other_user}",
      "gists_url": "https://api.github.com/users/S3RK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/S3RK/subscriptions",
      "organizations_url": "https://api.github.com/users/S3RK/orgs",
      "repos_url": "https://api.github.com/users/S3RK/repos",
      "events_url": "https://api.github.com/users/S3RK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/S3RK/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done",
    "created_at": "2021-09-20T06:48:02Z",
    "updated_at": "2021-09-20T06:48:02Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711910861",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910861"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711910861"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910861/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 498,
    "side": "RIGHT",
    "in_reply_to_id": 710464748
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910903",
    "pull_request_review_id": 758292090,
    "id": 711910903,
    "node_id": "PRRC_kwDOABII584qbuX3",
    "diff_hunk": "@@ -354,15 +354,22 @@ bool LegacyScriptPubKeyMan::TopUpInactiveHDChain(const CKeyID seed_id, int64_t i\n     return true;\n }\n \n-void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+std::vector<WalletDestination> LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     LOCK(cs_KeyStore);\n+    std::vector<WalletDestination> result;\n     // extract addresses and check if they match with an unused keypool key\n     for (const auto& keyid : GetAffectedKeys(script, *this)) {\n         std::map<CKeyID, int64_t>::const_iterator mi = m_pool_key_to_index.find(keyid);\n         if (mi != m_pool_key_to_index.end()) {\n             WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool keys up to this key as used\\n\", __func__);\n-            MarkReserveKeysAsUsed(mi->second);\n+            for (const auto& keypool : MarkReserveKeysAsUsed(mi->second)) {\n+                // derive all possible destinations as any of them could have been used\n+                for (const auto& type: LEGACY_OUTPUT_TYPES) {",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": null,
    "original_position": 17,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "fec5ded232ca37b8a965ce09a3940ccb6ce43249",
    "user": {
      "login": "S3RK",
      "id": 1466284,
      "node_id": "MDQ6VXNlcjE0NjYyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1466284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/S3RK",
      "html_url": "https://github.com/S3RK",
      "followers_url": "https://api.github.com/users/S3RK/followers",
      "following_url": "https://api.github.com/users/S3RK/following{/other_user}",
      "gists_url": "https://api.github.com/users/S3RK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/S3RK/subscriptions",
      "organizations_url": "https://api.github.com/users/S3RK/orgs",
      "repos_url": "https://api.github.com/users/S3RK/repos",
      "events_url": "https://api.github.com/users/S3RK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/S3RK/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done",
    "created_at": "2021-09-20T06:48:09Z",
    "updated_at": "2021-09-20T06:48:09Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711910903",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910903"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711910903"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711910903/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 368,
    "side": "RIGHT",
    "in_reply_to_id": 710466168
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711911667",
    "pull_request_review_id": 758292996,
    "id": 711911667,
    "node_id": "PRRC_kwDOABII584qbujz",
    "diff_hunk": "@@ -1059,7 +1059,19 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n             for (const CTxOut& txout: tx.vout) {\n                 const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);\n                 if (!spk_man) continue;\n-                spk_man->MarkUnusedAddresses(txout.scriptPubKey);\n+                for (auto& dest : spk_man->MarkUnusedAddresses(txout.scriptPubKey)) {\n+                    // If internal flag is not defined try to infer it from the ScriptPubKeyMan\n+                    if (!dest.internal.has_value()) {\n+                        dest.internal = IsInternalScriptPubKeyMan(spk_man);\n+                    }\n+\n+                    // If this is a receiving address and it's not in the address book yet\n+                    // (e.g. it wasn't generated on this node or we're restoring from backup)\n+                    // add it to the address book for proper transaction accounting\n+                    if (!dest.internal.value_or(true) && !FindAddressBookEntry(dest.dest, /* allow_change= */ false)) {",
    "path": "src/wallet/wallet.cpp",
    "position": null,
    "original_position": 14,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "cbb90fbc00e345100587cd47926c6c7fc5487628",
    "user": {
      "login": "S3RK",
      "id": 1466284,
      "node_id": "MDQ6VXNlcjE0NjYyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1466284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/S3RK",
      "html_url": "https://github.com/S3RK",
      "followers_url": "https://api.github.com/users/S3RK/followers",
      "following_url": "https://api.github.com/users/S3RK/following{/other_user}",
      "gists_url": "https://api.github.com/users/S3RK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/S3RK/subscriptions",
      "organizations_url": "https://api.github.com/users/S3RK/orgs",
      "repos_url": "https://api.github.com/users/S3RK/repos",
      "events_url": "https://api.github.com/users/S3RK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/S3RK/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I want to be conservative and skip if we can't determine if that's a change or a receiving destination. But the code is not obvious and I restructured it to make it explicit.",
    "created_at": "2021-09-20T06:49:46Z",
    "updated_at": "2021-09-20T06:49:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711911667",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711911667"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r711911667"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/711911667/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1071,
    "side": "RIGHT",
    "in_reply_to_id": 710472000
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719146825",
    "pull_request_review_id": 767510226,
    "id": 719146825,
    "node_id": "PRRC_kwDOABII584q3U9J",
    "diff_hunk": "@@ -1820,19 +1833,32 @@ bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n     return true;\n }\n \n-void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+std::vector<WalletDestination> DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     LOCK(cs_desc_man);\n+    std::vector<WalletDestination> result;\n     if (IsMine(script)) {\n         int32_t index = m_map_script_pub_keys[script];\n         if (index >= m_wallet_descriptor.next_index) {\n             WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n-            m_wallet_descriptor.next_index = index + 1;\n+            auto out_keys = std::make_unique<FlatSigningProvider>();\n+            std::vector<CScript> scripts_temp;\n+            while (index >= m_wallet_descriptor.next_index) {\n+                if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, *out_keys)) {",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 79,
    "original_position": 79,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
    "user": {
      "login": "S3RK",
      "id": 1466284,
      "node_id": "MDQ6VXNlcjE0NjYyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1466284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/S3RK",
      "html_url": "https://github.com/S3RK",
      "followers_url": "https://api.github.com/users/S3RK/followers",
      "following_url": "https://api.github.com/users/S3RK/following{/other_user}",
      "gists_url": "https://api.github.com/users/S3RK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/S3RK/subscriptions",
      "organizations_url": "https://api.github.com/users/S3RK/orgs",
      "repos_url": "https://api.github.com/users/S3RK/repos",
      "events_url": "https://api.github.com/users/S3RK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/S3RK/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "@achow101 I believe expanding from cache is enough here. But want to confirm.",
    "created_at": "2021-09-30T07:48:44Z",
    "updated_at": "2021-09-30T07:48:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719146825",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719146825"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719146825"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719146825/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1847,
    "original_line": 1847,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719149474",
    "pull_request_review_id": 767513414,
    "id": 719149474,
    "node_id": "PRRC_kwDOABII584q3Vmi",
    "diff_hunk": "@@ -1062,8 +1064,23 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n \n             // loop though all outputs\n             for (const CTxOut& txout: tx.vout) {\n-                for (const auto& spk_man_pair : m_spk_managers) {\n-                    spk_man_pair.second->MarkUnusedAddresses(txout.scriptPubKey);\n+                const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);",
    "path": "src/wallet/wallet.cpp",
    "position": null,
    "original_position": 17,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
    "user": {
      "login": "S3RK",
      "id": 1466284,
      "node_id": "MDQ6VXNlcjE0NjYyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1466284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/S3RK",
      "html_url": "https://github.com/S3RK",
      "followers_url": "https://api.github.com/users/S3RK/followers",
      "following_url": "https://api.github.com/users/S3RK/following{/other_user}",
      "gists_url": "https://api.github.com/users/S3RK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/S3RK/subscriptions",
      "organizations_url": "https://api.github.com/users/S3RK/orgs",
      "repos_url": "https://api.github.com/users/S3RK/repos",
      "events_url": "https://api.github.com/users/S3RK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/S3RK/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "@achow101 I think it's technically possible to have two descriptors producing same scriptPubKey. Wdyt?",
    "created_at": "2021-09-30T07:51:55Z",
    "updated_at": "2021-09-30T07:51:55Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719149474",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719149474"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719149474"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719149474/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1067,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719639229",
    "pull_request_review_id": 768177621,
    "id": 719639229,
    "node_id": "PRRC_kwDOABII584q5NK9",
    "diff_hunk": "@@ -1820,19 +1833,32 @@ bool DescriptorScriptPubKeyMan::TopUp(unsigned int size)\n     return true;\n }\n \n-void DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n+std::vector<WalletDestination> DescriptorScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     LOCK(cs_desc_man);\n+    std::vector<WalletDestination> result;\n     if (IsMine(script)) {\n         int32_t index = m_map_script_pub_keys[script];\n         if (index >= m_wallet_descriptor.next_index) {\n             WalletLogPrintf(\"%s: Detected a used keypool item at index %d, mark all keypool items up to this item as used\\n\", __func__, index);\n-            m_wallet_descriptor.next_index = index + 1;\n+            auto out_keys = std::make_unique<FlatSigningProvider>();\n+            std::vector<CScript> scripts_temp;\n+            while (index >= m_wallet_descriptor.next_index) {\n+                if (!m_wallet_descriptor.descriptor->ExpandFromCache(m_wallet_descriptor.next_index, m_wallet_descriptor.cache, scripts_temp, *out_keys)) {",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": 79,
    "original_position": 79,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes, that is.",
    "created_at": "2021-09-30T18:00:24Z",
    "updated_at": "2021-09-30T18:00:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719639229",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719639229"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719639229"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719639229/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 1847,
    "original_line": 1847,
    "side": "RIGHT",
    "in_reply_to_id": 719146825
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719641795",
    "pull_request_review_id": 768181185,
    "id": 719641795,
    "node_id": "PRRC_kwDOABII584q5NzD",
    "diff_hunk": "@@ -1062,8 +1064,23 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n \n             // loop though all outputs\n             for (const CTxOut& txout: tx.vout) {\n-                for (const auto& spk_man_pair : m_spk_managers) {\n-                    spk_man_pair.second->MarkUnusedAddresses(txout.scriptPubKey);\n+                const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);",
    "path": "src/wallet/wallet.cpp",
    "position": null,
    "original_position": 17,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
    "user": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Ah, that is indeed possible. In that case, we should keep this loop.",
    "created_at": "2021-09-30T18:04:09Z",
    "updated_at": "2021-09-30T18:04:09Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719641795",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719641795"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r719641795"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/719641795/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1067,
    "side": "RIGHT",
    "in_reply_to_id": 719149474
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720998301",
    "pull_request_review_id": 769811048,
    "id": 720998301,
    "node_id": "PRRC_kwDOABII584q-Y-d",
    "diff_hunk": "@@ -3276,6 +3276,29 @@ DescriptorScriptPubKeyMan* CWallet::GetDescriptorScriptPubKeyMan(const WalletDes\n     return nullptr;\n }\n \n+std::optional<bool> CWallet::IsInternalScriptPubKeyMan(ScriptPubKeyMan* spk_man) const\n+{\n+    // Legacy script pubkey man can't be either external or internal\n+    if (IsLegacy()) {\n+        return std::nullopt;\n+    }\n+\n+    // only active ScriptPubKeyMan can be internal\n+    if (!GetActiveScriptPubKeyMans().count(spk_man)) {\n+        return std::nullopt;\n+    }\n+\n+    const auto desc_spk_man = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man);\n+    if (!desc_spk_man) {\n+        throw std::runtime_error(std::string(__func__) + \": unexpected ScriptPubKeyMan type.\");\n+    }\n+\n+    LOCK(desc_spk_man->cs_desc_man);\n+    const auto& type = desc_spk_man->GetWalletDescriptor().descriptor->GetOutputType();\n+\n+    return GetScriptPubKeyMan(*type, /* internal= */ true) == desc_spk_man;",
    "path": "src/wallet/wallet.cpp",
    "position": 117,
    "original_position": 24,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "243473ed82c2c6ce79a40996a04e06fdab74f493",
    "user": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Should check `if (type)` or `has_value()` to ensure it has a value before calling `*type`",
    "created_at": "2021-10-04T02:32:52Z",
    "updated_at": "2021-10-04T02:53:19Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r720998301",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720998301"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r720998301"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720998301/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3306,
    "original_line": 3306,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720999793",
    "pull_request_review_id": 769811048,
    "id": 720999793,
    "node_id": "PRRC_kwDOABII584q-ZVx",
    "diff_hunk": "@@ -1448,7 +1458,10 @@ void LegacyScriptPubKeyMan::MarkReserveKeysAsUsed(int64_t keypool_id)\n         batch.ErasePool(index);\n         WalletLogPrintf(\"keypool index %d removed\\n\", index);\n         it = setKeyPool->erase(it);\n+        result.push_back(keypool);",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": null,
    "original_position": 55,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "3690de44544f596b6ee249b96149611ab16b883d",
    "user": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think this is better as `std::move(keypool)`?",
    "created_at": "2021-10-04T02:39:12Z",
    "updated_at": "2021-10-04T02:53:19Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r720999793",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720999793"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r720999793"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/720999793/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1461,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721002066",
    "pull_request_review_id": 769811048,
    "id": 721002066,
    "node_id": "PRRC_kwDOABII584q-Z5S",
    "diff_hunk": "@@ -210,5 +214,63 @@ def get_unconfirmed_utxo_entry(node, txid_to_match):\n         assert_equal(self.nodes[0].gettransaction(txid_3b)[\"bip125-replaceable\"], \"no\")\n         assert_equal(self.nodes[0].gettransaction(txid_4)[\"bip125-replaceable\"], \"unknown\")\n \n+    def run_externally_generated_address_test(self):\n+        \"\"\"Test behavior when receiving address is not in the address book.\"\"\"\n+\n+        self.log.info(\"Setup the same wallet on two nodes\")\n+        # refill keypool otherwise the second node wouldn't recognize addresses generated on the first nodes\n+        self.nodes[0].keypoolrefill(1000)\n+        self.stop_nodes()\n+        wallet0 = os.path.join(self.nodes[0].datadir, self.chain, self.default_wallet_name, \"wallet.dat\")\n+        wallet2 = os.path.join(self.nodes[2].datadir, self.chain, self.default_wallet_name, \"wallet.dat\")\n+        shutil.copyfile(wallet0, wallet2)\n+        self.start_nodes()\n+        # reconnect nodes\n+        self.connect_nodes(0, 1)\n+        self.connect_nodes(1, 2)\n+        self.connect_nodes(2, 0)\n+\n+        addr1 = self.nodes[0].getnewaddress(\"pizza1\", 'legacy')\n+        addr2 = self.nodes[0].getnewaddress(\"pizza2\", 'p2sh-segwit')\n+        addr3 = self.nodes[0].getnewaddress(\"pizza3\", 'bech32')\n+\n+        self.log.info(\"Send to externally generated addresses\")\n+        # send to N+2 address to test the keypool gap",
    "path": "test/functional/wallet_listtransactions.py",
    "position": null,
    "original_position": 54,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
    "user": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "What does `N+2` mean here (and below)?\r\n(I understand based on the code that `N` is meant to be the \"first\" key that node[0] and therefore also node[2] generates but the comment is confusing).",
    "created_at": "2021-10-04T02:49:33Z",
    "updated_at": "2021-10-04T02:53:19Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r721002066",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721002066"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r721002066"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/721002066/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 238,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921062",
    "pull_request_review_id": 772236741,
    "id": 722921062,
    "node_id": "PRRC_kwDOABII584rFuZm",
    "diff_hunk": "@@ -1062,8 +1064,23 @@ bool CWallet::AddToWalletIfInvolvingMe(const CTransactionRef& ptx, CWalletTx::Co\n \n             // loop though all outputs\n             for (const CTxOut& txout: tx.vout) {\n-                for (const auto& spk_man_pair : m_spk_managers) {\n-                    spk_man_pair.second->MarkUnusedAddresses(txout.scriptPubKey);\n+                const auto& spk_man = GetScriptPubKeyMan(txout.scriptPubKey);",
    "path": "src/wallet/wallet.cpp",
    "position": null,
    "original_position": 17,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
    "user": {
      "login": "S3RK",
      "id": 1466284,
      "node_id": "MDQ6VXNlcjE0NjYyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1466284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/S3RK",
      "html_url": "https://github.com/S3RK",
      "followers_url": "https://api.github.com/users/S3RK/followers",
      "following_url": "https://api.github.com/users/S3RK/following{/other_user}",
      "gists_url": "https://api.github.com/users/S3RK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/S3RK/subscriptions",
      "organizations_url": "https://api.github.com/users/S3RK/orgs",
      "repos_url": "https://api.github.com/users/S3RK/repos",
      "events_url": "https://api.github.com/users/S3RK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/S3RK/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Returned the cycle and removed `GetScriptPubKeyMan` function to avoid such mistakes in the future",
    "created_at": "2021-10-06T06:24:53Z",
    "updated_at": "2021-10-06T06:24:53Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921062",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921062"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921062"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921062/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1067,
    "side": "RIGHT",
    "in_reply_to_id": 719149474
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921332",
    "pull_request_review_id": 772237122,
    "id": 722921332,
    "node_id": "PRRC_kwDOABII584rFud0",
    "diff_hunk": "@@ -3276,6 +3276,29 @@ DescriptorScriptPubKeyMan* CWallet::GetDescriptorScriptPubKeyMan(const WalletDes\n     return nullptr;\n }\n \n+std::optional<bool> CWallet::IsInternalScriptPubKeyMan(ScriptPubKeyMan* spk_man) const\n+{\n+    // Legacy script pubkey man can't be either external or internal\n+    if (IsLegacy()) {\n+        return std::nullopt;\n+    }\n+\n+    // only active ScriptPubKeyMan can be internal\n+    if (!GetActiveScriptPubKeyMans().count(spk_man)) {\n+        return std::nullopt;\n+    }\n+\n+    const auto desc_spk_man = dynamic_cast<DescriptorScriptPubKeyMan*>(spk_man);\n+    if (!desc_spk_man) {\n+        throw std::runtime_error(std::string(__func__) + \": unexpected ScriptPubKeyMan type.\");\n+    }\n+\n+    LOCK(desc_spk_man->cs_desc_man);\n+    const auto& type = desc_spk_man->GetWalletDescriptor().descriptor->GetOutputType();\n+\n+    return GetScriptPubKeyMan(*type, /* internal= */ true) == desc_spk_man;",
    "path": "src/wallet/wallet.cpp",
    "position": 117,
    "original_position": 24,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "243473ed82c2c6ce79a40996a04e06fdab74f493",
    "user": {
      "login": "S3RK",
      "id": 1466284,
      "node_id": "MDQ6VXNlcjE0NjYyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1466284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/S3RK",
      "html_url": "https://github.com/S3RK",
      "followers_url": "https://api.github.com/users/S3RK/followers",
      "following_url": "https://api.github.com/users/S3RK/following{/other_user}",
      "gists_url": "https://api.github.com/users/S3RK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/S3RK/subscriptions",
      "organizations_url": "https://api.github.com/users/S3RK/orgs",
      "repos_url": "https://api.github.com/users/S3RK/repos",
      "events_url": "https://api.github.com/users/S3RK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/S3RK/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Active descriptors always have `type` defined, added assertion",
    "created_at": "2021-10-06T06:25:28Z",
    "updated_at": "2021-10-06T06:25:28Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921332",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921332"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921332"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921332/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3306,
    "original_line": 3306,
    "side": "RIGHT",
    "in_reply_to_id": 720998301
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921402",
    "pull_request_review_id": 772237228,
    "id": 722921402,
    "node_id": "PRRC_kwDOABII584rFue6",
    "diff_hunk": "@@ -1448,7 +1458,10 @@ void LegacyScriptPubKeyMan::MarkReserveKeysAsUsed(int64_t keypool_id)\n         batch.ErasePool(index);\n         WalletLogPrintf(\"keypool index %d removed\\n\", index);\n         it = setKeyPool->erase(it);\n+        result.push_back(keypool);",
    "path": "src/wallet/scriptpubkeyman.cpp",
    "position": null,
    "original_position": 55,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "3690de44544f596b6ee249b96149611ab16b883d",
    "user": {
      "login": "S3RK",
      "id": 1466284,
      "node_id": "MDQ6VXNlcjE0NjYyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1466284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/S3RK",
      "html_url": "https://github.com/S3RK",
      "followers_url": "https://api.github.com/users/S3RK/followers",
      "following_url": "https://api.github.com/users/S3RK/following{/other_user}",
      "gists_url": "https://api.github.com/users/S3RK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/S3RK/subscriptions",
      "organizations_url": "https://api.github.com/users/S3RK/orgs",
      "repos_url": "https://api.github.com/users/S3RK/repos",
      "events_url": "https://api.github.com/users/S3RK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/S3RK/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done",
    "created_at": "2021-10-06T06:25:37Z",
    "updated_at": "2021-10-06T06:25:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921402",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921402"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921402"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921402/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1461,
    "side": "RIGHT",
    "in_reply_to_id": 720999793
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921591",
    "pull_request_review_id": 772237474,
    "id": 722921591,
    "node_id": "PRRC_kwDOABII584rFuh3",
    "diff_hunk": "@@ -210,5 +214,63 @@ def get_unconfirmed_utxo_entry(node, txid_to_match):\n         assert_equal(self.nodes[0].gettransaction(txid_3b)[\"bip125-replaceable\"], \"no\")\n         assert_equal(self.nodes[0].gettransaction(txid_4)[\"bip125-replaceable\"], \"unknown\")\n \n+    def run_externally_generated_address_test(self):\n+        \"\"\"Test behavior when receiving address is not in the address book.\"\"\"\n+\n+        self.log.info(\"Setup the same wallet on two nodes\")\n+        # refill keypool otherwise the second node wouldn't recognize addresses generated on the first nodes\n+        self.nodes[0].keypoolrefill(1000)\n+        self.stop_nodes()\n+        wallet0 = os.path.join(self.nodes[0].datadir, self.chain, self.default_wallet_name, \"wallet.dat\")\n+        wallet2 = os.path.join(self.nodes[2].datadir, self.chain, self.default_wallet_name, \"wallet.dat\")\n+        shutil.copyfile(wallet0, wallet2)\n+        self.start_nodes()\n+        # reconnect nodes\n+        self.connect_nodes(0, 1)\n+        self.connect_nodes(1, 2)\n+        self.connect_nodes(2, 0)\n+\n+        addr1 = self.nodes[0].getnewaddress(\"pizza1\", 'legacy')\n+        addr2 = self.nodes[0].getnewaddress(\"pizza2\", 'p2sh-segwit')\n+        addr3 = self.nodes[0].getnewaddress(\"pizza3\", 'bech32')\n+\n+        self.log.info(\"Send to externally generated addresses\")\n+        # send to N+2 address to test the keypool gap",
    "path": "test/functional/wallet_listtransactions.py",
    "position": null,
    "original_position": 54,
    "commit_id": "3d71d16d1eb4173c70d4c294559fc2365e189856",
    "original_commit_id": "a438bcc7e2cb8c36bfc5d1bc28903f899249549b",
    "user": {
      "login": "S3RK",
      "id": 1466284,
      "node_id": "MDQ6VXNlcjE0NjYyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1466284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/S3RK",
      "html_url": "https://github.com/S3RK",
      "followers_url": "https://api.github.com/users/S3RK/followers",
      "following_url": "https://api.github.com/users/S3RK/following{/other_user}",
      "gists_url": "https://api.github.com/users/S3RK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/S3RK/subscriptions",
      "organizations_url": "https://api.github.com/users/S3RK/orgs",
      "repos_url": "https://api.github.com/users/S3RK/repos",
      "events_url": "https://api.github.com/users/S3RK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/S3RK/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes. I updated the comments",
    "created_at": "2021-10-06T06:26:01Z",
    "updated_at": "2021-10-06T06:26:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921591",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921591"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/22929#discussion_r722921591"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/22929"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/722921591/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 238,
    "side": "RIGHT",
    "in_reply_to_id": 721002066
  }
]