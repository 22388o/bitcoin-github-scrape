[
  {
    "sha": "6cca05d65d77d3b026c733e7db463af481a1dc72",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2Y2NhMDVkNjVkNzdkM2IwMjZjNzMzZTdkYjQ2M2FmNDgxYTFkYzcy",
    "commit": {
      "author": {
        "name": "Nelson Yen",
        "email": "1801104+n2yen@users.noreply.github.com",
        "date": "2018-06-08T07:22:35Z"
      },
      "committer": {
        "name": "Nelson Yen",
        "email": "1801104+n2yen@users.noreply.github.com",
        "date": "2020-05-30T15:48:01Z"
      },
      "message": "Fix #13371 - call umask earlier and remove it from AppInitBasicSetup() as it is too late there.\n\nWhen the option -sysperms=false (default) is enabled, the created datadirs does not take into account the default umask setting of '077'.\nFix moves the umask operation as early as possible inside of bitcoind, and bitcoin-qt. This was needed because by the time AppInitBasicSetup()\nis called, datadir, has typically already been created. Calling umask earlier ensures any filesystem writes that follows has the correct umask set.\n\nTests: feature_sysperms.py - validates datadir permissions where -sysperms=false (default)\nNotes:\n'-sysperms' option requires '-disablewallet'\n- add check for windows platform, feature_nosysperms.py will explicitly skip the test if\n  'Windows' platform is detected.\n\nif bitcoind is built with NO_WALLET=1. That is -sysperms will fail if\nnot accompanied with -disablewallet option",
      "tree": {
        "sha": "5c3544f635480a3db617a589a1170df87e39a0f6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5c3544f635480a3db617a589a1170df87e39a0f6"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6cca05d65d77d3b026c733e7db463af481a1dc72",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6cca05d65d77d3b026c733e7db463af481a1dc72",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/6cca05d65d77d3b026c733e7db463af481a1dc72",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6cca05d65d77d3b026c733e7db463af481a1dc72/comments",
    "author": {
      "login": "n2yen",
      "id": 1801104,
      "node_id": "MDQ6VXNlcjE4MDExMDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1801104?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/n2yen",
      "html_url": "https://github.com/n2yen",
      "followers_url": "https://api.github.com/users/n2yen/followers",
      "following_url": "https://api.github.com/users/n2yen/following{/other_user}",
      "gists_url": "https://api.github.com/users/n2yen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/n2yen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/n2yen/subscriptions",
      "organizations_url": "https://api.github.com/users/n2yen/orgs",
      "repos_url": "https://api.github.com/users/n2yen/repos",
      "events_url": "https://api.github.com/users/n2yen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/n2yen/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "n2yen",
      "id": 1801104,
      "node_id": "MDQ6VXNlcjE4MDExMDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1801104?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/n2yen",
      "html_url": "https://github.com/n2yen",
      "followers_url": "https://api.github.com/users/n2yen/followers",
      "following_url": "https://api.github.com/users/n2yen/following{/other_user}",
      "gists_url": "https://api.github.com/users/n2yen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/n2yen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/n2yen/subscriptions",
      "organizations_url": "https://api.github.com/users/n2yen/orgs",
      "repos_url": "https://api.github.com/users/n2yen/repos",
      "events_url": "https://api.github.com/users/n2yen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/n2yen/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e478b11db0b12951a418ae94c9465eae200af55b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e478b11db0b12951a418ae94c9465eae200af55b",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e478b11db0b12951a418ae94c9465eae200af55b"
      }
    ],
    "stats": {
      "total": 92,
      "additions": 88,
      "deletions": 4
    },
    "files": [
      {
        "sha": "196e59277917f1c9dc12358ec096467b46a7be2e",
        "filename": "src/bitcoind.cpp",
        "status": "modified",
        "additions": 13,
        "deletions": 0,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6cca05d65d77d3b026c733e7db463af481a1dc72/src/bitcoind.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6cca05d65d77d3b026c733e7db463af481a1dc72/src/bitcoind.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bitcoind.cpp?ref=6cca05d65d77d3b026c733e7db463af481a1dc72",
        "patch": "@@ -25,6 +25,10 @@\n \n #include <functional>\n \n+#ifndef WIN32\n+#include <sys/stat.h>\n+#endif\n+\n const std::function<std::string(const char*)> G_TRANSLATION_FUN = nullptr;\n UrlDecodeFn* const URL_DECODE = urlDecode;\n \n@@ -78,7 +82,16 @@ static bool AppInit(int argc, char* argv[])\n         return true;\n     }\n \n+\n     util::Ref context{node};\n+\n+#ifndef WIN32\n+    // set umask before any filesystem writes occur\n+    if (!gArgs.GetBoolArg(\"-sysperms\", false)) {\n+        umask(077);\n+    }\n+#endif\n+\n     try\n     {\n         if (!CheckDataDirOption()) {"
      },
      {
        "sha": "ab3878ec39335f19e80170dba64a473dcc526b92",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 0,
        "deletions": 4,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6cca05d65d77d3b026c733e7db463af481a1dc72/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6cca05d65d77d3b026c733e7db463af481a1dc72/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=6cca05d65d77d3b026c733e7db463af481a1dc72",
        "patch": "@@ -935,10 +935,6 @@ bool AppInitBasicSetup()\n     }\n \n #ifndef WIN32\n-    if (!gArgs.GetBoolArg(\"-sysperms\", false)) {\n-        umask(077);\n-    }\n-\n     // Clean shutdown on SIGTERM\n     registerSignalHandler(SIGTERM, HandleSIGTERM);\n     registerSignalHandler(SIGINT, HandleSIGTERM);"
      },
      {
        "sha": "962c5f88bda300bfdf51600e9bc2733b68ab36c0",
        "filename": "src/qt/bitcoin.cpp",
        "status": "modified",
        "additions": 14,
        "deletions": 0,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6cca05d65d77d3b026c733e7db463af481a1dc72/src/qt/bitcoin.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6cca05d65d77d3b026c733e7db463af481a1dc72/src/qt/bitcoin.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/bitcoin.cpp?ref=6cca05d65d77d3b026c733e7db463af481a1dc72",
        "patch": "@@ -37,6 +37,13 @@\n #include <validation.h>\n \n #include <memory>\n+#include <stdint.h>\n+\n+#ifndef WIN32\n+#include <sys/stat.h>\n+#endif\n+\n+#include <boost/thread.hpp>\n \n #include <QApplication>\n #include <QDebug>\n@@ -484,6 +491,13 @@ int GuiMain(int argc, char* argv[])\n         return EXIT_SUCCESS;\n     }\n \n+#ifndef WIN32\n+    // set umask before any filesystem writes occur\n+    if (!gArgs.GetBoolArg(\"-sysperms\", false)) {\n+        umask(077);\n+    }\n+#endif\n+\n     /// 5. Now that settings and translations are available, ask user for data directory\n     // User language is set up: pick a data directory\n     bool did_show_intro = false;"
      },
      {
        "sha": "4de77a668cc5dcad6667dcf72a388cb8402bb4d3",
        "filename": "test/functional/feature_sysperms.py",
        "status": "added",
        "additions": 60,
        "deletions": 0,
        "changes": 60,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6cca05d65d77d3b026c733e7db463af481a1dc72/test/functional/feature_sysperms.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6cca05d65d77d3b026c733e7db463af481a1dc72/test/functional/feature_sysperms.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/feature_sysperms.py?ref=6cca05d65d77d3b026c733e7db463af481a1dc72",
        "patch": "@@ -0,0 +1,60 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2018 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Verify -sysperms=false (default) works as expected.\"\"\"\n+\n+import os\n+import platform\n+import stat\n+\n+from test_framework.test_framework import BitcoinTestFramework, SkipTest\n+\n+\n+class SyspermsTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+\n+    def check_nosysperms_pathname(self, fullpathname):\n+        self.log.info('{}  {}'.format(stat.filemode(os.stat(fullpathname).st_mode), fullpathname))\n+        return (os.stat(fullpathname).st_mode & (stat.S_IRWXO | stat.S_IRWXG)) == 0\n+\n+    def check_nosysperms_dir(self, regtest_dirpath):\n+        result = []\n+        for path, dirs, files in os.walk(regtest_dirpath):\n+            for dirname in dirs:\n+                result.append(self.check_nosysperms_pathname(os.path.join(path, dirname)))\n+\n+            for filename in files:\n+                result.append(self.check_nosysperms_pathname(os.path.join(path, filename)))\n+        return result\n+\n+    def run_test(self):\n+        self.log.info(\"Check for valid platform\")\n+        if platform.system() == 'Windows':\n+            raise SkipTest(\"This test does not run on Windows.\")\n+\n+        self.restart_node(0)\n+        datadir = self.nodes[0].datadir\n+\n+        self.log.info(\"Running test without -sysperms option - assuming umask of '077'\")\n+        self.log.info('-datadir: {}'.format(datadir))\n+\n+        self.log.info('Checking permissions... ')\n+        # check regtest dir and its contents\n+        regtest_dirpath = os.path.join(datadir, 'regtest')\n+        assert self.check_nosysperms_pathname(regtest_dirpath)\n+        assert any(self.check_nosysperms_dir(regtest_dirpath))\n+        self.log.info('Pass.')\n+\n+        # Run test again with -sysperms\n+        self.stop_node(1)\n+        # Now retry an confirm node starts as expected\n+        self.log.info(\"Running test with -sysperms -disablewallet options\")\n+        self.start_node(1, extra_args=[\"-sysperms\", \"-disablewallet\"])\n+        self.log.info('Pass.')\n+\n+\n+if __name__ == '__main__':\n+    SyspermsTest().main()"
      },
      {
        "sha": "d1907934f30598b8383f6fa4b2f9ca5d5aee64ee",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6cca05d65d77d3b026c733e7db463af481a1dc72/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6cca05d65d77d3b026c733e7db463af481a1dc72/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=6cca05d65d77d3b026c733e7db463af481a1dc72",
        "patch": "@@ -180,6 +180,7 @@\n     'rpc_getblockfilter.py',\n     'rpc_invalidateblock.py',\n     'feature_rbf.py',\n+    'feature_sysperms.py',\n     'mempool_packages.py',\n     'mempool_package_onemore.py',\n     'rpc_createmultisig.py',"
      }
    ]
  },
  {
    "sha": "82e2f141c18884a444613c4323f4bff51a60e7e0",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4MmUyZjE0MWMxODg4NGE0NDQ2MTNjNDMyM2Y0YmZmNTFhNjBlN2Uw",
    "commit": {
      "author": {
        "name": "Nelson Yen",
        "email": "1801104+n2yen@users.noreply.github.com",
        "date": "2020-05-31T22:43:14Z"
      },
      "committer": {
        "name": "Nelson Yen",
        "email": "1801104+n2yen@users.noreply.github.com",
        "date": "2020-05-31T22:43:14Z"
      },
      "message": "rebased and move sysperms check after reading of config file",
      "tree": {
        "sha": "c93a5bf4c766c8b83f2c66c42dd1c0f9acfae7c2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c93a5bf4c766c8b83f2c66c42dd1c0f9acfae7c2"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/82e2f141c18884a444613c4323f4bff51a60e7e0",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/82e2f141c18884a444613c4323f4bff51a60e7e0",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/82e2f141c18884a444613c4323f4bff51a60e7e0",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/82e2f141c18884a444613c4323f4bff51a60e7e0/comments",
    "author": {
      "login": "n2yen",
      "id": 1801104,
      "node_id": "MDQ6VXNlcjE4MDExMDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1801104?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/n2yen",
      "html_url": "https://github.com/n2yen",
      "followers_url": "https://api.github.com/users/n2yen/followers",
      "following_url": "https://api.github.com/users/n2yen/following{/other_user}",
      "gists_url": "https://api.github.com/users/n2yen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/n2yen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/n2yen/subscriptions",
      "organizations_url": "https://api.github.com/users/n2yen/orgs",
      "repos_url": "https://api.github.com/users/n2yen/repos",
      "events_url": "https://api.github.com/users/n2yen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/n2yen/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "n2yen",
      "id": 1801104,
      "node_id": "MDQ6VXNlcjE4MDExMDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1801104?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/n2yen",
      "html_url": "https://github.com/n2yen",
      "followers_url": "https://api.github.com/users/n2yen/followers",
      "following_url": "https://api.github.com/users/n2yen/following{/other_user}",
      "gists_url": "https://api.github.com/users/n2yen/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/n2yen/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/n2yen/subscriptions",
      "organizations_url": "https://api.github.com/users/n2yen/orgs",
      "repos_url": "https://api.github.com/users/n2yen/repos",
      "events_url": "https://api.github.com/users/n2yen/events{/privacy}",
      "received_events_url": "https://api.github.com/users/n2yen/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6cca05d65d77d3b026c733e7db463af481a1dc72",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6cca05d65d77d3b026c733e7db463af481a1dc72",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6cca05d65d77d3b026c733e7db463af481a1dc72"
      }
    ],
    "stats": {
      "total": 28,
      "additions": 14,
      "deletions": 14
    },
    "files": [
      {
        "sha": "26b3d6090815e4d36d41910ce27f3497383c0983",
        "filename": "src/bitcoind.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 7,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/82e2f141c18884a444613c4323f4bff51a60e7e0/src/bitcoind.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/82e2f141c18884a444613c4323f4bff51a60e7e0/src/bitcoind.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bitcoind.cpp?ref=82e2f141c18884a444613c4323f4bff51a60e7e0",
        "patch": "@@ -85,13 +85,6 @@ static bool AppInit(int argc, char* argv[])\n \n     util::Ref context{node};\n \n-#ifndef WIN32\n-    // set umask before any filesystem writes occur\n-    if (!gArgs.GetBoolArg(\"-sysperms\", false)) {\n-        umask(077);\n-    }\n-#endif\n-\n     try\n     {\n         if (!CheckDataDirOption()) {\n@@ -116,6 +109,13 @@ static bool AppInit(int argc, char* argv[])\n \n         // -server defaults to true for bitcoind but not for the GUI so do this here\n         gArgs.SoftSetBoolArg(\"-server\", true);\n+\n+#ifndef WIN32\n+    // set umask before any filesystem writes occur\n+    if (!gArgs.GetBoolArg(\"-sysperms\", false)) {\n+        umask(077);\n+    }\n+#endif\n         // Set this early so that parameter interactions go to console\n         InitLogging();\n         InitParameterInteraction();"
      },
      {
        "sha": "69889232fe96223b25c5e333a1d3f8dda99bb1d2",
        "filename": "src/qt/bitcoin.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 7,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/82e2f141c18884a444613c4323f4bff51a60e7e0/src/qt/bitcoin.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/82e2f141c18884a444613c4323f4bff51a60e7e0/src/qt/bitcoin.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/bitcoin.cpp?ref=82e2f141c18884a444613c4323f4bff51a60e7e0",
        "patch": "@@ -491,13 +491,6 @@ int GuiMain(int argc, char* argv[])\n         return EXIT_SUCCESS;\n     }\n \n-#ifndef WIN32\n-    // set umask before any filesystem writes occur\n-    if (!gArgs.GetBoolArg(\"-sysperms\", false)) {\n-        umask(077);\n-    }\n-#endif\n-\n     /// 5. Now that settings and translations are available, ask user for data directory\n     // User language is set up: pick a data directory\n     bool did_show_intro = false;\n@@ -520,6 +513,13 @@ int GuiMain(int argc, char* argv[])\n         return EXIT_FAILURE;\n     }\n \n+#ifndef WIN32\n+    // set umask before any filesystem writes occur\n+    if (!gArgs.GetBoolArg(\"-sysperms\", false)) {\n+        umask(077);\n+    }\n+#endif\n+\n     /// 7. Determine network (and switch to network specific options)\n     // - Do not call Params() before this step\n     // - Do this after parsing the configuration file, as the network can be switched there"
      }
    ]
  }
]