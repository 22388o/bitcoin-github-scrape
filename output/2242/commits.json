[
  {
    "sha": "e5a83b70ad4574cce744cc0964a49630c25acd4e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplNWE4M2I3MGFkNDU3NGNjZTc0NGNjMDk2NGE0OTYzMGMyNWFjZDRl",
    "commit": {
      "author": {
        "name": "Philip Kaufmann",
        "email": "phil.kaufmann@t-online.de",
        "date": "2013-01-30T15:18:56Z"
      },
      "committer": {
        "name": "Philip Kaufmann",
        "email": "phil.kaufmann@t-online.de",
        "date": "2013-01-30T18:34:05Z"
      },
      "message": "fix crash with -reindex and empty datadir\n\n- check for existance of /blocks/ dir and verify if it is non-empty,\n  disable -reindex, if these checks fail\n- print \"Reindexing aborted\" to log, if OpenBlockFile() in ThreadImport()\n  fails",
      "tree": {
        "sha": "574b507dcd09b22cce6d09219a47e0acfc28eeaa",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/574b507dcd09b22cce6d09219a47e0acfc28eeaa"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e5a83b70ad4574cce744cc0964a49630c25acd4e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e5a83b70ad4574cce744cc0964a49630c25acd4e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e5a83b70ad4574cce744cc0964a49630c25acd4e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e5a83b70ad4574cce744cc0964a49630c25acd4e/comments",
    "author": null,
    "committer": null,
    "parents": [
      {
        "sha": "db3b4ade7ba8a91afaa649177d5f297f20eb40fd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/db3b4ade7ba8a91afaa649177d5f297f20eb40fd",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/db3b4ade7ba8a91afaa649177d5f297f20eb40fd"
      }
    ],
    "stats": {
      "total": 17,
      "additions": 14,
      "deletions": 3
    },
    "files": [
      {
        "sha": "a021018ee1a530da9d5b076ad5427d69ae8461e4",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 14,
        "deletions": 3,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e5a83b70ad4574cce744cc0964a49630c25acd4e/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e5a83b70ad4574cce744cc0964a49630c25acd4e/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=e5a83b70ad4574cce744cc0964a49630c25acd4e",
        "patch": "@@ -355,16 +355,21 @@ void ThreadImport(void *data) {\n         while (!fRequestShutdown) {\n             CDiskBlockPos pos(nFile, 0);\n             FILE *file = OpenBlockFile(pos, true);\n-            if (!file)\n+            if (!file) {\n+                nFile = -1; // use -1 as a flag for reindexing aborted\n                 break;\n+            }\n             printf(\"Reindexing block file blk%05u.dat...\\n\", (unsigned int)nFile);\n             LoadExternalBlockFile(file, &pos);\n             nFile++;\n         }\n         if (!fRequestShutdown) {\n             pblocktree->WriteReindexing(false);\n             fReindex = false;\n-            printf(\"Reindexing finished\\n\");\n+            if (nFile != -1)\n+                printf(\"Reindexing finished\\n\");\n+            else\n+                printf(\"Reindexing aborted\\n\");\n         }\n     }\n \n@@ -740,7 +745,14 @@ bool AppInit2()\n \n     // ********************************************************* Step 7: load block chain\n \n+    filesystem::path blocksDir = GetDataDir() / \"blocks\";\n+\n     fReindex = GetBoolArg(\"-reindex\");\n+    // don't try to reindex, if blocks dir is missing or empty\n+    if (fReindex && (filesystem::exists(blocksDir) ? filesystem::is_empty(blocksDir) : true)) {\n+        InitWarning(_(\"Disabling -reindex, because blocks directory is missing or empty.\"));\n+        fReindex = false;\n+    }\n \n     if (!bitdb.Open(GetDataDir()))\n     {\n@@ -751,7 +763,6 @@ bool AppInit2()\n     }\n \n     // Upgrading to 0.8; hard-link the old blknnnn.dat files into /blocks/\n-    filesystem::path blocksDir = GetDataDir() / \"blocks\";\n     if (!filesystem::exists(blocksDir))\n     {\n         filesystem::create_directories(blocksDir);"
      }
    ]
  }
]