casey,2015-09-03T14:47:23Z,"`-maxuploadtarget` is in MB (1000000), not MiB (1048576), not currently documented, but just in case it does get documented.\n\nIf a user wants to control the total amount transferred, then I don't think MB per day is a good unit to use. If they have a transfer cap, then it is most likely tied to a monthly billing cycle, so MB/month is likely better. (For example, I think Comcast in the US has a 2",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-137473807,137473807,
MarcoFalke,2015-09-03T14:54:59Z,> MB/month is likely better\n\nWhich could result in all of the 100GB being eaten up on the first few days of the timeframe. Maybe the owner restarts the server mid-month and then serves 200GB of historic blocks that month.\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-137475865,137475865,
laanwj,2015-09-03T14:57:48Z,"> Which could result in all of the 100GB being eaten up on the first few days of the timeframe. Maybe the owner restarts the server mid-month and then serves 200GB of historic blocks that month.\n\nOnce combined with connection throttling, which would make the speed that the 100GB can be 'eaten up' configurable, (which @cfields is working on ) it's less of an issue. \n",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-137476598,137476598,
jonasschnelli,2015-09-03T15:09:48Z,"> -maxuploadtarget is in MB (1000000), not MiB (1048576), not currently documented, but just in case it does get documented.\n\n@casey Thanks. Will fix it.\n\nNot sure about limit per month or per day.\nPer month can be difficult because not every month has the same amount of days (30/31/27/28). Also it's unclear how one could get ""in sync"" with providers month rhythm (must not be first to last da",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-137479693,137479693,
luke-jr,2015-09-03T15:48:03Z,"I need some kind of goal set in kB/second, as I am often forced to shutdown my node for reliable phone calls. :(\n",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-137490859,137490859,
ghost,2015-09-04T00:02:40Z,"Agree with @luke-jr here, we think about available bandwidth in terms of kB/sec rather than MB/day because that's how it's always reported to us - adverts from ISPs, speed checking websites, P2P torrenting apps etc.\n",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-137605028,137605028,
jonasschnelli,2015-09-04T07:20:46Z,"@NanoAkron: not sure if @luke-jr is for a bandwidth kB/sec limit.\nWhat is the most annoying thing that can happen when you download something over torrent? Probably if you connected and download from a throttled peer.\n\nBandwidth throttled peers is not something we should _not_ encourage within bitcoin-core. If a node-operator likes to limit the bandwidth, he can use different tools. What we rea",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-137663963,137663963,
MarcoFalke,2015-09-04T08:47:09Z,"> download from a throttled [torrent] peer\n\nI don't think you can compare torrent to bitcoin-core serving blocks... Using torrent you are happy to get any transmission speed because it is parallel download anyway.\n\nOn the contrary, bitcoin-core is doing moving-window download (c.f. #4468). So you always want to fetch the blocks from peers which can upload to you not much slower than your downl",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-137681449,137681449,
jonasschnelli,2015-09-04T09:05:55Z,"> This PR makes the full node to disconnect from initial-download-peers instead of serving them at lower speed, which sounds like the better solution to me.\n\nTwo questions:\n- What is the benefit for a peer in initial sync-state when it gets served with throttled bandwidth (lets assume 10kb/s) in comparison to a disconnect?\n- What is the benefit for a bandwidth limited peer to serve historical ",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-137684346,137684346,
sipa,2015-09-04T09:12:32Z,"Since 0.10 it does not really hurt much anymore to be served by a throttled\npeer, as the download algorithm will download in parallel from many, and if\none is significantly slower than others, disconnect it itself.\n",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-137685349,137685349,
MarcoFalke,2015-09-04T09:20:47Z,"@jonasschnelli To answer your two questions: No, I don't see a benefit. My wording was confusing, so to be clear: I am _supporting_ this PR/commit. (Just as @sipa said, throttling won't help as it results in disconnect anyway)\n",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-137686528,137686528,
luke-jr,2015-09-04T12:30:02Z,"Having an ""instant"" bandwidth limit to work with can enable Core to make intelligent-ish decisions, like not inv'ing/uploading new blocks to more than one peer at a time unless the current-upload peer is downloading at a slow rate.\n",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-137723150,137723150,
ghost,2015-09-05T14:27:35Z,"Surely we need some sort of scaling to our bandwidth limitations/throttling here - serving historic blocks to unsynced peers could 'trickle-feed' in the background at a few 10s of kB/sec, and anything within the last 60 blocks or so could then be served with greater priority. \n\nThis would need the unsynced peer to know with certainty the true current block height so that it didn't drop slow inbo",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-137960225,137960225,
gmaxwell,2015-09-06T07:25:01Z,"@casey  of course, any longer window cap can be divided down.   Breaking it up into smaller groups has a side effect of allowing us more freedom to ignore the resource scheduling issue.\n\nImagine that a low monthly cap were widely deployed on the network.  Then the whole network might blow through its cap in a few days at the start of the month, and be unwilling to serve blocks for the rest of th",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-138049630,138049630,
gmaxwell,2015-09-07T08:10:54Z,"With the above mentioned comparison bug fixed, I can confirm that the basic functionality works once the limit is crossed: new blocks are relayed without issue, old blocks result in disconnect.\n",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-138227127,138227127,
jonasschnelli,2015-09-07T15:47:45Z,@gmaxwell: Thanks for the review!\nUpdated the time check (block older than a week) and did some testing. Seems to work like this.\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-138328237,138328237,
gmaxwell,2015-09-07T18:40:35Z,might want to add a test so that it won't drop the last connection? I'm not sure but if you imagine e.g. someone using -connect and having several peers down already? -- then again is the peer really useful if its fetching old blocks?\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-138354611,138354611,
jonasschnelli,2015-09-07T20:26:46Z,"Not sure how useful a peer with height < now-1week is. But it could catch up and then be helpful. Thought, I think we should respect the uploadtarget in the first place.\n\nExcluding -whitebind looks more important to me (could be implemented in a follow up PR).\n",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-138371110,138371110,
gmaxwell,2015-09-07T23:15:35Z,With respect to forcing a minimum on the argument. Perhaps it should just whine in the logs if you've asked for a value that is too small?    One consequence of the current setup is that every restart forces another 144MB of history transfer.   (I removed that code in my own copy because it makes the software much easier to test.)\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-138391943,138391943,
jonasschnelli,2015-09-08T12:42:46Z,"- Fixed @sipa nit (mention MiB as unit per 24h cycle).\n- Dropped forcing of a minimum target of 24 hours of blocks \* MAX_BLOCKSIZE, only warn in a such case.\n",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-138548472,138548472,
jgarzik,2015-09-15T23:21:34Z,concept and quick code review ACK\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-140579009,140579009,
dcousens,2015-09-16T08:28:19Z,utACK and ACK if tests are added\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-140668317,140668317,
jonasschnelli,2015-09-18T13:49:54Z,Rebased.\nI have tried (serval hours) to write a rpc test that could test this feature; but didn't succeed. A solution would be to make the time-frame (currently static 24h) and move the static timeframe that determines if a block is historical (static 1 week) to chainparams. But somehow this looks after a bad solution.\nPlaying around with `setmocktime` also didn't help (seems not to affect the g,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141456496,141456496,
sdaftuar,2015-09-18T14:01:52Z,"@jonasschnelli I haven't reviewed this code carefully but from a quick glance, I think I can write up a test in the python p2p framework -- it looks to me like we can use setmocktime to trigger clearing the 24 hour measurement windows and we can send getdata messages over and over to test what happens when the limit is hit (and we can construct blocks with varying timestamps to exercise the 1 week",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141459145,141459145,
jonasschnelli,2015-09-18T15:02:53Z,@sdaftuar: Great! Thanks for having a look at the tests.\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141477182,141477182,
sdaftuar,2015-09-18T20:14:03Z,@jonasschnelli: i think i've got a working test -- https://github.com/sdaftuar/bitcoin/commit/67ffe80e373368242e3975046078cb9e8ac7b453\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141555012,141555012,
jonasschnelli,2015-09-19T15:01:32Z,@sdaftuar Nice! Looks good. I did ran into some errors.\nWill extend the test and add some `getnettotals` calls (during the next week).\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141677904,141677904,
mikehearn,2015-09-19T20:24:49Z,"> If the target-in-bytes - (time-left-in-24-cycle) / 600 \* MAX_BLOCK_SIZE is reached, stop serve blocks older than one week, stop serve filtered blocks (SPV) immediately.\n\nWhat?\n\nYou start out by saying nearly all bandwidth usage is serving historical blocks to full nodes. You then write code that limits SPV clients, which don't request full blocks. In fact the whole point of this mode is to ",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141703121,141703121,
jonasschnelli,2015-09-20T08:01:16Z,"I agree that limiting filtered blocks has not much of a importance to the upload bandwidth limiting. My thought where, if one sets a `-maxuploadtarget`, what commands can be dropped without harming the p2p network? Uploading historical blocks and disconnecting SPV nodes.\nIt could make sense to remove the part where maxuploadtarget also affects filtered blocks limiting.\n\nI hope i can generate so",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141757005,141757005,
gmaxwell,2015-09-20T08:15:06Z,"When a node has exhausted its capacity it should stop doing anything to use more capacity beyond keeping itself minimally participating. I don't think there is anything unreasonable about that.\n\nI think a case could be made for _non-historic_ filtered results-- as at least no worse than serving to other peers, though really if a node is out of outbound capacity it probably shouldn't have any cli",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141757602,141757602,
jonasschnelli,2015-09-20T08:20:47Z,Agree with @gmaxwell. I think we should reconsider that people shutting down nodes because nodes do create uncontrollable heigh amount of outbound traffic. If we could keep nodes alive – even if they don't server historical and filtered blocks for a limited timeframe – it's much better than seeing nodes get shut down because of missing traffic limiting options.\n\nNot saying that this is the ultim,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141757973,141757973,
mikehearn,2015-09-20T09:40:30Z,"I'd think you want the opposite - if a node literally exhausted a transfer quota, it needs to stop serving any data at all, stop listening and start using SPV mode itself.\n\nAs is, you will continue to upload at least 288mb of data per day even if you stop serving historical blocks entirely.\n\nBut if quota caps are the issue (as opposed to steady state limiting) then you should just make the nod",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141765564,141765564,
mikehearn,2015-09-20T09:43:05Z,"Oh, and by the way, the idea that disconnecting SPV wallets doesn't harm the P2P network is a pretty dangerous one. Those clients make up the bulk of all connects and users. Protecting them is very important!\n",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141766424,141766424,
gmaxwell,2015-09-20T09:46:18Z,It goes into limp mode early enough that it shouldn't need to shut down completely but will still usually avoid going over; this is obviously a very early first step and isn't perfect yet. But it is already very useful and can be incrementally improved.\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141767443,141767443,
jonasschnelli,2015-09-20T15:44:06Z,"> [...] As is, you will continue to upload at least 288mb of data per day even if you stop serving historical blocks entirely.\n\nNot exactly. After each cycle of 24h your counter will be reset. The minimum buffer for serving blocks is 144 blocks \* MAX_BLOCKSIZE. But if a node starts requesting blocks after 12h in you 24h cycle, only a min of 72MB are left. Also: not all blocks are full.\n\nAs sa",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141797439,141797439,
mikehearn,2015-09-21T10:35:41Z,"OK, so firstly, do we agree on this statement\n\n_This patch solves the problem of users with capped transfer quotas, probably measured in gigabytes per month. The other patch we're discussing on the XT repository solves the problem of inference with consumer services at home due to saturating the limited uplink bandwidth._\n\nBecause it seems to me that these are two independent problems that are",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141936613,141936613,
jonasschnelli,2015-09-21T11:34:48Z,"Real ""throttling"" (reducing the bandwidth to a static value) regardless of which node and which command/service being called, is bad and ineffective IMO.\nIf you are connected to a throttled tor node or a throttled node in a bittorent net, it will just result in a bad overall user experience.\n\nBitcoin p2p is different to tor and bittorrent. It does not serve or consume uncontrollable and ungroup",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141947660,141947660,
mikehearn,2015-09-21T11:44:08Z,"Hm, so we don't agree on that statement then?\n\nWhen a peer is uploading the block chain to freshly installed nodes/nodes that were offline for a long time, it does look quite a bit like BitTorrent ..... heavy upload traffic that goes as fast as possible for a long period of time. \n\nThe goal of the bandwidth throttler is _not_ to have huge swings in available serving bandwidth, but rather to av",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141949588,141949588,
jonasschnelli,2015-09-21T11:53:56Z,"> When a peer is uploading the block chain to freshly installed nodes/nodes that were offline for a long time, it does look quite a bit like BitTorrent ..... heavy upload traffic that goes as fast as possible for a long period of time.\n\nAgreed. That IBD serving is similar to torrent. This is the reason why this PR addresses that part if the upload target has been reached.\n\nThe rest of your poi",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141950865,141950865,
mikehearn,2015-09-21T13:12:58Z,"Well, the issue is people want to configure it at the app level as many consumer wifi routers don't offer the right features, or people don't know how to use them.\n",https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-141969777,141969777,
btcdrak,2015-10-21T13:38:49Z,Looks good to me. The OP said there is some documentation + tests to complete.\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-149898332,149898332,
laanwj,2015-10-21T14:48:57Z,utACK\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-149919862,149919862,
gmaxwell,2015-10-26T03:10:10Z,@jonasschnelli  Interest in performing a squash+rebase+message nits?  I'd like to move to merge this.\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-151009508,151009508,
laanwj,2015-10-26T12:13:24Z,Agree @gmaxwell \n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-151114936,151114936,
jonasschnelli,2015-10-26T12:17:19Z,I'm currently rebasing and fixing @sdaftuars rpc test. Have plans to fix everything until tmr.\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-151115588,151115588,
jonasschnelli,2015-10-26T16:01:29Z,Rebased. Added @sdaftuar rpc test. Addressed nits. Passes travis. Ready for merge.\n,https://github.com/bitcoin/bitcoin/pull/6622#issuecomment-151184904,151184904,
sipa,2015-09-07T17:36:04Z,"Specify units (bytes? megabytes?) and window size (seconds, days?)\n",https://github.com/bitcoin/bitcoin/pull/6622#discussion_r38875088,38875088,src/init.cpp
jgarzik,2015-09-15T23:21:10Z,"Univalue nit:  I wonder if we should add new code with Pair()   Ideal is to eliminate Pair() usage, and simply use object.pushKV()\n\nMaybe yes (don't use an obsolete interface), maybe no (stay consistent with surrounding code).\n",https://github.com/bitcoin/bitcoin/pull/6622#discussion_r39578205,39578205,src/rpcnet.cpp
jonasschnelli,2015-09-17T12:22:16Z,Agreed. A KV push method for `UniValue` would be nice. Out of scope for this PR and probably a relatively big changeset if all current `push_back(Pair())` will be converted.\n,https://github.com/bitcoin/bitcoin/pull/6622#discussion_r39738710,39738710,src/rpcnet.cpp
jgarzik,2015-09-17T12:44:42Z,"pushKV method already exists.\n\nAgreed it is out of scope for this PR, and a huge cleanup in terms of LOC to remove Pair() usage tree-wide.\n",https://github.com/bitcoin/bitcoin/pull/6622#discussion_r39740313,39740313,src/rpcnet.cpp
btcdrak,2015-10-21T10:19:34Z,Braces not required.\n,https://github.com/bitcoin/bitcoin/pull/6622#discussion_r42606302,42606302,src/net.cpp
laanwj,2015-10-22T09:20:30Z,"I don't understand this message. The target is too small, thus unlikely to be reached? Isn't it the other way around?\n",https://github.com/bitcoin/bitcoin/pull/6622#discussion_r42726950,42726950,src/net.cpp
jonasschnelli,2015-10-22T09:25:07Z,"What about just using `""Warning: max outbound target is very small, recommended minimum is %s""`?\n",https://github.com/bitcoin/bitcoin/pull/6622#discussion_r42727299,42727299,src/net.cpp
MarcoFalke,2015-10-22T11:54:44Z,"@jonasschnelli I think you can still print  `nMaxOutboundLimit`, just remove or clarify the `unlikely to be reached` as no one will understand this as ""`likely to overshoot`"".\n",https://github.com/bitcoin/bitcoin/pull/6622#discussion_r42738921,42738921,src/net.cpp
gmaxwell,2015-10-26T03:09:18Z,"Unlike to be reached sounds very much like it will use _less_ bandwidth than specified; so I think this should be changed to ""will be overshot"" or ""very likely to be exceeded."" or similar.\n",https://github.com/bitcoin/bitcoin/pull/6622#discussion_r42957092,42957092,src/net.cpp
MarcoFalke,2015-11-06T08:11:01Z,You'd need to update `help getnettotals` as well.\n,https://github.com/bitcoin/bitcoin/pull/6622#discussion_r44112801,44112801,src/rpcnet.cpp
