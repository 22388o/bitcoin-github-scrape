[
  {
    "sha": "5b95a190e8d7059039ce61e808d494dcf89ebb3b",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1Yjk1YTE5MGU4ZDcwNTkwMzljZTYxZTgwOGQ0OTRkY2Y4OWViYjNi",
    "commit": {
      "author": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2017-03-31T14:17:13Z"
      },
      "committer": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2017-03-31T17:15:39Z"
      },
      "message": "Make pcoinsTip memory calculations consistent\n\nSince we are more accurately measuring pcoinsTip peak usage at twice the current in dynamic usage, it makes sense to double the default (this will lead to the same effective usage and peak usage as previously).\nWe should also double the buffer used to avoid flushing if above 90% but still sufficient space remaining.",
      "tree": {
        "sha": "3d997219f851eb8f3992c877f21e613640bbadd1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3d997219f851eb8f3992c877f21e613640bbadd1"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5b95a190e8d7059039ce61e808d494dcf89ebb3b",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5b95a190e8d7059039ce61e808d494dcf89ebb3b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/5b95a190e8d7059039ce61e808d494dcf89ebb3b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5b95a190e8d7059039ce61e808d494dcf89ebb3b/comments",
    "author": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "4aa07fa735696eef828b7a82daedc654d626deac",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4aa07fa735696eef828b7a82daedc654d626deac",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/4aa07fa735696eef828b7a82daedc654d626deac"
      }
    ],
    "stats": {
      "total": 10,
      "additions": 7,
      "deletions": 3
    },
    "files": [
      {
        "sha": "963f1006eaab3d81ee690a43b2a89998e7fefc2e",
        "filename": "src/txdb.h",
        "status": "modified",
        "additions": 5,
        "deletions": 1,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5b95a190e8d7059039ce61e808d494dcf89ebb3b/src/txdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5b95a190e8d7059039ce61e808d494dcf89ebb3b/src/txdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txdb.h?ref=5b95a190e8d7059039ce61e808d494dcf89ebb3b",
        "patch": "@@ -21,8 +21,12 @@ class CBlockIndex;\n class CCoinsViewDBCursor;\n class uint256;\n \n+//! Compensate for extra memory peak (x1.5-x1.9) at flush time.\n+static constexpr int DB_PEAK_USAGE_FACTOR = 2;\n+//! No need to flush if at least this much space still available.\n+static constexpr int MAX_BLOCK_COINSDB_USAGE = 100 * DB_PEAK_USAGE_FACTOR;\n //! -dbcache default (MiB)\n-static const int64_t nDefaultDbCache = 300;\n+static const int64_t nDefaultDbCache = 600;\n //! max. -dbcache (MiB)\n static const int64_t nMaxDbCache = sizeof(void*) > 4 ? 16384 : 1024;\n //! min. -dbcache (MiB)"
      },
      {
        "sha": "390801d34f453dab8bbc6b76466821e3d49ad744",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5b95a190e8d7059039ce61e808d494dcf89ebb3b/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5b95a190e8d7059039ce61e808d494dcf89ebb3b/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=5b95a190e8d7059039ce61e808d494dcf89ebb3b",
        "patch": "@@ -2005,10 +2005,10 @@ bool static FlushStateToDisk(CValidationState &state, FlushStateMode mode, int n\n         nLastSetChain = nNow;\n     }\n     int64_t nMempoolSizeMax = GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n-    int64_t cacheSize = pcoinsTip->DynamicMemoryUsage() * 2; // Compensate for extra memory peak (x1.5-x1.9) at flush time.\n+    int64_t cacheSize = pcoinsTip->DynamicMemoryUsage() * DB_PEAK_USAGE_FACTOR;\n     int64_t nTotalSpace = nCoinCacheUsage + std::max<int64_t>(nMempoolSizeMax - nMempoolUsage, 0);\n     // The cache is large and we're within 10% and 100 MiB of the limit, but we have time now (not in the middle of a block processing).\n-    bool fCacheLarge = mode == FLUSH_STATE_PERIODIC && cacheSize > std::max((9 * nTotalSpace) / 10, nTotalSpace - 100 * 1024 * 1024);\n+    bool fCacheLarge = mode == FLUSH_STATE_PERIODIC && cacheSize > std::max((9 * nTotalSpace) / 10, nTotalSpace - MAX_BLOCK_COINSDB_USAGE * 1024 * 1024);\n     // The cache is over the limit, we have to write now.\n     bool fCacheCritical = mode == FLUSH_STATE_IF_NEEDED && cacheSize > nTotalSpace;\n     // It's been a while since we wrote the block index to disk. Do this frequently, so we don't need to redownload after a crash."
      }
    ]
  },
  {
    "sha": "f33afd3b2be1bcabeb10168a53835359c9ff4a3e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmMzNhZmQzYjJiZTFiY2FiZWIxMDE2OGE1MzgzNTM1OWM5ZmY0YTNl",
    "commit": {
      "author": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2017-03-31T14:25:39Z"
      },
      "committer": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2017-03-31T18:07:56Z"
      },
      "message": "Lower default memory footprint slightly",
      "tree": {
        "sha": "35eb0463837c9c496db06973ef4215f64ffa54b3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/35eb0463837c9c496db06973ef4215f64ffa54b3"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f33afd3b2be1bcabeb10168a53835359c9ff4a3e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f33afd3b2be1bcabeb10168a53835359c9ff4a3e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/f33afd3b2be1bcabeb10168a53835359c9ff4a3e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f33afd3b2be1bcabeb10168a53835359c9ff4a3e/comments",
    "author": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "5b95a190e8d7059039ce61e808d494dcf89ebb3b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5b95a190e8d7059039ce61e808d494dcf89ebb3b",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/5b95a190e8d7059039ce61e808d494dcf89ebb3b"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 1,
      "deletions": 1
    },
    "files": [
      {
        "sha": "337942ffaf37258ea8b56ad9d90be2a0fa0e5908",
        "filename": "src/txdb.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f33afd3b2be1bcabeb10168a53835359c9ff4a3e/src/txdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f33afd3b2be1bcabeb10168a53835359c9ff4a3e/src/txdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txdb.h?ref=f33afd3b2be1bcabeb10168a53835359c9ff4a3e",
        "patch": "@@ -26,7 +26,7 @@ static constexpr int DB_PEAK_USAGE_FACTOR = 2;\n //! No need to flush if at least this much space still available.\n static constexpr int MAX_BLOCK_COINSDB_USAGE = 100 * DB_PEAK_USAGE_FACTOR;\n //! -dbcache default (MiB)\n-static const int64_t nDefaultDbCache = 600;\n+static const int64_t nDefaultDbCache = 450;\n //! max. -dbcache (MiB)\n static const int64_t nMaxDbCache = sizeof(void*) > 4 ? 16384 : 1024;\n //! min. -dbcache (MiB)"
      }
    ]
  },
  {
    "sha": "1b55e07b7a61a9e6c299cf4c40fde80fa715d440",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxYjU1ZTA3YjdhNjFhOWU2YzI5OWNmNGM0MGZkZTgwZmE3MTVkNDQw",
    "commit": {
      "author": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2017-03-31T14:26:25Z"
      },
      "committer": {
        "name": "Alex Morcos",
        "email": "morcos@chaincode.com",
        "date": "2017-03-31T18:30:31Z"
      },
      "message": "Make threshold for flushing more conservative.\n\nAlways leave a reasonable buffer of 50MB for usage from newly connected block (once over 50%) and increase the high water mark buffer to 200MB.",
      "tree": {
        "sha": "4d5ee99dbcd42cdbb134a1f3426e6be2b5a85502",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4d5ee99dbcd42cdbb134a1f3426e6be2b5a85502"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1b55e07b7a61a9e6c299cf4c40fde80fa715d440",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1b55e07b7a61a9e6c299cf4c40fde80fa715d440",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1b55e07b7a61a9e6c299cf4c40fde80fa715d440",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1b55e07b7a61a9e6c299cf4c40fde80fa715d440/comments",
    "author": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "morcos",
      "id": 4360349,
      "node_id": "MDQ6VXNlcjQzNjAzNDk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4360349?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/morcos",
      "html_url": "https://github.com/morcos",
      "followers_url": "https://api.github.com/users/morcos/followers",
      "following_url": "https://api.github.com/users/morcos/following{/other_user}",
      "gists_url": "https://api.github.com/users/morcos/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/morcos/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/morcos/subscriptions",
      "organizations_url": "https://api.github.com/users/morcos/orgs",
      "repos_url": "https://api.github.com/users/morcos/repos",
      "events_url": "https://api.github.com/users/morcos/events{/privacy}",
      "received_events_url": "https://api.github.com/users/morcos/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f33afd3b2be1bcabeb10168a53835359c9ff4a3e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f33afd3b2be1bcabeb10168a53835359c9ff4a3e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f33afd3b2be1bcabeb10168a53835359c9ff4a3e"
      }
    ],
    "stats": {
      "total": 11,
      "additions": 7,
      "deletions": 4
    },
    "files": [
      {
        "sha": "d9214ba618546c100ed767b1d7e4ee6211f07045",
        "filename": "src/txdb.h",
        "status": "modified",
        "additions": 4,
        "deletions": 2,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1b55e07b7a61a9e6c299cf4c40fde80fa715d440/src/txdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1b55e07b7a61a9e6c299cf4c40fde80fa715d440/src/txdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txdb.h?ref=1b55e07b7a61a9e6c299cf4c40fde80fa715d440",
        "patch": "@@ -23,8 +23,10 @@ class uint256;\n \n //! Compensate for extra memory peak (x1.5-x1.9) at flush time.\n static constexpr int DB_PEAK_USAGE_FACTOR = 2;\n-//! No need to flush if at least this much space still available.\n-static constexpr int MAX_BLOCK_COINSDB_USAGE = 100 * DB_PEAK_USAGE_FACTOR;\n+//! No need to periodic flush if at least this much space still available.\n+static constexpr int MAX_BLOCK_COINSDB_USAGE = 200 * DB_PEAK_USAGE_FACTOR;\n+//! Always periodic flush if less than this much space still available.\n+static constexpr int MIN_BLOCK_COINSDB_USAGE = 50 * DB_PEAK_USAGE_FACTOR;\n //! -dbcache default (MiB)\n static const int64_t nDefaultDbCache = 450;\n //! max. -dbcache (MiB)"
      },
      {
        "sha": "fbfeffbaab89f980496975d18894ddefc9926041",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 2,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1b55e07b7a61a9e6c299cf4c40fde80fa715d440/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1b55e07b7a61a9e6c299cf4c40fde80fa715d440/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=1b55e07b7a61a9e6c299cf4c40fde80fa715d440",
        "patch": "@@ -2007,8 +2007,9 @@ bool static FlushStateToDisk(CValidationState &state, FlushStateMode mode, int n\n     int64_t nMempoolSizeMax = GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000;\n     int64_t cacheSize = pcoinsTip->DynamicMemoryUsage() * DB_PEAK_USAGE_FACTOR;\n     int64_t nTotalSpace = nCoinCacheUsage + std::max<int64_t>(nMempoolSizeMax - nMempoolUsage, 0);\n-    // The cache is large and we're within 10% and 100 MiB of the limit, but we have time now (not in the middle of a block processing).\n-    bool fCacheLarge = mode == FLUSH_STATE_PERIODIC && cacheSize > std::max((9 * nTotalSpace) / 10, nTotalSpace - MAX_BLOCK_COINSDB_USAGE * 1024 * 1024);\n+    // The cache is large and we're within 10% and 200 MiB or 50% and 50MiB of the limit, but we have time now (not in the middle of a block processing).\n+    bool fCacheLarge = mode == FLUSH_STATE_PERIODIC && cacheSize > std::min(std::max(nTotalSpace / 2, nTotalSpace - MIN_BLOCK_COINSDB_USAGE * 1024 * 1024),\n+                                                                            std::max((9 * nTotalSpace) / 10, nTotalSpace - MAX_BLOCK_COINSDB_USAGE * 1024 * 1024));\n     // The cache is over the limit, we have to write now.\n     bool fCacheCritical = mode == FLUSH_STATE_IF_NEEDED && cacheSize > nTotalSpace;\n     // It's been a while since we wrote the block index to disk. Do this frequently, so we don't need to redownload after a crash."
      }
    ]
  }
]