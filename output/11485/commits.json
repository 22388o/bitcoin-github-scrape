[
  {
    "sha": "87e39239070ab9a4ce4bf61773a44f673859937d",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4N2UzOTIzOTA3MGFiOWE0Y2U0YmY2MTc3M2E0NGY2NzM4NTk5Mzdk",
    "commit": {
      "author": {
        "name": "MeshCollider",
        "email": "dobsonsa68@gmail.com",
        "date": "2017-10-11T10:55:29Z"
      },
      "committer": {
        "name": "MeshCollider",
        "email": "dobsonsa68@gmail.com",
        "date": "2017-11-29T00:16:14Z"
      },
      "message": "Add release notes for listwallets RPC change",
      "tree": {
        "sha": "3c7086b3564fab53a0edffbc1e7d7c42155fb3d2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3c7086b3564fab53a0edffbc1e7d7c42155fb3d2"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/87e39239070ab9a4ce4bf61773a44f673859937d",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/87e39239070ab9a4ce4bf61773a44f673859937d",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/87e39239070ab9a4ce4bf61773a44f673859937d",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/87e39239070ab9a4ce4bf61773a44f673859937d/comments",
    "author": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "26efc220a13aa3413f6e55e311e8991445104f82",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/26efc220a13aa3413f6e55e311e8991445104f82",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/26efc220a13aa3413f6e55e311e8991445104f82"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 4,
      "deletions": 0
    },
    "files": [
      {
        "sha": "7e227774b749f9656b38ad4ddc2557b2e32a8f35",
        "filename": "doc/release-notes.md",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/87e39239070ab9a4ce4bf61773a44f673859937d/doc/release-notes.md",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/87e39239070ab9a4ce4bf61773a44f673859937d/doc/release-notes.md",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/doc/release-notes.md?ref=87e39239070ab9a4ce4bf61773a44f673859937d",
        "patch": "@@ -91,6 +91,10 @@ Low-level RPC changes\n - The wallet RPC `getreceivedbyaddress` will return an error if called with an address not in the wallet.\n \n \n+- `listwallets` now returns two arrays of wallet names, one listing the `loaded` wallets\n+  and one listing the `available` BDB database files in the wallet directory (generally these\n+  will be wallets but may return false positives if there are other BDB files present).\n+\n Credits\n =======\n "
      }
    ]
  },
  {
    "sha": "946b2ceb1a8c6702fc3412b63f42439bedbafe0c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5NDZiMmNlYjFhOGM2NzAyZmMzNDEyYjYzZjQyNDM5YmVkYmFmZTBj",
    "commit": {
      "author": {
        "name": "MeshCollider",
        "email": "dobsonsa68@gmail.com",
        "date": "2017-10-11T10:52:42Z"
      },
      "committer": {
        "name": "MeshCollider",
        "email": "dobsonsa68@gmail.com",
        "date": "2017-11-29T00:17:05Z"
      },
      "message": "Add available BDB list to listwallets RPC",
      "tree": {
        "sha": "144f0c035480d5278edfd87bfbfb45186cc53409",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/144f0c035480d5278edfd87bfbfb45186cc53409"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/946b2ceb1a8c6702fc3412b63f42439bedbafe0c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/946b2ceb1a8c6702fc3412b63f42439bedbafe0c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/946b2ceb1a8c6702fc3412b63f42439bedbafe0c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/946b2ceb1a8c6702fc3412b63f42439bedbafe0c/comments",
    "author": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "87e39239070ab9a4ce4bf61773a44f673859937d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/87e39239070ab9a4ce4bf61773a44f673859937d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/87e39239070ab9a4ce4bf61773a44f673859937d"
      }
    ],
    "stats": {
      "total": 53,
      "additions": 43,
      "deletions": 10
    },
    "files": [
      {
        "sha": "155cfb39983af86c87a0e362f13005a03e1a597d",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 35,
        "deletions": 7,
        "changes": 42,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/946b2ceb1a8c6702fc3412b63f42439bedbafe0c/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/946b2ceb1a8c6702fc3412b63f42439bedbafe0c/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=946b2ceb1a8c6702fc3412b63f42439bedbafe0c",
        "patch": "@@ -2749,16 +2749,17 @@ UniValue listwallets(const JSONRPCRequest& request)\n             \"Returns a list of currently loaded wallets.\\n\"\n             \"For full information on the wallet, use \\\"getwalletinfo\\\"\\n\"\n             \"\\nResult:\\n\"\n-            \"[                         (json array of strings)\\n\"\n-            \"  \\\"walletname\\\"            (string) the wallet name\\n\"\n-            \"   ...\\n\"\n-            \"]\\n\"\n+            \"{\\n\"\n+            \"  \\\"loaded\\\":     [ \\\"walletname\\\" ... ] (json array of strings) Names of loaded wallets\\n\"\n+            \"  \\\"available\\\":  [ \\\"walletname\\\" ... ] (json array of strings) Names of BDB files in wallet directory (may not always actually be wallets)\\n\"\n+            \"}\\n\"\n             \"\\nExamples:\\n\"\n             + HelpExampleCli(\"listwallets\", \"\")\n             + HelpExampleRpc(\"listwallets\", \"\")\n         );\n \n-    UniValue obj(UniValue::VARR);\n+    std::set<std::string> loaded_set;\n+    UniValue loaded(UniValue::VARR);\n \n     for (CWalletRef pwallet : vpwallets) {\n \n@@ -2768,10 +2769,37 @@ UniValue listwallets(const JSONRPCRequest& request)\n \n         LOCK(pwallet->cs_wallet);\n \n-        obj.push_back(pwallet->GetName());\n+        loaded.push_back(pwallet->GetName());\n+        loaded_set.insert(pwallet->GetName());\n     }\n \n-    return obj;\n+    UniValue available(UniValue::VARR);\n+    fs::path walletdir = GetWalletDir();\n+    const unsigned char bdb_magic[4] = {0x62, 0x31, 0x05, 0x00}; // Berkeley DB Btree magic bytes\n+\n+    for (fs::directory_iterator it(walletdir); it != fs::directory_iterator(); ++it) {\n+        if (!fs::is_regular_file(*it) || fs::is_symlink(*it)) continue;\n+\n+        std::ifstream file(it->path().string(), std::ios::binary);\n+        if (!file.is_open()) continue;\n+\n+        file.seekg(12, std::ios::beg); // Magic bytes start at offset 12\n+        unsigned char file_bytes[4] = {0};\n+        file.read((char*)file_bytes, sizeof(file_bytes)); // Read 4 bytes of file to compare against magic\n+\n+        if (memcmp(file_bytes, bdb_magic, sizeof(bdb_magic)) == 0) {\n+            // check if this wallet is already loaded\n+            const std::string filename = it->path().filename().string();\n+            if (loaded_set.count(filename) == 0) {\n+                available.push_back(filename);\n+            }\n+        }\n+    }\n+\n+    UniValue result(UniValue::VOBJ);\n+    result.push_back(Pair(\"loaded\", loaded));\n+    result.push_back(Pair(\"available\", available));\n+    return result;\n }\n \n UniValue resendwallettransactions(const JSONRPCRequest& request)"
      },
      {
        "sha": "268b02c124401cdac517d8a57b7359da1bfbf9e9",
        "filename": "test/functional/multiwallet.py",
        "status": "modified",
        "additions": 8,
        "deletions": 3,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/946b2ceb1a8c6702fc3412b63f42439bedbafe0c/test/functional/multiwallet.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/946b2ceb1a8c6702fc3412b63f42439bedbafe0c/test/functional/multiwallet.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/multiwallet.py?ref=946b2ceb1a8c6702fc3412b63f42439bedbafe0c",
        "patch": "@@ -19,7 +19,8 @@ def set_test_params(self):\n         self.extra_args = [['-wallet=w1', '-wallet=w2', '-wallet=w3', '-wallet=w']]\n \n     def run_test(self):\n-        assert_equal(set(self.nodes[0].listwallets()), {\"w1\", \"w2\", \"w3\", \"w\"})\n+        assert_equal(set(self.nodes[0].listwallets()['loaded']), {\"w1\", \"w2\", \"w3\", \"w\"})\n+        assert_equal(set(self.nodes[0].listwallets()['available']), set())\n \n         self.stop_node(0)\n \n@@ -46,15 +47,15 @@ def run_test(self):\n         wallet_dir2 = os.path.join(self.options.tmpdir, 'node0', 'regtest', 'walletdir')\n         os.rename(wallet_dir, wallet_dir2)\n         self.start_node(0, ['-wallet=w4', '-wallet=w5'])\n-        assert_equal(set(self.nodes[0].listwallets()), {\"w4\", \"w5\"})\n+        assert_equal(set(self.nodes[0].listwallets()['loaded']), {\"w4\", \"w5\"})\n         w5 = self.nodes[0].get_wallet_rpc(\"w5\")\n         w5.generate(1)\n         self.stop_node(0)\n \n         # now if wallets/ exists again, but the rootdir is specified as the walletdir, w4 and w5 should still be loaded\n         os.rename(wallet_dir2, wallet_dir)\n         self.start_node(0, ['-wallet=w4', '-wallet=w5', '-walletdir=' + os.path.join(self.options.tmpdir, 'node0', 'regtest')])\n-        assert_equal(set(self.nodes[0].listwallets()), {\"w4\", \"w5\"})\n+        assert_equal(set(self.nodes[0].listwallets()['loaded']), {\"w4\", \"w5\"})\n         w5 = self.nodes[0].get_wallet_rpc(\"w5\")\n         w5_info = w5.getwalletinfo()\n         assert_equal(w5_info['immature_balance'], 50)\n@@ -63,6 +64,10 @@ def run_test(self):\n \n         self.start_node(0, self.extra_args[0])\n \n+        # ensure listwallets only names BDB files, not symlinks, other files or directories\n+        open(os.path.join(wallet_dir, 'w01.dat'), 'a').close()\n+        assert_equal(set(self.nodes[0].listwallets()['available']), {\"w22\"})\n+\n         w1 = self.nodes[0].get_wallet_rpc(\"w1\")\n         w2 = self.nodes[0].get_wallet_rpc(\"w2\")\n         w3 = self.nodes[0].get_wallet_rpc(\"w3\")"
      }
    ]
  },
  {
    "sha": "3dac78f6f012196e3a4351f9a60df2fd03596f7d",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzozZGFjNzhmNmYwMTIxOTZlM2E0MzUxZjlhNjBkZjJmZDAzNTk2Zjdk",
    "commit": {
      "author": {
        "name": "MeshCollider",
        "email": "dobsonsa68@gmail.com",
        "date": "2017-12-12T22:57:15Z"
      },
      "committer": {
        "name": "MeshCollider",
        "email": "dobsonsa68@gmail.com",
        "date": "2017-12-12T22:57:15Z"
      },
      "message": "Fix listwallets documentation",
      "tree": {
        "sha": "81147e4df38c00a06b044fa4b7475f4b8dc40964",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/81147e4df38c00a06b044fa4b7475f4b8dc40964"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/3dac78f6f012196e3a4351f9a60df2fd03596f7d",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3dac78f6f012196e3a4351f9a60df2fd03596f7d",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/3dac78f6f012196e3a4351f9a60df2fd03596f7d",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3dac78f6f012196e3a4351f9a60df2fd03596f7d/comments",
    "author": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "meshcollider",
      "id": 3211283,
      "node_id": "MDQ6VXNlcjMyMTEyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3211283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/meshcollider",
      "html_url": "https://github.com/meshcollider",
      "followers_url": "https://api.github.com/users/meshcollider/followers",
      "following_url": "https://api.github.com/users/meshcollider/following{/other_user}",
      "gists_url": "https://api.github.com/users/meshcollider/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/meshcollider/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/meshcollider/subscriptions",
      "organizations_url": "https://api.github.com/users/meshcollider/orgs",
      "repos_url": "https://api.github.com/users/meshcollider/repos",
      "events_url": "https://api.github.com/users/meshcollider/events{/privacy}",
      "received_events_url": "https://api.github.com/users/meshcollider/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "946b2ceb1a8c6702fc3412b63f42439bedbafe0c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/946b2ceb1a8c6702fc3412b63f42439bedbafe0c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/946b2ceb1a8c6702fc3412b63f42439bedbafe0c"
      }
    ],
    "stats": {
      "total": 7,
      "additions": 4,
      "deletions": 3
    },
    "files": [
      {
        "sha": "d3fc07ab3dcc4e7b9df647efe427b3a6844556c3",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 3,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/3dac78f6f012196e3a4351f9a60df2fd03596f7d/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/3dac78f6f012196e3a4351f9a60df2fd03596f7d/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=3dac78f6f012196e3a4351f9a60df2fd03596f7d",
        "patch": "@@ -2746,12 +2746,13 @@ UniValue listwallets(const JSONRPCRequest& request)\n     if (request.fHelp || request.params.size() != 0)\n         throw std::runtime_error(\n             \"listwallets\\n\"\n-            \"Returns a list of currently loaded wallets.\\n\"\n-            \"For full information on the wallet, use \\\"getwalletinfo\\\"\\n\"\n+            \"Returns a list of currently loaded wallets, and a list of potential wallet files in the wallet directory.\\n\"\n+            \"For full information about a loaded wallet, use \\\"getwalletinfo\\\"\\n\"\n             \"\\nResult:\\n\"\n             \"{\\n\"\n             \"  \\\"loaded\\\":     [ \\\"walletname\\\" ... ] (json array of strings) Names of loaded wallets\\n\"\n-            \"  \\\"available\\\":  [ \\\"walletname\\\" ... ] (json array of strings) Names of BDB files in wallet directory (may not always actually be wallets)\\n\"\n+            \"  \\\"available\\\":  [ \\\"walletname\\\" ... ] (json array of strings) Names of BDB files in wallet directory\"\n+            \"           (may not always actually be wallets, e.g. other files from pre-0.8, or may include duplicate wallets which cannot be opened simultaneously)\\n\"\n             \"}\\n\"\n             \"\\nExamples:\\n\"\n             + HelpExampleCli(\"listwallets\", \"\")"
      }
    ]
  }
]