[
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/934329907",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#issuecomment-934329907",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23174",
    "id": 934329907,
    "node_id": "IC_kwDOABII5843sL4z",
    "user": {
      "login": "DrahtBot",
      "id": 39886733,
      "node_id": "MDQ6VXNlcjM5ODg2NzMz",
      "avatar_url": "https://avatars.githubusercontent.com/u/39886733?u=3c1e73d828cf5a5850dfc25c8397c1cf751db5ac&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/DrahtBot",
      "html_url": "https://github.com/DrahtBot",
      "followers_url": "https://api.github.com/users/DrahtBot/followers",
      "following_url": "https://api.github.com/users/DrahtBot/following{/other_user}",
      "gists_url": "https://api.github.com/users/DrahtBot/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/DrahtBot/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/DrahtBot/subscriptions",
      "organizations_url": "https://api.github.com/users/DrahtBot/orgs",
      "repos_url": "https://api.github.com/users/DrahtBot/repos",
      "events_url": "https://api.github.com/users/DrahtBot/events{/privacy}",
      "received_events_url": "https://api.github.com/users/DrahtBot/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-05T11:40:15Z",
    "updated_at": "2021-11-24T19:52:34Z",
    "author_association": "CONTRIBUTOR",
    "body": "<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#23581](https://github.com/bitcoin/bitcoin/pull/23581) (Move BlockManager to node/blockstorage by MarcoFalke)\n\nIf you consider this pull request important, please also help to review the conflicting pull requests. Ideally, start with the one that should be merged first.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/934329907/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937580719",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#issuecomment-937580719",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23174",
    "id": 937580719,
    "node_id": "IC_kwDOABII58434liv",
    "user": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url": "https://api.github.com/users/Sjors/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-07T08:42:00Z",
    "updated_at": "2021-10-07T08:42:00Z",
    "author_association": "MEMBER",
    "body": "(this PR is missing in the Assume UTXO project)",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/937580719/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/938101140",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#issuecomment-938101140",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23174",
    "id": 938101140,
    "node_id": "IC_kwDOABII58436kmU",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?u=3f68150a5f30acd541d1ed279376cd20b78046b1&v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-07T19:43:24Z",
    "updated_at": "2021-10-07T19:43:24Z",
    "author_association": "MEMBER",
    "body": "Concept ACK",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/938101140/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/947075033",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#issuecomment-947075033",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23174",
    "id": 947075033,
    "node_id": "IC_kwDOABII5844czfZ",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-19T20:20:54Z",
    "updated_at": "2021-10-19T20:20:54Z",
    "author_association": "CONTRIBUTOR",
    "body": "Forgot to post this earlier. I wrote up a description of this PR when I started reviewing it that may be useful to others (or helpful to me if I got something wrong):\r\n\r\nCurrently, `BlockManager::LoadBlockIndex` adds all blocks that have downloaded transactions to the _active_ chain state's `setBlockIndexCandidates` set, ignoring the _background_ chain state.\r\n\r\nThis PR changes `ChainstateManager::LoadBlockIndex` to:\r\n\r\n- Update `setBlockIndexCandidates` in the background chain, not just the active chain. In the active chain, all blocks are added as before. In the background chain, only blocks below the snapshot height are added so the background chain will continue to download and validate them.\r\n- Sets `pindex->nChainTx` of the snapshot block to the value from snapshot metadata instead of leaving it 0.\r\n",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/947075033/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/954242458",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#issuecomment-954242458",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23174",
    "id": 954242458,
    "node_id": "IC_kwDOABII58444JWa",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-10-28T21:37:44Z",
    "updated_at": "2021-10-28T22:06:05Z",
    "author_association": "MEMBER",
    "body": "Hey, review works! Thanks to commentary from @ryanofsky @ariard, I've found that a lot of the original patch was unnecessary .I've pushed a much-simplified changeset that addresses the quandary I posted yesterday (https://github.com/bitcoin/bitcoin/pull/23174#discussion_r737666011). \r\n\r\nIt turns out that the earlier version of this patch contained some unnecessary code that was a vestige from before I was persisting changes to the block index during snapshot activation (added in #21526).  The new changeset just ensures that we don't add tip candidates which rely on assumed-valid blocks to the IBD chainstate. I think the changes are much more intuitive to follow, and a decent amount of code was dropped.\r\n\r\nFor anyone who was in doubt: reviewing code pays off!",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/954242458/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/964561176",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#issuecomment-964561176",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23174",
    "id": 964561176,
    "node_id": "IC_kwDOABII5845fgkY",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-09T21:24:41Z",
    "updated_at": "2021-11-09T21:24:41Z",
    "author_association": "MEMBER",
    "body": "Man this changeset keeps getting smaller and smaller. Thanks @ryanofsky!\r\n\r\nI've reverted back to doing a stateful approach for assumed-valid detection in LoadBlockIndex since the more holistic approach of scanning ancestors ended up being prohibitively slow when loading the main chain. This has allowed me to drop a few more changes from the original patch.\r\n\r\nThe only remaining item left is to write unittests for the contents of `setBlockIndexCandidates` after calling LoadBlockIndex, which I'll be working on shortly.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/964561176/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/965766954",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#issuecomment-965766954",
    "issue_url": "https://api.github.com/repos/bitcoin/bitcoin/issues/23174",
    "id": 965766954,
    "node_id": "IC_kwDOABII5845kG8q",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "created_at": "2021-11-10T21:37:22Z",
    "updated_at": "2021-11-10T21:37:22Z",
    "author_association": "MEMBER",
    "body": "@ryanofsky nice timing. I just pushed a unittest for `LoadBlockIndex()`/`setBlockIndexCandidates`.",
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/issues/comments/965766954/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "performed_via_github_app": null
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725089856",
    "pull_request_review_id": 775125236,
    "id": 725089856,
    "node_id": "PRRC_kwDOABII584rN_5A",
    "diff_hunk": "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;\n+    unsigned int assumedvalid_end_nchaintx;\n+    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 22,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "For `std::tie`\r\n```diff\r\n+++ b/src/validation.cpp\r\n@@ -58,6 +58,7 @@\r\n #include <numeric>\r\n #include <optional>\r\n #include <string>\r\n+#include <tuple>\r\n```\r\n",
    "created_at": "2021-10-08T15:02:56Z",
    "updated_at": "2021-10-08T15:28:47Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725089856",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725089856"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725089856"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725089856/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3643,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725093367",
    "pull_request_review_id": 775125236,
    "id": 725093367,
    "node_id": "PRRC_kwDOABII584rOAv3",
    "diff_hunk": "@@ -3658,7 +3691,18 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+            for (CChainState* chainstate : chainman.GetAll()) {\n+                // If we're on an block index entry that is passed the end of the",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 67,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "- s/an block/a block/\r\n- s/passed the end/past the end/?\r\n\r\nmy editor auto-proposes this\r\n```diff\r\n-                // If we're on an block index entry that is passed the end of the\r\n-                // assumed-valid region of the chain, avoid\r\n-                // adding this as a candidate tip to the background validation\r\n-                // chain, since that would prevent background IBD from happening.\r\n+                // If we're on a block index entry that is past the end of the\r\n+                // assumed-valid region of the chain, avoid adding this as a\r\n+                // candidate tip to the background validation chain, since that\r\n+                // would prevent background IBD from happening.\r\n```\r\n",
    "created_at": "2021-10-08T15:07:35Z",
    "updated_at": "2021-10-08T15:28:47Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725093367",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725093367"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725093367"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725093367/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3695,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725093792",
    "pull_request_review_id": 775125236,
    "id": 725093792,
    "node_id": "PRRC_kwDOABII584rOA2g",
    "diff_hunk": "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;\n+    unsigned int assumedvalid_end_nchaintx;\n+    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =\n+        chainman.getAssumedValidEnd();\n+\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\n     {\n         if (ShutdownRequested()) return false;\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\n+\n         // We can link the chain of blocks for which we've received transactions at some point.\n         // Pruned nodes may have deleted the block.\n+        //\n+        // Do not expect assumed-valid blocks to have nTx.\n         if (pindex->nTx > 0) {\n             if (pindex->pprev) {\n-                if (pindex->pprev->HaveTxsDownloaded()) {\n+                bool is_assumedvalid_end =",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 39,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "```suggestion\r\n                const bool is_assumedvalid_end =\r\n```",
    "created_at": "2021-10-08T15:08:04Z",
    "updated_at": "2021-10-08T15:28:47Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725093792",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725093792"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725093792"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725093792/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3659,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725101183",
    "pull_request_review_id": 775125236,
    "id": 725101183,
    "node_id": "PRRC_kwDOABII584rOCp_",
    "diff_hunk": "@@ -1010,6 +1014,12 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! If some region of the block index is assumed to be valid (as in the case of\n+    //! UTXO snapshot usage), return the last blockhash to be assumed valid (i.e. the\n+    //! base of the snapshot) and the correspondent nChainTx value associated with it.\n+    std::pair<std::optional<uint256>, unsigned int> getAssumedValidEnd()",
    "path": "src/validation.h",
    "position": null,
    "original_position": 52,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "style nit, PascalCase unless there is some reason I'm not aware of here (same for the other `get...` functions introduced here) \r\n ```suggestion\r\n     std::pair<std::optional<uint256>, unsigned int> GetAssumedValidEnd()\r\n```",
    "created_at": "2021-10-08T15:18:03Z",
    "updated_at": "2021-10-08T15:30:10Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725101183",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725101183"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r725101183"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/725101183/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1020,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728209676",
    "pull_request_review_id": 778777785,
    "id": 728209676,
    "node_id": "PRRC_kwDOABII584rZ5kM",
    "diff_hunk": "@@ -1010,6 +1014,12 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! If some region of the block index is assumed to be valid (as in the case of\n+    //! UTXO snapshot usage), return the last blockhash to be assumed valid (i.e. the\n+    //! base of the snapshot) and the correspondent nChainTx value associated with it.\n+    std::pair<std::optional<uint256>, unsigned int> getAssumedValidEnd()",
    "path": "src/validation.h",
    "position": null,
    "original_position": 52,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (51e614fdbc6a23ade324e9bd01228bf97df9bc5d):\r\n\r\nWould suggest changing `GetAssumedValidEnd` to `GetLastAssumedValid` because \"end\" does not seem right here. In c++ \"end\" usually refers to the first element after the range, not the last element in the range. \r\n\r\nAlso, it seems like whole return value should be optional, not just the first element of the pair (`optional<tuple<uint256, int>>` not `pair<optional<uint256>, int>`. Changing this would also avoid having having to return a dummy `0` nchaintx value in the implementation if there is no snapshot.",
    "created_at": "2021-10-13T15:49:04Z",
    "updated_at": "2021-10-19T20:05:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r728209676",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728209676"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r728209676"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728209676/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1020,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728812760",
    "pull_request_review_id": 778777785,
    "id": 728812760,
    "node_id": "PRRC_kwDOABII584rcMzY",
    "diff_hunk": "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 18,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (51e614fdbc6a23ade324e9bd01228bf97df9bc5d)\r\n\r\nThis comment seems a little out of place since it's not describing these variables, but describing how they are used in code below. Would maybe suggest breaking this up and moving it to relevant places below.",
    "created_at": "2021-10-14T09:40:43Z",
    "updated_at": "2021-10-19T20:05:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r728812760",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728812760"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r728812760"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/728812760/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3639,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732065458",
    "pull_request_review_id": 778777785,
    "id": 732065458,
    "node_id": "PRRC_kwDOABII584rom6y",
    "diff_hunk": "@@ -1010,6 +1014,12 @@ class ChainstateManager\n     //! ResizeCoinsCaches() as needed.\n     void MaybeRebalanceCaches() EXCLUSIVE_LOCKS_REQUIRED(::cs_main);\n \n+    //! If some region of the block index is assumed to be valid (as in the case of\n+    //! UTXO snapshot usage), return the last blockhash to be assumed valid (i.e. the\n+    //! base of the snapshot) and the correspondent nChainTx value associated with it.\n+    std::pair<std::optional<uint256>, unsigned int> getAssumedValidEnd()",
    "path": "src/validation.h",
    "position": null,
    "original_position": 52,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> style nit, PascalCase unless there is some reason I'm not aware of here (same for the other `get...` functions introduced here)\r\n\r\nI always liked the lower/upper method/function convention so you know if some random function call is going to implicitly have access to `*this` as a hidden parameter. Making members or private members lowercase is less verbose than prefixing method calls with `this->` and this convention is already followed other parts of code. Nice to see internal method calls made more obvious in new code, IMO.",
    "created_at": "2021-10-19T16:52:47Z",
    "updated_at": "2021-10-19T20:05:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732065458",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732065458"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732065458"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732065458/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 1020,
    "side": "RIGHT",
    "in_reply_to_id": 725101183
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732083694",
    "pull_request_review_id": 778777785,
    "id": 732083694,
    "node_id": "PRRC_kwDOABII584rorXu",
    "diff_hunk": "@@ -629,6 +625,10 @@ class CChainState\n      */\n     const std::optional<uint256> m_from_snapshot_blockhash;\n \n+    //! Return true if this chainstate relies on blocks that are assumed-valid. In\n+    //! practice this means it was created based on a UTXO snapshot.\n+    bool ReliesOnAssumeValid() { return m_from_snapshot_blockhash.has_value(); }",
    "path": "src/validation.h",
    "position": null,
    "original_position": 29,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (51e614fdbc6a23ade324e9bd01228bf97df9bc5d)\r\n\r\nAnother naming nitpick. Feel free to ignore this naming suggestion and all the other ones, but might suggest inverting this function and calling it something like \"OnlyContainsAssumedValidBlocks\". This seems less handwavy than \"ReliesOnAssumeValid\" because it's not clear what \"relies\" mean or who is relying.",
    "created_at": "2021-10-19T17:16:13Z",
    "updated_at": "2021-10-19T20:05:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732083694",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732083694"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732083694"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732083694/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 630,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732089256",
    "pull_request_review_id": 778777785,
    "id": 732089256,
    "node_id": "PRRC_kwDOABII584rosuo",
    "diff_hunk": "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 20,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (51e614fdbc6a23ade324e9bd01228bf97df9bc5d)\r\n\r\nAlso suggested this in another comment, but maybe consider `s/assumedvalid_end/last_assumed_valid/` throughout this function, because \"end\" in c++ usually refers to first element after the range, not the last element in the range",
    "created_at": "2021-10-19T17:23:19Z",
    "updated_at": "2021-10-19T20:05:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732089256",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732089256"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732089256"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732089256/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3641,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732090717",
    "pull_request_review_id": 778777785,
    "id": 732090717,
    "node_id": "PRRC_kwDOABII584rotFd",
    "diff_hunk": "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;\n+    unsigned int assumedvalid_end_nchaintx;\n+    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =\n+        chainman.getAssumedValidEnd();",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 23,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (51e614fdbc6a23ade324e9bd01228bf97df9bc5d)\r\n\r\nCould use structured bindings to save space and avoid potentially dangerous type mismatches:\r\n\r\n```diff\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -3638,10 +3638,7 @@ bool BlockManager::LoadBlockIndex(\r\n     // setBlockIndexCandidates of the background chainstate.\r\n     bool saw_end_of_assumedvalid{false};\r\n \r\n-    std::optional<uint256> assumedvalid_end_blockhash;\r\n-    unsigned int assumedvalid_end_nchaintx;\r\n-    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =\r\n-        chainman.getAssumedValidEnd();\r\n+    auto [assumedvalid_end_blockhash, assumedvalid_end_nchaintx] = chainman.getAssumedValidEnd();\r\n \r\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\r\n     {\r\n\r\n```\r\n\r\n",
    "created_at": "2021-10-19T17:25:18Z",
    "updated_at": "2021-10-19T20:05:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732090717",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732090717"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732090717"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732090717/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 3641,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 3644,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732122417",
    "pull_request_review_id": 778777785,
    "id": 732122417,
    "node_id": "PRRC_kwDOABII584ro00x",
    "diff_hunk": "@@ -3658,7 +3691,18 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+            for (CChainState* chainstate : chainman.GetAll()) {\n+                // If we're on an block index entry that is passed the end of the\n+                // assumed-valid region of the chain, avoid\n+                // adding this as a candidate tip to the background validation\n+                // chain, since that would prevent background IBD from happening.",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 70,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (51e614fdbc6a23ade324e9bd01228bf97df9bc5d)\r\n\r\nIt's not so clear why adding blocks to `setBlockIndexCandidates` would prevent IBD from happening. The negative \"avoid doing X so Y doesn't happen\" logic here is a bit twisty, so I would try to describe more positively what this is doing. Something like:\r\n\r\n```c++\r\n// If a chain only supposed to contain assume valid blocks (because it is\r\n// validating them in the background) avoid adding later validated blocks,\r\n// because these would prevent earlier blocks from being downloaded and\r\n// validated.\r\nif (!chainstate->OnlyContainsAssumeValidBlocks() || block_assumed_valid) {\r\n    chainstate->setBlockIndexCandidates.insert(pindex);\r\n}\r\n```",
    "created_at": "2021-10-19T18:07:48Z",
    "updated_at": "2021-10-19T20:07:35Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732122417",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732122417"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732122417"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732122417/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3698,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732130569",
    "pull_request_review_id": 778777785,
    "id": 732130569,
    "node_id": "PRRC_kwDOABII584ro20J",
    "diff_hunk": "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;\n+    unsigned int assumedvalid_end_nchaintx;\n+    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =\n+        chainman.getAssumedValidEnd();\n+\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\n     {\n         if (ShutdownRequested()) return false;\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\n+\n         // We can link the chain of blocks for which we've received transactions at some point.\n         // Pruned nodes may have deleted the block.\n+        //\n+        // Do not expect assumed-valid blocks to have nTx.\n         if (pindex->nTx > 0) {",
    "path": "src/validation.cpp",
    "position": 46,
    "original_position": 36,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (51e614fdbc6a23ade324e9bd01228bf97df9bc5d)\r\n\r\nIs there a bug here? Comment is saying do not expect assumed valid blocks to have nTx, then the next line immediately skips assume valid logic if `nTx` is `0`",
    "created_at": "2021-10-19T18:19:21Z",
    "updated_at": "2021-10-19T20:05:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732130569",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732130569"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732130569"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732130569/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3657,
    "original_line": 3657,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732132238",
    "pull_request_review_id": 778777785,
    "id": 732132238,
    "node_id": "PRRC_kwDOABII584ro3OO",
    "diff_hunk": "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;\n+    unsigned int assumedvalid_end_nchaintx;\n+    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =\n+        chainman.getAssumedValidEnd();\n+\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\n     {\n         if (ShutdownRequested()) return false;\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\n+\n         // We can link the chain of blocks for which we've received transactions at some point.\n         // Pruned nodes may have deleted the block.\n+        //\n+        // Do not expect assumed-valid blocks to have nTx.\n         if (pindex->nTx > 0) {\n             if (pindex->pprev) {\n-                if (pindex->pprev->HaveTxsDownloaded()) {\n+                bool is_assumedvalid_end =\n+                    assumedvalid_end_blockhash &&\n+                    pindex->GetBlockHash() == *assumedvalid_end_blockhash;\n+\n+                if (is_assumedvalid_end) {\n+                    // While starting up with an assumeutxo snapshot chain,\n+                    // we need to manually populate the nChainTx field of the\n+                    // base of the snapshot so that we can add assumed-valid\n+                    // candidate tips to setBlockIndexCandidates below.\n+                    //\n+                    // After the snapshot has completed validation, nChainTx\n+                    // values should compute normally.\n+                    assert(assumedvalid_end_nchaintx > 0);\n+                    pindex->nChainTx = assumedvalid_end_nchaintx;",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 52,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (51e614fdbc6a23ade324e9bd01228bf97df9bc5d)\r\n\r\nIt would be good to have a unit test that ensures the function is actually setting this.",
    "created_at": "2021-10-19T18:21:38Z",
    "updated_at": "2021-10-19T20:05:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732132238",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732132238"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732132238"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732132238/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3672,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732133664",
    "pull_request_review_id": 778777785,
    "id": 732133664,
    "node_id": "PRRC_kwDOABII584ro3kg",
    "diff_hunk": "@@ -3658,7 +3691,18 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+            for (CChainState* chainstate : chainman.GetAll()) {\n+                // If we're on an block index entry that is passed the end of the\n+                // assumed-valid region of the chain, avoid\n+                // adding this as a candidate tip to the background validation\n+                // chain, since that would prevent background IBD from happening.\n+                //\n+                // If there is no assumed-valid region of the chain,\n+                // !saw_end_of_assumedvalid will always be true.\n+                if (!saw_end_of_assumedvalid || chainstate->ReliesOnAssumeValid()) {\n+                    chainstate->setBlockIndexCandidates.insert(pindex);\n+                }",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 76,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (51e614fdbc6a23ade324e9bd01228bf97df9bc5d)\r\n\r\nIt would be good to have a unit test that ensure the function is adding the right blocks as candidates in both chains.",
    "created_at": "2021-10-19T18:23:38Z",
    "updated_at": "2021-10-19T20:05:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732133664",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732133664"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732133664"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732133664/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 3702,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 3696,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732153494",
    "pull_request_review_id": 778777785,
    "id": 732153494,
    "node_id": "PRRC_kwDOABII584ro8aW",
    "diff_hunk": "@@ -5020,3 +5062,41 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{\n+    auto blockhash_op = SnapshotBlockhash();\n+    if (!blockhash_op) return nullptr;\n+    return m_blockman.LookupBlockIndex(*blockhash_op);\n+}\n+\n+std::optional<int> ChainstateManager::getSnapshotHeight()\n+{\n+    CBlockIndex* base = getSnapshotBaseBlock();\n+    return base ? std::make_optional(base->nHeight) : std::nullopt;\n+}\n+\n+std::optional<unsigned int> ChainstateManager::getSnapshotNChainTx()\n+{\n+    auto height = getSnapshotHeight();\n+    if (!height) return std::nullopt;\n+\n+    auto au_data = ExpectedAssumeutxo(*height, ::Params());\n+    if (!au_data) {\n+        LogPrintf(\"%s: WARNING: no assumeutxo chainparams found for \" /* Continued */\n+            \"active snapshot (%s); something is wrong - please report this\\n\",\n+            __func__, (*this->SnapshotBlockhash()).ToString());\n+        return std::nullopt;\n+    }\n+\n+    return au_data->nChainTx;\n+}\n+\n+std::pair<std::optional<uint256>, unsigned int> ChainstateManager::getAssumedValidEnd()\n+{\n+    std::optional<uint256> snapshotblockhash = SnapshotBlockhash();\n+    std::optional<unsigned int> nchaintx = getSnapshotNChainTx();\n+\n+    if (!snapshotblockhash || !nchaintx) return {std::nullopt, 0};",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 143,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (51e614fdbc6a23ade324e9bd01228bf97df9bc5d)\r\n\r\nMight write to assert when values are inconsistent:\r\n\r\n```c++\r\nif (nchaintx) {\r\n  assert(snapshotblockhash);\r\n  return {snapshotblockhash, *nchaintx};\r\n}\r\nreturn {nullopt, 0};\r\n```",
    "created_at": "2021-10-19T18:51:40Z",
    "updated_at": "2021-10-19T20:05:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732153494",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732153494"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732153494"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732153494/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 5100,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732182831",
    "pull_request_review_id": 778777785,
    "id": 732182831,
    "node_id": "PRRC_kwDOABII584rpDkv",
    "diff_hunk": "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;\n+    unsigned int assumedvalid_end_nchaintx;\n+    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =\n+        chainman.getAssumedValidEnd();\n+\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\n     {\n         if (ShutdownRequested()) return false;\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\n+\n         // We can link the chain of blocks for which we've received transactions at some point.\n         // Pruned nodes may have deleted the block.\n+        //\n+        // Do not expect assumed-valid blocks to have nTx.\n         if (pindex->nTx > 0) {\n             if (pindex->pprev) {\n-                if (pindex->pprev->HaveTxsDownloaded()) {\n+                bool is_assumedvalid_end =\n+                    assumedvalid_end_blockhash &&\n+                    pindex->GetBlockHash() == *assumedvalid_end_blockhash;\n+\n+                if (is_assumedvalid_end) {\n+                    // While starting up with an assumeutxo snapshot chain,\n+                    // we need to manually populate the nChainTx field of the\n+                    // base of the snapshot so that we can add assumed-valid\n+                    // candidate tips to setBlockIndexCandidates below.\n+                    //\n+                    // After the snapshot has completed validation, nChainTx\n+                    // values should compute normally.\n+                    assert(assumedvalid_end_nchaintx > 0);\n+                    pindex->nChainTx = assumedvalid_end_nchaintx;\n+                    saw_end_of_assumedvalid = true;",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 53,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (51e614fdbc6a23ade324e9bd01228bf97df9bc5d)\r\n\r\nThere can be multiple blocks at the same height in vSortedByHeight, right? If so, this behavior seems nondeterministic, because it's sorted by (height, pointer address), so blocks at the assume valid height with pointer addresses _less_ than the assume valid height will be added to `setBlockIndexCandidates` and blocks at the same height with _greater_ pointer addresses will not by added to `setBlockIndexCandidates`.\r\n\r\nHaving this mutable bool variable in the for loop makes this loop more stateful and complicated anyway. I think maybe ideally the GetAssumeValid method should return a (hash, height, nchaintx) tuple instead of a (hash, nchaintx) pair. So the height would be known in advance and the code could look something like:\r\n\r\n```c++\r\nconst auto last_assumed_valid_block = chainman.GetLastAssumedValid();\r\nfor (const auto& [height, pindex] : vSortedByHeight) {\r\n    // Update nChainTx the last assumed valid block\r\n    if (last_assumed_valid_block) {\r\n        const auto& [av_hash, av_height, av_chaintx] = *last_assumed_valid_block;\r\n        if (pindex->GetBlockHash() == av_hash) {\r\n            pindex->nChainTx = av_chaintx;\r\n        }\r\n    }\r\n    ....\r\n    // Add block to chain candidates lists, unless the block is after the assumed valid\r\n    // height and the chain is only supposed to contain assumed valid blocks (if it's a\r\n    // background chain supposed to download and validate them).\r\n    const int av_height = last_assumed_valid_block ? std::get<1>(*last_assumed_valid_block) : std::numeric_limits<int>::max();\r\n    if (!chainstate->OnlyContainsAssumedValidBlocks() || pindex->nHeight <= av_height) {\r\n         chainstate->setBlockIndexCandidates.insert(pindex);\r\n    }\r\n}\r\n```\r\n",
    "created_at": "2021-10-19T19:32:46Z",
    "updated_at": "2021-10-19T20:05:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732182831",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732182831"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732182831"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/732182831/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3673,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736021606",
    "pull_request_review_id": 788689376,
    "id": 736021606,
    "node_id": "PRRC_kwDOABII584r3sxm",
    "diff_hunk": "@@ -5020,3 +5062,41 @@ void ChainstateManager::MaybeRebalanceCaches()\n         }\n     }\n }\n+\n+CBlockIndex* ChainstateManager::getSnapshotBaseBlock()\n+{\n+    auto blockhash_op = SnapshotBlockhash();\n+    if (!blockhash_op) return nullptr;\n+    return m_blockman.LookupBlockIndex(*blockhash_op);\n+}\n+\n+std::optional<int> ChainstateManager::getSnapshotHeight()\n+{\n+    CBlockIndex* base = getSnapshotBaseBlock();\n+    return base ? std::make_optional(base->nHeight) : std::nullopt;\n+}\n+\n+std::optional<unsigned int> ChainstateManager::getSnapshotNChainTx()\n+{\n+    auto height = getSnapshotHeight();\n+    if (!height) return std::nullopt;\n+\n+    auto au_data = ExpectedAssumeutxo(*height, ::Params());\n+    if (!au_data) {\n+        LogPrintf(\"%s: WARNING: no assumeutxo chainparams found for \" /* Continued */\n+            \"active snapshot (%s); something is wrong - please report this\\n\",\n+            __func__, (*this->SnapshotBlockhash()).ToString());\n+        return std::nullopt;\n+    }\n+\n+    return au_data->nChainTx;\n+}\n+\n+std::pair<std::optional<uint256>, unsigned int> ChainstateManager::getAssumedValidEnd()\n+{\n+    std::optional<uint256> snapshotblockhash = SnapshotBlockhash();",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 140,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Can be `auto blockhash_op` ?",
    "created_at": "2021-10-25T22:50:51Z",
    "updated_at": "2021-10-25T23:51:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r736021606",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736021606"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r736021606"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736021606/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 5097,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736036940",
    "pull_request_review_id": 788689376,
    "id": 736036940,
    "node_id": "PRRC_kwDOABII584r3whM",
    "diff_hunk": "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;\n+    unsigned int assumedvalid_end_nchaintx;\n+    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =\n+        chainman.getAssumedValidEnd();\n+\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\n     {\n         if (ShutdownRequested()) return false;\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\n+\n         // We can link the chain of blocks for which we've received transactions at some point.\n         // Pruned nodes may have deleted the block.\n+        //\n+        // Do not expect assumed-valid blocks to have nTx.\n         if (pindex->nTx > 0) {",
    "path": "src/validation.cpp",
    "position": 46,
    "original_position": 36,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Agree, I think if the new logic seeks to detect the last block of the assumed-valid range but assumed-valid blocks are expected to not have `nTx`, detection success cannot be reached if it's conditional on `nTx` > 0.",
    "created_at": "2021-10-25T23:30:06Z",
    "updated_at": "2021-10-25T23:51:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r736036940",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736036940"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r736036940"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736036940/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3657,
    "original_line": 3657,
    "side": "RIGHT",
    "in_reply_to_id": 732130569
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736041983",
    "pull_request_review_id": 788689376,
    "id": 736041983,
    "node_id": "PRRC_kwDOABII584r3xv_",
    "diff_hunk": "@@ -3658,7 +3691,18 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+            for (CChainState* chainstate : chainman.GetAll()) {\n+                // If we're on an block index entry that is passed the end of the\n+                // assumed-valid region of the chain, avoid\n+                // adding this as a candidate tip to the background validation\n+                // chain, since that would prevent background IBD from happening.\n+                //\n+                // If there is no assumed-valid region of the chain,\n+                // !saw_end_of_assumedvalid will always be true.\n+                if (!saw_end_of_assumedvalid || chainstate->ReliesOnAssumeValid()) {",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 74,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Shouldn't the logical operator be an `&&` ?\r\n\r\nOtherwise I think if the end of the assumed-valid block region has been reached (`saw_end_of_assumevalid`=true) logic still enters this control flow.  And as such block index entries past the assumed-valid region of the chain are added to `setBlockIndexCandidates` (AFAIU from the comment just above).",
    "created_at": "2021-10-25T23:43:56Z",
    "updated_at": "2021-10-25T23:51:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r736041983",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736041983"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r736041983"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736041983/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3702,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736042920",
    "pull_request_review_id": 788689376,
    "id": 736042920,
    "node_id": "PRRC_kwDOABII584r3x-o",
    "diff_hunk": "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;\n+    unsigned int assumedvalid_end_nchaintx;\n+    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =\n+        chainman.getAssumedValidEnd();\n+\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\n     {\n         if (ShutdownRequested()) return false;\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\n+\n         // We can link the chain of blocks for which we've received transactions at some point.\n         // Pruned nodes may have deleted the block.\n+        //\n+        // Do not expect assumed-valid blocks to have nTx.\n         if (pindex->nTx > 0) {\n             if (pindex->pprev) {\n-                if (pindex->pprev->HaveTxsDownloaded()) {\n+                bool is_assumedvalid_end =\n+                    assumedvalid_end_blockhash &&\n+                    pindex->GetBlockHash() == *assumedvalid_end_blockhash;\n+\n+                if (is_assumedvalid_end) {\n+                    // While starting up with an assumeutxo snapshot chain,\n+                    // we need to manually populate the nChainTx field of the\n+                    // base of the snapshot so that we can add assumed-valid",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 46,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I don't see the causality between populating the `nChainTx` and adequately adding assumed-valid and assumed-valid _only_ blocks to `setBlockIndexCandidates` for snapshot chainstates ? I think conditional L3691 isn't pending on `nChainTx`.",
    "created_at": "2021-10-25T23:46:51Z",
    "updated_at": "2021-10-25T23:51:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r736042920",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736042920"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r736042920"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/736042920/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3666,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/737666011",
    "pull_request_review_id": 790914212,
    "id": 737666011,
    "node_id": "PRRC_kwDOABII584r9-Pb",
    "diff_hunk": "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;\n+    unsigned int assumedvalid_end_nchaintx;\n+    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =\n+        chainman.getAssumedValidEnd();\n+\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\n     {\n         if (ShutdownRequested()) return false;\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\n+\n         // We can link the chain of blocks for which we've received transactions at some point.\n         // Pruned nodes may have deleted the block.\n+        //\n+        // Do not expect assumed-valid blocks to have nTx.\n         if (pindex->nTx > 0) {",
    "path": "src/validation.cpp",
    "position": 46,
    "original_position": 36,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Good points - this is a little confusing; my fault for not being clearer in commentary. `nTx = 1` is set for all block headers during snapshot activation (https://github.com/jamesob/bitcoin/blob/2021-10-au-loadblockindex/src/validation.cpp#L4966-L4970) so this code will be executed for all assumed-valid blocks.\r\n\r\nNow that you've raised the point, I'm wondering if this code is even necessary. The modifications here are redundant with the ones we do during snapshot activation (linked above), and I think I added these here in LoadBlockIndex as a matter of necessity before I [thought to set the entire blockindex to dirty](https://github.com/jamesob/bitcoin/blob/2021-10-au-loadblockindex/src/validation.cpp#L4987) in the activation routine (thereby persisting all changes during FlushStateToDisk).\r\n\r\nI was going to say that having this code here is still valuable, if not a little confusing, in case there is some kind of interruption when writing the block index immediately after snapshot load... but changes to the block index [are batched](https://github.com/jamesob/bitcoin/blob/2021-10-au-loadblockindex/src/validation.cpp#L2022-L2024), so if we fail to write the block index, none of the chain will be considered assumedvalid!\r\n\r\nSo: maybe some of these LoadBlockIndex changes are unnecessary? I'll work to determine this today.",
    "created_at": "2021-10-27T16:51:49Z",
    "updated_at": "2021-10-27T16:51:50Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r737666011",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/737666011"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r737666011"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/737666011/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3657,
    "original_line": 3657,
    "side": "RIGHT",
    "in_reply_to_id": 732130569
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738785918",
    "pull_request_review_id": 792442090,
    "id": 738785918,
    "node_id": "PRRC_kwDOABII584sCPp-",
    "diff_hunk": "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;\n+    unsigned int assumedvalid_end_nchaintx;\n+    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =\n+        chainman.getAssumedValidEnd();\n+\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\n     {\n         if (ShutdownRequested()) return false;\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\n+\n         // We can link the chain of blocks for which we've received transactions at some point.\n         // Pruned nodes may have deleted the block.\n+        //\n+        // Do not expect assumed-valid blocks to have nTx.\n         if (pindex->nTx > 0) {\n             if (pindex->pprev) {\n-                if (pindex->pprev->HaveTxsDownloaded()) {\n+                bool is_assumedvalid_end =\n+                    assumedvalid_end_blockhash &&\n+                    pindex->GetBlockHash() == *assumedvalid_end_blockhash;\n+\n+                if (is_assumedvalid_end) {\n+                    // While starting up with an assumeutxo snapshot chain,\n+                    // we need to manually populate the nChainTx field of the\n+                    // base of the snapshot so that we can add assumed-valid",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 46,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Good point! Addressed in new changeset.",
    "created_at": "2021-10-28T21:24:39Z",
    "updated_at": "2021-10-28T21:24:40Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r738785918",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738785918"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r738785918"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738785918/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3666,
    "side": "RIGHT",
    "in_reply_to_id": 736042920
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738794750",
    "pull_request_review_id": 792453581,
    "id": 738794750,
    "node_id": "PRRC_kwDOABII584sCRz-",
    "diff_hunk": "@@ -3631,17 +3631,50 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // If we have a historical region of the chain that is assumed-valid, we should\n+    // mark the last assumed-valid block that we see, since we then have to populate\n+    // the final nChainTx as well as prevent inclusion of blocks after that in the\n+    // setBlockIndexCandidates of the background chainstate.\n+    bool saw_end_of_assumedvalid{false};\n+\n+    std::optional<uint256> assumedvalid_end_blockhash;\n+    unsigned int assumedvalid_end_nchaintx;\n+    std::tie(assumedvalid_end_blockhash, assumedvalid_end_nchaintx) =\n+        chainman.getAssumedValidEnd();\n+\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\n     {\n         if (ShutdownRequested()) return false;\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\n+\n         // We can link the chain of blocks for which we've received transactions at some point.\n         // Pruned nodes may have deleted the block.\n+        //\n+        // Do not expect assumed-valid blocks to have nTx.\n         if (pindex->nTx > 0) {\n             if (pindex->pprev) {\n-                if (pindex->pprev->HaveTxsDownloaded()) {\n+                bool is_assumedvalid_end =\n+                    assumedvalid_end_blockhash &&\n+                    pindex->GetBlockHash() == *assumedvalid_end_blockhash;\n+\n+                if (is_assumedvalid_end) {\n+                    // While starting up with an assumeutxo snapshot chain,\n+                    // we need to manually populate the nChainTx field of the\n+                    // base of the snapshot so that we can add assumed-valid\n+                    // candidate tips to setBlockIndexCandidates below.\n+                    //\n+                    // After the snapshot has completed validation, nChainTx\n+                    // values should compute normally.\n+                    assert(assumedvalid_end_nchaintx > 0);\n+                    pindex->nChainTx = assumedvalid_end_nchaintx;\n+                    saw_end_of_assumedvalid = true;",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 53,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Thanks for this comment; this raises a really good point. The LoadBlockIndex() modifications are now no longer stateful, and instead we walk backwards for each pindex to see if any of its ancestors are assumed-valid (which is O(n**2) with chain size, but since LoadBlockIndex() happens once on startup that doesn't really matter).",
    "created_at": "2021-10-28T21:41:04Z",
    "updated_at": "2021-10-28T21:41:04Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r738794750",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738794750"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r738794750"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738794750/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3673,
    "side": "RIGHT",
    "in_reply_to_id": 732182831
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738795942",
    "pull_request_review_id": 792455220,
    "id": 738795942,
    "node_id": "PRRC_kwDOABII584sCSGm",
    "diff_hunk": "@@ -3622,17 +3622,21 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\n     {\n         if (ShutdownRequested()) return false;\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\n-        // We can link the chain of blocks for which we've received transactions at some point.\n+\n+        // We can link the chain of blocks for which we've received transactions at some point, or\n+        // blocks that are assumed-valid on the basis of snapshot load (see\n+        // PopulateAndValidateSnapshot()).\n         // Pruned nodes may have deleted the block.\n         if (pindex->nTx > 0) {\n             if (pindex->pprev) {\n-                if (pindex->pprev->HaveTxsDownloaded()) {\n+                if (pindex->pprev->nChainTx > 0) {",
    "path": "src/validation.cpp",
    "position": 49,
    "original_position": 29,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "2d7ecfb6e9847a0f0d9072e659a743bd231381cd",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Note that this change is tautological, but done for clarity. `HaveTxsDownloaded()` should probably be removed since its name conflicts with assumed-valid blocks that have had their nChainTx value set during snapshot activation.",
    "created_at": "2021-10-28T21:43:30Z",
    "updated_at": "2021-10-28T21:43:30Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r738795942",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738795942"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r738795942"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/738795942/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3659,
    "original_line": 3659,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740230078",
    "pull_request_review_id": 794234225,
    "id": 740230078,
    "node_id": "PRRC_kwDOABII584sHwO-",
    "diff_hunk": "@@ -3658,7 +3691,18 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+            for (CChainState* chainstate : chainman.GetAll()) {\n+                // If we're on an block index entry that is passed the end of the",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 67,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "51e614fdbc6a23ade324e9bd01228bf97df9bc5d",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Fixed",
    "created_at": "2021-11-01T13:56:21Z",
    "updated_at": "2021-11-01T13:56:22Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r740230078",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740230078"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r740230078"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/740230078/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3695,
    "side": "RIGHT",
    "in_reply_to_id": 725093367
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741479471",
    "pull_request_review_id": 795938311,
    "id": 741479471,
    "node_id": "PRRC_kwDOABII584sMhQv",
    "diff_hunk": "@@ -4912,6 +4912,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n         index = snapshot_chainstate.m_chain[i];\n \n+        if (index->isGenesis()) {",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "cb1d4244806980d31ceaa2307431dd70e6c39fe9",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: don't modify genesis during snapshot load\" (cb1d4244806980d31ceaa2307431dd70e6c39fe9)\r\n\r\nThe new comment here seems good, but I think it would be more direct and straightforward to write\r\n\r\n```diff\r\n-for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\r\n+for (int i = 1; i <= snapshot_chainstate.m_chain.Height(); ++i) {\r\n```\r\n\r\nabove than add this extra control flow and indirect `isGenesis()` height check.",
    "created_at": "2021-11-02T21:36:50Z",
    "updated_at": "2021-11-02T23:13:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r741479471",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741479471"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r741479471"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741479471/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 4915,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741482214",
    "pull_request_review_id": 795938311,
    "id": 741482214,
    "node_id": "PRRC_kwDOABII584sMh7m",
    "diff_hunk": "@@ -4912,6 +4912,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n         index = snapshot_chainstate.m_chain[i];\n \n+        if (index->isGenesis()) {\n+            // Don't make any modifications to the genesis block.\n+            // This is especially important because we don't want to erroneously",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 6,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "cb1d4244806980d31ceaa2307431dd70e6c39fe9",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: don't modify genesis during snapshot load\" (cb1d4244806980d31ceaa2307431dd70e6c39fe9)\r\n\r\nWould be good to have a unit test for this, if changing this could break things.",
    "created_at": "2021-11-02T21:41:52Z",
    "updated_at": "2021-11-02T23:13:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r741482214",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741482214"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r741482214"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741482214/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 4917,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741486651",
    "pull_request_review_id": 795938311,
    "id": 741486651,
    "node_id": "PRRC_kwDOABII584sMjA7",
    "diff_hunk": "@@ -312,6 +312,10 @@ class CBlockIndex\n     //!   validated by a background chainstate.\n     bool IsAssumedValid() const { return nStatus & BLOCK_ASSUMED_VALID; }\n \n+    // Runtime: O(n) with chain length.\n+    // Returns true if the block specified relies on ancestors which are assumed-valid.\n+    bool reliesOnAssumedValid() const;",
    "path": "src/chain.h",
    "position": null,
    "original_position": 6,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "619ada31fdc90f079cb1a6c44df6b76f6a162c1e",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: add CBlockIndex reliesOnAssumeValid\" (619ada31fdc90f079cb1a6c44df6b76f6a162c1e)\r\n\r\nWould suggest calling method `HasAssumedValidAncestors()` instead of `reliesOnAssumedValid()` to avoid vague \"relies\", to be more consistent with other `IsAssumedValid()` and `GetAncestor()` method names, and to be less confusing in the place where `CBlockIndex::reliesOnAssumedValid` and `CChainState::reliesOnAssumedValid` are both called together.",
    "created_at": "2021-11-02T21:50:28Z",
    "updated_at": "2021-11-02T23:13:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r741486651",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741486651"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r741486651"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741486651/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 317,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741490463",
    "pull_request_review_id": 795938311,
    "id": 741490463,
    "node_id": "PRRC_kwDOABII584sMj8f",
    "diff_hunk": "@@ -337,7 +341,7 @@ class CBlockIndex\n     //! Build the skiplist pointer for this entry.\n     void BuildSkip();\n \n-    //! Efficiently find an ancestor of this block.\n+    //! Efficiently find an ancestor of this block. If nHeight is passed, this is returned.",
    "path": "src/chain.h",
    "position": null,
    "original_position": 16,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "619ada31fdc90f079cb1a6c44df6b76f6a162c1e",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: add CBlockIndex reliesOnAssumeValid\" (619ada31fdc90f079cb1a6c44df6b76f6a162c1e)\r\n\r\nI was confused what `nHeight` might be referring to, or if it might be a typo for `height`. Maybe say \"If current block height is passed\" or \"If this->nHeight is passed\" instead of \"If nHeight is passed\"",
    "created_at": "2021-11-02T21:57:52Z",
    "updated_at": "2021-11-02T23:13:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r741490463",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741490463"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r741490463"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741490463/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 344,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741509474",
    "pull_request_review_id": 795938311,
    "id": 741509474,
    "node_id": "PRRC_kwDOABII584sMoli",
    "diff_hunk": "@@ -3649,7 +3653,18 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+            for (CChainState* chainstate : chainman.GetAll()) {\n+                // Only add blocks which are assumed-valid to fitting chainstates, i.e. those\n+                // populated on the basis of a UTXO snapshot.\n+                if (pindex->reliesOnAssumedValid()) {\n+                    if (chainstate->reliesOnAssumedValid()) {\n+                        chainstate->setBlockIndexCandidates.insert(pindex);\n+                    }\n+                } else {\n+                    // When blockindex doesn't rely on assumedvalid blocks, add it to all chainstates.\n+                    chainstate->setBlockIndexCandidates.insert(pindex);\n+                }\n+            }",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 49,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "dbca47ece6b9a3a5e02969270bfab340fce286c0",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (dbca47ece6b9a3a5e02969270bfab340fce286c0)\r\n\r\nI think I would suggest a few changes here:\r\n\r\n- Consolidate the insert calls, and just focus on one case where blocks shouldn't be added instead of branching for other cases.\r\n- Try to be less vague in comments (\"fitting chainstates\")\r\n- Be a little more efficient avoiding the O(n) pindex call, and mention it explicitly in comment to be clear that it's intentional.\r\n\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 4af1c7f07a0..eec27f63abb 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -3653,15 +3653,15 @@ bool BlockManager::LoadBlockIndex(\r\n         if (pindex->IsAssumedValid() ||\r\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\r\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\r\n+            // Following call is O(n), but should not be a significant slowdown.\r\n+            const bool has_assumed_valid_ancestors = pindex->reliesOnAssumedValid();\r\n+\r\n+            // Fill each chainstate's block candidate set. Add all blocks as\r\n+            // candidates if the chainstate is allowed to rely on assumed-valid\r\n+            // data. Otherwise avoid adding assumed-valid blocks so the\r\n+            // chainstate will download and validate all earlier blocks.\r\n             for (CChainState* chainstate : chainman.GetAll()) {\r\n-                // Only add blocks which are assumed-valid to fitting chainstates, i.e. those\r\n-                // populated on the basis of a UTXO snapshot.\r\n-                if (pindex->reliesOnAssumedValid()) {\r\n-                    if (chainstate->reliesOnAssumedValid()) {\r\n-                        chainstate->setBlockIndexCandidates.insert(pindex);\r\n-                    }\r\n-                } else {\r\n-                    // When blockindex doesn't rely on assumedvalid blocks, add it to all chainstates.\r\n+                if (chainstate->reliesOnAssumedValid() || !has_assumed_valid_ancestors) {\r\n                     chainstate->setBlockIndexCandidates.insert(pindex);\r\n                 }\r\n             }\r\n\r\n```\r\n\r\nAlso it would be good to have unit test coverage for this",
    "created_at": "2021-11-02T22:37:00Z",
    "updated_at": "2021-11-02T23:13:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r741509474",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741509474"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r741509474"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741509474/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 3652,
    "start_side": "LEFT",
    "line": null,
    "original_line": 3697,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741513665",
    "pull_request_review_id": 795938311,
    "id": 741513665,
    "node_id": "PRRC_kwDOABII584sMpnB",
    "diff_hunk": "@@ -119,6 +119,15 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n+bool CBlockIndex::reliesOnAssumedValid() const {",
    "path": "src/chain.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "619ada31fdc90f079cb1a6c44df6b76f6a162c1e",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: add CBlockIndex reliesOnAssumeValid\" (619ada31fdc90f079cb1a6c44df6b76f6a162c1e)\r\n\r\nWould be good and should be pretty easy add a simple unit test for this. If you want a template, `findearliestatleast_edge_test` is a simple existing test making a chain of blocks and checking some properties.",
    "created_at": "2021-11-02T22:47:00Z",
    "updated_at": "2021-11-02T23:13:44Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r741513665",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741513665"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r741513665"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/741513665/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 122,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745109360",
    "pull_request_review_id": 800628374,
    "id": 745109360,
    "node_id": "PRRC_kwDOABII584saXdw",
    "diff_hunk": "@@ -119,6 +119,15 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n+bool CBlockIndex::reliesOnAssumedValid() const {",
    "path": "src/chain.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "619ada31fdc90f079cb1a6c44df6b76f6a162c1e",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yep, will test this.\r\n\r\nAlso, this change is not mergeable as-is: it turns out invoking this for each CBlockIndex in the chain takes a really. long. time. making startup on mainnet appear as though it is hung. :cry: ",
    "created_at": "2021-11-08T21:33:41Z",
    "updated_at": "2021-11-08T21:33:42Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r745109360",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745109360"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r745109360"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/745109360/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 122,
    "side": "RIGHT",
    "in_reply_to_id": 741513665
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056082",
    "pull_request_review_id": 801894915,
    "id": 746056082,
    "node_id": "PRRC_kwDOABII584sd-mS",
    "diff_hunk": "@@ -4912,6 +4912,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n         index = snapshot_chainstate.m_chain[i];\n \n+        if (index->isGenesis()) {",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "cb1d4244806980d31ceaa2307431dd70e6c39fe9",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done.",
    "created_at": "2021-11-09T21:21:30Z",
    "updated_at": "2021-11-09T21:21:30Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746056082",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056082"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746056082"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056082/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 4915,
    "side": "RIGHT",
    "in_reply_to_id": 741479471
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056172",
    "pull_request_review_id": 801895010,
    "id": 746056172,
    "node_id": "PRRC_kwDOABII584sd-ns",
    "diff_hunk": "@@ -4912,6 +4912,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n     for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n         index = snapshot_chainstate.m_chain[i];\n \n+        if (index->isGenesis()) {\n+            // Don't make any modifications to the genesis block.\n+            // This is especially important because we don't want to erroneously",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 6,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "cb1d4244806980d31ceaa2307431dd70e6c39fe9",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Done.",
    "created_at": "2021-11-09T21:21:37Z",
    "updated_at": "2021-11-09T21:21:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746056172",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056172"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746056172"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056172/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 4917,
    "side": "RIGHT",
    "in_reply_to_id": 741482214
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056309",
    "pull_request_review_id": 801895182,
    "id": 746056309,
    "node_id": "PRRC_kwDOABII584sd-p1",
    "diff_hunk": "@@ -312,6 +312,10 @@ class CBlockIndex\n     //!   validated by a background chainstate.\n     bool IsAssumedValid() const { return nStatus & BLOCK_ASSUMED_VALID; }\n \n+    // Runtime: O(n) with chain length.\n+    // Returns true if the block specified relies on ancestors which are assumed-valid.\n+    bool reliesOnAssumedValid() const;",
    "path": "src/chain.h",
    "position": null,
    "original_position": 6,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "619ada31fdc90f079cb1a6c44df6b76f6a162c1e",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Removed this method altogether, so done.",
    "created_at": "2021-11-09T21:21:52Z",
    "updated_at": "2021-11-09T21:21:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746056309",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056309"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746056309"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056309/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 317,
    "side": "RIGHT",
    "in_reply_to_id": 741486651
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056515",
    "pull_request_review_id": 801895474,
    "id": 746056515,
    "node_id": "PRRC_kwDOABII584sd-tD",
    "diff_hunk": "@@ -3649,7 +3653,18 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+            for (CChainState* chainstate : chainman.GetAll()) {\n+                // Only add blocks which are assumed-valid to fitting chainstates, i.e. those\n+                // populated on the basis of a UTXO snapshot.\n+                if (pindex->reliesOnAssumedValid()) {\n+                    if (chainstate->reliesOnAssumedValid()) {\n+                        chainstate->setBlockIndexCandidates.insert(pindex);\n+                    }\n+                } else {\n+                    // When blockindex doesn't rely on assumedvalid blocks, add it to all chainstates.\n+                    chainstate->setBlockIndexCandidates.insert(pindex);\n+                }\n+            }",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 49,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "dbca47ece6b9a3a5e02969270bfab340fce286c0",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Addressed everything here aside from the unittest, which I will follow up with. ",
    "created_at": "2021-11-09T21:22:15Z",
    "updated_at": "2021-11-09T21:22:15Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746056515",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056515"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746056515"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056515/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 3652,
    "start_side": "LEFT",
    "line": null,
    "original_line": 3697,
    "side": "RIGHT",
    "in_reply_to_id": 741509474
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056741",
    "pull_request_review_id": 801895737,
    "id": 746056741,
    "node_id": "PRRC_kwDOABII584sd-wl",
    "diff_hunk": "@@ -119,6 +119,15 @@ void CBlockIndex::BuildSkip()\n         pskip = pprev->GetAncestor(GetSkipHeight(nHeight));\n }\n \n+bool CBlockIndex::reliesOnAssumedValid() const {",
    "path": "src/chain.cpp",
    "position": null,
    "original_position": 4,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "619ada31fdc90f079cb1a6c44df6b76f6a162c1e",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Fixed - nothing to test anymore.",
    "created_at": "2021-11-09T21:22:37Z",
    "updated_at": "2021-11-09T21:22:37Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746056741",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056741"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746056741"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746056741/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 122,
    "side": "RIGHT",
    "in_reply_to_id": 741513665
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746966753",
    "pull_request_review_id": 803118052,
    "id": 746966753,
    "node_id": "PRRC_kwDOABII584shc7h",
    "diff_hunk": "@@ -3622,17 +3622,29 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // Have we yet seen a pindex->IsAssumedValid()? If so, account for the fact that all subsequent\n+    // index entries rely on assumed-valid ancestors.\n+    bool seen_assumed_valid{false};\n+\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\n     {\n         if (ShutdownRequested()) return false;\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\n-        // We can link the chain of blocks for which we've received transactions at some point.\n+\n+        if (!seen_assumed_valid && pindex->IsAssumedValid()) {\n+            seen_assumed_valid = true;",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 27,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "2833bd0277ac87cd07e98b0a23b73eed97a2e513",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: don't modify genesis during snapshot load\" (86d48535198724c723370a447f73e134029331c2)\r\n\r\nI still don't think it is good that if there are two blocks at the same height and one is assumed valid, then how the other one is treated depends on whether its _pointer address_ is higher or lower than the assumed valid block pointer address. (Previous comment about this was https://github.com/bitcoin/bitcoin/pull/23174#discussion_r732182831). I get that this only temporarily impacts validation state of the background chainstate, but I don't think validation behavior should be nondeterministic and treat blocks differently based on what addresses malloc returns. Would suggest just doing height comparison directly so order of vSortedByHeight entries with the same height won't matter:\r\n\r\n\r\n```diff\r\ndiff --git a/src/validation.cpp b/src/validation.cpp\r\nindex 02b0f76f7b5..119b9141706 100644\r\n--- a/src/validation.cpp\r\n+++ b/src/validation.cpp\r\n@@ -3623,9 +3623,14 @@ bool BlockManager::LoadBlockIndex(\r\n     }\r\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\r\n \r\n-    // Have we yet seen a pindex->IsAssumedValid()? If so, account for the fact that all subsequent\r\n-    // index entries rely on assumed-valid ancestors.\r\n-    bool seen_assumed_valid{false};\r\n+    // Find start of assumed-valid region.\r\n+    int first_assumed_valid_height = std::numeric_limits<int>::max();\r\n+    for (const auto& [height, block] : vSortedByHeight) {\r\n+        if (block->IsAssumedValid()) {\r\n+            first_assumed_valid_height = height;\r\n+            break;\r\n+        }\r\n+    }\r\n \r\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\r\n     {\r\n@@ -3634,10 +3639,6 @@ bool BlockManager::LoadBlockIndex(\r\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\r\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\r\n \r\n-        if (!seen_assumed_valid && pindex->IsAssumedValid()) {\r\n-            seen_assumed_valid = true;\r\n-        }\r\n-\r\n         // We can link the chain of blocks for which we've received transactions at some point, or\r\n         // blocks that are assumed-valid on the basis of snapshot load (see\r\n         // PopulateAndValidateSnapshot()).\r\n@@ -3674,7 +3675,7 @@ bool BlockManager::LoadBlockIndex(\r\n             // happen because assumed-valid blocks are buried deeply in\r\n             // the valid chain.\r\n             for (CChainState* chainstate : chainman.GetAll()) {\r\n-                if (!seen_assumed_valid || chainstate->reliesOnAssumedValid()) {\r\n+                if (chainstate->reliesOnAssumedValid() || pindex->nHeight < first_assumed_valid_height) {\r\n                     chainstate->setBlockIndexCandidates.insert(pindex);\r\n                 }\r\n             }\r\n\r\n```\r\n",
    "created_at": "2021-11-10T20:36:54Z",
    "updated_at": "2021-11-10T21:36:39Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746966753",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746966753"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746966753"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746966753/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 3637,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 3638,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746975622",
    "pull_request_review_id": 803118052,
    "id": 746975622,
    "node_id": "PRRC_kwDOABII584shfGG",
    "diff_hunk": "@@ -3649,7 +3661,23 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+            // Fill each chainstate's block candidate set. Add all blocks as\n+            // candidates if the chainstate is allowed to rely on assumed-valid\n+            // blocks. Otherwise avoid adding assumed-valid blocks so the\n+            // chainstate will download and validate all earlier blocks.\n+            //\n+            // Note: given the loop over `vSortedByHeight` and the way\n+            // `seen_assumed_valid` works, it is (in general) possible that we\n+            // are considering a block which has a height higher than the\n+            // assumed-valid region but is not itself reliant on assumed-valid\n+            // ancestors (i.e. a very deep fork). In practice this will not\n+            // happen because assumed-valid blocks are buried deeply in\n+            // the valid chain.",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 57,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "2833bd0277ac87cd07e98b0a23b73eed97a2e513",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (2833bd0277ac87cd07e98b0a23b73eed97a2e513)\r\n\r\nI think this note is helpful but a little confusing:\r\n\r\n- It's vague where it refers to \"the way seen_assumed_valid works\" and what \" considering a block\"  means\r\n- It's unclear where the claim that this has to be a very deep fork comes from. IIUC, the fork just has to happen before the first assumed valid block height, and this could be anywhere in between the genesis block and the snapshot height. It could actually be very close to the snapshot height if the background chainstate is almost finished validating.\r\n- It isn't clear about why this behavior is safe. That last sentence \"In practice this will not happen\" seems to imply that this is safe just because the condition is unlikely to happen. But comment is ambiguous whether it is safe regardless. IIUC, it is safe regardless.\r\n\r\nMy attempt to describe this would be \"Note: This is considering all blocks whose height is greater or equal to the first assumed-valid block to be assumed-valid blocks, and excluding them from the background chainstate's setBlockIndexCandidates set. This does mean that some blocks which are not technically assumed-valid (later blocks on a fork beginning before the first assumed-valid block) might not get added to the the background chainstate, but this is ok, because they will still be attached to the active chainstate if they actually contain more work.\"",
    "created_at": "2021-11-10T20:50:47Z",
    "updated_at": "2021-11-10T21:36:39Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746975622",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746975622"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746975622"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746975622/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 3669,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 3675,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746977365",
    "pull_request_review_id": 803118052,
    "id": 746977365,
    "node_id": "PRRC_kwDOABII584shfhV",
    "diff_hunk": "@@ -3649,7 +3661,23 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+            // Fill each chainstate's block candidate set. Add all blocks as\n+            // candidates if the chainstate is allowed to rely on assumed-valid\n+            // blocks. Otherwise avoid adding assumed-valid blocks so the\n+            // chainstate will download and validate all earlier blocks.\n+            //\n+            // Note: given the loop over `vSortedByHeight` and the way\n+            // `seen_assumed_valid` works, it is (in general) possible that we\n+            // are considering a block which has a height higher than the\n+            // assumed-valid region but is not itself reliant on assumed-valid\n+            // ancestors (i.e. a very deep fork). In practice this will not\n+            // happen because assumed-valid blocks are buried deeply in\n+            // the valid chain.\n+            for (CChainState* chainstate : chainman.GetAll()) {\n+                if (!seen_assumed_valid || chainstate->reliesOnAssumedValid()) {",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 59,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "2833bd0277ac87cd07e98b0a23b73eed97a2e513",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (2833bd0277ac87cd07e98b0a23b73eed97a2e513)\r\n\r\nI'd maybe swap these conditions and write this as `if (chainstate->reliesOnAssumedValid() || !seen_assumed_valid)` to match the description above \"Add all blocks as candidates if the chainstate is allowed to rely on assumed-valid blocks. Otherwise avoid adding assumed-valid blocks\"\r\n",
    "created_at": "2021-11-10T20:53:41Z",
    "updated_at": "2021-11-10T21:36:39Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746977365",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746977365"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746977365"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746977365/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3677,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746999259",
    "pull_request_review_id": 803118052,
    "id": 746999259,
    "node_id": "PRRC_kwDOABII584shk3b",
    "diff_hunk": "@@ -3649,7 +3661,23 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+            // Fill each chainstate's block candidate set. Add all blocks as\n+            // candidates if the chainstate is allowed to rely on assumed-valid\n+            // blocks. Otherwise avoid adding assumed-valid blocks so the\n+            // chainstate will download and validate all earlier blocks.\n+            //\n+            // Note: given the loop over `vSortedByHeight` and the way\n+            // `seen_assumed_valid` works, it is (in general) possible that we\n+            // are considering a block which has a height higher than the\n+            // assumed-valid region but is not itself reliant on assumed-valid\n+            // ancestors (i.e. a very deep fork). In practice this will not\n+            // happen because assumed-valid blocks are buried deeply in\n+            // the valid chain.\n+            for (CChainState* chainstate : chainman.GetAll()) {\n+                if (!seen_assumed_valid || chainstate->reliesOnAssumedValid()) {\n+                    chainstate->setBlockIndexCandidates.insert(pindex);",
    "path": "src/validation.cpp",
    "position": 77,
    "original_position": 60,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "2833bd0277ac87cd07e98b0a23b73eed97a2e513",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"validation: have LoadBlockIndex account for snapshot use\" (2833bd0277ac87cd07e98b0a23b73eed97a2e513)\r\n\r\nI still think it would be really nice to call this function from a unit test and make sure this set is filled correctly. The logic here is fragile, and testing this part of `LoadBlockIndex` could make it easier to test other parts as well.\r\n\r\nEDIT: Sorry, I see you mentioned working on this in https://github.com/bitcoin/bitcoin/pull/23174#issuecomment-964561176",
    "created_at": "2021-11-10T21:29:07Z",
    "updated_at": "2021-11-10T21:37:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746999259",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746999259"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r746999259"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/746999259/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3695,
    "original_line": 3695,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747012968",
    "pull_request_review_id": 803181569,
    "id": 747012968,
    "node_id": "PRRC_kwDOABII584shoNo",
    "diff_hunk": "@@ -3622,17 +3622,29 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // Have we yet seen a pindex->IsAssumedValid()? If so, account for the fact that all subsequent\n+    // index entries rely on assumed-valid ancestors.\n+    bool seen_assumed_valid{false};\n+\n     for (const std::pair<int, CBlockIndex*>& item : vSortedByHeight)\n     {\n         if (ShutdownRequested()) return false;\n         CBlockIndex* pindex = item.second;\n         pindex->nChainWork = (pindex->pprev ? pindex->pprev->nChainWork : 0) + GetBlockProof(*pindex);\n         pindex->nTimeMax = (pindex->pprev ? std::max(pindex->pprev->nTimeMax, pindex->nTime) : pindex->nTime);\n-        // We can link the chain of blocks for which we've received transactions at some point.\n+\n+        if (!seen_assumed_valid && pindex->IsAssumedValid()) {\n+            seen_assumed_valid = true;",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 27,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "2833bd0277ac87cd07e98b0a23b73eed97a2e513",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Great suggestions, all integrated. Thank you!",
    "created_at": "2021-11-10T21:50:11Z",
    "updated_at": "2021-11-10T21:50:11Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r747012968",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747012968"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r747012968"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/747012968/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 3637,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 3638,
    "side": "RIGHT",
    "in_reply_to_id": 746966753
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748440394",
    "pull_request_review_id": 805023614,
    "id": 748440394,
    "node_id": "PRRC_kwDOABII584snEtK",
    "diff_hunk": "@@ -312,4 +312,81 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, TestChain100Setup)\n         loaded_snapshot_blockhash);\n }\n \n+//! Test LoadBlockIndex behavior when multiple chainstates are in use.\n+//!\n+//! - First, verfiy that setBlockIndexCandidates is as expected when using a single,\n+//!   fully-validating chainstate.\n+//!\n+//! - Then mark a region of the chain BLOCK_ASSUMED_VALID and introduce a second chainstate\n+//!   that will tolerate assumed-valid blocks. Run LoadBlockIndex() and ensure that the first\n+//!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n+//!   even those assumed-valid.\n+//!\n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n+{\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    CTxMemPool& mempool = *m_node.mempool;\n+    CChainState& cs1 = chainman.ActiveChainstate();\n+\n+    int num_indexes{0};\n+    int num_assumed_valid{0};\n+    int expected_assumed_valid{20};\n+    int last_assumed_valid_idx{40};\n+    int assumed_valid_start_idx = last_assumed_valid_idx - expected_assumed_valid;",
    "path": "src/test/validation_chainstatemanager_tests.cpp",
    "position": null,
    "original_position": 24,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e35d167682bc527fa9d8734f1cc7558f18d95b09",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"test: add tests for LoadBlockIndex when using multiple chainstates\" (e35d167682bc527fa9d8734f1cc7558f18d95b09)\r\n\r\nDeclaring these const could make the test a little easier to grok",
    "created_at": "2021-11-12T16:52:41Z",
    "updated_at": "2021-11-12T17:02:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r748440394",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748440394"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r748440394"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748440394/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 331,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 335,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748441135",
    "pull_request_review_id": 805023614,
    "id": 748441135,
    "node_id": "PRRC_kwDOABII584snE4v",
    "diff_hunk": "@@ -312,4 +312,81 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, TestChain100Setup)\n         loaded_snapshot_blockhash);\n }\n \n+//! Test LoadBlockIndex behavior when multiple chainstates are in use.\n+//!\n+//! - First, verfiy that setBlockIndexCandidates is as expected when using a single,\n+//!   fully-validating chainstate.\n+//!\n+//! - Then mark a region of the chain BLOCK_ASSUMED_VALID and introduce a second chainstate\n+//!   that will tolerate assumed-valid blocks. Run LoadBlockIndex() and ensure that the first\n+//!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n+//!   even those assumed-valid.\n+//!\n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n+{\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    CTxMemPool& mempool = *m_node.mempool;\n+    CChainState& cs1 = chainman.ActiveChainstate();\n+\n+    int num_indexes{0};\n+    int num_assumed_valid{0};\n+    int expected_assumed_valid{20};\n+    int last_assumed_valid_idx{40};\n+    int assumed_valid_start_idx = last_assumed_valid_idx - expected_assumed_valid;\n+\n+    CBlockIndex* validated_tip{nullptr};\n+    CBlockIndex* assumed_tip{chainman.ActiveChain().Tip()};\n+\n+    auto reload_all_block_indexes = [&]() {\n+        for (CChainState* cs : chainman.GetAll()) {\n+            LOCK(::cs_main);\n+            cs->UnloadBlockIndex();\n+            BOOST_CHECK(cs->setBlockIndexCandidates.empty());\n+        }\n+\n+        WITH_LOCK(::cs_main, chainman.LoadBlockIndex());\n+    };\n+\n+    // Ensure that without any assumed-valid BlockIndex entries, all entries are considered\n+    // tip candidates.\n+    reload_all_block_indexes();\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);\n+\n+    // Mark some region of the chain assumed-valid.\n+    for (int i = 0; i <= cs1.m_chain.Height(); ++i) {\n+        auto index = cs1.m_chain[i];\n+\n+        if (i < last_assumed_valid_idx && i >= (last_assumed_valid_idx - expected_assumed_valid)) {",
    "path": "src/test/validation_chainstatemanager_tests.cpp",
    "position": null,
    "original_position": 48,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e35d167682bc527fa9d8734f1cc7558f18d95b09",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "In commit \"test: add tests for LoadBlockIndex when using multiple chainstates\" (e35d167682bc527fa9d8734f1cc7558f18d95b09)\r\n\r\nCould simplify `last_assumed_valid_idx - expected_assumed_valid` as `assumed_valid_start_idx`",
    "created_at": "2021-11-12T16:53:49Z",
    "updated_at": "2021-11-12T17:02:01Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r748441135",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748441135"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r748441135"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748441135/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 359,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748949388",
    "pull_request_review_id": 805559521,
    "id": 748949388,
    "node_id": "PRRC_kwDOABII584spA-M",
    "diff_hunk": "@@ -309,4 +312,81 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, TestChain100Setup)\n         loaded_snapshot_blockhash);\n }\n \n+//! Test LoadBlockIndex behavior when multiple chainstates are in use.\n+//!\n+//! - First, verfiy that setBlockIndexCandidates is as expected when using a single,\n+//!   fully-validating chainstate.\n+//!\n+//! - Then mark a region of the chain BLOCK_ASSUMED_VALID and introduce a second chainstate\n+//!   that will tolerate assumed-valid blocks. Run LoadBlockIndex() and ensure that the first\n+//!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n+//!   even those assumed-valid.\n+//!\n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n+{\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    CTxMemPool& mempool = *m_node.mempool;\n+    CChainState& cs1 = chainman.ActiveChainstate();\n+\n+    int num_indexes{0};\n+    int num_assumed_valid{0};\n+    int expected_assumed_valid{20};\n+    int last_assumed_valid_idx{40};\n+    int assumed_valid_start_idx = last_assumed_valid_idx - expected_assumed_valid;\n+\n+    CBlockIndex* validated_tip{nullptr};\n+    CBlockIndex* assumed_tip{chainman.ActiveChain().Tip()};\n+\n+    auto reload_all_block_indexes = [&]() {\n+        for (CChainState* cs : chainman.GetAll()) {\n+            LOCK(::cs_main);\n+            cs->UnloadBlockIndex();\n+            BOOST_CHECK(cs->setBlockIndexCandidates.empty());\n+        }\n+\n+        WITH_LOCK(::cs_main, chainman.LoadBlockIndex());\n+    };\n+\n+    // Ensure that without any assumed-valid BlockIndex entries, all entries are considered\n+    // tip candidates.\n+    reload_all_block_indexes();\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);\n+\n+    // Mark some region of the chain assumed-valid.\n+    for (int i = 0; i <= cs1.m_chain.Height(); ++i) {\n+        auto index = cs1.m_chain[i];\n+\n+        if (i < last_assumed_valid_idx && i >= (last_assumed_valid_idx - expected_assumed_valid)) {\n+            index->nStatus = BlockStatus::BLOCK_VALID_TREE | BlockStatus::BLOCK_ASSUMED_VALID;\n+        }\n+\n+        ++num_indexes;\n+        if (index->IsAssumedValid()) ++num_assumed_valid;\n+\n+        // Note the last fully-validated block as the expected validated tip.\n+        if (i == (assumed_valid_start_idx - 1)) {\n+            validated_tip = index;\n+            BOOST_CHECK(!index->IsAssumedValid());\n+        }\n+    }\n+\n+    BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\n+\n+    CChainState& cs2 = WITH_LOCK(::cs_main,\n+        return chainman.InitializeChainstate(&mempool, GetRandHash()));\n+\n+    reload_all_block_indexes();\n+\n+    // The fully validated chain only has candidates up to the start of the assumed-valid\n+    // blocks.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+\n+    // The assumed-valid tolerant chain has all blocks as candidates.\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_tip), 1);\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.size(), num_indexes);",
    "path": "src/test/validation_chainstatemanager_tests.cpp",
    "position": 88,
    "original_position": 88,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e35d167682bc527fa9d8734f1cc7558f18d95b09",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "IIUC any fully validated block beyond the assumed-valid range of blocks shouldn't not be tolerated by the \"fully-validated\" chain, as they're relying on assumed-valid blocks ?\r\n\r\nIf so can you add a `BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(m_chain.Height()), 0)` to verify this expected behavior holds ?",
    "created_at": "2021-11-15T01:15:48Z",
    "updated_at": "2021-11-15T01:24:05Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r748949388",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748949388"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r748949388"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748949388/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 389,
    "original_line": 389,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748949660",
    "pull_request_review_id": 805559521,
    "id": 748949660,
    "node_id": "PRRC_kwDOABII584spBCc",
    "diff_hunk": "@@ -3622,17 +3622,30 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // Find start of assumed-valid region.\n+    int first_assumed_valid_height = std::numeric_limits<int>::max();\n+    for (const auto& [height, block] : vSortedByHeight) {\n+        if (block->IsAssumedValid()) {\n+            first_assumed_valid_height = height;",
    "path": "src/validation.cpp",
    "position": 29,
    "original_position": 18,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e35d167682bc527fa9d8734f1cc7558f18d95b09",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "nit: Maybe add a `assert(IsSnapshotActive()` as we shouldn't have assumed-valid blocks in the absence of a snapshot loaded ?",
    "created_at": "2021-11-15T01:17:19Z",
    "updated_at": "2021-11-15T01:24:05Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r748949660",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748949660"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r748949660"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748949660/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3641,
    "original_line": 3641,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748950124",
    "pull_request_review_id": 805559521,
    "id": 748950124,
    "node_id": "PRRC_kwDOABII584spBJs",
    "diff_hunk": "@@ -3649,7 +3662,28 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+\n+            // Fill each chainstate's block candidate set. Add all blocks as\n+            // candidates if the chainstate is allowed to rely on assumed-valid\n+            // blocks. Otherwise avoid adding assumed-valid blocks so the\n+            // chainstate will download and validate all earlier blocks.",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 51,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e35d167682bc527fa9d8734f1cc7558f18d95b09",
    "user": {
      "login": "ariard",
      "id": 23310655,
      "node_id": "MDQ6VXNlcjIzMzEwNjU1",
      "avatar_url": "https://avatars.githubusercontent.com/u/23310655?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ariard",
      "html_url": "https://github.com/ariard",
      "followers_url": "https://api.github.com/users/ariard/followers",
      "following_url": "https://api.github.com/users/ariard/following{/other_user}",
      "gists_url": "https://api.github.com/users/ariard/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ariard/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ariard/subscriptions",
      "organizations_url": "https://api.github.com/users/ariard/orgs",
      "repos_url": "https://api.github.com/users/ariard/repos",
      "events_url": "https://api.github.com/users/ariard/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ariard/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I think the comment can be slightly modified to mention the descendants of assumed-valid blocks, like in the commit description.\r\n\r\n\"Otherwise avoid adding assumed-valid blocks and their fully-validated descendants therefore inducing the chainstate to download and validate all blocks earlier than the first assumed-valid block\".",
    "created_at": "2021-11-15T01:19:43Z",
    "updated_at": "2021-11-15T01:24:05Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r748950124",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748950124"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r748950124"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/748950124/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3669,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/750592969",
    "pull_request_review_id": 807741510,
    "id": 750592969,
    "node_id": "PRRC_kwDOABII584svSPJ",
    "diff_hunk": "@@ -309,4 +312,81 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, TestChain100Setup)\n         loaded_snapshot_blockhash);\n }\n \n+//! Test LoadBlockIndex behavior when multiple chainstates are in use.\n+//!\n+//! - First, verfiy that setBlockIndexCandidates is as expected when using a single,\n+//!   fully-validating chainstate.\n+//!\n+//! - Then mark a region of the chain BLOCK_ASSUMED_VALID and introduce a second chainstate\n+//!   that will tolerate assumed-valid blocks. Run LoadBlockIndex() and ensure that the first\n+//!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n+//!   even those assumed-valid.\n+//!\n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n+{\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    CTxMemPool& mempool = *m_node.mempool;\n+    CChainState& cs1 = chainman.ActiveChainstate();\n+\n+    int num_indexes{0};\n+    int num_assumed_valid{0};\n+    int expected_assumed_valid{20};\n+    int last_assumed_valid_idx{40};\n+    int assumed_valid_start_idx = last_assumed_valid_idx - expected_assumed_valid;\n+\n+    CBlockIndex* validated_tip{nullptr};\n+    CBlockIndex* assumed_tip{chainman.ActiveChain().Tip()};\n+\n+    auto reload_all_block_indexes = [&]() {\n+        for (CChainState* cs : chainman.GetAll()) {\n+            LOCK(::cs_main);\n+            cs->UnloadBlockIndex();\n+            BOOST_CHECK(cs->setBlockIndexCandidates.empty());\n+        }\n+\n+        WITH_LOCK(::cs_main, chainman.LoadBlockIndex());\n+    };\n+\n+    // Ensure that without any assumed-valid BlockIndex entries, all entries are considered\n+    // tip candidates.\n+    reload_all_block_indexes();\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), cs1.m_chain.Height() + 1);\n+\n+    // Mark some region of the chain assumed-valid.\n+    for (int i = 0; i <= cs1.m_chain.Height(); ++i) {\n+        auto index = cs1.m_chain[i];\n+\n+        if (i < last_assumed_valid_idx && i >= (last_assumed_valid_idx - expected_assumed_valid)) {\n+            index->nStatus = BlockStatus::BLOCK_VALID_TREE | BlockStatus::BLOCK_ASSUMED_VALID;\n+        }\n+\n+        ++num_indexes;\n+        if (index->IsAssumedValid()) ++num_assumed_valid;\n+\n+        // Note the last fully-validated block as the expected validated tip.\n+        if (i == (assumed_valid_start_idx - 1)) {\n+            validated_tip = index;\n+            BOOST_CHECK(!index->IsAssumedValid());\n+        }\n+    }\n+\n+    BOOST_CHECK_EQUAL(expected_assumed_valid, num_assumed_valid);\n+\n+    CChainState& cs2 = WITH_LOCK(::cs_main,\n+        return chainman.InitializeChainstate(&mempool, GetRandHash()));\n+\n+    reload_all_block_indexes();\n+\n+    // The fully validated chain only has candidates up to the start of the assumed-valid\n+    // blocks.\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(validated_tip), 1);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);\n+    BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.size(), assumed_valid_start_idx);\n+\n+    // The assumed-valid tolerant chain has all blocks as candidates.\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(validated_tip), 1);\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.count(assumed_tip), 1);\n+    BOOST_CHECK_EQUAL(cs2.setBlockIndexCandidates.size(), num_indexes);",
    "path": "src/test/validation_chainstatemanager_tests.cpp",
    "position": 88,
    "original_position": 88,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e35d167682bc527fa9d8734f1cc7558f18d95b09",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Did you mean `cs1.setBlockIndexCandidates.count(m_chain.Height())`? Because the set doesn't contain heights, it contains CBlockIndex*. Also which `m_chain` are you referring to? Because there's one for `c1` and `c2`. \r\n\r\nI think the check you want is already included in `BOOST_CHECK_EQUAL(cs1.setBlockIndexCandidates.count(assumed_tip), 0);`.",
    "created_at": "2021-11-16T19:25:24Z",
    "updated_at": "2021-11-16T19:25:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r750592969",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/750592969"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r750592969"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/750592969/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 389,
    "original_line": 389,
    "side": "RIGHT",
    "in_reply_to_id": 748949388
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/750594454",
    "pull_request_review_id": 807743475,
    "id": 750594454,
    "node_id": "PRRC_kwDOABII584svSmW",
    "diff_hunk": "@@ -3622,17 +3622,30 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // Find start of assumed-valid region.\n+    int first_assumed_valid_height = std::numeric_limits<int>::max();\n+    for (const auto& [height, block] : vSortedByHeight) {\n+        if (block->IsAssumedValid()) {\n+            first_assumed_valid_height = height;",
    "path": "src/validation.cpp",
    "position": 29,
    "original_position": 18,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e35d167682bc527fa9d8734f1cc7558f18d95b09",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Part of @ryanofsky's overarching (and good) feedback a few months earlier was to avoid leaking knowledge of the idea of \"UTXO snapshots\" in places where it doesn't need to be. Instead we should rely on more fundamental state (like the presence of assumed-valid block index entries). I think referencing snapshots here would be going the other direction.",
    "created_at": "2021-11-16T19:27:24Z",
    "updated_at": "2021-11-16T19:27:24Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r750594454",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/750594454"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r750594454"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/750594454/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3641,
    "original_line": 3641,
    "side": "RIGHT",
    "in_reply_to_id": 748949660
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/750633848",
    "pull_request_review_id": 807797246,
    "id": 750633848,
    "node_id": "PRRC_kwDOABII584svcN4",
    "diff_hunk": "@@ -3649,7 +3662,28 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+\n+            // Fill each chainstate's block candidate set. Add all blocks as\n+            // candidates if the chainstate is allowed to rely on assumed-valid\n+            // blocks. Otherwise avoid adding assumed-valid blocks so the\n+            // chainstate will download and validate all earlier blocks.",
    "path": "src/validation.cpp",
    "position": null,
    "original_position": 51,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e35d167682bc527fa9d8734f1cc7558f18d95b09",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Not sure I follow your suggested comment, since fully-validated blocks should be added to both chainstates, but I've updated the comment to be try and be clearer.",
    "created_at": "2021-11-16T20:23:51Z",
    "updated_at": "2021-11-16T20:23:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r750633848",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/750633848"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r750633848"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/750633848/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 3669,
    "side": "RIGHT",
    "in_reply_to_id": 748950124
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/750865419",
    "pull_request_review_id": 808091891,
    "id": 750865419,
    "node_id": "PRRC_kwDOABII584swUwL",
    "diff_hunk": "@@ -3622,17 +3622,30 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // Find start of assumed-valid region.\n+    int first_assumed_valid_height = std::numeric_limits<int>::max();\n+    for (const auto& [height, block] : vSortedByHeight) {\n+        if (block->IsAssumedValid()) {\n+            first_assumed_valid_height = height;",
    "path": "src/validation.cpp",
    "position": 29,
    "original_position": 18,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e35d167682bc527fa9d8734f1cc7558f18d95b09",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "re: https://github.com/bitcoin/bitcoin/pull/23174#discussion_r748949660\r\n\r\n> nit: Maybe add a `assert(IsSnapshotActive()` as we shouldn't have assumed-valid blocks in the absence of a snapshot loaded ?\r\n\r\nI guess like James said I'd be a little disinclined to add an assert checking for assumeutxo snapshots in validation code that's dealing more abstractly with chainstates. But I could also see the assert being useful as a sanity check, so no strong opinion either way.\r\n\r\nAnother option would be to write the assert a more generically with something like:\r\n\r\n```c++\r\n\r\n// assert that the assumed valid blocks come from some assumed-valid chainstate.\r\nassert(any_of(chainstates, [](auto& chainstate) { return chainstate->reliesOnAssumedValid(); });\r\n\r\n// assert that the assumed valid blocks will be validated by some not assumed-valid chainstate\r\nassert(any_of(chainstates, [](auto& chainstate) { return !chainstate->reliesOnAssumedValid(); });\r\n```",
    "created_at": "2021-11-17T04:03:02Z",
    "updated_at": "2021-11-17T04:06:17Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r750865419",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/750865419"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r750865419"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/750865419/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3641,
    "original_line": 3641,
    "side": "RIGHT",
    "in_reply_to_id": 748949660
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752672520",
    "pull_request_review_id": 810519220,
    "id": 752672520,
    "node_id": "PRRC_kwDOABII584s3N8I",
    "diff_hunk": "@@ -312,4 +312,81 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, TestChain100Setup)\n         loaded_snapshot_blockhash);\n }\n \n+//! Test LoadBlockIndex behavior when multiple chainstates are in use.\n+//!\n+//! - First, verfiy that setBlockIndexCandidates is as expected when using a single,\n+//!   fully-validating chainstate.\n+//!\n+//! - Then mark a region of the chain BLOCK_ASSUMED_VALID and introduce a second chainstate\n+//!   that will tolerate assumed-valid blocks. Run LoadBlockIndex() and ensure that the first\n+//!   chainstate only contains fully validated blocks and the other chainstate contains all blocks,\n+//!   even those assumed-valid.\n+//!\n+BOOST_FIXTURE_TEST_CASE(chainstatemanager_loadblockindex, TestChain100Setup)\n+{\n+    ChainstateManager& chainman = *Assert(m_node.chainman);\n+    CTxMemPool& mempool = *m_node.mempool;\n+    CChainState& cs1 = chainman.ActiveChainstate();\n+\n+    int num_indexes{0};\n+    int num_assumed_valid{0};\n+    int expected_assumed_valid{20};\n+    int last_assumed_valid_idx{40};\n+    int assumed_valid_start_idx = last_assumed_valid_idx - expected_assumed_valid;",
    "path": "src/test/validation_chainstatemanager_tests.cpp",
    "position": null,
    "original_position": 24,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e35d167682bc527fa9d8734f1cc7558f18d95b09",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Fixed, thanks",
    "created_at": "2021-11-18T22:26:17Z",
    "updated_at": "2021-11-18T22:26:17Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r752672520",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752672520"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r752672520"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/752672520/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": 331,
    "start_side": "RIGHT",
    "line": null,
    "original_line": 335,
    "side": "RIGHT",
    "in_reply_to_id": 748440394
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753429531",
    "pull_request_review_id": 811541105,
    "id": 753429531,
    "node_id": "PRRC_kwDOABII584s6Gwb",
    "diff_hunk": "@@ -3622,17 +3622,30 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // Find start of assumed-valid region.\n+    int first_assumed_valid_height = std::numeric_limits<int>::max();\n+    for (const auto& [height, block] : vSortedByHeight) {\n+        if (block->IsAssumedValid()) {\n+            first_assumed_valid_height = height;",
    "path": "src/validation.cpp",
    "position": 29,
    "original_position": 18,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e35d167682bc527fa9d8734f1cc7558f18d95b09",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Good idea! Added.",
    "created_at": "2021-11-19T18:34:30Z",
    "updated_at": "2021-11-19T18:34:31Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r753429531",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753429531"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r753429531"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/753429531/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3641,
    "original_line": 3641,
    "side": "RIGHT",
    "in_reply_to_id": 748949660
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757915350",
    "pull_request_review_id": 817231643,
    "id": 757915350,
    "node_id": "PRRC_kwDOABII584tLN7W",
    "diff_hunk": "@@ -3622,17 +3622,41 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // Find start of assumed-valid region.\n+    int first_assumed_valid_height = std::numeric_limits<int>::max();\n+\n+    for (const auto& [height, block] : vSortedByHeight) {\n+        if (block->IsAssumedValid()) {\n+            auto chainstates = chainman.GetAll();\n+\n+            // assert that the assumed valid blocks come from some assumed-valid chainstate.\n+            assert(any_of(chainstates.cbegin(), chainstates.cend(),\n+                [](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));",
    "path": "src/validation.cpp",
    "position": 23,
    "original_position": 23,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e19253f2fd17b01e52950b9e78fcd10251e6e8c0",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Hm, this feels a bit backwards to me. Couldn't we skip the whole loop if we first check that one of the chainstates relies on assume-valid?",
    "created_at": "2021-11-28T15:49:23Z",
    "updated_at": "2021-11-28T17:04:14Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r757915350",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757915350"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r757915350"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757915350/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3635,
    "original_line": 3635,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757922484",
    "pull_request_review_id": 817231643,
    "id": 757922484,
    "node_id": "PRRC_kwDOABII584tLPq0",
    "diff_hunk": "@@ -184,6 +184,9 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, TestChain100Setup)\n     BOOST_CHECK(!chainman.ActiveChainstate().m_from_snapshot_blockhash);\n     BOOST_CHECK(!chainman.SnapshotBlockhash());\n \n+    // Ensure that the genesis block was not marked assumed-valid.\n+    BOOST_CHECK(!chainman.ActiveChain().Genesis()->IsAssumedValid());",
    "path": "src/test/validation_chainstatemanager_tests.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "86d48535198724c723370a447f73e134029331c2",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Is this in the right place here? When I set `AFTER_GENESIS_START` to 0 this still doesn't fail for me.",
    "created_at": "2021-11-28T16:47:06Z",
    "updated_at": "2021-11-28T17:04:14Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r757922484",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757922484"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r757922484"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/757922484/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 188,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758160127",
    "pull_request_review_id": 817521177,
    "id": 758160127,
    "node_id": "PRRC_kwDOABII584tMJr_",
    "diff_hunk": "@@ -4909,7 +4952,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     // Fake various pieces of CBlockIndex state:\n     CBlockIndex* index = nullptr;\n-    for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n+\n+    // Don't make any modifications to the genesis block.\n+    // This is especially important because we don't want to erroneously\n+    // apply BLOCK_ASSUMED_VALID to genesis, which would happen if we didn't skip\n+    // it here (since it apparently isn't BLOCK_VALID_SCRIPTS).",
    "path": "src/validation.cpp",
    "position": 115,
    "original_position": 115,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "7a576ba9d24308e36dcde2b48b34c0676de98daa",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I don't understand this comment. If genesis isn't `BLOCK_VALID_SCRIPTS`, then `BLOCK_ASSUMED_VALID` wouldn't be applied, so the workaround isn't needed??",
    "created_at": "2021-11-29T09:12:16Z",
    "updated_at": "2021-11-29T09:18:14Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r758160127",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758160127"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r758160127"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758160127/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 4959,
    "original_line": 4959,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758505693",
    "pull_request_review_id": 817997457,
    "id": 758505693,
    "node_id": "PRRC_kwDOABII584tNeDd",
    "diff_hunk": "@@ -184,6 +184,9 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, TestChain100Setup)\n     BOOST_CHECK(!chainman.ActiveChainstate().m_from_snapshot_blockhash);\n     BOOST_CHECK(!chainman.SnapshotBlockhash());\n \n+    // Ensure that the genesis block was not marked assumed-valid.\n+    BOOST_CHECK(!chainman.ActiveChain().Genesis()->IsAssumedValid());",
    "path": "src/test/validation_chainstatemanager_tests.cpp",
    "position": null,
    "original_position": 5,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "86d48535198724c723370a447f73e134029331c2",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Oh yep, you're very right - we haven't actually yet activated the snapshot at this point in the test. Good find, thanks.",
    "created_at": "2021-11-29T16:01:54Z",
    "updated_at": "2021-11-29T16:01:54Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r758505693",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758505693"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r758505693"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758505693/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": null,
    "original_line": 188,
    "side": "RIGHT",
    "in_reply_to_id": 757922484
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758506598",
    "pull_request_review_id": 817998710,
    "id": 758506598,
    "node_id": "PRRC_kwDOABII584tNeRm",
    "diff_hunk": "@@ -4909,7 +4952,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     // Fake various pieces of CBlockIndex state:\n     CBlockIndex* index = nullptr;\n-    for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n+\n+    // Don't make any modifications to the genesis block.\n+    // This is especially important because we don't want to erroneously\n+    // apply BLOCK_ASSUMED_VALID to genesis, which would happen if we didn't skip\n+    // it here (since it apparently isn't BLOCK_VALID_SCRIPTS).",
    "path": "src/validation.cpp",
    "position": 115,
    "original_position": 115,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "7a576ba9d24308e36dcde2b48b34c0676de98daa",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "No, *because* genesis isn't `BLOCK_VALID_SCRIPTS` we would apply `BLOCK_ASSUMED_VALID` unless we specifically skip it. The workaround is still desirable and necessary, I just bungled the unittest (see above).",
    "created_at": "2021-11-29T16:02:52Z",
    "updated_at": "2021-11-29T16:02:53Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r758506598",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758506598"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r758506598"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758506598/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 4959,
    "original_line": 4959,
    "side": "RIGHT",
    "in_reply_to_id": 758160127
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758517157",
    "pull_request_review_id": 818012842,
    "id": 758517157,
    "node_id": "PRRC_kwDOABII584tNg2l",
    "diff_hunk": "@@ -4909,7 +4952,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     // Fake various pieces of CBlockIndex state:\n     CBlockIndex* index = nullptr;\n-    for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n+\n+    // Don't make any modifications to the genesis block.\n+    // This is especially important because we don't want to erroneously\n+    // apply BLOCK_ASSUMED_VALID to genesis, which would happen if we didn't skip\n+    // it here (since it apparently isn't BLOCK_VALID_SCRIPTS).",
    "path": "src/validation.cpp",
    "position": 115,
    "original_position": 115,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "7a576ba9d24308e36dcde2b48b34c0676de98daa",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Yes, and the code below is:\r\n\r\n```cpp\r\n        if (!index->IsValid(BLOCK_VALID_SCRIPTS)) {\r\n            // This flag will be removed once the block is fully validated by a\r\n            // background chainstate.\r\n            index->nStatus |= BLOCK_ASSUMED_VALID;\r\n        }\r\n```\r\n\r\nSo how could it be executed if `BLOCK_VALID_SCRIPTS` isn't set?",
    "created_at": "2021-11-29T16:13:46Z",
    "updated_at": "2021-11-29T16:13:46Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r758517157",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758517157"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r758517157"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758517157/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 4959,
    "original_line": 4959,
    "side": "RIGHT",
    "in_reply_to_id": 758160127
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758527196",
    "pull_request_review_id": 818026373,
    "id": 758527196,
    "node_id": "PRRC_kwDOABII584tNjTc",
    "diff_hunk": "@@ -3622,17 +3622,41 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // Find start of assumed-valid region.\n+    int first_assumed_valid_height = std::numeric_limits<int>::max();\n+\n+    for (const auto& [height, block] : vSortedByHeight) {\n+        if (block->IsAssumedValid()) {\n+            auto chainstates = chainman.GetAll();\n+\n+            // assert that the assumed valid blocks come from some assumed-valid chainstate.\n+            assert(any_of(chainstates.cbegin(), chainstates.cend(),\n+                [](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));",
    "path": "src/validation.cpp",
    "position": 23,
    "original_position": 23,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e19253f2fd17b01e52950b9e78fcd10251e6e8c0",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "I don't understand your comment: these two asserts are only performed once if there is an assumed-valid block detected, and then the loop is broken out of (line 3642). We don't want to do the asserts if there is no assumed-valid block, so I don't see how or why we'd do them outside of the loop.",
    "created_at": "2021-11-29T16:24:21Z",
    "updated_at": "2021-11-29T16:24:21Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r758527196",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758527196"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r758527196"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758527196/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3635,
    "original_line": 3635,
    "side": "RIGHT",
    "in_reply_to_id": 757915350
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758556179",
    "pull_request_review_id": 818065014,
    "id": 758556179,
    "node_id": "PRRC_kwDOABII584tNqYT",
    "diff_hunk": "@@ -4909,7 +4952,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     // Fake various pieces of CBlockIndex state:\n     CBlockIndex* index = nullptr;\n-    for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n+\n+    // Don't make any modifications to the genesis block.\n+    // This is especially important because we don't want to erroneously\n+    // apply BLOCK_ASSUMED_VALID to genesis, which would happen if we didn't skip\n+    // it here (since it apparently isn't BLOCK_VALID_SCRIPTS).",
    "path": "src/validation.cpp",
    "position": 115,
    "original_position": 115,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "7a576ba9d24308e36dcde2b48b34c0676de98daa",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "It is only executed when `BLOCK_VALID_SCRIPTS` *isn't* set - are you by chance missing the `!` in the conditional?\r\nEdit: changed an \"is\" to \"isn't\" - the double negative got me!",
    "created_at": "2021-11-29T16:55:30Z",
    "updated_at": "2021-11-29T17:15:52Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r758556179",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758556179"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r758556179"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/758556179/reactions",
      "total_count": 1,
      "+1": 1,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 4959,
    "original_line": 4959,
    "side": "RIGHT",
    "in_reply_to_id": 758160127
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759226449",
    "pull_request_review_id": 818955219,
    "id": 759226449,
    "node_id": "PRRC_kwDOABII584tQOBR",
    "diff_hunk": "@@ -4909,7 +4952,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     // Fake various pieces of CBlockIndex state:\n     CBlockIndex* index = nullptr;\n-    for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n+\n+    // Don't make any modifications to the genesis block.\n+    // This is especially important because we don't want to erroneously\n+    // apply BLOCK_ASSUMED_VALID to genesis, which would happen if we didn't skip\n+    // it here (since it apparently isn't BLOCK_VALID_SCRIPTS).",
    "path": "src/validation.cpp",
    "position": 115,
    "original_position": 115,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "7a576ba9d24308e36dcde2b48b34c0676de98daa",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Nvm, apparently I don't understand how negation works.",
    "created_at": "2021-11-30T12:24:13Z",
    "updated_at": "2021-11-30T12:24:14Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759226449",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759226449"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759226449"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759226449/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 4959,
    "original_line": 4959,
    "side": "RIGHT",
    "in_reply_to_id": 758160127
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759363877",
    "pull_request_review_id": 819148005,
    "id": 759363877,
    "node_id": "PRRC_kwDOABII584tQvkl",
    "diff_hunk": "@@ -4909,7 +4952,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     // Fake various pieces of CBlockIndex state:\n     CBlockIndex* index = nullptr;\n-    for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n+\n+    // Don't make any modifications to the genesis block.\n+    // This is especially important because we don't want to erroneously\n+    // apply BLOCK_ASSUMED_VALID to genesis, which would happen if we didn't skip\n+    // it here (since it apparently isn't BLOCK_VALID_SCRIPTS).",
    "path": "src/validation.cpp",
    "position": 115,
    "original_position": 115,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "7a576ba9d24308e36dcde2b48b34c0676de98daa",
    "user": {
      "login": "jamesob",
      "id": 73197,
      "node_id": "MDQ6VXNlcjczMTk3",
      "avatar_url": "https://avatars.githubusercontent.com/u/73197?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jamesob",
      "html_url": "https://github.com/jamesob",
      "followers_url": "https://api.github.com/users/jamesob/followers",
      "following_url": "https://api.github.com/users/jamesob/following{/other_user}",
      "gists_url": "https://api.github.com/users/jamesob/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jamesob/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jamesob/subscriptions",
      "organizations_url": "https://api.github.com/users/jamesob/orgs",
      "repos_url": "https://api.github.com/users/jamesob/repos",
      "events_url": "https://api.github.com/users/jamesob/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jamesob/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "This is an argument for including Python's `not` operator in C++21. ;)",
    "created_at": "2021-11-30T14:59:51Z",
    "updated_at": "2021-11-30T14:59:51Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759363877",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759363877"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759363877"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759363877/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 4959,
    "original_line": 4959,
    "side": "RIGHT",
    "in_reply_to_id": 758160127
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759468928",
    "pull_request_review_id": 819293171,
    "id": 759468928,
    "node_id": "PRRC_kwDOABII584tRJOA",
    "diff_hunk": "@@ -4909,7 +4952,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     // Fake various pieces of CBlockIndex state:\n     CBlockIndex* index = nullptr;\n-    for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n+\n+    // Don't make any modifications to the genesis block.\n+    // This is especially important because we don't want to erroneously\n+    // apply BLOCK_ASSUMED_VALID to genesis, which would happen if we didn't skip\n+    // it here (since it apparently isn't BLOCK_VALID_SCRIPTS).",
    "path": "src/validation.cpp",
    "position": 115,
    "original_position": 115,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "7a576ba9d24308e36dcde2b48b34c0676de98daa",
    "user": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "> This is an argument for including Python's `not` operator in C++21. ;)\r\n\r\nIt's actually already there, no need to wait https://en.cppreference.com/w/cpp/language/operator_alternative",
    "created_at": "2021-11-30T16:45:25Z",
    "updated_at": "2021-11-30T16:45:25Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759468928",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759468928"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759468928"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759468928/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 4959,
    "original_line": 4959,
    "side": "RIGHT",
    "in_reply_to_id": 758160127
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759476770",
    "pull_request_review_id": 819304116,
    "id": 759476770,
    "node_id": "PRRC_kwDOABII584tRLIi",
    "diff_hunk": "@@ -4909,7 +4952,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     // Fake various pieces of CBlockIndex state:\n     CBlockIndex* index = nullptr;\n-    for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n+\n+    // Don't make any modifications to the genesis block.\n+    // This is especially important because we don't want to erroneously\n+    // apply BLOCK_ASSUMED_VALID to genesis, which would happen if we didn't skip\n+    // it here (since it apparently isn't BLOCK_VALID_SCRIPTS).",
    "path": "src/validation.cpp",
    "position": 115,
    "original_position": 115,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "7a576ba9d24308e36dcde2b48b34c0676de98daa",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Pretty sure that `not` may fail on some compilers (on windows?).\r\n\r\nIn general I think if there is a way to avoid a negation, it might be preferable. In this case saying \"(since it apparently is lacking BLOCK_VALID_SCRIPTS)\" might work?",
    "created_at": "2021-11-30T16:53:58Z",
    "updated_at": "2021-11-30T16:53:58Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759476770",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759476770"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759476770"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759476770/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 4959,
    "original_line": 4959,
    "side": "RIGHT",
    "in_reply_to_id": 758160127
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759485558",
    "pull_request_review_id": 819316081,
    "id": 759485558,
    "node_id": "PRRC_kwDOABII584tRNR2",
    "diff_hunk": "@@ -4909,7 +4909,14 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     // Fake various pieces of CBlockIndex state:\n     CBlockIndex* index = nullptr;\n-    for (int i = 0; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n+\n+    // Don't make any modifications to the genesis block.\n+    // This is especially important because we don't want to erroneously\n+    // apply BLOCK_ASSUMED_VALID to genesis, which would happen if we didn't skip\n+    // it here (since it apparently isn't BLOCK_VALID_SCRIPTS).\n+    constexpr int AFTER_GENESIS_START{1};\n+\n+    for (int i = AFTER_GENESIS_START; i <= snapshot_chainstate.m_chain.Height(); ++i) {\n         index = snapshot_chainstate.m_chain[i];\n \n         // Fake nTx so that LoadBlockIndex() loads assumed-valid CBlockIndex",
    "path": "src/validation.cpp",
    "position": 121,
    "original_position": 15,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "9be75f223577108bc573c2b04f2f8c67eefe88ef",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "in the first commit (9be75f223577108bc573c2b04f2f8c67eefe88ef):\r\n\r\nAs the genesis block is the only block which doesn't have a previous block, it might be good to remove the dead code in this body now.\r\n\r\n`index->pprev` is always true now and can/should be removed. If you are worried about future logic bugs, you may use `Assert(index->pprev)->nChainTx` instead of `index->pprev->nChainTx`.",
    "created_at": "2021-11-30T17:03:29Z",
    "updated_at": "2021-11-30T18:04:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759485558",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759485558"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759485558"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759485558/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 4965,
    "original_line": 4922,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759503280",
    "pull_request_review_id": 819316081,
    "id": 759503280,
    "node_id": "PRRC_kwDOABII584tRRmw",
    "diff_hunk": "@@ -3622,17 +3622,41 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // Find start of assumed-valid region.\n+    int first_assumed_valid_height = std::numeric_limits<int>::max();\n+\n+    for (const auto& [height, block] : vSortedByHeight) {\n+        if (block->IsAssumedValid()) {\n+            auto chainstates = chainman.GetAll();\n+\n+            // assert that the assumed valid blocks come from some assumed-valid chainstate.\n+            assert(any_of(chainstates.cbegin(), chainstates.cend(),",
    "path": "src/validation.cpp",
    "position": 22,
    "original_position": 22,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "36e2bc4275fdb0d72390215fcea4d499f8049701",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "in commit 36e2bc4275fdb0d72390215fcea4d499f8049701:\r\n\r\nCan you explain why this compiles? I always assumed that standard library helpers are only accessible in the `std::` namespace.",
    "created_at": "2021-11-30T17:24:29Z",
    "updated_at": "2021-11-30T18:04:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759503280",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759503280"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759503280"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759503280/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3634,
    "original_line": 3634,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759507823",
    "pull_request_review_id": 819316081,
    "id": 759507823,
    "node_id": "PRRC_kwDOABII584tRStv",
    "diff_hunk": "@@ -3622,17 +3622,41 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // Find start of assumed-valid region.\n+    int first_assumed_valid_height = std::numeric_limits<int>::max();\n+\n+    for (const auto& [height, block] : vSortedByHeight) {\n+        if (block->IsAssumedValid()) {\n+            auto chainstates = chainman.GetAll();\n+\n+            // assert that the assumed valid blocks come from some assumed-valid chainstate.\n+            assert(any_of(chainstates.cbegin(), chainstates.cend(),\n+                [](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));\n+            // assert that the assumed valid blocks will be validated by some not assumed-valid\n+            // chainstate.\n+            assert(any_of(chainstates.cbegin(), chainstates.cend(),\n+                [](auto chainstate) { return !chainstate->reliesOnAssumedValid(); }));",
    "path": "src/validation.cpp",
    "position": 27,
    "original_position": 27,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "36e2bc4275fdb0d72390215fcea4d499f8049701",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "in commit 36e2bc4275fdb0d72390215fcea4d499f8049701:\r\n\r\nCan you explain the asserts a bit better? Currently it looks like they are asserting that two chainstates exist. This condition should be independent of the loop and could be moved outside?\r\n\r\n",
    "created_at": "2021-11-30T17:30:00Z",
    "updated_at": "2021-11-30T18:04:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759507823",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759507823"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759507823"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759507823/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3639,
    "original_line": 3639,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759533358",
    "pull_request_review_id": 819316081,
    "id": 759533358,
    "node_id": "PRRC_kwDOABII584tRY8u",
    "diff_hunk": "@@ -3649,7 +3673,28 @@ bool BlockManager::LoadBlockIndex(\n         if (pindex->IsAssumedValid() ||\n                 (pindex->IsValid(BLOCK_VALID_TRANSACTIONS) &&\n                  (pindex->HaveTxsDownloaded() || pindex->pprev == nullptr))) {\n-            block_index_candidates.insert(pindex);\n+\n+            // Fill each chainstate's block candidate set. Add all blocks as\n+            // candidates if the chainstate is allowed to rely on assumed-valid\n+            // blocks. Otherwise avoid adding assumed-valid blocks so that\n+            // non-assumed-valid chainstates will download and validate all earlier,\n+            // unvalidated blocks.\n+            //\n+            // Note: This is considering all blocks whose height is greater or\n+            // equal to the first assumed-valid block to be assumed-valid\n+            // blocks, and excluding them from the background chainstate's\n+            // setBlockIndexCandidates set. This does mean that some blocks\n+            // which are not technically assumed-valid (later blocks on a fork\n+            // beginning before the first assumed-valid block) might not get\n+            // added to the the background chainstate, but this is ok, because\n+            // they will still be attached to the active chainstate if they\n+            // actually contain more work.",
    "path": "src/validation.cpp",
    "position": 73,
    "original_position": 73,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "36e2bc4275fdb0d72390215fcea4d499f8049701",
    "user": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "in commit 36e2bc4275fdb0d72390215fcea4d499f8049701:\r\n\r\nI don't understand why it is safe to not attach them. If the assumed valid block is sufficiently old, it may cost little POW to create an alternative fork up to that height, and confusing the background chainstate that it can't connect to the active chainstate?\r\n\r\nWhat is the reason for the if-condition in the first place? What would happen if both candidate sets are fully populated?",
    "created_at": "2021-11-30T18:02:47Z",
    "updated_at": "2021-11-30T18:04:59Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759533358",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "MEMBER",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759533358"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759533358"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759533358/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3691,
    "original_line": 3691,
    "side": "RIGHT"
  },
  {
    "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759737914",
    "pull_request_review_id": 819659122,
    "id": 759737914,
    "node_id": "PRRC_kwDOABII584tSK46",
    "diff_hunk": "@@ -3622,17 +3622,41 @@ bool BlockManager::LoadBlockIndex(\n         vSortedByHeight.push_back(std::make_pair(pindex->nHeight, pindex));\n     }\n     sort(vSortedByHeight.begin(), vSortedByHeight.end());\n+\n+    // Find start of assumed-valid region.\n+    int first_assumed_valid_height = std::numeric_limits<int>::max();\n+\n+    for (const auto& [height, block] : vSortedByHeight) {\n+        if (block->IsAssumedValid()) {\n+            auto chainstates = chainman.GetAll();\n+\n+            // assert that the assumed valid blocks come from some assumed-valid chainstate.\n+            assert(any_of(chainstates.cbegin(), chainstates.cend(),\n+                [](auto chainstate) { return chainstate->reliesOnAssumedValid(); }));",
    "path": "src/validation.cpp",
    "position": 23,
    "original_position": 23,
    "commit_id": "709a09c9b6a902d5ed0e5ad6ac421b17c8921e6e",
    "original_commit_id": "e19253f2fd17b01e52950b9e78fcd10251e6e8c0",
    "user": {
      "login": "fjahr",
      "id": 1322187,
      "node_id": "MDQ6VXNlcjEzMjIxODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1322187?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/fjahr",
      "html_url": "https://github.com/fjahr",
      "followers_url": "https://api.github.com/users/fjahr/followers",
      "following_url": "https://api.github.com/users/fjahr/following{/other_user}",
      "gists_url": "https://api.github.com/users/fjahr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/fjahr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/fjahr/subscriptions",
      "organizations_url": "https://api.github.com/users/fjahr/orgs",
      "repos_url": "https://api.github.com/users/fjahr/repos",
      "events_url": "https://api.github.com/users/fjahr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/fjahr/received_events",
      "type": "User",
      "site_admin": false
    },
    "body": "Unless I have a misunderstanding here, what I meant: We only have blocks that are assumed valid if we have a chainstate that relies on assume valid, those two will always go together. We will probably have very few chain states and we have a lot of blocks. So it seems to me that it would be more efficient to first loop the chainstates and then the blocks.",
    "created_at": "2021-11-30T23:24:30Z",
    "updated_at": "2021-11-30T23:24:30Z",
    "html_url": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759737914",
    "pull_request_url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174",
    "author_association": "CONTRIBUTOR",
    "_links": {
      "self": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759737914"
      },
      "html": {
        "href": "https://github.com/bitcoin/bitcoin/pull/23174#discussion_r759737914"
      },
      "pull_request": {
        "href": "https://api.github.com/repos/bitcoin/bitcoin/pulls/23174"
      }
    },
    "reactions": {
      "url": "https://api.github.com/repos/bitcoin/bitcoin/pulls/comments/759737914/reactions",
      "total_count": 0,
      "+1": 0,
      "-1": 0,
      "laugh": 0,
      "hooray": 0,
      "confused": 0,
      "heart": 0,
      "rocket": 0,
      "eyes": 0
    },
    "start_line": null,
    "original_start_line": null,
    "start_side": null,
    "line": 3635,
    "original_line": 3635,
    "side": "RIGHT",
    "in_reply_to_id": 757915350
  }
]