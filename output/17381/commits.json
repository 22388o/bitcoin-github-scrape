[
  {
    "sha": "b07b07cd8779355ba1dd16e7eb4af42e0ae1c587",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiMDdiMDdjZDg3NzkzNTViYTFkZDE2ZTdlYjRhZjQyZTBhZTFjNTg3",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2019-11-05T15:13:43Z"
      },
      "committer": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2019-11-05T15:13:43Z"
      },
      "message": "Add EnsureLegacyScriptPubKeyMan and use in rpcwallet.cpp\n\nThis also fixes unused variable warnings in rpcdump.cpp",
      "tree": {
        "sha": "27f5a1027184ab0a0586a00dd6c3ad8161a78d0b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/27f5a1027184ab0a0586a00dd6c3ad8161a78d0b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b07b07cd8779355ba1dd16e7eb4af42e0ae1c587",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b07b07cd8779355ba1dd16e7eb4af42e0ae1c587",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b07b07cd8779355ba1dd16e7eb4af42e0ae1c587",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b07b07cd8779355ba1dd16e7eb4af42e0ae1c587/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e204dc11b562c2cf31d320774a4dcbe49f3b6468",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e204dc11b562c2cf31d320774a4dcbe49f3b6468",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e204dc11b562c2cf31d320774a4dcbe49f3b6468"
      }
    ],
    "stats": {
      "total": 58,
      "additions": 27,
      "deletions": 31
    },
    "files": [
      {
        "sha": "6995974f08333dd38f6a65a79643331a2df3dd45",
        "filename": "src/wallet/rpcdump.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 16,
        "changes": 23,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b07b07cd8779355ba1dd16e7eb4af42e0ae1c587/src/wallet/rpcdump.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b07b07cd8779355ba1dd16e7eb4af42e0ae1c587/src/wallet/rpcdump.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcdump.cpp?ref=b07b07cd8779355ba1dd16e7eb4af42e0ae1c587",
        "patch": "@@ -87,15 +87,6 @@ static void RescanWallet(CWallet& wallet, const WalletRescanReserver& reserver,\n     }\n }\n \n-static LegacyScriptPubKeyMan& GetLegacyScriptPubKeyMan(CWallet& wallet)\n-{\n-    LegacyScriptPubKeyMan* spk_man = wallet.GetLegacyScriptPubKeyMan();\n-    if (!spk_man) {\n-        throw JSONRPCError(RPC_WALLET_ERROR, \"This type of wallet does not support this command\");\n-    }\n-    return *spk_man;\n-}\n-\n UniValue importprivkey(const JSONRPCRequest& request)\n {\n     std::shared_ptr<CWallet> const wallet = GetWalletForJSONRPCRequest(request);\n@@ -134,7 +125,7 @@ UniValue importprivkey(const JSONRPCRequest& request)\n         throw JSONRPCError(RPC_WALLET_ERROR, \"Cannot import private keys to a wallet with private keys disabled\");\n     }\n \n-    LegacyScriptPubKeyMan& spk_man = GetLegacyScriptPubKeyMan(*wallet);\n+    EnsureLegacyScriptPubKeyMan(*wallet);\n \n     WalletRescanReserver reserver(pwallet);\n     bool fRescan = true;\n@@ -262,7 +253,7 @@ UniValue importaddress(const JSONRPCRequest& request)\n                 },\n             }.Check(request);\n \n-    LegacyScriptPubKeyMan& spk_man = GetLegacyScriptPubKeyMan(*pwallet);\n+    EnsureLegacyScriptPubKeyMan(*pwallet);\n \n     std::string strLabel;\n     if (!request.params[1].isNull())\n@@ -465,7 +456,7 @@ UniValue importpubkey(const JSONRPCRequest& request)\n                 },\n             }.Check(request);\n \n-    LegacyScriptPubKeyMan& spk_man = GetLegacyScriptPubKeyMan(*wallet);\n+    EnsureLegacyScriptPubKeyMan(*wallet);\n \n     std::string strLabel;\n     if (!request.params[1].isNull())\n@@ -549,7 +540,7 @@ UniValue importwallet(const JSONRPCRequest& request)\n                 },\n             }.Check(request);\n \n-    LegacyScriptPubKeyMan& spk_man = GetLegacyScriptPubKeyMan(*wallet);\n+    EnsureLegacyScriptPubKeyMan(*wallet);\n \n     if (pwallet->chain().havePruned()) {\n         // Exit early and print an error.\n@@ -708,7 +699,7 @@ UniValue dumpprivkey(const JSONRPCRequest& request)\n                 },\n             }.Check(request);\n \n-    LegacyScriptPubKeyMan& spk_man = GetLegacyScriptPubKeyMan(*wallet);\n+    LegacyScriptPubKeyMan& spk_man = EnsureLegacyScriptPubKeyMan(*wallet);\n \n     auto locked_chain = pwallet->chain().lock();\n     LOCK(pwallet->cs_wallet);\n@@ -759,7 +750,7 @@ UniValue dumpwallet(const JSONRPCRequest& request)\n                 },\n             }.Check(request);\n \n-    LegacyScriptPubKeyMan& spk_man = GetLegacyScriptPubKeyMan(*wallet);\n+    LegacyScriptPubKeyMan& spk_man = EnsureLegacyScriptPubKeyMan(*wallet);\n \n     auto locked_chain = pwallet->chain().lock();\n     LOCK(pwallet->cs_wallet);\n@@ -1346,7 +1337,7 @@ UniValue importmulti(const JSONRPCRequest& mainRequest)\n \n     RPCTypeCheck(mainRequest.params, {UniValue::VARR, UniValue::VOBJ});\n \n-    LegacyScriptPubKeyMan& spk_man = GetLegacyScriptPubKeyMan(*wallet);\n+    EnsureLegacyScriptPubKeyMan(*wallet);\n \n     const UniValue& requests = mainRequest.params[0];\n "
      },
      {
        "sha": "7b39f3aecbb8ad3d8cb1ad4cab9ad9837b4fe9c2",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 18,
        "deletions": 15,
        "changes": 33,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b07b07cd8779355ba1dd16e7eb4af42e0ae1c587/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b07b07cd8779355ba1dd16e7eb4af42e0ae1c587/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=b07b07cd8779355ba1dd16e7eb4af42e0ae1c587",
        "patch": "@@ -124,6 +124,15 @@ void EnsureWalletIsUnlocked(const CWallet* pwallet)\n     }\n }\n \n+LegacyScriptPubKeyMan& EnsureLegacyScriptPubKeyMan(CWallet& wallet)\n+{\n+    LegacyScriptPubKeyMan* spk_man = wallet.GetLegacyScriptPubKeyMan();\n+    if (!spk_man) {\n+        throw JSONRPCError(RPC_WALLET_ERROR, \"This type of wallet does not support this command\");\n+    }\n+    return *spk_man;\n+}\n+\n static void WalletTxToJSON(interfaces::Chain& chain, interfaces::Chain::Lock& locked_chain, const CWalletTx& wtx, UniValue& entry)\n {\n     int confirms = wtx.GetDepthInMainChain(locked_chain);\n@@ -966,10 +975,7 @@ static UniValue addmultisigaddress(const JSONRPCRequest& request)\n                 },\n             }.Check(request);\n \n-    LegacyScriptPubKeyMan* spk_man = pwallet->GetLegacyScriptPubKeyMan();\n-    if (!spk_man) {\n-        throw JSONRPCError(RPC_WALLET_ERROR, \"This type of wallet does not support this command\");\n-    }\n+    LegacyScriptPubKeyMan& spk_man = EnsureLegacyScriptPubKeyMan(*pwallet);\n \n     auto locked_chain = pwallet->chain().lock();\n     LOCK(pwallet->cs_wallet);\n@@ -987,7 +993,7 @@ static UniValue addmultisigaddress(const JSONRPCRequest& request)\n         if (IsHex(keys_or_addrs[i].get_str()) && (keys_or_addrs[i].get_str().length() == 66 || keys_or_addrs[i].get_str().length() == 130)) {\n             pubkeys.push_back(HexToPubKey(keys_or_addrs[i].get_str()));\n         } else {\n-            pubkeys.push_back(AddrToPubKey(spk_man, keys_or_addrs[i].get_str()));\n+            pubkeys.push_back(AddrToPubKey(&spk_man, keys_or_addrs[i].get_str()));\n         }\n     }\n \n@@ -1000,7 +1006,7 @@ static UniValue addmultisigaddress(const JSONRPCRequest& request)\n \n     // Construct using pay-to-script-hash:\n     CScript inner;\n-    CTxDestination dest = AddAndGetMultisigDestination(required, pubkeys, output_type, *spk_man, inner);\n+    CTxDestination dest = AddAndGetMultisigDestination(required, pubkeys, output_type, spk_man, inner);\n     pwallet->SetAddressBook(dest, label, \"send\");\n \n     UniValue result(UniValue::VOBJ);\n@@ -3933,10 +3939,7 @@ UniValue sethdseed(const JSONRPCRequest& request)\n                 },\n             }.Check(request);\n \n-    LegacyScriptPubKeyMan* spk_man = pwallet->GetLegacyScriptPubKeyMan();\n-    if (!spk_man) {\n-        throw JSONRPCError(RPC_WALLET_ERROR, \"This type of wallet does not support this command\");\n-    }\n+    LegacyScriptPubKeyMan& spk_man = EnsureLegacyScriptPubKeyMan(*pwallet);\n \n     if (pwallet->chain().isInitialBlockDownload()) {\n         throw JSONRPCError(RPC_CLIENT_IN_INITIAL_DOWNLOAD, \"Cannot set a new HD seed while still in Initial Block Download\");\n@@ -3963,22 +3966,22 @@ UniValue sethdseed(const JSONRPCRequest& request)\n \n     CPubKey master_pub_key;\n     if (request.params[1].isNull()) {\n-        master_pub_key = spk_man->GenerateNewSeed();\n+        master_pub_key = spk_man.GenerateNewSeed();\n     } else {\n         CKey key = DecodeSecret(request.params[1].get_str());\n         if (!key.IsValid()) {\n             throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid private key\");\n         }\n \n-        if (HaveKey(*spk_man, key)) {\n+        if (HaveKey(spk_man, key)) {\n             throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Already have this key (either as an HD seed or as a loose private key)\");\n         }\n \n-        master_pub_key = spk_man->DeriveNewSeed(key);\n+        master_pub_key = spk_man.DeriveNewSeed(key);\n     }\n \n-    spk_man->SetHDSeed(master_pub_key);\n-    if (flush_key_pool) spk_man->NewKeyPool();\n+    spk_man.SetHDSeed(master_pub_key);\n+    if (flush_key_pool) spk_man.NewKeyPool();\n \n     return NullUniValue;\n }"
      },
      {
        "sha": "becca455f649e5a228cde34f7415cf5629aa7594",
        "filename": "src/wallet/rpcwallet.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b07b07cd8779355ba1dd16e7eb4af42e0ae1c587/src/wallet/rpcwallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b07b07cd8779355ba1dd16e7eb4af42e0ae1c587/src/wallet/rpcwallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.h?ref=b07b07cd8779355ba1dd16e7eb4af42e0ae1c587",
        "patch": "@@ -12,6 +12,7 @@\n class CRPCTable;\n class CWallet;\n class JSONRPCRequest;\n+class LegacyScriptPubKeyMan;\n class UniValue;\n struct PartiallySignedTransaction;\n class CTransaction;\n@@ -40,6 +41,7 @@ std::shared_ptr<CWallet> GetWalletForJSONRPCRequest(const JSONRPCRequest& reques\n std::string HelpRequiringPassphrase(const CWallet*);\n void EnsureWalletIsUnlocked(const CWallet*);\n bool EnsureWalletIsAvailable(const CWallet*, bool avoidException);\n+LegacyScriptPubKeyMan& EnsureLegacyScriptPubKeyMan(CWallet& wallet);\n \n UniValue getaddressinfo(const JSONRPCRequest& request);\n UniValue signrawtransactionwithwallet(const JSONRPCRequest& request);"
      }
    ]
  },
  {
    "sha": "4a0abf694ee10cf186f25a67ca35c3fce0c10874",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0YTBhYmY2OTRlZTEwY2YxODZmMjVhNjdjYTM1YzNmY2UwYzEwODc0",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2019-11-05T15:36:55Z"
      },
      "committer": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2019-11-05T15:36:55Z"
      },
      "message": "Pass CTxDestination to ScriptPubKeyMan::GetMetadata\n\nPass CTxDestination instead of more ambiguous uint160 hash value. This is more\ntype safe and more efficient since it avoids doing map lookups that will always\nfail and were not done previously before\na18edd7b383d667b15b6d4b87aa3a055a9fa5051 from\nhttps://github.com/bitcoin/bitcoin/pull/17304\n\nChange suggested by Andrew Chow <achow101-github@achow101.com> in\nhttps://github.com/bitcoin/bitcoin/pull/17304#discussion_r340345745 and\nhttps://github.com/bitcoin/bitcoin/pull/17381#issuecomment-549994944",
      "tree": {
        "sha": "77edda9a457ead323d39c165030c6a0ff94d13a4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/77edda9a457ead323d39c165030c6a0ff94d13a4"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4a0abf694ee10cf186f25a67ca35c3fce0c10874",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4a0abf694ee10cf186f25a67ca35c3fce0c10874",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/4a0abf694ee10cf186f25a67ca35c3fce0c10874",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4a0abf694ee10cf186f25a67ca35c3fce0c10874/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b07b07cd8779355ba1dd16e7eb4af42e0ae1c587",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b07b07cd8779355ba1dd16e7eb4af42e0ae1c587",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b07b07cd8779355ba1dd16e7eb4af42e0ae1c587"
      }
    ],
    "stats": {
      "total": 37,
      "additions": 18,
      "deletions": 19
    },
    "files": [
      {
        "sha": "6098a08292a6b49a9f0cb263ded2465fc696246a",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 9,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4a0abf694ee10cf186f25a67ca35c3fce0c10874/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4a0abf694ee10cf186f25a67ca35c3fce0c10874/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=4a0abf694ee10cf186f25a67ca35c3fce0c10874",
        "patch": "@@ -3765,15 +3765,7 @@ UniValue getaddressinfo(const JSONRPCRequest& request)\n \n     ScriptPubKeyMan* spk_man = pwallet->GetScriptPubKeyMan();\n     if (spk_man) {\n-        CKeyID key_id = GetKeyForDestination(*provider, dest);\n-        const CKeyMetadata* meta = nullptr;\n-        if (!key_id.IsNull()) {\n-            meta = spk_man->GetMetadata(key_id);\n-        }\n-        if (!meta) {\n-            meta = spk_man->GetMetadata(CScriptID(scriptPubKey));\n-        }\n-        if (meta) {\n+        if (const CKeyMetadata* meta = spk_man->GetMetadata(dest)) {\n             ret.pushKV(\"timestamp\", meta->nCreateTime);\n             if (meta->has_key_origin) {\n                 ret.pushKV(\"hdkeypath\", WriteHDKeypath(meta->key_origin.path));"
      },
      {
        "sha": "48fe1843a3f92824f46a041c3a130688fb626278",
        "filename": "src/wallet/scriptpubkeyman.cpp",
        "status": "modified",
        "additions": 14,
        "deletions": 8,
        "changes": 22,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4a0abf694ee10cf186f25a67ca35c3fce0c10874/src/wallet/scriptpubkeyman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4a0abf694ee10cf186f25a67ca35c3fce0c10874/src/wallet/scriptpubkeyman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.cpp?ref=4a0abf694ee10cf186f25a67ca35c3fce0c10874",
        "patch": "@@ -476,18 +476,24 @@ int64_t LegacyScriptPubKeyMan::GetTimeFirstKey() const\n     return nTimeFirstKey;\n }\n \n-const CKeyMetadata* LegacyScriptPubKeyMan::GetMetadata(uint160 id) const\n+const CKeyMetadata* LegacyScriptPubKeyMan::GetMetadata(const CTxDestination& dest) const\n {\n     AssertLockHeld(cs_wallet);\n-    auto it = mapKeyMetadata.find(CKeyID(id));\n-    if (it != mapKeyMetadata.end()) {\n-        return &it->second;\n-    } else {\n-        auto it2 = m_script_metadata.find(CScriptID(id));\n-        if (it2 != m_script_metadata.end()) {\n-            return &it2->second;\n+\n+    CKeyID key_id = GetKeyForDestination(*this, dest);\n+    if (!key_id.IsNull()) {\n+        auto it = mapKeyMetadata.find(key_id);\n+        if (it != mapKeyMetadata.end()) {\n+            return &it->second;\n         }\n     }\n+\n+    CScript scriptPubKey = GetScriptForDestination(dest);\n+    auto it = m_script_metadata.find(CScriptID(scriptPubKey));\n+    if (it != m_script_metadata.end()) {\n+        return &it->second;\n+    }\n+\n     return nullptr;\n }\n "
      },
      {
        "sha": "55117db5c184ea2d708edf0e21869f6e129b2664",
        "filename": "src/wallet/scriptpubkeyman.h",
        "status": "modified",
        "additions": 3,
        "deletions": 2,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4a0abf694ee10cf186f25a67ca35c3fce0c10874/src/wallet/scriptpubkeyman.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4a0abf694ee10cf186f25a67ca35c3fce0c10874/src/wallet/scriptpubkeyman.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.h?ref=4a0abf694ee10cf186f25a67ca35c3fce0c10874",
        "patch": "@@ -186,7 +186,8 @@ class ScriptPubKeyMan\n \n     virtual int64_t GetTimeFirstKey() const { return 0; }\n \n-    virtual const CKeyMetadata* GetMetadata(uint160 id) const { return nullptr; }\n+    //! Return address metadata\n+    virtual const CKeyMetadata* GetMetadata(const CTxDestination& dest) const { return nullptr; }\n };\n \n class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProvider\n@@ -302,7 +303,7 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n \n     int64_t GetTimeFirstKey() const override;\n \n-    const CKeyMetadata* GetMetadata(uint160 id) const override;\n+    const CKeyMetadata* GetMetadata(const CTxDestination& dest) const override;\n \n     bool CanGetAddresses(bool internal = false) override;\n "
      }
    ]
  },
  {
    "sha": "491a599b37f3e3a648e52aebed677ca11b0615e2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0OTFhNTk5YjM3ZjNlM2E2NDhlNTJhZWJlZDY3N2NhMTFiMDYxNWUy",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2019-11-05T15:43:36Z"
      },
      "committer": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2019-11-05T15:43:36Z"
      },
      "message": "Get rid of confusing LegacyScriptPubKeyMan::TopUpKeyPool method\n\nPrevious discussion https://github.com/bitcoin/bitcoin/pull/17304#discussion_r340307903",
      "tree": {
        "sha": "ebb36a32336db0855d73ac284d400dde6808528f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ebb36a32336db0855d73ac284d400dde6808528f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/491a599b37f3e3a648e52aebed677ca11b0615e2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/491a599b37f3e3a648e52aebed677ca11b0615e2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/491a599b37f3e3a648e52aebed677ca11b0615e2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/491a599b37f3e3a648e52aebed677ca11b0615e2/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "4a0abf694ee10cf186f25a67ca35c3fce0c10874",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4a0abf694ee10cf186f25a67ca35c3fce0c10874",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/4a0abf694ee10cf186f25a67ca35c3fce0c10874"
      }
    ],
    "stats": {
      "total": 18,
      "additions": 6,
      "deletions": 12
    },
    "files": [
      {
        "sha": "ce7cf36924393189c206c81572984c3cb583d526",
        "filename": "src/wallet/scriptpubkeyman.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 11,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/491a599b37f3e3a648e52aebed677ca11b0615e2/src/wallet/scriptpubkeyman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/491a599b37f3e3a648e52aebed677ca11b0615e2/src/wallet/scriptpubkeyman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.cpp?ref=491a599b37f3e3a648e52aebed677ca11b0615e2",
        "patch": "@@ -14,7 +14,7 @@\n bool LegacyScriptPubKeyMan::GetNewDestination(const OutputType type, CTxDestination& dest, std::string& error)\n {\n     error.clear();\n-    TopUpKeyPool();\n+    TopUp();\n \n     // Generate a new key that is added to wallet\n     CPubKey new_key;\n@@ -282,11 +282,6 @@ void LegacyScriptPubKeyMan::ReturnDestination(int64_t index, bool internal, cons\n     ReturnKey(index, internal, pubkey);\n }\n \n-bool LegacyScriptPubKeyMan::TopUp(unsigned int size)\n-{\n-    return TopUpKeyPool(size);\n-}\n-\n void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n {\n     AssertLockHeld(cs_wallet);\n@@ -297,7 +292,7 @@ void LegacyScriptPubKeyMan::MarkUnusedAddresses(const CScript& script)\n             WalletLogPrintf(\"%s: Detected a used keypool key, mark all keypool key up to this key as used\\n\", __func__);\n             MarkReserveKeysAsUsed(mi->second);\n \n-            if (!TopUpKeyPool()) {\n+            if (!TopUp()) {\n                 WalletLogPrintf(\"%s: Topping up keypool failed (locked wallet)\\n\", __func__);\n             }\n         }\n@@ -401,7 +396,7 @@ bool LegacyScriptPubKeyMan::Upgrade(int prev_version, std::string& error)\n     }\n     // Regenerate the keypool if upgraded to HD\n     if (hd_upgrade) {\n-        if (!TopUpKeyPool()) {\n+        if (!TopUp()) {\n             error = _(\"Unable to generate keys\").translated;\n             return false;\n         }\n@@ -1029,15 +1024,15 @@ bool LegacyScriptPubKeyMan::NewKeyPool()\n \n         m_pool_key_to_index.clear();\n \n-        if (!TopUpKeyPool()) {\n+        if (!TopUp()) {\n             return false;\n         }\n         WalletLogPrintf(\"LegacyScriptPubKeyMan::NewKeyPool rewrote keypool\\n\");\n     }\n     return true;\n }\n \n-bool LegacyScriptPubKeyMan::TopUpKeyPool(unsigned int kpSize)\n+bool LegacyScriptPubKeyMan::TopUp(unsigned int kpSize)\n {\n     if (!CanGenerateKeys()) {\n         return false;\n@@ -1154,7 +1149,7 @@ bool LegacyScriptPubKeyMan::ReserveKeyFromKeyPool(int64_t& nIndex, CKeyPool& key\n     {\n         LOCK(cs_wallet);\n \n-        TopUpKeyPool();\n+        TopUp();\n \n         bool fReturningInternal = fRequestedInternal;\n         fReturningInternal &= (IsHDEnabled() && m_storage.CanSupportFeature(FEATURE_HD_SPLIT)) || m_storage.IsWalletFlagSet(WALLET_FLAG_DISABLE_PRIVATE_KEYS);"
      },
      {
        "sha": "4f17156792956cc63f895db7ee9ddbc2e8275084",
        "filename": "src/wallet/scriptpubkeyman.h",
        "status": "modified",
        "additions": 0,
        "deletions": 1,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/491a599b37f3e3a648e52aebed677ca11b0615e2/src/wallet/scriptpubkeyman.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/491a599b37f3e3a648e52aebed677ca11b0615e2/src/wallet/scriptpubkeyman.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.h?ref=491a599b37f3e3a648e52aebed677ca11b0615e2",
        "patch": "@@ -356,7 +356,6 @@ class LegacyScriptPubKeyMan : public ScriptPubKeyMan, public FillableSigningProv\n \n     //! Load a keypool entry\n     void LoadKeyPool(int64_t nIndex, const CKeyPool &keypool) EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n-    bool TopUpKeyPool(unsigned int kpSize = 0);\n     bool NewKeyPool();\n     void MarkPreSplitKeys() EXCLUSIVE_LOCKS_REQUIRED(cs_wallet);\n "
      }
    ]
  },
  {
    "sha": "bfd826a675445801adec86a469040f3ceb8172ee",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiZmQ4MjZhNjc1NDQ1ODAxYWRlYzg2YTQ2OTA0MGYzY2ViODE3MmVl",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2019-11-05T15:47:07Z"
      },
      "committer": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2019-11-05T15:47:07Z"
      },
      "message": "Clean up nested scope in GetReservedDestination\n\nSuggested https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341194391\nby Gregory Sanders <gsanders87@gmail.com>\n\nReason for keeping the `return true` `return false` verbosity is that more code\nwill be added after the ReserveKeyFromKeyPool() call before returning.",
      "tree": {
        "sha": "09415d8f68a4549bb07d8510b5d30eed0727923d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/09415d8f68a4549bb07d8510b5d30eed0727923d"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/bfd826a675445801adec86a469040f3ceb8172ee",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bfd826a675445801adec86a469040f3ceb8172ee",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/bfd826a675445801adec86a469040f3ceb8172ee",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bfd826a675445801adec86a469040f3ceb8172ee/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "491a599b37f3e3a648e52aebed677ca11b0615e2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/491a599b37f3e3a648e52aebed677ca11b0615e2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/491a599b37f3e3a648e52aebed677ca11b0615e2"
      }
    ],
    "stats": {
      "total": 6,
      "additions": 2,
      "deletions": 4
    },
    "files": [
      {
        "sha": "3eaaf3786c38c9da301850695484bf2efb4b5247",
        "filename": "src/wallet/scriptpubkeyman.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 4,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/bfd826a675445801adec86a469040f3ceb8172ee/src/wallet/scriptpubkeyman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/bfd826a675445801adec86a469040f3ceb8172ee/src/wallet/scriptpubkeyman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/scriptpubkeyman.cpp?ref=bfd826a675445801adec86a469040f3ceb8172ee",
        "patch": "@@ -264,10 +264,8 @@ bool LegacyScriptPubKeyMan::EncryptKeys(CKeyingMaterial& vMasterKeyIn)\n \n bool LegacyScriptPubKeyMan::GetReservedDestination(const OutputType type, bool internal, int64_t& index, CKeyPool& keypool)\n {\n-    {\n-        if (!ReserveKeyFromKeyPool(index, keypool, internal)) {\n-            return false;\n-        }\n+    if (!ReserveKeyFromKeyPool(index, keypool, internal)) {\n+        return false;\n     }\n     return true;\n }"
      }
    ]
  },
  {
    "sha": "05b224a175065aee4d6d9c471722bc4503f01fdf",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowNWIyMjRhMTc1MDY1YWVlNGQ2ZDljNDcxNzIyYmM0NTAzZjAxZmRm",
    "commit": {
      "author": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2019-11-05T15:53:07Z"
      },
      "committer": {
        "name": "Russell Yanofsky",
        "email": "russ@yanofsky.org",
        "date": "2019-11-05T15:53:07Z"
      },
      "message": "Add missing SetupGeneration error handling in EncryptWallet\n\nSuggested https://github.com/bitcoin/bitcoin/pull/17304#discussion_r341286026\nby me",
      "tree": {
        "sha": "f852acbdc981e2c1f63cebbd75ec0528003eb822",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f852acbdc981e2c1f63cebbd75ec0528003eb822"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/05b224a175065aee4d6d9c471722bc4503f01fdf",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/05b224a175065aee4d6d9c471722bc4503f01fdf",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/05b224a175065aee4d6d9c471722bc4503f01fdf",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/05b224a175065aee4d6d9c471722bc4503f01fdf/comments",
    "author": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ryanofsky",
      "id": 7133040,
      "node_id": "MDQ6VXNlcjcxMzMwNDA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7133040?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ryanofsky",
      "html_url": "https://github.com/ryanofsky",
      "followers_url": "https://api.github.com/users/ryanofsky/followers",
      "following_url": "https://api.github.com/users/ryanofsky/following{/other_user}",
      "gists_url": "https://api.github.com/users/ryanofsky/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ryanofsky/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ryanofsky/subscriptions",
      "organizations_url": "https://api.github.com/users/ryanofsky/orgs",
      "repos_url": "https://api.github.com/users/ryanofsky/repos",
      "events_url": "https://api.github.com/users/ryanofsky/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ryanofsky/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "bfd826a675445801adec86a469040f3ceb8172ee",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bfd826a675445801adec86a469040f3ceb8172ee",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/bfd826a675445801adec86a469040f3ceb8172ee"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 3,
      "deletions": 1
    },
    "files": [
      {
        "sha": "cdcb65e3c0091cdab9877e8a36152f621406886f",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 1,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/05b224a175065aee4d6d9c471722bc4503f01fdf/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/05b224a175065aee4d6d9c471722bc4503f01fdf/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=05b224a175065aee4d6d9c471722bc4503f01fdf",
        "patch": "@@ -572,7 +572,9 @@ bool CWallet::EncryptWallet(const SecureString& strWalletPassphrase)\n         // if we are using HD, replace the HD seed with a new one\n         if (auto spk_man = m_spk_man.get()) {\n             if (spk_man->IsHDEnabled()) {\n-                spk_man->SetupGeneration(true);\n+                if (!spk_man->SetupGeneration(true)) {\n+                    return false;\n+                }\n             }\n         }\n         Lock();"
      }
    ]
  }
]