[
  {
    "sha": "ccca27a788fe1ae13661308243c20a1d7a3d0074",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjY2NhMjdhNzg4ZmUxYWUxMzY2MTMwODI0M2MyMGExZDdhM2QwMDc0",
    "commit": {
      "author": {
        "name": "Cozz Lovan",
        "email": "cozzlovan@yahoo.com",
        "date": "2014-07-26T19:05:11Z"
      },
      "committer": {
        "name": "Cozz Lovan",
        "email": "cozzlovan@yahoo.com",
        "date": "2014-10-03T02:29:51Z"
      },
      "message": "[Wallet] Watch-only fixes",
      "tree": {
        "sha": "b862f0f1e0fe98fdd1957cc2236076fef899cc50",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b862f0f1e0fe98fdd1957cc2236076fef899cc50"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ccca27a788fe1ae13661308243c20a1d7a3d0074",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ccca27a788fe1ae13661308243c20a1d7a3d0074",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ccca27a788fe1ae13661308243c20a1d7a3d0074",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ccca27a788fe1ae13661308243c20a1d7a3d0074/comments",
    "author": {
      "login": "cozz",
      "id": 2814559,
      "node_id": "MDQ6VXNlcjI4MTQ1NTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2814559?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cozz",
      "html_url": "https://github.com/cozz",
      "followers_url": "https://api.github.com/users/cozz/followers",
      "following_url": "https://api.github.com/users/cozz/following{/other_user}",
      "gists_url": "https://api.github.com/users/cozz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cozz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cozz/subscriptions",
      "organizations_url": "https://api.github.com/users/cozz/orgs",
      "repos_url": "https://api.github.com/users/cozz/repos",
      "events_url": "https://api.github.com/users/cozz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cozz/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "cozz",
      "id": 2814559,
      "node_id": "MDQ6VXNlcjI4MTQ1NTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2814559?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cozz",
      "html_url": "https://github.com/cozz",
      "followers_url": "https://api.github.com/users/cozz/followers",
      "following_url": "https://api.github.com/users/cozz/following{/other_user}",
      "gists_url": "https://api.github.com/users/cozz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cozz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cozz/subscriptions",
      "organizations_url": "https://api.github.com/users/cozz/orgs",
      "repos_url": "https://api.github.com/users/cozz/repos",
      "events_url": "https://api.github.com/users/cozz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cozz/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "29f96e8bc652cb14c6fdefe5279ee983054faa2a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/29f96e8bc652cb14c6fdefe5279ee983054faa2a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/29f96e8bc652cb14c6fdefe5279ee983054faa2a"
      }
    ],
    "stats": {
      "total": 83,
      "additions": 70,
      "deletions": 13
    },
    "files": [
      {
        "sha": "755defa26de9be41bc1d87eda19e4b0652785214",
        "filename": "src/keystore.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 0,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/keystore.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/keystore.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/keystore.cpp?ref=ccca27a788fe1ae13661308243c20a1d7a3d0074",
        "patch": "@@ -67,6 +67,13 @@ bool CBasicKeyStore::AddWatchOnly(const CScript &dest)\n     return true;\n }\n \n+bool CBasicKeyStore::RemoveWatchOnly(const CScript &dest)\n+{\n+    LOCK(cs_KeyStore);\n+    setWatchOnly.erase(dest);\n+    return true;\n+}\n+\n bool CBasicKeyStore::HaveWatchOnly(const CScript &dest) const\n {\n     LOCK(cs_KeyStore);"
      },
      {
        "sha": "d3478f7672aed777c91d82248600bdc23ece1e55",
        "filename": "src/keystore.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/keystore.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/keystore.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/keystore.h?ref=ccca27a788fe1ae13661308243c20a1d7a3d0074",
        "patch": "@@ -40,6 +40,7 @@ class CKeyStore\n \n     // Support for Watch-only addresses\n     virtual bool AddWatchOnly(const CScript &dest) =0;\n+    virtual bool RemoveWatchOnly(const CScript &dest) =0;\n     virtual bool HaveWatchOnly(const CScript &dest) const =0;\n     virtual bool HaveWatchOnly() const =0;\n };\n@@ -98,6 +99,7 @@ class CBasicKeyStore : public CKeyStore\n     virtual bool GetCScript(const CScriptID &hash, CScript& redeemScriptOut) const;\n \n     virtual bool AddWatchOnly(const CScript &dest);\n+    virtual bool RemoveWatchOnly(const CScript &dest);\n     virtual bool HaveWatchOnly(const CScript &dest) const;\n     virtual bool HaveWatchOnly() const;\n };"
      },
      {
        "sha": "5278c8673a2ced46a4edbd37c85fdb95bad99cf4",
        "filename": "src/qt/transactionrecord.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/qt/transactionrecord.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/qt/transactionrecord.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/transactionrecord.cpp?ref=ccca27a788fe1ae13661308243c20a1d7a3d0074",
        "patch": "@@ -32,7 +32,7 @@ QList<TransactionRecord> TransactionRecord::decomposeTransaction(const CWallet *\n {\n     QList<TransactionRecord> parts;\n     int64_t nTime = wtx.GetTxTime();\n-    CAmount nCredit = wtx.GetCredit(true);\n+    CAmount nCredit = wtx.GetCredit(ISMINE_ALL);\n     CAmount nDebit = wtx.GetDebit(ISMINE_ALL);\n     CAmount nNet = nCredit - nDebit;\n     uint256 hash = wtx.GetHash();"
      },
      {
        "sha": "b4733d369ea3b09a6cd373c49b3c2c6473182ad9",
        "filename": "src/qt/walletmodel.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/qt/walletmodel.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/qt/walletmodel.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/walletmodel.cpp?ref=ccca27a788fe1ae13661308243c20a1d7a3d0074",
        "patch": "@@ -605,7 +605,8 @@ void WalletModel::listCoins(std::map<QString, std::vector<COutput> >& mapCoins)\n         int nDepth = wallet->mapWallet[outpoint.hash].GetDepthInMainChain();\n         if (nDepth < 0) continue;\n         COutput out(&wallet->mapWallet[outpoint.hash], outpoint.n, nDepth, true);\n-        vCoins.push_back(out);\n+        if (outpoint.n < out.tx->vout.size() && wallet->IsMine(out.tx->vout[outpoint.n]) == ISMINE_SPENDABLE)\n+            vCoins.push_back(out);\n     }\n \n     BOOST_FOREACH(const COutput& out, vCoins)"
      },
      {
        "sha": "9da0a7d091b3f0b29cd4453c00723892a518ea67",
        "filename": "src/rpcdump.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 3,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/rpcdump.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/rpcdump.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpcdump.cpp?ref=ccca27a788fe1ae13661308243c20a1d7a3d0074",
        "patch": "@@ -114,8 +114,6 @@ Value importprivkey(const Array& params, bool fHelp)\n     CPubKey pubkey = key.GetPubKey();\n     CKeyID vchAddress = pubkey.GetID();\n     {\n-        LOCK2(cs_main, pwalletMain->cs_wallet);\n-\n         pwalletMain->MarkDirty();\n         pwalletMain->SetAddressBook(vchAddress, strLabel, \"receive\");\n \n@@ -181,7 +179,8 @@ Value importaddress(const Array& params, bool fHelp)\n         fRescan = params[2].get_bool();\n \n     {\n-        LOCK2(cs_main, pwalletMain->cs_wallet);\n+        if (::IsMine(*pwalletMain, script) == ISMINE_SPENDABLE)\n+            throw JSONRPCError(RPC_WALLET_ERROR, \"The wallet already contains the private key for this address or script\");\n \n         // add to address book or update label\n         if (address.IsValid())"
      },
      {
        "sha": "d11455e389aa5ccfc2d84c4ef403b585aa4ef51d",
        "filename": "src/rpcwallet.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpcwallet.cpp?ref=ccca27a788fe1ae13661308243c20a1d7a3d0074",
        "patch": "@@ -1539,7 +1539,7 @@ Value gettransaction(const Array& params, bool fHelp)\n         throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid or non-wallet transaction id\");\n     const CWalletTx& wtx = pwalletMain->mapWallet[hash];\n \n-    CAmount nCredit = wtx.GetCredit(filter != 0);\n+    CAmount nCredit = wtx.GetCredit(filter);\n     CAmount nDebit = wtx.GetDebit(filter);\n     CAmount nNet = nCredit - nDebit;\n     CAmount nFee = (wtx.IsFromMe(filter) ? wtx.GetValueOut() - nDebit : 0);"
      },
      {
        "sha": "1653084495e46e62c067a44a44c10b507b1d5f04",
        "filename": "src/wallet.cpp",
        "status": "modified",
        "additions": 21,
        "deletions": 0,
        "changes": 21,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet.cpp?ref=ccca27a788fe1ae13661308243c20a1d7a3d0074",
        "patch": "@@ -87,6 +87,13 @@ bool CWallet::AddKeyPubKey(const CKey& secret, const CPubKey &pubkey)\n     AssertLockHeld(cs_wallet); // mapKeyMetadata\n     if (!CCryptoKeyStore::AddKeyPubKey(secret, pubkey))\n         return false;\n+\n+    // check if we need to remove from watch-only\n+    CScript script;\n+    script = GetScriptForDestination(pubkey.GetID());\n+    if (HaveWatchOnly(script))\n+        RemoveWatchOnly(script);\n+\n     if (!fFileBacked)\n         return true;\n     if (!IsCrypted()) {\n@@ -169,6 +176,20 @@ bool CWallet::AddWatchOnly(const CScript &dest)\n     return CWalletDB(strWalletFile).WriteWatchOnly(dest);\n }\n \n+bool CWallet::RemoveWatchOnly(const CScript &dest)\n+{\n+    AssertLockHeld(cs_wallet);\n+    if (!CCryptoKeyStore::RemoveWatchOnly(dest))\n+        return false;\n+    if (!HaveWatchOnly())\n+        NotifyWatchonlyChanged(false);\n+    if (fFileBacked)\n+        if (!CWalletDB(strWalletFile).EraseWatchOnly(dest))\n+            return false;\n+\n+    return true;\n+}\n+\n bool CWallet::LoadWatchOnly(const CScript &dest)\n {\n     return CCryptoKeyStore::AddWatchOnly(dest);"
      },
      {
        "sha": "1ccc29d3c8fb8457e1d3afb314389604fc2ec48b",
        "filename": "src/wallet.h",
        "status": "modified",
        "additions": 27,
        "deletions": 7,
        "changes": 34,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet.h?ref=ccca27a788fe1ae13661308243c20a1d7a3d0074",
        "patch": "@@ -222,6 +222,7 @@ class CWallet : public CCryptoKeyStore, public CWalletInterface\n \n     // Adds a watch-only address to the store, and saves it to disk.\n     bool AddWatchOnly(const CScript &dest);\n+    bool RemoveWatchOnly(const CScript &dest);\n     // Adds a watch-only address to the store, without saving it to disk (used by LoadWallet)\n     bool LoadWatchOnly(const CScript &dest);\n \n@@ -701,18 +702,37 @@ class CWalletTx : public CMerkleTx\n         return debit;\n     }\n \n-    CAmount GetCredit(bool fUseCache=true) const\n+    CAmount GetCredit(const isminefilter& filter) const\n     {\n         // Must wait until coinbase is safely deep enough in the chain before valuing it\n         if (IsCoinBase() && GetBlocksToMaturity() > 0)\n             return 0;\n \n-        // GetBalance can assume transactions in mapWallet won't change\n-        if (fUseCache && fCreditCached)\n-            return nCreditCached;\n-        nCreditCached = pwallet->GetCredit(*this, ISMINE_ALL);\n-        fCreditCached = true;\n-        return nCreditCached;\n+        int64_t credit = 0;\n+        if (filter & ISMINE_SPENDABLE)\n+        {\n+            // GetBalance can assume transactions in mapWallet won't change\n+            if (fCreditCached)\n+                credit += nCreditCached;\n+            else\n+            {\n+                nCreditCached = pwallet->GetCredit(*this, ISMINE_SPENDABLE);\n+                fCreditCached = true;\n+                credit += nCreditCached;\n+            }\n+        }\n+        if (filter & ISMINE_WATCH_ONLY)\n+        {\n+            if (fWatchCreditCached)\n+                credit += nWatchCreditCached;\n+            else\n+            {\n+                nWatchCreditCached = pwallet->GetCredit(*this, ISMINE_WATCH_ONLY);\n+                fWatchCreditCached = true;\n+                credit += nWatchCreditCached;\n+            }\n+        }\n+        return credit;\n     }\n \n     CAmount GetImmatureCredit(bool fUseCache=true) const"
      },
      {
        "sha": "a851db65cd86689d929688f3ea6dc11888c7e9c5",
        "filename": "src/walletdb.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/walletdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/walletdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/walletdb.cpp?ref=ccca27a788fe1ae13661308243c20a1d7a3d0074",
        "patch": "@@ -121,6 +121,12 @@ bool CWalletDB::WriteWatchOnly(const CScript &dest)\n     return Write(std::make_pair(std::string(\"watchs\"), dest), '1');\n }\n \n+bool CWalletDB::EraseWatchOnly(const CScript &dest)\n+{\n+    nWalletDBUpdated++;\n+    return Erase(std::make_pair(std::string(\"watchs\"), dest));\n+}\n+\n bool CWalletDB::WriteBestBlock(const CBlockLocator& locator)\n {\n     nWalletDBUpdated++;"
      },
      {
        "sha": "7ff41c7c8d4736626c3dec4c7992bf4a337e1e7a",
        "filename": "src/walletdb.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/walletdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ccca27a788fe1ae13661308243c20a1d7a3d0074/src/walletdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/walletdb.h?ref=ccca27a788fe1ae13661308243c20a1d7a3d0074",
        "patch": "@@ -96,6 +96,7 @@ class CWalletDB : public CDB\n     bool WriteCScript(const uint160& hash, const CScript& redeemScript);\n \n     bool WriteWatchOnly(const CScript &script);\n+    bool EraseWatchOnly(const CScript &script);\n \n     bool WriteBestBlock(const CBlockLocator& locator);\n     bool ReadBestBlock(CBlockLocator& locator);"
      }
    ]
  }
]