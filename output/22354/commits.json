[
  {
    "sha": "698e793a8083839aba5969535a5e0dc0139b9a0b",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2OThlNzkzYTgwODM4MzlhYmE1OTY5NTM1YTVlMGRjMDEzOWI5YTBi",
    "commit": {
      "author": {
        "name": "Matt Whitlock",
        "email": "bitcoin@mattwhitlock.name",
        "date": "2021-06-19T17:42:41Z"
      },
      "committer": {
        "name": "Matt Whitlock",
        "email": "bitcoin@mattwhitlock.name",
        "date": "2021-06-27T19:42:15Z"
      },
      "message": "contrib/init: (OpenRC) use -startupnotify to wait for startup completion\n\nWhen other initscripts depend on bitcoind, it's because their daemons\nwant to be able to invoke bitcoin-cli or to communicate with bitcoind\nvia RPC. That can't happen until some time after bitcoind has forked\ninto the background. The -startupnotify option was added in 090530cc24\n(#15367) to support exactly this use case, so let's use it.\n\nA straightforward and reliable way to wait for bitcoind to invoke its\n-startupnotify command is to make bitcoind hold a lock on a dummy file\nand release that lock via the -startupnotify command. The initscript's\nstart_post() function initially marks the service as inactive and forks\na subshell process into the background to wait for bitcoind to release\nthe lock file, which will happen when bitcoind either executes the\n-startupnotify command or dies. After acquiring and releasing the lock,\nthe subshell checks whether the pid file still exists and marks the\nservice as started or stopped appropriately.",
      "tree": {
        "sha": "aecd7aee071a67f755ea301b6d9db06057b01789",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/aecd7aee071a67f755ea301b6d9db06057b01789"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/698e793a8083839aba5969535a5e0dc0139b9a0b",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/698e793a8083839aba5969535a5e0dc0139b9a0b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/698e793a8083839aba5969535a5e0dc0139b9a0b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/698e793a8083839aba5969535a5e0dc0139b9a0b/comments",
    "author": {
      "login": "whitslack",
      "id": 797782,
      "node_id": "MDQ6VXNlcjc5Nzc4Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/797782?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/whitslack",
      "html_url": "https://github.com/whitslack",
      "followers_url": "https://api.github.com/users/whitslack/followers",
      "following_url": "https://api.github.com/users/whitslack/following{/other_user}",
      "gists_url": "https://api.github.com/users/whitslack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/whitslack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/whitslack/subscriptions",
      "organizations_url": "https://api.github.com/users/whitslack/orgs",
      "repos_url": "https://api.github.com/users/whitslack/repos",
      "events_url": "https://api.github.com/users/whitslack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/whitslack/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "whitslack",
      "id": 797782,
      "node_id": "MDQ6VXNlcjc5Nzc4Mg==",
      "avatar_url": "https://avatars.githubusercontent.com/u/797782?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/whitslack",
      "html_url": "https://github.com/whitslack",
      "followers_url": "https://api.github.com/users/whitslack/followers",
      "following_url": "https://api.github.com/users/whitslack/following{/other_user}",
      "gists_url": "https://api.github.com/users/whitslack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/whitslack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/whitslack/subscriptions",
      "organizations_url": "https://api.github.com/users/whitslack/orgs",
      "repos_url": "https://api.github.com/users/whitslack/repos",
      "events_url": "https://api.github.com/users/whitslack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/whitslack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "090530cc24054d6b4658752bb88f75a3b73eab5d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/090530cc24054d6b4658752bb88f75a3b73eab5d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/090530cc24054d6b4658752bb88f75a3b73eab5d"
      }
    ],
    "stats": {
      "total": 35,
      "additions": 31,
      "deletions": 4
    },
    "files": [
      {
        "sha": "a07ef8285e483cb9f59e591491bbf975b2317f3e",
        "filename": "contrib/init/bitcoind.openrc",
        "status": "modified",
        "additions": 31,
        "deletions": 4,
        "changes": 35,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/698e793a8083839aba5969535a5e0dc0139b9a0b/contrib/init/bitcoind.openrc",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/698e793a8083839aba5969535a5e0dc0139b9a0b/contrib/init/bitcoind.openrc",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/contrib/init/bitcoind.openrc?ref=698e793a8083839aba5969535a5e0dc0139b9a0b",
        "patch": "@@ -17,21 +17,28 @@ BITCOIND_GROUP=${BITCOIND_GROUP:-bitcoin}\n BITCOIND_BIN=${BITCOIND_BIN:-/usr/bin/bitcoind}\n BITCOIND_NICE=${BITCOIND_NICE:-${NICELEVEL:-0}}\n BITCOIND_OPTS=\"${BITCOIND_OPTS:-${BITCOIN_OPTS}}\"\n+: ${BITCOIND_STARTUPFILE:=${BITCOIND_PIDFILE%.pid}.startup}\n \n name=\"Bitcoin Core Daemon\"\n description=\"Bitcoin cryptocurrency P2P network daemon\"\n \n-command=\"/usr/bin/bitcoind\"\n-command_args=\"-pid=\\\"${BITCOIND_PIDFILE}\\\" \\\n-\t\t-conf=\\\"${BITCOIND_CONFIGFILE}\\\" \\\n-\t\t-datadir=\\\"${BITCOIND_DATADIR}\\\" \\\n+command=\"/usr/bin/flock\"\n+command_args=\"--no-fork\n+\t\t$(/usr/bin/printf '%q' \"${BITCOIND_STARTUPFILE}\") \\\n+\t\t/usr/bin/bitcoind\n+\t\t$(/usr/bin/printf '%s=%q ' \\\n+\t\t\t-pid \"${BITCOIND_PIDFILE}\" \\\n+\t\t\t-conf \"${BITCOIND_CONFIGFILE}\" \\\n+\t\t\t-datadir \"${BITCOIND_DATADIR}\" \\\n+\t\t\t-startupnotify \"flock -u 3\") \\\n \t\t-daemon \\\n \t\t${BITCOIND_OPTS}\"\n \n required_files=\"${BITCOIND_CONFIGFILE}\"\n start_stop_daemon_args=\"-u ${BITCOIND_USER} \\\n \t\t\t-N ${BITCOIND_NICE} -w 2000\"\n pidfile=\"${BITCOIND_PIDFILE}\"\n+in_background_fake=\"start\"\n \n # The retry schedule to use when stopping the daemon. Could be either\n # a timeout in seconds or multiple signal/timeout pairs (like\n@@ -47,6 +54,8 @@ depend() {\n # 2) that a directory for the pid exists and is writable\n # 3) ownership and permissions on the config file\n start_pre() {\n+\tyesno \"${IN_BACKGROUND}\" && return 0\n+\n \tcheckpath \\\n \t-d \\\n \t--mode 0750 \\\n@@ -67,6 +76,24 @@ start_pre() {\n \tcheckconfig || return 1\n }\n \n+start_post() {\n+\tyesno \"${IN_BACKGROUND}\" && return 0\n+\n+\t# mark service inactive if daemon startup is pending\n+\tif ! flock -n \"${BITCOIND_STARTUPFILE}\" true ; then\n+\t\tmark_service_inactive\n+\t\t# fork into background to await -startupnotify or failure\n+\t\t(\n+\t\t\tflock \"${BITCOIND_STARTUPFILE}\" true\n+\t\t\tif [ -e \"${BITCOIND_PIDFILE}\" ] ; then\n+\t\t\t\tIN_BACKGROUND=yes rc-service \"${SVCNAME}\" --quiet start\n+\t\t\telse\n+\t\t\t\trc-service \"${SVCNAME}\" --quiet zap\n+\t\t\tfi\n+\t\t) &\n+\tfi\n+}\n+\n checkconfig()\n {\n \tif ! grep -qs '^rpcpassword=' \"${BITCOIND_CONFIGFILE}\" ; then"
      }
    ]
  }
]