[
  {
    "sha": "09adcfdebb95e35b866982f1c678af5491711a92",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowOWFkY2ZkZWJiOTVlMzViODY2OTgyZjFjNjc4YWY1NDkxNzExYTky",
    "commit": {
      "author": {
        "name": "Evan Klitzke",
        "email": "evan@eklitzke.org",
        "date": "2018-03-29T06:05:13Z"
      },
      "committer": {
        "name": "Evan Klitzke",
        "email": "evan@eklitzke.org",
        "date": "2018-04-18T23:30:14Z"
      },
      "message": "Only give LevelDB a block cache if LevelDB will actually use it.\n\nOn systems that use mmap LevelDB does not use a block cache. On these systems we\ngive the memory instead to the write buffer, where it will be used more\neffectively.",
      "tree": {
        "sha": "2d460a7d9cf119ce338f8087047f49a71986d0c9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2d460a7d9cf119ce338f8087047f49a71986d0c9"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/09adcfdebb95e35b866982f1c678af5491711a92",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEr5FzGLjELREnIWJdFX78rLxkhCIFAlrX1QYACgkQFX78rLxk\nhCLa7hAAtKVRycb1gGW7UzoFq0b3wiMKty2BlWqXNUVIOdC6gUrcraEmjfjyWbZO\nOPdV4BYo6hRNZS0MYsYJDr/kmY1eof9iq69SeUeOcp8xaOYXnSpxtVy/IDejuWbv\noHyBkbviO+hni7l9Hd3/144wnwl1HaafzfIc+HhDei0AfKhSUFvPIZonYTFP3ny+\n8byuefcSaWncX8NBlvMbeXfc1JPLlmaa3gZvADgOpy7RyuwZwu1XaC7klP9PHo1Q\nC6Q+8tRqkOOLn7UxwaVymJtJP028po9bgWXblM1OyQGESXzexMbdtRxEAAbVtnrW\nsbmxfJ+W1kNqcEq2Sc0l8w1914OtOtx8Xx4MBzpNYxmul8dSHHwhhjNVNJl0ajqm\n5+KQMeI2QX7R+z5oNpy+DBtAbyfER/YfueBoZeday1L+wdzKxCPK+U0rv8Ui3Non\ngeus/88jHcVvhIgVX/ueH+qqVoPZv2r0EX0TNpcoCrfFEnHqV0lBh9mIS2NGjwva\n0hKv/i06xpyAPmZYFCJy9LGbJzT66ntFaKgUqq4XJIV9/dYollikRmiSZ2LjpkPY\n4UCfECCX1xNVuCqMmVbkkE2de+Y2iC3ZOB85n+xlBwjRQ/9Zi/kA7UPSbUSUr8gY\nMxVrkBeQnlqYygrKI/tAkBHihvSLZX13P0E5PQP3Q8tlVRL2IXQ=\n=FYfx\n-----END PGP SIGNATURE-----",
        "payload": "tree 2d460a7d9cf119ce338f8087047f49a71986d0c9\nparent 615f7c288414a89cd1dec1d67e0f84abe2fb4c6d\nauthor Evan Klitzke <evan@eklitzke.org> 1522303513 -0700\ncommitter Evan Klitzke <evan@eklitzke.org> 1524094214 -0700\n\nOnly give LevelDB a block cache if LevelDB will actually use it.\n\nOn systems that use mmap LevelDB does not use a block cache. On these systems we\ngive the memory instead to the write buffer, where it will be used more\neffectively.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/09adcfdebb95e35b866982f1c678af5491711a92",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/09adcfdebb95e35b866982f1c678af5491711a92",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/09adcfdebb95e35b866982f1c678af5491711a92/comments",
    "author": {
      "login": "eklitzke",
      "id": 2734,
      "node_id": "MDQ6VXNlcjI3MzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2734?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eklitzke",
      "html_url": "https://github.com/eklitzke",
      "followers_url": "https://api.github.com/users/eklitzke/followers",
      "following_url": "https://api.github.com/users/eklitzke/following{/other_user}",
      "gists_url": "https://api.github.com/users/eklitzke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eklitzke/subscriptions",
      "organizations_url": "https://api.github.com/users/eklitzke/orgs",
      "repos_url": "https://api.github.com/users/eklitzke/repos",
      "events_url": "https://api.github.com/users/eklitzke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eklitzke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "eklitzke",
      "id": 2734,
      "node_id": "MDQ6VXNlcjI3MzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2734?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eklitzke",
      "html_url": "https://github.com/eklitzke",
      "followers_url": "https://api.github.com/users/eklitzke/followers",
      "following_url": "https://api.github.com/users/eklitzke/following{/other_user}",
      "gists_url": "https://api.github.com/users/eklitzke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eklitzke/subscriptions",
      "organizations_url": "https://api.github.com/users/eklitzke/orgs",
      "repos_url": "https://api.github.com/users/eklitzke/repos",
      "events_url": "https://api.github.com/users/eklitzke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eklitzke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "615f7c288414a89cd1dec1d67e0f84abe2fb4c6d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/615f7c288414a89cd1dec1d67e0f84abe2fb4c6d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/615f7c288414a89cd1dec1d67e0f84abe2fb4c6d"
      }
    ],
    "stats": {
      "total": 30,
      "additions": 28,
      "deletions": 2
    },
    "files": [
      {
        "sha": "03d38939ffa7c9eae49c5c54a9e37755c69d3f8a",
        "filename": "src/dbwrapper.cpp",
        "status": "modified",
        "additions": 28,
        "deletions": 2,
        "changes": 30,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/09adcfdebb95e35b866982f1c678af5491711a92/src/dbwrapper.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/09adcfdebb95e35b866982f1c678af5491711a92/src/dbwrapper.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/dbwrapper.cpp?ref=09adcfdebb95e35b866982f1c678af5491711a92",
        "patch": "@@ -72,6 +72,20 @@ class CBitcoinLevelDBLogger : public leveldb::Logger {\n     }\n };\n \n+// Mmap is only used on 64-bit Unix systems.\n+constexpr bool LevelDBUsesMmap() {\n+#ifdef WIN32\n+    return false;\n+#else\n+    return sizeof(void*) >= 8;\n+#endif\n+}\n+\n+// Systems with mmap do not use the block cache.\n+constexpr bool LevelDBUsesBlockCache() {\n+    return !LevelDBUsesMmap();\n+}\n+\n static void SetMaxOpenFiles(leveldb::Options *options) {\n     // On most platforms the default setting of max_open_files (which is 1000)\n     // is optimal. On Windows using a large file count is OK because the handles\n@@ -100,8 +114,20 @@ static void SetMaxOpenFiles(leveldb::Options *options) {\n static leveldb::Options GetOptions(size_t nCacheSize)\n {\n     leveldb::Options options;\n-    options.block_cache = leveldb::NewLRUCache(nCacheSize / 2);\n-    options.write_buffer_size = nCacheSize / 4; // up to two write buffers may be held in memory simultaneously\n+\n+    // Only give LevelDB memory for the block cache if it will actually use it;\n+    // on systems mmap this space is not used by LevelDB (as it's already in the\n+    // page cache), so don't bother in that case.\n+    //\n+    // Up to two write buffers may be held in memory simultaneously, so set\n+    // write_buffer_size for the worst case.\n+    if (LevelDBUsesBlockCache()) {\n+        options.write_buffer_size = nCacheSize / 4;\n+        options.block_cache = leveldb::NewLRUCache(nCacheSize / 2);\n+    } else {\n+        options.write_buffer_size = nCacheSize / 2;\n+    }\n+\n     options.filter_policy = leveldb::NewBloomFilterPolicy(10);\n     options.compression = leveldb::kNoCompression;\n     options.info_log = new CBitcoinLevelDBLogger();"
      }
    ]
  },
  {
    "sha": "133534cf4cc056e6a8a2e9544dda015c5617ffc7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxMzM1MzRjZjRjYzA1NmU2YThhMmU5NTQ0ZGRhMDE1YzU2MTdmZmM3",
    "commit": {
      "author": {
        "name": "Evan Klitzke",
        "email": "evan@eklitzke.org",
        "date": "2018-04-19T19:20:48Z"
      },
      "committer": {
        "name": "Evan Klitzke",
        "email": "evan@eklitzke.org",
        "date": "2018-04-19T19:20:48Z"
      },
      "message": "fix braces",
      "tree": {
        "sha": "2c9bdf14bf3b3cecb52bee0695885983e2b63a9f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2c9bdf14bf3b3cecb52bee0695885983e2b63a9f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/133534cf4cc056e6a8a2e9544dda015c5617ffc7",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQEzBAABCAAdFiEEYlj7NGJl3hK98UMLenZjGAELgsMFAlrY7BQACgkQenZjGAEL\ngsPLWwf/WoGz9iaWPQLWSglkexyDH8Czx9eWX+ac3i3QDgoCT1HFZ3xI/LqkYh/v\n/uPE+iQ5uR8OD0LyJxqHFOn4gP4COgHU6puerHehQpzdr2otH17E25DlsoNlG09h\n5kggqRjESsCO2vRJZjFgaXBLWHwQFfmBsUZaTQWU9iYsh3o1Yxy8zJFxcRZZluNK\n2PvD9rNOBRJcB+05LTxagwF5slZRZNFI9XBNltf4W3ydPHiwRg0QOxmmlTyLdMUr\nAxCzQXnh523pMT/k8bmyagvPlZeeHpM6pncq0hwUEoDp5agiX0E85k23SENtrU5t\nyyeFAddEvAlpcYMB/mA0VNxKO6OR1Q==\n=OYDB\n-----END PGP SIGNATURE-----",
        "payload": "tree 2c9bdf14bf3b3cecb52bee0695885983e2b63a9f\nparent 09adcfdebb95e35b866982f1c678af5491711a92\nauthor Evan Klitzke <evan@eklitzke.org> 1524165648 -0700\ncommitter Evan Klitzke <evan@eklitzke.org> 1524165648 -0700\n\nfix braces\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/133534cf4cc056e6a8a2e9544dda015c5617ffc7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/133534cf4cc056e6a8a2e9544dda015c5617ffc7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/133534cf4cc056e6a8a2e9544dda015c5617ffc7/comments",
    "author": {
      "login": "eklitzke",
      "id": 2734,
      "node_id": "MDQ6VXNlcjI3MzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2734?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eklitzke",
      "html_url": "https://github.com/eklitzke",
      "followers_url": "https://api.github.com/users/eklitzke/followers",
      "following_url": "https://api.github.com/users/eklitzke/following{/other_user}",
      "gists_url": "https://api.github.com/users/eklitzke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eklitzke/subscriptions",
      "organizations_url": "https://api.github.com/users/eklitzke/orgs",
      "repos_url": "https://api.github.com/users/eklitzke/repos",
      "events_url": "https://api.github.com/users/eklitzke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eklitzke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "eklitzke",
      "id": 2734,
      "node_id": "MDQ6VXNlcjI3MzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2734?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/eklitzke",
      "html_url": "https://github.com/eklitzke",
      "followers_url": "https://api.github.com/users/eklitzke/followers",
      "following_url": "https://api.github.com/users/eklitzke/following{/other_user}",
      "gists_url": "https://api.github.com/users/eklitzke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/eklitzke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/eklitzke/subscriptions",
      "organizations_url": "https://api.github.com/users/eklitzke/orgs",
      "repos_url": "https://api.github.com/users/eklitzke/repos",
      "events_url": "https://api.github.com/users/eklitzke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/eklitzke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "09adcfdebb95e35b866982f1c678af5491711a92",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/09adcfdebb95e35b866982f1c678af5491711a92",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/09adcfdebb95e35b866982f1c678af5491711a92"
      }
    ],
    "stats": {
      "total": 6,
      "additions": 4,
      "deletions": 2
    },
    "files": [
      {
        "sha": "4730e9798a2bb48bbb9529f719a619cfa3fc9528",
        "filename": "src/dbwrapper.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 2,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/133534cf4cc056e6a8a2e9544dda015c5617ffc7/src/dbwrapper.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/133534cf4cc056e6a8a2e9544dda015c5617ffc7/src/dbwrapper.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/dbwrapper.cpp?ref=133534cf4cc056e6a8a2e9544dda015c5617ffc7",
        "patch": "@@ -82,11 +82,13 @@ constexpr bool LevelDBUsesMmap() {\n }\n \n // Systems with mmap do not use the block cache.\n-constexpr bool LevelDBUsesBlockCache() {\n+constexpr bool LevelDBUsesBlockCache()\n+{\n     return !LevelDBUsesMmap();\n }\n \n-static void SetMaxOpenFiles(leveldb::Options *options) {\n+static void SetMaxOpenFiles(leveldb::Options *options)\n+{\n     // On most platforms the default setting of max_open_files (which is 1000)\n     // is optimal. On Windows using a large file count is OK because the handles\n     // do not interfere with select() loops. On 64-bit Unix hosts this value is"
      }
    ]
  }
]