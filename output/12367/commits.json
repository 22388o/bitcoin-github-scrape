[
  {
    "sha": "1c9394ad477d0c1ca0ab1caa6024a7e70c125d15",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxYzkzOTRhZDQ3N2QwYzFjYTBhYjFjYWE2MDI0YTdlNzBjMTI1ZDE1",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2018-02-06T18:32:53Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2018-02-06T20:13:59Z"
      },
      "message": "Fix fast-shutdown hang on ThreadImport+GenesisWait\n\nIf the user somehow manages to get into ShutdownRequested before\nThreadImport gets to ActivateBestChain() we may hang waiting on\ncondvar_GenesisWait forever. A simple wait_for and\nShutdownRequested resolves this case.",
      "tree": {
        "sha": "a5a75ace2bc0447d1b85b03ab4ea9ca8e61f0d33",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a5a75ace2bc0447d1b85b03ab4ea9ca8e61f0d33"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1c9394ad477d0c1ca0ab1caa6024a7e70c125d15",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1c9394ad477d0c1ca0ab1caa6024a7e70c125d15",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1c9394ad477d0c1ca0ab1caa6024a7e70c125d15",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1c9394ad477d0c1ca0ab1caa6024a7e70c125d15/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1462bde767a121233118c04c5629bd9de1ba0f16",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1462bde767a121233118c04c5629bd9de1ba0f16",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1462bde767a121233118c04c5629bd9de1ba0f16"
      }
    ],
    "stats": {
      "total": 11,
      "additions": 9,
      "deletions": 2
    },
    "files": [
      {
        "sha": "14dd8fc8ac3df6bb5de4cda6e10761ce81cf1d1e",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 2,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1c9394ad477d0c1ca0ab1caa6024a7e70c125d15/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1c9394ad477d0c1ca0ab1caa6024a7e70c125d15/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=1c9394ad477d0c1ca0ab1caa6024a7e70c125d15",
        "patch": "@@ -1645,12 +1645,19 @@ bool AppInitMain()\n     // Wait for genesis block to be processed\n     {\n         WaitableLock lock(cs_GenesisWait);\n-        while (!fHaveGenesis) {\n-            condvar_GenesisWait.wait(lock);\n+        // We previously could hang here if StartShutdown() is called prior to\n+        // ThreadImport getting started, so instead we just wait on a timer to\n+        // check ShutdownRequested() regularly.\n+        while (!fHaveGenesis && !ShutdownRequested()) {\n+            condvar_GenesisWait.wait_for(lock, std::chrono::milliseconds(500));\n         }\n         uiInterface.NotifyBlockTip.disconnect(BlockNotifyGenesisWait);\n     }\n \n+    if (ShutdownRequested()) {\n+        return false;\n+    }\n+\n     // ********************************************************* Step 11: start node\n \n     int chain_active_height;"
      }
    ]
  },
  {
    "sha": "dd2de47c6288654abb2c3eef29edcd1cc5f39fc9",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkZDJkZTQ3YzYyODg2NTRhYmIyYzNlZWYyOWVkY2QxY2M1ZjM5ZmM5",
    "commit": {
      "author": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2018-02-06T18:38:54Z"
      },
      "committer": {
        "name": "Matt Corallo",
        "email": "git@bluematt.me",
        "date": "2018-02-06T20:14:02Z"
      },
      "message": "Fix fast-shutdown crash if genesis block was not loaded\n\nIf the ShutdownRequested() check at the top of ActivateBestChain()\nreturns false during initial genesis block load we will fail an\nassertion in UTXO DB flush as the best block hash IsNull(). To work\naround this, we move the check until after one round of\nActivateBestChainStep(), ensuring the genesis block gets connected.",
      "tree": {
        "sha": "9f20e429cda9976828ac8ffbd30f21d64b025018",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9f20e429cda9976828ac8ffbd30f21d64b025018"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/dd2de47c6288654abb2c3eef29edcd1cc5f39fc9",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dd2de47c6288654abb2c3eef29edcd1cc5f39fc9",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/dd2de47c6288654abb2c3eef29edcd1cc5f39fc9",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dd2de47c6288654abb2c3eef29edcd1cc5f39fc9/comments",
    "author": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "TheBlueMatt",
      "id": 649246,
      "node_id": "MDQ6VXNlcjY0OTI0Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/649246?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/TheBlueMatt",
      "html_url": "https://github.com/TheBlueMatt",
      "followers_url": "https://api.github.com/users/TheBlueMatt/followers",
      "following_url": "https://api.github.com/users/TheBlueMatt/following{/other_user}",
      "gists_url": "https://api.github.com/users/TheBlueMatt/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/TheBlueMatt/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/TheBlueMatt/subscriptions",
      "organizations_url": "https://api.github.com/users/TheBlueMatt/orgs",
      "repos_url": "https://api.github.com/users/TheBlueMatt/repos",
      "events_url": "https://api.github.com/users/TheBlueMatt/events{/privacy}",
      "received_events_url": "https://api.github.com/users/TheBlueMatt/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1c9394ad477d0c1ca0ab1caa6024a7e70c125d15",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1c9394ad477d0c1ca0ab1caa6024a7e70c125d15",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1c9394ad477d0c1ca0ab1caa6024a7e70c125d15"
      }
    ],
    "stats": {
      "total": 10,
      "additions": 7,
      "deletions": 3
    },
    "files": [
      {
        "sha": "4315ec1814c2a23ecbda2f5a6524b197f7d78da7",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 3,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd2de47c6288654abb2c3eef29edcd1cc5f39fc9/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd2de47c6288654abb2c3eef29edcd1cc5f39fc9/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=dd2de47c6288654abb2c3eef29edcd1cc5f39fc9",
        "patch": "@@ -2581,9 +2581,6 @@ bool CChainState::ActivateBestChain(CValidationState &state, const CChainParams&\n             SyncWithValidationInterfaceQueue();\n         }\n \n-        if (ShutdownRequested())\n-            break;\n-\n         const CBlockIndex *pindexFork;\n         bool fInitialDownload;\n         {\n@@ -2630,6 +2627,13 @@ bool CChainState::ActivateBestChain(CValidationState &state, const CChainParams&\n         }\n \n         if (nStopAtHeight && pindexNewTip && pindexNewTip->nHeight >= nStopAtHeight) StartShutdown();\n+\n+        // We check shutdown only after giving ActivateBestChainStep a chance to run once so that we\n+        // never shutdown before connecting the genesis block during LoadChainTip(). Previously this\n+        // caused an assert() failure during shutdown in such cases as the UTXO DB flushing checks\n+        // that the best block hash is non-null.\n+        if (ShutdownRequested())\n+            break;\n     } while (pindexNewTip != pindexMostWork);\n     CheckBlockIndex(chainparams.GetConsensus());\n "
      }
    ]
  }
]