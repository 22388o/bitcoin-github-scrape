[
  {
    "sha": "c5ec9ce334d26cb57a659d62264612c9f02f025f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjNWVjOWNlMzM0ZDI2Y2I1N2E2NTlkNjIyNjQ2MTJjOWYwMmYwMjVm",
    "commit": {
      "author": {
        "name": "NicolasDorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2016-07-18T06:50:09Z"
      },
      "committer": {
        "name": "NicolasDorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2016-07-21T09:48:52Z"
      },
      "message": "Wallet: Minimum output value depends on fee instead of minTxRelayFee",
      "tree": {
        "sha": "9c1adc0632e634da6d6216cfc33a4f85e3c89168",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/9c1adc0632e634da6d6216cfc33a4f85e3c89168"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c5ec9ce334d26cb57a659d62264612c9f02f025f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c5ec9ce334d26cb57a659d62264612c9f02f025f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c5ec9ce334d26cb57a659d62264612c9f02f025f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c5ec9ce334d26cb57a659d62264612c9f02f025f/comments",
    "author": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "238300b39894ef3a79540687d127a928d7b3c53c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/238300b39894ef3a79540687d127a928d7b3c53c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/238300b39894ef3a79540687d127a928d7b3c53c"
      }
    ],
    "stats": {
      "total": 33,
      "additions": 24,
      "deletions": 9
    },
    "files": [
      {
        "sha": "d767d25451394ebecf6c9edb87f9cb0227d8e82c",
        "filename": "src/qt/coincontroldialog.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 3,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c5ec9ce334d26cb57a659d62264612c9f02f025f/src/qt/coincontroldialog.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c5ec9ce334d26cb57a659d62264612c9f02f025f/src/qt/coincontroldialog.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/qt/coincontroldialog.cpp?ref=c5ec9ce334d26cb57a659d62264612c9f02f025f",
        "patch": "@@ -456,6 +456,7 @@ void CoinControlDialog::updateLabels(WalletModel *model, QDialog* dialog)\n     if (!model)\n         return;\n \n+    CFeeRate dustRate = CWallet::GetDustRate();\n     // nPayAmount\n     CAmount nPayAmount = 0;\n     bool fDust = false;\n@@ -468,7 +469,7 @@ void CoinControlDialog::updateLabels(WalletModel *model, QDialog* dialog)\n         {\n             CTxOut txout(amount, (CScript)std::vector<unsigned char>(24, 0));\n             txDummy.vout.push_back(txout);\n-            if (txout.IsDust(::minRelayTxFee))\n+            if (txout.IsDust(dustRate))\n                fDust = true;\n         }\n     }\n@@ -585,10 +586,10 @@ void CoinControlDialog::updateLabels(WalletModel *model, QDialog* dialog)\n             if (nChange > 0 && nChange < MIN_CHANGE)\n             {\n                 CTxOut txout(nChange, (CScript)std::vector<unsigned char>(24, 0));\n-                if (txout.IsDust(::minRelayTxFee))\n+                if (txout.IsDust(dustRate))\n                 {\n                     if (CoinControlDialog::fSubtractFeeFromAmount) // dust-change will be raised until no dust\n-                        nChange = txout.GetDustThreshold(::minRelayTxFee);\n+                        nChange = txout.GetDustThreshold(dustRate);\n                     else\n                     {\n                         nPayFee += nChange;"
      },
      {
        "sha": "1019a6ba2a79f76b740043a73a07cf12f3e194bb",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 15,
        "deletions": 6,
        "changes": 21,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c5ec9ce334d26cb57a659d62264612c9f02f025f/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c5ec9ce334d26cb57a659d62264612c9f02f025f/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=c5ec9ce334d26cb57a659d62264612c9f02f025f",
        "patch": "@@ -2094,9 +2094,18 @@ bool CWallet::FundTransaction(CMutableTransaction& tx, CAmount& nFeeRet, bool ov\n     return true;\n }\n \n+CFeeRate CWallet::GetDustRate()\n+{\n+    CFeeRate minValueRate = mempool.GetMinFee(GetArg(\"-maxmempool\", DEFAULT_MAX_MEMPOOL_SIZE) * 1000000);\n+    if(minValueRate < ::minRelayTxFee)\n+        minValueRate = ::minRelayTxFee;\n+    return minValueRate;\n+}\n+\n bool CWallet::CreateTransaction(const vector<CRecipient>& vecSend, CWalletTx& wtxNew, CReserveKey& reservekey, CAmount& nFeeRet,\n                                 int& nChangePosInOut, std::string& strFailReason, const CCoinControl* coinControl, bool sign)\n {\n+    CFeeRate dustRate = CWallet::GetDustRate();\n     CAmount nValue = 0;\n     int nChangePosRequest = nChangePosInOut;\n     unsigned int nSubtractFeeFromAmount = 0;\n@@ -2190,7 +2199,7 @@ bool CWallet::CreateTransaction(const vector<CRecipient>& vecSend, CWalletTx& wt\n                         }\n                     }\n \n-                    if (txout.IsDust(::minRelayTxFee))\n+                    if (txout.IsDust(dustRate))\n                     {\n                         if (recipient.fSubtractFeeFromAmount && nFeeRet > 0)\n                         {\n@@ -2264,16 +2273,16 @@ bool CWallet::CreateTransaction(const vector<CRecipient>& vecSend, CWalletTx& wt\n                     // We do not move dust-change to fees, because the sender would end up paying more than requested.\n                     // This would be against the purpose of the all-inclusive feature.\n                     // So instead we raise the change and deduct from the recipient.\n-                    if (nSubtractFeeFromAmount > 0 && newTxOut.IsDust(::minRelayTxFee))\n+                    if (nSubtractFeeFromAmount > 0 && newTxOut.IsDust(dustRate))\n                     {\n-                        CAmount nDust = newTxOut.GetDustThreshold(::minRelayTxFee) - newTxOut.nValue;\n+                        CAmount nDust = newTxOut.GetDustThreshold(dustRate) - newTxOut.nValue;\n                         newTxOut.nValue += nDust; // raise change until no more dust\n                         for (unsigned int i = 0; i < vecSend.size(); i++) // subtract from first recipient\n                         {\n                             if (vecSend[i].fSubtractFeeFromAmount)\n                             {\n                                 txNew.vout[i].nValue -= nDust;\n-                                if (txNew.vout[i].IsDust(::minRelayTxFee))\n+                                if (txNew.vout[i].IsDust(dustRate))\n                                 {\n                                     strFailReason = _(\"The transaction amount is too small to send after the fee has been deducted\");\n                                     return false;\n@@ -2285,7 +2294,7 @@ bool CWallet::CreateTransaction(const vector<CRecipient>& vecSend, CWalletTx& wt\n \n                     // Never create dust outputs; if we would, just\n                     // add the dust to the fee.\n-                    if (newTxOut.IsDust(::minRelayTxFee))\n+                    if (newTxOut.IsDust(dustRate))\n                     {\n                         nChangePosInOut = -1;\n                         nFeeRet += nChange;\n@@ -2383,7 +2392,7 @@ bool CWallet::CreateTransaction(const vector<CRecipient>& vecSend, CWalletTx& wt\n \n                 // If we made it here and we aren't even able to meet the relay fee on the next pass, give up\n                 // because we must be at the maximum allowed fee.\n-                if (nFeeNeeded < ::minRelayTxFee.GetFee(nBytes))\n+                if (nFeeNeeded < dustRate.GetFee(nBytes))\n                 {\n                     strFailReason = _(\"Transaction too large for fee policy\");\n                     return false;"
      },
      {
        "sha": "36438e07d16929d10dfe4822724b8c0f0cf837a7",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c5ec9ce334d26cb57a659d62264612c9f02f025f/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c5ec9ce334d26cb57a659d62264612c9f02f025f/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=c5ec9ce334d26cb57a659d62264612c9f02f025f",
        "patch": "@@ -772,6 +772,11 @@ class CWallet : public CCryptoKeyStore, public CValidationInterface\n      */\n     static CAmount GetRequiredFee(unsigned int nTxBytes);\n \n+    /**\n+     * Return the rate below which wallet's outputs should be considered dust.\n+     */\n+    static CFeeRate GetDustRate();\n+\n     bool NewKeyPool();\n     bool TopUpKeyPool(unsigned int kpSize = 0);\n     void ReserveKeyFromKeyPool(int64_t& nIndex, CKeyPool& keypool);"
      }
    ]
  }
]