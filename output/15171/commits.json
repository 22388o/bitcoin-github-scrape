[
  {
    "sha": "2a9d4e583833b468f7743f85a96bbb94ad439d54",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyYTlkNGU1ODM4MzNiNDY4Zjc3NDNmODVhOTZiYmI5NGFkNDM5ZDU0",
    "commit": {
      "author": {
        "name": "Ben Woosley",
        "email": "ben.woosley@gmail.com",
        "date": "2019-01-15T02:24:24Z"
      },
      "committer": {
        "name": "Ben Woosley",
        "email": "ben.woosley@gmail.com",
        "date": "2019-01-15T23:27:27Z"
      },
      "message": "test: Wait before cleanup on exit\n\nThis operation can fail due to log file contention, retrying should reduce this occurance.\n\n[00:27:35] Traceback (most recent call last):\n[00:27:35]   File \"C:\\projects\\bitcoin/test/functional/feature_notifications.py\", line 88, in <module>\n[00:27:35]     NotificationsTest().main()\n[00:27:35]   File \"C:\\projects\\bitcoin\\test\\functional\\test_framework\\test_framework.py\", line 223, in main\n[00:27:35]     shutil.rmtree(self.options.tmpdir)\n[00:27:35]   File \"C:\\Python37-x64\\lib\\shutil.py\", line 507, in rmtree\n[00:27:35]     return _rmtree_unsafe(path, onerror)\n[00:27:35]   File \"C:\\Python37-x64\\lib\\shutil.py\", line 386, in _rmtree_unsafe\n[00:27:35]     _rmtree_unsafe(fullname, onerror)\n[00:27:35]   File \"C:\\Python37-x64\\lib\\shutil.py\", line 386, in _rmtree_unsafe\n[00:27:35]     _rmtree_unsafe(fullname, onerror)\n[00:27:35]   File \"C:\\Python37-x64\\lib\\shutil.py\", line 391, in _rmtree_unsafe\n[00:27:35]     onerror(os.unlink, fullname, sys.exc_info())\n[00:27:35]   File \"C:\\Python37-x64\\lib\\shutil.py\", line 389, in _rmtree_unsafe\n[00:27:35]     os.unlink(fullname)\n[00:27:35] PermissionError: [WinError 32] The process cannot access the file because it is being used by another process: 'C:\\\\Users\\\\appveyor\\\\AppData\\\\Local\\\\Temp\\\\1\\\\test_runner_20190115_020102\\\\feature_notifications_45\\\\node0\\\\regtest\\\\debug.log'\nhttps://ci.appveyor.com/project/DrahtBot/bitcoin/builds/21618398",
      "tree": {
        "sha": "186f0fe89680e08e330bdf80928761e5992b9de8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/186f0fe89680e08e330bdf80928761e5992b9de8"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2a9d4e583833b468f7743f85a96bbb94ad439d54",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE+XLHXoy4Dim7e8hvTYykuhgECQYFAlw+bGAACgkQTYykuhgE\nCQYZTg/7Bc2jb1nz4ZdShqSCyPU9nrxDxPV+yK89aJ/bBdljdZytGLm9iYojabUe\nU6el+u/0Jw6nge41f4n2BEGca9IYZ1BOaJLXYLqCkN9mt/TGOk4fFB70goNQgcyO\npl1t3KJodmlGnW+b9KB6V8V4Cqo1eDBd4qiqMu+snMDs6lLtBOXxQCwPpoDKbp3d\nMmaKIi0FXoi7ojNKorYEKCOgCEBZBHelpgDG620IgUenAwbvNT0aIcNx5KJUTN6f\nkdP3gTXBhjpeHFazDTZz8ZfDiH9T4cHYTNy91K+lYrzLA5qosA0YMnfO6k+v0kaW\ncFfT+kTiwT0s8iG/Vg7s5pFperuPp04YUYilVbFLv58V9HlREBV3PKFWlbXMbYlp\nOL1Im0MTkK10LggdXKXJ/7h0ZOKL7A6Ql1+JbDMKZN15I57fdEjSHr/k3yjMFaMz\n68o/P685Ew/QJ3pPwn8eioQ3sVyKYKCMR0QF6e8SVGmAWOiNFmJMd3bviU6szY7V\nMJTbxx3C8jax7gadmu9QpHO+9orapk90OQHDWbM154F/6ir0eGOmCe3WTiLog2YF\nIQd2gmH93qyinveFMiNM6BEqLmySy7SiltBNZFd5a6r8AsRYkmXSLPwryfvFS/iL\n5jEC3gJO6vXcQFOYLUJXbdXM2guJ7cNMVU3xrbc+WtL7nCLwDlM=\n=Ja3t\n-----END PGP SIGNATURE-----",
        "payload": "tree 186f0fe89680e08e330bdf80928761e5992b9de8\nparent cf0c67b62c2037dc9e70ea84ffee3b205a9b1bef\nauthor Ben Woosley <ben.woosley@gmail.com> 1547519064 -0800\ncommitter Ben Woosley <ben.woosley@gmail.com> 1547594847 -0800\n\ntest: Wait before cleanup on exit\n\nThis operation can fail due to log file contention, retrying should reduce this occurance.\n\n[00:27:35] Traceback (most recent call last):\n[00:27:35]   File \"C:\\projects\\bitcoin/test/functional/feature_notifications.py\", line 88, in <module>\n[00:27:35]     NotificationsTest().main()\n[00:27:35]   File \"C:\\projects\\bitcoin\\test\\functional\\test_framework\\test_framework.py\", line 223, in main\n[00:27:35]     shutil.rmtree(self.options.tmpdir)\n[00:27:35]   File \"C:\\Python37-x64\\lib\\shutil.py\", line 507, in rmtree\n[00:27:35]     return _rmtree_unsafe(path, onerror)\n[00:27:35]   File \"C:\\Python37-x64\\lib\\shutil.py\", line 386, in _rmtree_unsafe\n[00:27:35]     _rmtree_unsafe(fullname, onerror)\n[00:27:35]   File \"C:\\Python37-x64\\lib\\shutil.py\", line 386, in _rmtree_unsafe\n[00:27:35]     _rmtree_unsafe(fullname, onerror)\n[00:27:35]   File \"C:\\Python37-x64\\lib\\shutil.py\", line 391, in _rmtree_unsafe\n[00:27:35]     onerror(os.unlink, fullname, sys.exc_info())\n[00:27:35]   File \"C:\\Python37-x64\\lib\\shutil.py\", line 389, in _rmtree_unsafe\n[00:27:35]     os.unlink(fullname)\n[00:27:35] PermissionError: [WinError 32] The process cannot access the file because it is being used by another process: 'C:\\\\Users\\\\appveyor\\\\AppData\\\\Local\\\\Temp\\\\1\\\\test_runner_20190115_020102\\\\feature_notifications_45\\\\node0\\\\regtest\\\\debug.log'\nhttps://ci.appveyor.com/project/DrahtBot/bitcoin/builds/21618398\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2a9d4e583833b468f7743f85a96bbb94ad439d54",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/2a9d4e583833b468f7743f85a96bbb94ad439d54",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2a9d4e583833b468f7743f85a96bbb94ad439d54/comments",
    "author": {
      "login": "Empact",
      "id": 5470,
      "node_id": "MDQ6VXNlcjU0NzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Empact",
      "html_url": "https://github.com/Empact",
      "followers_url": "https://api.github.com/users/Empact/followers",
      "following_url": "https://api.github.com/users/Empact/following{/other_user}",
      "gists_url": "https://api.github.com/users/Empact/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Empact/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
      "organizations_url": "https://api.github.com/users/Empact/orgs",
      "repos_url": "https://api.github.com/users/Empact/repos",
      "events_url": "https://api.github.com/users/Empact/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Empact/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "Empact",
      "id": 5470,
      "node_id": "MDQ6VXNlcjU0NzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5470?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Empact",
      "html_url": "https://github.com/Empact",
      "followers_url": "https://api.github.com/users/Empact/followers",
      "following_url": "https://api.github.com/users/Empact/following{/other_user}",
      "gists_url": "https://api.github.com/users/Empact/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Empact/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Empact/subscriptions",
      "organizations_url": "https://api.github.com/users/Empact/orgs",
      "repos_url": "https://api.github.com/users/Empact/repos",
      "events_url": "https://api.github.com/users/Empact/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Empact/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "cf0c67b62c2037dc9e70ea84ffee3b205a9b1bef",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/cf0c67b62c2037dc9e70ea84ffee3b205a9b1bef",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/cf0c67b62c2037dc9e70ea84ffee3b205a9b1bef"
      }
    ],
    "stats": {
      "total": 12,
      "additions": 11,
      "deletions": 1
    },
    "files": [
      {
        "sha": "d29aed9a2aa9a3a38855567bc1d9758159843e1e",
        "filename": "test/functional/test_framework/test_framework.py",
        "status": "modified",
        "additions": 11,
        "deletions": 1,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2a9d4e583833b468f7743f85a96bbb94ad439d54/test/functional/test_framework/test_framework.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2a9d4e583833b468f7743f85a96bbb94ad439d54/test/functional/test_framework/test_framework.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_framework/test_framework.py?ref=2a9d4e583833b468f7743f85a96bbb94ad439d54",
        "patch": "@@ -32,6 +32,7 @@\n     set_node_times,\n     sync_blocks,\n     sync_mempools,\n+    wait_until,\n )\n \n class TestStatus(Enum):\n@@ -220,7 +221,16 @@ def main(self):\n             exit_code = TEST_EXIT_FAILED\n         logging.shutdown()\n         if cleanup_tree_on_exit:\n-            shutil.rmtree(self.options.tmpdir)\n+            # retry when rmtree fails due to file access by another process, e.g. on windows\n+            def no_permission_error(predicate, action):\n+                try:\n+                    predicate()\n+                except PermissionError as e:\n+                    self.log.warning(\"Failed {} with: {}\".format(action, e))\n+                    return False\n+                return True\n+            wait_until(lambda: no_permission_error(lambda: shutil.rmtree(self.options.tmpdir), \"clean up on exit\"), timeout=1)\n+\n         sys.exit(exit_code)\n \n     # Methods to override in subclass test scripts."
      }
    ]
  }
]