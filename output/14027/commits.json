[
  {
    "sha": "66b3fc543706aad1aaccc403b4ee08f65fa5d17b",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2NmIzZmM1NDM3MDZhYWQxYWFjY2M0MDNiNGVlMDhmNjVmYTVkMTdi",
    "commit": {
      "author": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2018-08-22T23:29:01Z"
      },
      "committer": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2018-08-23T10:10:12Z"
      },
      "message": "Skip stale tip checking if outbound connections are off or if reindexing.",
      "tree": {
        "sha": "a3e42c57603ce50c6e7fba55629f68af7c287fec",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a3e42c57603ce50c6e7fba55629f68af7c287fec"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/66b3fc543706aad1aaccc403b4ee08f65fa5d17b",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/66b3fc543706aad1aaccc403b4ee08f65fa5d17b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/66b3fc543706aad1aaccc403b4ee08f65fa5d17b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/66b3fc543706aad1aaccc403b4ee08f65fa5d17b/comments",
    "author": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "271b379e636afa419c5208cb462c07090490266c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/271b379e636afa419c5208cb462c07090490266c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/271b379e636afa419c5208cb462c07090490266c"
      }
    ],
    "stats": {
      "total": 15,
      "additions": 10,
      "deletions": 5
    },
    "files": [
      {
        "sha": "e074dbb624ae2350d296cdf413857a77604d0e7e",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/66b3fc543706aad1aaccc403b4ee08f65fa5d17b/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/66b3fc543706aad1aaccc403b4ee08f65fa5d17b/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=66b3fc543706aad1aaccc403b4ee08f65fa5d17b",
        "patch": "@@ -149,6 +149,7 @@ class CConnman\n         nLocalServices = connOptions.nLocalServices;\n         nMaxConnections = connOptions.nMaxConnections;\n         nMaxOutbound = std::min(connOptions.nMaxOutbound, connOptions.nMaxConnections);\n+        m_use_addrman_outgoing = connOptions.m_use_addrman_outgoing;\n         nMaxAddnode = connOptions.nMaxAddnode;\n         nMaxFeeler = connOptions.nMaxFeeler;\n         nBestHeight = connOptions.nBestHeight;\n@@ -174,6 +175,7 @@ class CConnman\n     void Stop();\n     void Interrupt();\n     bool GetNetworkActive() const { return fNetworkActive; };\n+    bool GetUseAddrmanOutgoing() const { return m_use_addrman_outgoing; };\n     void SetNetworkActive(bool active);\n     void OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound = nullptr, const char *strDest = nullptr, bool fOneShot = false, bool fFeeler = false, bool manual_connection = false);\n     bool CheckIncomingNonce(uint64_t nonce);\n@@ -416,6 +418,7 @@ class CConnman\n     int nMaxOutbound;\n     int nMaxAddnode;\n     int nMaxFeeler;\n+    bool m_use_addrman_outgoing;\n     std::atomic<int> nBestHeight;\n     CClientUIInterface* clientInterface;\n     NetEventsInterface* m_msgproc;"
      },
      {
        "sha": "2a0ba3970df70634429d83a44f8e6c5630031661",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 4,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/66b3fc543706aad1aaccc403b4ee08f65fa5d17b/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/66b3fc543706aad1aaccc403b4ee08f65fa5d17b/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=66b3fc543706aad1aaccc403b4ee08f65fa5d17b",
        "patch": "@@ -3166,8 +3166,6 @@ void PeerLogicValidation::EvictExtraOutboundPeers(int64_t time_in_seconds)\n         NodeId worst_peer = -1;\n         int64_t oldest_block_announcement = std::numeric_limits<int64_t>::max();\n \n-        LOCK(cs_main);\n-\n         connman->ForEachNode([&](CNode* pnode) {\n             AssertLockHeld(cs_main);\n \n@@ -3215,17 +3213,18 @@ void PeerLogicValidation::EvictExtraOutboundPeers(int64_t time_in_seconds)\n \n void PeerLogicValidation::CheckForStaleTipAndEvictPeers(const Consensus::Params &consensusParams)\n {\n+    LOCK(cs_main);\n+\n     if (connman == nullptr) return;\n \n     int64_t time_in_seconds = GetTime();\n \n     EvictExtraOutboundPeers(time_in_seconds);\n \n     if (time_in_seconds > m_stale_tip_check_time) {\n-        LOCK(cs_main);\n         // Check whether our tip is stale, and if so, allow using an extra\n         // outbound peer\n-        if (TipMayBeStale(consensusParams)) {\n+        if (!fImporting && !fReindex && connman->GetNetworkActive() && connman->GetUseAddrmanOutgoing() && TipMayBeStale(consensusParams)) {\n             LogPrintf(\"Potential stale tip detected, will try using extra outbound peer (last tip update: %d seconds ago)\\n\", time_in_seconds - g_last_tip_update);\n             connman->SetTryNewOutboundPeer(true);\n         } else if (connman->GetTryNewOutboundPeer()) {"
      },
      {
        "sha": "01b8e97075612d0444bf2dcb53f635f16c4b21f4",
        "filename": "src/net_processing.h",
        "status": "modified",
        "additions": 4,
        "deletions": 1,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/66b3fc543706aad1aaccc403b4ee08f65fa5d17b/src/net_processing.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/66b3fc543706aad1aaccc403b4ee08f65fa5d17b/src/net_processing.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.h?ref=66b3fc543706aad1aaccc403b4ee08f65fa5d17b",
        "patch": "@@ -9,6 +9,9 @@\n #include <net.h>\n #include <validationinterface.h>\n #include <consensus/params.h>\n+#include <sync.h>\n+\n+extern CCriticalSection cs_main;\n \n /** Default for -maxorphantx, maximum number of orphan transactions kept in memory */\n static const unsigned int DEFAULT_MAX_ORPHAN_TRANSACTIONS = 100;\n@@ -65,7 +68,7 @@ class PeerLogicValidation final : public CValidationInterface, public NetEventsI\n     /** Evict extra outbound peers. If we think our tip may be stale, connect to an extra outbound */\n     void CheckForStaleTipAndEvictPeers(const Consensus::Params &consensusParams);\n     /** If we have extra outbound peers, try to disconnect the one with the oldest block announcement */\n-    void EvictExtraOutboundPeers(int64_t time_in_seconds);\n+    void EvictExtraOutboundPeers(int64_t time_in_seconds) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n private:\n     int64_t m_stale_tip_check_time; //! Next time to check for stale tip"
      }
    ]
  }
]