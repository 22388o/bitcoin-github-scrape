[
  {
    "sha": "e5a688dbdebf02828fb4bf22d0add1dad1b4e765",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplNWE2ODhkYmRlYmYwMjgyOGZiNGJmMjJkMGFkZDFkYWQxYjRlNzY1",
    "commit": {
      "author": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2021-05-17T14:29:34Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2021-05-17T14:29:37Z"
      },
      "message": "[tests] Always return false from CCoinsViewTest.GetCoin() if the coin is spent.\n\nCCoinsViewTest.GetCoins() was added in ed27e53c9, when a per-tx model\nwas used.  PR 10195 changed our model to be per-txout, so\nCCoinsViewTest.GetCoins() was changed to GetCoin(). GetCoins() would\nrandomly return false if the tx had been pruned from the coins view. In\nthe per-txout model, the real implementation of coins view will always\nreturn false if the coin IsSpent(), so it doesn't make sense for\nCCoinsViewTest.GetCoin() to sometimes return true.",
      "tree": {
        "sha": "b8f15a2e9f5181b0cb5e2dd20a8aa431cf16a47e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b8f15a2e9f5181b0cb5e2dd20a8aa431cf16a47e"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e5a688dbdebf02828fb4bf22d0add1dad1b4e765",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e5a688dbdebf02828fb4bf22d0add1dad1b4e765",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e5a688dbdebf02828fb4bf22d0add1dad1b4e765",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e5a688dbdebf02828fb4bf22d0add1dad1b4e765/comments",
    "author": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6d1d33d33491a98bb0dbf64ea7e4743200e71474",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6d1d33d33491a98bb0dbf64ea7e4743200e71474",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6d1d33d33491a98bb0dbf64ea7e4743200e71474"
      }
    ],
    "stats": {
      "total": 13,
      "additions": 4,
      "deletions": 9
    },
    "files": [
      {
        "sha": "7e6fbef1fd8be6ccc29609fefaa04f1a7f764a6d",
        "filename": "src/test/coins_tests.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 9,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e5a688dbdebf02828fb4bf22d0add1dad1b4e765/src/test/coins_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e5a688dbdebf02828fb4bf22d0add1dad1b4e765/src/test/coins_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/coins_tests.cpp?ref=e5a688dbdebf02828fb4bf22d0add1dad1b4e765",
        "patch": "@@ -40,16 +40,11 @@ class CCoinsViewTest : public CCoinsView\n public:\n     [[nodiscard]] bool GetCoin(const COutPoint& outpoint, Coin& coin) const override\n     {\n-        std::map<COutPoint, Coin>::const_iterator it = map_.find(outpoint);\n-        if (it == map_.end()) {\n-            return false;\n-        }\n+        auto it = map_.find(outpoint);\n+        if (it == map_.end()) return false;\n+\n         coin = it->second;\n-        if (coin.IsSpent() && InsecureRandBool() == 0) {\n-            // Randomly return false in case of an empty entry.\n-            return false;\n-        }\n-        return true;\n+        return !(coin.IsSpent());\n     }\n \n     uint256 GetBestBlock() const override { return hashBestBlock_; }"
      }
    ]
  },
  {
    "sha": "b5f17602b335a18ab05753da0c14b3f5acf83213",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiNWYxNzYwMmIzMzVhMThhYjA1NzUzZGEwYzE0YjNmNWFjZjgzMjEz",
    "commit": {
      "author": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2020-02-11T00:09:33Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2021-05-17T14:44:15Z"
      },
      "message": "[consensus] Clarify that spent coins are not added to the cache.\n\nWhen fetching a coin from a parent cache, it doesn't get added to the\nchild cache if it's already spent, since there's no benefit to adding\nit.\n\nClarify the invariant properties of the coins cache:\n- a spent coin cannot be FRESH\n- a spent coin must be DIRTY",
      "tree": {
        "sha": "6df22137ff773453ffd93e0c836485c3c158670e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6df22137ff773453ffd93e0c836485c3c158670e"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b5f17602b335a18ab05753da0c14b3f5acf83213",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b5f17602b335a18ab05753da0c14b3f5acf83213",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b5f17602b335a18ab05753da0c14b3f5acf83213",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b5f17602b335a18ab05753da0c14b3f5acf83213/comments",
    "author": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e5a688dbdebf02828fb4bf22d0add1dad1b4e765",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e5a688dbdebf02828fb4bf22d0add1dad1b4e765",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e5a688dbdebf02828fb4bf22d0add1dad1b4e765"
      }
    ],
    "stats": {
      "total": 44,
      "additions": 22,
      "deletions": 22
    },
    "files": [
      {
        "sha": "eccbe27c27338e105aa4c3ac02eadcf211733d2b",
        "filename": "src/coins.cpp",
        "status": "modified",
        "additions": 21,
        "deletions": 20,
        "changes": 41,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b5f17602b335a18ab05753da0c14b3f5acf83213/src/coins.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b5f17602b335a18ab05753da0c14b3f5acf83213/src/coins.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coins.cpp?ref=b5f17602b335a18ab05753da0c14b3f5acf83213",
        "patch": "@@ -42,14 +42,13 @@ CCoinsMap::iterator CCoinsViewCache::FetchCoin(const COutPoint &outpoint) const\n     if (it != cacheCoins.end())\n         return it;\n     Coin tmp;\n-    if (!base->GetCoin(outpoint, tmp))\n+    if (!base->GetCoin(outpoint, tmp)) {\n+        // The coin does not exist in the parent cache or has been spent in the\n+        // parent cache.\n         return cacheCoins.end();\n-    CCoinsMap::iterator ret = cacheCoins.emplace(std::piecewise_construct, std::forward_as_tuple(outpoint), std::forward_as_tuple(std::move(tmp))).first;\n-    if (ret->second.coin.IsSpent()) {\n-        // The parent only has an empty entry for this outpoint; we can consider our\n-        // version as fresh.\n-        ret->second.flags = CCoinsCacheEntry::FRESH;\n     }\n+    assert(!tmp.IsSpent());  // GetCoin will never return a spend (empty) coin\n+    CCoinsMap::iterator ret = cacheCoins.emplace(std::piecewise_construct, std::forward_as_tuple(outpoint), std::forward_as_tuple(std::move(tmp))).first;\n     cachedCoinsUsage += ret->second.coin.DynamicMemoryUsage();\n     return ret;\n }\n@@ -172,20 +171,22 @@ bool CCoinsViewCache::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlockIn\n         CCoinsMap::iterator itUs = cacheCoins.find(it->first);\n         if (itUs == cacheCoins.end()) {\n             // The parent cache does not have an entry, while the child cache does.\n-            // We can ignore it if it's both spent and FRESH in the child\n-            if (!(it->second.flags & CCoinsCacheEntry::FRESH && it->second.coin.IsSpent())) {\n-                // Create the coin in the parent cache, move the data up\n-                // and mark it as dirty.\n-                CCoinsCacheEntry& entry = cacheCoins[it->first];\n-                entry.coin = std::move(it->second.coin);\n-                cachedCoinsUsage += entry.coin.DynamicMemoryUsage();\n-                entry.flags = CCoinsCacheEntry::DIRTY;\n-                // We can mark it FRESH in the parent if it was FRESH in the child\n-                // Otherwise it might have just been flushed from the parent's cache\n-                // and already exist in the grandparent\n-                if (it->second.flags & CCoinsCacheEntry::FRESH) {\n-                    entry.flags |= CCoinsCacheEntry::FRESH;\n-                }\n+            if (it->second.flags & CCoinsCacheEntry::FRESH && it->second.coin.IsSpent()) {\n+                // A coin shouldn't be marked FRESH and spent (when a FRESH coin is spent,\n+                // it should be removed from the cache).\n+                throw std::logic_error(\"A FRESH coin was not removed when it was spent\");\n+            }\n+            // Create the coin in the parent cache, move the data up\n+            // and mark it as dirty.\n+            CCoinsCacheEntry& entry = cacheCoins[it->first];\n+            entry.coin = std::move(it->second.coin);\n+            cachedCoinsUsage += entry.coin.DynamicMemoryUsage();\n+            entry.flags = CCoinsCacheEntry::DIRTY;\n+            // We can mark it FRESH in the parent if it was FRESH in the child\n+            // Otherwise it might have just been flushed from the parent's cache\n+            // and already exist in the grandparent\n+            if (it->second.flags & CCoinsCacheEntry::FRESH) {\n+                entry.flags |= CCoinsCacheEntry::FRESH;\n             }\n         } else {\n             // Found the entry in the parent cache"
      },
      {
        "sha": "a3854499f80b89b7413d2eaaf4d5d6d6adf0e0bb",
        "filename": "src/coins.h",
        "status": "modified",
        "additions": 0,
        "deletions": 1,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b5f17602b335a18ab05753da0c14b3f5acf83213/src/coins.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b5f17602b335a18ab05753da0c14b3f5acf83213/src/coins.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coins.h?ref=b5f17602b335a18ab05753da0c14b3f5acf83213",
        "patch": "@@ -97,7 +97,6 @@ class Coin\n  * - unspent, FRESH, DIRTY (e.g. a new coin created in the cache)\n  * - unspent, not FRESH, DIRTY (e.g. a coin changed in the cache during a reorg)\n  * - unspent, not FRESH, not DIRTY (e.g. an unspent coin fetched from the parent cache)\n- * - spent, FRESH, not DIRTY (e.g. a spent coin fetched from the parent cache)\n  * - spent, not FRESH, DIRTY (e.g. a coin is spent and spentness needs to be flushed to the parent)\n  */\n struct CCoinsCacheEntry"
      },
      {
        "sha": "252158fcaf1b7b8da523b072fc9399606f0307e5",
        "filename": "src/test/coins_tests.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b5f17602b335a18ab05753da0c14b3f5acf83213/src/test/coins_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b5f17602b335a18ab05753da0c14b3f5acf83213/src/test/coins_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/coins_tests.cpp?ref=b5f17602b335a18ab05753da0c14b3f5acf83213",
        "patch": "@@ -818,7 +818,7 @@ BOOST_AUTO_TEST_CASE(ccoins_write)\n      */\n     CheckWriteCoins(ABSENT, ABSENT, ABSENT, NO_ENTRY   , NO_ENTRY   , NO_ENTRY   );\n     CheckWriteCoins(ABSENT, SPENT , SPENT , NO_ENTRY   , DIRTY      , DIRTY      );\n-    CheckWriteCoins(ABSENT, SPENT , ABSENT, NO_ENTRY   , DIRTY|FRESH, NO_ENTRY   );\n+    CheckWriteCoins(ABSENT, SPENT , FAIL  , NO_ENTRY   , DIRTY|FRESH, NO_ENTRY   );\n     CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY      , DIRTY      );\n     CheckWriteCoins(ABSENT, VALUE2, VALUE2, NO_ENTRY   , DIRTY|FRESH, DIRTY|FRESH);\n     CheckWriteCoins(SPENT , ABSENT, SPENT , 0          , NO_ENTRY   , 0          );"
      }
    ]
  }
]