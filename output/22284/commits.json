[
  {
    "sha": "566357f8f7471f74729297868917aa32f6d3c390",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1NjYzNTdmOGY3NDcxZjc0NzI5Mjk3ODY4OTE3YWEzMmY2ZDNjMzkw",
    "commit": {
      "author": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2021-07-01T10:48:51Z"
      },
      "committer": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2021-07-06T15:28:15Z"
      },
      "message": "refactor: move GetRandomNodeEvictionCandidates() to test utilities\n\nCo-authored-by: Vasil Dimov <vd@FreeBSD.org>",
      "tree": {
        "sha": "1ae0de3c612f40af7af9cbc76adc88f6935ec48f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1ae0de3c612f40af7af9cbc76adc88f6935ec48f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/566357f8f7471f74729297868917aa32f6d3c390",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEd6u7+MhX7zEv6RP5T1chs9Djkh0FAmDkdpAACgkQT1chs9Dj\nkh1yABAApNw3iZEQNUUxZJrTAH/oozi/yubDKcDvWM9ihcfbGf4UKX3JQ1ZRkkUW\n9Ahei/hSUcJvnmKU4+Qy5sKz1+SKto0Qd0pda4qanfS2W+0Jc9owDsPjPsSWx3tk\np+65/H1PtkiPKHQmHxFC6kgWXsobwdW4WDgOYowrmbQlGi9EkQl+YzfRV/Vf1zIG\nAWep/8dx74EiOjGOeEsvw1e9WY2ydCIdH2wdVmbgkl571ahoNhbI1OjtvkKd59xE\n1dNCNuM44vkmcOSayB2TMt3BNH6xozdh4WMjeCU/qUF4NJnyAbCFCl6YOaeLwFQm\nlAHFB5JCgkm2RblM6Ttp2aFnQ2jvoCnhMD1L7gOd7fP8Hu6bQ0WMLNy3joNEUsBi\njqCGycNY4cDcX5x5JNjKHeD+L5wpYwgA1BSoc0Ata3iJ9rCWMOUelqHOqZAatoBC\n2BG1EORcYE2QXAW5C45MXZFZ2xjwKfrxEnlYMTxX6mfHrmAZdkHICXD4UI5GDogq\nnawy8qaA4wWPrmy5CwgCmDEera7kjQ/SxxZhz/NOe4+OFgmOhKl6vZJM7t/kXwi2\nFODnGEd0DbvD1VcU3RKkRKpyCtTWAnJlJnLRkeyNRY/bK8V/DmljYnQlncKQDf6I\nMDMv9kVWnXJWOSOeYDEwIPknWgXFnYJQRpTl/xSw7Ic1uJ+A4Aw=\n=Ssmz\n-----END PGP SIGNATURE-----\n-----BEGIN OPENTIMESTAMPS GIT TIMESTAMP-----\n\nAQHwICgTAjWfVX9JI54MCE+PCvhFRL0guAia9Vvcz4R282fDCP/wEAUpgjGId9Ry\nwIxjh9iYW2EI8SBFjcuZgdOfCDZbtc1Vt7bbx6/16iYcE4WHoHJCDSet8wjxBGDk\ndpLwCJJxi25sa8XuAIPf4w0u+QyOLi1odHRwczovL2FsaWNlLmJ0Yy5jYWxlbmRh\nci5vcGVudGltZXN0YW1wcy5vcmf/8BAnwv7YNAOQaKP2eyDal6dTCPEEYOR2kvAI\nrzpNP7tgmV8Ag9/jDS75DI4sK2h0dHBzOi8vYm9iLmJ0Yy5jYWxlbmRhci5vcGVu\ndGltZXN0YW1wcy5vcmf/8BBJxTme/Au5IWKknLFZpvFQCPEEYOR2kfAIDzILc4Fe\nx/sAg9/jDS75DI4jImh0dHBzOi8vYnRjLmNhbGVuZGFyLmNhdGFsbGF4eS5jb23w\nEJhbr47f16WiUyAeTpdvh+cI8QRg5HaR8Aj6BZwsvb/gSwCD3+MNLvkMjikoaHR0\ncHM6Ly9maW5uZXkuY2FsZW5kYXIuZXRlcm5pdHl3YWxsLmNvbQ==\n-----END OPENTIMESTAMPS GIT TIMESTAMP-----",
        "payload": "tree 1ae0de3c612f40af7af9cbc76adc88f6935ec48f\nparent 088b348dbe82689ce1782653c8fdcebb3b636eb5\nauthor Jon Atack <jon@atack.com> 1625136531 +0200\ncommitter Jon Atack <jon@atack.com> 1625585295 +0200\n\nrefactor: move GetRandomNodeEvictionCandidates() to test utilities\n\nCo-authored-by: Vasil Dimov <vd@FreeBSD.org>\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/566357f8f7471f74729297868917aa32f6d3c390",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/566357f8f7471f74729297868917aa32f6d3c390",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/566357f8f7471f74729297868917aa32f6d3c390/comments",
    "author": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "088b348dbe82689ce1782653c8fdcebb3b636eb5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/088b348dbe82689ce1782653c8fdcebb3b636eb5",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/088b348dbe82689ce1782653c8fdcebb3b636eb5"
      }
    ],
    "stats": {
      "total": 49,
      "additions": 27,
      "deletions": 22
    },
    "files": [
      {
        "sha": "5eb280b498945bf5d040d484cd1d276fb548a29e",
        "filename": "src/test/net_peer_eviction_tests.cpp",
        "status": "modified",
        "additions": 0,
        "deletions": 22,
        "changes": 22,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/566357f8f7471f74729297868917aa32f6d3c390/src/test/net_peer_eviction_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/566357f8f7471f74729297868917aa32f6d3c390/src/test/net_peer_eviction_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/net_peer_eviction_tests.cpp?ref=566357f8f7471f74729297868917aa32f6d3c390",
        "patch": "@@ -17,28 +17,6 @@\n \n BOOST_FIXTURE_TEST_SUITE(net_peer_eviction_tests, BasicTestingSetup)\n \n-std::vector<NodeEvictionCandidate> GetRandomNodeEvictionCandidates(const int n_candidates, FastRandomContext& random_context)\n-{\n-    std::vector<NodeEvictionCandidate> candidates;\n-    for (int id = 0; id < n_candidates; ++id) {\n-        candidates.push_back({\n-            /* id */ id,\n-            /* nTimeConnected */ static_cast<int64_t>(random_context.randrange(100)),\n-            /* m_min_ping_time */ std::chrono::microseconds{random_context.randrange(100)},\n-            /* nLastBlockTime */ static_cast<int64_t>(random_context.randrange(100)),\n-            /* nLastTXTime */ static_cast<int64_t>(random_context.randrange(100)),\n-            /* fRelevantServices */ random_context.randbool(),\n-            /* fRelayTxes */ random_context.randbool(),\n-            /* fBloomFilter */ random_context.randbool(),\n-            /* nKeyedNetGroup */ random_context.randrange(100),\n-            /* prefer_evict */ random_context.randbool(),\n-            /* m_is_local */ random_context.randbool(),\n-            /* m_network */ ALL_NETWORKS[random_context.randrange(ALL_NETWORKS.size())],\n-        });\n-    }\n-    return candidates;\n-}\n-\n // Create `num_peers` random nodes, apply setup function `candidate_setup_fn`,\n // call ProtectEvictionCandidatesByRatio() to apply protection logic, and then\n // return true if all of `protected_peer_ids` and none of `unprotected_peer_ids`"
      },
      {
        "sha": "28d79670786bbbba3ff926459a7eb5704b27cfc0",
        "filename": "src/test/util/net.cpp",
        "status": "modified",
        "additions": 25,
        "deletions": 0,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/566357f8f7471f74729297868917aa32f6d3c390/src/test/util/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/566357f8f7471f74729297868917aa32f6d3c390/src/test/util/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/util/net.cpp?ref=566357f8f7471f74729297868917aa32f6d3c390",
        "patch": "@@ -6,6 +6,9 @@\n \n #include <chainparams.h>\n #include <net.h>\n+#include <span.h>\n+\n+#include <vector>\n \n void ConnmanTestMsg::NodeReceiveMsgBytes(CNode& node, Span<const uint8_t> msg_bytes, bool& complete) const\n {\n@@ -37,3 +40,25 @@ bool ConnmanTestMsg::ReceiveMsgFrom(CNode& node, CSerializedNetMsg& ser_msg) con\n     NodeReceiveMsgBytes(node, ser_msg.data, complete);\n     return complete;\n }\n+\n+std::vector<NodeEvictionCandidate> GetRandomNodeEvictionCandidates(int n_candidates, FastRandomContext& random_context)\n+{\n+    std::vector<NodeEvictionCandidate> candidates;\n+    for (int id = 0; id < n_candidates; ++id) {\n+        candidates.push_back({\n+            /* id */ id,\n+            /* nTimeConnected */ static_cast<int64_t>(random_context.randrange(100)),\n+            /* m_min_ping_time */ std::chrono::microseconds{random_context.randrange(100)},\n+            /* nLastBlockTime */ static_cast<int64_t>(random_context.randrange(100)),\n+            /* nLastTXTime */ static_cast<int64_t>(random_context.randrange(100)),\n+            /* fRelevantServices */ random_context.randbool(),\n+            /* fRelayTxes */ random_context.randbool(),\n+            /* fBloomFilter */ random_context.randbool(),\n+            /* nKeyedNetGroup */ random_context.randrange(100),\n+            /* prefer_evict */ random_context.randbool(),\n+            /* m_is_local */ random_context.randbool(),\n+            /* m_network */ ALL_NETWORKS[random_context.randrange(ALL_NETWORKS.size())],\n+        });\n+    }\n+    return candidates;\n+}"
      },
      {
        "sha": "939ec322ede73d21887e91dbd420afaf356b4b11",
        "filename": "src/test/util/net.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/566357f8f7471f74729297868917aa32f6d3c390/src/test/util/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/566357f8f7471f74729297868917aa32f6d3c390/src/test/util/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/util/net.h?ref=566357f8f7471f74729297868917aa32f6d3c390",
        "patch": "@@ -141,4 +141,6 @@ class StaticContentsSock : public Sock\n     mutable size_t m_consumed;\n };\n \n+std::vector<NodeEvictionCandidate> GetRandomNodeEvictionCandidates(int n_candidates, FastRandomContext& random_context);\n+\n #endif // BITCOIN_TEST_UTIL_NET_H"
      }
    ]
  },
  {
    "sha": "5adb06457403f8c1d874e9c6748ecbb78ef8fa2b",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1YWRiMDY0NTc0MDNmOGMxZDg3NGU5YzY3NDhlY2JiNzhlZjhmYTJi",
    "commit": {
      "author": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2021-06-20T11:04:45Z"
      },
      "committer": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2021-07-08T10:28:23Z"
      },
      "message": "bench: add peer eviction protection benchmarks\n\nCo-authored-by: Vasil Dimov <vd@FreeBSD.org>",
      "tree": {
        "sha": "b4b66f51f14a7c79fcd2522577e91baaab3d5123",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b4b66f51f14a7c79fcd2522577e91baaab3d5123"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5adb06457403f8c1d874e9c6748ecbb78ef8fa2b",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEd6u7+MhX7zEv6RP5T1chs9Djkh0FAmDm01EACgkQT1chs9Dj\nkh2UUg//Qw8N+pdeULXrSqlZprb6e+QmW8bUmW7uarcqgNElihK64UulPROcyzVb\nAkMohygOwUsfoF+2Y4If8E3qCyXdckcNyw5gZAuX7/Z3hvwkiMq/MVzkxO2Wme+b\nPQE5OgvE56w4XTI/f4Fua6xMbLdygiPzGn5YUWHsTAyt9db/FkRq10gdk1V2Cm/W\nElIU1ti20Ek9Ypu+AtcXi/M8jJa1WWPFriYl8Od88onW+X9CS9my66lDyfhWyXup\nfYI/EIvpjKwz6Vt799gFHihzk6hJC0ZGxy3fYH8YagKYltbZOWEotuwgct5mDrO9\n55U+XYdg1FXLbHit+zmwRdgCS8JvFG6YN99hLNuEr9NlyyfB1Q9uy5y+WitFz8mJ\n4QCSBA+BhFYJF2+T/Yp1cJpJIehqOdbXcnJdcRkQQoth8t8PDTM2ZCSfBrAfr0LA\nHjevzFZ8zBPXWbFt/DRz5auOZlGU9tGMe6I86ksbKBpkh1/pgqr5I3OtjU8Enu5+\n+3fG4mhmC8LjcqSpVTqGFpVrm5lpT55XaaJFl7HIeqZNZIMJJF7feVEC2HKgcgXP\nHAyphh+5eOUk8qIydQDFd9iCms5yEW4R5coNENZAtjmi5E98wTUv3Ca4u1bxYUvJ\n3/sHR8Rd8H4WEEJleM5MeykEKMyr1bxR9/4L3aki7nT1NWT9DpI=\n=YEpZ\n-----END PGP SIGNATURE-----\n-----BEGIN OPENTIMESTAMPS GIT TIMESTAMP-----\n\nAQHwIBCJ6ZcfCa26GIFvvDCvEvo+ZwUsQEQs2FPwk3mWuNJuCP/wEAt09qWQm56i\nxPAI/AbPYQcI8QRg5tNS8AiurtT6+xo2RACD3+MNLvkMjiwraHR0cHM6Ly9ib2Iu\nYnRjLmNhbGVuZGFyLm9wZW50aW1lc3RhbXBzLm9yZ//wECcyvf932YNKFOvhVrUr\nV18I8SCmzYAdbAG2A8MNCNIxYbcilhosyB3I4t7ftrb20cQ5EwjwIJ3e0zrQ+1oJ\nSaL1hEeGpDqM9HUeLuZRZemChPjj97OcCPEEYObTU/AIPAGFBfqtq2oAg9/jDS75\nDI4pKGh0dHBzOi8vZmlubmV5LmNhbGVuZGFyLmV0ZXJuaXR5d2FsbC5jb23/8BBM\ny09ABSW0bXIKGgPQW0SuCPEEYObTUvAIoI0Wyv4Uu/YAg9/jDS75DI4jImh0dHBz\nOi8vYnRjLmNhbGVuZGFyLmNhdGFsbGF4eS5jb23wEK7xKt4xI3zvN+sjZif/w7EI\n8QRg5tNS8AjRxi7MJNs5SwCD3+MNLvkMji4taHR0cHM6Ly9hbGljZS5idGMuY2Fs\nZW5kYXIub3BlbnRpbWVzdGFtcHMub3Jn\n-----END OPENTIMESTAMPS GIT TIMESTAMP-----",
        "payload": "tree b4b66f51f14a7c79fcd2522577e91baaab3d5123\nparent 566357f8f7471f74729297868917aa32f6d3c390\nauthor Jon Atack <jon@atack.com> 1624187085 +0200\ncommitter Jon Atack <jon@atack.com> 1625740103 +0200\n\nbench: add peer eviction protection benchmarks\n\nCo-authored-by: Vasil Dimov <vd@FreeBSD.org>\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5adb06457403f8c1d874e9c6748ecbb78ef8fa2b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/5adb06457403f8c1d874e9c6748ecbb78ef8fa2b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5adb06457403f8c1d874e9c6748ecbb78ef8fa2b/comments",
    "author": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "566357f8f7471f74729297868917aa32f6d3c390",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/566357f8f7471f74729297868917aa32f6d3c390",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/566357f8f7471f74729297868917aa32f6d3c390"
      }
    ],
    "stats": {
      "total": 157,
      "additions": 157,
      "deletions": 0
    },
    "files": [
      {
        "sha": "2a8e4a0aaca0b6f83487290e3b47f1b1f138142f",
        "filename": "src/Makefile.bench.include",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5adb06457403f8c1d874e9c6748ecbb78ef8fa2b/src/Makefile.bench.include",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5adb06457403f8c1d874e9c6748ecbb78ef8fa2b/src/Makefile.bench.include",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/Makefile.bench.include?ref=5adb06457403f8c1d874e9c6748ecbb78ef8fa2b",
        "patch": "@@ -35,6 +35,7 @@ bench_bench_bitcoin_SOURCES = \\\n   bench/mempool_stress.cpp \\\n   bench/nanobench.h \\\n   bench/nanobench.cpp \\\n+  bench/peer_eviction.cpp \\\n   bench/rpc_blockchain.cpp \\\n   bench/rpc_mempool.cpp \\\n   bench/util_time.cpp \\"
      },
      {
        "sha": "0469f0cb4c0db537200041e06c497c5cfeb7f461",
        "filename": "src/bench/peer_eviction.cpp",
        "status": "added",
        "additions": 156,
        "deletions": 0,
        "changes": 156,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5adb06457403f8c1d874e9c6748ecbb78ef8fa2b/src/bench/peer_eviction.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5adb06457403f8c1d874e9c6748ecbb78ef8fa2b/src/bench/peer_eviction.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bench/peer_eviction.cpp?ref=5adb06457403f8c1d874e9c6748ecbb78ef8fa2b",
        "patch": "@@ -0,0 +1,156 @@\n+// Copyright (c) 2021 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+#include <net.h>\n+#include <netaddress.h>\n+#include <random.h>\n+#include <test/util/net.h>\n+#include <test/util/setup_common.h>\n+\n+#include <algorithm>\n+#include <functional>\n+#include <vector>\n+\n+static void EvictionProtectionCommon(\n+    benchmark::Bench& bench,\n+    int num_candidates,\n+    std::function<void(NodeEvictionCandidate&)> candidate_setup_fn)\n+{\n+    using Candidates = std::vector<NodeEvictionCandidate>;\n+    FastRandomContext random_context{true};\n+    bench.warmup(100).epochIterations(1100);\n+\n+    Candidates candidates{GetRandomNodeEvictionCandidates(num_candidates, random_context)};\n+    for (auto& c : candidates) {\n+        candidate_setup_fn(c);\n+    }\n+\n+    std::vector<Candidates> copies{bench.epochs() * bench.epochIterations(), candidates};\n+    size_t i{0};\n+    bench.run([&] {\n+        ProtectEvictionCandidatesByRatio(copies.at(i));\n+        ++i;\n+    });\n+}\n+\n+/* Benchmarks */\n+\n+static void EvictionProtection0Networks250Candidates(benchmark::Bench& bench)\n+{\n+    EvictionProtectionCommon(\n+        bench,\n+        250 /* num_candidates */,\n+        [](NodeEvictionCandidate& c) {\n+            c.nTimeConnected = c.id;\n+            c.m_network = NET_IPV4;\n+        });\n+}\n+\n+static void EvictionProtection1Networks250Candidates(benchmark::Bench& bench)\n+{\n+    EvictionProtectionCommon(\n+        bench,\n+        250 /* num_candidates */,\n+        [](NodeEvictionCandidate& c) {\n+            c.nTimeConnected = c.id;\n+            c.m_is_local = false;\n+            if (c.id >= 130 && c.id < 240) { // 110 Tor\n+                c.m_network = NET_ONION;\n+            } else {\n+                c.m_network = NET_IPV4;\n+            }\n+        });\n+}\n+\n+static void EvictionProtection2Networks250Candidates(benchmark::Bench& bench)\n+{\n+    EvictionProtectionCommon(\n+        bench,\n+        250 /* num_candidates */,\n+        [](NodeEvictionCandidate& c) {\n+            c.nTimeConnected = c.id;\n+            c.m_is_local = false;\n+            if (c.id >= 90 && c.id < 160) { // 70 Tor\n+                c.m_network = NET_ONION;\n+            } else if (c.id >= 170 && c.id < 250) { // 80 I2P\n+                c.m_network = NET_I2P;\n+            } else {\n+                c.m_network = NET_IPV4;\n+            }\n+        });\n+}\n+\n+static void EvictionProtection3Networks050Candidates(benchmark::Bench& bench)\n+{\n+    EvictionProtectionCommon(\n+        bench,\n+        50 /* num_candidates */,\n+        [](NodeEvictionCandidate& c) {\n+            c.nTimeConnected = c.id;\n+            c.m_is_local = (c.id == 28 || c.id == 47); //  2 localhost\n+            if (c.id >= 30 && c.id < 47) {             // 17 I2P\n+                c.m_network = NET_I2P;\n+            } else if (c.id >= 24 && c.id < 28) { //  4 Tor\n+                c.m_network = NET_ONION;\n+            } else {\n+                c.m_network = NET_IPV4;\n+            }\n+        });\n+}\n+\n+static void EvictionProtection3Networks100Candidates(benchmark::Bench& bench)\n+{\n+    EvictionProtectionCommon(\n+        bench,\n+        100 /* num_candidates */,\n+        [](NodeEvictionCandidate& c) {\n+            c.nTimeConnected = c.id;\n+            c.m_is_local = (c.id >= 55 && c.id < 60); //  5 localhost\n+            if (c.id >= 70 && c.id < 80) {            // 10 I2P\n+                c.m_network = NET_I2P;\n+            } else if (c.id >= 80 && c.id < 96) { // 16 Tor\n+                c.m_network = NET_ONION;\n+            } else {\n+                c.m_network = NET_IPV4;\n+            }\n+        });\n+}\n+\n+static void EvictionProtection3Networks250Candidates(benchmark::Bench& bench)\n+{\n+    EvictionProtectionCommon(\n+        bench,\n+        250 /* num_candidates */,\n+        [](NodeEvictionCandidate& c) {\n+            c.nTimeConnected = c.id;\n+            c.m_is_local = (c.id >= 140 && c.id < 160); // 20 localhost\n+            if (c.id >= 170 && c.id < 180) {            // 10 I2P\n+                c.m_network = NET_I2P;\n+            } else if (c.id >= 190 && c.id < 240) { // 50 Tor\n+                c.m_network = NET_ONION;\n+            } else {\n+                c.m_network = NET_IPV4;\n+            }\n+        });\n+}\n+\n+// Candidate numbers used for the benchmarks:\n+// -  50 candidates simulates a possible use of -maxconnections\n+// - 100 candidates approximates an average node with default settings\n+// - 250 candidates is the number of peers reported by operators of busy nodes\n+\n+// No disadvantaged networks, with 250 eviction candidates.\n+BENCHMARK(EvictionProtection0Networks250Candidates);\n+\n+// 1 disadvantaged network (Tor) with 250 eviction candidates.\n+BENCHMARK(EvictionProtection1Networks250Candidates);\n+\n+// 2 disadvantaged networks (I2P, Tor) with 250 eviction candidates.\n+BENCHMARK(EvictionProtection2Networks250Candidates);\n+\n+// 3 disadvantaged networks (I2P/localhost/Tor) with 50/100/250 eviction candidates.\n+BENCHMARK(EvictionProtection3Networks050Candidates);\n+BENCHMARK(EvictionProtection3Networks100Candidates);\n+BENCHMARK(EvictionProtection3Networks250Candidates);"
      }
    ]
  },
  {
    "sha": "02e411ec456af80d1da76085a814c68bb3aca6de",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowMmU0MTFlYzQ1NmFmODBkMWRhNzYwODVhODE0YzY4YmIzYWNhNmRl",
    "commit": {
      "author": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2021-06-19T15:19:38Z"
      },
      "committer": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2021-07-08T10:28:35Z"
      },
      "message": "p2p: iterate eviction protection only on networks having candidates\n\nin ProtectEvictionCandidatesByRatio().\n\nThank you to Vasil Dimov, whose suggestions during a post-merge\ndiscussion about PR 21261 reminded me that I had done this in\nearlier versions of the PR, e.g. commits like ef411cd2.\n\nCo-authored-by: Vasil Dimov <vd@FreeBSD.org>",
      "tree": {
        "sha": "e0ededf60f9f9734d6388e5df90f1634561afa1e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e0ededf60f9f9734d6388e5df90f1634561afa1e"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/02e411ec456af80d1da76085a814c68bb3aca6de",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEd6u7+MhX7zEv6RP5T1chs9Djkh0FAmDm01QACgkQT1chs9Dj\nkh0YxRAAqNdNwNAaS3yK894Yo4j7wugj5sBAH8bkYL2lttd2To6R+PdXaHjqtUMq\n5/HiDh40MJ9QYHvMnaPEcYgjs4+L5XPgwqW/q1c8z8/QIlkAX2YnaZ9/Rs28Chse\nxmUvzDtJRA/sLjyL6Qi/AIwYtHb7MMxa0qeV1K20iBF75NOYKASbTQu9TyUhgYHr\ndkh9IDldpmTKSDifYUb5WhC6lBZr/eQkwXJmgbi97UHmZO4fC2d8/db/HCx113Ft\nwWznEgnlSvrSUU6Z2ui/IFF9lp9pJpxLjteS5TBbkVQ+Mh+iLhGQuvSMKgtnACNZ\nqrOHP5bw2/1qgtpz2CJRkA53Y/XFOiUOvzyZby2ZZH4Uqb1VD74DHsJ5qZAy+3oa\nMo9UES5rbk++w09rm0/k0KSNLCeQp5XwNn7cdT6LcGCT2nBNi3y1mnlnL90mqhxa\npu/J1/Bp8/9pOfVOLtZMp1LN6BaaVq/uhzcZb2ard8lCrEkqcx2QubzGRbNnhrEH\nMemx9LtJaFV0VuaDlrduGHNTSSl3cjkzfvoJjCj2mBz71UFAkbzO5cm2y6azNDA3\nEz0ON9BckEW89w33x0VMOpb/yo9dCCG+EN+IsEpCNNC1x4DB5eOtauckD3hjpHgN\nuhN06Y29EKUsBexrqhKYN7JBWs5HK6WoBzTRC0Xx/enrAmUJ6og=\n=J/wG\n-----END PGP SIGNATURE-----\n-----BEGIN OPENTIMESTAMPS GIT TIMESTAMP-----\n\nAQHwIEnzYaes4cp4T5NKXPRU3EewIaIj98HQ8lWijaeD6McsCP/wEFFqC+M1GruG\nlSlgFFM4EnYI8QRg5tNV8Ah8fLNNR2rTQACD3+MNLvkMji4taHR0cHM6Ly9hbGlj\nZS5idGMuY2FsZW5kYXIub3BlbnRpbWVzdGFtcHMub3Jn//AQXJE2E+0t1cbA4+7Z\nfPhrFgjwIG8u3+m5DKNVuJ2tYCLsTYZ+KlTrAJuJMMAgOMfS3FxoCPAgxHn4U3iG\nQilXpIqblbHq6gHFi7W8dRkqWfhNs+XgesQI8QRg5tNV8Ajq0kJ24sdSNwCD3+MN\nLvkMjiwraHR0cHM6Ly9ib2IuYnRjLmNhbGVuZGFyLm9wZW50aW1lc3RhbXBzLm9y\nZ//wELfGMC7G2o9koPTnaNhYYW0I8QRg5tNV8Ahl16MS2e51wgCD3+MNLvkMjiko\naHR0cHM6Ly9maW5uZXkuY2FsZW5kYXIuZXRlcm5pdHl3YWxsLmNvbfAQxpmb+f1E\nyRxpu7l1uMpITgjxBGDm01XwCBrtcPx+t653AIPf4w0u+QyOIyJodHRwczovL2J0\nYy5jYWxlbmRhci5jYXRhbGxheHkuY29t\n-----END OPENTIMESTAMPS GIT TIMESTAMP-----",
        "payload": "tree e0ededf60f9f9734d6388e5df90f1634561afa1e\nparent 5adb06457403f8c1d874e9c6748ecbb78ef8fa2b\nauthor Jon Atack <jon@atack.com> 1624115978 +0200\ncommitter Jon Atack <jon@atack.com> 1625740115 +0200\n\np2p: iterate eviction protection only on networks having candidates\n\nin ProtectEvictionCandidatesByRatio().\n\nThank you to Vasil Dimov, whose suggestions during a post-merge\ndiscussion about PR 21261 reminded me that I had done this in\nearlier versions of the PR, e.g. commits like ef411cd2.\n\nCo-authored-by: Vasil Dimov <vd@FreeBSD.org>\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/02e411ec456af80d1da76085a814c68bb3aca6de",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/02e411ec456af80d1da76085a814c68bb3aca6de",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/02e411ec456af80d1da76085a814c68bb3aca6de/comments",
    "author": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "5adb06457403f8c1d874e9c6748ecbb78ef8fa2b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5adb06457403f8c1d874e9c6748ecbb78ef8fa2b",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/5adb06457403f8c1d874e9c6748ecbb78ef8fa2b"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 4,
      "deletions": 1
    },
    "files": [
      {
        "sha": "1611b1a24b90755e0d1ab9a2b4735654f28652ed",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 1,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/02e411ec456af80d1da76085a814c68bb3aca6de/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/02e411ec456af80d1da76085a814c68bb3aca6de/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=02e411ec456af80d1da76085a814c68bb3aca6de",
        "patch": "@@ -935,7 +935,10 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n     const size_t max_protect_by_network{total_protect_size / 2};\n     size_t num_protected{0};\n \n-    while (num_protected < max_protect_by_network) {\n+    // Count the number of disadvantaged networks from which we have peers to protect.\n+    auto num_networks = std::count_if(networks.begin(), networks.end(), [](const Net& n) { return n.count; });\n+\n+    while (num_networks != 0 && num_protected < max_protect_by_network) {\n         const size_t disadvantaged_to_protect{max_protect_by_network - num_protected};\n         const size_t protect_per_network{\n             std::max(disadvantaged_to_protect / networks.size(), static_cast<size_t>(1))};"
      }
    ]
  },
  {
    "sha": "c9e8d8f9b168dec2bc7b845da38449e96708cf8e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjOWU4ZDhmOWIxNjhkZWMyYmM3Yjg0NWRhMzg0NDllOTY3MDhjZjhl",
    "commit": {
      "author": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2021-07-06T15:01:15Z"
      },
      "committer": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2021-07-08T10:28:38Z"
      },
      "message": "p2p: process more candidates per protection iteration\n\nfor the usual case when some of the protected networks\ndon't have eviction candidates, to reduce the number\nof iterations in ProtectEvictionCandidatesByRatio().\n\nPicks up an idea in ef411cd2 that I had dropped.",
      "tree": {
        "sha": "71c7fc6042432899fd99324faf26257e8082d1c1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/71c7fc6042432899fd99324faf26257e8082d1c1"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c9e8d8f9b168dec2bc7b845da38449e96708cf8e",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEd6u7+MhX7zEv6RP5T1chs9Djkh0FAmDm01YACgkQT1chs9Dj\nkh3tRg//Xm66YKK5RGrOHNRJB05FFwBur/GXpLzWK9a5BsJKJhgCr3Ki7bJvXADJ\nskX/a7fgr1fQDwDwlMVx11AppWGnN2bRIODEmdQFyNz8Q8akiT4ca0T7JNhhnXuk\ngl2hZktWCNsL9QvRHsNqWkSJQrOTT4cI1MHTA9V5qKqsIMveSGvtIYBB4VDrtF5H\nUoe/u9+JSKuPJFvK3pQDIr/+6RE1QVQk8yLzTgw8FKH7E0BxKPvAiW1EtkFA4WRE\n9PMlU5y9YS5IQ0pIGkW14WezEa5W5sp5BU22sAmWmo/4t8/SRYLRWIhj62SXy0nI\ndTIz/kU8ZanYNEe8aYS26fhAE/V861Ui4C/i9as4+D4XJLvkhCLSk5zwrwgjM/gp\njHYymlK2UntbRjkl5sOPWuur6JAT1LA0TgPC6kiMr7QI6o7uEQXWA3ZYNckrwG6g\n33ZKq/ku+uHfHqJDfD+L1G93msTxVio+W3A2pPvyXS9H/0436gaoN4HCWvfbkWKE\neRWCD+uE/dGKyndg8smEZlhqtfg3AovKbMiMT2iun5escXk9gAHgsRkJex+M/ad3\nx7B8x3VfUVhrwbeY0X1UiGwnn0q24TPsrx5lBrfe1aZmKjfgUUEqLIsePe9aRefI\noKvfT5+FLyTcQL0Idq4SZzKmv7p+TZhYzO4l/lGiiT+XE/0mKY0=\n=F5G1\n-----END PGP SIGNATURE-----\n-----BEGIN OPENTIMESTAMPS GIT TIMESTAMP-----\n\nAQHwII4sVLzuFv0MbFg0PUgv2i0H4pDNlToaODhLQHEqxqm8CP/wEAtNEujkHbVx\nDZch72445aAI8QRg5tNX8AgBK575EokwrwCD3+MNLvkMjikoaHR0cHM6Ly9maW5u\nZXkuY2FsZW5kYXIuZXRlcm5pdHl3YWxsLmNvbf/wEED8CSOBbW9DdG0TL/k4vucI\n8QRg5tNX8AhKSS4FpFYlXgCD3+MNLvkMjiMiaHR0cHM6Ly9idGMuY2FsZW5kYXIu\nY2F0YWxsYXh5LmNvbf/wEJLhCVgvV7KtObEGj8FLKeEI8QRg5tNX8AgtpenyRrr8\nFACD3+MNLvkMjiwraHR0cHM6Ly9ib2IuYnRjLmNhbGVuZGFyLm9wZW50aW1lc3Rh\nbXBzLm9yZ/AQ0WnGKuw5nTPOQeAkdEVlQAjxBGDm01fwCEryaPP8m9SWAIPf4w0u\n+QyOLi1odHRwczovL2FsaWNlLmJ0Yy5jYWxlbmRhci5vcGVudGltZXN0YW1wcy5v\ncmc=\n-----END OPENTIMESTAMPS GIT TIMESTAMP-----",
        "payload": "tree 71c7fc6042432899fd99324faf26257e8082d1c1\nparent 02e411ec456af80d1da76085a814c68bb3aca6de\nauthor Jon Atack <jon@atack.com> 1625583675 +0200\ncommitter Jon Atack <jon@atack.com> 1625740118 +0200\n\np2p: process more candidates per protection iteration\n\nfor the usual case when some of the protected networks\ndon't have eviction candidates, to reduce the number\nof iterations in ProtectEvictionCandidatesByRatio().\n\nPicks up an idea in ef411cd2 that I had dropped.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c9e8d8f9b168dec2bc7b845da38449e96708cf8e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c9e8d8f9b168dec2bc7b845da38449e96708cf8e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c9e8d8f9b168dec2bc7b845da38449e96708cf8e/comments",
    "author": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "02e411ec456af80d1da76085a814c68bb3aca6de",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/02e411ec456af80d1da76085a814c68bb3aca6de",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/02e411ec456af80d1da76085a814c68bb3aca6de"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 1,
      "deletions": 3
    },
    "files": [
      {
        "sha": "9567e2b0cf97c61bd3ea34bcc20d74c173c97b79",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 3,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c9e8d8f9b168dec2bc7b845da38449e96708cf8e/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c9e8d8f9b168dec2bc7b845da38449e96708cf8e/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=c9e8d8f9b168dec2bc7b845da38449e96708cf8e",
        "patch": "@@ -940,9 +940,7 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n \n     while (num_networks != 0 && num_protected < max_protect_by_network) {\n         const size_t disadvantaged_to_protect{max_protect_by_network - num_protected};\n-        const size_t protect_per_network{\n-            std::max(disadvantaged_to_protect / networks.size(), static_cast<size_t>(1))};\n-\n+        const size_t protect_per_network{std::max(disadvantaged_to_protect / num_networks, static_cast<size_t>(1))};\n         // Early exit flag if there are no remaining candidates by disadvantaged network.\n         bool protected_at_least_one{false};\n "
      }
    ]
  },
  {
    "sha": "b1d905c225e87a4a289c0cd3593c6c21cea3fba7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiMWQ5MDVjMjI1ZTg3YTRhMjg5YzBjZDM1OTNjNmMyMWNlYTNmYmE3",
    "commit": {
      "author": {
        "name": "Vasil Dimov",
        "email": "vd@FreeBSD.org",
        "date": "2021-06-19T15:07:01Z"
      },
      "committer": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2021-07-08T10:28:40Z"
      },
      "message": "p2p: earlier continuation when no remaining eviction candidates\n\nin ProtectEvictionCandidatesByRatio().\n\nWith this change, `if (n.count == 0) continue;` will be true\nif a network had candidates protected in the first iterations\nand has no candidates remaining to be protected in later iterations.\n\nCo-authored-by: Jon Atack <jon@atack.com>",
      "tree": {
        "sha": "1e351bba3f84d5ca0f8f795304da3a44fe29abb7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1e351bba3f84d5ca0f8f795304da3a44fe29abb7"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b1d905c225e87a4a289c0cd3593c6c21cea3fba7",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEd6u7+MhX7zEv6RP5T1chs9Djkh0FAmDm01gACgkQT1chs9Dj\nkh36bQ/+LGtYWhK0lfoFTi+FC0tpdzwaAMTUILfP36eNt64yzRczWy8X7A1ir54y\nXfLKuhoQSl4EKrMSeB/a03RsxfvXDi8sYTsSdMO62OigVYS2Wd1BrUn6ALRupmvl\n3dkSEDIjJ8s78RC5bgVMEP5flJe891MEZc4srlj6GRN8c3a234awE+90kjDmCQFI\nUbkipgawL7j+culZY3d9iSlkhbMsVwkZyJVIEF3CB0x6VKG+2GiPzjflqUNW9S3b\niHGcX77cnUrc7FNeNnHYvmf4D1ULf4CTuRQw/Jl5V97H4pQC95B/Ns9XAMyvYsSg\ngoXjnTJ9XLMRWfbwF5kKHRa1WqsaJILjHlL0AOZun9nosueZD/b9RtT8SMJRkU9W\nEHCjF8g1QM7bh3AxIgqiAeok/qpPn8zccSKTDC/5UxQHebpGFSijHXZvAhMlmm5V\nBSR1CN9jGmvYHP+VeSERwfyMAQXF4NutokyT8qyUB5/LnLu/5e21BgbRNyPS2A3A\ncnTAhvfsUAboa52ble/6o99CPl1mkuhqTXEws9Y9IxwH/FL/iHmZXfsAUE/nD5XS\nD87GTdsQ+EtA8lxYFXvn9sElZ69IEuM+6llGepuL0FfI4YiAq0tnI+ucJBcrrLFn\ns50TgpoDrj9uyI5NdbB1QKwxsbW/OYq/m8YIXkSd+kQNuXLo7qo=\n=/6UC\n-----END PGP SIGNATURE-----\n-----BEGIN OPENTIMESTAMPS GIT TIMESTAMP-----\n\nAQHwIFK0FyH3Etirowk+TjMM9MZh8vnn84ktwT9bYMLUG5cXCP/wEDXo/ePcEIBA\nUqTYkvoPZFUI8CDv15qT0wG9rNB3vHaJxopfVE5H1IFNr5r9nXiLIoXchgjxBGDm\n01nwCMRINnMU5v+AAIPf4w0u+QyOIyJodHRwczovL2J0Yy5jYWxlbmRhci5jYXRh\nbGxheHkuY29t//AQTxpCuoJqvmn1YnBnzWynrwjwIILu2wJwtuUq3e71LTNEdf0X\n8WBYrNV8eMitZQK4j8XdCPEEYObTWfAIMUDCi45qDpoAg9/jDS75DI4uLWh0dHBz\nOi8vYWxpY2UuYnRjLmNhbGVuZGFyLm9wZW50aW1lc3RhbXBzLm9yZ//wENYCVUJ4\ni/bHOWZM3iHFcDoI8CCHBcG2/MAoEOV7JGsyfcTzY9UCRzoT3IjvI0Bq8LfhEQjx\nBGDm01nwCCYmeXaEEdLwAIPf4w0u+QyOLCtodHRwczovL2JvYi5idGMuY2FsZW5k\nYXIub3BlbnRpbWVzdGFtcHMub3Jn8BDd84yB7DlIfuw3Su4jlTM5CPEg/bLqxJJf\nfHR1N+sVoSF6k0LBxLLrCeDhS6DB0Anse5cI8QRg5tNZ8AhYRaMI0U96rQCD3+MN\nLvkMjikoaHR0cHM6Ly9maW5uZXkuY2FsZW5kYXIuZXRlcm5pdHl3YWxsLmNvbQ==\n-----END OPENTIMESTAMPS GIT TIMESTAMP-----",
        "payload": "tree 1e351bba3f84d5ca0f8f795304da3a44fe29abb7\nparent c9e8d8f9b168dec2bc7b845da38449e96708cf8e\nauthor Vasil Dimov <vd@FreeBSD.org> 1624115221 +0200\ncommitter Jon Atack <jon@atack.com> 1625740120 +0200\n\np2p: earlier continuation when no remaining eviction candidates\n\nin ProtectEvictionCandidatesByRatio().\n\nWith this change, `if (n.count == 0) continue;` will be true\nif a network had candidates protected in the first iterations\nand has no candidates remaining to be protected in later iterations.\n\nCo-authored-by: Jon Atack <jon@atack.com>\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b1d905c225e87a4a289c0cd3593c6c21cea3fba7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b1d905c225e87a4a289c0cd3593c6c21cea3fba7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b1d905c225e87a4a289c0cd3593c6c21cea3fba7/comments",
    "author": {
      "login": "vasild",
      "id": 266751,
      "node_id": "MDQ6VXNlcjI2Njc1MQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/266751?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/vasild",
      "html_url": "https://github.com/vasild",
      "followers_url": "https://api.github.com/users/vasild/followers",
      "following_url": "https://api.github.com/users/vasild/following{/other_user}",
      "gists_url": "https://api.github.com/users/vasild/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/vasild/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/vasild/subscriptions",
      "organizations_url": "https://api.github.com/users/vasild/orgs",
      "repos_url": "https://api.github.com/users/vasild/repos",
      "events_url": "https://api.github.com/users/vasild/events{/privacy}",
      "received_events_url": "https://api.github.com/users/vasild/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c9e8d8f9b168dec2bc7b845da38449e96708cf8e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c9e8d8f9b168dec2bc7b845da38449e96708cf8e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c9e8d8f9b168dec2bc7b845da38449e96708cf8e"
      }
    ],
    "stats": {
      "total": 16,
      "additions": 10,
      "deletions": 6
    },
    "files": [
      {
        "sha": "f7d46881ee18e68c04a8d8fdde87f10fa81f245f",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 6,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b1d905c225e87a4a289c0cd3593c6c21cea3fba7/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b1d905c225e87a4a289c0cd3593c6c21cea3fba7/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=b1d905c225e87a4a289c0cd3593c6c21cea3fba7",
        "patch": "@@ -935,16 +935,18 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n     const size_t max_protect_by_network{total_protect_size / 2};\n     size_t num_protected{0};\n \n-    // Count the number of disadvantaged networks from which we have peers to protect.\n-    auto num_networks = std::count_if(networks.begin(), networks.end(), [](const Net& n) { return n.count; });\n-\n-    while (num_networks != 0 && num_protected < max_protect_by_network) {\n+    while (num_protected < max_protect_by_network) {\n+        // Count the number of disadvantaged networks from which we have peers to protect.\n+        auto num_networks = std::count_if(networks.begin(), networks.end(), [](const Net& n) { return n.count; });\n+        if (num_networks == 0) {\n+            break;\n+        }\n         const size_t disadvantaged_to_protect{max_protect_by_network - num_protected};\n         const size_t protect_per_network{std::max(disadvantaged_to_protect / num_networks, static_cast<size_t>(1))};\n         // Early exit flag if there are no remaining candidates by disadvantaged network.\n         bool protected_at_least_one{false};\n \n-        for (const Net& n : networks) {\n+        for (Net& n : networks) {\n             if (n.count == 0) continue;\n             const size_t before = eviction_candidates.size();\n             EraseLastKElements(eviction_candidates, CompareNodeNetworkTime(n.is_local, n.id),\n@@ -954,10 +956,12 @@ void ProtectEvictionCandidatesByRatio(std::vector<NodeEvictionCandidate>& evicti\n             const size_t after = eviction_candidates.size();\n             if (before > after) {\n                 protected_at_least_one = true;\n-                num_protected += before - after;\n+                const size_t delta{before - after};\n+                num_protected += delta;\n                 if (num_protected >= max_protect_by_network) {\n                     break;\n                 }\n+                n.count -= delta;\n             }\n         }\n         if (!protected_at_least_one) {"
      }
    ]
  }
]