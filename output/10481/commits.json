[
  {
    "sha": "5b75c477841fa463aad9c6e6d95a98b50ce14dd3",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1Yjc1YzQ3Nzg0MWZhNDYzYWFkOWM2ZTZkOTVhOThiNTBjZTE0ZGQz",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2017-05-30T22:42:10Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2017-06-07T19:40:01Z"
      },
      "message": "Add a valid opcode sanity check to CScript\n\nAdded a function in CScript that checks if the script contains valid opcodes.\n\nAdd a test for that function",
      "tree": {
        "sha": "b1d8f572c189d1eb8af6aa324a002b1ee3a299aa",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b1d8f572c189d1eb8af6aa324a002b1ee3a299aa"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5b75c477841fa463aad9c6e6d95a98b50ce14dd3",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5b75c477841fa463aad9c6e6d95a98b50ce14dd3",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/5b75c477841fa463aad9c6e6d95a98b50ce14dd3",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5b75c477841fa463aad9c6e6d95a98b50ce14dd3/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "9fec4da0bec93a49798b5f5e92cf76e900759ee4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9fec4da0bec93a49798b5f5e92cf76e900759ee4",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/9fec4da0bec93a49798b5f5e92cf76e900759ee4"
      }
    ],
    "stats": {
      "total": 29,
      "additions": 29,
      "deletions": 0
    },
    "files": [
      {
        "sha": "a71fee19cfe437c9443072cf14e1d8eaf25ea234",
        "filename": "src/script/script.cpp",
        "status": "modified",
        "additions": 12,
        "deletions": 0,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5b75c477841fa463aad9c6e6d95a98b50ce14dd3/src/script/script.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5b75c477841fa463aad9c6e6d95a98b50ce14dd3/src/script/script.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/script.cpp?ref=5b75c477841fa463aad9c6e6d95a98b50ce14dd3",
        "patch": "@@ -267,3 +267,15 @@ std::string CScriptWitness::ToString() const\n     }\n     return ret + \")\";\n }\n+\n+bool CScript::HasValidOps() const\n+{\n+    CScript::const_iterator it = begin();\n+    while (it < end()) {\n+        opcodetype opcode;\n+        if (!GetOp(it, opcode) || opcode > 0xb9) {\n+            return false;\n+        }\n+    }\n+    return true;\n+}"
      },
      {
        "sha": "25b80ef62bfc38138a4eb69677ef346eb5fe5b58",
        "filename": "src/script/script.h",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5b75c477841fa463aad9c6e6d95a98b50ce14dd3/src/script/script.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5b75c477841fa463aad9c6e6d95a98b50ce14dd3/src/script/script.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/script.h?ref=5b75c477841fa463aad9c6e6d95a98b50ce14dd3",
        "patch": "@@ -630,6 +630,9 @@ class CScript : public CScriptBase\n     bool IsPushOnly(const_iterator pc) const;\n     bool IsPushOnly() const;\n \n+    /** Check if the script contains valid OP_CODES */\n+    bool HasValidOps() const;\n+\n     /**\n      * Returns whether the script is guaranteed to fail at execution,\n      * regardless of the initial stack. This allows outputs to be pruned"
      },
      {
        "sha": "70544cacd6a8e58a1ff509c6311ea09eaf59fe5b",
        "filename": "src/test/script_tests.cpp",
        "status": "modified",
        "additions": 14,
        "deletions": 0,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5b75c477841fa463aad9c6e6d95a98b50ce14dd3/src/test/script_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5b75c477841fa463aad9c6e6d95a98b50ce14dd3/src/test/script_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/script_tests.cpp?ref=5b75c477841fa463aad9c6e6d95a98b50ce14dd3",
        "patch": "@@ -1438,4 +1438,18 @@ BOOST_AUTO_TEST_CASE(script_FindAndDelete)\n     BOOST_CHECK(s == expect);\n }\n \n+BOOST_AUTO_TEST_CASE(script_HasValidOps)\n+{\n+    // Exercise the HasValidOps functionality\n+    CScript script;\n+    script = ScriptFromHex(\"76a9141234567890abcdefa1a2a3a4a5a6a7a8a9a0aaab88ac\"); // Normal script\n+    BOOST_CHECK(script.HasValidOps());\n+    script = ScriptFromHex(\"76a914ff34567890abcdefa1a2a3a4a5a6a7a8a9a0aaab88ac\");\n+    BOOST_CHECK(script.HasValidOps());\n+    script = ScriptFromHex(\"ff88ac\"); // Script with OP_INVALIDOPCODE explicit\n+    BOOST_CHECK(!script.HasValidOps());\n+    script = ScriptFromHex(\"88acc0\"); // Script with undefined opcode\n+    BOOST_CHECK(!script.HasValidOps());\n+}\n+\n BOOST_AUTO_TEST_SUITE_END()"
      }
    ]
  },
  {
    "sha": "ac4e438229134595e949bfedb1f487c71fd45d24",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphYzRlNDM4MjI5MTM0NTk1ZTk0OWJmZWRiMWY0ODdjNzFmZDQ1ZDI0",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2017-05-30T22:43:07Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2017-06-07T21:07:26Z"
      },
      "message": "Sanity check transaction scripts in DecodeHexTx\n\nMake sure that the scripts of decoded transactions are valid scripts.",
      "tree": {
        "sha": "08114ad8a0bd5616c83fd10d2a0db4f091b2e09b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/08114ad8a0bd5616c83fd10d2a0db4f091b2e09b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ac4e438229134595e949bfedb1f487c71fd45d24",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ac4e438229134595e949bfedb1f487c71fd45d24",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ac4e438229134595e949bfedb1f487c71fd45d24",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ac4e438229134595e949bfedb1f487c71fd45d24/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "5b75c477841fa463aad9c6e6d95a98b50ce14dd3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5b75c477841fa463aad9c6e6d95a98b50ce14dd3",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/5b75c477841fa463aad9c6e6d95a98b50ce14dd3"
      }
    ],
    "stats": {
      "total": 35,
      "additions": 31,
      "deletions": 4
    },
    "files": [
      {
        "sha": "463871d17821832374f0d1fc6a3584a8be510ca6",
        "filename": "src/core_read.cpp",
        "status": "modified",
        "additions": 26,
        "deletions": 3,
        "changes": 29,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ac4e438229134595e949bfedb1f487c71fd45d24/src/core_read.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ac4e438229134595e949bfedb1f487c71fd45d24/src/core_read.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/core_read.cpp?ref=ac4e438229134595e949bfedb1f487c71fd45d24",
        "patch": "@@ -88,18 +88,40 @@ CScript ParseScript(const std::string& s)\n     return result;\n }\n \n+// Check that all of the input and output scripts of a transaction contains valid opcodes\n+bool CheckTxScriptsSanity(const CMutableTransaction& tx)\n+{\n+    // Check input scripts for non-coinbase txs\n+    if (!CTransaction(tx).IsCoinBase()) {\n+        for (unsigned int i = 0; i < tx.vin.size(); i++) {\n+            if (!tx.vin[i].scriptSig.HasValidOps() || tx.vin[i].scriptSig.size() > MAX_SCRIPT_SIZE) {\n+                return false;\n+            }\n+        }\n+    }\n+    // Check output scripts\n+    for (unsigned int i = 0; i < tx.vout.size(); i++) {\n+        if (!tx.vout[i].scriptPubKey.HasValidOps() || tx.vout[i].scriptPubKey.size() > MAX_SCRIPT_SIZE) {\n+            return false;\n+        }\n+    }\n+    \n+    return true;\n+}\n+\n bool DecodeHexTx(CMutableTransaction& tx, const std::string& strHexTx, bool fTryNoWitness)\n {\n-    if (!IsHex(strHexTx))\n+    if (!IsHex(strHexTx)) {\n         return false;\n+    }\n \n     std::vector<unsigned char> txData(ParseHex(strHexTx));\n \n     if (fTryNoWitness) {\n         CDataStream ssData(txData, SER_NETWORK, PROTOCOL_VERSION | SERIALIZE_TRANSACTION_NO_WITNESS);\n         try {\n             ssData >> tx;\n-            if (ssData.eof()) {\n+            if (ssData.eof() && CheckTxScriptsSanity(tx)) {\n                 return true;\n             }\n         }\n@@ -111,8 +133,9 @@ bool DecodeHexTx(CMutableTransaction& tx, const std::string& strHexTx, bool fTry\n     CDataStream ssData(txData, SER_NETWORK, PROTOCOL_VERSION);\n     try {\n         ssData >> tx;\n-        if (!ssData.empty())\n+        if (!ssData.empty()) {\n             return false;\n+        }\n     }\n     catch (const std::exception&) {\n         return false;"
      },
      {
        "sha": "a10b619f7d439facc87c512ed820ddf3442e07b8",
        "filename": "src/script/script.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ac4e438229134595e949bfedb1f487c71fd45d24/src/script/script.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ac4e438229134595e949bfedb1f487c71fd45d24/src/script/script.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/script.cpp?ref=ac4e438229134595e949bfedb1f487c71fd45d24",
        "patch": "@@ -273,7 +273,8 @@ bool CScript::HasValidOps() const\n     CScript::const_iterator it = begin();\n     while (it < end()) {\n         opcodetype opcode;\n-        if (!GetOp(it, opcode) || opcode > 0xb9) {\n+        std::vector<unsigned char> item;\n+        if (!GetOp(it, opcode, item) || opcode > MAX_OPCODE || item.size() > MAX_SCRIPT_ELEMENT_SIZE) {\n             return false;\n         }\n     }"
      },
      {
        "sha": "23706b9826dd34de61e02988552def888c7953f7",
        "filename": "src/script/script.h",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ac4e438229134595e949bfedb1f487c71fd45d24/src/script/script.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ac4e438229134595e949bfedb1f487c71fd45d24/src/script/script.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/script.h?ref=ac4e438229134595e949bfedb1f487c71fd45d24",
        "patch": "@@ -190,6 +190,9 @@ enum opcodetype\n     OP_INVALIDOPCODE = 0xff,\n };\n \n+// Maximum value that an opcode can be\n+static const unsigned int MAX_OPCODE = OP_NOP10;\n+\n const char* GetOpName(opcodetype opcode);\n \n class scriptnum_error : public std::runtime_error"
      }
    ]
  }
]