[
  {
    "sha": "75e628064921e4d921cbe59f2a899240c198de7b",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3NWU2MjgwNjQ5MjFlNGQ5MjFjYmU1OWYyYTg5OTI0MGMxOThkZTdi",
    "commit": {
      "author": {
        "name": "Troy Giorshev",
        "email": "troygiorshev@gmail.com",
        "date": "2020-08-05T21:55:41Z"
      },
      "committer": {
        "name": "Troy Giorshev",
        "email": "troygiorshev@gmail.com",
        "date": "2020-11-03T16:57:38Z"
      },
      "message": "cleanup: Clean PushMessage\n\nThis commit brings PushMessage in line with the style guide, with a few\nsimple renames, some changes to if statements, and the removal of an\nunnecessary \"== true\".\n\nEaster Egg - serializedHeader has the weird \"in between\" naming\nconvention: no szHungarianNotation but still camelCase.",
      "tree": {
        "sha": "cf3b49842c82f5d10bd5b03e6e439a1401e9135b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cf3b49842c82f5d10bd5b03e6e439a1401e9135b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/75e628064921e4d921cbe59f2a899240c198de7b",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/75e628064921e4d921cbe59f2a899240c198de7b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/75e628064921e4d921cbe59f2a899240c198de7b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/75e628064921e4d921cbe59f2a899240c198de7b/comments",
    "author": {
      "login": "troygiorshev",
      "id": 5553787,
      "node_id": "MDQ6VXNlcjU1NTM3ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5553787?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/troygiorshev",
      "html_url": "https://github.com/troygiorshev",
      "followers_url": "https://api.github.com/users/troygiorshev/followers",
      "following_url": "https://api.github.com/users/troygiorshev/following{/other_user}",
      "gists_url": "https://api.github.com/users/troygiorshev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/troygiorshev/subscriptions",
      "organizations_url": "https://api.github.com/users/troygiorshev/orgs",
      "repos_url": "https://api.github.com/users/troygiorshev/repos",
      "events_url": "https://api.github.com/users/troygiorshev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/troygiorshev/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "troygiorshev",
      "id": 5553787,
      "node_id": "MDQ6VXNlcjU1NTM3ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5553787?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/troygiorshev",
      "html_url": "https://github.com/troygiorshev",
      "followers_url": "https://api.github.com/users/troygiorshev/followers",
      "following_url": "https://api.github.com/users/troygiorshev/following{/other_user}",
      "gists_url": "https://api.github.com/users/troygiorshev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/troygiorshev/subscriptions",
      "organizations_url": "https://api.github.com/users/troygiorshev/orgs",
      "repos_url": "https://api.github.com/users/troygiorshev/repos",
      "events_url": "https://api.github.com/users/troygiorshev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/troygiorshev/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "bb2a9f9c8c555e6055d78a73f897bafc1c73c726",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/bb2a9f9c8c555e6055d78a73f897bafc1c73c726",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/bb2a9f9c8c555e6055d78a73f897bafc1c73c726"
      }
    ],
    "stats": {
      "total": 34,
      "additions": 18,
      "deletions": 16
    },
    "files": [
      {
        "sha": "fcb2fba59c41c76c1da31a08931aee558b5e5643",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 18,
        "deletions": 16,
        "changes": 34,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/75e628064921e4d921cbe59f2a899240c198de7b/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/75e628064921e4d921cbe59f2a899240c198de7b/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=75e628064921e4d921cbe59f2a899240c198de7b",
        "patch": "@@ -2813,35 +2813,37 @@ bool CConnman::NodeFullyConnected(const CNode* pnode)\n \n void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n {\n-    size_t nMessageSize = msg.data.size();\n-    LogPrint(BCLog::NET, \"sending %s (%d bytes) peer=%d\\n\",  SanitizeString(msg.m_type), nMessageSize, pnode->GetId());\n+    const size_t message_size{msg.data.size()};\n+    LogPrint(BCLog::NET, \"sending %s (%d bytes) peer=%d\\n\", SanitizeString(msg.m_type), message_size, pnode->GetId());\n \n     // make sure we use the appropriate network transport format\n-    std::vector<unsigned char> serializedHeader;\n-    pnode->m_serializer->prepareForTransport(msg, serializedHeader);\n-    size_t nTotalSize = nMessageSize + serializedHeader.size();\n+    std::vector<unsigned char> serialized_header;\n+    pnode->m_serializer->prepareForTransport(msg, serialized_header);\n+    const size_t total_size{message_size + serialized_header.size()};\n \n-    size_t nBytesSent = 0;\n+    size_t bytes_sent{0};\n     {\n         LOCK(pnode->cs_vSend);\n-        bool optimisticSend(pnode->vSendMsg.empty());\n+        bool optimistic_send{pnode->vSendMsg.empty()};\n \n         //log total amount of bytes per message type\n-        pnode->mapSendBytesPerMsgCmd[msg.m_type] += nTotalSize;\n-        pnode->nSendSize += nTotalSize;\n+        pnode->mapSendBytesPerMsgCmd[msg.m_type] += total_size;\n+        pnode->nSendSize += total_size;\n \n-        if (pnode->nSendSize > nSendBufferMaxSize)\n+        if (pnode->nSendSize > nSendBufferMaxSize) {\n             pnode->fPauseSend = true;\n-        pnode->vSendMsg.push_back(std::move(serializedHeader));\n-        if (nMessageSize)\n+        }\n+        pnode->vSendMsg.push_back(std::move(serialized_header));\n+        if (message_size) {\n             pnode->vSendMsg.push_back(std::move(msg.data));\n+        }\n \n         // If write queue empty, attempt \"optimistic write\"\n-        if (optimisticSend == true)\n-            nBytesSent = SocketSendData(pnode);\n+        if (optimistic_send) {\n+            bytes_sent = SocketSendData(pnode);\n+        }\n     }\n-    if (nBytesSent)\n-        RecordBytesSent(nBytesSent);\n+    if (bytes_sent) RecordBytesSent(bytes_sent);\n }\n \n bool CConnman::ForNode(NodeId id, std::function<bool(CNode* pnode)> func)"
      }
    ]
  },
  {
    "sha": "92897d43443db3a7cd68d8655d1bbf4b9b69c427",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5Mjg5N2Q0MzQ0M2RiM2E3Y2Q2OGQ4NjU1ZDFiYmY0YjliNjljNDI3",
    "commit": {
      "author": {
        "name": "Troy Giorshev",
        "email": "troygiorshev@gmail.com",
        "date": "2020-08-26T13:29:12Z"
      },
      "committer": {
        "name": "Troy Giorshev",
        "email": "troygiorshev@gmail.com",
        "date": "2020-11-03T16:57:51Z"
      },
      "message": "Add missing lock annotations\n\nThese variables are already guarded by cs_vSend, they are just missing\nthe annotations.",
      "tree": {
        "sha": "1e3c1988d36bf48f9090ac87ef9149aa89790d95",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1e3c1988d36bf48f9090ac87ef9149aa89790d95"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/92897d43443db3a7cd68d8655d1bbf4b9b69c427",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/92897d43443db3a7cd68d8655d1bbf4b9b69c427",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/92897d43443db3a7cd68d8655d1bbf4b9b69c427",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/92897d43443db3a7cd68d8655d1bbf4b9b69c427/comments",
    "author": {
      "login": "troygiorshev",
      "id": 5553787,
      "node_id": "MDQ6VXNlcjU1NTM3ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5553787?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/troygiorshev",
      "html_url": "https://github.com/troygiorshev",
      "followers_url": "https://api.github.com/users/troygiorshev/followers",
      "following_url": "https://api.github.com/users/troygiorshev/following{/other_user}",
      "gists_url": "https://api.github.com/users/troygiorshev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/troygiorshev/subscriptions",
      "organizations_url": "https://api.github.com/users/troygiorshev/orgs",
      "repos_url": "https://api.github.com/users/troygiorshev/repos",
      "events_url": "https://api.github.com/users/troygiorshev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/troygiorshev/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "troygiorshev",
      "id": 5553787,
      "node_id": "MDQ6VXNlcjU1NTM3ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5553787?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/troygiorshev",
      "html_url": "https://github.com/troygiorshev",
      "followers_url": "https://api.github.com/users/troygiorshev/followers",
      "following_url": "https://api.github.com/users/troygiorshev/following{/other_user}",
      "gists_url": "https://api.github.com/users/troygiorshev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/troygiorshev/subscriptions",
      "organizations_url": "https://api.github.com/users/troygiorshev/orgs",
      "repos_url": "https://api.github.com/users/troygiorshev/repos",
      "events_url": "https://api.github.com/users/troygiorshev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/troygiorshev/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "75e628064921e4d921cbe59f2a899240c198de7b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/75e628064921e4d921cbe59f2a899240c198de7b",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/75e628064921e4d921cbe59f2a899240c198de7b"
      }
    ],
    "stats": {
      "total": 6,
      "additions": 3,
      "deletions": 3
    },
    "files": [
      {
        "sha": "0a3a8cc788dcf2790a9670906d108bbbd9ea3325",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/92897d43443db3a7cd68d8655d1bbf4b9b69c427/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/92897d43443db3a7cd68d8655d1bbf4b9b69c427/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=92897d43443db3a7cd68d8655d1bbf4b9b69c427",
        "patch": "@@ -759,8 +759,8 @@ class CNode\n     // socket\n     std::atomic<ServiceFlags> nServices{NODE_NONE};\n     SOCKET hSocket GUARDED_BY(cs_hSocket);\n-    size_t nSendSize{0}; // total size of all vSendMsg entries\n-    size_t nSendOffset{0}; // offset inside the first vSendMsg already sent\n+    size_t nSendSize GUARDED_BY(cs_vSend){0}; // total size of all vSendMsg entries\n+    size_t nSendOffset GUARDED_BY(cs_vSend){0}; // offset inside the first vSendMsg already sent\n     uint64_t nSendBytes GUARDED_BY(cs_vSend){0};\n     std::deque<std::vector<unsigned char>> vSendMsg GUARDED_BY(cs_vSend);\n     RecursiveMutex cs_vSend;\n@@ -817,7 +817,7 @@ class CNode\n     std::atomic_bool fPauseSend{false};\n \n protected:\n-    mapMsgCmdSize mapSendBytesPerMsgCmd;\n+    mapMsgCmdSize mapSendBytesPerMsgCmd GUARDED_BY(cs_vSend);\n     mapMsgCmdSize mapRecvBytesPerMsgCmd GUARDED_BY(cs_vRecv);\n \n public:"
      }
    ]
  },
  {
    "sha": "9d47d6da524b78ee4a628119f09636b855e881a2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo5ZDQ3ZDZkYTUyNGI3OGVlNGE2MjgxMTlmMDk2MzZiODU1ZTg4MWEy",
    "commit": {
      "author": {
        "name": "Troy Giorshev",
        "email": "troygiorshev@gmail.com",
        "date": "2020-08-05T21:52:33Z"
      },
      "committer": {
        "name": "Troy Giorshev",
        "email": "troygiorshev@gmail.com",
        "date": "2020-11-03T16:57:51Z"
      },
      "message": "Move cs_vSend lock into SocketSendData\n\nSocketSendData requires cs_vSend to be locked, but it places this\nresponsibility with the caller.  This is unnecessary, unclear, and has\ncaused us to accidentally add RecordBytesSent under the lock.\n\nThis commit fixes both problems.\n\nJustification is needed in the case of PushMessage.  It is ok that we\nlet go of cs_vSend for a moment before locking it again and calling\nSocketSendData.  In the case where optimistic_send == false, this lock\nis let go of for a long time between adding messages to vSendMsg and the\ncall to SocketSendData (in SocketHandler).  As corrected in the comment\nchange, optimistic_send represents whether vSendMsg *was* empty, not\n*is* empty (as, of course, we've just added to it).\n\nIf SocketHandler grabs cs_vSend in the middle then SocketSendData will\nbe empty when we call it in PushMessage.  As suggested by the \"if\n(bytes_sent)\" check, this is fine.",
      "tree": {
        "sha": "1eed4ebf431b9f288a5a91d43ce816b8a71512b9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1eed4ebf431b9f288a5a91d43ce816b8a71512b9"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/9d47d6da524b78ee4a628119f09636b855e881a2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9d47d6da524b78ee4a628119f09636b855e881a2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/9d47d6da524b78ee4a628119f09636b855e881a2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/9d47d6da524b78ee4a628119f09636b855e881a2/comments",
    "author": {
      "login": "troygiorshev",
      "id": 5553787,
      "node_id": "MDQ6VXNlcjU1NTM3ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5553787?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/troygiorshev",
      "html_url": "https://github.com/troygiorshev",
      "followers_url": "https://api.github.com/users/troygiorshev/followers",
      "following_url": "https://api.github.com/users/troygiorshev/following{/other_user}",
      "gists_url": "https://api.github.com/users/troygiorshev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/troygiorshev/subscriptions",
      "organizations_url": "https://api.github.com/users/troygiorshev/orgs",
      "repos_url": "https://api.github.com/users/troygiorshev/repos",
      "events_url": "https://api.github.com/users/troygiorshev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/troygiorshev/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "troygiorshev",
      "id": 5553787,
      "node_id": "MDQ6VXNlcjU1NTM3ODc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5553787?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/troygiorshev",
      "html_url": "https://github.com/troygiorshev",
      "followers_url": "https://api.github.com/users/troygiorshev/followers",
      "following_url": "https://api.github.com/users/troygiorshev/following{/other_user}",
      "gists_url": "https://api.github.com/users/troygiorshev/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/troygiorshev/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/troygiorshev/subscriptions",
      "organizations_url": "https://api.github.com/users/troygiorshev/orgs",
      "repos_url": "https://api.github.com/users/troygiorshev/repos",
      "events_url": "https://api.github.com/users/troygiorshev/events{/privacy}",
      "received_events_url": "https://api.github.com/users/troygiorshev/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "92897d43443db3a7cd68d8655d1bbf4b9b69c427",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/92897d43443db3a7cd68d8655d1bbf4b9b69c427",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/92897d43443db3a7cd68d8655d1bbf4b9b69c427"
      }
    ],
    "stats": {
      "total": 25,
      "additions": 11,
      "deletions": 14
    },
    "files": [
      {
        "sha": "b234a052bea311181bfa8802a2691b7104c571c0",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 11,
        "deletions": 14,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/9d47d6da524b78ee4a628119f09636b855e881a2/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/9d47d6da524b78ee4a628119f09636b855e881a2/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=9d47d6da524b78ee4a628119f09636b855e881a2",
        "patch": "@@ -747,8 +747,9 @@ void V1TransportSerializer::prepareForTransport(CSerializedNetMsg& msg, std::vec\n     CVectorWriter{SER_NETWORK, INIT_PROTO_VERSION, header, 0, hdr};\n }\n \n-size_t CConnman::SocketSendData(CNode *pnode) const EXCLUSIVE_LOCKS_REQUIRED(pnode->cs_vSend)\n+size_t CConnman::SocketSendData(CNode *pnode) const\n {\n+    LOCK(pnode->cs_vSend);\n     auto it = pnode->vSendMsg.begin();\n     size_t nSentSize = 0;\n \n@@ -1445,11 +1446,8 @@ void CConnman::SocketHandler()\n         //\n         if (sendSet)\n         {\n-            LOCK(pnode->cs_vSend);\n-            size_t nBytes = SocketSendData(pnode);\n-            if (nBytes) {\n-                RecordBytesSent(nBytes);\n-            }\n+            const size_t bytes_sent{SocketSendData(pnode)};\n+            if (bytes_sent) RecordBytesSent(bytes_sent);\n         }\n \n         InactivityCheck(pnode);\n@@ -2821,10 +2819,10 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n     pnode->m_serializer->prepareForTransport(msg, serialized_header);\n     const size_t total_size{message_size + serialized_header.size()};\n \n-    size_t bytes_sent{0};\n+    bool optimistic_send{false};\n     {\n         LOCK(pnode->cs_vSend);\n-        bool optimistic_send{pnode->vSendMsg.empty()};\n+        optimistic_send = pnode->vSendMsg.empty();\n \n         //log total amount of bytes per message type\n         pnode->mapSendBytesPerMsgCmd[msg.m_type] += total_size;\n@@ -2837,13 +2835,12 @@ void CConnman::PushMessage(CNode* pnode, CSerializedNetMsg&& msg)\n         if (message_size) {\n             pnode->vSendMsg.push_back(std::move(msg.data));\n         }\n-\n-        // If write queue empty, attempt \"optimistic write\"\n-        if (optimistic_send) {\n-            bytes_sent = SocketSendData(pnode);\n-        }\n     }\n-    if (bytes_sent) RecordBytesSent(bytes_sent);\n+    // If write queue was empty, attempt \"optimistic write\"\n+    if (optimistic_send) {\n+        const size_t bytes_sent{SocketSendData(pnode)};\n+        if (bytes_sent) RecordBytesSent(bytes_sent);\n+    }\n }\n \n bool CConnman::ForNode(NodeId id, std::function<bool(CNode* pnode)> func)"
      }
    ]
  }
]