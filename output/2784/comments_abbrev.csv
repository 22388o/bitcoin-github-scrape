sipa,2013-06-22T17:30:14Z,@mikehearn Would this interact badly with BitcoinJ wallets? How frequently do they send pings?\n(or anyone with an alternate implementation)\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-19861397,19861397,
mikehearn,2013-06-23T13:56:57Z,"bitcoinj sends pings every two seconds, it's much more aggressive than this patch. We could certainly reduce it. Ping times are used to pick which peer to download from.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-19874318,19874318,
jgarzik,2013-06-23T19:50:34Z,The disconnect logic seems like it would negatively impact testnet.\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-19879931,19879931,
sipa,2013-06-23T22:20:15Z,"Inverted the logic, so it now becomes a ping if nothing has been received for a while, rather than sent.\n\nTested that it indeed detects broken connections within one minute.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-19882740,19882740,
mikehearn,2013-07-05T10:41:12Z,"Change looks good to me, although it will have the effect of disconnecting any nodes that don't respond to pings with pongs (or some other message). As pong messages were added in protocol version 60000 it would effectively EOL clients older than that and this may deserve an announcement somewhere.\n\nHowever bitcoinj clients will be fine with it.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-20512785,20512785,
gmaxwell,2013-07-07T16:46:13Z,"So, this causes nodes to impose an upper bound on their peers response latency. Effectively, someone who will take a minute to respond can't participate in the network at all. This may adversely impact some anonymity protocols which cause high latencyâ€” for many kinds of Bitcoin usage the latency isn't all that critical. I'd suggest that such users should be using an alternative transport, except t",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-20573463,20573463,
mikehearn,2013-07-08T13:00:05Z,"It would be easy to adjust the timeout for onion addresses, but really, I'm not sure we want nodes in the network that can't respond within a minute. Slow nodes can have terrible effects on the user experience for SPV wallets. They will automatically drop to the bottom of the preference list in bitcoinj and not be used for much except observing broadcasts, for that reason.\n\nThat said, just dropp",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-20603317,20603317,
jgarzik,2013-08-25T03:05:17Z,"How about a 5-minute timeout, and get this merged?  Maybe 1 minute is too short, but 90 is far too long.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-23220987,23220987,
sipa,2013-10-14T00:16:43Z,"Suggestion: send pings _every_ 2 minutes (even in case something was received recently, with the new ping-response-time-measurement that means we always get some useful latency information), and disconnect after receiving nothing for 5 minutes.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-26230542,26230542,
gmaxwell,2013-10-14T17:15:58Z,@sipa  ACK unconditional 2 minute ping plus 5 minute disconnect.\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-26272177,26272177,
sipa,2013-10-14T22:42:20Z,Rebased & updated.\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-26295067,26295067,
gavinandresen,2013-10-14T23:10:05Z,ACK.\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-26296509,26296509,
sipa,2013-10-14T23:21:22Z,There may be a bug in this code; will investigate later.\n\nEDIT: fixed.\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-26297069,26297069,
jgarzik,2013-10-15T02:21:55Z,"ACK\n\nOptional nit:  ""5 \* 60"" is more self-documenting than ""300"", and the previous code used the ""M \* 60"" notation.  All modern compilers will automatically convert the more human-readable M*60 at compile time, so there is no added runtime cost.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-26304885,26304885,
sipa,2013-10-15T20:08:59Z,"Moved/added the ping/timeout constants to net.h (where they can be accessed by both net & main), and changed the timeout logic a bit: either there is an unanswered ping >5 minutes old, or there has been no message received at all for 5 minutes.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-26367710,26367710,
sipa,2013-10-16T18:25:54Z,"Currently running this patch myself on bitcoin.sipa.be. I see a surprisingly high number of ping timeouts and inactivity timeouts (every 10 minutes or so, very irregularly). I'll investigate whether these are actual connections that go dead (in which case this patch is actually useful...) or a problem with the disconnection logic.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-26444184,26444184,
luke-jr,2014-02-21T01:11:17Z,@sipa What did you find?\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-35689194,35689194,
sipa,2014-05-10T13:30:27Z,"Rebased, and made some changes (better reporting, and don't enforce 5-minute receive timeout on pre-BIP31 peers).\n\nI'm testing it again myself.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-42741756,42741756,
sipa,2014-05-10T13:35:37Z,"Strange, I have one peer (/Satoshi:0.8.6/, proto v70001) which seems to disconnect when it receives a ping message, and then immediately reconnects.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-42741874,42741874,
sipa,2014-05-11T09:34:36Z,"Seems the majority of timeouts detected are ping timeouts from getaddr.bitnodes.io (which apparently only recently implemented ping/pong - though probably not yet deployed).\n\nApart from that I do quite some others, from various clients and IPs, every ~10 minutes on average the past hours. These look like genuine connection problems.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-42766164,42766164,
ayeowch,2014-05-11T09:48:13Z,@sipa I have just deployed the ping/pong update to getaddr.bitnodes.io. The crawler should be responding to incoming ping properly now.\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-42766402,42766402,
sipa,2014-05-11T10:17:26Z,"@ayeowch Cool, good to know. I'm not seeing any pongs yet, though...\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-42766947,42766947,
ayeowch,2014-05-11T10:26:24Z,@sipa Hmm.. If the crawler (subver=/getaddr.bitnodes.io:0.1/) is already connected to your node. Try sending a ping with `bitcoind ping`. I did get pong from the crawler by doing this.\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-42767115,42767115,
sipa,2014-05-11T10:31:38Z,2014-05-11 10:27:53 Sending ping to [2a01:4f8:202:81b1::2]:48980 /getaddr.bitnodes.io:0.1/\n\nNo pong afterwards (while I do receive pongs from other nodes).\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-42767220,42767220,
sipa,2014-05-31T11:50:17Z,"For reference: the problem with bitnodes.io was lingering connections from a crawler that didn't support BIP31 (but advertized a protocol version that did), which was fixed on their side now.\n\nI'm seeing occassional disconnects because of the new ping timeouts, but I believe these are correct.\n\nAny objections to merging?\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-44746241,44746241,
laanwj,2014-06-05T04:55:20Z,"@sipa No objections to pinging more, but I'm a bit wary about the 'disconnect nodes faster' part of this. Going from 90 minutes to 5 minutes is a big change. It wouldn't be the first time that something is introduced that can hang bitcoind for a few minutes.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-45180890,45180890,
leofidus,2014-06-06T00:55:27Z,"I think there are already scenarios where network pings are not answered within 5 minutes. For example the `importprivkey` rpc command can lock cs_main for many minutes during a rescan. If during that time a network message arrives which also requires a lock on cs_main (for example a harmless inv), this locks the network thread until the rescan is complete. This leaves the peer unable to answer pi",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-45292760,45292760,
sipa,2014-06-06T01:02:54Z,"I think it's reasonable that peers disconnect you during that time. You can't use their service, and they can't use yours.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-45293118,45293118,
laanwj,2014-06-06T03:53:51Z,To me it just doesn't feel very robust to have the network fall apart when somehow 5 minutes of lag are introduced.\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-45300676,45300676,
sipa,2014-06-08T21:25:46Z,@laanwj What timeout would you find acceptable?\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-45449092,45449092,
laanwj,2014-06-09T11:11:29Z,Let's pick uhm... 20 minutes. That slices the current inactivity timeout in four already. We can always lower the value later.\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-45481102,45481102,
gmaxwell,2014-06-09T20:57:17Z,"@wumpus TCP itself will fail over long before that if the network itself is delayed. A node thats holding up our connection but not responding for >5 minutes is _really_ broken as far as we should care. It can reconnect when it can start responding again.  (and yes, in some cases bitocoind is 'broken', but thats okay... reconnecting is fairly cheap).\n\nThe flip side of a long timeout is that we'l",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-45543171,45543171,
sipa,2014-06-09T21:00:24Z,Increased the timeout to 20 minutes.\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-45543527,45543527,
gmaxwell,2014-06-09T21:05:54Z,@sipa The commit message is now wrong.\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-45544180,45544180,
sipa,2014-06-09T21:07:14Z,Fixed.\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-45544336,45544336,
BitcoinPullTester,2014-06-09T21:31:41Z,"Automatic sanity-testing: PASSED, see http://jenkins.bluematt.me/pull-tester/f1920e86063d0ed008c6028d8223b0e21889bf75 for binaries and test log.\nThis test script verifies pulls every time they are updated. It, however, dies sometimes and fails to test properly.  If you are waiting on a test, please check timestamps to verify that the test.log is moving at http://jenkins.bluematt.me/pull-tester/cu",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-45547052,45547052,
laanwj,2014-06-09T21:56:01Z,@gmaxwell I just want to be careful here.\n\n@sipa Looks good to me now.\n,https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-45549500,45549500,
cozz,2014-06-13T17:58:27Z,"Just tested on mainnet:\n- start with maxconnections=1\n- initial pingtime under a second\n- wait for block sync to start\n- ping\n- pingtime=140s\n\nThe problem is the node is busy sending us blocks, so does not respond to the ping.\nI think we should delay the ping when blocks are in flight.\n\n![ping](https://cloud.githubusercontent.com/assets/2814559/3273364/7354af1e-f323-11e3-936f-0b9e6db4fae",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-46041291,46041291,
gmaxwell,2014-06-13T18:06:13Z,"@cozz  I don't understand your concern.  Yes, pings will take a lot of time in the case, but it will not be disconnected.\n",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-46042180,46042180,
cozz,2014-06-13T18:32:44Z,"Well, I thought if the pingtime is used for peer-selection later, then you probably dont want to ping, if you know that the ping will be much slower as normal, because blocks are in flight.\nI dont have any concerns for now, just saying that if we are going to judge a peer by its periodically pingtime, a slow ping does not necessarily mean a slow node. In my case the node is a good node, just busy",https://github.com/bitcoin/bitcoin/pull/2784#issuecomment-46045079,46045079,
Diapolo,2013-10-15T20:55:38Z,Small nit: Perhaps indent the comments to be in line.\n,https://github.com/bitcoin/bitcoin/pull/2784#discussion_r6984726,6984726,src/net.h
sipa,2013-10-15T21:36:47Z,Done.\n,https://github.com/bitcoin/bitcoin/pull/2784#discussion_r6985909,6985909,src/net.h
