theuni,2016-10-04T00:29:29Z,"Concept ACK and quick code-review ACK other than the nits. I'd like to spend some time testing, though.\n",https://github.com/bitcoin/bitcoin/pull/8865#issuecomment-251265292,251265292,
TheBlueMatt,2016-10-04T02:41:22Z,"No? I think after this patch set the only place mapBlockSource is erased from is this line.\n\nOn October 3, 2016 8:26:53 PM EDT, Cory Fields notifications@github.com wrote:\n\n> theuni commented on this pull request.\n> \n> > +\n> > -        const uint256 hash(block.GetHash());\n> > -        std::map<uint256, NodeId>::iterator it =\n> >   mapBlockSource.find(hash);\n> >   +\n> > -        int nDoS",https://github.com/bitcoin/bitcoin/pull/8865#issuecomment-251281504,251281504,
theuni,2016-10-04T05:33:19Z,I was just pointing out that this looks to be a memleak bugfix :)\n,https://github.com/bitcoin/bitcoin/pull/8865#issuecomment-251299990,251299990,
TheBlueMatt,2016-10-04T13:18:23Z,"I dont believe it is actually any (much?) different than it used to be. Maybe it will be deleted more often on reorgs now, I didnt investigate fully. In any case, its pretty hard to DoS since you only add to the map after AcceptBlock succeeds (ie the block is syntactically valid/connects/has valid PoW)\n",https://github.com/bitcoin/bitcoin/pull/8865#issuecomment-251385087,251385087,
TheBlueMatt,2016-10-04T13:46:39Z,"Switched g_connman to be a shared_ptr instead of a unique_ptr, which I think should neatly address all the outstanding nits.\n",https://github.com/bitcoin/bitcoin/pull/8865#issuecomment-251392182,251392182,
TheBlueMatt,2016-10-04T16:50:17Z,"Backed out the shared_ptr change, I misunderstood @theuni's comments, just fixed the make_pair nit and left everything else as-is: it should be easier to clean up things like class design once everything is split out.\n",https://github.com/bitcoin/bitcoin/pull/8865#issuecomment-251445444,251445444,
TheBlueMatt,2016-10-04T17:56:42Z,"Restructured the code after discussion on IRC with @theuni...now the CValidationInterface subclass is defined in main.h (requires an extra include, but we can drop that when we move all the stuff to another file) and init.cpp itself does the object initialization and keeps the CValidationInterface around.\n",https://github.com/bitcoin/bitcoin/pull/8865#issuecomment-251463559,251463559,
laanwj,2016-10-18T20:48:08Z,utACK a9aec5c\n,https://github.com/bitcoin/bitcoin/pull/8865#issuecomment-254634772,254634772,
theuni,2016-10-18T21:37:09Z,post-merge utACK.\n,https://github.com/bitcoin/bitcoin/pull/8865#issuecomment-254646818,254646818,
sipa,2016-10-30T20:43:43Z,Posthummus utACK.\n,https://github.com/bitcoin/bitcoin/pull/8865#issuecomment-257177673,257177673,
theuni,2016-10-03T17:47:58Z,"nit: don't make_pair with emplace, just use the components directly.\n",https://github.com/bitcoin/bitcoin/pull/8865#discussion_r81602325,81602325,src/main.cpp
theuni,2016-10-03T17:49:36Z,"Using a ptr for the index feels kinda icky. Since a reference is passed and stored anyway, let's add an Id to CConnman instead. It'll be helpful in other places too.\n",https://github.com/bitcoin/bitcoin/pull/8865#discussion_r81602663,81602663,src/main.cpp
TheBlueMatt,2016-10-03T21:14:25Z,"Hmm, I feel like that is a layer violation? If CConnman is a low-level network socket/connection manager, it should have little knowledge of the fact that there is something hooked up above it to listen to validation callbacks and do things with them?\n",https://github.com/bitcoin/bitcoin/pull/8865#discussion_r81641546,81641546,src/main.cpp
theuni,2016-10-03T22:17:42Z,"Sorry, I meant: add a GetID() to CConnman, which would return a const value set during construction. That would allow maps to be created which refer to specific connman instances without tying them to a pointer.\n",https://github.com/bitcoin/bitcoin/pull/8865#discussion_r81652021,81652021,src/main.cpp
TheBlueMatt,2016-10-03T22:20:05Z,I think we're overengineering? Are we ever really gonna have more than one CConnman? Maybe something without even a map is simpler?\n,https://github.com/bitcoin/bitcoin/pull/8865#discussion_r81652347,81652347,src/main.cpp
theuni,2016-10-03T23:37:08Z,"I'm hoping to be able to hook up 2 CConnmans to eachother in the future for testing against eachother, yes. I've gone to significant efforts to remove the ""stuff a static global somewhere"" practice from much of the net code, please don't start reintroducing.\n\nA pointer is fine here if you'd prefer to keep it simple, we can adapt later if needed.\n",https://github.com/bitcoin/bitcoin/pull/8865#discussion_r81662860,81662860,src/main.cpp
theuni,2016-10-04T00:26:45Z,"Hmm, were these not erased before in the invalid case?\n",https://github.com/bitcoin/bitcoin/pull/8865#discussion_r81668063,81668063,src/main.cpp
theuni,2016-10-18T20:58:19Z,"If pnode->nStartingHeight is -1, we just haven't completed the version handshake, no? Shouldn't we always refuse to relay in that case?\n\nOr am I not seeing some other way this can happen?\n",https://github.com/bitcoin/bitcoin/pull/8865#discussion_r83949369,83949369,src/main.cpp
TheBlueMatt,2016-10-18T21:15:53Z,"Indeed, probably, though that would be a behavior change whereas this PR shouldnt have any :p.\n",https://github.com/bitcoin/bitcoin/pull/8865#discussion_r83952681,83952681,src/main.cpp
theuni,2016-10-18T21:31:06Z,"This is fine for now, but I think we ultimately want these split up.\n",https://github.com/bitcoin/bitcoin/pull/8865#discussion_r83955324,83955324,src/validationinterface.h
TheBlueMatt,2016-10-18T21:35:23Z,"Yea, I think medium-term we need to think hard about what goes in what signaling interface (we have two already that are highly duplicative, I have some thoughts but we should discuss)\n",https://github.com/bitcoin/bitcoin/pull/8865#discussion_r83956003,83956003,src/validationinterface.h
rebroad,2016-10-19T03:23:17Z,"The logic of this line is confusing now... If pnode->nStartingHeight = -1 then don't do (if nNewHeight > -1) but instead do (if nNewHeight > 0)?! It hardly makes any difference, it will return true, therefore simply do if (nNewHeight > pnode->nStartingHeight - 2000) without any need for the ? operator.\n\nAnyway, why make it always true and not make use of the nBlocksEstimate as was previously don",https://github.com/bitcoin/bitcoin/pull/8865#discussion_r83991876,83991876,src/main.cpp
rebroad,2016-10-19T03:28:56Z,Fixed in #8958 \n,https://github.com/bitcoin/bitcoin/pull/8865#discussion_r83992220,83992220,src/main.cpp
sipa,2016-10-30T20:36:17Z,"See the earlier commit: ""Remove duplicate nBlocksEstimate cmp (we already checked IsIBD())"".\n",https://github.com/bitcoin/bitcoin/pull/8865#discussion_r85668647,85668647,src/main.cpp
