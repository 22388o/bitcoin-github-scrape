[
  {
    "sha": "b5d5d231545d6f64f0791fa2966d4216391386ca",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiNWQ1ZDIzMTU0NWQ2ZjY0ZjA3OTFmYTI5NjZkNDIxNjM5MTM4NmNh",
    "commit": {
      "author": {
        "name": "Matt Drollette",
        "email": "matt@drollette.com",
        "date": "2020-07-30T16:38:31Z"
      },
      "committer": {
        "name": "Matt Drollette",
        "email": "matt@drollette.com",
        "date": "2020-07-30T16:44:48Z"
      },
      "message": "torcontrol: add -tortarget config\n\nThis allows torcontrol to auto configure the HiddenService even\nwhen Tor is running on a different host or within a containerized\nenvironment.",
      "tree": {
        "sha": "067ad257baa59f1fbf6aaad59b4517dc9848a64b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/067ad257baa59f1fbf6aaad59b4517dc9848a64b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b5d5d231545d6f64f0791fa2966d4216391386ca",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b5d5d231545d6f64f0791fa2966d4216391386ca",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b5d5d231545d6f64f0791fa2966d4216391386ca",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b5d5d231545d6f64f0791fa2966d4216391386ca/comments",
    "author": {
      "login": "MDrollette",
      "id": 329784,
      "node_id": "MDQ6VXNlcjMyOTc4NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/329784?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MDrollette",
      "html_url": "https://github.com/MDrollette",
      "followers_url": "https://api.github.com/users/MDrollette/followers",
      "following_url": "https://api.github.com/users/MDrollette/following{/other_user}",
      "gists_url": "https://api.github.com/users/MDrollette/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MDrollette/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MDrollette/subscriptions",
      "organizations_url": "https://api.github.com/users/MDrollette/orgs",
      "repos_url": "https://api.github.com/users/MDrollette/repos",
      "events_url": "https://api.github.com/users/MDrollette/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MDrollette/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "MDrollette",
      "id": 329784,
      "node_id": "MDQ6VXNlcjMyOTc4NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/329784?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MDrollette",
      "html_url": "https://github.com/MDrollette",
      "followers_url": "https://api.github.com/users/MDrollette/followers",
      "following_url": "https://api.github.com/users/MDrollette/following{/other_user}",
      "gists_url": "https://api.github.com/users/MDrollette/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MDrollette/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MDrollette/subscriptions",
      "organizations_url": "https://api.github.com/users/MDrollette/orgs",
      "repos_url": "https://api.github.com/users/MDrollette/repos",
      "events_url": "https://api.github.com/users/MDrollette/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MDrollette/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "edec7f7c254294cd5c46ae5cf304353d458bb852",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/edec7f7c254294cd5c46ae5cf304353d458bb852",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/edec7f7c254294cd5c46ae5cf304353d458bb852"
      }
    ],
    "stats": {
      "total": 11,
      "additions": 10,
      "deletions": 1
    },
    "files": [
      {
        "sha": "8b901a96c51b273f26d688ea554847d007f079bd",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b5d5d231545d6f64f0791fa2966d4216391386ca/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b5d5d231545d6f64f0791fa2966d4216391386ca/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=b5d5d231545d6f64f0791fa2966d4216391386ca",
        "patch": "@@ -461,6 +461,7 @@ void SetupServerArgs(NodeContext& node)\n     argsman.AddArg(\"-timeout=<n>\", strprintf(\"Specify connection timeout in milliseconds (minimum: 1, default: %d)\", DEFAULT_CONNECT_TIMEOUT), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-peertimeout=<n>\", strprintf(\"Specify p2p connection timeout in seconds. This option determines the amount of time a peer may be inactive before the connection to it is dropped. (minimum: 1, default: %d)\", DEFAULT_PEER_CONNECT_TIMEOUT), ArgsManager::ALLOW_ANY | ArgsManager::DEBUG_ONLY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-torcontrol=<ip>:<port>\", strprintf(\"Tor control port to use if onion listening enabled (default: %s)\", DEFAULT_TOR_CONTROL), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n+    argsman.AddArg(\"-tortarget=<ip:port>\", strprintf(\"Target for Tor HiddenService (default: 127.0.0.1:%i)\", defaultChainParams->GetDefaultPort()), ArgsManager::ALLOW_ANY, OptionsCategory::CONNECTION);\n     argsman.AddArg(\"-torpassword=<pass>\", \"Tor control port password (default: empty)\", ArgsManager::ALLOW_ANY | ArgsManager::SENSITIVE, OptionsCategory::CONNECTION);\n #ifdef USE_UPNP\n #if USE_UPNP"
      },
      {
        "sha": "5b6b47531ccd848d7c421dec83818a419ecac874",
        "filename": "src/torcontrol.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 1,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b5d5d231545d6f64f0791fa2966d4216391386ca/src/torcontrol.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b5d5d231545d6f64f0791fa2966d4216391386ca/src/torcontrol.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/torcontrol.cpp?ref=b5d5d231545d6f64f0791fa2966d4216391386ca",
        "patch": "@@ -531,12 +531,20 @@ void TorController::auth_cb(TorControlConnection& _conn, const TorControlReply&\n             SetReachable(NET_ONION, true);\n         }\n \n+        // Validate the target of the hidden service\n+        std::string targetArg = gArgs.GetArg(\"-tortarget\", \"127.0.0.1\");\n+        CService targetAddr;\n+        if (!Lookup(targetArg, targetAddr, GetListenPort(), false)) {\n+            LogPrintf(\"tor: Invalid -tortarget address or hostname: '%s'\\n\", targetArg);\n+            return;\n+        }\n+\n         // Finally - now create the service\n         if (private_key.empty()) // No private key, generate one\n             private_key = \"NEW:RSA1024\"; // Explicitly request RSA1024 - see issue #9214\n         // Request hidden service, redirect port.\n         // Note that the 'virtual' port is always the default port to avoid decloaking nodes using other ports.\n-        _conn.Command(strprintf(\"ADD_ONION %s Port=%i,127.0.0.1:%i\", private_key, Params().GetDefaultPort(), GetListenPort()),\n+        _conn.Command(strprintf(\"ADD_ONION %s Port=%i,%s\", private_key, Params().GetDefaultPort(), targetAddr.ToStringIPPort()),\n             std::bind(&TorController::add_onion_cb, this, std::placeholders::_1, std::placeholders::_2));\n     } else {\n         LogPrintf(\"tor: Authentication failed\\n\");"
      }
    ]
  }
]