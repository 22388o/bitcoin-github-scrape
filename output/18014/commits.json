[
  {
    "sha": "610a5b21fdf809ab4f1d15003484b518b6dde26a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2MTBhNWIyMWZkZjgwOWFiNGYxZDE1MDAzNDg0YjUxOGI2ZGRlMjZh",
    "commit": {
      "author": {
        "name": "Elichai Turkel",
        "email": "elichai.turkel@gmail.com",
        "date": "2020-01-28T16:45:19Z"
      },
      "committer": {
        "name": "Elichai Turkel",
        "email": "elichai.turkel@gmail.com",
        "date": "2021-03-19T14:23:45Z"
      },
      "message": "Add more benchmarks to siphash",
      "tree": {
        "sha": "a8c9b7cc46a5b0a8c574e17650796ae93a7a8eb7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a8c9b7cc46a5b0a8c574e17650796ae93a7a8eb7"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/610a5b21fdf809ab4f1d15003484b518b6dde26a",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJNBAABCAA3FiEEC5PUstyhDoo+NyfXk4PN6ejman8FAmBUs/IZHGVsaWNoYWku\ndHVya2VsQGdtYWlsLmNvbQAKCRCTg83p6OZqf5CFEAC6dfIabeTk8QIMLRercqAj\nazVYS7OTUDubBP8B9u8V86nPeCBNWDxs/SdjBXfbIG42ZZBBgxN9yOIseepd6S+E\nXSO/KTG0SYJfpBTMrwJKUYlcuH6Br+IVJDqNo0h2r0RvQS4pq3DrYrEGjG44rrgH\nvpxBUNo+2MEPHtaMPy0F9MFzz+DjjLhyvUeyKQFC+Ilpr8X6W+0ePxKIe3OjTKn9\n+vLeaS+rp6T0fsDyTdnEk8VPGkG4eJgOO9kMRyRgUwa6Myb0UqoZ5lt5M4ShFaOo\nsT8N2wug86hxGF+Z5+24fDOfEV4I5t54TJJi3ESwJ6poAwt4WRA1tgM8chmYaJkv\nR+Iz7J2EzgQCB95p5rQ3DWPADiEhxJwmsd23JwahaxkpEsn5iK5PpdZvviXWPN50\ntTrbwtvyZ4hg67iygyKqCdgEQ5512VJcn7rWe7UHmSrncsg/WTxZo78JFifFdkTP\naiWo8f+FAW8GXfr+LjWzh+HNq4IXNWQRgJiCJ5ZTGvaNL0dJoO6/iEm309ruKoSo\n0MpUm1Rz9zYD7t2QHKWftooB8ujftiafbaqC8xrV+5xs+Cs7aJyAmGuiYmsCdBkw\n6p36XfNFKM89E2GmjvdSnF0mPiV8+pF/VdktqxJlPSXczkWRGJkXx7lnKKaoO0qd\nAtAhU2zVHs549F+iIaIj1A==\n=q9ZP\n-----END PGP SIGNATURE-----",
        "payload": "tree a8c9b7cc46a5b0a8c574e17650796ae93a7a8eb7\nparent 05757aa860215a8fd5002d99b6ec653175c6b734\nauthor Elichai Turkel <elichai.turkel@gmail.com> 1580229919 +0200\ncommitter Elichai Turkel <elichai.turkel@gmail.com> 1616163825 +0200\n\nAdd more benchmarks to siphash\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/610a5b21fdf809ab4f1d15003484b518b6dde26a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/610a5b21fdf809ab4f1d15003484b518b6dde26a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/610a5b21fdf809ab4f1d15003484b518b6dde26a/comments",
    "author": {
      "login": "elichai",
      "id": 2167860,
      "node_id": "MDQ6VXNlcjIxNjc4NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2167860?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/elichai",
      "html_url": "https://github.com/elichai",
      "followers_url": "https://api.github.com/users/elichai/followers",
      "following_url": "https://api.github.com/users/elichai/following{/other_user}",
      "gists_url": "https://api.github.com/users/elichai/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/elichai/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/elichai/subscriptions",
      "organizations_url": "https://api.github.com/users/elichai/orgs",
      "repos_url": "https://api.github.com/users/elichai/repos",
      "events_url": "https://api.github.com/users/elichai/events{/privacy}",
      "received_events_url": "https://api.github.com/users/elichai/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "elichai",
      "id": 2167860,
      "node_id": "MDQ6VXNlcjIxNjc4NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2167860?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/elichai",
      "html_url": "https://github.com/elichai",
      "followers_url": "https://api.github.com/users/elichai/followers",
      "following_url": "https://api.github.com/users/elichai/following{/other_user}",
      "gists_url": "https://api.github.com/users/elichai/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/elichai/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/elichai/subscriptions",
      "organizations_url": "https://api.github.com/users/elichai/orgs",
      "repos_url": "https://api.github.com/users/elichai/repos",
      "events_url": "https://api.github.com/users/elichai/events{/privacy}",
      "received_events_url": "https://api.github.com/users/elichai/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "05757aa860215a8fd5002d99b6ec653175c6b734",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/05757aa860215a8fd5002d99b6ec653175c6b734",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/05757aa860215a8fd5002d99b6ec653175c6b734"
      }
    ],
    "stats": {
      "total": 25,
      "additions": 24,
      "deletions": 1
    },
    "files": [
      {
        "sha": "1c3ce0f9af8eebc38e70cfeba4f2a0c3bc6dd89e",
        "filename": "src/bench/crypto_hash.cpp",
        "status": "modified",
        "additions": 24,
        "deletions": 1,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/610a5b21fdf809ab4f1d15003484b518b6dde26a/src/bench/crypto_hash.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/610a5b21fdf809ab4f1d15003484b518b6dde26a/src/bench/crypto_hash.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bench/crypto_hash.cpp?ref=610a5b21fdf809ab4f1d15003484b518b6dde26a",
        "patch": "@@ -85,11 +85,32 @@ static void SipHash_32b(benchmark::Bench& bench)\n {\n     uint256 x;\n     uint64_t k1 = 0;\n-    bench.run([&] {\n+    bench.batch(x.size()).unit(\"byte\").run([&] {\n         *((uint64_t*)x.begin()) = SipHashUint256(0, ++k1, x);\n     });\n }\n \n+static void SipHash_3b(benchmark::Bench& bench)\n+{\n+    uint64_t hash = 0;\n+    uint64_t k2 = 0;\n+    std::vector<uint8_t> in(3, 0xee);\n+    bench.batch(in.size()).unit(\"byte\").run([&] {\n+        hash = CSipHasher(hash, ++k2).Write(in.data(), in.size()).Finalize();\n+    });\n+}\n+\n+\n+static void SipHash(benchmark::Bench& bench)\n+{\n+    uint64_t hash = 0;\n+    uint64_t k2 = 0;\n+    std::vector<uint8_t> in(BUFFER_SIZE, 0);\n+    bench.batch(in.size()).unit(\"byte\").run([&] {\n+        hash = CSipHasher(hash, ++k2).Write(in.data(), in.size()).Finalize();\n+    });\n+}\n+\n static void FastRandom_32bit(benchmark::Bench& bench)\n {\n     FastRandomContext rng(true);\n@@ -159,9 +180,11 @@ BENCHMARK(SHA1);\n BENCHMARK(SHA256);\n BENCHMARK(SHA512);\n BENCHMARK(SHA3_256_1M);\n+BENCHMARK(SipHash);\n \n BENCHMARK(SHA256_32b);\n BENCHMARK(SipHash_32b);\n+BENCHMARK(SipHash_3b);\n BENCHMARK(SHA256D64_1024);\n BENCHMARK(FastRandom_32bit);\n BENCHMARK(FastRandom_1bit);"
      }
    ]
  },
  {
    "sha": "19e28a41168d02dc85356714c889b43d96d834d6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxOWUyOGE0MTE2OGQwMmRjODUzNTY3MTRjODg5YjQzZDk2ZDgzNGQ2",
    "commit": {
      "author": {
        "name": "Elichai Turkel",
        "email": "elichai.turkel@gmail.com",
        "date": "2020-01-28T16:50:00Z"
      },
      "committer": {
        "name": "Elichai Turkel",
        "email": "elichai.turkel@gmail.com",
        "date": "2021-03-19T14:23:49Z"
      },
      "message": "Optimized siphash implementation",
      "tree": {
        "sha": "b311975b39b250953401a91716fc1a21fc1a057d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b311975b39b250953401a91716fc1a21fc1a057d"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/19e28a41168d02dc85356714c889b43d96d834d6",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQJNBAABCAA3FiEEC5PUstyhDoo+NyfXk4PN6ejman8FAmBUs/UZHGVsaWNoYWku\ndHVya2VsQGdtYWlsLmNvbQAKCRCTg83p6OZqfzMmEADSY9OTicd4vSdckJwV0QI8\nLfw9ktRJWmGW/U594gkeulglgwzAWaKiIGPtao43wDUroXzBi/ykDzq9kZpJs4vT\nsc4ExPvt5UbCevGxBl2dsilmPRiWNdbVROx6FQB1i5/uium9wx86VcnuKl4PmoG7\ntg6fRDDJcXX6PHKUR83PPYa9ywje7OgXbbIsoF9Xyv3OKMdXAW6EM7GXcIyxIjel\nW2YBA1A2KnK8WOaupXQdmrAYplnbvq8Y9qp9m+L0d/36hOuSB+i6SAJQKHwZGwgv\n+jPDXcaN/PdEkEJfdx9FqWF4Igi2/bHiOvXQn8PzrvzM74gPovZ1itYjX2u7P/Ha\n9EVWbsoZ1VigA2939wAoK+JBVpnUfIbqsHFzB8qGM8mmi1uOVSlpiPTEoMeBfjaR\nO8886lmqiZs8VDsfvyePEK+xVkZPPi8tScK7DFHGykJYpKDMSZhv5P/+vznGWEtN\nxMsXd4k4LnvATxkIBCIme+rdMD793S3RcONANYVI+q896yxBVqD6wNqtoVfrYFuk\nIgv2IjOU4JaEN+j1F93ILt2PCobeWSlP8SuvlYycA2LzvHVEcPgGfmelc9BkZi3R\nnkSb2pjNY+HIbmNL6+kr1VS1IAd+yA1ToV0/e7t1G9SotkOvMFWUW72jb4JFLzLp\nfz8U8rFhlcAIYSqS3brJiw==\n=Yw4B\n-----END PGP SIGNATURE-----",
        "payload": "tree b311975b39b250953401a91716fc1a21fc1a057d\nparent 610a5b21fdf809ab4f1d15003484b518b6dde26a\nauthor Elichai Turkel <elichai.turkel@gmail.com> 1580230200 +0200\ncommitter Elichai Turkel <elichai.turkel@gmail.com> 1616163829 +0200\n\nOptimized siphash implementation\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/19e28a41168d02dc85356714c889b43d96d834d6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/19e28a41168d02dc85356714c889b43d96d834d6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/19e28a41168d02dc85356714c889b43d96d834d6/comments",
    "author": {
      "login": "elichai",
      "id": 2167860,
      "node_id": "MDQ6VXNlcjIxNjc4NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2167860?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/elichai",
      "html_url": "https://github.com/elichai",
      "followers_url": "https://api.github.com/users/elichai/followers",
      "following_url": "https://api.github.com/users/elichai/following{/other_user}",
      "gists_url": "https://api.github.com/users/elichai/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/elichai/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/elichai/subscriptions",
      "organizations_url": "https://api.github.com/users/elichai/orgs",
      "repos_url": "https://api.github.com/users/elichai/repos",
      "events_url": "https://api.github.com/users/elichai/events{/privacy}",
      "received_events_url": "https://api.github.com/users/elichai/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "elichai",
      "id": 2167860,
      "node_id": "MDQ6VXNlcjIxNjc4NjA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2167860?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/elichai",
      "html_url": "https://github.com/elichai",
      "followers_url": "https://api.github.com/users/elichai/followers",
      "following_url": "https://api.github.com/users/elichai/following{/other_user}",
      "gists_url": "https://api.github.com/users/elichai/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/elichai/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/elichai/subscriptions",
      "organizations_url": "https://api.github.com/users/elichai/orgs",
      "repos_url": "https://api.github.com/users/elichai/repos",
      "events_url": "https://api.github.com/users/elichai/events{/privacy}",
      "received_events_url": "https://api.github.com/users/elichai/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "610a5b21fdf809ab4f1d15003484b518b6dde26a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/610a5b21fdf809ab4f1d15003484b518b6dde26a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/610a5b21fdf809ab4f1d15003484b518b6dde26a"
      }
    ],
    "stats": {
      "total": 66,
      "additions": 49,
      "deletions": 17
    },
    "files": [
      {
        "sha": "f78771868ada54f54efb61fd49cdc2f9d427e8f4",
        "filename": "src/crypto/siphash.cpp",
        "status": "modified",
        "additions": 47,
        "deletions": 15,
        "changes": 62,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/19e28a41168d02dc85356714c889b43d96d834d6/src/crypto/siphash.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/19e28a41168d02dc85356714c889b43d96d834d6/src/crypto/siphash.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/crypto/siphash.cpp?ref=19e28a41168d02dc85356714c889b43d96d834d6",
        "patch": "@@ -2,8 +2,11 @@\n // Distributed under the MIT software license, see the accompanying\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n+#include <crypto/common.h>\n #include <crypto/siphash.h>\n \n+#include <algorithm>\n+\n #define ROTL(x, b) (uint64_t)(((x) << (b)) | ((x) >> (64 - (b))))\n \n #define SIPROUND do { \\\n@@ -22,14 +25,14 @@ CSipHasher::CSipHasher(uint64_t k0, uint64_t k1)\n     v[2] = 0x6c7967656e657261ULL ^ k0;\n     v[3] = 0x7465646279746573ULL ^ k1;\n     count = 0;\n-    tmp = 0;\n+    tail = 0;\n }\n \n CSipHasher& CSipHasher::Write(uint64_t data)\n {\n     uint64_t v0 = v[0], v1 = v[1], v2 = v[2], v3 = v[3];\n \n-    assert(count % 8 == 0);\n+    assert((count & 0x07) == 0);\n \n     v3 ^= data;\n     SIPROUND;\n@@ -45,30 +48,57 @@ CSipHasher& CSipHasher::Write(uint64_t data)\n     return *this;\n }\n \n+\n+/// Load a uint64_t from 0 to 7 bytes.\n+inline uint64_t ReadU64ByLenLE(const unsigned char* data, size_t len)\n+{\n+    assert(len < 8);\n+    uint64_t out = 0;\n+    for (size_t i = 0; i < len; ++i) {\n+        out |= (uint64_t)data[i] << (i * 8);\n+    }\n+    return out;\n+}\n+\n CSipHasher& CSipHasher::Write(const unsigned char* data, size_t size)\n {\n     uint64_t v0 = v[0], v1 = v[1], v2 = v[2], v3 = v[3];\n-    uint64_t t = tmp;\n-    uint8_t c = count;\n-\n-    while (size--) {\n-        t |= ((uint64_t)(*(data++))) << (8 * (c % 8));\n-        c++;\n-        if ((c & 7) == 0) {\n-            v3 ^= t;\n+    auto ntail = count & 0x07;\n+    count += size;\n+\n+    size_t needed = 0;\n+\n+    if (ntail != 0) {\n+        needed = 8 - ntail;\n+        tail |= ReadU64ByLenLE(data, std::min(size, needed)) << 8 * ntail;\n+        if (size < needed) {\n+            return *this;\n+        } else {\n+            v3 ^= tail;\n             SIPROUND;\n             SIPROUND;\n-            v0 ^= t;\n-            t = 0;\n+            v0 ^= tail;\n         }\n     }\n \n+    size_t len = size - needed;\n+    auto left = len & 0x07;\n+\n+    auto i = needed;\n+    while (i < len - left) {\n+        uint64_t mi = ReadLE64(data + i);\n+        v3 ^= mi;\n+        SIPROUND;\n+        SIPROUND;\n+        v0 ^= mi;\n+        i += 8;\n+    }\n+\n     v[0] = v0;\n     v[1] = v1;\n     v[2] = v2;\n     v[3] = v3;\n-    count = c;\n-    tmp = t;\n+    tail = ReadU64ByLenLE(data + i, left);\n \n     return *this;\n }\n@@ -77,12 +107,14 @@ uint64_t CSipHasher::Finalize() const\n {\n     uint64_t v0 = v[0], v1 = v[1], v2 = v[2], v3 = v[3];\n \n-    uint64_t t = tmp | (((uint64_t)count) << 56);\n+\n+    uint64_t t = tail | (((uint64_t)count) << 56);\n \n     v3 ^= t;\n     SIPROUND;\n     SIPROUND;\n     v0 ^= t;\n+\n     v2 ^= 0xFF;\n     SIPROUND;\n     SIPROUND;"
      },
      {
        "sha": "4b630f229057f27e0ca2d40cfb49cfe01acb03a4",
        "filename": "src/crypto/siphash.h",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/19e28a41168d02dc85356714c889b43d96d834d6/src/crypto/siphash.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/19e28a41168d02dc85356714c889b43d96d834d6/src/crypto/siphash.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/crypto/siphash.h?ref=19e28a41168d02dc85356714c889b43d96d834d6",
        "patch": "@@ -14,8 +14,8 @@ class CSipHasher\n {\n private:\n     uint64_t v[4];\n-    uint64_t tmp;\n-    uint8_t count; // Only the low 8 bits of the input size matter.\n+    uint64_t tail; // bytes that weren't processed yet.\n+    uint8_t count;  // total amount of bytes inputted.\n \n public:\n     /** Construct a SipHash calculator initialized with 128-bit key (k0, k1) */"
      }
    ]
  }
]