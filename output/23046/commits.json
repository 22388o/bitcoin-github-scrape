[
  {
    "sha": "fadc4c72723d67a59d80d843c85b090ae22b463b",
    "node_id": "C_kwDOABII59oAKGZhZGM0YzcyNzIzZDY3YTU5ZDgwZDg0M2M4NWIwOTBhZTIyYjQ2M2I",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2021-09-20T12:41:32Z"
      },
      "committer": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2021-11-09T11:05:45Z"
      },
      "message": "test: Add txindex migration test",
      "tree": {
        "sha": "f81f438db203c23e4fcda9a27dd767ff258acb1e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f81f438db203c23e4fcda9a27dd767ff258acb1e"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fadc4c72723d67a59d80d843c85b090ae22b463b",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unknown_key",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\npUjtdgwAzRffxVETiM/yLk0QjkgddJKbrYcsrZpqUOlRjupwwTWReMs+JgdXyKk9\nEZ6SKoz5PZJqpgxM1J9NTVDpt9ObYEhqZ3XifEtdG1TRAET1a/3Xen52+nusIkzZ\nYutLSxXzLEfUSyl+Ng669n/g5F75xCMYKe3AD/4pQNWdZ2gCbvv+MFLFO7tsr0TX\nW4O2FXehITuahZ5yOqqGEbhdTBLqB2QYg2HIfEB63GxvuwV9eGvimaJ0H4aa8zBR\n3Qau/w/ZvfPPGA9lq51AhogiM3g8QX5Gg3CidelVMvmAFf4xlQnhbVbd+k6Gka9h\n4kO1HTPyZN1LnikhHEiVzhmiQ/4tCf5J5bTDF4dJ78F7GMxyYcfMPrSJQ0dsgvRU\ntqzVLaOeMoY/L8u/j/PCmyvNQ8iYCCKMgkpWp1/TmBVxE3WasUGJlHFW6NOjwLcC\nWlpaLj0VqEhP0/54JbhI4tCdcg2JPT2M/gx+TQ3ix9UnJ31Dv+/24pKCazW1mSPa\n45bUKAcU\n=qD1w\n-----END PGP SIGNATURE-----",
        "payload": "tree f81f438db203c23e4fcda9a27dd767ff258acb1e\nparent 94db963de501e4aba6e5d8150a01ceb85753dee1\nauthor MarcoFalke <falke.marco@gmail.com> 1632141692 +0200\ncommitter MarcoFalke <falke.marco@gmail.com> 1636455945 +0100\n\ntest: Add txindex migration test\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fadc4c72723d67a59d80d843c85b090ae22b463b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/fadc4c72723d67a59d80d843c85b090ae22b463b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fadc4c72723d67a59d80d843c85b090ae22b463b/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "94db963de501e4aba6e5d8150a01ceb85753dee1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/94db963de501e4aba6e5d8150a01ceb85753dee1",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/94db963de501e4aba6e5d8150a01ceb85753dee1"
      }
    ],
    "stats": {
      "total": 93,
      "additions": 93,
      "deletions": 0
    },
    "files": [
      {
        "sha": "bbe1d1b53711512882a8d25af4422f596c774bea",
        "filename": "test/functional/feature_txindex_compatibility.py",
        "status": "added",
        "additions": 92,
        "deletions": 0,
        "changes": 92,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fadc4c72723d67a59d80d843c85b090ae22b463b/test/functional/feature_txindex_compatibility.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fadc4c72723d67a59d80d843c85b090ae22b463b/test/functional/feature_txindex_compatibility.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/feature_txindex_compatibility.py?ref=fadc4c72723d67a59d80d843c85b090ae22b463b",
        "patch": "@@ -0,0 +1,92 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2021 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test that legacy txindex will be disabled on upgrade.\n+\n+Previous releases are required by this test, see test/README.md.\n+\"\"\"\n+\n+import os\n+import shutil\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.wallet import MiniWallet\n+\n+\n+class MempoolCompatibilityTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 3\n+        self.extra_args = [\n+            [\"-reindex\", \"-txindex\"],\n+            [],\n+            [],\n+        ]\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_previous_releases()\n+\n+    def setup_network(self):\n+        self.add_nodes(\n+            self.num_nodes,\n+            self.extra_args,\n+            versions=[\n+                160300,  # Last release with legacy txindex\n+                None,  # For MiniWallet, without migration code\n+                200100,  # Any release with migration code (0.17.x - 22.x)\n+            ],\n+        )\n+        self.start_nodes()\n+        self.connect_nodes(0, 1)\n+        self.connect_nodes(1, 2)\n+\n+    def run_test(self):\n+        mini_wallet = MiniWallet(self.nodes[1])\n+        mini_wallet.rescan_utxos()\n+        spend_utxo = mini_wallet.get_utxo()\n+        mini_wallet.send_self_transfer(from_node=self.nodes[1], utxo_to_spend=spend_utxo)\n+        self.generate(self.nodes[1], 1)\n+\n+        self.log.info(\"Check legacy txindex\")\n+        self.nodes[0].getrawtransaction(txid=spend_utxo[\"txid\"])  # Requires -txindex\n+\n+        self.stop_nodes()\n+        legacy_chain_dir = os.path.join(self.nodes[0].datadir, self.chain)\n+\n+        self.log.info(\"Migrate legacy txindex\")\n+        migrate_chain_dir = os.path.join(self.nodes[2].datadir, self.chain)\n+        shutil.rmtree(migrate_chain_dir)\n+        shutil.copytree(legacy_chain_dir, migrate_chain_dir)\n+        with self.nodes[2].assert_debug_log([\n+                \"Upgrading txindex database...\",\n+                \"txindex is enabled at height 200\",\n+        ]):\n+            self.start_node(2, extra_args=[\"-txindex\"])\n+        self.nodes[2].getrawtransaction(txid=spend_utxo[\"txid\"])  # Requires -txindex\n+\n+        self.log.info(\"Drop legacy txindex\")\n+        drop_index_chain_dir = os.path.join(self.nodes[1].datadir, self.chain)\n+        shutil.rmtree(drop_index_chain_dir)\n+        shutil.copytree(legacy_chain_dir, drop_index_chain_dir)\n+        self.nodes[1].assert_start_raises_init_error(\n+            extra_args=[\"-txindex\"],\n+            expected_msg=\"Error: The block index db contains a legacy 'txindex'. To clear the occupied disk space, run a full -reindex, otherwise ignore this error. This error message will not be displayed again.\",\n+        )\n+        # Build txindex from scratch and check there is no error this time\n+        self.start_node(1, extra_args=[\"-txindex\"])\n+        self.nodes[2].getrawtransaction(txid=spend_utxo[\"txid\"])  # Requires -txindex\n+\n+        self.stop_nodes()\n+\n+        self.log.info(\"Check migrated txindex can not be read by legacy node\")\n+        err_msg = f\": You need to rebuild the database using -reindex to change -txindex.{os.linesep}Please restart with -reindex or -reindex-chainstate to recover.\"\n+        shutil.rmtree(legacy_chain_dir)\n+        shutil.copytree(migrate_chain_dir, legacy_chain_dir)\n+        self.nodes[0].assert_start_raises_init_error(extra_args=[\"-txindex\"], expected_msg=err_msg)\n+        shutil.rmtree(legacy_chain_dir)\n+        shutil.copytree(drop_index_chain_dir, legacy_chain_dir)\n+        self.nodes[0].assert_start_raises_init_error(extra_args=[\"-txindex\"], expected_msg=err_msg)\n+\n+\n+if __name__ == \"__main__\":\n+    MempoolCompatibilityTest().main()"
      },
      {
        "sha": "fe974a112257810edde8635b0b1a8b52bdb6d305",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fadc4c72723d67a59d80d843c85b090ae22b463b/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fadc4c72723d67a59d80d843c85b090ae22b463b/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=fadc4c72723d67a59d80d843c85b090ae22b463b",
        "patch": "@@ -296,6 +296,7 @@\n     'rpc_deriveaddresses.py --usecli',\n     'p2p_ping.py',\n     'rpc_scantxoutset.py',\n+    'feature_txindex_compatibility.py',\n     'feature_logging.py',\n     'feature_anchors.py',\n     'feature_coinstatsindex.py',"
      }
    ]
  }
]