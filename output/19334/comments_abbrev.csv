DrahtBot,2020-06-20 03:34:10,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19335 (wallet: Cleanup and separate BerkeleyDatabase and BerkeleyBatch by achow101)\n* #19101 (refactor: remove ::vpwalle",https://github.com/bitcoin/bitcoin/pull/19334#issuecomment-646931904,646931904,
achow101,2020-06-23 20:21:55,Many of the suggested cleanups are done in #19335 (as I suspect you already know),https://github.com/bitcoin/bitcoin/pull/19334#issuecomment-648397000,648397000,
ryanofsky,2020-06-23 18:05:27,"In commit ""walletdb: Move BerkeleyDatabase::Flush(true) to Close()"" (da7ac55e65926d7c0ef9b4ad8afaf96468d9574b)\n\nNote for future cleanup: This code is just moving from the header, not changing, but want to note it seems pretty unsafe to access m_databases without locking cs_db here given multithreaded loadwallet & unloadwallet rpcs and fact that environments can be shared between wallets",https://github.com/bitcoin/bitcoin/pull/19334#discussion_r444411657,444411657,src/wallet/bdb.cpp
ryanofsky,2020-06-23 18:10:03,"In commit ""walletdb: Move BerkeleyDatabase::Flush(true) to Close()"" (da7ac55e65926d7c0ef9b4ad8afaf96468d9574b)\n\nNote for future cleanup: I didn't test but it was reported that this erase fails sometimes https://github.com/bitcoin/bitcoin/pull/18971#discussion_r441722431. This seems harmless but is also unexpected. Good to debug and fix in the future.",https://github.com/bitcoin/bitcoin/pull/19334#discussion_r444414128,444414128,src/wallet/bdb.cpp
ryanofsky,2020-06-23 18:36:14,"In commit ""walletdb: Move BerkeleyDatabase::Flush(true) to Close()"" (da7ac55e65926d7c0ef9b4ad8afaf96468d9574b)\n\nNote for future cleanup: Descriptions and names of Close and Flush here are misleading. \n\nI'd expect Database::Flush to reliably flush data to disk like Batch::Flush does. But Database::Flush may or may not flush data in the current database, and may flush data in other databases",https://github.com/bitcoin/bitcoin/pull/19334#discussion_r444428173,444428173,src/wallet/bdb.h
ryanofsky,2020-06-23 18:37:14,"In commit ""walletdb: Move BerkeleyDatabase::Flush(true) to Close()"" (da7ac55e65926d7c0ef9b4ad8afaf96468d9574b)\n\nNote: TODO is removed here because it was previously implemented https://github.com/bitcoin/bitcoin/pull/18971#discussion_r432694132",https://github.com/bitcoin/bitcoin/pull/19334#discussion_r444428729,444428729,src/wallet/bdb.cpp
ryanofsky,2020-06-23 18:40:45,"In commit ""walletdb: Move BerkeleyDatabase::Flush(true) to Close()"" (da7ac55e65926d7c0ef9b4ad8afaf96468d9574b)\n\nNote: Erase call was buggy here and is moved to destructor in this commit for reasons described https://github.com/bitcoin/bitcoin/pull/18971#discussion_r436856577",https://github.com/bitcoin/bitcoin/pull/19334#discussion_r444430775,444430775,src/wallet/bdb.cpp
ryanofsky,2020-06-23 18:42:01,"In commit ""walletdb: Move BerkeleyDatabase::Flush(true) to Close()"" (da7ac55e65926d7c0ef9b4ad8afaf96468d9574b)\n\nNote: m_fileids.erase is moving to ~Database destructor in this commit for reasons described https://github.com/bitcoin/bitcoin/pull/18971#discussion_r436976128",https://github.com/bitcoin/bitcoin/pull/19334#discussion_r444431566,444431566,src/wallet/bdb.cpp
ryanofsky,2020-06-23 18:42:28,"In commit ""walletdb: Move BerkeleyDatabase::Flush(true) to Close()"" (da7ac55e65926d7c0ef9b4ad8afaf96468d9574b)\n\nNote for future cleanup, this destructor should be calling CloseDb and asserting !m_db here https://github.com/bitcoin/bitcoin/pull/18971#discussion_r437012889 to make sure the database is actually closed",https://github.com/bitcoin/bitcoin/pull/19334#discussion_r444431831,444431831,src/wallet/bdb.cpp
achow101,2020-06-23 20:20:12,"I would prefer to keep the naming and move to make the functions actually do as the names suggest. Since the goal is to have a standard interface, changing the names to match the craziness we have for BDB seems counterproductive. For example, in #19077, Flush and Close do work as you would expect.\n\nI think many of these issues stem from the fact that we allow multiple BerkeleyDatabases for one",https://github.com/bitcoin/bitcoin/pull/19334#discussion_r444483245,444483245,src/wallet/bdb.h
Sjors,2020-07-06 19:00:31,b46a69556d4c42245b60eeb4ff00ddc070669fd4:  this destructor is now called from a place that _did_ have a `cs_db` lock: https://github.com/bitcoin/bitcoin/pull/19334/commits/b46a69556d4c42245b60eeb4ff00ddc070669fd4#diff-f9e31f5caede7a3aa7106793ffa1e1eaL702,https://github.com/bitcoin/bitcoin/pull/19334#discussion_r450421287,450421287,src/wallet/bdb.cpp
Sjors,2020-07-06 19:23:14,ae35e09495db8f5dea407053aebc05515f172469  nit : `Make a DatabaseBatch`,https://github.com/bitcoin/bitcoin/pull/19334#discussion_r450432172,450432172,src/wallet/db.h
achow101,2020-07-06 22:15:42,Done,https://github.com/bitcoin/bitcoin/pull/19334#discussion_r450507636,450507636,src/wallet/db.h
achow101,2020-07-06 22:15:52,Added the lock back.,https://github.com/bitcoin/bitcoin/pull/19334#discussion_r450507707,450507707,src/wallet/bdb.cpp
fjahr,2020-07-21 13:17:12,"nit for a follow-up:\n```suggestion\n    /** Indicate that a new database user has begun using the database. */\n```",https://github.com/bitcoin/bitcoin/pull/19334#discussion_r458087653,458087653,src/wallet/bdb.h
