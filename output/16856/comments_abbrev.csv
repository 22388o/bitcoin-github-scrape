Sjors,2019-09-30 12:08:36,"Looking at the `pindexFirstInvalid` check in isolation (0ae7281), that makes sense to me. If I drop everything except that check, then a whole bunch of functional tests throw an assert: ` ((pindex->nStatus & BLOCK_FAILED_VALID) == 0), function CheckBlockIndex, file validation.cpp, line 4669.`. But I don't understand the fix itself, at least not the bit above my inline comment. ",https://github.com/bitcoin/bitcoin/pull/16856#issuecomment-536532295,536532295,
jnewbery,2019-12-13 16:25:24,"Can you give a bit of motivation for why we want to mark descendants of `BLOCK_FAILED_VALID` as `BLOCK_FAILED_CHILD`? I can't see any functional difference in the way that a `CBlockIndex` is treated when its `nStatus` is `BLOCK_FAILED_CHILD`. The only comparisons seem to be against `BLOCK_FAILED_MASK`.\n\nIf that's the case, then I think we should just mark all descendants of the block to invali",https://github.com/bitcoin/bitcoin/pull/16856#issuecomment-565506585,565506585,
TheBlueMatt,2019-12-13 22:14:07,"Right, I don't think we really use it anywhere, I just figured as long as we make the distinction, make the distinction. Maybe @sipa recalls why it was there in the first place?",https://github.com/bitcoin/bitcoin/pull/16856#issuecomment-565628399,565628399,
sipa,2019-12-13 22:38:34,"I don't recall exactly why they're separate. One point is that BLOCK_FAILED_CHILD doesn't actually need to be stored on disk, as it is recomputed at db load time. So an advantage of keeping them separate is that if only FAILED_CHILD gets set on a blockindex object, it doesn't need to be made dirty and written to disk. I'm not sure that optimization is ever taken advantage of (and it probably can b",https://github.com/bitcoin/bitcoin/pull/16856#issuecomment-565635595,565635595,
jnewbery,2019-12-13 23:05:22,"> I'm not sure that optimization is ever taken advantage of\n\nLooks to me like it isn't used. I'd vote to just use `BLOCK_FAILED_VALID` and keep `InvalidateBlock()` simple.",https://github.com/bitcoin/bitcoin/pull/16856#issuecomment-565642960,565642960,
jnewbery,2019-12-20 20:16:39,"Alternative here https://github.com/jnewbery/bitcoin/tree/2019-12-block-failed-valid-descendants just removes tracking of `BLOCK_FAILED_CHILD`. Let me know what you think, @TheBlueMatt .",https://github.com/bitcoin/bitcoin/pull/16856#issuecomment-568073859,568073859,
BrannonKing,2020-09-06 03:35:19,"@jnewbery , that branch doesn't remove all references to BLOCK_FAILED_CHILD. Was the intent to remove them all?",https://github.com/bitcoin/bitcoin/pull/16856#issuecomment-687694612,687694612,
jnewbery,2020-09-06 08:27:22,@BrannonKing - The intent was to demonstrate how removing `BLOCK_FAILED_CHILD` from `InvalidateBlock()` makes it simpler (and therefore less likely to hide bugs). I agree that we should remove `BLOCK_FAILED_CHILD` everywhere.,https://github.com/bitcoin/bitcoin/pull/16856#issuecomment-687724324,687724324,
jnewbery,2020-10-01 10:06:36,"@BrannonKing - I've rebased my branch on master and removed all the remaining instances of BLOCK_FAILED_CHILD.\n\n@TheBlueMatt - This PR hasn't had any activity for about a year. Are you happy to close it?",https://github.com/bitcoin/bitcoin/pull/16856#issuecomment-702031401,702031401,
Sjors,2019-09-30 11:35:54,"I'm confused by this fix. Let's say we called `invalidateblock` on block 10. In that case `to_mark_failed` is block 10, `to_mark_failed->pprev` is block 9. Let's say we're almost done and we just disconnected the tip at height 11. Then `invalid_walk_tip` is block 11. So this comparison always returns `false`?",https://github.com/bitcoin/bitcoin/pull/16856#discussion_r329530982,329530982,src/validation.cpp
TheBlueMatt,2019-10-03 02:57:19,"If we're almost done, to_mark_failed got set to block 12 in the last iteration of the loop (yes, these variable names make no sense).",https://github.com/bitcoin/bitcoin/pull/16856#discussion_r330847050,330847050,src/validation.cpp
Sjors,2019-10-03 16:24:20,"Ah, it's actually `pindex` that stays at block 10 throughout this function. `to_mark_failed` is set to `invalid_walk_tip`. By the time we reach this line we chipped one block off of the tip.\n\nLooking at the first iteration: let's say the original tip is block 20. `to_mark_failed` starts at block 10. We disconnect block 20 and mark it `BLOCK_FAILED_VALID`. The`if` statement here returns `false`",https://github.com/bitcoin/bitcoin/pull/16856#discussion_r331132035,331132035,src/validation.cpp
TheBlueMatt,2019-10-03 16:42:55,"Right, I mean its not *strictly* because we want to be safe in case of shutdown (though that's nice), and more that this hunk previously never did anything at all (though its intent was ""descendants get marked FAILED_CHILD"").",https://github.com/bitcoin/bitcoin/pull/16856#discussion_r331140041,331140041,src/validation.cpp
