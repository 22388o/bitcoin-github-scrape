[
  {
    "sha": "4433ed0f730cfd60eeba3694ff3c283ce2c0c8ee",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0NDMzZWQwZjczMGNmZDYwZWViYTM2OTRmZjNjMjgzY2UyYzBjOGVl",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2019-01-31T20:47:25Z"
      },
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2019-06-05T09:05:37Z"
      },
      "message": "[validation] Crash if disconnecting a block fails\n\nIf we're unable to disconnect a block during normal operation, then that is a\nfailure of our local system (such as disk failure) or the chain that we are on\n(eg CVE-2018-17144), but cannot be due to failure of the (more work) chain that\nwe're trying to validate.\n\nWe should abort rather than stay on a less work chain.",
      "tree": {
        "sha": "b602afba38a577d001a6106ac28e7fb41816ad57",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b602afba38a577d001a6106ac28e7fb41816ad57"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4433ed0f730cfd60eeba3694ff3c283ce2c0c8ee",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4433ed0f730cfd60eeba3694ff3c283ce2c0c8ee",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/4433ed0f730cfd60eeba3694ff3c283ce2c0c8ee",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4433ed0f730cfd60eeba3694ff3c283ce2c0c8ee/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "3b19d8e341a5234c3e41f59f7b3de8febfc51c21",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/3b19d8e341a5234c3e41f59f7b3de8febfc51c21",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/3b19d8e341a5234c3e41f59f7b3de8febfc51c21"
      }
    ],
    "stats": {
      "total": 7,
      "additions": 6,
      "deletions": 1
    },
    "files": [
      {
        "sha": "83a17de09261ed2b7bfe0c9eca6163b4a5b468f0",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 1,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4433ed0f730cfd60eeba3694ff3c283ce2c0c8ee/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4433ed0f730cfd60eeba3694ff3c283ce2c0c8ee/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=4433ed0f730cfd60eeba3694ff3c283ce2c0c8ee",
        "patch": "@@ -2295,7 +2295,7 @@ bool CChainState::DisconnectTip(CValidationState& state, const CChainParams& cha\n     std::shared_ptr<CBlock> pblock = std::make_shared<CBlock>();\n     CBlock& block = *pblock;\n     if (!ReadBlockFromDisk(block, pindexDelete, chainparams.GetConsensus()))\n-        return AbortNode(state, \"Failed to read block\");\n+        return error(\"DisconnectTip(): Failed to read block\");\n     // Apply the block atomically to the chain state.\n     int64_t nStart = GetTimeMicros();\n     {\n@@ -2551,6 +2551,11 @@ bool CChainState::ActivateBestChainStep(CValidationState& state, const CChainPar\n             // This is likely a fatal error, but keep the mempool consistent,\n             // just in case. Only remove from the mempool in this case.\n             UpdateMempoolForReorg(disconnectpool, false);\n+\n+            // If we're unable to disconnect a block during normal operation,\n+            // then that is a failure of our local system -- we should abort\n+            // rather than stay on a less work chain.\n+            AbortNode(state, \"Failed to disconnect block; see debug.log for details\");\n             return false;\n         }\n         fBlocksDisconnected = true;"
      }
    ]
  },
  {
    "sha": "a47df13471e3168e2e02023fb20cdf2414141b36",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphNDdkZjEzNDcxZTMxNjhlMmUwMjAyM2ZiMjBjZGYyNDE0MTQxYjM2",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2019-01-31T21:06:07Z"
      },
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2019-06-05T09:05:49Z"
      },
      "message": "[qa] Test disconnect block failure -> shutdown",
      "tree": {
        "sha": "cbffdfc1b112d92fa1abb83f0e4082f171007bfa",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/cbffdfc1b112d92fa1abb83f0e4082f171007bfa"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a47df13471e3168e2e02023fb20cdf2414141b36",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a47df13471e3168e2e02023fb20cdf2414141b36",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a47df13471e3168e2e02023fb20cdf2414141b36",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a47df13471e3168e2e02023fb20cdf2414141b36/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "4433ed0f730cfd60eeba3694ff3c283ce2c0c8ee",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4433ed0f730cfd60eeba3694ff3c283ce2c0c8ee",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/4433ed0f730cfd60eeba3694ff3c283ce2c0c8ee"
      }
    ],
    "stats": {
      "total": 49,
      "additions": 49,
      "deletions": 0
    },
    "files": [
      {
        "sha": "62c3eca07defd025aeaca970e522c039d445fe05",
        "filename": "test/functional/feature_abortnode.py",
        "status": "added",
        "additions": 48,
        "deletions": 0,
        "changes": 48,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a47df13471e3168e2e02023fb20cdf2414141b36/test/functional/feature_abortnode.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a47df13471e3168e2e02023fb20cdf2414141b36/test/functional/feature_abortnode.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/feature_abortnode.py?ref=a47df13471e3168e2e02023fb20cdf2414141b36",
        "patch": "@@ -0,0 +1,48 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2019 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test bitcoind aborts if can't disconnect a block.\n+\n+- Start a single node and generate 3 blocks.\n+- Delete the undo data.\n+- Mine a fork that requires disconnecting the tip.\n+- Verify that bitcoind AbortNode's.\n+\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import wait_until, get_datadir_path, connect_nodes\n+import os\n+\n+class AbortNodeTest(BitcoinTestFramework):\n+\n+    def set_test_params(self):\n+        self.setup_clean_chain = True\n+        self.num_nodes = 2\n+\n+    def setup_network(self):\n+        self.setup_nodes()\n+        # We'll connect the nodes later\n+\n+    def run_test(self):\n+        self.nodes[0].generate(3)\n+        datadir = get_datadir_path(self.options.tmpdir, 0)\n+\n+        # Deleting the undo file will result in reorg failure\n+        os.unlink(os.path.join(datadir, 'regtest', 'blocks', 'rev00000.dat'))\n+\n+        # Connecting to a node with a more work chain will trigger a reorg\n+        # attempt.\n+        self.nodes[1].generate(3)\n+        with self.nodes[0].assert_debug_log([\"Failed to disconnect block\"]):\n+            connect_nodes(self.nodes[0], 1)\n+            self.nodes[1].generate(1)\n+\n+            # Check that node0 aborted\n+            self.log.info(\"Waiting for crash\")\n+            wait_until(lambda: self.nodes[0].is_node_stopped(), timeout=60)\n+        self.log.info(\"Node crashed - now verifying restart fails\")\n+        self.nodes[0].assert_start_raises_init_error()\n+\n+if __name__ == '__main__':\n+    AbortNodeTest().main()"
      },
      {
        "sha": "2a6691a66e4f62531a70ae0ebadcfc5917a67eda",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a47df13471e3168e2e02023fb20cdf2414141b36/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a47df13471e3168e2e02023fb20cdf2414141b36/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=a47df13471e3168e2e02023fb20cdf2414141b36",
        "patch": "@@ -102,6 +102,7 @@\n     'feature_bip68_sequence.py',\n     'p2p_feefilter.py',\n     'feature_reindex.py',\n+    'feature_abortnode.py',\n     # vv Tests less than 30s vv\n     'wallet_keypool_topup.py',\n     'interface_zmq.py',"
      }
    ]
  }
]