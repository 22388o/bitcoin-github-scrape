TheBlueMatt,2017-11-04T00:32:16Z,Ping @theuni.,https://github.com/bitcoin/bitcoin/pull/11604#issuecomment-341858157,341858157,
practicalswift,2017-11-06T12:33:24Z,"Strong concept ACK\n\nGetting this merged will allow removing this ugly `-Wthread-safety` work-around: https://github.com/bitcoin/bitcoin/pull/11226/commits/5a890d376f7a296a6a4a7ce0d076012ef920b239",https://github.com/bitcoin/bitcoin/pull/11604#issuecomment-342135417,342135417,
theuni,2017-11-07T20:15:28Z,"This really clashes with the libevent work, which totally reworks the disconnection logic.\n\nCan we revisit this down the road a bit? It's a bit frustrating to have some of these things already worked out, but stuck waiting on per-requisite PR review.\n\nThat said, concept ACK on moving RelayTransaction/nStartingHeight out of net.",https://github.com/bitcoin/bitcoin/pull/11604#issuecomment-342608289,342608289,
TheBlueMatt,2017-11-07T20:22:32Z,"How does this conflict with libevent? The disconnect logic is still based on telling CConnman to do X with a peer, no? And FinalizeNode being moved around shouldn't matter too much, just as long as its not called at the same time as a call to one of the other NetEventsInterface calls.\n\nThis is a rather simple PR, I'm happy to rebase it on some different disconnect-order tweaks that are pulled ",https://github.com/bitcoin/bitcoin/pull/11604#issuecomment-342610248,342610248,
practicalswift,2017-11-14T22:37:53Z,Rebase needed :-),https://github.com/bitcoin/bitcoin/pull/11604#issuecomment-344423221,344423221,
theuni,2017-11-14T23:14:10Z,"Discussed this with @TheBlueMatt today and we agreed that it makes sense to split this into 2 PRs: 1 to move a bunch of stuff to CNodeState, then a follow-up to argue about how to best remove ForEachNode.",https://github.com/bitcoin/bitcoin/pull/11604#issuecomment-344431891,344431891,
TheBlueMatt,2017-11-15T23:42:33Z,"Heh, to follow up on the 2PRs comment, @theuni sent me down a rabbit hole and suddenly I found myself in a farmiliar place - trying to pull CNodeState out of cs_main...I'm probably going to revive that work soon based on an approach @theuni suggested, but this PR will have to stand alone for some time yet. Please review with that in mind.",https://github.com/bitcoin/bitcoin/pull/11604#issuecomment-344766638,344766638,
promag,2017-11-04T01:47:42Z,const?,https://github.com/bitcoin/bitcoin/pull/11604#discussion_r148919848,148919848,src/net_processing.cpp
theuni,2017-11-07T19:57:41Z,"If I'm understanding this correctly, I think it may cause issues with recursive locks that are currently harmless (though potentially troublesome)? e.g.:\n```\nrecursive_mutex a;\nrecursive_mutex b;\nlock(a)\nlock(a)\nlock(b)\nlock(b)\nunlock(a)\nunlock(b)\nunlock(b)\nunlock(a)\n```",https://github.com/bitcoin/bitcoin/pull/11604#discussion_r149486464,149486464,src/sync.cpp
TheBlueMatt,2017-11-07T20:01:31Z,"Yes, those will now be DEBUG_LOCKORDER failures, but it appears to currently not be violated, and would detect some potentially significant issues, consider:\n\nlock(a)\nlock(b)\nunlock(a) (this now pops b off the stack, so lockorder thinks we have a locked)\nlock(a) (this is a deadlock cause we've now violated lockorder, but DEBUG_LOCKORDER thinks that we're just re-locking a).",https://github.com/bitcoin/bitcoin/pull/11604#discussion_r149487552,149487552,src/sync.cpp
theuni,2017-11-07T20:02:20Z,"I agree with passing an opaque handle in directly here, but making it easier for net_processing to use CNode's internals is the _opposite_ of the direction we should be headed in :(",https://github.com/bitcoin/bitcoin/pull/11604#discussion_r149487830,149487830,src/net_processing.cpp
TheBlueMatt,2017-11-07T20:18:57Z,"Sure, but incremental steps - its clearly the right direction, even if CNode will have more fields made private over the coming months...its not like we have to merge things which reference more CNode fields aside from clear const descriptors that just describe the connection itself.",https://github.com/bitcoin/bitcoin/pull/11604#discussion_r149491941,149491941,src/net_processing.cpp
theuni,2017-11-14T22:36:20Z,Let's just move vBlockHashesToAnnounce to CNodeState also. Then PushBlockHash can die and we don't have to mess with CNode here at all.,https://github.com/bitcoin/bitcoin/pull/11604#discussion_r150985003,150985003,src/net_processing.cpp
