[
  {
    "sha": "a7599c80ebb9579df45e2d6ccf3168302cf42f03",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphNzU5OWM4MGViYjk1NzlkZjQ1ZTJkNmNjZjMxNjgzMDJjZjQyZjAz",
    "commit": {
      "author": {
        "name": "Michael Dietz",
        "email": "michael.dietz@waya.ai",
        "date": "2021-01-07T18:24:24Z"
      },
      "committer": {
        "name": "Michael Dietz",
        "email": "michael.dietz@waya.ai",
        "date": "2021-01-07T18:24:24Z"
      },
      "message": "test: run mempool_compatibility.py even with wallet disabled",
      "tree": {
        "sha": "084318ec61a41faae2f18d4830183e213a502c6c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/084318ec61a41faae2f18d4830183e213a502c6c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a7599c80ebb9579df45e2d6ccf3168302cf42f03",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEENKwpEUV32QrrIOeYc3/VzfHRRrkFAl/3UdgACgkQc3/VzfHR\nRrl1FA//daS6gU0hp9wpobSmsbma5MvEbOtM/+QzZyqOHYkqO/nAC2DGOYACXSZo\n2pl5Wpx0TQelDDXC8uC8jnQUAHxHVq0feZET5sLKwsTIDDCeO9rKKuubU8CyNare\nAPhfxwF+cxFOybXi4dFLcsP8ZhuA85OQ6scedZDuwtMDbm2urXjYLaU2UsBbLY8S\nTmTsgmfnnRVWL6RVWU+3lYxRm/DJ0OtR800QgKBoVzb4axGAXCZ+p9YVsLjMM2St\n9ZDM/6kQ4zPAi85cwEbLn7Ls1nwpk24dqKQlqKt28c33W9DJwfvet21zMyTTeIa6\nq/YGTBz7jtErBwb4WEMINixIjbv5VRMX4iJp1+dK4JDgIELDOrdMQCnh1TN0ZswV\ngUxSsQAc1pFNyDjlVeuPYryldStzGIyPf0EiYSeAvHAUu515k4QMsxcx7PbBKymt\ndKl5cAwZdbox8d6fgVCO9XlmUsDh425ThDcLA8BdellVkBT2NaOA8tQYiUAL8baJ\nqce5+wThwD4JSIo6RbTHVLzHkkstlxO24WEaYea3R7n2+UrITCdWLurCrUIKQnBK\nKouMuY0NAE5mKGWERWDev6tS7o+m6vAsNEOrBsB+jlZKCUeBwo/SOMUOZMudAI9Y\n87qWqBBN4a30ck1cCobNd5S4UmqAjRU8mnnzBLyZ2erZxflzvSY=\n=uIcd\n-----END PGP SIGNATURE-----",
        "payload": "tree 084318ec61a41faae2f18d4830183e213a502c6c\nparent 143bd108ed6626405b0361c9939a8e1bf6cfc3d2\nauthor Michael Dietz <michael.dietz@waya.ai> 1610043864 -0600\ncommitter Michael Dietz <michael.dietz@waya.ai> 1610043864 -0600\n\ntest: run mempool_compatibility.py even with wallet disabled\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a7599c80ebb9579df45e2d6ccf3168302cf42f03",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a7599c80ebb9579df45e2d6ccf3168302cf42f03",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a7599c80ebb9579df45e2d6ccf3168302cf42f03/comments",
    "author": {
      "login": "mjdietzx",
      "id": 7217256,
      "node_id": "MDQ6VXNlcjcyMTcyNTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7217256?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mjdietzx",
      "html_url": "https://github.com/mjdietzx",
      "followers_url": "https://api.github.com/users/mjdietzx/followers",
      "following_url": "https://api.github.com/users/mjdietzx/following{/other_user}",
      "gists_url": "https://api.github.com/users/mjdietzx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mjdietzx/subscriptions",
      "organizations_url": "https://api.github.com/users/mjdietzx/orgs",
      "repos_url": "https://api.github.com/users/mjdietzx/repos",
      "events_url": "https://api.github.com/users/mjdietzx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mjdietzx/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "mjdietzx",
      "id": 7217256,
      "node_id": "MDQ6VXNlcjcyMTcyNTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7217256?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mjdietzx",
      "html_url": "https://github.com/mjdietzx",
      "followers_url": "https://api.github.com/users/mjdietzx/followers",
      "following_url": "https://api.github.com/users/mjdietzx/following{/other_user}",
      "gists_url": "https://api.github.com/users/mjdietzx/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mjdietzx/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mjdietzx/subscriptions",
      "organizations_url": "https://api.github.com/users/mjdietzx/orgs",
      "repos_url": "https://api.github.com/users/mjdietzx/repos",
      "events_url": "https://api.github.com/users/mjdietzx/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mjdietzx/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "143bd108ed6626405b0361c9939a8e1bf6cfc3d2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/143bd108ed6626405b0361c9939a8e1bf6cfc3d2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/143bd108ed6626405b0361c9939a8e1bf6cfc3d2"
      }
    ],
    "stats": {
      "total": 17,
      "additions": 12,
      "deletions": 5
    },
    "files": [
      {
        "sha": "eb08765ebfe12faad3d2010403c077c749ab3932",
        "filename": "test/functional/mempool_compatibility.py",
        "status": "modified",
        "additions": 12,
        "deletions": 5,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a7599c80ebb9579df45e2d6ccf3168302cf42f03/test/functional/mempool_compatibility.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a7599c80ebb9579df45e2d6ccf3168302cf42f03/test/functional/mempool_compatibility.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/mempool_compatibility.py?ref=a7599c80ebb9579df45e2d6ccf3168302cf42f03",
        "patch": "@@ -16,15 +16,15 @@\n import os\n \n from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.wallet import MiniWallet\n \n \n class MempoolCompatibilityTest(BitcoinTestFramework):\n     def set_test_params(self):\n         self.num_nodes = 2\n-        self.wallet_names = [None, self.default_wallet_name]\n+        self.wallet_names = [None]\n \n     def skip_test_if_missing_module(self):\n-        self.skip_if_no_wallet()\n         self.skip_if_no_previous_releases()\n \n     def setup_network(self):\n@@ -38,8 +38,15 @@ def setup_network(self):\n     def run_test(self):\n         self.log.info(\"Test that mempool.dat is compatible between versions\")\n \n-        old_node = self.nodes[0]\n-        new_node = self.nodes[1]\n+        old_node, new_node = self.nodes\n+        new_wallet = MiniWallet(new_node)\n+        new_wallet.generate(1)\n+        new_node.generate(100)\n+        # Sync the nodes to ensure old_node has the block that contains the coinbase that new_wallet will spend.\n+        # Otherwise, because coinbases are only valid in a block and not as loose txns, if the nodes aren't synced\n+        # unbroadcasted_tx won't pass old_node's `MemPoolAccept::PreChecks`.\n+        self.connect_nodes(0, 1)\n+        self.sync_blocks()\n         recipient = old_node.getnewaddress()\n         self.stop_node(1)\n \n@@ -58,7 +65,7 @@ def run_test(self):\n         assert old_tx_hash in new_node.getrawmempool()\n \n         self.log.info(\"Add unbroadcasted tx to mempool on new node and shutdown\")\n-        unbroadcasted_tx_hash = new_node.sendtoaddress(recipient, 0.0001)\n+        unbroadcasted_tx_hash = new_wallet.send_self_transfer(from_node=new_node)['txid']\n         assert unbroadcasted_tx_hash in new_node.getrawmempool()\n         mempool = new_node.getrawmempool(True)\n         assert mempool[unbroadcasted_tx_hash]['unbroadcast']"
      }
    ]
  }
]