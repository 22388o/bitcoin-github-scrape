[
  {
    "sha": "f73ef0cf3593fcf7954ab7701d6fc05480daca7e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmNzNlZjBjZjM1OTNmY2Y3OTU0YWI3NzAxZDZmYzA1NDgwZGFjYTdl",
    "commit": {
      "author": {
        "name": "Daniel Kraft",
        "email": "d@domob.eu",
        "date": "2018-08-02T17:27:36Z"
      },
      "committer": {
        "name": "Daniel Kraft",
        "email": "d@domob.eu",
        "date": "2018-08-02T17:27:52Z"
      },
      "message": "Clear mapDeltas also in CTxMemPool::clear.\n\nCTxMemPool::clear() was missing mapDeltas, which should also be cleared\nas part of the overall mempool state.  This change fixes that, and adds\na consistency check between mapDeltas and mapTx to CTxMemPool::check.",
      "tree": {
        "sha": "f6686ff1a348409f53e077b59fbfcbc503167994",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f6686ff1a348409f53e077b59fbfcbc503167994"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f73ef0cf3593fcf7954ab7701d6fc05480daca7e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f73ef0cf3593fcf7954ab7701d6fc05480daca7e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/f73ef0cf3593fcf7954ab7701d6fc05480daca7e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f73ef0cf3593fcf7954ab7701d6fc05480daca7e/comments",
    "author": {
      "login": "domob1812",
      "id": 4943644,
      "node_id": "MDQ6VXNlcjQ5NDM2NDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4943644?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/domob1812",
      "html_url": "https://github.com/domob1812",
      "followers_url": "https://api.github.com/users/domob1812/followers",
      "following_url": "https://api.github.com/users/domob1812/following{/other_user}",
      "gists_url": "https://api.github.com/users/domob1812/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/domob1812/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/domob1812/subscriptions",
      "organizations_url": "https://api.github.com/users/domob1812/orgs",
      "repos_url": "https://api.github.com/users/domob1812/repos",
      "events_url": "https://api.github.com/users/domob1812/events{/privacy}",
      "received_events_url": "https://api.github.com/users/domob1812/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "domob1812",
      "id": 4943644,
      "node_id": "MDQ6VXNlcjQ5NDM2NDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4943644?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/domob1812",
      "html_url": "https://github.com/domob1812",
      "followers_url": "https://api.github.com/users/domob1812/followers",
      "following_url": "https://api.github.com/users/domob1812/following{/other_user}",
      "gists_url": "https://api.github.com/users/domob1812/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/domob1812/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/domob1812/subscriptions",
      "organizations_url": "https://api.github.com/users/domob1812/orgs",
      "repos_url": "https://api.github.com/users/domob1812/repos",
      "events_url": "https://api.github.com/users/domob1812/events{/privacy}",
      "received_events_url": "https://api.github.com/users/domob1812/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c88529a178d5ca719ebab597a4c4c3437327b2f6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c88529a178d5ca719ebab597a4c4c3437327b2f6",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c88529a178d5ca719ebab597a4c4c3437327b2f6"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 4,
      "deletions": 0
    },
    "files": [
      {
        "sha": "c1129547b7c5a445b61e4cb0b0468aa13e3cdf9c",
        "filename": "src/txmempool.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f73ef0cf3593fcf7954ab7701d6fc05480daca7e/src/txmempool.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f73ef0cf3593fcf7954ab7701d6fc05480daca7e/src/txmempool.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txmempool.cpp?ref=f73ef0cf3593fcf7954ab7701d6fc05480daca7e",
        "patch": "@@ -588,6 +588,7 @@ void CTxMemPool::_clear()\n     mapLinks.clear();\n     mapTx.clear();\n     mapNextTx.clear();\n+    mapDeltas.clear();\n     totalTxSize = 0;\n     cachedInnerUsage = 0;\n     lastRollingFeeUpdate = GetTime();\n@@ -727,6 +728,9 @@ void CTxMemPool::check(const CCoinsViewCache *pcoins) const\n         assert(it2 != mapTx.end());\n         assert(&tx == it->second);\n     }\n+    for (const auto& entry : mapDeltas) {\n+        assert(mapTx.count(entry.first) > 0);\n+    }\n \n     assert(totalTxSize == checkTotal);\n     assert(innerUsage == cachedInnerUsage);"
      }
    ]
  },
  {
    "sha": "1976013161e892bd534768f503d3f90af0987d1a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxOTc2MDEzMTYxZTg5MmJkNTM0NzY4ZjUwM2QzZjkwYWYwOTg3ZDFh",
    "commit": {
      "author": {
        "name": "Daniel Kraft",
        "email": "d@domob.eu",
        "date": "2018-08-01T16:46:38Z"
      },
      "committer": {
        "name": "Daniel Kraft",
        "email": "d@domob.eu",
        "date": "2018-08-03T18:57:40Z"
      },
      "message": "Add new 'clearmempool' RPC.\n\nThe new 'clearmempool' RPC method removes all transactions in the\nmempool.  This can be useful for testing, and might be useful also\nin some other situations.",
      "tree": {
        "sha": "e330134323bbf8fa9b861c8c9ea77f96c928738c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/e330134323bbf8fa9b861c8c9ea77f96c928738c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1976013161e892bd534768f503d3f90af0987d1a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1976013161e892bd534768f503d3f90af0987d1a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1976013161e892bd534768f503d3f90af0987d1a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1976013161e892bd534768f503d3f90af0987d1a/comments",
    "author": {
      "login": "domob1812",
      "id": 4943644,
      "node_id": "MDQ6VXNlcjQ5NDM2NDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4943644?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/domob1812",
      "html_url": "https://github.com/domob1812",
      "followers_url": "https://api.github.com/users/domob1812/followers",
      "following_url": "https://api.github.com/users/domob1812/following{/other_user}",
      "gists_url": "https://api.github.com/users/domob1812/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/domob1812/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/domob1812/subscriptions",
      "organizations_url": "https://api.github.com/users/domob1812/orgs",
      "repos_url": "https://api.github.com/users/domob1812/repos",
      "events_url": "https://api.github.com/users/domob1812/events{/privacy}",
      "received_events_url": "https://api.github.com/users/domob1812/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "domob1812",
      "id": 4943644,
      "node_id": "MDQ6VXNlcjQ5NDM2NDQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/4943644?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/domob1812",
      "html_url": "https://github.com/domob1812",
      "followers_url": "https://api.github.com/users/domob1812/followers",
      "following_url": "https://api.github.com/users/domob1812/following{/other_user}",
      "gists_url": "https://api.github.com/users/domob1812/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/domob1812/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/domob1812/subscriptions",
      "organizations_url": "https://api.github.com/users/domob1812/orgs",
      "repos_url": "https://api.github.com/users/domob1812/repos",
      "events_url": "https://api.github.com/users/domob1812/events{/privacy}",
      "received_events_url": "https://api.github.com/users/domob1812/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f73ef0cf3593fcf7954ab7701d6fc05480daca7e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f73ef0cf3593fcf7954ab7701d6fc05480daca7e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f73ef0cf3593fcf7954ab7701d6fc05480daca7e"
      }
    ],
    "stats": {
      "total": 73,
      "additions": 73,
      "deletions": 0
    },
    "files": [
      {
        "sha": "1a3b7bed80b4e598b6990eb65d08f4e2d5551fe8",
        "filename": "src/rpc/blockchain.cpp",
        "status": "modified",
        "additions": 33,
        "deletions": 0,
        "changes": 33,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1976013161e892bd534768f503d3f90af0987d1a/src/rpc/blockchain.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1976013161e892bd534768f503d3f90af0987d1a/src/rpc/blockchain.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/blockchain.cpp?ref=1976013161e892bd534768f503d3f90af0987d1a",
        "patch": "@@ -1924,6 +1924,38 @@ static UniValue savemempool(const JSONRPCRequest& request)\n     return NullUniValue;\n }\n \n+static UniValue clearmempool(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() != 0) {\n+        throw std::runtime_error(\n+            \"clearmempool\\n\"\n+            \"\\nRemoves all transactions from the mempool.\\n\"\n+            \"It will fail if a previous dump is still being loaded.\\n\"\n+            \"\\nResult:\\n\"\n+            \"{                               (json object)\\n\"\n+            \"  \\\"transactions_removed\\\": n,    (numeric) The number of evicted transactions\\n\"\n+            \"}\\n\"\n+            \"\\nExamples:\\n\"\n+            + HelpExampleCli(\"clearmempool\", \"\")\n+            + HelpExampleRpc(\"clearmempool\", \"\")\n+        );\n+    }\n+\n+    if (!g_is_mempool_loaded) {\n+        throw JSONRPCError(RPC_MISC_ERROR, \"The mempool was not loaded yet\");\n+    }\n+\n+    LOCK2(cs_main, mempool.cs);\n+\n+    UniValue result(UniValue::VOBJ);\n+    result.pushKV(\"transactions_removed\", mempool.size());\n+\n+    mempool.clear();\n+    mempool.check(pcoinsTip.get());\n+\n+    return result;\n+}\n+\n //! Search for a given set of pubkey scripts\n bool FindScriptPubKey(std::atomic<int>& scan_progress, const std::atomic<bool>& should_abort, int64_t& count, CCoinsViewCursor* cursor, const std::set<CScript>& needles, std::map<COutPoint, Coin>& out_results) {\n     scan_progress = 0;\n@@ -2230,6 +2262,7 @@ static const CRPCCommand commands[] =\n     { \"blockchain\",         \"gettxoutsetinfo\",        &gettxoutsetinfo,        {} },\n     { \"blockchain\",         \"pruneblockchain\",        &pruneblockchain,        {\"height\"} },\n     { \"blockchain\",         \"savemempool\",            &savemempool,            {} },\n+    { \"blockchain\",         \"clearmempool\",           &clearmempool,           {} },\n     { \"blockchain\",         \"verifychain\",            &verifychain,            {\"checklevel\",\"nblocks\"} },\n \n     { \"blockchain\",         \"preciousblock\",          &preciousblock,          {\"blockhash\"} },"
      },
      {
        "sha": "48de09a6e503595849619efc5e7ec554c1d8e77e",
        "filename": "test/functional/mempool_clear.py",
        "status": "added",
        "additions": 39,
        "deletions": 0,
        "changes": 39,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1976013161e892bd534768f503d3f90af0987d1a/test/functional/mempool_clear.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1976013161e892bd534768f503d3f90af0987d1a/test/functional/mempool_clear.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/mempool_clear.py?ref=1976013161e892bd534768f503d3f90af0987d1a",
        "patch": "@@ -0,0 +1,39 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2018 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test explicit clearing of the mempool.\"\"\"\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+)\n+\n+from decimal import Decimal\n+\n+\n+class MempoolClearTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+\n+    def run_test(self):\n+        address = self.nodes[0].getnewaddress()\n+        txid = self.nodes[0].sendtoaddress(address, Decimal('1'))\n+        assert_equal(self.nodes[0].getrawmempool(), [txid])\n+\n+        # Add a fee delta to make the mempool more complicated before we\n+        # clear it.\n+        self.nodes[0].prioritisetransaction(txid, None, 1000)\n+\n+        assert_equal(self.nodes[0].clearmempool(), {\"transactions_removed\": 1})\n+        assert_equal(self.nodes[0].getrawmempool(), [])\n+        assert_equal(self.nodes[0].clearmempool(), {\"transactions_removed\": 0})\n+        assert_equal(self.nodes[0].getrawmempool(), [])\n+\n+        # Mine a block, it should not confirm the wallet transaction.\n+        self.nodes[0].generate(1)\n+        assert_equal(self.nodes[0].gettransaction(txid)['confirmations'], 0)\n+\n+\n+if __name__ == '__main__':\n+    MempoolClearTest().main()"
      },
      {
        "sha": "5e95b2ca71cc7bea66c9cc48276be41e9a0c10ce",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1976013161e892bd534768f503d3f90af0987d1a/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1976013161e892bd534768f503d3f90af0987d1a/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=1976013161e892bd534768f503d3f90af0987d1a",
        "patch": "@@ -119,6 +119,7 @@\n     'p2p_invalid_tx.py',\n     'rpc_createmultisig.py',\n     'feature_versionbits_warning.py',\n+    'mempool_clear.py',\n     'rpc_preciousblock.py',\n     'wallet_importprunedfunds.py',\n     'rpc_zmq.py',"
      }
    ]
  }
]