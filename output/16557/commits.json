[
  {
    "sha": "214c4ecb9ab306627a08abb35cf82c73f10ec627",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyMTRjNGVjYjlhYjMwNjYyN2EwOGFiYjM1Y2Y4MmM3M2YxMGVjNjI3",
    "commit": {
      "author": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2019-08-06T18:38:34Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2019-08-06T18:38:34Z"
      },
      "message": "[wallet] restore coinbase check in SubmitMemoryPoolAndRelay()\n\nThis check doesn't change mempool acceptance/relay behaviour, but reduces log spam.",
      "tree": {
        "sha": "197fda0b61ba6782c113f7a51de5352c174422e1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/197fda0b61ba6782c113f7a51de5352c174422e1"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/214c4ecb9ab306627a08abb35cf82c73f10ec627",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/214c4ecb9ab306627a08abb35cf82c73f10ec627",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/214c4ecb9ab306627a08abb35cf82c73f10ec627",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/214c4ecb9ab306627a08abb35cf82c73f10ec627/comments",
    "author": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e5fdda68c6d2313edb74443f0d1e6d2ce2d97f5e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e5fdda68c6d2313edb74443f0d1e6d2ce2d97f5e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e5fdda68c6d2313edb74443f0d1e6d2ce2d97f5e"
      }
    ],
    "stats": {
      "total": 3,
      "additions": 3,
      "deletions": 0
    },
    "files": [
      {
        "sha": "4701bd356471c3bd0cfcf5a7ecbdac56d9e39d4b",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/214c4ecb9ab306627a08abb35cf82c73f10ec627/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/214c4ecb9ab306627a08abb35cf82c73f10ec627/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=214c4ecb9ab306627a08abb35cf82c73f10ec627",
        "patch": "@@ -2160,6 +2160,9 @@ bool CWalletTx::SubmitMemoryPoolAndRelay(std::string& err_string, bool relay)\n     if (!pwallet->GetBroadcastTransactions()) return false;\n     // Don't relay abandoned transactions\n     if (isAbandoned()) return false;\n+    // Don't try to submit coinbase transactions. These would fail anyway but would\n+    // cause log spam.\n+    if (IsCoinBase()) return false;\n \n     // Submit transaction to mempool for relay\n     pwallet->WalletLogPrintf(\"Submitting wtx %s to mempool for relay\\n\", GetHash().ToString());"
      }
    ]
  },
  {
    "sha": "c8b53c3beafa289dcdbd8c2ee9f957bdeca79cbc",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjOGI1M2MzYmVhZmEyODlkY2RiZDhjMmVlOWY5NTdiZGVjYTc5Y2Jj",
    "commit": {
      "author": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2019-08-09T15:07:30Z"
      },
      "committer": {
        "name": "John Newbery",
        "email": "john@johnnewbery.com",
        "date": "2019-08-09T15:07:30Z"
      },
      "message": "[wallet] Restore confirmed/conflicted tx check in SubmitMemoryPoolAndRelay()\n\nRestores the confirmed/conflicted tx check removed in\n8753f5652b4710e66b50ce87788bf6f33619b75a. There should be no external\nbehaviour change (these txs would not get accepted to the mempool\nanyway), but not having the check in the wallet causes log spam.\n\nAlso adds a comment to ResentWalletTransactions() that\nconfirmed/conflicted tx check is done in SubmitMemoryPoolAndRelay().",
      "tree": {
        "sha": "037a90aebdff141019e52eed0872c177ef1a5e4b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/037a90aebdff141019e52eed0872c177ef1a5e4b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c8b53c3beafa289dcdbd8c2ee9f957bdeca79cbc",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c8b53c3beafa289dcdbd8c2ee9f957bdeca79cbc",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c8b53c3beafa289dcdbd8c2ee9f957bdeca79cbc",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c8b53c3beafa289dcdbd8c2ee9f957bdeca79cbc/comments",
    "author": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jnewbery",
      "id": 1063656,
      "node_id": "MDQ6VXNlcjEwNjM2NTY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1063656?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jnewbery",
      "html_url": "https://github.com/jnewbery",
      "followers_url": "https://api.github.com/users/jnewbery/followers",
      "following_url": "https://api.github.com/users/jnewbery/following{/other_user}",
      "gists_url": "https://api.github.com/users/jnewbery/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jnewbery/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jnewbery/subscriptions",
      "organizations_url": "https://api.github.com/users/jnewbery/orgs",
      "repos_url": "https://api.github.com/users/jnewbery/repos",
      "events_url": "https://api.github.com/users/jnewbery/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jnewbery/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "214c4ecb9ab306627a08abb35cf82c73f10ec627",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/214c4ecb9ab306627a08abb35cf82c73f10ec627",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/214c4ecb9ab306627a08abb35cf82c73f10ec627"
      }
    ],
    "stats": {
      "total": 17,
      "additions": 10,
      "deletions": 7
    },
    "files": [
      {
        "sha": "03acf23508bcc5638119328721e846c24d7f89a1",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 6,
        "changes": 15,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c8b53c3beafa289dcdbd8c2ee9f957bdeca79cbc/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c8b53c3beafa289dcdbd8c2ee9f957bdeca79cbc/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=c8b53c3beafa289dcdbd8c2ee9f957bdeca79cbc",
        "patch": "@@ -2150,11 +2150,11 @@ void CWallet::ReacceptWalletTransactions(interfaces::Chain::Lock& locked_chain)\n     for (const std::pair<const int64_t, CWalletTx*>& item : mapSorted) {\n         CWalletTx& wtx = *(item.second);\n         std::string unused_err_string;\n-        wtx.SubmitMemoryPoolAndRelay(unused_err_string, false);\n+        wtx.SubmitMemoryPoolAndRelay(unused_err_string, false, locked_chain);\n     }\n }\n \n-bool CWalletTx::SubmitMemoryPoolAndRelay(std::string& err_string, bool relay)\n+bool CWalletTx::SubmitMemoryPoolAndRelay(std::string& err_string, bool relay, interfaces::Chain::Lock& locked_chain)\n {\n     // Can't relay if wallet is not broadcasting\n     if (!pwallet->GetBroadcastTransactions()) return false;\n@@ -2163,6 +2163,8 @@ bool CWalletTx::SubmitMemoryPoolAndRelay(std::string& err_string, bool relay)\n     // Don't try to submit coinbase transactions. These would fail anyway but would\n     // cause log spam.\n     if (IsCoinBase()) return false;\n+    // Don't try to submit conflicted or confirmed transactions.\n+    if (GetDepthInMainChain(locked_chain) != 0) return false;\n \n     // Submit transaction to mempool for relay\n     pwallet->WalletLogPrintf(\"Submitting wtx %s to mempool for relay\\n\", GetHash().ToString());\n@@ -2377,11 +2379,12 @@ void CWallet::ResendWalletTransactions()\n         // Relay transactions\n         for (std::pair<const uint256, CWalletTx>& item : mapWallet) {\n             CWalletTx& wtx = item.second;\n-            // only rebroadcast unconfirmed txes older than 5 minutes before the\n-            // last block was found\n+            // Attempt to rebroadcast all txes more than 5 minutes older than\n+            // the last block. SubmitMemoryPoolAndRelay() will not rebroadcast\n+            // any confirmed or conflicting txs.\n             if (wtx.nTimeReceived > m_best_block_time - 5 * 60) continue;\n             std::string unused_err_string;\n-            if (wtx.SubmitMemoryPoolAndRelay(unused_err_string, true)) ++submitted_tx_count;\n+            if (wtx.SubmitMemoryPoolAndRelay(unused_err_string, true, *locked_chain)) ++submitted_tx_count;\n         }\n     } // locked_chain and cs_wallet\n \n@@ -3326,7 +3329,7 @@ bool CWallet::CommitTransaction(CTransactionRef tx, mapValue_t mapValue, std::ve\n         if (fBroadcastTransactions)\n         {\n             std::string err_string;\n-            if (!wtx.SubmitMemoryPoolAndRelay(err_string, true)) {\n+            if (!wtx.SubmitMemoryPoolAndRelay(err_string, true, *locked_chain)) {\n                 WalletLogPrintf(\"CommitTransaction(): Transaction cannot be broadcast immediately, %s\\n\", err_string);\n                 // TODO: if we expect the failure to be long term or permanent, instead delete wtx from the wallet and return failure.\n             }"
      },
      {
        "sha": "cf388ad827d87e8d0a00f6ce5563135e222a3842",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c8b53c3beafa289dcdbd8c2ee9f957bdeca79cbc/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c8b53c3beafa289dcdbd8c2ee9f957bdeca79cbc/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=c8b53c3beafa289dcdbd8c2ee9f957bdeca79cbc",
        "patch": "@@ -580,7 +580,7 @@ class CWalletTx\n     int64_t GetTxTime() const;\n \n     // Pass this transaction to node for mempool insertion and relay to peers if flag set to true\n-    bool SubmitMemoryPoolAndRelay(std::string& err_string, bool relay);\n+    bool SubmitMemoryPoolAndRelay(std::string& err_string, bool relay, interfaces::Chain::Lock& locked_chain);\n \n     // TODO: Remove \"NO_THREAD_SAFETY_ANALYSIS\" and replace it with the correct\n     // annotation \"EXCLUSIVE_LOCKS_REQUIRED(pwallet->cs_wallet)\". The annotation"
      }
    ]
  }
]