[
  {
    "sha": "50f8ba992cdb75a222d9aa321592fd5acdd73b8c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1MGY4YmE5OTJjZGI3NWEyMjJkOWFhMzIxNTkyZmQ1YWNkZDczYjhj",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-17T05:02:23Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-17T05:02:43Z"
      },
      "message": "Fix potential memory leak in m_process_time",
      "tree": {
        "sha": "846e491070baea8da356b0eadd33d8b2ef858c10",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/846e491070baea8da356b0eadd33d8b2ef858c10"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/50f8ba992cdb75a222d9aa321592fd5acdd73b8c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/50f8ba992cdb75a222d9aa321592fd5acdd73b8c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/50f8ba992cdb75a222d9aa321592fd5acdd73b8c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/50f8ba992cdb75a222d9aa321592fd5acdd73b8c/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "a238fccce84bcd5544e88bdc37bf5b9b387d2164",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a238fccce84bcd5544e88bdc37bf5b9b387d2164",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/a238fccce84bcd5544e88bdc37bf5b9b387d2164"
      }
    ],
    "stats": {
      "total": 7,
      "additions": 5,
      "deletions": 2
    },
    "files": [
      {
        "sha": "015c9057814284fdea9434e3c5d1ad69391e7cab",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 2,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/50f8ba992cdb75a222d9aa321592fd5acdd73b8c/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/50f8ba992cdb75a222d9aa321592fd5acdd73b8c/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=50f8ba992cdb75a222d9aa321592fd5acdd73b8c",
        "patch": "@@ -2415,8 +2415,11 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         CValidationState state;\n \n         CNodeState* nodestate = State(pfrom->GetId());\n-        nodestate->m_tx_download.m_tx_announced.erase(inv.hash);\n-        nodestate->m_tx_download.m_tx_in_flight.erase(inv.hash);\n+        if (nodestate->m_tx_download.m_tx_in_flight.erase(inv.hash)) {\n+            // only erase from m_tx_announced if we've already erased\n+            // from m_tx_process_time\n+            nodestate->m_tx_download.m_tx_announced.erase(inv.hash);\n+        }\n         EraseTxRequest(inv.hash);\n \n         std::list<CTransactionRef> lRemovedTxn;"
      }
    ]
  },
  {
    "sha": "44bafa17ce56506443db5218daf1c1956c862e6f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0NGJhZmExN2NlNTY1MDY0NDNkYjUyMThkYWYxYzE5NTZjODYyZTZm",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-09T05:40:02Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-17T05:12:01Z"
      },
      "message": "Report number of pending/inflight tx requests via getpeerinfo",
      "tree": {
        "sha": "4c10386180bab71a3fe908ca49c1007bf810604b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4c10386180bab71a3fe908ca49c1007bf810604b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/44bafa17ce56506443db5218daf1c1956c862e6f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/44bafa17ce56506443db5218daf1c1956c862e6f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/44bafa17ce56506443db5218daf1c1956c862e6f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/44bafa17ce56506443db5218daf1c1956c862e6f/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "50f8ba992cdb75a222d9aa321592fd5acdd73b8c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/50f8ba992cdb75a222d9aa321592fd5acdd73b8c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/50f8ba992cdb75a222d9aa321592fd5acdd73b8c"
      }
    ],
    "stats": {
      "total": 8,
      "additions": 8,
      "deletions": 0
    },
    "files": [
      {
        "sha": "36b3234a40930a1e7e7321312d32d932833c2ed0",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/44bafa17ce56506443db5218daf1c1956c862e6f/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/44bafa17ce56506443db5218daf1c1956c862e6f/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=44bafa17ce56506443db5218daf1c1956c862e6f",
        "patch": "@@ -797,6 +797,8 @@ bool GetNodeStateStats(NodeId nodeid, CNodeStateStats &stats) {\n     stats.nMisbehavior = state->nMisbehavior;\n     stats.nSyncHeight = state->pindexBestKnownBlock ? state->pindexBestKnownBlock->nHeight : -1;\n     stats.nCommonHeight = state->pindexLastCommonBlock ? state->pindexLastCommonBlock->nHeight : -1;\n+    stats.nTxInFlight = state->m_tx_download.m_tx_in_flight.size();\n+    stats.nTxProcess = state->m_tx_download.m_tx_process_time.size();\n     for (const QueuedBlock& queue : state->vBlocksInFlight) {\n         if (queue.pindex)\n             stats.vHeightInFlight.push_back(queue.pindex->nHeight);"
      },
      {
        "sha": "c2f158d58bb31c59d6b0605ee9ec7c619a5d8478",
        "filename": "src/net_processing.h",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/44bafa17ce56506443db5218daf1c1956c862e6f/src/net_processing.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/44bafa17ce56506443db5218daf1c1956c862e6f/src/net_processing.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.h?ref=44bafa17ce56506443db5218daf1c1956c862e6f",
        "patch": "@@ -83,6 +83,8 @@ struct CNodeStateStats {\n     int nMisbehavior = 0;\n     int nSyncHeight = -1;\n     int nCommonHeight = -1;\n+    int nTxInFlight = -1;\n+    int nTxProcess = -1;\n     std::vector<int> vHeightInFlight;\n };\n "
      },
      {
        "sha": "a66d2dff55a8f2f48e4efc414eef6a2354119722",
        "filename": "src/rpc/net.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/44bafa17ce56506443db5218daf1c1956c862e6f/src/rpc/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/44bafa17ce56506443db5218daf1c1956c862e6f/src/rpc/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/net.cpp?ref=44bafa17ce56506443db5218daf1c1956c862e6f",
        "patch": "@@ -106,6 +106,8 @@ static UniValue getpeerinfo(const JSONRPCRequest& request)\n             \"    \\\"banscore\\\": n,             (numeric) The ban score\\n\"\n             \"    \\\"synced_headers\\\": n,       (numeric) The last header we have in common with this peer\\n\"\n             \"    \\\"synced_blocks\\\": n,        (numeric) The last block we have in common with this peer\\n\"\n+            \"    \\\"tx_inflight\\\": n,          (numeric) The number of transactions this peer is expected to tell us about\\n\"\n+            \"    \\\"tx_process\\\": n,           (numeric) The number of transactions we'd like to ask this peer about soon\\n\"\n             \"    \\\"inflight\\\": [\\n\"\n             \"       n,                        (numeric) The heights of blocks we're currently asking from this peer\\n\"\n             \"       ...\\n\"\n@@ -178,6 +180,8 @@ static UniValue getpeerinfo(const JSONRPCRequest& request)\n             obj.pushKV(\"banscore\", statestats.nMisbehavior);\n             obj.pushKV(\"synced_headers\", statestats.nSyncHeight);\n             obj.pushKV(\"synced_blocks\", statestats.nCommonHeight);\n+            obj.pushKV(\"tx_inflight\", statestats.nTxInFlight);\n+            obj.pushKV(\"tx_process\", statestats.nTxProcess);\n             UniValue heights(UniValue::VARR);\n             for (const int height : statestats.vHeightInFlight) {\n                 heights.push_back(height);"
      }
    ]
  },
  {
    "sha": "e1576bf0febad66b79ea96153a1e1a5ffc3e6aa6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplMTU3NmJmMGZlYmFkNjZiNzllYTk2MTUzYTFlMWE1ZmZjM2U2YWE2",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-10T08:04:34Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-17T05:12:01Z"
      },
      "message": "Log NOTFOUND messages",
      "tree": {
        "sha": "5e91edc62946b60f8da63c4e60d9840b03d4ff5e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5e91edc62946b60f8da63c4e60d9840b03d4ff5e"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e1576bf0febad66b79ea96153a1e1a5ffc3e6aa6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e1576bf0febad66b79ea96153a1e1a5ffc3e6aa6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e1576bf0febad66b79ea96153a1e1a5ffc3e6aa6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e1576bf0febad66b79ea96153a1e1a5ffc3e6aa6/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "44bafa17ce56506443db5218daf1c1956c862e6f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/44bafa17ce56506443db5218daf1c1956c862e6f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/44bafa17ce56506443db5218daf1c1956c862e6f"
      }
    ],
    "stats": {
      "total": 9,
      "additions": 9,
      "deletions": 0
    },
    "files": [
      {
        "sha": "42ebba99a408bafa9b14c6924d80a481731784eb",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 0,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e1576bf0febad66b79ea96153a1e1a5ffc3e6aa6/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e1576bf0febad66b79ea96153a1e1a5ffc3e6aa6/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=e1576bf0febad66b79ea96153a1e1a5ffc3e6aa6",
        "patch": "@@ -3121,6 +3121,15 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     if (strCommand == NetMsgType::NOTFOUND) {\n         // We do not care about the NOTFOUND message, but logging an Unknown Command\n         // message would be undesirable as we transmit it ourselves.\n+        std::vector<CInv> vInv;\n+        vRecv >> vInv;\n+        // note: we don't enforce a limit on number of inv's in a notfound\n+\n+        LogPrint(BCLog::NET, \"received notfound (%u invsz) peer=%d\\n\", vInv.size(), pfrom->GetId());\n+\n+        if (vInv.size() > 0) {\n+            LogPrint(BCLog::NET, \"received notfound for: %s peer=%d\\n\", vInv[0].ToString(), pfrom->GetId());\n+        }\n         return true;\n     }\n "
      }
    ]
  },
  {
    "sha": "465d2ad17768e8d573dee8c0a12ec70381327c05",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0NjVkMmFkMTc3NjhlOGQ1NzNkZWU4YzBhMTJlYzcwMzgxMzI3YzA1",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-09T07:11:40Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-17T05:12:01Z"
      },
      "message": "Test p2p behaviour for getdata/notfound",
      "tree": {
        "sha": "0e1a20ff2dd6edf922db8288991af6a854ff3fa7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/0e1a20ff2dd6edf922db8288991af6a854ff3fa7"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/465d2ad17768e8d573dee8c0a12ec70381327c05",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/465d2ad17768e8d573dee8c0a12ec70381327c05",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/465d2ad17768e8d573dee8c0a12ec70381327c05",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/465d2ad17768e8d573dee8c0a12ec70381327c05/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e1576bf0febad66b79ea96153a1e1a5ffc3e6aa6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e1576bf0febad66b79ea96153a1e1a5ffc3e6aa6",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e1576bf0febad66b79ea96153a1e1a5ffc3e6aa6"
      }
    ],
    "stats": {
      "total": 105,
      "additions": 105,
      "deletions": 0
    },
    "files": [
      {
        "sha": "46bf36e574843b7b367c6b5db7b8be1b56713de5",
        "filename": "test/functional/p2p_getdata_parent_failure.py",
        "status": "added",
        "additions": 104,
        "deletions": 0,
        "changes": 104,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/465d2ad17768e8d573dee8c0a12ec70381327c05/test/functional/p2p_getdata_parent_failure.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/465d2ad17768e8d573dee8c0a12ec70381327c05/test/functional/p2p_getdata_parent_failure.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_getdata_parent_failure.py?ref=465d2ad17768e8d573dee8c0a12ec70381327c05",
        "patch": "@@ -0,0 +1,104 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2015-2018 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test node responses to invalid transactions.\n+\n+In this test we connect to one node over p2p, and test tx requests.\"\"\"\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+    connect_nodes,\n+    disconnect_nodes,\n+)\n+import time\n+\n+class GetDataFailureTest(BitcoinTestFramework):\n+    NUM_ADDR = 25\n+\n+    def set_test_params(self):\n+        self.num_nodes = 2\n+        self.setup_clean_chain = True\n+\n+    def skip_test_if_missing_module(self):\n+        self.skip_if_no_wallet()\n+\n+    def peerinfo_interesting(self, node):\n+        pi = node.getpeerinfo()\n+        mpi = node.getmempoolinfo()\n+        return mpi[\"size\"],pi[0][\"tx_inflight\"], pi[0][\"tx_process\"]\n+\n+    def run_test(self):\n+        node_work,node_miss = self.nodes  # convenience reference to the nodes\n+\n+        mt = int(time.time())\n+        node_miss.setmocktime(mt)\n+        node_work.setmocktime(mt)\n+\n+        node_work.generate(2) # 100 BTC mature\n+        self.sync_all()\n+        node_miss.generate(100)\n+\n+        self.log.info('Setup %d wallet addresses' % self.NUM_ADDR)\n+        addr = [node_work.getnewaddress() for i in range(self.NUM_ADDR)]\n+        self.sync_all()\n+\n+        self.log.info('Setup with %d utxos to spend' % (5*self.NUM_ADDR))\n+        assert(5*self.NUM_ADDR*0.351 < 50)\n+        node_work.sendmany(\"\", {a: 0.351 for a in addr})\n+        node_work.sendmany(\"\", {a: 0.351 for a in addr})\n+        node_work.sendmany(\"\", {a: 0.351 for a in addr})\n+        node_work.sendmany(\"\", {a: 0.351 for a in addr})\n+        node_work.sendmany(\"\", {a: 0.351 for a in addr})\n+\n+        self.sync_all()\n+        node_miss.generate(1)\n+        self.sync_all()\n+        assert_equal(node_work.getmempoolinfo()[\"size\"], 0)\n+        assert_equal(node_miss.getmempoolinfo()[\"size\"], 0)\n+\n+        self.log.info('Disconnect node_miss, create 100 transactions')\n+        disconnect_nodes(self.nodes[0], 1)\n+        utxos = []\n+        for i in range(100):\n+            rawtx = node_work.createrawtransaction( [], [{addr[0]: 0.2}] )\n+            rawtxf = node_work.fundrawtransaction(rawtx)\n+            vout = 1-rawtxf[\"changepos\"]\n+            rawtxs = node_work.signrawtransactionwithwallet(rawtxf[\"hex\"])\n+            txid = node_work.sendrawtransaction(rawtxs[\"hex\"])\n+            utxos.append( (txid, vout) )\n+\n+        self.log.info('Bump time by 20 minutes, reconnect nodes')\n+        mt += 20*60 # bump time by 20 minutes\n+        node_miss.setmocktime(mt)\n+        node_work.setmocktime(mt)\n+\n+        connect_nodes(self.nodes[0], 1)\n+\n+        self.log.info('Create %d txs with parents in mempool for >15m' % (len(utxos)))\n+        for txid,vout in utxos:\n+            rawtx = node_work.createrawtransaction( [{\"txid\":txid, \"vout\":vout}], [{addr[0]: 0.199}] )\n+            rawtxs = node_work.signrawtransactionwithwallet(rawtx)\n+            txid = node_work.sendrawtransaction(rawtxs[\"hex\"])\n+\n+        # time to sync\n+        time.sleep(25)\n+\n+        self.log.info(\"Check node_miss didn't see any transactions\")\n+        assert_equal(self.peerinfo_interesting(node_miss), (0, 100, 0))\n+        assert_equal(self.peerinfo_interesting(node_work), (200, 0, 0))\n+\n+        txid = node_miss.sendtoaddress(addr[0], 0.5)\n+        self.log.info(\"Check node_miss transactions still work (%s)\" % (txid))\n+        time.sleep(25)\n+        assert_equal(self.peerinfo_interesting(node_miss), (1, 100, 0))\n+        assert_equal(self.peerinfo_interesting(node_work), (201, 0, 0))\n+\n+        txid = node_work.sendtoaddress(addr[0], 30)\n+        self.log.info(\"Check legit node_work transactions don't work at all (%s)\" % (txid))\n+        time.sleep(25)\n+        assert_equal(self.peerinfo_interesting(node_miss), (1, 100, 1))\n+        assert_equal(self.peerinfo_interesting(node_work), (202, 0, 0))\n+\n+if __name__ == '__main__':\n+    GetDataFailureTest().main()"
      },
      {
        "sha": "93ab87bbeaaaa39bf3136df34463918e6fd6a951",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/465d2ad17768e8d573dee8c0a12ec70381327c05/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/465d2ad17768e8d573dee8c0a12ec70381327c05/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=465d2ad17768e8d573dee8c0a12ec70381327c05",
        "patch": "@@ -85,6 +85,7 @@\n     'p2p_segwit.py',\n     'p2p_timeouts.py',\n     'wallet_dump.py',\n+    'p2p_getdata_parent_failure.py',\n     'wallet_listtransactions.py',\n     # vv Tests less than 60s vv\n     'p2p_sendheaders.py',"
      }
    ]
  },
  {
    "sha": "b83bf533c823e233fc7a7e174aa9dde880506b9f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiODNiZjUzM2M4MjNlMjMzZmM3YTdlMTc0YWE5ZGRlODgwNTA2Yjlm",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-09T07:11:40Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-17T05:12:01Z"
      },
      "message": "Test p2p behaviour when getdata is ignored",
      "tree": {
        "sha": "4ba0b1cc7e37a8264295203554aacce7c4e1e2e0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4ba0b1cc7e37a8264295203554aacce7c4e1e2e0"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b83bf533c823e233fc7a7e174aa9dde880506b9f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b83bf533c823e233fc7a7e174aa9dde880506b9f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b83bf533c823e233fc7a7e174aa9dde880506b9f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b83bf533c823e233fc7a7e174aa9dde880506b9f/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "465d2ad17768e8d573dee8c0a12ec70381327c05",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/465d2ad17768e8d573dee8c0a12ec70381327c05",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/465d2ad17768e8d573dee8c0a12ec70381327c05"
      }
    ],
    "stats": {
      "total": 120,
      "additions": 120,
      "deletions": 0
    },
    "files": [
      {
        "sha": "4b0faf137f7888590bd81ea67bcf9005aebb8a96",
        "filename": "test/functional/p2p_getdata_ignore.py",
        "status": "added",
        "additions": 119,
        "deletions": 0,
        "changes": 119,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b83bf533c823e233fc7a7e174aa9dde880506b9f/test/functional/p2p_getdata_ignore.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b83bf533c823e233fc7a7e174aa9dde880506b9f/test/functional/p2p_getdata_ignore.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_getdata_ignore.py?ref=b83bf533c823e233fc7a7e174aa9dde880506b9f",
        "patch": "@@ -0,0 +1,119 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2015-2018 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test node responses to invalid transactions.\n+\n+In this test we connect to one node over p2p, and test tx requests.\"\"\"\n+from test_framework.blocktools import create_block, create_coinbase\n+from test_framework.messages import (\n+    CInv,\n+    COIN,\n+    COutPoint,\n+    CTransaction,\n+    CTxIn,\n+    CTxOut,\n+    msg_inv,\n+)\n+from test_framework.mininode import P2PDataStore\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import (\n+    assert_equal,\n+)\n+import time\n+\n+class InvalidTxRequestTest(BitcoinTestFramework):\n+    SCRIPT_PUB_KEY_OP_TRUE = b'\\x51\\x75' * 15 + b'\\x51'\n+\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+        self.withheld_tx_offset = 0\n+\n+    def bootstrap_p2p(self, *, num_connections=1):\n+        \"\"\"Add a P2P connection to the node.\n+\n+        Helper to connect and wait for version handshake.\"\"\"\n+        for _ in range(num_connections):\n+            self.nodes[0].add_p2p_connection(P2PDataStore())\n+\n+    def reconnect_p2p(self, **kwargs):\n+        \"\"\"Tear down and bootstrap the P2P connection to the node.\n+\n+        The node gets disconnected several times in this test. This helper\n+        method reconnects the p2p and restarts the network thread.\"\"\"\n+        self.nodes[0].disconnect_p2ps()\n+        self.bootstrap_p2p(**kwargs)\n+\n+    def p2p_withheld_tx(self, num):\n+        node = self.nodes[0]  # convenience reference to the node\n+        for i in range(num):\n+            tx_withhold = CTransaction()\n+            tx_withhold.vin.append(CTxIn(outpoint=COutPoint(self.block1.vtx[0].sha256, 0)))\n+            tx_withhold.vout.append(CTxOut(nValue=50 * COIN - 12000 + self.withheld_tx_offset + i, scriptPubKey=self.SCRIPT_PUB_KEY_OP_TRUE))\n+            tx_withhold.calc_sha256()\n+            self.log.debug(\"Withheld tx %d %s\" % (self.withheld_tx_offset+i+1, tx_withhold.hash))\n+            node.p2p.send_message(msg_inv(inv=[CInv(1, tx_withhold.sha256)]))\n+        self.withheld_tx_offset += num\n+        time.sleep(5) # give it time to actually do some getdata requests\n+\n+    def run_test(self):\n+        node = self.nodes[0]  # convenience reference to the node\n+        mt = int(time.time())\n+        node.setmocktime(mt)\n+\n+        self.bootstrap_p2p()  # Add one p2p connection to the node\n+\n+        best_block = self.nodes[0].getbestblockhash()\n+        tip = int(best_block, 16)\n+        best_block_time = self.nodes[0].getblock(best_block)['time']\n+        block_time = best_block_time + 1\n+\n+        self.log.info(\"Create a new block with an anyone-can-spend coinbase.\")\n+        height = 1\n+        block = create_block(tip, create_coinbase(height), block_time)\n+        block.solve()\n+        # Save the coinbase for later\n+        self.block1 = block\n+        tip = block.sha256\n+        node.p2p.send_blocks_and_test([block], node, success=True)\n+\n+        self.log.info(\"Mature the block.\")\n+        self.nodes[0].generatetoaddress(100, self.nodes[0].get_deterministic_priv_key().address)\n+\n+        self.log.info('Test withheld transaction handling ... ')\n+        # Create a root transaction that we withhold until all dependent transactions\n+        # are sent out and in the orphan cache\n+\n+        time.sleep(1) # catch up\n+        node.p2p.getdata_requests = [] # clear this\n+        self.p2p_withheld_tx(120)\n+\n+        assert_equal(0, node.getmempoolinfo()['size'])  # Mempool should be empty\n+        assert_equal(1, len(node.getpeerinfo()))  # still connected\n+        assert_equal(len(node.p2p.getdata_requests), 100) # stop at >100 getdata requests\n+        self.log.info(\"Correctly asked for 100 transactions out of 120!\")\n+        node.p2p.getdata_requests = [] # clear again\n+\n+        self.log.info(\"Have 40 unasked-for transactions queued at 2min...\")\n+        node.setmocktime(mt+2*60)\n+        self.p2p_withheld_tx(20)\n+        assert_equal(len(node.p2p.getdata_requests), 0)\n+        assert_equal(node.getpeerinfo()[0][\"tx_process\"], 40)\n+\n+        self.log.info(\"Have 60 unasked-for transactions queued at 28min...\")\n+        node.setmocktime(mt+28*60)\n+        self.p2p_withheld_tx(20)\n+        assert_equal(len(node.p2p.getdata_requests), 0)\n+        assert_equal(node.getpeerinfo()[0][\"tx_process\"], 60)\n+\n+        self.log.info(\"Have 80 unasked-for transactions queued at 32min...\")\n+        node.setmocktime(mt+32*60)\n+        self.p2p_withheld_tx(20)\n+        assert_equal(len(node.p2p.getdata_requests), 0)\n+        assert_equal(node.getpeerinfo()[0][\"tx_process\"], 80)\n+        assert_equal(0, node.getmempoolinfo()['size'])  # Mempool should be empty\n+        assert_equal(1, len(node.getpeerinfo()))  # still connected\n+\n+if __name__ == '__main__':\n+    InvalidTxRequestTest().main()"
      },
      {
        "sha": "e1cfc82563728e473d4fef5186272b04c10d4bb4",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b83bf533c823e233fc7a7e174aa9dde880506b9f/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b83bf533c823e233fc7a7e174aa9dde880506b9f/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=b83bf533c823e233fc7a7e174aa9dde880506b9f",
        "patch": "@@ -104,6 +104,7 @@\n     # vv Tests less than 30s vv\n     'wallet_keypool_topup.py',\n     'interface_zmq.py',\n+    'p2p_getdata_ignore.py',\n     'interface_bitcoin_cli.py',\n     'mempool_resurrect.py',\n     'wallet_txn_doublespend.py --mineblock',"
      }
    ]
  },
  {
    "sha": "e96932fd7e9b45b077529e707e253114f56180c8",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplOTY5MzJmZDdlOWI0NWIwNzc1MjllNzA3ZTI1MzExNGY1NjE4MGM4",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-10T05:04:14Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-17T05:12:01Z"
      },
      "message": "Remove NOTFOUND txs from in_flight set",
      "tree": {
        "sha": "5a06a6c781635cae452e67ea5bd4b305f9fad70b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5a06a6c781635cae452e67ea5bd4b305f9fad70b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e96932fd7e9b45b077529e707e253114f56180c8",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e96932fd7e9b45b077529e707e253114f56180c8",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e96932fd7e9b45b077529e707e253114f56180c8",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e96932fd7e9b45b077529e707e253114f56180c8/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b83bf533c823e233fc7a7e174aa9dde880506b9f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b83bf533c823e233fc7a7e174aa9dde880506b9f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b83bf533c823e233fc7a7e174aa9dde880506b9f"
      }
    ],
    "stats": {
      "total": 26,
      "additions": 19,
      "deletions": 7
    },
    "files": [
      {
        "sha": "2ff880a551acd0f410b665a32ad48ead34086177",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 14,
        "deletions": 2,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e96932fd7e9b45b077529e707e253114f56180c8/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e96932fd7e9b45b077529e707e253114f56180c8/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=e96932fd7e9b45b077529e707e253114f56180c8",
        "patch": "@@ -3119,8 +3119,7 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n     }\n \n     if (strCommand == NetMsgType::NOTFOUND) {\n-        // We do not care about the NOTFOUND message, but logging an Unknown Command\n-        // message would be undesirable as we transmit it ourselves.\n+        // NOTFOUND means we can clear the entry from the tx_in_flight/announced set\n         std::vector<CInv> vInv;\n         vRecv >> vInv;\n         // note: we don't enforce a limit on number of inv's in a notfound\n@@ -3130,6 +3129,19 @@ bool static ProcessMessage(CNode* pfrom, const std::string& strCommand, CDataStr\n         if (vInv.size() > 0) {\n             LogPrint(BCLog::NET, \"received notfound for: %s peer=%d\\n\", vInv[0].ToString(), pfrom->GetId());\n         }\n+\n+        {\n+            LOCK(cs_main);\n+            CNodeState* nodestate = State(pfrom->GetId());\n+            for (const CInv& inv : vInv) {\n+                if (inv.type == MSG_TX || inv.type == MSG_WITNESS_TX) {\n+                    if (nodestate->m_tx_download.m_tx_in_flight.erase(inv.hash)) {\n+                        nodestate->m_tx_download.m_tx_announced.erase(inv.hash);\n+                    }\n+                }\n+            }\n+        }\n+\n         return true;\n     }\n "
      },
      {
        "sha": "c30a3e0e33950f60dc23d7711500136483c1471c",
        "filename": "test/functional/p2p_getdata_parent_failure.py",
        "status": "modified",
        "additions": 5,
        "deletions": 5,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e96932fd7e9b45b077529e707e253114f56180c8/test/functional/p2p_getdata_parent_failure.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e96932fd7e9b45b077529e707e253114f56180c8/test/functional/p2p_getdata_parent_failure.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_getdata_parent_failure.py?ref=e96932fd7e9b45b077529e707e253114f56180c8",
        "patch": "@@ -84,20 +84,20 @@ def run_test(self):\n         # time to sync\n         time.sleep(25)\n \n-        self.log.info(\"Check node_miss didn't see any transactions\")\n-        assert_equal(self.peerinfo_interesting(node_miss), (0, 100, 0))\n+        self.log.info(\"Check node_miss didn't see any transactions, but isn't confused either\")\n+        assert_equal(self.peerinfo_interesting(node_miss), (0, 0, 0))\n         assert_equal(self.peerinfo_interesting(node_work), (200, 0, 0))\n \n         txid = node_miss.sendtoaddress(addr[0], 0.5)\n         self.log.info(\"Check node_miss transactions still work (%s)\" % (txid))\n         time.sleep(25)\n-        assert_equal(self.peerinfo_interesting(node_miss), (1, 100, 0))\n+        assert_equal(self.peerinfo_interesting(node_miss), (1, 0, 0))\n         assert_equal(self.peerinfo_interesting(node_work), (201, 0, 0))\n \n         txid = node_work.sendtoaddress(addr[0], 30)\n-        self.log.info(\"Check legit node_work transactions don't work at all (%s)\" % (txid))\n+        self.log.info(\"Check legit node_work transactions still work too (%s)\" % (txid))\n         time.sleep(25)\n-        assert_equal(self.peerinfo_interesting(node_miss), (1, 100, 1))\n+        assert_equal(self.peerinfo_interesting(node_miss), (2, 0, 0))\n         assert_equal(self.peerinfo_interesting(node_work), (202, 0, 0))\n \n if __name__ == '__main__':"
      }
    ]
  },
  {
    "sha": "595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1OTViMDQwMmE1Zjg5YmRhM2I5YTc4MDVlZTBhYzI4NWVjN2ZlNTc5",
    "commit": {
      "author": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-10T05:38:08Z"
      },
      "committer": {
        "name": "Anthony Towns",
        "email": "aj@erisian.com.au",
        "date": "2019-04-17T05:12:01Z"
      },
      "message": "Disconnect from outbound peers with in_flight tx backlog",
      "tree": {
        "sha": "b937da206297c40990fd8d301d4d6c84c2c7d01a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b937da206297c40990fd8d301d4d6c84c2c7d01a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/595b0402a5f89bda3b9a7805ee0ac285ec7fe579/comments",
    "author": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "ajtowns",
      "id": 127186,
      "node_id": "MDQ6VXNlcjEyNzE4Ng==",
      "avatar_url": "https://avatars.githubusercontent.com/u/127186?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/ajtowns",
      "html_url": "https://github.com/ajtowns",
      "followers_url": "https://api.github.com/users/ajtowns/followers",
      "following_url": "https://api.github.com/users/ajtowns/following{/other_user}",
      "gists_url": "https://api.github.com/users/ajtowns/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/ajtowns/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/ajtowns/subscriptions",
      "organizations_url": "https://api.github.com/users/ajtowns/orgs",
      "repos_url": "https://api.github.com/users/ajtowns/repos",
      "events_url": "https://api.github.com/users/ajtowns/events{/privacy}",
      "received_events_url": "https://api.github.com/users/ajtowns/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e96932fd7e9b45b077529e707e253114f56180c8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e96932fd7e9b45b077529e707e253114f56180c8",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e96932fd7e9b45b077529e707e253114f56180c8"
      }
    ],
    "stats": {
      "total": 17,
      "additions": 13,
      "deletions": 4
    },
    "files": [
      {
        "sha": "0572d9c849fabc6ffccb85388a65e58f04e3bd15",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 0,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/595b0402a5f89bda3b9a7805ee0ac285ec7fe579/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/595b0402a5f89bda3b9a7805ee0ac285ec7fe579/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
        "patch": "@@ -72,6 +72,8 @@ static constexpr int32_t MAX_PEER_TX_ANNOUNCEMENTS = 2 * MAX_INV_SZ;\n static constexpr int64_t INBOUND_PEER_TX_DELAY = 2 * 1000000;\n /** How long to wait (in microseconds) before downloading a transaction from an additional peer */\n static constexpr int64_t GETDATA_TX_INTERVAL = 60 * 1000000;\n+/** How long (in microseconds) to allow a tx getdata to lag due to a full in_flight queue before considering peer non-viable */\n+static constexpr int64_t GETDATA_TX_TIMEOUT = 30 * 60 * 1000000;\n /** Maximum delay (in microseconds) for transaction requests to avoid biasing some peers over others. */\n static constexpr int64_t MAX_GETDATA_RANDOM_DELAY = 2 * 1000000;\n static_assert(INBOUND_PEER_TX_DELAY >= MAX_GETDATA_RANDOM_DELAY,\n@@ -3367,6 +3369,14 @@ void PeerLogicValidation::ConsiderEviction(CNode *pto, int64_t time_in_seconds)\n             }\n         }\n     }\n+\n+    const auto& tx_download = state.m_tx_download;\n+    if (tx_download.m_tx_in_flight.size() >= MAX_PEER_TX_IN_FLIGHT) {\n+        if (!tx_download.m_tx_process_time.empty() && (tx_download.m_tx_process_time.begin()->first + GETDATA_TX_TIMEOUT) <= time_in_seconds * 1000000) {\n+            LogPrintf(\"Disconnecting outbound peer %d due to tx request backlog (%d inflight, %d queued)\\n\", pto->GetId(), tx_download.m_tx_in_flight.size(), tx_download.m_tx_process_time.size());\n+            pto->fDisconnect = true;\n+        }\n+    }\n }\n \n void PeerLogicValidation::EvictExtraOutboundPeers(int64_t time_in_seconds)"
      },
      {
        "sha": "e61671d5e12c879b27e3699781a7f29fb1d7fa15",
        "filename": "test/functional/p2p_getdata_ignore.py",
        "status": "modified",
        "additions": 3,
        "deletions": 4,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/595b0402a5f89bda3b9a7805ee0ac285ec7fe579/test/functional/p2p_getdata_ignore.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/595b0402a5f89bda3b9a7805ee0ac285ec7fe579/test/functional/p2p_getdata_ignore.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/p2p_getdata_ignore.py?ref=595b0402a5f89bda3b9a7805ee0ac285ec7fe579",
        "patch": "@@ -107,13 +107,12 @@ def run_test(self):\n         assert_equal(len(node.p2p.getdata_requests), 0)\n         assert_equal(node.getpeerinfo()[0][\"tx_process\"], 60)\n \n-        self.log.info(\"Have 80 unasked-for transactions queued at 32min...\")\n+        self.log.info(\"After 30 minutes, have disconnected\")\n         node.setmocktime(mt+32*60)\n-        self.p2p_withheld_tx(20)\n+        time.sleep(1)\n         assert_equal(len(node.p2p.getdata_requests), 0)\n-        assert_equal(node.getpeerinfo()[0][\"tx_process\"], 80)\n         assert_equal(0, node.getmempoolinfo()['size'])  # Mempool should be empty\n-        assert_equal(1, len(node.getpeerinfo()))  # still connected\n+        assert_equal(0, len(node.getpeerinfo()))  # disconnected\n \n if __name__ == '__main__':\n     InvalidTxRequestTest().main()"
      }
    ]
  }
]