jtimon,2016-07-14T11:26:46Z,Actually I'm copying/re-writing things from that branch to https://github.com/jtimon/bitcoin/tree/0.12.99-consensus (which contains #8328 #8329 and #8337 ).\nI really think we should try to work on a common base...\n,https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232638729,232638729,
NicolasDorier,2016-07-14T11:44:03Z,"Thanks @jtimon, it is actually moving very fast now, I'll try to consolidate with the same base a you when the dust in my code will settle. For now I'll fix the pow you just told. How did you do for the logging ? with CValidationState I see you just remove the ""error"" methods ? (I really don't like the ""Logger"" abstraction, but I don't want to remove features either :()\n\nAlso I broke the consens",https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232642369,232642369,
jtimon,2016-07-14T11:50:44Z,"> How did you do for the logging ? \n\nhttps://github.com/bitcoin/bitcoin/pull/8339#discussion_r70789717\n\n> with CValidationState I see you just remove the ""error"" methods ?\n\nLook again to the PR I link you, the messages aren't lost.\n\n> Also I broke the consensus somewhere :p\n\nMaybe in https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70790789 ?\n",https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232643639,232643639,
NicolasDorier,2016-07-14T11:56:39Z,Awesome I'll cherry pick your commit and remove my logger.\n\nEDIT: ho I need to do it for the new methods :(\n,https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232644864,232644864,
NicolasDorier,2016-07-14T11:57:05Z,"the consensus break in the time-too-old rule. (block too early)\n\nEDIT: Found the culprit, in TestValidityBlock I was not using prevIndex for calculating the context.\n",https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232644956,232644956,
NicolasDorier,2016-07-14T12:14:23Z,"@jtimon if I understand well https://github.com/bitcoin/bitcoin/pull/7287/files actually I only need to remove error and pass ""false"" to DoS/Invalid ValidationState methods right? Since you are already printing out stuff in the caller ?\n",https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232648713,232648713,
jtimon,2016-07-14T12:59:44Z,"You need to make sure you print from all callers, yes.\nYou replace the error(""my message"") with false, yes, but also, at the end, you add ''', false, ""my message"""""" so that you don't lose the longer message.\n",https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232658250,232658250,
NicolasDorier,2016-07-14T16:31:44Z,@jtimon https://github.com/NicolasDorier/bitcoin/commit/53f677b8240f4eb40803885473ddbc5a51991dd2 might be useful (independant commit which remove error from contextualcheckblockheader)\n,https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232718854,232718854,
NicolasDorier,2016-07-15T03:08:57Z,"Yes, I just created https://github.com/bitcoin/bitcoin/pull/8341 with the reference of the two callers. (they already have error calls)\n",https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-232849508,232849508,
fanquake,2017-01-12T13:18:48Z,Closing this for now due to inactivity. @NicolasDorier feel free to reopen if your continuing this work.,https://github.com/bitcoin/bitcoin/pull/8339#issuecomment-272160898,272160898,
jtimon,2016-07-14T11:27:43Z,"Do you plan to move GetContextInfo() to libconsensus ? If not, please don't move consensus critical code out of consensus critical functions.\n",https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70789246,70789246,src/main.cpp
jtimon,2016-07-14T11:32:07Z,"There's no logging needed in libconsensus, CValidationState should be enough, see https://github.com/bitcoin/bitcoin/pull/7287/files\n",https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70789717,70789717,src/main.cpp
jtimon,2016-07-14T11:33:59Z,"If we're not going to try to move the code to the same files, can you please at least use the consensus directory instead of the script one?\n",https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70789905,70789905,src/script/blockvalidator.cpp
jtimon,2016-07-14T11:37:31Z,"pow is already a file containing only consensus code and ready for becoming part of the consensus module/package (see makefile) except for its CBlockIndex dependency. Just call CheckProofOfWork from the other consensus code directly, it's ok to include pow.h \n",https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70790303,70790303,src/pow.cpp
jtimon,2016-07-14T11:39:17Z,As discussed the consensusFlags struct seems to just cause unnecessary disruption with no apparent benefit.\n,https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70790687,70790687,src/main.cpp
jtimon,2016-07-14T11:40:30Z,aren't you changing functionality here?\n,https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70790789,70790789,src/main.cpp
NicolasDorier,2016-07-14T11:45:48Z,"I noticed that the consensus code only depends on the current majorityVersion. So I'm calculating the majorityVersion outside consensus, and I make the check inside. I've not found a better solution for now.\n",https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70791378,70791378,src/main.cpp
NicolasDorier,2016-07-14T11:48:33Z,"no, where it is used, pindex points to the block. (I ran the tests after this change, worked fine)\n",https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70791621,70791621,src/main.cpp
NicolasDorier,2016-07-14T11:49:14Z,"Agree, I'll fix that at the end.\n",https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70791693,70791693,src/main.cpp
NicolasDorier,2016-07-14T14:29:21Z,"@jtimon actually, it is not ok, pow is not part of consensus (some methods are linked to CBlockIndex)\n",https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70815431,70815431,src/pow.cpp
jtimon,2016-07-14T23:16:44Z,"then we should remove the undesired dependencies.\n\nOn Thu, Jul 14, 2016 at 4:30 PM, Nicolas Dorier notifications@github.com\nwrote:\n\n> In src/pow.cpp\n> https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70815431:\n> \n> > @@ -73,22 +73,3 @@ unsigned int CalculateNextWorkRequired(const CBlockIndex\* pindexLast, int64_t nF\n> > \n> > ```\n> >  return bnNew.GetCompact();\n> > ```\n> > \n> ",https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70900392,70900392,src/pow.cpp
NicolasDorier,2016-07-15T10:01:13Z,"Ultimately I agree, however it means we need either to put CBlockIndex as part of consensuslib or making a stripped type representing it in consensuslib.\n\nBut it involves lots of refactoring that I don't need it for my VerifyBlock / VerifyTx so I won't do it for now. I'll maybe include nextWorkRequired as field in CConsensusContextInfo and calculated in GetContextualInfo() though.\n",https://github.com/bitcoin/bitcoin/pull/8339#discussion_r70949498,70949498,src/pow.cpp
