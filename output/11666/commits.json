[
  {
    "sha": "5da5e788c8cff3a71dbac956e7bdb1174c5e7626",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1ZGE1ZTc4OGM4Y2ZmM2E3MWRiYWM5NTZlN2JkYjExNzRjNWU3NjI2",
    "commit": {
      "author": {
        "name": "NicolasDorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2017-11-10T09:51:07Z"
      },
      "committer": {
        "name": "nicolas.dorier",
        "email": "nicolas.dorier@gmail.com",
        "date": "2017-11-20T10:15:49Z"
      },
      "message": "[RPC] Add utility signinput",
      "tree": {
        "sha": "64e2c385d79de00e54bbf12f6c12e3a06a191bd7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/64e2c385d79de00e54bbf12f6c12e3a06a191bd7"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5da5e788c8cff3a71dbac956e7bdb1174c5e7626",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5da5e788c8cff3a71dbac956e7bdb1174c5e7626",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/5da5e788c8cff3a71dbac956e7bdb1174c5e7626",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/comments",
    "author": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "NicolasDorier",
      "id": 3020646,
      "node_id": "MDQ6VXNlcjMwMjA2NDY=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3020646?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/NicolasDorier",
      "html_url": "https://github.com/NicolasDorier",
      "followers_url": "https://api.github.com/users/NicolasDorier/followers",
      "following_url": "https://api.github.com/users/NicolasDorier/following{/other_user}",
      "gists_url": "https://api.github.com/users/NicolasDorier/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/NicolasDorier/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/NicolasDorier/subscriptions",
      "organizations_url": "https://api.github.com/users/NicolasDorier/orgs",
      "repos_url": "https://api.github.com/users/NicolasDorier/repos",
      "events_url": "https://api.github.com/users/NicolasDorier/events{/privacy}",
      "received_events_url": "https://api.github.com/users/NicolasDorier/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6e4e98ee8ce2da3cca2e2fd210e9e8dbc9b1c936",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6e4e98ee8ce2da3cca2e2fd210e9e8dbc9b1c936",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6e4e98ee8ce2da3cca2e2fd210e9e8dbc9b1c936"
      }
    ],
    "stats": {
      "total": 195,
      "additions": 182,
      "deletions": 13
    },
    "files": [
      {
        "sha": "5f34ca5f80a0935c2c3bcedfea5d679d6e503b38",
        "filename": "src/rpc/client.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/src/rpc/client.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/src/rpc/client.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/client.cpp?ref=5da5e788c8cff3a71dbac956e7bdb1174c5e7626",
        "patch": "@@ -66,6 +66,8 @@ static const CRPCConvertParam vRPCConvertParams[] =\n     { \"listaccounts\", 1, \"include_watchonly\" },\n     { \"walletpassphrase\", 1, \"timeout\" },\n     { \"getblocktemplate\", 0, \"template_request\" },\n+    { \"signinput\", 2, \"amount\" },\n+    { \"signinput\", 4, \"inputindex\" },\n     { \"listsinceblock\", 1, \"target_confirmations\" },\n     { \"listsinceblock\", 2, \"include_watchonly\" },\n     { \"listsinceblock\", 3, \"include_removed\" },"
      },
      {
        "sha": "94c86e11c2a8bc9aa439590f1d3b58a3948d4171",
        "filename": "src/rpc/misc.cpp",
        "status": "modified",
        "additions": 84,
        "deletions": 0,
        "changes": 84,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/src/rpc/misc.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/src/rpc/misc.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/misc.cpp?ref=5da5e788c8cff3a71dbac956e7bdb1174c5e7626",
        "patch": "@@ -320,6 +320,89 @@ UniValue createmultisig(const JSONRPCRequest& request)\n     return result;\n }\n \n+UniValue signinput(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() < 6 || request.params.size() > 7)\n+        throw std::runtime_error(\n+            \"signinput \\\"tx\\\" \\\"scriptcode\\\" amount \\\"sigversion\\\" inputindex \\\"privatekey\\\" (\\\"sighashtype\\\")\\n\"\n+            \"\\nCreate the a valid signature for the given input\\n\"\n+\n+            \"\\nArguments:\\n\"\n+            \"1. \\\"tx\\\"                 (string, required) The transaction hex string\\n\"\n+            \"2. \\\"scriptcode\\\"         (string, required) The scriptCode to sign\\n\"\n+            \"3. \\\"amount\\\"             (numeric, required) The amount spent in satoshi\\n\"\n+            \"4. \\\"sigversion\\\"         (string, required) The signature version\\n\"\n+            \"       \\\"BASE\\\"\\n\"\n+            \"       \\\"WITNESS_V0\\\"\\n\"\n+            \"5. inputindex             (numeric, required) The index of the input to sign\\n\"\n+            \"6. \\\"privatekey\\\"         (string, required) Private key in base58-encoding\\n\"\n+            \"7. \\\"sighashtype\\\"        (string, optional, default=ALL) The signature hash type. Must be one of\\n\"\n+            \"       \\\"ALL\\\"\\n\"\n+            \"       \\\"NONE\\\"\\n\"\n+            \"       \\\"SINGLE\\\"\\n\"\n+            \"       \\\"ALL|ANYONECANPAY\\\"\\n\"\n+            \"       \\\"NONE|ANYONECANPAY\\\"\\n\"\n+            \"       \\\"SINGLE|ANYONECANPAY\\\"\\n\"\n+            \"\\nResult:\\n\"\n+            \"\\\"signature\\\"             (string) hex string of the signature\\n\"\n+\n+            \"\\nExamples:\\n\"\n+            + HelpExampleCli(\"signinput\", \"\\\"txhex\\\" \\\"scriptcode\\\" \\\"0.01\\\" \\\"WITNESS_V0\\\" 1 \\\"privateKey\\\" \\\"SINGLE\\\"\")\n+            + HelpExampleRpc(\"signinput\", \"\\\"txhex\\\" \\\"scriptcode\\\" \\\"0.01\\\" \\\"WITNESS_V0\\\" 1 \\\"privateKey\\\" \\\"SINGLE\\\"\")\n+        );\n+\n+    RPCTypeCheck(request.params,\n+    {\n+        UniValue::VSTR, // tx\n+        UniValue::VSTR, // scriptCode\n+        UniValue::VNUM, // amount\n+        UniValue::VSTR, // sigVersion\n+        UniValue::VNUM, // inputIndex\n+        UniValue::VSTR  // privatekey\n+    }, false);\n+\n+    CMutableTransaction mtx;\n+    if (!DecodeHexTx(mtx, request.params[0].get_str(), true))\n+    {\n+        throw JSONRPCError(RPC_DESERIALIZATION_ERROR, \"TX decode failed\");\n+    }\n+\n+    std::vector<unsigned char> scriptCodeData(ParseHexV(request.params[1], \"scriptCode\"));\n+    CScript scriptCode(scriptCodeData.begin(), scriptCodeData.end());\n+\n+    CAmount amount = request.params[2].get_int64();\n+    if (!MoneyRange(amount))\n+        throw JSONRPCError(RPC_TYPE_ERROR, \"Amount out of range\");\n+    SigVersion sigVersion;\n+    static std::map<std::string, SigVersion> mapSigVersionValues = {\n+        { std::string(\"BASE\"), SigVersion::SIGVERSION_BASE },\n+        { std::string(\"WITNESS_V0\"), SigVersion::SIGVERSION_WITNESS_V0 },\n+    };\n+    std::string strHashType = request.params[3].get_str();\n+    if (mapSigVersionValues.count(strHashType))\n+        sigVersion = mapSigVersionValues[strHashType];\n+    else\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid sigversion param\");\n+\n+    int inputIndex = request.params[4].get_int();\n+\n+    CBitcoinSecret secret;\n+    if (!secret.SetString(request.params[5].get_str()))\n+        throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid private key\");\n+\n+    int nHashType = SIGHASH_ALL;\n+    if (!request.params[6].isNull()) {\n+        nHashType = ParseSigHash(request.params[6].get_str(), \"sighashtype\");\n+    }\n+    std::vector<unsigned char> signature;\n+    if (!secret.GetKey().Sign(SignatureHash(scriptCode, mtx, inputIndex, nHashType, amount, sigVersion), signature))\n+    {\n+        throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Private key outside allowed range\");\n+    }\n+    signature.push_back(static_cast<unsigned char>(nHashType));\n+    return HexStr(signature.begin(), signature.end());\n+}\n+\n UniValue verifymessage(const JSONRPCRequest& request)\n {\n     if (request.fHelp || request.params.size() != 3)\n@@ -611,6 +694,7 @@ static const CRPCCommand commands[] =\n     { \"control\",            \"logging\",                &logging,                {\"include\", \"exclude\"}},\n     { \"util\",               \"validateaddress\",        &validateaddress,        {\"address\"} }, /* uses wallet if enabled */\n     { \"util\",               \"createmultisig\",         &createmultisig,         {\"nrequired\",\"keys\"} },\n+    { \"util\",               \"signinput\",       &signinput,                     { \"tx\", \"scriptcode\", \"amount\", \"sigversion\", \"inputindex\", \"privatekey\", \"sighashtype\" } },\n     { \"util\",               \"verifymessage\",          &verifymessage,          {\"address\",\"signature\",\"message\"} },\n     { \"util\",               \"signmessagewithprivkey\", &signmessagewithprivkey, {\"privkey\",\"message\"} },\n "
      },
      {
        "sha": "3b007734a0ed88aecd8bee36b94471627c405f84",
        "filename": "src/rpc/rawtransaction.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 13,
        "changes": 14,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/src/rpc/rawtransaction.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/src/rpc/rawtransaction.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/rawtransaction.cpp?ref=5da5e788c8cff3a71dbac956e7bdb1174c5e7626",
        "patch": "@@ -829,19 +829,7 @@ UniValue signrawtransaction(const JSONRPCRequest& request)\n \n     int nHashType = SIGHASH_ALL;\n     if (!request.params[3].isNull()) {\n-        static std::map<std::string, int> mapSigHashValues = {\n-            {std::string(\"ALL\"), int(SIGHASH_ALL)},\n-            {std::string(\"ALL|ANYONECANPAY\"), int(SIGHASH_ALL|SIGHASH_ANYONECANPAY)},\n-            {std::string(\"NONE\"), int(SIGHASH_NONE)},\n-            {std::string(\"NONE|ANYONECANPAY\"), int(SIGHASH_NONE|SIGHASH_ANYONECANPAY)},\n-            {std::string(\"SINGLE\"), int(SIGHASH_SINGLE)},\n-            {std::string(\"SINGLE|ANYONECANPAY\"), int(SIGHASH_SINGLE|SIGHASH_ANYONECANPAY)},\n-        };\n-        std::string strHashType = request.params[3].get_str();\n-        if (mapSigHashValues.count(strHashType))\n-            nHashType = mapSigHashValues[strHashType];\n-        else\n-            throw JSONRPCError(RPC_INVALID_PARAMETER, \"Invalid sighash param\");\n+        nHashType = ParseSigHash(request.params[3].get_str(), \"sighashtype\");\n     }\n \n     bool fHashSingle = ((nHashType & ~SIGHASH_ANYONECANPAY) == SIGHASH_SINGLE);"
      },
      {
        "sha": "7d62960a585cb97eb7d82d7479b93623282f6f15",
        "filename": "src/rpc/server.cpp",
        "status": "modified",
        "additions": 17,
        "deletions": 0,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/src/rpc/server.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/src/rpc/server.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/server.cpp?ref=5da5e788c8cff3a71dbac956e7bdb1174c5e7626",
        "patch": "@@ -131,6 +131,23 @@ uint256 ParseHashV(const UniValue& v, std::string strName)\n     result.SetHex(strHex);\n     return result;\n }\n+\n+int ParseSigHash(const std::string& sighash, const std::string& parameter_name)\n+{\n+    int nHashType = 0;\n+    static const std::map<std::string, int> sighash_values = {\n+        { std::string(\"ALL\"), int(SIGHASH_ALL) },\n+        { std::string(\"ALL|ANYONECANPAY\"), int(SIGHASH_ALL | SIGHASH_ANYONECANPAY) },\n+        { std::string(\"NONE\"), int(SIGHASH_NONE) },\n+        { std::string(\"NONE|ANYONECANPAY\"), int(SIGHASH_NONE | SIGHASH_ANYONECANPAY) },\n+        { std::string(\"SINGLE\"), int(SIGHASH_SINGLE) },\n+        { std::string(\"SINGLE|ANYONECANPAY\"), int(SIGHASH_SINGLE | SIGHASH_ANYONECANPAY) },\n+    };\n+    auto it = sighash_values.find(sighash);\n+    if (it == sighash_values.end()) throw JSONRPCError(RPC_INVALID_PARAMETER, strprintf(\"Invalid %s param\", parameter_name));\n+    return (*it).second;\n+}\n+\n uint256 ParseHashO(const UniValue& o, std::string strKey)\n {\n     return ParseHashV(find_value(o, strKey), strKey);"
      },
      {
        "sha": "88d2a8c43aa20785fbc304adde320d75daec03c2",
        "filename": "src/rpc/server.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/src/rpc/server.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/src/rpc/server.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/server.h?ref=5da5e788c8cff3a71dbac956e7bdb1174c5e7626",
        "patch": "@@ -184,6 +184,7 @@ extern uint256 ParseHashO(const UniValue& o, std::string strKey);\n extern std::vector<unsigned char> ParseHexV(const UniValue& v, std::string strName);\n extern std::vector<unsigned char> ParseHexO(const UniValue& o, std::string strKey);\n \n+extern int ParseSigHash(const std::string& sighash, const std::string& parameter_name);\n extern CAmount AmountFromValue(const UniValue& value);\n extern std::string HelpExampleCli(const std::string& methodname, const std::string& args);\n extern std::string HelpExampleRpc(const std::string& methodname, const std::string& args);"
      },
      {
        "sha": "830027e33941c199cd8ad2b4d72f8183ea8b8e7f",
        "filename": "test/functional/signinput.py",
        "status": "added",
        "additions": 76,
        "deletions": 0,
        "changes": 76,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/test/functional/signinput.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/test/functional/signinput.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/signinput.py?ref=5da5e788c8cff3a71dbac956e7bdb1174c5e7626",
        "patch": "@@ -0,0 +1,76 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2017 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\"\"\"Test the RPC call related to the uptime command.\n+\n+Test corresponds to code in rpc/server.cpp.\n+\"\"\"\n+\n+import time\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+\n+class SignInputTest(BitcoinTestFramework):\n+    def set_test_params(self):\n+        self.num_nodes = 1\n+        self.setup_clean_chain = True\n+\n+    def run_test(self):\n+        privatekey = \"cPbVfYM4UUuxKeJUotfq791Z36QN8br9yyAi61JghziH6LDgiqWF\"\n+        tx = \"010000000243ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d200000000844730440220449a203d0062ea01022f565c94c4b62bf2cc9a05de20519bc18cded9e99aa5f702201a2b8361e2af179eb93e697d9fedd0bf1e036f0a5be39af4b1f791df803bdb6501210363e38e2e0e55cdebfb7e27d0cb53ded150c320564a4614c18738feb124c8efd21976a9141a5fdcb6201f7e4fd160f9dca81075bd8537526088acffffffff43ec7a579f5561a42a7e9637ad4156672735a658be2752181801f723ba3316d20100000085483045022100ff6e7edffa5e0758244af6af77edd14f1d80226d66f81ed58dba2def34778236022057d95177497758e467c194f0d897f175645d30e7ac2f9490247e13227ac4d2fc01210363e38e2e0e55cdebfb7e27d0cb53ded150c320564a4614c18738feb124c8efd21976a9141a5fdcb6201f7e4fd160f9dca81075bd8537526088acffffffff0100752b7d000000001976a9141a5fdcb6201f7e4fd160f9dca81075bd8537526088ac00000000\"\n+        scriptcode = \"76a9141a5fdcb6201f7e4fd160f9dca81075bd8537526088ac\"\n+        amount = 100000000\n+        sigversion = \"BASE\"\n+        input_index = 0\n+        sighash = \"ALL\"\n+        expected_sig = \"3045022100cc79eb5596db1e5cf48acf67dd67626110698d4c504995ae00dd421edc721f91022053b5f23c1808b4a22e6364deed5eceda8967d1d3af2d2c7edf4727f1d1a4df6501\"\n+        assert_equal(expected_sig, self.nodes[0].signinput(\n+            tx,\n+            scriptcode,\n+            amount,\n+            sigversion,\n+            input_index,\n+            privatekey,\n+            sighash\n+        ))\n+\n+        # optional parameter\n+        assert_equal(expected_sig, self.nodes[0].signinput(\n+            tx,\n+            scriptcode,\n+            amount,\n+            sigversion,\n+            input_index,\n+            privatekey\n+        ))\n+\n+        # WITNESS_0\n+        sigversion = \"WITNESS_V0\"\n+        expected_sig = \"304402207618e6c93582612b25024cab7a6b3a0ce0a4389f0ee81cc6a8efb9345a47df2402205a15ba66ea375e25fcd9758453c14d7596d59eae5702a339f2c3f793c68f1a9801\"\n+        assert_equal(expected_sig, self.nodes[0].signinput(\n+            tx,\n+            scriptcode,\n+            amount,\n+            sigversion,\n+            input_index,\n+            privatekey\n+        ))\n+\n+        # WITNESS_0/SINGLE\n+        sigversion = \"WITNESS_V0\"\n+        sighash = \"SINGLE\"\n+        expected_sig = \"3044022053a587a195c93b4d0816e03aa7922e010d64f08fdadf1d69ec5589e0163ff30002207daf9b3ca2b5fb3c584ef8e91e1e5e42d3b16fbb87fcdbf59be6462421f4bac003\"\n+        assert_equal(expected_sig, self.nodes[0].signinput(\n+            tx,\n+            scriptcode,\n+            amount,\n+            sigversion,\n+            input_index,\n+            privatekey,\n+            sighash\n+        ))\n+\n+if __name__ == '__main__':\n+    SignInputTest().main()"
      },
      {
        "sha": "799bbc2adfb8e9b0ae284d9c080080c8b790da76",
        "filename": "test/functional/test_runner.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/test/functional/test_runner.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5da5e788c8cff3a71dbac956e7bdb1174c5e7626/test/functional/test_runner.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/test_runner.py?ref=5da5e788c8cff3a71dbac956e7bdb1174c5e7626",
        "patch": "@@ -126,6 +126,7 @@\n     'p2p-fingerprint.py',\n     'uacomment.py',\n     'p2p-acceptblock.py',\n+    'signinput.py',\n ]\n \n EXTENDED_SCRIPTS = ["
      }
    ]
  }
]