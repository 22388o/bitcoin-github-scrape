[
  {
    "sha": "6d1f51343cf11b07cd401fbd0c5bc3603e185a0e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2ZDFmNTEzNDNjZjExYjA3Y2Q0MDFmYmQwYzViYzM2MDNlMTg1YTBl",
    "commit": {
      "author": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2020-08-07T11:53:51Z"
      },
      "committer": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2020-08-07T12:13:15Z"
      },
      "message": "[rpc] fundrawtransaction, walletcreatefundedpsbt lock manually selected coins\n\nPreviously only automatically selected coins were locked when lockUnspents is set.\nIt now also locks selected coins.",
      "tree": {
        "sha": "4c7b2379cffe5e1617f298fc9ea8e0d9adc1c6f4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4c7b2379cffe5e1617f298fc9ea8e0d9adc1c6f4"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEE7ZvfetalXiMuhFJCV/+b28wwEAkFAl8tRV0ACgkQV/+b28ww\nEAkdQw/8CjW+QylWX68vZM2o58BGFLUjJnGbgkvfzLGf/sXJhWzOZH6nely0V1gL\nj6biE8+aU+5eZ4JJaI6hmNOujQ1Nrncv5jbMwasAX0yyY1OZcyYexI4LwSJhTnys\npn7nieXpuKV3NZ0JkOVpBt4VP1vQKspPD7/9IQ2l89q1Tpb666KO5l+7fctmrLh9\nRc1vy5nE0940TY0rPGkiu12QxBkHelC5IJIhJ8GN8Fd7f3W8FfVymu9ItT5lnXYq\nf2XhdRVLr5GkJ0ORflD/duSsnh57lj3M+q6ocd3VzfnVR7BXkz6Bb+w8Sm0CgeHR\nigPv+PPh8HNmMHK5s+zbhTf/sXszdJCvriBy6G93Phj5Yx/goHlyHv027tcPSmNF\nBRvg+ypM2ezTW3nUml6ZIpK0hDdizqZGKz03oC2OVyR/YhZiDcb9zcWGGnpSprri\nNwS9/0ZYZURh8HzPPUFIPdprOyfALth+e7c9+h3H7A94xfcaxIxC3h93ufwVtMBp\nYjvkE49BFtkx2JVh9SgkCLKgghvRlfN3eL9sd4JZktNsXZ+xVegyv7nWeMBPNIEp\nD3SMs5IwgJq8Lc0VbwJf+4VOtcVJ7pZGoocogNYifV6KyyzgkKin71M9z3Z/fHOb\n+VosAB6eJkBtnFIZ3aPA4JTaEBXeSgIhe2G39A81TDaYOnWTzKY=\n=db/Y\n-----END PGP SIGNATURE-----",
        "payload": "tree 4c7b2379cffe5e1617f298fc9ea8e0d9adc1c6f4\nparent 4b705b1c98f60ab736df98d62a8d4988f61678d5\nauthor Sjors Provoost <sjors@sprovoost.nl> 1596801231 +0200\ncommitter Sjors Provoost <sjors@sprovoost.nl> 1596802395 +0200\n\n[rpc] fundrawtransaction, walletcreatefundedpsbt lock manually selected coins\n\nPreviously only automatically selected coins were locked when lockUnspents is set.\nIt now also locks selected coins.\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e/comments",
    "author": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url": "https://api.github.com/users/Sjors/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url": "https://api.github.com/users/Sjors/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "4b705b1c98f60ab736df98d62a8d4988f61678d5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4b705b1c98f60ab736df98d62a8d4988f61678d5",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/4b705b1c98f60ab736df98d62a8d4988f61678d5"
      }
    ],
    "stats": {
      "total": 38,
      "additions": 32,
      "deletions": 6
    },
    "files": [
      {
        "sha": "625fbaf7a160b16bef02959eddfcd6ed7ebc5ad7",
        "filename": "doc/release-notes-18244.md",
        "status": "added",
        "additions": 7,
        "deletions": 0,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e/doc/release-notes-18244.md",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e/doc/release-notes-18244.md",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/doc/release-notes-18244.md?ref=6d1f51343cf11b07cd401fbd0c5bc3603e185a0e",
        "patch": "@@ -0,0 +1,7 @@\n+Updated RPCs\n+------------\n+\n+- `fundrawtransaction` and `walletcreatefundedpsbt` when used with the `lockUnspents`\n+   argument now lock manually selected coins, in addition to automatically selected\n+   coins. Note that locked coins are never used in automatic coin selection, but\n+   can still be manually selected."
      },
      {
        "sha": "cc7d6cbaf5c4620183c53e0f64c3881630efb061",
        "filename": "src/wallet/rpcwallet.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e/src/wallet/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e/src/wallet/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcwallet.cpp?ref=6d1f51343cf11b07cd401fbd0c5bc3603e185a0e",
        "patch": "@@ -2047,6 +2047,7 @@ static UniValue lockunspent(const JSONRPCRequest& request)\n                 \"Temporarily lock (unlock=false) or unlock (unlock=true) specified transaction outputs.\\n\"\n                 \"If no transaction outputs are specified when unlocking then all current locked transaction outputs are unlocked.\\n\"\n                 \"A locked transaction output will not be chosen by automatic coin selection, when spending bitcoins.\\n\"\n+                \"Manually selected coins are automatically unlocked.\\n\"\n                 \"Locks are stored in memory only. Nodes start with zero locked outputs, and the locked output list\\n\"\n                 \"is always cleared (by virtue of process exit) when a node stops or fails.\\n\"\n                 \"Also see the listunspent call\\n\","
      },
      {
        "sha": "2166373a72ddb6ddedd70ca8071450b65711f0e4",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 3,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=6d1f51343cf11b07cd401fbd0c5bc3603e185a0e",
        "patch": "@@ -2609,10 +2609,11 @@ bool CWallet::FundTransaction(CMutableTransaction& tx, CAmount& nFeeRet, int& nC\n         if (!coinControl.IsSelected(txin.prevout)) {\n             tx.vin.push_back(txin);\n \n-            if (lockUnspents) {\n-                LockCoin(txin.prevout);\n-            }\n         }\n+        if (lockUnspents) {\n+            LockCoin(txin.prevout);\n+        }\n+\n     }\n \n     return true;"
      },
      {
        "sha": "5d724e7cc764216c359eb2017aea901f9ee7e08f",
        "filename": "test/functional/rpc_psbt.py",
        "status": "modified",
        "additions": 10,
        "deletions": 1,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e/test/functional/rpc_psbt.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e/test/functional/rpc_psbt.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_psbt.py?ref=6d1f51343cf11b07cd401fbd0c5bc3603e185a0e",
        "patch": "@@ -103,7 +103,16 @@ def run_test(self):\n         final_tx = self.nodes[0].finalizepsbt(signed_tx)['hex']\n         self.nodes[0].sendrawtransaction(final_tx)\n \n-        # Get pubkeys\n+        # Manually selected inputs can be locked:\n+        assert_equal(len(self.nodes[0].listlockunspent()), 0)\n+        utxo1 = self.nodes[0].listunspent()[0]\n+        psbtx1 = self.nodes[0].walletcreatefundedpsbt([{\"txid\": utxo1['txid'], \"vout\": utxo1['vout']}], {self.nodes[2].getnewaddress():1}, 0,{\"lockUnspents\": True})[\"psbt\"]\n+        assert_equal(len(self.nodes[0].listlockunspent()), 1)\n+\n+        # Locks are ignored for manually selected inputs\n+        self.nodes[0].walletcreatefundedpsbt([{\"txid\": utxo1['txid'], \"vout\": utxo1['vout']}], {self.nodes[2].getnewaddress():1}, 0)\n+\n+        # Create p2sh, p2wpkh, and p2wsh addresses\n         pubkey0 = self.nodes[0].getaddressinfo(self.nodes[0].getnewaddress())['pubkey']\n         pubkey1 = self.nodes[1].getaddressinfo(self.nodes[1].getnewaddress())['pubkey']\n         pubkey2 = self.nodes[2].getaddressinfo(self.nodes[2].getnewaddress())['pubkey']"
      },
      {
        "sha": "7f891deabf31932ca0934bec564b6e832f7ed228",
        "filename": "test/functional/wallet_basic.py",
        "status": "modified",
        "additions": 10,
        "deletions": 2,
        "changes": 12,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e/test/functional/wallet_basic.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6d1f51343cf11b07cd401fbd0c5bc3603e185a0e/test/functional/wallet_basic.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/wallet_basic.py?ref=6d1f51343cf11b07cd401fbd0c5bc3603e185a0e",
        "patch": "@@ -136,11 +136,19 @@ def run_test(self):\n                                 self.nodes[2].lockunspent, False,\n                                 [{\"txid\": unspent_0[\"txid\"], \"vout\": 999}])\n \n-        # An output should be unlocked when spent\n+        # The lock on a manually selected output is ignored\n         unspent_0 = self.nodes[1].listunspent()[0]\n         self.nodes[1].lockunspent(False, [unspent_0])\n         tx = self.nodes[1].createrawtransaction([unspent_0], { self.nodes[1].getnewaddress() : 1 })\n-        tx = self.nodes[1].fundrawtransaction(tx)['hex']\n+        self.nodes[1].fundrawtransaction(tx,{\"lockUnspents\": True})\n+\n+        # fundrawtransaction can lock an input\n+        self.nodes[1].lockunspent(True, [unspent_0])\n+        assert_equal(len(self.nodes[1].listlockunspent()), 0)\n+        tx = self.nodes[1].fundrawtransaction(tx,{\"lockUnspents\": True})['hex']\n+        assert_equal(len(self.nodes[1].listlockunspent()), 1)\n+\n+        # Send transaction\n         tx = self.nodes[1].signrawtransactionwithwallet(tx)[\"hex\"]\n         self.nodes[1].sendrawtransaction(tx)\n         assert_equal(len(self.nodes[1].listlockunspent()), 0)"
      }
    ]
  }
]