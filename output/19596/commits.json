[
  {
    "sha": "81961762439fb72fc2ef168164689ddc29d7ef94",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4MTk2MTc2MjQzOWZiNzJmYzJlZjE2ODE2NDY4OWRkYzI5ZDdlZjk0",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-07-27T03:25:27Z"
      },
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-08-04T17:59:11Z"
      },
      "message": "Rewrite parent txid loop of requested transactions\n\nPreviously, we would potentially add the same txid many times to the rolling\nbloom filter of recently announced transactions to a peer, if many outputs of\nthe same txid appeared as inputs in a transaction. Eliminate this problem and\navoid redundant lookups by asking the mempool for the unique parents of a\nrequested transaction.",
      "tree": {
        "sha": "f9c8f801ce4e1652a88dab1e9aed982051303206",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f9c8f801ce4e1652a88dab1e9aed982051303206"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/81961762439fb72fc2ef168164689ddc29d7ef94",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/81961762439fb72fc2ef168164689ddc29d7ef94",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/81961762439fb72fc2ef168164689ddc29d7ef94",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/81961762439fb72fc2ef168164689ddc29d7ef94/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "0f16212c5931b30f430014caa485de53f9a14920",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0f16212c5931b30f430014caa485de53f9a14920",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/0f16212c5931b30f430014caa485de53f9a14920"
      }
    ],
    "stats": {
      "total": 25,
      "additions": 18,
      "deletions": 7
    },
    "files": [
      {
        "sha": "b52427d84ba773e9dc1695b5b56195fb98cc6572",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 18,
        "deletions": 7,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/81961762439fb72fc2ef168164689ddc29d7ef94/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/81961762439fb72fc2ef168164689ddc29d7ef94/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=81961762439fb72fc2ef168164689ddc29d7ef94",
        "patch": "@@ -1734,16 +1734,27 @@ void static ProcessGetData(CNode& pfrom, const CChainParams& chainparams, CConnm\n             connman.PushMessage(&pfrom, msgMaker.Make(nSendFlags, NetMsgType::TX, *tx));\n             mempool.RemoveUnbroadcastTx(tx->GetHash());\n             // As we're going to send tx, make sure its unconfirmed parents are made requestable.\n-            for (const auto& txin : tx->vin) {\n-                auto txinfo = mempool.info(txin.prevout.hash);\n-                if (txinfo.tx && txinfo.m_time > now - UNCONDITIONAL_RELAY_DELAY) {\n-                    // Relaying a transaction with a recent but unconfirmed parent.\n-                    if (WITH_LOCK(pfrom.m_tx_relay->cs_tx_inventory, return !pfrom.m_tx_relay->filterInventoryKnown.contains(txin.prevout.hash))) {\n-                        LOCK(cs_main);\n-                        State(pfrom.GetId())->m_recently_announced_invs.insert(txin.prevout.hash);\n+            std::vector<uint256> parent_ids_to_add;\n+            {\n+                LOCK(mempool.cs);\n+                auto txiter = mempool.GetIter(tx->GetHash());\n+                if (txiter) {\n+                    const CTxMemPool::setEntries& parents = mempool.GetMemPoolParents(*txiter);\n+                    parent_ids_to_add.reserve(parents.size());\n+                    for (CTxMemPool::txiter parent_iter : parents) {\n+                        if (parent_iter->GetTime() > now - UNCONDITIONAL_RELAY_DELAY) {\n+                            parent_ids_to_add.push_back(parent_iter->GetTx().GetHash());\n+                        }\n                     }\n                 }\n             }\n+            for (const uint256& parent_txid : parent_ids_to_add) {\n+                // Relaying a transaction with a recent but unconfirmed parent.\n+                if (WITH_LOCK(pfrom.m_tx_relay->cs_tx_inventory, return !pfrom.m_tx_relay->filterInventoryKnown.contains(parent_txid))) {\n+                    LOCK(cs_main);\n+                    State(pfrom.GetId())->m_recently_announced_invs.insert(parent_txid);\n+                }\n+            }\n         } else {\n             vNotFound.push_back(inv);\n         }"
      }
    ]
  },
  {
    "sha": "4c0731f9c50b0556f8a57b912c8f295c7a9ea89c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0YzA3MzFmOWM1MGIwNTU2ZjhhNTdiOTEyYzhmMjk1YzdhOWVhODlj",
    "commit": {
      "author": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-07-27T03:46:36Z"
      },
      "committer": {
        "name": "Suhas Daftuar",
        "email": "sdaftuar@gmail.com",
        "date": "2020-08-04T17:59:16Z"
      },
      "message": "Deduplicate missing parents of orphan transactions\n\nIn the logic for requesting missing parents of orphan transactions, parent\ntransactions with multiple outputs being spent by the given orphan were being\nprocessed multiple times. Fix this by deduplicating the set of missing parent\ntxids first.\n\nCo-authored-by: Anthony Towns <aj@erisian.com.au>",
      "tree": {
        "sha": "1b26d4871475286d0208ddc70214cb30c650c3d5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1b26d4871475286d0208ddc70214cb30c650c3d5"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4c0731f9c50b0556f8a57b912c8f295c7a9ea89c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4c0731f9c50b0556f8a57b912c8f295c7a9ea89c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/4c0731f9c50b0556f8a57b912c8f295c7a9ea89c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4c0731f9c50b0556f8a57b912c8f295c7a9ea89c/comments",
    "author": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sdaftuar",
      "id": 7463573,
      "node_id": "MDQ6VXNlcjc0NjM1NzM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7463573?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sdaftuar",
      "html_url": "https://github.com/sdaftuar",
      "followers_url": "https://api.github.com/users/sdaftuar/followers",
      "following_url": "https://api.github.com/users/sdaftuar/following{/other_user}",
      "gists_url": "https://api.github.com/users/sdaftuar/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sdaftuar/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sdaftuar/subscriptions",
      "organizations_url": "https://api.github.com/users/sdaftuar/orgs",
      "repos_url": "https://api.github.com/users/sdaftuar/repos",
      "events_url": "https://api.github.com/users/sdaftuar/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sdaftuar/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "81961762439fb72fc2ef168164689ddc29d7ef94",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/81961762439fb72fc2ef168164689ddc29d7ef94",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/81961762439fb72fc2ef168164689ddc29d7ef94"
      }
    ],
    "stats": {
      "total": 19,
      "additions": 15,
      "deletions": 4
    },
    "files": [
      {
        "sha": "2e724ad94812149a225b4b621e67e5e58a5ed23c",
        "filename": "src/net_processing.cpp",
        "status": "modified",
        "additions": 15,
        "deletions": 4,
        "changes": 19,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4c0731f9c50b0556f8a57b912c8f295c7a9ea89c/src/net_processing.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4c0731f9c50b0556f8a57b912c8f295c7a9ea89c/src/net_processing.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net_processing.cpp?ref=4c0731f9c50b0556f8a57b912c8f295c7a9ea89c",
        "patch": "@@ -2990,8 +2990,19 @@ void ProcessMessage(\n         else if (state.GetResult() == TxValidationResult::TX_MISSING_INPUTS)\n         {\n             bool fRejectedParents = false; // It may be the case that the orphans parents have all been rejected\n+\n+            // Deduplicate parent txids, so that we don't have to loop over\n+            // the same parent txid more than once down below.\n+            std::vector<uint256> unique_parents;\n+            unique_parents.reserve(tx.vin.size());\n             for (const CTxIn& txin : tx.vin) {\n-                if (recentRejects->contains(txin.prevout.hash)) {\n+                // We start with all parents, and then remove duplicates below.\n+                unique_parents.push_back(txin.prevout.hash);\n+            }\n+            std::sort(unique_parents.begin(), unique_parents.end());\n+            unique_parents.erase(std::unique(unique_parents.begin(), unique_parents.end()), unique_parents.end());\n+            for (const uint256& parent_txid : unique_parents) {\n+                if (recentRejects->contains(parent_txid)) {\n                     fRejectedParents = true;\n                     break;\n                 }\n@@ -3000,14 +3011,14 @@ void ProcessMessage(\n                 uint32_t nFetchFlags = GetFetchFlags(pfrom);\n                 const auto current_time = GetTime<std::chrono::microseconds>();\n \n-                for (const CTxIn& txin : tx.vin) {\n+                for (const uint256& parent_txid : unique_parents) {\n                     // Here, we only have the txid (and not wtxid) of the\n                     // inputs, so we only request in txid mode, even for\n                     // wtxidrelay peers.\n                     // Eventually we should replace this with an improved\n                     // protocol for getting all unconfirmed parents.\n-                    CInv _inv(MSG_TX | nFetchFlags, txin.prevout.hash);\n-                    pfrom.AddKnownTx(txin.prevout.hash);\n+                    CInv _inv(MSG_TX | nFetchFlags, parent_txid);\n+                    pfrom.AddKnownTx(parent_txid);\n                     if (!AlreadyHave(_inv, mempool)) RequestTx(State(pfrom.GetId()), ToGenTxid(_inv), current_time);\n                 }\n                 AddOrphanTx(ptx, pfrom.GetId());"
      }
    ]
  }
]