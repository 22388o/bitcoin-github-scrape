[
  {
    "sha": "f277cf567fb9f3acf4430f68545316268f500ece",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmMjc3Y2Y1NjdmYjlmM2FjZjQ0MzBmNjg1NDUzMTYyNjhmNTAwZWNl",
    "commit": {
      "author": {
        "name": "Cozz Lovan",
        "email": "cozzlovan@yahoo.com",
        "date": "2014-10-05T20:30:01Z"
      },
      "committer": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2017-01-04T00:46:51Z"
      },
      "message": "txoutsbyaddress index",
      "tree": {
        "sha": "a8d728eaaa927013841e5229f79a37d21c33757b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a8d728eaaa927013841e5229f79a37d21c33757b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/f277cf567fb9f3acf4430f68545316268f500ece",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f277cf567fb9f3acf4430f68545316268f500ece",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/f277cf567fb9f3acf4430f68545316268f500ece",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f277cf567fb9f3acf4430f68545316268f500ece/comments",
    "author": {
      "login": "cozz",
      "id": 2814559,
      "node_id": "MDQ6VXNlcjI4MTQ1NTk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2814559?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/cozz",
      "html_url": "https://github.com/cozz",
      "followers_url": "https://api.github.com/users/cozz/followers",
      "following_url": "https://api.github.com/users/cozz/following{/other_user}",
      "gists_url": "https://api.github.com/users/cozz/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/cozz/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/cozz/subscriptions",
      "organizations_url": "https://api.github.com/users/cozz/orgs",
      "repos_url": "https://api.github.com/users/cozz/repos",
      "events_url": "https://api.github.com/users/cozz/events{/privacy}",
      "received_events_url": "https://api.github.com/users/cozz/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6dc4c43d326eeb86c33ca7257dd7165d8cd6fd0f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6dc4c43d326eeb86c33ca7257dd7165d8cd6fd0f",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6dc4c43d326eeb86c33ca7257dd7165d8cd6fd0f"
      }
    ],
    "stats": {
      "total": 1036,
      "additions": 952,
      "deletions": 84
    },
    "files": [
      {
        "sha": "40c21f77413b72d239ccfb481004e9a30aa09274",
        "filename": "qa/rpc-tests/txoutsbyaddress.sh",
        "status": "added",
        "additions": 163,
        "deletions": 0,
        "changes": 163,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/qa/rpc-tests/txoutsbyaddress.sh",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/qa/rpc-tests/txoutsbyaddress.sh",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/txoutsbyaddress.sh?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -0,0 +1,163 @@\n+#!/usr/bin/env bash\n+# Copyright (c) 2013-2014 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+# Test -txoutsbyaddressindex\n+\n+if [ $# -lt 1 ]; then\n+        echo \"Usage: $0 path_to_binaries\"\n+        echo \"e.g. $0 ../../src\"\n+        exit 1\n+fi\n+\n+set -f\n+\n+BITCOIND=${1}/bitcoind\n+CLI=${1}/bitcoin-cli\n+\n+DIR=\"${BASH_SOURCE%/*}\"\n+SENDANDWAIT=\"${DIR}/send.sh\"\n+if [[ ! -d \"$DIR\" ]]; then DIR=\"$PWD\"; fi\n+. \"$DIR/util.sh\"\n+\n+D=$(mktemp -d test.XXXXX)\n+\n+D1=${D}/node1\n+CreateDataDir \"$D1\" port=11000 rpcport=11001\n+B1ARGS=\"-datadir=$D1\"\n+$BITCOIND $B1ARGS -txoutsbyaddressindex -sendfreetransactions=1 &\n+B1PID=$!\n+\n+D2=${D}/node2\n+CreateDataDir \"$D2\" port=11010 rpcport=11011\n+B2ARGS=\"-datadir=$D2\"\n+$BITCOIND $B2ARGS -sendfreetransactions=1 &\n+B2PID=$!\n+\n+D3=${D}/node3\n+CreateDataDir \"$D3\" port=11020 rpcport=11021\n+B3ARGS=\"-datadir=$D3\"\n+$BITCOIND $B3ARGS -sendfreetransactions=1 &\n+B3PID=$!\n+\n+# Wait until all three nodes are at the same block number\n+function WaitBlocks {\n+    while :\n+    do\n+        sleep 1\n+        declare -i BLOCKS1=$( GetBlocks $B1ARGS )\n+        declare -i BLOCKS2=$( GetBlocks $B2ARGS )\n+        declare -i BLOCKS3=$( GetBlocks $B3ARGS )\n+        if (( BLOCKS1 == BLOCKS2 && BLOCKS2 == BLOCKS3 ))\n+        then\n+            break\n+        fi\n+    done\n+}\n+\n+function WaitBlocks2 {\n+    while :\n+    do\n+        sleep 1\n+        declare -i BLOCKS1=$( GetBlocks $B1ARGS )\n+        declare -i BLOCKS2=$( GetBlocks $B2ARGS )\n+        if (( BLOCKS1 == BLOCKS2 ))\n+        then\n+            break\n+        fi\n+    done\n+}\n+\n+function CleanUp {\n+$CLI $B3ARGS stop > /dev/null 2>&1\n+wait $B3PID\n+$CLI $B2ARGS stop > /dev/null 2>&1\n+wait $B2PID\n+$CLI $B1ARGS stop > /dev/null 2>&1\n+wait $B1PID\n+\n+rm -rf $D\n+}\n+\n+function ErrorAndExit {\n+echo \"$@\" 1>&2;\n+CleanUp\n+exit 1\n+}\n+\n+echo \"Generating test blockchain...\"\n+\n+# mining\n+$CLI $B2ARGS addnode \"127.0.0.1:11000\" \"onetry\"\n+$CLI $B3ARGS addnode \"127.0.0.1:11000\" \"onetry\"\n+$CLI $B1ARGS generate 101\n+WaitBlocks\n+CheckBalance \"$B1ARGS\" 50\n+\n+# TX1: send from node1 to node2\n+# - check if txout from tx1 is there\n+address=$($CLI $B2ARGS getnewaddress)\n+txid1=$($CLI $B1ARGS sendtoaddress $address 10)\n+$CLI $B1ARGS generate 1\n+WaitBlocks\n+CheckBalance \"$B1ARGS\" 90\n+CheckBalance \"$B2ARGS\" 10\n+txouts=$($CLI $B1ARGS gettxoutsbyaddress 1 \"[\\\"\"\"$address\"\"\\\"]\")\n+txid=$(ExtractKey \"txid\" \"$txouts\")\n+if [ -z \"$txid\" ] || [ $txid != $txid1 ] ; then\n+   ErrorAndExit \"wrong txid1: $txid != $txid1\"\n+fi\n+\n+# stop node 3\n+$CLI $B3ARGS stop > /dev/null 2>&1\n+wait $B3PID\n+\n+# TX2: send from node2 to node1\n+# - check if txout from tx1 is gone\n+# - check if txout from tx2 is there\n+address2=$($CLI $B1ARGS getnewaddress)\n+txid2=$($CLI $B2ARGS sendtoaddress $address2 5)\n+$CLI $B2ARGS generate 1\n+WaitBlocks2\n+CheckBalance \"$B1ARGS\" 145\n+txouts=$($CLI $B1ARGS gettxoutsbyaddress 1 \"[\\\"\"\"$address\"\"\\\"]\")\n+txid=$(ExtractKey \"txid\" \"$txouts\")\n+if [ ! -z \"$txid\" ] ; then\n+   ErrorAndExit \"txid not empty: $txid\"\n+fi\n+txouts=$($CLI $B1ARGS gettxoutsbyaddress 1 \"[\\\"\"\"$address2\"\"\\\"]\")\n+txid=$(ExtractKey \"txid\" \"$txouts\")\n+if [ -z \"$txid\" ] || [ $txid != $txid2 ] ; then\n+   ErrorAndExit \"wrong txid2: $txid != $txid2\"\n+fi\n+\n+# start node 3\n+$BITCOIND $B3ARGS &\n+B3PID=$!\n+\n+# mine 10 blocks alone to have the longest chain\n+$CLI $B3ARGS generate 10\n+$CLI $B1ARGS addnode \"127.0.0.1:11020\" \"onetry\"\n+$CLI $B2ARGS addnode \"127.0.0.1:11020\" \"onetry\"\n+$CLI $B3ARGS generate 1\n+WaitBlocks\n+\n+# TX2 must be reverted\n+# - check if txout from tx1 is there again\n+# - check if txout from tx2 is gone\n+CheckBalance \"$B1ARGS\" 640\n+txouts=$($CLI $B1ARGS gettxoutsbyaddress 1 \"[\\\"\"\"$address\"\"\\\"]\")\n+txid=$(ExtractKey \"txid\" \"$txouts\")\n+if [ -z \"$txid\" ] || [ $txid != $txid1 ] ; then\n+   ErrorAndExit \"wrong txid1 : $txid != $txid1\"\n+fi\n+txouts=$($CLI $B1ARGS gettxoutsbyaddress 1 \"[\\\"\"\"$address2\"\"\\\"]\")\n+txid=$(ExtractKey \"txid\" \"$txouts\")\n+if [ ! -z \"$txid\" ] ; then\n+   ErrorAndExit \"txid is not empty: $txid\"\n+fi\n+\n+echo \"Tests successful, cleaning up\"\n+CleanUp\n+exit 0"
      },
      {
        "sha": "022ca800a2634f4740a0508a71e01e2c9d6a5d82",
        "filename": "src/Makefile.am",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/Makefile.am",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/Makefile.am",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/Makefile.am?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -89,6 +89,8 @@ BITCOIN_CORE_H = \\\n   checkqueue.h \\\n   clientversion.h \\\n   coins.h \\\n+  coinsbyscript.h \\\n+  coinstats.h \\\n   compat.h \\\n   compat/byteswap.h \\\n   compat/endian.h \\\n@@ -297,6 +299,8 @@ libbitcoin_common_a_SOURCES = \\\n   base58.cpp \\\n   chainparams.cpp \\\n   coins.cpp \\\n+  coinsbyscript.cpp \\\n+  coinstats.cpp \\\n   compressor.cpp \\\n   core_read.cpp \\\n   core_write.cpp \\"
      },
      {
        "sha": "7c5cb359fd9301071dd11f5dacfff33c0f3d9ed9",
        "filename": "src/bench/mempool_eviction.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/bench/mempool_eviction.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/bench/mempool_eviction.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bench/mempool_eviction.cpp?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -97,7 +97,7 @@ static void MempoolEviction(benchmark::State& state)\n     tx7.vout[1].scriptPubKey = CScript() << OP_7 << OP_EQUAL;\n     tx7.vout[1].nValue = 10 * COIN;\n \n-    CTxMemPool pool(CFeeRate(1000));\n+    CTxMemPool pool(CFeeRate(1000), false);\n \n     while (state.KeepRunning()) {\n         AddTx(tx1, 10000LL, pool);"
      },
      {
        "sha": "92ad633494d3f2cb01bbc978d4907b0d4588de25",
        "filename": "src/coinsbyscript.cpp",
        "status": "added",
        "additions": 50,
        "deletions": 0,
        "changes": 50,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/coinsbyscript.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/coinsbyscript.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinsbyscript.cpp?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -0,0 +1,50 @@\n+// Copyright (c) 2014 The Bitcoin developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include \"coinsbyscript.h\"\n+#include \"txdb.h\"\n+#include \"hash.h\"\n+\n+#include <assert.h>\n+\n+CCoinsViewByScript::CCoinsViewByScript(CCoinsViewDB* viewIn) : base(viewIn) { }\n+\n+bool CCoinsViewByScript::GetCoinsByScript(const CScript &script, CCoinsByScript &coins) {\n+    const uint160 key = CCoinsViewByScript::getKey(script);\n+    if (cacheCoinsByScript.count(key)) {\n+        coins = cacheCoinsByScript[key];\n+        return true;\n+    }\n+    if (base->GetCoinsByHashOfScript(key, coins)) {\n+        cacheCoinsByScript[key] = coins;\n+        return true;\n+    }\n+    return false;\n+}\n+\n+CCoinsMapByScript::iterator CCoinsViewByScript::FetchCoinsByScript(const CScript &script, bool fRequireExisting) {\n+    const uint160 key = CCoinsViewByScript::getKey(script);\n+    CCoinsMapByScript::iterator it = cacheCoinsByScript.find(key);\n+    if (it != cacheCoinsByScript.end())\n+        return it;\n+    CCoinsByScript tmp;\n+    if (!base->GetCoinsByHashOfScript(key, tmp))\n+    {\n+        if (fRequireExisting)\n+            return cacheCoinsByScript.end();\n+    }\n+    CCoinsMapByScript::iterator ret = cacheCoinsByScript.insert(it, std::make_pair(key, CCoinsByScript()));\n+    tmp.swap(ret->second);\n+    return ret;\n+}\n+\n+CCoinsByScript &CCoinsViewByScript::GetCoinsByScript(const CScript &script, bool fRequireExisting) {\n+    CCoinsMapByScript::iterator it = FetchCoinsByScript(script, fRequireExisting);\n+    assert(it != cacheCoinsByScript.end());\n+    return it->second;\n+}\n+\n+uint160 CCoinsViewByScript::getKey(const CScript &script) {\n+    return Hash160(script);\n+}"
      },
      {
        "sha": "637ec8d99adf8847721c92786d0416b25cf3a768",
        "filename": "src/coinsbyscript.h",
        "status": "added",
        "additions": 63,
        "deletions": 0,
        "changes": 63,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/coinsbyscript.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/coinsbyscript.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinsbyscript.h?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -0,0 +1,63 @@\n+// Copyright (c) 2014 The Bitcoin developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSBYSCRIPT_H\n+#define BITCOIN_COINSBYSCRIPT_H\n+\n+#include \"coins.h\"\n+#include \"primitives/transaction.h\"\n+#include \"serialize.h\"\n+#include \"uint256.h\"\n+\n+class CCoinsViewDB;\n+class CScript;\n+\n+class CCoinsByScript\n+{\n+public:\n+    // unspent transaction outputs\n+    std::set<COutPoint> setCoins;\n+\n+    // empty constructor\n+    CCoinsByScript() { }\n+\n+    bool IsEmpty() const {\n+        return (setCoins.empty());\n+    }\n+\n+    void swap(CCoinsByScript &to) {\n+        to.setCoins.swap(setCoins);\n+    }\n+\n+    ADD_SERIALIZE_METHODS;\n+    template <typename Stream, typename Operation>\n+    inline void SerializationOp(Stream& s, Operation ser_action) {\n+        READWRITE(setCoins);\n+    }\n+};\n+\n+typedef std::map<uint160, CCoinsByScript> CCoinsMapByScript; // uint160 = hash of script\n+\n+/** Adds a memory cache for coins by address */\n+class CCoinsViewByScript\n+{\n+private:\n+    CCoinsViewDB *base;\n+\n+public:\n+    CCoinsMapByScript cacheCoinsByScript; // accessed also from CCoinsViewDB in txdb.cpp\n+    CCoinsViewByScript(CCoinsViewDB* baseIn);\n+\n+    bool GetCoinsByScript(const CScript &script, CCoinsByScript &coins);\n+\n+    // Return a modifiable reference to a CCoinsByScript.\n+    CCoinsByScript &GetCoinsByScript(const CScript &script, bool fRequireExisting = true);\n+\n+    static uint160 getKey(const CScript &script); // we use the hash of the script as key in the database\n+\n+private:\n+    CCoinsMapByScript::iterator FetchCoinsByScript(const CScript &script, bool fRequireExisting);\n+};\n+\n+#endif // BITCOIN_COINSBYSCRIPT_H"
      },
      {
        "sha": "c39fd035b098b34ca90ad9c665669b10a0b9abe2",
        "filename": "src/coinstats.cpp",
        "status": "added",
        "additions": 68,
        "deletions": 0,
        "changes": 68,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/coinstats.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/coinstats.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinstats.cpp?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -0,0 +1,68 @@\n+// Copyright (c) 2014-2016 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include \"coinstats.h\"\n+#include \"validation.h\"\n+\n+#include <stdint.h>\n+\n+#include <boost/thread/thread.hpp> // boost::thread::interrupt\n+\n+using namespace std;\n+\n+//! Calculate statistics about the unspent transaction output set\n+bool GetUTXOStats(CCoinsView *view, CCoinsViewDB *viewdb, CCoinsStats &stats)\n+{\n+    boost::scoped_ptr<CCoinsViewCursor> pcursor(view->Cursor());\n+\n+    CHashWriter ss(SER_GETHASH, PROTOCOL_VERSION);\n+    stats.hashBlock = pcursor->GetBestBlock();\n+    {\n+        LOCK(cs_main);\n+        stats.nHeight = mapBlockIndex.find(stats.hashBlock)->second->nHeight;\n+    }\n+    ss << stats.hashBlock;\n+    CAmount nTotalAmount = 0;\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        uint256 key;\n+        CCoins coins;\n+        if (pcursor->GetKey(key) && pcursor->GetValue(coins)) {\n+            stats.nTransactions++;\n+            ss << key;\n+            for (unsigned int i=0; i<coins.vout.size(); i++) {\n+                const CTxOut &out = coins.vout[i];\n+                if (!out.IsNull()) {\n+                    stats.nTransactionOutputs++;\n+                    ss << VARINT(i+1);\n+                    ss << out;\n+                    nTotalAmount += out.nValue;\n+                }\n+            }\n+            stats.nSerializedSize += 32 + pcursor->GetValueSize();\n+            ss << VARINT(0);\n+        } else {\n+            return error(\"%s: unable to read value\", __func__);\n+        }\n+        pcursor->Next();\n+    }\n+    stats.hashSerialized = ss.GetHash();\n+    stats.nTotalAmount = nTotalAmount;\n+\n+    boost::scoped_ptr<CDBIterator> pcursordb(viewdb->RawCursor());\n+    pcursordb->Seek('d');\n+    while (pcursordb->Valid()) {\n+        boost::this_thread::interruption_point();\n+        std::pair<char, uint160> key;\n+        CCoinsByScript coinsByScript;\n+        if (pcursordb->GetKey(key) && key.first == 'd' && pcursordb->GetValue(coinsByScript)) {\n+            stats.nAddresses++;\n+            stats.nAddressesOutputs += coinsByScript.setCoins.size();\n+        } else {\n+            return error(\"%s: unable to read value\", __func__);\n+        }\n+        pcursordb->Next();\n+    }\n+    return true;\n+}"
      },
      {
        "sha": "29faf6df64005224572ede7503d7ff5c03cef3eb",
        "filename": "src/coinstats.h",
        "status": "added",
        "additions": 28,
        "deletions": 0,
        "changes": 28,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/coinstats.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/coinstats.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinstats.h?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -0,0 +1,28 @@\n+// Copyright (c) 2014-2016 The Bitcoin developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#ifndef BITCOIN_COINSTATS_H\n+#define BITCOIN_COINSTATS_H\n+\n+#include \"coins.h\"\n+#include \"txdb.h\"\n+\n+struct CCoinsStats\n+{\n+    int nHeight;\n+    uint256 hashBlock;\n+    uint64_t nTransactions;\n+    uint64_t nTransactionOutputs;\n+    uint64_t nAddresses;\n+    uint64_t nAddressesOutputs; // equal nTransactionOutputs (if addressindex is enabled)\n+    uint64_t nSerializedSize;\n+    uint256 hashSerialized;\n+    CAmount nTotalAmount;\n+\n+    CCoinsStats() : nHeight(0), nTransactions(0), nTransactionOutputs(0), nAddresses(0), nAddressesOutputs(0), nSerializedSize(0), nTotalAmount(0) {}\n+};\n+\n+bool GetUTXOStats(CCoinsView *view, CCoinsViewDB *viewdb, CCoinsStats &stats);\n+\n+#endif // BITCOIN_COINSTATS_H"
      },
      {
        "sha": "6a0794229c6fbb564736cf4cd3b511f701fa6a45",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 59,
        "deletions": 1,
        "changes": 60,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -11,6 +11,7 @@\n \n #include \"addrman.h\"\n #include \"amount.h\"\n+#include \"coinstats.h\"\n #include \"chain.h\"\n #include \"chainparams.h\"\n #include \"checkpoints.h\"\n@@ -165,7 +166,6 @@ class CCoinsViewErrorCatcher : public CCoinsViewBacked\n     // Writes do not need similar protection, as failure to write is handled by the caller.\n };\n \n-static CCoinsViewDB *pcoinsdbview = NULL;\n static CCoinsViewErrorCatcher *pcoinscatcher = NULL;\n static std::unique_ptr<ECCVerifyHandle> globalVerifyHandle;\n \n@@ -233,6 +233,8 @@ void Shutdown()\n         pcoinscatcher = NULL;\n         delete pcoinsdbview;\n         pcoinsdbview = NULL;\n+        delete pcoinsByScript;\n+        pcoinsByScript = NULL;\n         delete pblocktree;\n         pblocktree = NULL;\n     }\n@@ -356,6 +358,7 @@ std::string HelpMessage(HelpMessageMode mode)\n     strUsage += HelpMessageOpt(\"-sysperms\", _(\"Create new files with system default permissions, instead of umask 077 (only effective with disabled wallet functionality)\"));\n #endif\n     strUsage += HelpMessageOpt(\"-txindex\", strprintf(_(\"Maintain a full transaction index, used by the getrawtransaction rpc call (default: %u)\"), DEFAULT_TXINDEX));\n+    strUsage += HelpMessageOpt(\"-txoutsbyaddressindex\", strprintf(_(\"Maintain an address to unspent outputs index (rpc: gettxoutsbyaddress). The index is built on first use. (default: %u)\"), 0));\n \n     strUsage += HelpMessageGroup(_(\"Connection options:\"));\n     strUsage += HelpMessageOpt(\"-addnode=<ip>\", _(\"Add a node to connect to and attempt to keep the connection open\"));\n@@ -1408,6 +1411,61 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n                     }\n                 }\n \n+                // Check -txoutsbyaddressindex\n+                pcoinsdbview->ReadFlag(\"txoutsbyaddressindex\", fTxOutsByAddressIndex);\n+                if (IsArgSet(\"-txoutsbyaddressindex\"))\n+                {\n+                    if (GetBoolArg(\"-txoutsbyaddressindex\", false))\n+                    {\n+                        // build index\n+                        if (!fTxOutsByAddressIndex)\n+                        {\n+                            if (!pcoinsdbview->DeleteAllCoinsByScript())\n+                            {\n+                                strLoadError = _(\"Error deleting txoutsbyaddressindex\");\n+                                break;\n+                            }\n+                            if (!pcoinsdbview->GenerateAllCoinsByScript())\n+                            {\n+                                strLoadError = _(\"Error building txoutsbyaddressindex\");\n+                                break;\n+                            }\n+                            CCoinsStats stats;\n+                            if (!GetUTXOStats(pcoinsTip, pcoinsdbview, stats))\n+                            {\n+                                strLoadError = _(\"Error GetUTXOStats for txoutsbyaddressindex\");\n+                                break;\n+                            }\n+                            if (stats.nTransactionOutputs != stats.nAddressesOutputs)\n+                            {\n+                                strLoadError = _(\"Error compare stats for txoutsbyaddressindex\");\n+                                break;\n+                            }\n+                            pcoinsdbview->WriteFlag(\"txoutsbyaddressindex\", true);\n+                            fTxOutsByAddressIndex = true;\n+                        }\n+                    }\n+                    else\n+                    {\n+                        if (fTxOutsByAddressIndex)\n+                        {\n+                            // remove index\n+                            pcoinsdbview->DeleteAllCoinsByScript();\n+                            pcoinsdbview->WriteFlag(\"txoutsbyaddressindex\", false);\n+                            fTxOutsByAddressIndex = false;\n+                        }\n+                    }\n+                }\n+                else if (fTxOutsByAddressIndex)\n+                    return InitError(_(\"You need to provide -txoutsbyaddressindex. Do -txoutsbyaddressindex=0 to delete the index.\"));\n+\n+                // Init -txoutsbyaddressindex\n+                if (fTxOutsByAddressIndex)\n+                {\n+                    pcoinsByScript = new CCoinsViewByScript(pcoinsdbview);\n+                    pcoinsdbview->SetCoinsViewByScript(pcoinsByScript);\n+                }\n+\n                 uiInterface.InitMessage(_(\"Verifying blocks...\"));\n                 if (fHavePruned && GetArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS) > MIN_BLOCKS_TO_KEEP) {\n                     LogPrintf(\"Prune: pruned datadir may not have more than %d blocks; only checking available blocks\","
      },
      {
        "sha": "9a5c1b01d76808581d1c73bdd30451b4d74147c3",
        "filename": "src/rpc/blockchain.cpp",
        "status": "modified",
        "additions": 174,
        "deletions": 55,
        "changes": 229,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/rpc/blockchain.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/rpc/blockchain.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/blockchain.cpp?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -4,11 +4,13 @@\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n #include \"amount.h\"\n+#include \"base58.h\"\n #include \"chain.h\"\n #include \"chainparams.h\"\n #include \"checkpoints.h\"\n #include \"coins.h\"\n #include \"consensus/validation.h\"\n+#include \"coinstats.h\"\n #include \"validation.h\"\n #include \"policy/policy.h\"\n #include \"primitives/transaction.h\"\n@@ -19,11 +21,14 @@\n #include \"util.h\"\n #include \"utilstrencodings.h\"\n #include \"hash.h\"\n+#include \"txdb.h\"\n+#include \"dbwrapper.h\"\n \n #include <stdint.h>\n \n #include <univalue.h>\n \n+#include <boost/assign/list_of.hpp>\n #include <boost/thread/thread.hpp> // boost::thread::interrupt\n \n #include <mutex>\n@@ -760,60 +765,6 @@ UniValue getblock(const JSONRPCRequest& request)\n     return blockToJSON(block, pblockindex);\n }\n \n-struct CCoinsStats\n-{\n-    int nHeight;\n-    uint256 hashBlock;\n-    uint64_t nTransactions;\n-    uint64_t nTransactionOutputs;\n-    uint64_t nSerializedSize;\n-    uint256 hashSerialized;\n-    CAmount nTotalAmount;\n-\n-    CCoinsStats() : nHeight(0), nTransactions(0), nTransactionOutputs(0), nSerializedSize(0), nTotalAmount(0) {}\n-};\n-\n-//! Calculate statistics about the unspent transaction output set\n-static bool GetUTXOStats(CCoinsView *view, CCoinsStats &stats)\n-{\n-    std::unique_ptr<CCoinsViewCursor> pcursor(view->Cursor());\n-\n-    CHashWriter ss(SER_GETHASH, PROTOCOL_VERSION);\n-    stats.hashBlock = pcursor->GetBestBlock();\n-    {\n-        LOCK(cs_main);\n-        stats.nHeight = mapBlockIndex.find(stats.hashBlock)->second->nHeight;\n-    }\n-    ss << stats.hashBlock;\n-    CAmount nTotalAmount = 0;\n-    while (pcursor->Valid()) {\n-        boost::this_thread::interruption_point();\n-        uint256 key;\n-        CCoins coins;\n-        if (pcursor->GetKey(key) && pcursor->GetValue(coins)) {\n-            stats.nTransactions++;\n-            ss << key;\n-            for (unsigned int i=0; i<coins.vout.size(); i++) {\n-                const CTxOut &out = coins.vout[i];\n-                if (!out.IsNull()) {\n-                    stats.nTransactionOutputs++;\n-                    ss << VARINT(i+1);\n-                    ss << out;\n-                    nTotalAmount += out.nValue;\n-                }\n-            }\n-            stats.nSerializedSize += 32 + pcursor->GetValueSize();\n-            ss << VARINT(0);\n-        } else {\n-            return error(\"%s: unable to read value\", __func__);\n-        }\n-        pcursor->Next();\n-    }\n-    stats.hashSerialized = ss.GetHash();\n-    stats.nTotalAmount = nTotalAmount;\n-    return true;\n-}\n-\n UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n {\n     if (request.fHelp || request.params.size() != 0)\n@@ -827,6 +778,8 @@ UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n             \"  \\\"bestblock\\\": \\\"hex\\\",   (string) the best block hash hex\\n\"\n             \"  \\\"transactions\\\": n,      (numeric) The number of transactions\\n\"\n             \"  \\\"txouts\\\": n,            (numeric) The number of output transactions\\n\"\n+            \"  \\\"addresses\\\": n,         (numeric) The number of addresses and scripts. Only if -txoutsbyaddressindex=1\\n\"\n+            \"  \\\"txoutsbyaddress\\\": n,   (numeric) The number of output transactions. Only if -txoutsbyaddressindex=1\\n\"\n             \"  \\\"bytes_serialized\\\": n,  (numeric) The serialized size\\n\"\n             \"  \\\"hash_serialized\\\": \\\"hash\\\",   (string) The serialized hash\\n\"\n             \"  \\\"total_amount\\\": x.xxx          (numeric) The total amount\\n\"\n@@ -840,11 +793,13 @@ UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n \n     CCoinsStats stats;\n     FlushStateToDisk();\n-    if (GetUTXOStats(pcoinsTip, stats)) {\n+    if (GetUTXOStats(pcoinsTip, pcoinsdbview, stats)) {\n         ret.push_back(Pair(\"height\", (int64_t)stats.nHeight));\n         ret.push_back(Pair(\"bestblock\", stats.hashBlock.GetHex()));\n         ret.push_back(Pair(\"transactions\", (int64_t)stats.nTransactions));\n         ret.push_back(Pair(\"txouts\", (int64_t)stats.nTransactionOutputs));\n+        ret.push_back(Pair(\"addresses\", (int64_t)stats.nAddresses));\n+        ret.push_back(Pair(\"txoutsbyaddress\", (int64_t)stats.nAddressesOutputs));\n         ret.push_back(Pair(\"bytes_serialized\", (int64_t)stats.nSerializedSize));\n         ret.push_back(Pair(\"hash_serialized\", stats.hashSerialized.GetHex()));\n         ret.push_back(Pair(\"total_amount\", ValueFromAmount(stats.nTotalAmount)));\n@@ -934,6 +889,169 @@ UniValue gettxout(const JSONRPCRequest& request)\n     return ret;\n }\n \n+UniValue gettxoutsbyaddress(const JSONRPCRequest& request)\n+{\n+    if (request.fHelp || request.params.size() < 2 || request.params.size() > 4)\n+        throw runtime_error(\n+            \"gettxoutsbyaddress ( minconf [\\\"address\\\",...] count from )\\n\"\n+            \"\\nReturns a list of unspent transaction outputs by address (or script).\\n\"\n+            \"The list is ordered by confirmations in descending order.\\n\"\n+            \"Note that passing minconf=0 will include the mempool.\\n\"\n+            \"\\nTo use this function, you must start bitcoin with the -txoutsbyaddressindex parameter.\\n\"\n+            \"\\nArguments:\\n\"\n+            \"1. minconf          (numeric) Minimum confirmations\\n\"\n+            \"2. \\\"addresses\\\"    (string) A json array of bitcoin addresses (or scripts)\\n\"\n+            \"    [\\n\"\n+            \"      \\\"address\\\"   (string) bitcoin address (or script)\\n\"\n+            \"      ,...\\n\"\n+            \"    ]\\n\"\n+            \"3. count            (numeric, optional, default=999999999) The number of outputs to return\\n\"\n+            \"4. from             (numeric, optional, default=0) The number of outputs to skip\\n\"\n+            \"\\nResult\\n\"\n+            \"[                   (array of json object)\\n\"\n+            \"  {\\n\"\n+            \"    \\\"confirmations\\\" : n,        (numeric) The number of confirmations\\n\"\n+            \"    \\\"txid\\\" : \\\"txid\\\",          (string)  The transaction id \\n\"\n+            \"    \\\"vout\\\" : n,                 (numeric) The vout value\\n\"\n+            \"    \\\"value\\\" : x.xxx,            (numeric) The transaction value in btc\\n\"\n+            \"    \\\"scriptPubKey\\\" : {          (json object)\\n\"\n+            \"       \\\"asm\\\" : \\\"code\\\",        (string) \\n\"\n+            \"       \\\"hex\\\" : \\\"hex\\\",         (string) \\n\"\n+            \"       \\\"reqSigs\\\" : n,           (numeric) Number of required signatures\\n\"\n+            \"       \\\"type\\\" : \\\"pubkeyhash\\\", (string) The type, eg pubkeyhash\\n\"\n+            \"       \\\"addresses\\\" : [          (array of string) array of bitcoin addresses\\n\"\n+            \"          \\\"bitcoinaddress\\\"      (string) bitcoin address\\n\"\n+            \"          ,...\\n\"\n+            \"       ]\\n\"\n+            \"    },\\n\"\n+            \"    \\\"version\\\" : n,              (numeric) The transaction version\\n\"\n+            \"    \\\"coinbase\\\" : true|false     (boolean) Coinbase or not\\n\"\n+            \"    \\\"bestblockhash\\\" : \\\"hash\\\", (string)  The block hash of the best block\\n\"\n+            \"    \\\"bestblockheight\\\" : n,      (numeric) The block height of the best block\\n\"\n+            \"    \\\"bestblocktime\\\" : n,        (numeric) The block time of the best block\\n\"\n+            \"    \\\"blockhash\\\" : \\\"hash\\\",     (string)  The block hash of the block the tx is in (only if confirmations > 0)\\n\"\n+            \"    \\\"blockheight\\\" : n,          (numeric) The block height of the block the tx is in (only if confirmations > 0)\\n\"\n+            \"    \\\"blocktime\\\" : ttt,          (numeric) The block time in seconds since 1.1.1970 GMT (only if confirmations > 0)\\n\"\n+            \"  }\\n\"\n+            \"  ,...\\n\"\n+            \"]\\n\"\n+            \"\\nExamples:\\n\"\n+            + HelpExampleCli(\"gettxoutsbyaddress\", \"6 \\\"[\\\\\\\"1PGFqEzfmQch1gKD3ra4k18PNj3tTUUSqg\\\\\\\",\\\\\\\"1LtvqCaApEdUGFkpKMM4MstjcaL4dKg8SP\\\\\\\"]\\\"\")\n+            + \"\\nAs a json rpc call\\n\"\n+            + HelpExampleRpc(\"gettxoutsbyaddress\", \"6, \\\"[\\\\\\\"1PGFqEzfmQch1gKD3ra4k18PNj3tTUUSqg\\\\\\\",\\\\\\\"1LtvqCaApEdUGFkpKMM4MstjcaL4dKg8SP\\\\\\\"]\\\"\")\n+        );\n+\n+    if (!fTxOutsByAddressIndex)\n+        throw JSONRPCError(RPC_METHOD_NOT_FOUND, \"To use this function, you must start bitcoin with the -txoutsbyaddressindex parameter.\");\n+\n+    RPCTypeCheck(request.params, boost::assign::list_of(UniValue::VNUM)(UniValue::VARR)(UniValue::VNUM)(UniValue::VNUM));\n+\n+    UniValue vObjects(UniValue::VARR);\n+    vector<pair<int, unsigned int> > vSort;\n+    int nMinDepth = request.params[0].get_int();\n+    UniValue inputs = request.params[1].get_array();\n+\n+    int nCount = 999999999;\n+    if (request.params.size() > 2)\n+        nCount = request.params[2].get_int();\n+    int nFrom = 0;\n+    if (request.params.size() > 3)\n+        nFrom = request.params[3].get_int();\n+\n+    if (nMinDepth < 0)\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Negative minconf\");\n+    if (nCount < 0)\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Negative count\");\n+    if (nFrom < 0)\n+        throw JSONRPCError(RPC_INVALID_PARAMETER, \"Negative from\");\n+\n+    for (unsigned int idx = 0; idx < inputs.size(); idx++) {\n+        const UniValue& input = inputs[idx];\n+        CScript script;\n+        CBitcoinAddress address(input.get_str());\n+        if (address.IsValid()) {\n+            script = GetScriptForDestination(address.Get());\n+        } else if (IsHex(input.get_str())) {\n+            std::vector<unsigned char> data(ParseHex(input.get_str()));\n+            script = CScript(data.begin(), data.end());\n+        } else {\n+            throw JSONRPCError(RPC_INVALID_ADDRESS_OR_KEY, \"Invalid Bitcoin address or script: \" + input.get_str());\n+        }\n+\n+        CCoinsByScript coinsByScript;\n+        pcoinsByScript->GetCoinsByScript(script, coinsByScript);\n+\n+        if (nMinDepth == 0)\n+            mempool.GetCoinsByScript(script, coinsByScript);\n+\n+        BOOST_FOREACH(const COutPoint &outpoint, coinsByScript.setCoins)\n+        {\n+            CCoins coins;\n+            if (nMinDepth == 0)\n+            {\n+                LOCK(mempool.cs);\n+                CCoinsViewMemPool view(pcoinsTip, mempool);\n+                if (!view.GetCoins(outpoint.hash, coins))\n+                    continue;\n+                mempool.pruneSpent(outpoint.hash, coins); // TODO: this should be done by the CCoinsViewMemPool\n+            }\n+            else if (!pcoinsTip->GetCoins(outpoint.hash, coins))\n+                continue;\n+\n+            if (outpoint.n < coins.vout.size() && !coins.vout[outpoint.n].IsNull() && !coins.vout[outpoint.n].scriptPubKey.IsUnspendable())\n+            {\n+                // should not happen\n+                if ((unsigned int)coins.nHeight != MEMPOOL_HEIGHT && (!chainActive[coins.nHeight] || !chainActive[coins.nHeight]->phashBlock))\n+                    throw JSONRPCError(RPC_INTERNAL_ERROR, \"Internal Error: !chainActive[coins.nHeight]\");\n+\n+                BlockMap::iterator it = mapBlockIndex.find(pcoinsTip->GetBestBlock());\n+                CBlockIndex *pindex = it->second;\n+\n+                int nConfirmations = 0;\n+                if ((unsigned int)coins.nHeight != MEMPOOL_HEIGHT)\n+                    nConfirmations = pindex->nHeight - coins.nHeight + 1;\n+                if (nConfirmations < nMinDepth)\n+                    continue;\n+\n+                UniValue oScriptPubKey(UniValue::VOBJ);\n+                ScriptPubKeyToJSON(coins.vout[outpoint.n].scriptPubKey, oScriptPubKey, true);\n+\n+                UniValue o(UniValue::VOBJ);\n+                o.push_back(Pair(\"confirmations\", nConfirmations));\n+                o.push_back(Pair(\"txid\", outpoint.hash.GetHex()));\n+                o.push_back(Pair(\"vout\", (int)outpoint.n));\n+                o.push_back(Pair(\"value\", ValueFromAmount(coins.vout[outpoint.n].nValue)));\n+                o.push_back(Pair(\"scriptPubKey\", oScriptPubKey));\n+                o.push_back(Pair(\"version\", coins.nVersion));\n+                o.push_back(Pair(\"coinbase\", coins.fCoinBase));\n+                o.push_back(Pair(\"bestblockhash\", pindex->GetBlockHash().GetHex()));\n+                o.push_back(Pair(\"bestblockheight\", pindex->nHeight));\n+                o.push_back(Pair(\"bestblocktime\", pindex->GetBlockTime()));\n+                if ((unsigned int)coins.nHeight != MEMPOOL_HEIGHT)\n+                {\n+                    o.push_back(Pair(\"blockhash\", chainActive[coins.nHeight]->GetBlockHash().GetHex()));\n+                    o.push_back(Pair(\"blockheight\", coins.nHeight));\n+                    o.push_back(Pair(\"blocktime\", chainActive[coins.nHeight]->GetBlockTime()));\n+                }\n+                vObjects.push_back(o);\n+                vSort.push_back(make_pair(coins.nHeight, (unsigned int)vObjects.size() - 1));\n+            }\n+        }\n+    }\n+\n+    UniValue results(UniValue::VARR);\n+    sort(vSort.begin(), vSort.end());\n+    for (unsigned int i = (unsigned int)nFrom; i < vSort.size(); i++)\n+    {\n+        if (i == (unsigned int)nCount + (unsigned int)nFrom)\n+            break;\n+\n+        results.push_back(vObjects[vSort[i].second]);\n+    }\n+\n+    return results;\n+}\n+\n UniValue verifychain(const JSONRPCRequest& request)\n {\n     int nCheckLevel = GetArg(\"-checklevel\", DEFAULT_CHECKLEVEL);\n@@ -1383,6 +1501,7 @@ static const CRPCCommand commands[] =\n     { \"blockchain\",         \"getmempoolinfo\",         &getmempoolinfo,         true  },\n     { \"blockchain\",         \"getrawmempool\",          &getrawmempool,          true  },\n     { \"blockchain\",         \"gettxout\",               &gettxout,               true  },\n+    { \"blockchain\",         \"gettxoutsbyaddress\",     &gettxoutsbyaddress,     true  },\n     { \"blockchain\",         \"gettxoutsetinfo\",        &gettxoutsetinfo,        true  },\n     { \"blockchain\",         \"verifychain\",            &verifychain,            true  },\n "
      },
      {
        "sha": "3dd89c0cb59be2944aeb760f602b831931873803",
        "filename": "src/rpc/client.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/rpc/client.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/rpc/client.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/client.cpp?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -89,6 +89,10 @@ static const CRPCConvertParam vRPCConvertParams[] =\n     { \"gettxout\", 1 },\n     { \"gettxout\", 2 },\n     { \"gettxoutproof\", 0 },\n+    { \"gettxoutsbyaddress\", 0 },\n+    { \"gettxoutsbyaddress\", 1 },\n+    { \"gettxoutsbyaddress\", 2 },\n+    { \"gettxoutsbyaddress\", 3 },\n     { \"lockunspent\", 0 },\n     { \"lockunspent\", 1 },\n     { \"importprivkey\", 2 },"
      },
      {
        "sha": "00c192f550a4503a102cf5fd9b9c6162b6f5d885",
        "filename": "src/test/blockencodings_tests.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 4,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/test/blockencodings_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/test/blockencodings_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/blockencodings_tests.cpp?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -55,7 +55,7 @@ static CBlock BuildBlockTestCase() {\n \n BOOST_AUTO_TEST_CASE(SimpleRoundTripTest)\n {\n-    CTxMemPool pool(CFeeRate(0));\n+    CTxMemPool pool(CFeeRate(0), false);\n     TestMemPoolEntryHelper entry;\n     CBlock block(BuildBlockTestCase());\n \n@@ -148,7 +148,7 @@ class TestHeaderAndShortIDs {\n \n BOOST_AUTO_TEST_CASE(NonCoinbasePreforwardRTTest)\n {\n-    CTxMemPool pool(CFeeRate(0));\n+    CTxMemPool pool(CFeeRate(0), false);\n     TestMemPoolEntryHelper entry;\n     CBlock block(BuildBlockTestCase());\n \n@@ -207,7 +207,7 @@ BOOST_AUTO_TEST_CASE(NonCoinbasePreforwardRTTest)\n \n BOOST_AUTO_TEST_CASE(SufficientPreforwardRTTest)\n {\n-    CTxMemPool pool(CFeeRate(0));\n+    CTxMemPool pool(CFeeRate(0), false);\n     TestMemPoolEntryHelper entry;\n     CBlock block(BuildBlockTestCase());\n \n@@ -257,7 +257,7 @@ BOOST_AUTO_TEST_CASE(SufficientPreforwardRTTest)\n \n BOOST_AUTO_TEST_CASE(EmptyBlockRoundTripTest)\n {\n-    CTxMemPool pool(CFeeRate(0));\n+    CTxMemPool pool(CFeeRate(0), false);\n     CMutableTransaction coinbase;\n     coinbase.vin.resize(1);\n     coinbase.vin[0].scriptSig.resize(10);"
      },
      {
        "sha": "4ce33f57473093c61cd73afb63b2ade1bc93dbae",
        "filename": "src/test/mempool_tests.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 5,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/test/mempool_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/test/mempool_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/mempool_tests.cpp?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -53,8 +53,8 @@ BOOST_AUTO_TEST_CASE(MempoolRemoveTest)\n         txGrandChild[i].vout[0].nValue = 11000LL;\n     }\n \n-\n-    CTxMemPool testPool(CFeeRate(0));\n+    bool fTxOutsByAddressIndex = false;\n+    CTxMemPool testPool(CFeeRate(0), fTxOutsByAddressIndex);\n \n     // Nothing in pool, remove should do nothing:\n     unsigned int poolSize = testPool.size();\n@@ -118,7 +118,7 @@ void CheckSort(CTxMemPool &pool, std::vector<std::string> &sortedOrder)\n \n BOOST_AUTO_TEST_CASE(MempoolIndexingTest)\n {\n-    CTxMemPool pool(CFeeRate(0));\n+    CTxMemPool pool(CFeeRate(0), false);\n     TestMemPoolEntryHelper entry;\n     entry.hadNoDependencies = true;\n \n@@ -321,7 +321,7 @@ BOOST_AUTO_TEST_CASE(MempoolIndexingTest)\n \n BOOST_AUTO_TEST_CASE(MempoolAncestorIndexingTest)\n {\n-    CTxMemPool pool(CFeeRate(0));\n+    CTxMemPool pool(CFeeRate(0), false);\n     TestMemPoolEntryHelper entry;\n     entry.hadNoDependencies = true;\n \n@@ -434,7 +434,7 @@ BOOST_AUTO_TEST_CASE(MempoolAncestorIndexingTest)\n \n BOOST_AUTO_TEST_CASE(MempoolSizeLimitTest)\n {\n-    CTxMemPool pool(CFeeRate(1000));\n+    CTxMemPool pool(CFeeRate(1000), false);\n     TestMemPoolEntryHelper entry;\n     entry.dPriority = 10.0;\n "
      },
      {
        "sha": "a0fd534f0dbd628daed10b5a402848b500511ff8",
        "filename": "src/test/policyestimator_tests.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/test/policyestimator_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/test/policyestimator_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/policyestimator_tests.cpp?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -16,7 +16,8 @@ BOOST_FIXTURE_TEST_SUITE(policyestimator_tests, BasicTestingSetup)\n \n BOOST_AUTO_TEST_CASE(BlockPolicyEstimates)\n {\n-    CTxMemPool mpool(CFeeRate(1000));\n+    bool fTxOutsByAddressIndex = false;\n+    CTxMemPool mpool(CFeeRate(1000), fTxOutsByAddressIndex);\n     TestMemPoolEntryHelper entry;\n     CAmount basefee(2000);\n     CAmount deltaFee(100);"
      },
      {
        "sha": "99db068a6259391b1e0f2cf6b204bdf797ce51e4",
        "filename": "src/txdb.cpp",
        "status": "modified",
        "additions": 183,
        "deletions": 1,
        "changes": 184,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/txdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/txdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txdb.cpp?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -9,6 +9,7 @@\n #include \"hash.h\"\n #include \"pow.h\"\n #include \"uint256.h\"\n+#include \"ui_interface.h\"\n \n #include <stdint.h>\n \n@@ -27,14 +28,23 @@ static const char DB_REINDEX_FLAG = 'R';\n static const char DB_LAST_BLOCK = 'l';\n \n \n-CCoinsViewDB::CCoinsViewDB(size_t nCacheSize, bool fMemory, bool fWipe) : db(GetDataDir() / \"chainstate\", nCacheSize, fMemory, fWipe, true) \n+CCoinsViewDB::CCoinsViewDB(size_t nCacheSize, bool fMemory, bool fWipe) : db(GetDataDir() / \"chainstate\", nCacheSize, fMemory, fWipe, true)\n {\n+    pcoinsViewByScript = NULL;\n+}\n+\n+void CCoinsViewDB::SetCoinsViewByScript(CCoinsViewByScript* pcoinsViewByScriptIn) {\n+    pcoinsViewByScript = pcoinsViewByScriptIn;\n }\n \n bool CCoinsViewDB::GetCoins(const uint256 &txid, CCoins &coins) const {\n     return db.Read(make_pair(DB_COINS, txid), coins);\n }\n \n+bool CCoinsViewDB::GetCoinsByHashOfScript(const uint160 &hash, CCoinsByScript &coins) const {\n+    return db.Read(make_pair('d', hash), coins);\n+}\n+\n bool CCoinsViewDB::HaveCoins(const uint256 &txid) const {\n     return db.Exists(make_pair(DB_COINS, txid));\n }\n@@ -62,13 +72,37 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n         CCoinsMap::iterator itOld = it++;\n         mapCoins.erase(itOld);\n     }\n+    if (pcoinsViewByScript) // only if -txoutsbyaddressindex\n+    {\n+        for (CCoinsMapByScript::iterator it = pcoinsViewByScript->cacheCoinsByScript.begin(); it != pcoinsViewByScript->cacheCoinsByScript.end();) {\n+            if (it->second.IsEmpty())\n+                batch.Erase(make_pair('d', it->first));\n+            else\n+                batch.Write(make_pair('d', it->first), it->second);\n+            CCoinsMapByScript::iterator itOld = it++;\n+            pcoinsViewByScript->cacheCoinsByScript.erase(itOld);\n+        }\n+        pcoinsViewByScript->cacheCoinsByScript.clear();\n+    }\n     if (!hashBlock.IsNull())\n         batch.Write(DB_BEST_BLOCK, hashBlock);\n \n     LogPrint(\"coindb\", \"Committing %u changed transactions (out of %u) to coin database...\\n\", (unsigned int)changed, (unsigned int)count);\n     return db.WriteBatch(batch);\n }\n \n+bool CCoinsViewDB::WriteFlag(const std::string &name, bool fValue) {\n+    return db.Write(std::make_pair('F', name), fValue ? '1' : '0');\n+}\n+\n+bool CCoinsViewDB::ReadFlag(const std::string &name, bool &fValue) {\n+    char ch;\n+    if (!db.Read(std::make_pair('F', name), ch))\n+        return false;\n+    fValue = ch == '1';\n+    return true;\n+}\n+\n CBlockTreeDB::CBlockTreeDB(size_t nCacheSize, bool fMemory, bool fWipe) : CDBWrapper(GetDataDir() / \"blocks\" / \"index\", nCacheSize, fMemory, fWipe) {\n }\n \n@@ -92,6 +126,11 @@ bool CBlockTreeDB::ReadLastBlockFile(int &nFile) {\n     return Read(DB_LAST_BLOCK, nFile);\n }\n \n+CDBIterator *CCoinsViewDB::RawCursor() const\n+{\n+    return const_cast<CDBWrapper*>(&db)->NewIterator();\n+}\n+\n CCoinsViewCursor *CCoinsViewDB::Cursor() const\n {\n     CCoinsViewDBCursor *i = new CCoinsViewDBCursor(const_cast<CDBWrapper*>(&db)->NewIterator(), GetBestBlock());\n@@ -136,6 +175,149 @@ void CCoinsViewDBCursor::Next()\n         keyTmp.first = 0; // Invalidate cached key after last record so that Valid() and GetKey() return false\n }\n \n+int64_t CCoinsViewDB::GetPrefixCount(char prefix) const\n+{\n+    boost::scoped_ptr<CDBIterator> pcursor(RawCursor());\n+    pcursor->Seek(prefix);\n+\n+    int64_t i = 0;\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        try {\n+            char key;\n+            if (!pcursor->GetKey(key) || key != prefix)\n+                break;\n+            i++;\n+            pcursor->Next();\n+        } catch (std::exception &e) {\n+            return 0;\n+        }\n+    }\n+    return i;\n+}\n+\n+bool CCoinsViewDB::DeleteAllCoinsByScript()\n+{\n+    boost::scoped_ptr<CDBIterator> pcursor(RawCursor());\n+    pcursor->Seek('d');\n+\n+    std::vector<uint160> v;\n+    int64_t i = 0;\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        try {\n+            std::pair<char, uint160> key;\n+            if (!pcursor->GetKey(key) || key.first != 'd')\n+                break;\n+            v.push_back(key.second);\n+            if (v.size() >= 10000)\n+            {\n+                i += v.size();\n+                CDBBatch batch(db);\n+                BOOST_FOREACH(const uint160& hash, v)\n+                    batch.Erase(make_pair('d', hash)); // delete\n+                db.WriteBatch(batch);\n+                v.clear();\n+            }\n+\n+            pcursor->Next();\n+        } catch (std::exception &e) {\n+            return error(\"%s : Deserialize or I/O error - %s\", __func__, e.what());\n+        }\n+    }\n+    if (!v.empty())\n+    {\n+        i += v.size();\n+        CDBBatch batch(db);\n+        BOOST_FOREACH(const uint160& hash, v)\n+            batch.Erase(make_pair('d', hash)); // delete\n+        db.WriteBatch(batch);\n+    }\n+    if (i > 0)\n+        LogPrintf(\"Address index with %d addresses successfully deleted.\\n\", i);\n+\n+    return true;\n+}\n+\n+bool CCoinsViewDB::GenerateAllCoinsByScript()\n+{\n+    LogPrintf(\"Building address index for -txoutsbyaddressindex. Be patient...\\n\");\n+    int64_t nTxCount = GetPrefixCount('c');\n+\n+    boost::scoped_ptr<CDBIterator> pcursor(RawCursor());\n+    pcursor->Seek('c');\n+\n+    CCoinsMapByScript mapCoinsByScript;\n+    int64_t i = 0;\n+    int64_t progress = 0;\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        try {\n+            if (progress % 1000 == 0 && nTxCount > 0)\n+                uiInterface.ShowProgress(_(\"Building address index...\"), (int)(((double)progress / (double)nTxCount) * (double)100));\n+            progress++;\n+\n+            std::pair<char, uint256> key;\n+            CCoins coins;\n+            if (!pcursor->GetKey(key) || key.first != 'c')\n+                break;\n+            uint256 txhash = key.second;\n+            if (!pcursor->GetValue(coins))\n+                break;\n+\n+            for (unsigned int j = 0; j < coins.vout.size(); j++)\n+            {\n+                if (coins.vout[j].IsNull() || coins.vout[j].scriptPubKey.IsUnspendable())\n+                    continue;\n+\n+                const uint160 key = CCoinsViewByScript::getKey(coins.vout[j].scriptPubKey);\n+                if (!mapCoinsByScript.count(key))\n+                {\n+                    CCoinsByScript coinsByScript;\n+                    GetCoinsByHashOfScript(key, coinsByScript);\n+                    mapCoinsByScript.insert(make_pair(key, coinsByScript));\n+                }\n+                mapCoinsByScript[key].setCoins.insert(COutPoint(txhash, (uint32_t)j));\n+                i++;\n+            }\n+\n+            if (mapCoinsByScript.size() >= 10000)\n+            {\n+                CDBBatch batch(db);\n+                for (CCoinsMapByScript::iterator it = mapCoinsByScript.begin(); it != mapCoinsByScript.end();) {\n+                    if (it->second.IsEmpty())\n+                        batch.Erase(make_pair('d', it->first));\n+                    else\n+                        batch.Write(make_pair('d', it->first), it->second);\n+                    CCoinsMapByScript::iterator itOld = it++;\n+                    mapCoinsByScript.erase(itOld);\n+                }\n+                db.WriteBatch(batch);\n+                mapCoinsByScript.clear();\n+            }\n+\n+            pcursor->Next();\n+        } catch (std::exception &e) {\n+            return error(\"%s : Deserialize or I/O error - %s\", __func__, e.what());\n+        }\n+    }\n+    if (!mapCoinsByScript.empty())\n+    {\n+       CDBBatch batch(db);\n+       for (CCoinsMapByScript::iterator it = mapCoinsByScript.begin(); it != mapCoinsByScript.end();) {\n+           if (it->second.IsEmpty())\n+               batch.Erase(make_pair('d', it->first));\n+           else\n+               batch.Write(make_pair('d', it->first), it->second);\n+           CCoinsMapByScript::iterator itOld = it++;\n+           mapCoinsByScript.erase(itOld);\n+       }\n+       db.WriteBatch(batch);\n+    }\n+    LogPrintf(\"Address index with %d outputs successfully built.\\n\", i);\n+    return true;\n+}\n+\n bool CBlockTreeDB::WriteBatchSync(const std::vector<std::pair<int, const CBlockFileInfo*> >& fileInfo, int nLastFile, const std::vector<const CBlockIndex*>& blockinfo) {\n     CDBBatch batch(*this);\n     for (std::vector<std::pair<int, const CBlockFileInfo*> >::const_iterator it=fileInfo.begin(); it != fileInfo.end(); it++) {"
      },
      {
        "sha": "87c71c325f919f9227f7c493cd5d437c32328045",
        "filename": "src/txdb.h",
        "status": "modified",
        "additions": 11,
        "deletions": 0,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/txdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/txdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txdb.h?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -9,6 +9,7 @@\n #include \"coins.h\"\n #include \"dbwrapper.h\"\n #include \"chain.h\"\n+#include \"coinsbyscript.h\"\n \n #include <map>\n #include <string>\n@@ -64,15 +65,25 @@ struct CDiskTxPos : public CDiskBlockPos\n /** CCoinsView backed by the coin database (chainstate/) */\n class CCoinsViewDB : public CCoinsView\n {\n+private:\n+    CCoinsViewByScript* pcoinsViewByScript;\n protected:\n     CDBWrapper db;\n public:\n     CCoinsViewDB(size_t nCacheSize, bool fMemory = false, bool fWipe = false);\n \n     bool GetCoins(const uint256 &txid, CCoins &coins) const;\n+    bool GetCoinsByHashOfScript(const uint160 &hash, CCoinsByScript &coins) const;\n     bool HaveCoins(const uint256 &txid) const;\n     uint256 GetBestBlock() const;\n     bool BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock);\n+    bool WriteFlag(const std::string &name, bool fValue);\n+    bool ReadFlag(const std::string &name, bool &fValue);\n+    int64_t GetPrefixCount(char prefix) const;\n+    bool DeleteAllCoinsByScript();   // removes txoutsbyaddressindex\n+    bool GenerateAllCoinsByScript(); // creates txoutsbyaddressindex\n+    void SetCoinsViewByScript(CCoinsViewByScript* pcoinsViewByScriptIn);\n+    CDBIterator *RawCursor() const;\n     CCoinsViewCursor *Cursor() const;\n };\n "
      },
      {
        "sha": "bcb980ad6d2fe6ad64fd99a957111755f1eeade3",
        "filename": "src/txmempool.cpp",
        "status": "modified",
        "additions": 37,
        "deletions": 2,
        "changes": 39,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/txmempool.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/txmempool.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txmempool.cpp?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -348,8 +348,9 @@ void CTxMemPoolEntry::UpdateAncestorState(int64_t modifySize, CAmount modifyFee,\n     assert(int(nSigOpCostWithAncestors) >= 0);\n }\n \n-CTxMemPool::CTxMemPool(const CFeeRate& _minReasonableRelayFee) :\n-    nTransactionsUpdated(0)\n+CTxMemPool::CTxMemPool(const CFeeRate& _minReasonableRelayFee, const bool& _fTxOutsByAddressIndex) :\n+    nTransactionsUpdated(0),\n+    fTxOutsByAddressIndex(_fTxOutsByAddressIndex)\n {\n     _clear(); //lock free clear\n \n@@ -386,6 +387,17 @@ unsigned int CTxMemPool::GetTransactionsUpdated() const\n     return nTransactionsUpdated;\n }\n \n+void CTxMemPool::GetCoinsByScript(const CScript& script, CCoinsByScript& coinsByScript) const\n+{\n+    LOCK(cs);\n+    CCoinsMapByScript::const_iterator it = mapCoinsByScript.find(CCoinsViewByScript::getKey(script));\n+    if (it != mapCoinsByScript.end())\n+    {\n+        BOOST_FOREACH(const COutPoint &outpoint, it->second.setCoins)\n+            coinsByScript.setCoins.insert(outpoint);\n+    }\n+}\n+\n void CTxMemPool::AddTransactionsUpdated(unsigned int n)\n {\n     LOCK(cs);\n@@ -447,6 +459,11 @@ bool CTxMemPool::addUnchecked(const uint256& hash, const CTxMemPoolEntry &entry,\n     vTxHashes.emplace_back(tx.GetWitnessHash(), newit);\n     newit->vTxHashesIdx = vTxHashes.size() - 1;\n \n+    if (fTxOutsByAddressIndex)\n+        for (unsigned int i = 0; i < tx.vout.size(); i++)\n+            if (!tx.vout[i].IsNull() && !tx.vout[i].scriptPubKey.IsUnspendable())\n+                mapCoinsByScript[CCoinsViewByScript::getKey(tx.vout[i].scriptPubKey)].setCoins.insert(COutPoint(hash, (uint32_t)i));\n+\n     return true;\n }\n \n@@ -508,6 +525,24 @@ void CTxMemPool::removeRecursive(const CTransaction &origTx)\n     // Remove transaction from memory pool\n     {\n         LOCK(cs);\n+\n+        if (fTxOutsByAddressIndex)\n+        {\n+            for (unsigned int i = 0; i < origTx.vout.size(); i++)\n+            {\n+                if (origTx.vout[i].IsNull() || origTx.vout[i].scriptPubKey.IsUnspendable())\n+                    continue;\n+\n+                CCoinsMapByScript::iterator it = mapCoinsByScript.find(CCoinsViewByScript::getKey(origTx.vout[i].scriptPubKey));\n+                if (it != mapCoinsByScript.end())\n+                {\n+                    it->second.setCoins.erase(COutPoint(origTx.GetHash(), (uint32_t)i));\n+                    if (it->second.setCoins.empty())\n+                        mapCoinsByScript.erase(it);\n+                }\n+            }\n+        }\n+\n         setEntries txToRemove;\n         txiter origit = mapTx.find(origTx.GetHash());\n         if (origit != mapTx.end()) {"
      },
      {
        "sha": "48371c442413a95d42584dc61d6e61cc9bf4876c",
        "filename": "src/txmempool.h",
        "status": "modified",
        "additions": 5,
        "deletions": 1,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/txmempool.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/txmempool.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txmempool.h?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -16,6 +16,7 @@\n #include \"amount.h\"\n #include \"coins.h\"\n #include \"indirectmap.h\"\n+#include \"coinsbyscript.h\"\n #include \"primitives/transaction.h\"\n #include \"sync.h\"\n #include \"random.h\"\n@@ -422,6 +423,8 @@ class CTxMemPool\n     CBlockPolicyEstimator* minerPolicyEstimator;\n \n     uint64_t totalTxSize;      //!< sum of all mempool tx' byte sizes\n+    const bool& fTxOutsByAddressIndex;\n+    CCoinsMapByScript mapCoinsByScript; // only used if -txoutsbyaddressindex\n     uint64_t cachedInnerUsage; //!< sum of dynamic memory usage of all the map elements (NOT the maps themselves)\n \n     CFeeRate minReasonableRelayFee;\n@@ -508,7 +511,7 @@ class CTxMemPool\n      *  around what it \"costs\" to relay a transaction around the network and\n      *  below which we would reasonably say a transaction has 0-effective-fee.\n      */\n-    CTxMemPool(const CFeeRate& _minReasonableRelayFee);\n+    CTxMemPool(const CFeeRate& _minReasonableRelayFee, const bool& _fTxOutsByAddressIndex);\n     ~CTxMemPool();\n \n     /**\n@@ -539,6 +542,7 @@ class CTxMemPool\n     void pruneSpent(const uint256& hash, CCoins &coins);\n     unsigned int GetTransactionsUpdated() const;\n     void AddTransactionsUpdated(unsigned int n);\n+    void GetCoinsByScript(const CScript& script, CCoinsByScript& coinsByScript) const;\n     /**\n      * Check that none of this transactions inputs are in the mempool, and thus\n      * the tx is not dependent on other mempool transactions to be included in a block."
      },
      {
        "sha": "b33ab50313eb622aa04d4d26d81cefa8156daf6c",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 72,
        "deletions": 11,
        "changes": 83,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -67,6 +67,7 @@ int nScriptCheckThreads = 0;\n std::atomic_bool fImporting(false);\n bool fReindex = false;\n bool fTxIndex = false;\n+bool fTxOutsByAddressIndex = false;\n bool fHavePruned = false;\n bool fPruneMode = false;\n bool fIsBareMultisigStd = DEFAULT_PERMIT_BAREMULTISIG;\n@@ -82,7 +83,7 @@ bool fEnableReplacement = DEFAULT_ENABLE_REPLACEMENT;\n CFeeRate minRelayTxFee = CFeeRate(DEFAULT_MIN_RELAY_TX_FEE);\n CAmount maxTxFee = DEFAULT_TRANSACTION_MAXFEE;\n \n-CTxMemPool mempool(::minRelayTxFee);\n+CTxMemPool mempool(::minRelayTxFee, fTxOutsByAddressIndex);\n \n static void CheckBlockIndex(const Consensus::Params& consensusParams);\n \n@@ -175,6 +176,8 @@ CBlockIndex* FindForkInGlobalIndex(const CChain& chain, const CBlockLocator& loc\n }\n \n CCoinsViewCache *pcoinsTip = NULL;\n+CCoinsViewDB *pcoinsdbview = NULL;\n+CCoinsViewByScript *pcoinsByScript = NULL;\n CBlockTreeDB *pblocktree = NULL;\n \n enum FlushStateMode {\n@@ -1524,7 +1527,7 @@ static bool ApplyTxInUndo(const CTxInUndo& undo, CCoinsViewCache& view, const CO\n     return fClean;\n }\n \n-bool DisconnectBlock(const CBlock& block, CValidationState& state, const CBlockIndex* pindex, CCoinsViewCache& view, bool* pfClean)\n+bool DisconnectBlock(const CBlock& block, CValidationState& state, const CBlockIndex* pindex, CCoinsViewCache& view, CBlockUndo& blockUndo, bool* pfClean)\n {\n     assert(pindex->GetBlockHash() == view.GetBestBlock());\n \n@@ -1533,7 +1536,6 @@ bool DisconnectBlock(const CBlock& block, CValidationState& state, const CBlockI\n \n     bool fClean = true;\n \n-    CBlockUndo blockUndo;\n     CDiskBlockPos pos = pindex->GetUndoPos();\n     if (pos.IsNull())\n         return error(\"DisconnectBlock(): no undo data available\");\n@@ -1678,7 +1680,7 @@ static int64_t nTimeCallbacks = 0;\n static int64_t nTimeTotal = 0;\n \n bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockIndex* pindex,\n-                  CCoinsViewCache& view, const CChainParams& chainparams, bool fJustCheck)\n+                  CCoinsViewCache& view, const CChainParams& chainparams, CBlockUndo& blockundo, bool fJustCheck)\n {\n     AssertLockHeld(cs_main);\n \n@@ -1779,8 +1781,6 @@ bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockIndex* pin\n     int64_t nTime2 = GetTimeMicros(); nTimeForks += nTime2 - nTime1;\n     LogPrint(\"bench\", \"    - Fork checks: %.2fms [%.2fs]\\n\", 0.001 * (nTime2 - nTime1), nTimeForks * 0.000001);\n \n-    CBlockUndo blockundo;\n-\n     CCheckQueueControl<CScriptCheck> control(fScriptChecks && nScriptCheckThreads ? &scriptcheckqueue : NULL);\n \n     std::vector<int> prevheights;\n@@ -2023,6 +2023,60 @@ void PruneAndFlush() {\n     FlushStateToDisk(state, FLUSH_STATE_NONE);\n }\n \n+void static UpdateAddressIndex(const CTxOut& txout, const COutPoint& outpoint, bool fInsert)\n+{\n+    if (!txout.IsNull() && !txout.scriptPubKey.IsUnspendable())\n+    {\n+        CCoinsByScript &coinsByScript = pcoinsByScript->GetCoinsByScript(txout.scriptPubKey, !fInsert);\n+        if (fInsert)\n+            coinsByScript.setCoins.insert(outpoint);\n+        else\n+            coinsByScript.setCoins.erase(outpoint);\n+    }\n+}\n+\n+void static UpdateAddressIndex(const CBlock& block, CBlockUndo& blockundo, bool fConnect)\n+{\n+    if (!fTxOutsByAddressIndex)\n+        return;\n+\n+    assert(block.vtx.size() > 0);\n+    unsigned int i = 0;\n+    if (!fConnect)\n+        i = block.vtx.size() - 1; // iterate backwards\n+\n+    while (true)\n+    {\n+        const CTransaction &tx = *block.vtx[i];\n+\n+        if (i > 0)\n+        {\n+            for (unsigned int j = 0; j < tx.vin.size(); j++)\n+                UpdateAddressIndex(blockundo.vtxundo[i-1].vprevout[j].txout, tx.vin[j].prevout, !fConnect);\n+        }\n+\n+        for (unsigned int j = 0; j < tx.vout.size(); j++)\n+        {\n+            CTxOut& txout = const_cast<CTxOut&>(tx.vout[j]);\n+            const COutPoint outpoint(tx.GetHash(),((uint32_t)j));\n+            UpdateAddressIndex(txout, outpoint, fConnect);\n+        }\n+\n+        if (fConnect)\n+        {\n+            if (i == block.vtx.size() - 1)\n+                break;\n+            i++;\n+        }\n+        else\n+        {\n+            if (i == 0)\n+                break;\n+            i--;\n+        }\n+    }\n+}\n+\n /** Update chainActive and related internal data structures. */\n void static UpdateTip(CBlockIndex *pindexNew, const CChainParams& chainParams) {\n     chainActive.SetTip(pindexNew);\n@@ -2098,11 +2152,13 @@ bool static DisconnectTip(CValidationState& state, const CChainParams& chainpara\n     // Apply the block atomically to the chain state.\n     int64_t nStart = GetTimeMicros();\n     {\n+        CBlockUndo blockUndo;\n         CCoinsViewCache view(pcoinsTip);\n-        if (!DisconnectBlock(block, state, pindexDelete, view))\n+        if (!DisconnectBlock(block, state, pindexDelete, view, blockUndo))\n             return error(\"DisconnectTip(): DisconnectBlock %s failed\", pindexDelete->GetBlockHash().ToString());\n         bool flushed = view.Flush();\n         assert(flushed);\n+        UpdateAddressIndex(block, blockUndo, false);\n     }\n     LogPrint(\"bench\", \"- Disconnect block: %.2fms\\n\", (GetTimeMicros() - nStart) * 0.001);\n     // Write the chain state to disk, if necessary.\n@@ -2181,8 +2237,9 @@ bool static ConnectTip(CValidationState& state, const CChainParams& chainparams,\n     int64_t nTime3;\n     LogPrint(\"bench\", \"  - Load block from disk: %.2fms [%.2fs]\\n\", (nTime2 - nTime1) * 0.001, nTimeReadFromDisk * 0.000001);\n     {\n+        CBlockUndo blockundo;\n         CCoinsViewCache view(pcoinsTip);\n-        bool rv = ConnectBlock(blockConnecting, state, pindexNew, view, chainparams);\n+        bool rv = ConnectBlock(blockConnecting, state, pindexNew, view, chainparams, blockundo);\n         GetMainSignals().BlockChecked(blockConnecting, state);\n         if (!rv) {\n             if (state.IsInvalid())\n@@ -2193,6 +2250,7 @@ bool static ConnectTip(CValidationState& state, const CChainParams& chainparams,\n         LogPrint(\"bench\", \"  - Connect total: %.2fms [%.2fs]\\n\", (nTime3 - nTime2) * 0.001, nTimeConnectTotal * 0.000001);\n         bool flushed = view.Flush();\n         assert(flushed);\n+        UpdateAddressIndex(*pblock, blockundo, true);\n     }\n     int64_t nTime4 = GetTimeMicros(); nTimeFlush += nTime4 - nTime3;\n     LogPrint(\"bench\", \"  - Flush: %.2fms [%.2fs]\\n\", (nTime4 - nTime3) * 0.001, nTimeFlush * 0.000001);\n@@ -3150,6 +3208,7 @@ bool TestBlockValidity(CValidationState& state, const CChainParams& chainparams,\n         return error(\"%s: CheckIndexAgainstCheckpoint(): %s\", __func__, state.GetRejectReason().c_str());\n \n     CCoinsViewCache viewNew(pcoinsTip);\n+    CBlockUndo blockundo;\n     CBlockIndex indexDummy(block);\n     indexDummy.pprev = pindexPrev;\n     indexDummy.nHeight = pindexPrev->nHeight + 1;\n@@ -3161,7 +3220,7 @@ bool TestBlockValidity(CValidationState& state, const CChainParams& chainparams,\n         return error(\"%s: Consensus::CheckBlock: %s\", __func__, FormatStateMessage(state));\n     if (!ContextualCheckBlock(block, state, chainparams.GetConsensus(), pindexPrev))\n         return error(\"%s: Consensus::ContextualCheckBlock: %s\", __func__, FormatStateMessage(state));\n-    if (!ConnectBlock(block, state, &indexDummy, viewNew, chainparams, true))\n+    if (!ConnectBlock(block, state, &indexDummy, viewNew, chainparams, blockundo, true))\n         return false;\n     assert(state.IsValid());\n \n@@ -3516,7 +3575,8 @@ bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CCoinsView *coinsview,\n         // check level 3: check for inconsistencies during memory-only disconnect of tip blocks\n         if (nCheckLevel >= 3 && pindex == pindexState && (coins.DynamicMemoryUsage() + pcoinsTip->DynamicMemoryUsage()) <= nCoinCacheUsage) {\n             bool fClean = true;\n-            if (!DisconnectBlock(block, state, pindex, coins, &fClean))\n+            CBlockUndo undo;\n+            if (!DisconnectBlock(block, state, pindex, coins, undo, &fClean))\n                 return error(\"VerifyDB(): *** irrecoverable inconsistency in block data at %d, hash=%s\", pindex->nHeight, pindex->GetBlockHash().ToString());\n             pindexState = pindex->pprev;\n             if (!fClean) {\n@@ -3539,9 +3599,10 @@ bool CVerifyDB::VerifyDB(const CChainParams& chainparams, CCoinsView *coinsview,\n             uiInterface.ShowProgress(_(\"Verifying blocks...\"), std::max(1, std::min(99, 100 - (int)(((double)(chainActive.Height() - pindex->nHeight)) / (double)nCheckDepth * 50))));\n             pindex = chainActive.Next(pindex);\n             CBlock block;\n+            CBlockUndo undo;\n             if (!ReadBlockFromDisk(block, pindex, chainparams.GetConsensus()))\n                 return error(\"VerifyDB(): *** ReadBlockFromDisk failed at %d, hash=%s\", pindex->nHeight, pindex->GetBlockHash().ToString());\n-            if (!ConnectBlock(block, state, pindex, coins, chainparams))\n+            if (!ConnectBlock(block, state, pindex, coins, chainparams, undo))\n                 return error(\"VerifyDB(): *** found unconnectable block at %d, hash=%s\", pindex->nHeight, pindex->GetBlockHash().ToString());\n         }\n     }"
      },
      {
        "sha": "ebd3a21dd7e110c08a7960b631b315ed8bed3134",
        "filename": "src/validation.h",
        "status": "modified",
        "additions": 19,
        "deletions": 2,
        "changes": 21,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/f277cf567fb9f3acf4430f68545316268f500ece/src/validation.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/f277cf567fb9f3acf4430f68545316268f500ece/src/validation.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.h?ref=f277cf567fb9f3acf4430f68545316268f500ece",
        "patch": "@@ -13,6 +13,7 @@\n #include \"amount.h\"\n #include \"chain.h\"\n #include \"coins.h\"\n+#include \"coinsbyscript.h\"\n #include \"protocol.h\" // For CMessageHeader::MessageStartChars\n #include \"script/script_error.h\"\n #include \"sync.h\"\n@@ -34,6 +35,7 @@\n \n class CBlockIndex;\n class CBlockTreeDB;\n+class CBlockUndo;\n class CBloomFilter;\n class CChainParams;\n class CInv;\n@@ -170,6 +172,7 @@ extern std::atomic_bool fImporting;\n extern bool fReindex;\n extern int nScriptCheckThreads;\n extern bool fTxIndex;\n+extern bool fTxOutsByAddressIndex;\n extern bool fIsBareMultisigStd;\n extern bool fRequireStandard;\n extern bool fCheckBlockIndex;\n@@ -476,13 +479,21 @@ bool ContextualCheckBlock(const CBlock& block, CValidationState& state, const Co\n  *  Validity checks that depend on the UTXO set are also done; ConnectBlock()\n  *  can fail if those validity checks fail (among other reasons). */\n bool ConnectBlock(const CBlock& block, CValidationState& state, CBlockIndex* pindex, CCoinsViewCache& coins,\n-                  const CChainParams& chainparams, bool fJustCheck = false);\n+                  const CChainParams& chainparams, CBlockUndo& blockundo, bool fJustCheck = false);\n \n /** Undo the effects of this block (with given index) on the UTXO set represented by coins.\n  *  In case pfClean is provided, operation will try to be tolerant about errors, and *pfClean\n  *  will be true if no problems were found. Otherwise, the return value will be false in case\n  *  of problems. Note that in any case, coins may be modified. */\n-bool DisconnectBlock(const CBlock& block, CValidationState& state, const CBlockIndex* pindex, CCoinsViewCache& coins, bool* pfClean = NULL);\n+bool DisconnectBlock(const CBlock& block, CValidationState& state, const CBlockIndex* pindex, CCoinsViewCache& coins, CBlockUndo& blockUndo, bool* pfClean = NULL);\n+\n+/** Context-independent validity checks */\n+bool CheckBlockHeader(const CBlockHeader& block, CValidationState& state, bool fCheckPOW = true);\n+bool CheckBlock(const CBlock& block, CValidationState& state, bool fCheckPOW = true, bool fCheckMerkleRoot = true);\n+\n+/** Context-dependent validity checks */\n+bool ContextualCheckBlockHeader(const CBlockHeader& block, CValidationState& state, CBlockIndex *pindexPrev);\n+bool ContextualCheckBlock(const CBlock& block, CValidationState& state, CBlockIndex *pindexPrev);\n \n /** Check a block is completely valid from start to finish (only works on top of our current best block, with cs_main held) */\n bool TestBlockValidity(CValidationState& state, const CChainParams& chainparams, const CBlock& block, CBlockIndex* pindexPrev, bool fCheckPOW = true, bool fCheckMerkleRoot = true);\n@@ -525,6 +536,12 @@ extern CChain chainActive;\n /** Global variable that points to the active CCoinsView (protected by cs_main) */\n extern CCoinsViewCache *pcoinsTip;\n \n+/** Global variable that points to the active CCoinsView (protected by cs_main) */\n+extern CCoinsViewDB *pcoinsdbview;\n+\n+/** Only used if -txoutsbyaddressindex */\n+extern CCoinsViewByScript *pcoinsByScript;\n+\n /** Global variable that points to the active block tree (protected by cs_main) */\n extern CBlockTreeDB *pblocktree;\n "
      }
    ]
  },
  {
    "sha": "80337066b26b6091903e6bd1e6d8b701414ea73a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4MDMzNzA2NmIyNmI2MDkxOTAzZTZiZDFlNmQ4YjcwMTQxNGVhNzNh",
    "commit": {
      "author": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2016-09-03T09:11:34Z"
      },
      "committer": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2017-01-04T00:49:21Z"
      },
      "message": "move txoutsbyaddress index to its own database",
      "tree": {
        "sha": "eb24a8acad5bcf8894e86d6768edbd9c65c75e20",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/eb24a8acad5bcf8894e86d6768edbd9c65c75e20"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/80337066b26b6091903e6bd1e6d8b701414ea73a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/80337066b26b6091903e6bd1e6d8b701414ea73a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/80337066b26b6091903e6bd1e6d8b701414ea73a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/80337066b26b6091903e6bd1e6d8b701414ea73a/comments",
    "author": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f277cf567fb9f3acf4430f68545316268f500ece",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f277cf567fb9f3acf4430f68545316268f500ece",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f277cf567fb9f3acf4430f68545316268f500ece"
      }
    ],
    "stats": {
      "total": 522,
      "additions": 318,
      "deletions": 204
    },
    "files": [
      {
        "sha": "8462cc2800dbcf7d8c0d8fc470b1167649c337e4",
        "filename": "src/coinsbyscript.cpp",
        "status": "modified",
        "additions": 230,
        "deletions": 2,
        "changes": 232,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/80337066b26b6091903e6bd1e6d8b701414ea73a/src/coinsbyscript.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/80337066b26b6091903e6bd1e6d8b701414ea73a/src/coinsbyscript.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinsbyscript.cpp?ref=80337066b26b6091903e6bd1e6d8b701414ea73a",
        "patch": "@@ -1,14 +1,23 @@\n-// Copyright (c) 2014 The Bitcoin developers\n+// Copyright (c) 2014-2016 The Bitcoin developers\n // Distributed under the MIT software license, see the accompanying\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n #include \"coinsbyscript.h\"\n #include \"txdb.h\"\n #include \"hash.h\"\n+#include \"ui_interface.h\"\n \n #include <assert.h>\n \n-CCoinsViewByScript::CCoinsViewByScript(CCoinsViewDB* viewIn) : base(viewIn) { }\n+#include <boost/thread.hpp>\n+\n+using namespace std;\n+\n+static const char DB_COINS_BYSCRIPT = 'd';\n+static const char DB_FLAG = 'F';\n+static const char DB_BEST_BLOCK = 'B';\n+\n+CCoinsViewByScript::CCoinsViewByScript(CCoinsViewByScriptDB* viewIn) : base(viewIn) { }\n \n bool CCoinsViewByScript::GetCoinsByScript(const CScript &script, CCoinsByScript &coins) {\n     const uint160 key = CCoinsViewByScript::getKey(script);\n@@ -48,3 +57,222 @@ CCoinsByScript &CCoinsViewByScript::GetCoinsByScript(const CScript &script, bool\n uint160 CCoinsViewByScript::getKey(const CScript &script) {\n     return Hash160(script);\n }\n+\n+uint256 CCoinsViewByScript::GetBestBlock() const {\n+    return hashBlock;\n+}\n+\n+void CCoinsViewByScript::SetBestBlock(const uint256 &hashBlockIn) {\n+    hashBlock = hashBlockIn;\n+}\n+\n+bool CCoinsViewByScript::Flush() {\n+    bool fOk = base->BatchWrite(this, hashBlock);\n+    return fOk;\n+}\n+\n+CCoinsViewByScriptDB::CCoinsViewByScriptDB(size_t nCacheSize, bool fMemory, bool fWipe) : db(GetDataDir() / \"coinsbyscript\", nCacheSize, fMemory, fWipe, true)\n+{\n+}\n+\n+bool CCoinsViewByScriptDB::GetCoinsByHashOfScript(const uint160 &hash, CCoinsByScript &coins) const {\n+    return db.Read(make_pair(DB_COINS_BYSCRIPT, hash), coins);\n+}\n+\n+bool CCoinsViewByScriptDB::BatchWrite(CCoinsViewByScript* pcoinsViewByScriptIn, const uint256 &hashBlock) {\n+    CDBBatch batch(db);\n+    size_t count = 0;\n+    for (CCoinsMapByScript::iterator it = pcoinsViewByScriptIn->cacheCoinsByScript.begin(); it != pcoinsViewByScriptIn->cacheCoinsByScript.end();) {\n+        if (it->second.IsEmpty())\n+            batch.Erase(make_pair(DB_COINS_BYSCRIPT, it->first));\n+        else\n+            batch.Write(make_pair(DB_COINS_BYSCRIPT, it->first), it->second);\n+        CCoinsMapByScript::iterator itOld = it++;\n+        pcoinsViewByScriptIn->cacheCoinsByScript.erase(itOld);\n+        count++;\n+    }\n+    pcoinsViewByScriptIn->cacheCoinsByScript.clear();\n+\n+    if (!hashBlock.IsNull())\n+        batch.Write(DB_BEST_BLOCK, hashBlock);\n+\n+    LogPrint(\"coindb\", \"Committing %u coin address indexes to coin database...\\n\", (unsigned int)count);\n+    return db.WriteBatch(batch);\n+}\n+\n+bool CCoinsViewByScriptDB::WriteFlag(const std::string &name, bool fValue) {\n+    return db.Write(std::make_pair(DB_FLAG, name), fValue ? '1' : '0');\n+}\n+\n+bool CCoinsViewByScriptDB::ReadFlag(const std::string &name, bool &fValue) {\n+    char ch;\n+    if (!db.Read(std::make_pair(DB_FLAG, name), ch))\n+        return false;\n+    fValue = ch == '1';\n+    return true;\n+}\n+\n+CCoinsViewByScriptDBCursor *CCoinsViewByScriptDB::Cursor() const\n+{\n+    CCoinsViewByScriptDBCursor *i = new CCoinsViewByScriptDBCursor(const_cast<CDBWrapper*>(&db)->NewIterator());\n+    /* It seems that there are no \"const iterators\" for LevelDB.  Since we\n+       only need read operations on it, use a const-cast to get around\n+       that restriction.  */\n+    i->pcursor->Seek(DB_COINS_BYSCRIPT);\n+    if (!i->pcursor->Valid())\n+        // If db empty then set this cursor invalid\n+        i->keyTmp.first = 0;\n+    else\n+        // Cache key of first record\n+        i->pcursor->GetKey(i->keyTmp);\n+    return i;\n+}\n+\n+bool CCoinsViewByScriptDBCursor::GetKey(uint160 &key) const\n+{\n+    // Return cached key\n+    if (keyTmp.first == DB_COINS_BYSCRIPT) {\n+        key = keyTmp.second;\n+        return true;\n+    }\n+    return false;\n+}\n+\n+bool CCoinsViewByScriptDBCursor::GetValue(CCoinsByScript &coins) const\n+{\n+    return pcursor->GetValue(coins);\n+}\n+\n+unsigned int CCoinsViewByScriptDBCursor::GetValueSize() const\n+{\n+    return pcursor->GetValueSize();\n+}\n+\n+bool CCoinsViewByScriptDBCursor::Valid() const\n+{\n+    return keyTmp.first == DB_COINS_BYSCRIPT;\n+}\n+\n+void CCoinsViewByScriptDBCursor::Next()\n+{\n+    pcursor->Next();\n+    if (!pcursor->Valid() || !pcursor->GetKey(keyTmp))\n+        keyTmp.first = 0; // Invalidate cached key after last record so that Valid() and GetKey() return false\n+}\n+\n+bool CCoinsViewByScriptDB::DeleteAllCoinsByScript()\n+{\n+    boost::scoped_ptr<CCoinsViewByScriptDBCursor> pcursor(Cursor());\n+\n+    std::vector<uint160> v;\n+    int64_t i = 0;\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        try {\n+            uint160 hash;\n+            if (!pcursor->GetKey(hash))\n+                break;\n+            v.push_back(hash);\n+            if (v.size() >= 10000)\n+            {\n+                i += v.size();\n+                CDBBatch batch(db);\n+                BOOST_FOREACH(const uint160& hash, v)\n+                    batch.Erase(make_pair(DB_COINS_BYSCRIPT, hash)); // delete\n+                db.WriteBatch(batch);\n+                v.clear();\n+            }\n+\n+            pcursor->Next();\n+        } catch (std::exception &e) {\n+            return error(\"%s : Deserialize or I/O error - %s\", __func__, e.what());\n+        }\n+    }\n+    if (!v.empty())\n+    {\n+        i += v.size();\n+        CDBBatch batch(db);\n+        BOOST_FOREACH(const uint160& hash, v)\n+            batch.Erase(make_pair(DB_COINS_BYSCRIPT, hash)); // delete\n+        db.WriteBatch(batch);\n+    }\n+    if (i > 0)\n+        LogPrintf(\"Address index with %d addresses successfully deleted.\\n\", i);\n+\n+    return true;\n+}\n+\n+bool CCoinsViewByScriptDB::GenerateAllCoinsByScript(CCoinsViewDB* coinsIn)\n+{\n+    LogPrintf(\"Building address index for -txoutsbyaddressindex. Be patient...\\n\");\n+    int64_t nTxCount = coinsIn->CountCoins();\n+\n+    boost::scoped_ptr<CCoinsViewCursor> pcursor(coinsIn->Cursor());\n+\n+    CCoinsMapByScript mapCoinsByScript;\n+    int64_t i = 0;\n+    int64_t progress = 0;\n+    while (pcursor->Valid()) {\n+        boost::this_thread::interruption_point();\n+        try {\n+            if (progress % 1000 == 0 && nTxCount > 0)\n+                uiInterface.ShowProgress(_(\"Building address index...\"), (int)(((double)progress / (double)nTxCount) * (double)100));\n+            progress++;\n+\n+            uint256 txhash;\n+            CCoins coins;\n+            if (!pcursor->GetKey(txhash) || !pcursor->GetValue(coins))\n+                break;\n+\n+            for (unsigned int j = 0; j < coins.vout.size(); j++)\n+            {\n+                if (coins.vout[j].IsNull() || coins.vout[j].scriptPubKey.IsUnspendable())\n+                    continue;\n+\n+                const uint160 key = CCoinsViewByScript::getKey(coins.vout[j].scriptPubKey);\n+                if (!mapCoinsByScript.count(key))\n+                {\n+                    CCoinsByScript coinsByScript;\n+                    GetCoinsByHashOfScript(key, coinsByScript);\n+                    mapCoinsByScript.insert(make_pair(key, coinsByScript));\n+                }\n+                mapCoinsByScript[key].setCoins.insert(COutPoint(txhash, (uint32_t)j));\n+                i++;\n+            }\n+\n+            if (mapCoinsByScript.size() >= 10000)\n+            {\n+                CDBBatch batch(db);\n+                for (CCoinsMapByScript::iterator it = mapCoinsByScript.begin(); it != mapCoinsByScript.end();) {\n+                    if (it->second.IsEmpty())\n+                        batch.Erase(make_pair(DB_COINS_BYSCRIPT, it->first));\n+                    else\n+                        batch.Write(make_pair(DB_COINS_BYSCRIPT, it->first), it->second);\n+                    CCoinsMapByScript::iterator itOld = it++;\n+                    mapCoinsByScript.erase(itOld);\n+                }\n+                db.WriteBatch(batch);\n+                mapCoinsByScript.clear();\n+            }\n+\n+            pcursor->Next();\n+        } catch (std::exception &e) {\n+            return error(\"%s : Deserialize or I/O error - %s\", __func__, e.what());\n+        }\n+    }\n+    if (!mapCoinsByScript.empty())\n+    {\n+       CDBBatch batch(db);\n+       for (CCoinsMapByScript::iterator it = mapCoinsByScript.begin(); it != mapCoinsByScript.end();) {\n+           if (it->second.IsEmpty())\n+               batch.Erase(make_pair(DB_COINS_BYSCRIPT, it->first));\n+           else\n+               batch.Write(make_pair(DB_COINS_BYSCRIPT, it->first), it->second);\n+           CCoinsMapByScript::iterator itOld = it++;\n+           mapCoinsByScript.erase(itOld);\n+       }\n+       db.WriteBatch(batch);\n+    }\n+    LogPrintf(\"Address index with %d outputs successfully built.\\n\", i);\n+    return true;\n+}"
      },
      {
        "sha": "5a2d12943ea2dbdcc58dbf1870189a8d56065da8",
        "filename": "src/coinsbyscript.h",
        "status": "modified",
        "additions": 58,
        "deletions": 4,
        "changes": 62,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/80337066b26b6091903e6bd1e6d8b701414ea73a/src/coinsbyscript.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/80337066b26b6091903e6bd1e6d8b701414ea73a/src/coinsbyscript.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinsbyscript.h?ref=80337066b26b6091903e6bd1e6d8b701414ea73a",
        "patch": "@@ -1,16 +1,18 @@\n-// Copyright (c) 2014 The Bitcoin developers\n+// Copyright (c) 2014-2016 The Bitcoin developers\n // Distributed under the MIT software license, see the accompanying\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n #ifndef BITCOIN_COINSBYSCRIPT_H\n #define BITCOIN_COINSBYSCRIPT_H\n \n #include \"coins.h\"\n+#include \"dbwrapper.h\"\n #include \"primitives/transaction.h\"\n #include \"serialize.h\"\n #include \"uint256.h\"\n \n class CCoinsViewDB;\n+class CCoinsViewByScriptDB;\n class CScript;\n \n class CCoinsByScript\n@@ -43,11 +45,13 @@ typedef std::map<uint160, CCoinsByScript> CCoinsMapByScript; // uint160 = hash o\n class CCoinsViewByScript\n {\n private:\n-    CCoinsViewDB *base;\n+    CCoinsViewByScriptDB *base;\n+\n+    mutable uint256 hashBlock;\n \n public:\n-    CCoinsMapByScript cacheCoinsByScript; // accessed also from CCoinsViewDB in txdb.cpp\n-    CCoinsViewByScript(CCoinsViewDB* baseIn);\n+    CCoinsMapByScript cacheCoinsByScript; // accessed also from CCoinsViewByScriptDB\n+    CCoinsViewByScript(CCoinsViewByScriptDB* baseIn);\n \n     bool GetCoinsByScript(const CScript &script, CCoinsByScript &coins);\n \n@@ -56,8 +60,58 @@ class CCoinsViewByScript\n \n     static uint160 getKey(const CScript &script); // we use the hash of the script as key in the database\n \n+    void SetBestBlock(const uint256 &hashBlock);\n+    uint256 GetBestBlock() const;\n+\n+    /**\n+     * Push the modifications applied to this cache to its base.\n+     * Failure to call this method before destruction will cause the changes to be forgotten.\n+     * If false is returned, the state of this cache (and its backing view) will be undefined.\n+     */\n+    bool Flush();\n+\n private:\n     CCoinsMapByScript::iterator FetchCoinsByScript(const CScript &script, bool fRequireExisting);\n };\n \n+/** Cursor for iterating over a CCoinsViewByScriptDB */\n+class CCoinsViewByScriptDBCursor \n+{\n+public:\n+    ~CCoinsViewByScriptDBCursor() {}\n+\n+    bool GetKey(uint160 &key) const;\n+    bool GetValue(CCoinsByScript &coins) const;\n+    unsigned int GetValueSize() const;\n+\n+    bool Valid() const;\n+    void Next();\n+\n+private:\n+    CCoinsViewByScriptDBCursor(CDBIterator* pcursorIn):\n+        pcursor(pcursorIn) {}\n+    uint256 hashBlock;\n+    boost::scoped_ptr<CDBIterator> pcursor;\n+    std::pair<char, uint160> keyTmp;\n+\n+    friend class CCoinsViewByScriptDB;\n+};\n+\n+/** coinsbyscript database (coinsbyscript/) */\n+class CCoinsViewByScriptDB \n+{\n+protected:\n+    CDBWrapper db;\n+public:\n+    CCoinsViewByScriptDB(size_t nCacheSize, bool fMemory = false, bool fWipe = false);\n+\n+    bool GetCoinsByHashOfScript(const uint160 &hash, CCoinsByScript &coins) const;\n+    bool BatchWrite(CCoinsViewByScript* pcoinsViewByScriptIn, const uint256 &hashBlock);\n+    bool WriteFlag(const std::string &name, bool fValue);\n+    bool ReadFlag(const std::string &name, bool &fValue);\n+    bool DeleteAllCoinsByScript();   // removes txoutsbyaddressindex\n+    bool GenerateAllCoinsByScript(CCoinsViewDB* coinsIn); // creates txoutsbyaddressindex\n+    CCoinsViewByScriptDBCursor *Cursor() const;\n+};\n+\n #endif // BITCOIN_COINSBYSCRIPT_H"
      },
      {
        "sha": "34328955b453e6c7af3fe732a32e3358e59df8f2",
        "filename": "src/coinstats.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 5,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/80337066b26b6091903e6bd1e6d8b701414ea73a/src/coinstats.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/80337066b26b6091903e6bd1e6d8b701414ea73a/src/coinstats.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinstats.cpp?ref=80337066b26b6091903e6bd1e6d8b701414ea73a",
        "patch": "@@ -12,7 +12,7 @@\n using namespace std;\n \n //! Calculate statistics about the unspent transaction output set\n-bool GetUTXOStats(CCoinsView *view, CCoinsViewDB *viewdb, CCoinsStats &stats)\n+bool GetUTXOStats(CCoinsView *view, CCoinsViewByScriptDB *viewbyscriptdb, CCoinsStats &stats)\n {\n     boost::scoped_ptr<CCoinsViewCursor> pcursor(view->Cursor());\n \n@@ -50,13 +50,12 @@ bool GetUTXOStats(CCoinsView *view, CCoinsViewDB *viewdb, CCoinsStats &stats)\n     stats.hashSerialized = ss.GetHash();\n     stats.nTotalAmount = nTotalAmount;\n \n-    boost::scoped_ptr<CDBIterator> pcursordb(viewdb->RawCursor());\n-    pcursordb->Seek('d');\n+    boost::scoped_ptr<CCoinsViewByScriptDBCursor> pcursordb(viewbyscriptdb->Cursor());\n     while (pcursordb->Valid()) {\n         boost::this_thread::interruption_point();\n-        std::pair<char, uint160> key;\n+        uint160 hash;\n         CCoinsByScript coinsByScript;\n-        if (pcursordb->GetKey(key) && key.first == 'd' && pcursordb->GetValue(coinsByScript)) {\n+        if (pcursordb->GetKey(hash) && pcursordb->GetValue(coinsByScript)) {\n             stats.nAddresses++;\n             stats.nAddressesOutputs += coinsByScript.setCoins.size();\n         } else {"
      },
      {
        "sha": "bac4f3db34e4844200b9a3fbbb271ef2884a3026",
        "filename": "src/coinstats.h",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/80337066b26b6091903e6bd1e6d8b701414ea73a/src/coinstats.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/80337066b26b6091903e6bd1e6d8b701414ea73a/src/coinstats.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinstats.h?ref=80337066b26b6091903e6bd1e6d8b701414ea73a",
        "patch": "@@ -7,6 +7,7 @@\n \n #include \"coins.h\"\n #include \"txdb.h\"\n+#include \"coinsbyscript.h\"\n \n struct CCoinsStats\n {\n@@ -23,6 +24,6 @@ struct CCoinsStats\n     CCoinsStats() : nHeight(0), nTransactions(0), nTransactionOutputs(0), nAddresses(0), nAddressesOutputs(0), nSerializedSize(0), nTotalAmount(0) {}\n };\n \n-bool GetUTXOStats(CCoinsView *view, CCoinsViewDB *viewdb, CCoinsStats &stats);\n+bool GetUTXOStats(CCoinsView *view, CCoinsViewByScriptDB *viewbyscriptdb, CCoinsStats &stats);\n \n #endif // BITCOIN_COINSTATS_H"
      },
      {
        "sha": "979708306fb3f72c01023d15d3cabc4e20afada8",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 12,
        "deletions": 11,
        "changes": 23,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/80337066b26b6091903e6bd1e6d8b701414ea73a/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/80337066b26b6091903e6bd1e6d8b701414ea73a/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=80337066b26b6091903e6bd1e6d8b701414ea73a",
        "patch": "@@ -166,6 +166,7 @@ class CCoinsViewErrorCatcher : public CCoinsViewBacked\n     // Writes do not need similar protection, as failure to write is handled by the caller.\n };\n \n+static CCoinsViewDB *pcoinsdbview = NULL;\n static CCoinsViewErrorCatcher *pcoinscatcher = NULL;\n static std::unique_ptr<ECCVerifyHandle> globalVerifyHandle;\n \n@@ -235,6 +236,8 @@ void Shutdown()\n         pcoinsdbview = NULL;\n         delete pcoinsByScript;\n         pcoinsByScript = NULL;\n+        delete pcoinsByScriptDB;\n+        pcoinsByScriptDB = NULL;\n         delete pblocktree;\n         pblocktree = NULL;\n     }\n@@ -1364,6 +1367,7 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n \n                 pblocktree = new CBlockTreeDB(nBlockTreeDBCache, false, fReindex);\n                 pcoinsdbview = new CCoinsViewDB(nCoinDBCache, false, fReindex || fReindexChainState);\n+                pcoinsByScriptDB = new CCoinsViewByScriptDB(nCoinDBCache, false, false);\n                 pcoinscatcher = new CCoinsViewErrorCatcher(pcoinsdbview);\n                 pcoinsTip = new CCoinsViewCache(pcoinscatcher);\n \n@@ -1412,26 +1416,26 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n                 }\n \n                 // Check -txoutsbyaddressindex\n-                pcoinsdbview->ReadFlag(\"txoutsbyaddressindex\", fTxOutsByAddressIndex);\n+                pcoinsByScriptDB->ReadFlag(\"txoutsbyaddressindex\", fTxOutsByAddressIndex);\n                 if (IsArgSet(\"-txoutsbyaddressindex\"))\n                 {\n                     if (GetBoolArg(\"-txoutsbyaddressindex\", false))\n                     {\n                         // build index\n                         if (!fTxOutsByAddressIndex)\n                         {\n-                            if (!pcoinsdbview->DeleteAllCoinsByScript())\n+                            if (!pcoinsByScriptDB->DeleteAllCoinsByScript())\n                             {\n                                 strLoadError = _(\"Error deleting txoutsbyaddressindex\");\n                                 break;\n                             }\n-                            if (!pcoinsdbview->GenerateAllCoinsByScript())\n+                            if (!pcoinsByScriptDB->GenerateAllCoinsByScript(pcoinsdbview))\n                             {\n                                 strLoadError = _(\"Error building txoutsbyaddressindex\");\n                                 break;\n                             }\n                             CCoinsStats stats;\n-                            if (!GetUTXOStats(pcoinsTip, pcoinsdbview, stats))\n+                            if (!GetUTXOStats(pcoinsTip, pcoinsByScriptDB, stats))\n                             {\n                                 strLoadError = _(\"Error GetUTXOStats for txoutsbyaddressindex\");\n                                 break;\n@@ -1441,7 +1445,7 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n                                 strLoadError = _(\"Error compare stats for txoutsbyaddressindex\");\n                                 break;\n                             }\n-                            pcoinsdbview->WriteFlag(\"txoutsbyaddressindex\", true);\n+                            pcoinsByScriptDB->WriteFlag(\"txoutsbyaddressindex\", true);\n                             fTxOutsByAddressIndex = true;\n                         }\n                     }\n@@ -1450,8 +1454,8 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n                         if (fTxOutsByAddressIndex)\n                         {\n                             // remove index\n-                            pcoinsdbview->DeleteAllCoinsByScript();\n-                            pcoinsdbview->WriteFlag(\"txoutsbyaddressindex\", false);\n+                            pcoinsByScriptDB->DeleteAllCoinsByScript();\n+                            pcoinsByScriptDB->WriteFlag(\"txoutsbyaddressindex\", false);\n                             fTxOutsByAddressIndex = false;\n                         }\n                     }\n@@ -1461,10 +1465,7 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n \n                 // Init -txoutsbyaddressindex\n                 if (fTxOutsByAddressIndex)\n-                {\n-                    pcoinsByScript = new CCoinsViewByScript(pcoinsdbview);\n-                    pcoinsdbview->SetCoinsViewByScript(pcoinsByScript);\n-                }\n+                    pcoinsByScript = new CCoinsViewByScript(pcoinsByScriptDB);\n \n                 uiInterface.InitMessage(_(\"Verifying blocks...\"));\n                 if (fHavePruned && GetArg(\"-checkblocks\", DEFAULT_CHECKBLOCKS) > MIN_BLOCKS_TO_KEEP) {"
      },
      {
        "sha": "2276ac5a76535ca4868496eb7da8eef380f2dd9e",
        "filename": "src/rpc/blockchain.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/80337066b26b6091903e6bd1e6d8b701414ea73a/src/rpc/blockchain.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/80337066b26b6091903e6bd1e6d8b701414ea73a/src/rpc/blockchain.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/blockchain.cpp?ref=80337066b26b6091903e6bd1e6d8b701414ea73a",
        "patch": "@@ -793,7 +793,7 @@ UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n \n     CCoinsStats stats;\n     FlushStateToDisk();\n-    if (GetUTXOStats(pcoinsTip, pcoinsdbview, stats)) {\n+    if (GetUTXOStats(pcoinsTip, pcoinsByScriptDB, stats)) {\n         ret.push_back(Pair(\"height\", (int64_t)stats.nHeight));\n         ret.push_back(Pair(\"bestblock\", stats.hashBlock.GetHex()));\n         ret.push_back(Pair(\"transactions\", (int64_t)stats.nTransactions));"
      },
      {
        "sha": "280c3465dad981e7c2c181a82bf14d578f45c1e1",
        "filename": "src/txdb.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 166,
        "changes": 168,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/80337066b26b6091903e6bd1e6d8b701414ea73a/src/txdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/80337066b26b6091903e6bd1e6d8b701414ea73a/src/txdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txdb.cpp?ref=80337066b26b6091903e6bd1e6d8b701414ea73a",
        "patch": "@@ -30,21 +30,12 @@ static const char DB_LAST_BLOCK = 'l';\n \n CCoinsViewDB::CCoinsViewDB(size_t nCacheSize, bool fMemory, bool fWipe) : db(GetDataDir() / \"chainstate\", nCacheSize, fMemory, fWipe, true)\n {\n-    pcoinsViewByScript = NULL;\n-}\n-\n-void CCoinsViewDB::SetCoinsViewByScript(CCoinsViewByScript* pcoinsViewByScriptIn) {\n-    pcoinsViewByScript = pcoinsViewByScriptIn;\n }\n \n bool CCoinsViewDB::GetCoins(const uint256 &txid, CCoins &coins) const {\n     return db.Read(make_pair(DB_COINS, txid), coins);\n }\n \n-bool CCoinsViewDB::GetCoinsByHashOfScript(const uint160 &hash, CCoinsByScript &coins) const {\n-    return db.Read(make_pair('d', hash), coins);\n-}\n-\n bool CCoinsViewDB::HaveCoins(const uint256 &txid) const {\n     return db.Exists(make_pair(DB_COINS, txid));\n }\n@@ -72,37 +63,13 @@ bool CCoinsViewDB::BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock) {\n         CCoinsMap::iterator itOld = it++;\n         mapCoins.erase(itOld);\n     }\n-    if (pcoinsViewByScript) // only if -txoutsbyaddressindex\n-    {\n-        for (CCoinsMapByScript::iterator it = pcoinsViewByScript->cacheCoinsByScript.begin(); it != pcoinsViewByScript->cacheCoinsByScript.end();) {\n-            if (it->second.IsEmpty())\n-                batch.Erase(make_pair('d', it->first));\n-            else\n-                batch.Write(make_pair('d', it->first), it->second);\n-            CCoinsMapByScript::iterator itOld = it++;\n-            pcoinsViewByScript->cacheCoinsByScript.erase(itOld);\n-        }\n-        pcoinsViewByScript->cacheCoinsByScript.clear();\n-    }\n     if (!hashBlock.IsNull())\n         batch.Write(DB_BEST_BLOCK, hashBlock);\n \n     LogPrint(\"coindb\", \"Committing %u changed transactions (out of %u) to coin database...\\n\", (unsigned int)changed, (unsigned int)count);\n     return db.WriteBatch(batch);\n }\n \n-bool CCoinsViewDB::WriteFlag(const std::string &name, bool fValue) {\n-    return db.Write(std::make_pair('F', name), fValue ? '1' : '0');\n-}\n-\n-bool CCoinsViewDB::ReadFlag(const std::string &name, bool &fValue) {\n-    char ch;\n-    if (!db.Read(std::make_pair('F', name), ch))\n-        return false;\n-    fValue = ch == '1';\n-    return true;\n-}\n-\n CBlockTreeDB::CBlockTreeDB(size_t nCacheSize, bool fMemory, bool fWipe) : CDBWrapper(GetDataDir() / \"blocks\" / \"index\", nCacheSize, fMemory, fWipe) {\n }\n \n@@ -126,11 +93,6 @@ bool CBlockTreeDB::ReadLastBlockFile(int &nFile) {\n     return Read(DB_LAST_BLOCK, nFile);\n }\n \n-CDBIterator *CCoinsViewDB::RawCursor() const\n-{\n-    return const_cast<CDBWrapper*>(&db)->NewIterator();\n-}\n-\n CCoinsViewCursor *CCoinsViewDB::Cursor() const\n {\n     CCoinsViewDBCursor *i = new CCoinsViewDBCursor(const_cast<CDBWrapper*>(&db)->NewIterator(), GetBestBlock());\n@@ -175,18 +137,14 @@ void CCoinsViewDBCursor::Next()\n         keyTmp.first = 0; // Invalidate cached key after last record so that Valid() and GetKey() return false\n }\n \n-int64_t CCoinsViewDB::GetPrefixCount(char prefix) const\n+int64_t CCoinsViewDB::CountCoins() const\n {\n-    boost::scoped_ptr<CDBIterator> pcursor(RawCursor());\n-    pcursor->Seek(prefix);\n+    boost::scoped_ptr<CCoinsViewCursor> pcursor(Cursor());\n \n     int64_t i = 0;\n     while (pcursor->Valid()) {\n         boost::this_thread::interruption_point();\n         try {\n-            char key;\n-            if (!pcursor->GetKey(key) || key != prefix)\n-                break;\n             i++;\n             pcursor->Next();\n         } catch (std::exception &e) {\n@@ -196,128 +154,6 @@ int64_t CCoinsViewDB::GetPrefixCount(char prefix) const\n     return i;\n }\n \n-bool CCoinsViewDB::DeleteAllCoinsByScript()\n-{\n-    boost::scoped_ptr<CDBIterator> pcursor(RawCursor());\n-    pcursor->Seek('d');\n-\n-    std::vector<uint160> v;\n-    int64_t i = 0;\n-    while (pcursor->Valid()) {\n-        boost::this_thread::interruption_point();\n-        try {\n-            std::pair<char, uint160> key;\n-            if (!pcursor->GetKey(key) || key.first != 'd')\n-                break;\n-            v.push_back(key.second);\n-            if (v.size() >= 10000)\n-            {\n-                i += v.size();\n-                CDBBatch batch(db);\n-                BOOST_FOREACH(const uint160& hash, v)\n-                    batch.Erase(make_pair('d', hash)); // delete\n-                db.WriteBatch(batch);\n-                v.clear();\n-            }\n-\n-            pcursor->Next();\n-        } catch (std::exception &e) {\n-            return error(\"%s : Deserialize or I/O error - %s\", __func__, e.what());\n-        }\n-    }\n-    if (!v.empty())\n-    {\n-        i += v.size();\n-        CDBBatch batch(db);\n-        BOOST_FOREACH(const uint160& hash, v)\n-            batch.Erase(make_pair('d', hash)); // delete\n-        db.WriteBatch(batch);\n-    }\n-    if (i > 0)\n-        LogPrintf(\"Address index with %d addresses successfully deleted.\\n\", i);\n-\n-    return true;\n-}\n-\n-bool CCoinsViewDB::GenerateAllCoinsByScript()\n-{\n-    LogPrintf(\"Building address index for -txoutsbyaddressindex. Be patient...\\n\");\n-    int64_t nTxCount = GetPrefixCount('c');\n-\n-    boost::scoped_ptr<CDBIterator> pcursor(RawCursor());\n-    pcursor->Seek('c');\n-\n-    CCoinsMapByScript mapCoinsByScript;\n-    int64_t i = 0;\n-    int64_t progress = 0;\n-    while (pcursor->Valid()) {\n-        boost::this_thread::interruption_point();\n-        try {\n-            if (progress % 1000 == 0 && nTxCount > 0)\n-                uiInterface.ShowProgress(_(\"Building address index...\"), (int)(((double)progress / (double)nTxCount) * (double)100));\n-            progress++;\n-\n-            std::pair<char, uint256> key;\n-            CCoins coins;\n-            if (!pcursor->GetKey(key) || key.first != 'c')\n-                break;\n-            uint256 txhash = key.second;\n-            if (!pcursor->GetValue(coins))\n-                break;\n-\n-            for (unsigned int j = 0; j < coins.vout.size(); j++)\n-            {\n-                if (coins.vout[j].IsNull() || coins.vout[j].scriptPubKey.IsUnspendable())\n-                    continue;\n-\n-                const uint160 key = CCoinsViewByScript::getKey(coins.vout[j].scriptPubKey);\n-                if (!mapCoinsByScript.count(key))\n-                {\n-                    CCoinsByScript coinsByScript;\n-                    GetCoinsByHashOfScript(key, coinsByScript);\n-                    mapCoinsByScript.insert(make_pair(key, coinsByScript));\n-                }\n-                mapCoinsByScript[key].setCoins.insert(COutPoint(txhash, (uint32_t)j));\n-                i++;\n-            }\n-\n-            if (mapCoinsByScript.size() >= 10000)\n-            {\n-                CDBBatch batch(db);\n-                for (CCoinsMapByScript::iterator it = mapCoinsByScript.begin(); it != mapCoinsByScript.end();) {\n-                    if (it->second.IsEmpty())\n-                        batch.Erase(make_pair('d', it->first));\n-                    else\n-                        batch.Write(make_pair('d', it->first), it->second);\n-                    CCoinsMapByScript::iterator itOld = it++;\n-                    mapCoinsByScript.erase(itOld);\n-                }\n-                db.WriteBatch(batch);\n-                mapCoinsByScript.clear();\n-            }\n-\n-            pcursor->Next();\n-        } catch (std::exception &e) {\n-            return error(\"%s : Deserialize or I/O error - %s\", __func__, e.what());\n-        }\n-    }\n-    if (!mapCoinsByScript.empty())\n-    {\n-       CDBBatch batch(db);\n-       for (CCoinsMapByScript::iterator it = mapCoinsByScript.begin(); it != mapCoinsByScript.end();) {\n-           if (it->second.IsEmpty())\n-               batch.Erase(make_pair('d', it->first));\n-           else\n-               batch.Write(make_pair('d', it->first), it->second);\n-           CCoinsMapByScript::iterator itOld = it++;\n-           mapCoinsByScript.erase(itOld);\n-       }\n-       db.WriteBatch(batch);\n-    }\n-    LogPrintf(\"Address index with %d outputs successfully built.\\n\", i);\n-    return true;\n-}\n-\n bool CBlockTreeDB::WriteBatchSync(const std::vector<std::pair<int, const CBlockFileInfo*> >& fileInfo, int nLastFile, const std::vector<const CBlockIndex*>& blockinfo) {\n     CDBBatch batch(*this);\n     for (std::vector<std::pair<int, const CBlockFileInfo*> >::const_iterator it=fileInfo.begin(); it != fileInfo.end(); it++) {"
      },
      {
        "sha": "11722e6d89c77cedad46e7f0c80e8600f8160848",
        "filename": "src/txdb.h",
        "status": "modified",
        "additions": 1,
        "deletions": 10,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/80337066b26b6091903e6bd1e6d8b701414ea73a/src/txdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/80337066b26b6091903e6bd1e6d8b701414ea73a/src/txdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txdb.h?ref=80337066b26b6091903e6bd1e6d8b701414ea73a",
        "patch": "@@ -65,25 +65,16 @@ struct CDiskTxPos : public CDiskBlockPos\n /** CCoinsView backed by the coin database (chainstate/) */\n class CCoinsViewDB : public CCoinsView\n {\n-private:\n-    CCoinsViewByScript* pcoinsViewByScript;\n protected:\n     CDBWrapper db;\n public:\n     CCoinsViewDB(size_t nCacheSize, bool fMemory = false, bool fWipe = false);\n \n     bool GetCoins(const uint256 &txid, CCoins &coins) const;\n-    bool GetCoinsByHashOfScript(const uint160 &hash, CCoinsByScript &coins) const;\n     bool HaveCoins(const uint256 &txid) const;\n     uint256 GetBestBlock() const;\n     bool BatchWrite(CCoinsMap &mapCoins, const uint256 &hashBlock);\n-    bool WriteFlag(const std::string &name, bool fValue);\n-    bool ReadFlag(const std::string &name, bool &fValue);\n-    int64_t GetPrefixCount(char prefix) const;\n-    bool DeleteAllCoinsByScript();   // removes txoutsbyaddressindex\n-    bool GenerateAllCoinsByScript(); // creates txoutsbyaddressindex\n-    void SetCoinsViewByScript(CCoinsViewByScript* pcoinsViewByScriptIn);\n-    CDBIterator *RawCursor() const;\n+    int64_t CountCoins() const;\n     CCoinsViewCursor *Cursor() const;\n };\n "
      },
      {
        "sha": "475d141dc05fd0299232914e3ad77479bc67d367",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 1,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/80337066b26b6091903e6bd1e6d8b701414ea73a/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/80337066b26b6091903e6bd1e6d8b701414ea73a/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=80337066b26b6091903e6bd1e6d8b701414ea73a",
        "patch": "@@ -176,7 +176,7 @@ CBlockIndex* FindForkInGlobalIndex(const CChain& chain, const CBlockLocator& loc\n }\n \n CCoinsViewCache *pcoinsTip = NULL;\n-CCoinsViewDB *pcoinsdbview = NULL;\n+CCoinsViewByScriptDB *pcoinsByScriptDB = NULL;\n CCoinsViewByScript *pcoinsByScript = NULL;\n CBlockTreeDB *pblocktree = NULL;\n \n@@ -1999,6 +1999,10 @@ bool static FlushStateToDisk(CValidationState &state, FlushStateMode mode) {\n         // Flush the chainstate (which may refer to block index entries).\n         if (!pcoinsTip->Flush())\n             return AbortNode(state, \"Failed to write to coin database\");\n+        if (fTxOutsByAddressIndex) {\n+            if (!pcoinsByScript->Flush())\n+                return AbortNode(state, \"Failed to write to coin database\");\n+        }\n         nLastFlush = nNow;\n     }\n     if (fDoFullFlush || ((mode == FLUSH_STATE_ALWAYS || mode == FLUSH_STATE_PERIODIC) && nNow > nLastSetChain + (int64_t)DATABASE_WRITE_INTERVAL * 1000000)) {\n@@ -2075,6 +2079,8 @@ void static UpdateAddressIndex(const CBlock& block, CBlockUndo& blockundo, bool\n             i--;\n         }\n     }\n+\n+    pcoinsByScript->SetBestBlock(block.GetHash());\n }\n \n /** Update chainActive and related internal data structures. */"
      },
      {
        "sha": "419ae90940a5a10320f6abb6ad3f4f2d752b0656",
        "filename": "src/validation.h",
        "status": "modified",
        "additions": 1,
        "deletions": 3,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/80337066b26b6091903e6bd1e6d8b701414ea73a/src/validation.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/80337066b26b6091903e6bd1e6d8b701414ea73a/src/validation.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.h?ref=80337066b26b6091903e6bd1e6d8b701414ea73a",
        "patch": "@@ -536,10 +536,8 @@ extern CChain chainActive;\n /** Global variable that points to the active CCoinsView (protected by cs_main) */\n extern CCoinsViewCache *pcoinsTip;\n \n-/** Global variable that points to the active CCoinsView (protected by cs_main) */\n-extern CCoinsViewDB *pcoinsdbview;\n-\n /** Only used if -txoutsbyaddressindex */\n+extern CCoinsViewByScriptDB *pcoinsByScriptDB;\n extern CCoinsViewByScript *pcoinsByScript;\n \n /** Global variable that points to the active block tree (protected by cs_main) */"
      }
    ]
  },
  {
    "sha": "7458f1839dfef0c4efa5fae759754ba3c3fc3c56",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3NDU4ZjE4MzlkZmVmMGM0ZWZhNWZhZTc1OTc1NGJhM2MzZmMzYzU2",
    "commit": {
      "author": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2016-09-03T09:16:28Z"
      },
      "committer": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2017-01-04T00:49:21Z"
      },
      "message": "add txoutsbyaddress querying via rest interface",
      "tree": {
        "sha": "2f8de5864a05f5966e62405fe4624266aa0a001f",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2f8de5864a05f5966e62405fe4624266aa0a001f"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7458f1839dfef0c4efa5fae759754ba3c3fc3c56",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7458f1839dfef0c4efa5fae759754ba3c3fc3c56",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/7458f1839dfef0c4efa5fae759754ba3c3fc3c56",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7458f1839dfef0c4efa5fae759754ba3c3fc3c56/comments",
    "author": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "80337066b26b6091903e6bd1e6d8b701414ea73a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/80337066b26b6091903e6bd1e6d8b701414ea73a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/80337066b26b6091903e6bd1e6d8b701414ea73a"
      }
    ],
    "stats": {
      "total": 246,
      "additions": 193,
      "deletions": 53
    },
    "files": [
      {
        "sha": "01a7ed77819fe89da5f9622e5a9125bf4a50b0fd",
        "filename": "src/rest.cpp",
        "status": "modified",
        "additions": 135,
        "deletions": 0,
        "changes": 135,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7458f1839dfef0c4efa5fae759754ba3c3fc3c56/src/rest.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7458f1839dfef0c4efa5fae759754ba3c3fc3c56/src/rest.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rest.cpp?ref=7458f1839dfef0c4efa5fae759754ba3c3fc3c56",
        "patch": "@@ -3,6 +3,7 @@\n // Distributed under the MIT software license, see the accompanying\n // file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \n+#include \"base58.h\"\n #include \"chain.h\"\n #include \"chainparams.h\"\n #include \"primitives/block.h\"\n@@ -24,6 +25,7 @@\n using namespace std;\n \n static const size_t MAX_GETUTXOS_OUTPOINTS = 15; //allow a max of 15 outpoints to be queried at once\n+static const size_t MAX_GETTXOUTSBYADDRESS_SCRIPTS = 15; //allow a max of 15 scripts to be queried at once\n \n enum RetFormat {\n     RF_UNDEF,\n@@ -63,6 +65,7 @@ extern UniValue blockToJSON(const CBlock& block, const CBlockIndex* blockindex,\n extern UniValue mempoolInfoToJSON();\n extern UniValue mempoolToJSON(bool fVerbose = false);\n extern void ScriptPubKeyToJSON(const CScript& scriptPubKey, UniValue& out, bool fIncludeHex);\n+extern void CoinsByScriptToJSON(const CCoinsByScript& coinsByScript, int nMinDepth, UniValue& vObjects, vector<pair<int, unsigned int>>& vSort, bool fIncludeHex);\n extern UniValue blockheaderToJSON(const CBlockIndex* blockindex);\n \n static bool RESTERR(HTTPRequest* req, enum HTTPStatusCode status, string message)\n@@ -600,6 +603,137 @@ static bool rest_getutxos(HTTPRequest* req, const std::string& strURIPart)\n     return true; // continue to process further HTTP reqs on this cxn\n }\n \n+static bool rest_gettxoutsbyaddress(HTTPRequest* req, const std::string& strURIPart)\n+{\n+    if (!CheckWarmup(req))\n+        return false;\n+    if (!fTxOutsByAddressIndex)\n+        return RESTERR(req, HTTP_BAD_REQUEST, \"To use this function, you must start bitcoin with the -txoutsbyaddressindex parameter.\");\n+\n+    std::string param;\n+    const RetFormat rf = ParseDataFormat(param, strURIPart);\n+\n+    vector<string> uriParts;\n+    if (param.length() > 1)\n+    {\n+        std::string strUriParams = param.substr(1);\n+        boost::split(uriParts, strUriParams, boost::is_any_of(\"/\"));\n+    }\n+\n+    // throw exception in case of a empty request\n+    std::string strRequestMutable = req->ReadBody();\n+    if (strRequestMutable.length() == 0 && uriParts.size() == 0)\n+        return RESTERR(req, HTTP_BAD_REQUEST, \"Error: empty request\");\n+\n+    bool fInputParsed = false;\n+    bool fCheckMemPool = false;\n+    vector<CScript> vScripts;\n+\n+    // parse/deserialize input\n+    // input-format = output-format, rest/gettxoutsbyaddress/bin requires binary input, gives binary output, ...\n+\n+    if (uriParts.size() > 0)\n+    {\n+\n+        //inputs is sent over URI scheme (/rest/gettxoutsbyaddress/checkmempool/addr1/addr2/...)\n+        if (uriParts.size() > 0 && uriParts[0] == \"checkmempool\")\n+            fCheckMemPool = true;\n+\n+        for (size_t i = (fCheckMemPool) ? 1 : 0; i < uriParts.size(); i++)\n+        {\n+            CScript script;\n+            CBitcoinAddress address(uriParts[i]);\n+            if (address.IsValid()) {\n+                script = GetScriptForDestination(address.Get());\n+            } else if (IsHex(uriParts[i])) {\n+                std::vector<unsigned char> data(ParseHex(uriParts[i]));\n+                script = CScript(data.begin(), data.end());\n+            } else {\n+                return RESTERR(req, HTTP_BAD_REQUEST, \"Invalid Bitcoin address or script: \" + uriParts[i]);\n+            }\n+\n+            vScripts.push_back(script);\n+        }\n+\n+        if (vScripts.size() > 0)\n+            fInputParsed = true;\n+        else\n+            return RESTERR(req, HTTP_BAD_REQUEST, \"Error: empty request\");\n+    }\n+\n+    switch (rf) {\n+    case RF_HEX: {\n+        // convert hex to bin, continue then with bin part\n+        std::vector<unsigned char> strRequestV = ParseHex(strRequestMutable);\n+        strRequestMutable.assign(strRequestV.begin(), strRequestV.end());\n+    }\n+\n+    case RF_BINARY: {\n+        try {\n+            //deserialize only if user sent a request\n+            if (strRequestMutable.size() > 0)\n+            {\n+                if (fInputParsed) //don't allow sending input over URI and HTTP RAW DATA\n+                    return RESTERR(req, HTTP_BAD_REQUEST, \"Combination of URI scheme inputs and raw post data is not allowed\");\n+\n+                CDataStream oss(SER_NETWORK, PROTOCOL_VERSION);\n+                oss << strRequestMutable;\n+                oss >> fCheckMemPool;\n+                //DN: TODO: fix serialization\n+                //oss >> vScripts;\n+            }\n+        } catch (const std::ios_base::failure& e) {\n+            // abort in case of unreadable binary data\n+            return RESTERR(req, HTTP_BAD_REQUEST, \"Parse error\");\n+        }\n+        break;\n+    }\n+\n+    case RF_JSON: {\n+        if (!fInputParsed)\n+            return RESTERR(req, HTTP_BAD_REQUEST, \"Error: empty request\");\n+        break;\n+    }\n+    default: {\n+        return RESTERR(req, HTTP_NOT_FOUND, \"output format not found (available: \" + AvailableDataFormatsString() + \")\");\n+    }\n+    }\n+\n+    // limit max scriptis\n+    if (vScripts.size() > MAX_GETTXOUTSBYADDRESS_SCRIPTS)\n+        return RESTERR(req, HTTP_BAD_REQUEST, strprintf(\"Error: max scripts exceeded (max: %d, tried: %d)\", MAX_GETTXOUTSBYADDRESS_SCRIPTS, vScripts.size()));\n+\n+    int nMinDepth = fCheckMemPool ? 0 : 1;\n+    UniValue vObjects(UniValue::VARR);\n+    vector<pair<int, unsigned int> > vSort;\n+\n+    BOOST_FOREACH(const CScript &script, vScripts)\n+    {\n+        CCoinsByScript coinsByScript;\n+        pcoinsByScript->GetCoinsByScript(script, coinsByScript);\n+\n+        if (nMinDepth == 0)\n+            mempool.GetCoinsByScript(script, coinsByScript);\n+\n+        CoinsByScriptToJSON(coinsByScript, nMinDepth, vObjects, vSort, true); \n+    }\n+\n+    //DN: TODO: BIN and HEX\n+\n+    UniValue results(UniValue::VARR);\n+    sort(vSort.begin(), vSort.end());\n+    for (unsigned int i = 0; i < vSort.size(); i++)\n+    {\n+        results.push_back(vObjects[vSort[i].second]);\n+    }\n+\n+    // return json string\n+    string strJSON = results.write() + \"\\n\";\n+    req->WriteHeader(\"Content-Type\", \"application/json\");\n+    req->WriteReply(HTTP_OK, strJSON);\n+    return true;\n+}\n+\n static const struct {\n     const char* prefix;\n     bool (*handler)(HTTPRequest* req, const std::string& strReq);\n@@ -612,6 +746,7 @@ static const struct {\n       {\"/rest/mempool/contents\", rest_mempool_contents},\n       {\"/rest/headers/\", rest_headers},\n       {\"/rest/getutxos\", rest_getutxos},\n+      {\"/rest/gettxoutsbyaddress\", rest_gettxoutsbyaddress},\n };\n \n bool StartREST()"
      },
      {
        "sha": "c351ee210d79aa4397fd9ed198d03c915a7809b3",
        "filename": "src/rpc/blockchain.cpp",
        "status": "modified",
        "additions": 58,
        "deletions": 53,
        "changes": 111,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7458f1839dfef0c4efa5fae759754ba3c3fc3c56/src/rpc/blockchain.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7458f1839dfef0c4efa5fae759754ba3c3fc3c56/src/rpc/blockchain.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/blockchain.cpp?ref=7458f1839dfef0c4efa5fae759754ba3c3fc3c56",
        "patch": "@@ -48,6 +48,63 @@ static CUpdatedBlock latestblock;\n extern void TxToJSON(const CTransaction& tx, const uint256 hashBlock, UniValue& entry);\n void ScriptPubKeyToJSON(const CScript& scriptPubKey, UniValue& out, bool fIncludeHex);\n \n+void CoinsByScriptToJSON(const CCoinsByScript& coinsByScript, int nMinDepth, UniValue& vObjects, vector<pair<int, unsigned int>>& vSort, bool fIncludeHex)\n+{\n+    BOOST_FOREACH(const COutPoint &outpoint, coinsByScript.setCoins)\n+    {\n+        CCoins coins;\n+        if (nMinDepth == 0)\n+        {\n+            LOCK(mempool.cs);\n+            CCoinsViewMemPool view(pcoinsTip, mempool);\n+            if (!view.GetCoins(outpoint.hash, coins))\n+                continue;\n+            mempool.pruneSpent(outpoint.hash, coins); // TODO: this should be done by the CCoinsViewMemPool\n+        }\n+        else if (!pcoinsTip->GetCoins(outpoint.hash, coins))\n+            continue;\n+\n+        if (outpoint.n < coins.vout.size() && !coins.vout[outpoint.n].IsNull() && !coins.vout[outpoint.n].scriptPubKey.IsUnspendable())\n+        {\n+            // should not happen\n+            if ((unsigned int)coins.nHeight != MEMPOOL_HEIGHT && (!chainActive[coins.nHeight] || !chainActive[coins.nHeight]->phashBlock))\n+                throw JSONRPCError(RPC_INTERNAL_ERROR, \"Internal Error: !chainActive[coins.nHeight]\");\n+\n+            BlockMap::iterator it = mapBlockIndex.find(pcoinsTip->GetBestBlock());\n+            CBlockIndex *pindex = it->second;\n+\n+            int nConfirmations = 0;\n+            if ((unsigned int)coins.nHeight != MEMPOOL_HEIGHT)\n+                nConfirmations = pindex->nHeight - coins.nHeight + 1;\n+            if (nConfirmations < nMinDepth)\n+                continue;\n+\n+            UniValue oScriptPubKey(UniValue::VOBJ);\n+            ScriptPubKeyToJSON(coins.vout[outpoint.n].scriptPubKey, oScriptPubKey, fIncludeHex);\n+\n+            UniValue o(UniValue::VOBJ);\n+            o.push_back(Pair(\"confirmations\", nConfirmations));\n+            o.push_back(Pair(\"txid\", outpoint.hash.GetHex()));\n+            o.push_back(Pair(\"vout\", (int)outpoint.n));\n+            o.push_back(Pair(\"value\", ValueFromAmount(coins.vout[outpoint.n].nValue)));\n+            o.push_back(Pair(\"scriptPubKey\", oScriptPubKey));\n+            o.push_back(Pair(\"version\", coins.nVersion));\n+            o.push_back(Pair(\"coinbase\", coins.fCoinBase));\n+            o.push_back(Pair(\"bestblockhash\", pindex->GetBlockHash().GetHex()));\n+            o.push_back(Pair(\"bestblockheight\", pindex->nHeight));\n+            o.push_back(Pair(\"bestblocktime\", pindex->GetBlockTime()));\n+            if ((unsigned int)coins.nHeight != MEMPOOL_HEIGHT)\n+            {\n+                o.push_back(Pair(\"blockhash\", chainActive[coins.nHeight]->GetBlockHash().GetHex()));\n+                o.push_back(Pair(\"blockheight\", coins.nHeight));\n+                o.push_back(Pair(\"blocktime\", chainActive[coins.nHeight]->GetBlockTime()));\n+            }\n+            vObjects.push_back(o);\n+            vSort.push_back(make_pair(coins.nHeight, (unsigned int)vObjects.size() - 1));\n+        }\n+    }\n+}\n+\n double GetDifficulty(const CBlockIndex* blockindex)\n {\n     // Floating point number that is a multiple of the minimum difficulty,\n@@ -984,59 +1041,7 @@ UniValue gettxoutsbyaddress(const JSONRPCRequest& request)\n         if (nMinDepth == 0)\n             mempool.GetCoinsByScript(script, coinsByScript);\n \n-        BOOST_FOREACH(const COutPoint &outpoint, coinsByScript.setCoins)\n-        {\n-            CCoins coins;\n-            if (nMinDepth == 0)\n-            {\n-                LOCK(mempool.cs);\n-                CCoinsViewMemPool view(pcoinsTip, mempool);\n-                if (!view.GetCoins(outpoint.hash, coins))\n-                    continue;\n-                mempool.pruneSpent(outpoint.hash, coins); // TODO: this should be done by the CCoinsViewMemPool\n-            }\n-            else if (!pcoinsTip->GetCoins(outpoint.hash, coins))\n-                continue;\n-\n-            if (outpoint.n < coins.vout.size() && !coins.vout[outpoint.n].IsNull() && !coins.vout[outpoint.n].scriptPubKey.IsUnspendable())\n-            {\n-                // should not happen\n-                if ((unsigned int)coins.nHeight != MEMPOOL_HEIGHT && (!chainActive[coins.nHeight] || !chainActive[coins.nHeight]->phashBlock))\n-                    throw JSONRPCError(RPC_INTERNAL_ERROR, \"Internal Error: !chainActive[coins.nHeight]\");\n-\n-                BlockMap::iterator it = mapBlockIndex.find(pcoinsTip->GetBestBlock());\n-                CBlockIndex *pindex = it->second;\n-\n-                int nConfirmations = 0;\n-                if ((unsigned int)coins.nHeight != MEMPOOL_HEIGHT)\n-                    nConfirmations = pindex->nHeight - coins.nHeight + 1;\n-                if (nConfirmations < nMinDepth)\n-                    continue;\n-\n-                UniValue oScriptPubKey(UniValue::VOBJ);\n-                ScriptPubKeyToJSON(coins.vout[outpoint.n].scriptPubKey, oScriptPubKey, true);\n-\n-                UniValue o(UniValue::VOBJ);\n-                o.push_back(Pair(\"confirmations\", nConfirmations));\n-                o.push_back(Pair(\"txid\", outpoint.hash.GetHex()));\n-                o.push_back(Pair(\"vout\", (int)outpoint.n));\n-                o.push_back(Pair(\"value\", ValueFromAmount(coins.vout[outpoint.n].nValue)));\n-                o.push_back(Pair(\"scriptPubKey\", oScriptPubKey));\n-                o.push_back(Pair(\"version\", coins.nVersion));\n-                o.push_back(Pair(\"coinbase\", coins.fCoinBase));\n-                o.push_back(Pair(\"bestblockhash\", pindex->GetBlockHash().GetHex()));\n-                o.push_back(Pair(\"bestblockheight\", pindex->nHeight));\n-                o.push_back(Pair(\"bestblocktime\", pindex->GetBlockTime()));\n-                if ((unsigned int)coins.nHeight != MEMPOOL_HEIGHT)\n-                {\n-                    o.push_back(Pair(\"blockhash\", chainActive[coins.nHeight]->GetBlockHash().GetHex()));\n-                    o.push_back(Pair(\"blockheight\", coins.nHeight));\n-                    o.push_back(Pair(\"blocktime\", chainActive[coins.nHeight]->GetBlockTime()));\n-                }\n-                vObjects.push_back(o);\n-                vSort.push_back(make_pair(coins.nHeight, (unsigned int)vObjects.size() - 1));\n-            }\n-        }\n+        CoinsByScriptToJSON(coinsByScript, nMinDepth, vObjects, vSort, true); \n     }\n \n     UniValue results(UniValue::VARR);"
      }
    ]
  },
  {
    "sha": "227cfe95ba1d7a675946e7f8d8523b384a1b5a96",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyMjdjZmU5NWJhMWQ3YTY3NTk0NmU3ZjhkODUyM2IzODRhMWI1YTk2",
    "commit": {
      "author": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2016-09-03T11:08:19Z"
      },
      "committer": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2017-01-04T00:49:21Z"
      },
      "message": "C++11: s/boost::scoped_ptr/std::unique_ptr/",
      "tree": {
        "sha": "93cd349f1b35f7323ae39fb03eedee0771f09e11",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/93cd349f1b35f7323ae39fb03eedee0771f09e11"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/227cfe95ba1d7a675946e7f8d8523b384a1b5a96",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/227cfe95ba1d7a675946e7f8d8523b384a1b5a96",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/227cfe95ba1d7a675946e7f8d8523b384a1b5a96",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/227cfe95ba1d7a675946e7f8d8523b384a1b5a96/comments",
    "author": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "7458f1839dfef0c4efa5fae759754ba3c3fc3c56",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7458f1839dfef0c4efa5fae759754ba3c3fc3c56",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/7458f1839dfef0c4efa5fae759754ba3c3fc3c56"
      }
    ],
    "stats": {
      "total": 12,
      "additions": 6,
      "deletions": 6
    },
    "files": [
      {
        "sha": "82c974dad470ff03ff3e5e6f7f9fe5431a6eddae",
        "filename": "src/coinsbyscript.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/227cfe95ba1d7a675946e7f8d8523b384a1b5a96/src/coinsbyscript.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/227cfe95ba1d7a675946e7f8d8523b384a1b5a96/src/coinsbyscript.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinsbyscript.cpp?ref=227cfe95ba1d7a675946e7f8d8523b384a1b5a96",
        "patch": "@@ -162,7 +162,7 @@ void CCoinsViewByScriptDBCursor::Next()\n \n bool CCoinsViewByScriptDB::DeleteAllCoinsByScript()\n {\n-    boost::scoped_ptr<CCoinsViewByScriptDBCursor> pcursor(Cursor());\n+    std::unique_ptr<CCoinsViewByScriptDBCursor> pcursor(Cursor());\n \n     std::vector<uint160> v;\n     int64_t i = 0;\n@@ -207,7 +207,7 @@ bool CCoinsViewByScriptDB::GenerateAllCoinsByScript(CCoinsViewDB* coinsIn)\n     LogPrintf(\"Building address index for -txoutsbyaddressindex. Be patient...\\n\");\n     int64_t nTxCount = coinsIn->CountCoins();\n \n-    boost::scoped_ptr<CCoinsViewCursor> pcursor(coinsIn->Cursor());\n+    std::unique_ptr<CCoinsViewCursor> pcursor(coinsIn->Cursor());\n \n     CCoinsMapByScript mapCoinsByScript;\n     int64_t i = 0;"
      },
      {
        "sha": "124e601d2840f822076a81428018f66b78e63f25",
        "filename": "src/coinsbyscript.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/227cfe95ba1d7a675946e7f8d8523b384a1b5a96/src/coinsbyscript.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/227cfe95ba1d7a675946e7f8d8523b384a1b5a96/src/coinsbyscript.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinsbyscript.h?ref=227cfe95ba1d7a675946e7f8d8523b384a1b5a96",
        "patch": "@@ -91,7 +91,7 @@ class CCoinsViewByScriptDBCursor\n     CCoinsViewByScriptDBCursor(CDBIterator* pcursorIn):\n         pcursor(pcursorIn) {}\n     uint256 hashBlock;\n-    boost::scoped_ptr<CDBIterator> pcursor;\n+    std::unique_ptr<CDBIterator> pcursor;\n     std::pair<char, uint160> keyTmp;\n \n     friend class CCoinsViewByScriptDB;"
      },
      {
        "sha": "b8d3d3206c82a26bd71ed42eb493a195230531ee",
        "filename": "src/coinstats.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/227cfe95ba1d7a675946e7f8d8523b384a1b5a96/src/coinstats.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/227cfe95ba1d7a675946e7f8d8523b384a1b5a96/src/coinstats.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinstats.cpp?ref=227cfe95ba1d7a675946e7f8d8523b384a1b5a96",
        "patch": "@@ -14,7 +14,7 @@ using namespace std;\n //! Calculate statistics about the unspent transaction output set\n bool GetUTXOStats(CCoinsView *view, CCoinsViewByScriptDB *viewbyscriptdb, CCoinsStats &stats)\n {\n-    boost::scoped_ptr<CCoinsViewCursor> pcursor(view->Cursor());\n+    std::unique_ptr<CCoinsViewCursor> pcursor(view->Cursor());\n \n     CHashWriter ss(SER_GETHASH, PROTOCOL_VERSION);\n     stats.hashBlock = pcursor->GetBestBlock();\n@@ -50,7 +50,7 @@ bool GetUTXOStats(CCoinsView *view, CCoinsViewByScriptDB *viewbyscriptdb, CCoins\n     stats.hashSerialized = ss.GetHash();\n     stats.nTotalAmount = nTotalAmount;\n \n-    boost::scoped_ptr<CCoinsViewByScriptDBCursor> pcursordb(viewbyscriptdb->Cursor());\n+    std::unique_ptr<CCoinsViewByScriptDBCursor> pcursordb(viewbyscriptdb->Cursor());\n     while (pcursordb->Valid()) {\n         boost::this_thread::interruption_point();\n         uint160 hash;"
      },
      {
        "sha": "3b0a3449f2f56fd796fe8eab2dfb76dfb6c63f22",
        "filename": "src/txdb.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/227cfe95ba1d7a675946e7f8d8523b384a1b5a96/src/txdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/227cfe95ba1d7a675946e7f8d8523b384a1b5a96/src/txdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txdb.cpp?ref=227cfe95ba1d7a675946e7f8d8523b384a1b5a96",
        "patch": "@@ -139,7 +139,7 @@ void CCoinsViewDBCursor::Next()\n \n int64_t CCoinsViewDB::CountCoins() const\n {\n-    boost::scoped_ptr<CCoinsViewCursor> pcursor(Cursor());\n+    std::unique_ptr<CCoinsViewCursor> pcursor(Cursor());\n \n     int64_t i = 0;\n     while (pcursor->Valid()) {"
      }
    ]
  },
  {
    "sha": "ad28b1b170956603ce63cfd7fe82d8cf0722cb25",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphZDI4YjFiMTcwOTU2NjAzY2U2M2NmZDdmZTgyZDhjZjA3MjJjYjI1",
    "commit": {
      "author": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2016-09-15T06:24:22Z"
      },
      "committer": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2017-01-04T00:50:58Z"
      },
      "message": "convert txoutsbyaddress test to python",
      "tree": {
        "sha": "d9048d8594b338ffc61cbc93d21c066f1ac98740",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d9048d8594b338ffc61cbc93d21c066f1ac98740"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ad28b1b170956603ce63cfd7fe82d8cf0722cb25",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ad28b1b170956603ce63cfd7fe82d8cf0722cb25",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ad28b1b170956603ce63cfd7fe82d8cf0722cb25",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ad28b1b170956603ce63cfd7fe82d8cf0722cb25/comments",
    "author": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "227cfe95ba1d7a675946e7f8d8523b384a1b5a96",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/227cfe95ba1d7a675946e7f8d8523b384a1b5a96",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/227cfe95ba1d7a675946e7f8d8523b384a1b5a96"
      }
    ],
    "stats": {
      "total": 270,
      "additions": 105,
      "deletions": 165
    },
    "files": [
      {
        "sha": "cb0b24cc900814d33e994ea3a17e9020ca7b66d1",
        "filename": "qa/pull-tester/rpc-tests.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ad28b1b170956603ce63cfd7fe82d8cf0722cb25/qa/pull-tester/rpc-tests.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ad28b1b170956603ce63cfd7fe82d8cf0722cb25/qa/pull-tester/rpc-tests.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/pull-tester/rpc-tests.py?ref=ad28b1b170956603ce63cfd7fe82d8cf0722cb25",
        "patch": "@@ -151,6 +151,7 @@\n     'signmessages.py',\n     'nulldummy.py',\n     'import-rescan.py',\n+    'txoutsbyaddress.py',\n ]\n if ENABLE_ZMQ:\n     testScripts.append('zmq_test.py')"
      },
      {
        "sha": "2213b1d64779e8a5fd9c18cb1a1ec7053c7c8f2e",
        "filename": "qa/rpc-tests/txoutsbyaddress.py",
        "status": "added",
        "additions": 96,
        "deletions": 0,
        "changes": 96,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ad28b1b170956603ce63cfd7fe82d8cf0722cb25/qa/rpc-tests/txoutsbyaddress.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ad28b1b170956603ce63cfd7fe82d8cf0722cb25/qa/rpc-tests/txoutsbyaddress.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/txoutsbyaddress.py?ref=ad28b1b170956603ce63cfd7fe82d8cf0722cb25",
        "patch": "@@ -0,0 +1,96 @@\n+#!/usr/bin/env python3\n+# Copyright (c) 2016 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+from test_framework.test_framework import BitcoinTestFramework\n+from test_framework.util import *\n+\n+\n+class TxOutsByAddressTest(BitcoinTestFramework):\n+    \"\"\"Tests -txoutsbyaddressindex\"\"\"\n+\n+    def __init__(self):\n+        super().__init__()\n+        self.setup_clean_chain = True\n+        self.num_nodes = 3\n+\n+    def setup_network(self, split=False):\n+        print(\"Setup network...\")\n+        self.nodes = []\n+        self.nodes.append(start_node(0, self.options.tmpdir, [\"-txoutsbyaddressindex\"]))\n+        self.nodes.append(start_node(1, self.options.tmpdir))\n+        self.nodes.append(start_node(2, self.options.tmpdir))\n+        self.is_network_split = False\n+        self.sync_all()\n+\n+    def run_test(self):\n+        print(\"Generating test blockchain...\")\n+\n+        # Check that there's no UTXO on any of the nodes\n+        for node in self.nodes:\n+            assert_equal(len(node.listunspent()), 0)\n+\n+        # mining\n+        connect_nodes(self.nodes[1], 0)\n+        connect_nodes(self.nodes[2], 0)\n+        self.nodes[0].generate(101)\n+        self.sync_all()\n+        assert_equal(self.nodes[0].getbalance(), 50)\n+\n+        # TX1: send from node0 to node1\n+        # - check if txout from tx1 is there\n+        address = self.nodes[1].getnewaddress()\n+        txid1 = self.nodes[0].sendtoaddress(address, 10)\n+        self.nodes[0].generate(101) # node will collect its own fee\n+        self.sync_all()\n+        assert_equal(self.nodes[0].getbalance(), 5090)\n+        assert_equal(self.nodes[1].getbalance(), 10)\n+        txouts = self.nodes[0].gettxoutsbyaddress(1, (address,))\n+        txid = txouts[0][\"txid\"]\n+        assert_is_hash_string(txid)\n+        assert_equal(txid, txid1)\n+\n+        # stop node 2\n+        stop_node(self.nodes[2], 2)\n+        self.nodes.pop()\n+\n+        # TX2: send from node1 to node0\n+        # - check if txout from tx1 is gone\n+        # - check if txout from tx2 is there\n+        address2 = self.nodes[0].getnewaddress()\n+        txid2 = self.nodes[1].sendtoaddress(address2, 5)\n+        self.nodes[1].generate(1)\n+        self.sync_all()\n+        assert_equal(self.nodes[0].getbalance(), 5145)\n+        txouts = self.nodes[0].gettxoutsbyaddress(1, (address,))\n+        assert_equal(txouts, [])\n+        txouts = self.nodes[0].gettxoutsbyaddress(1, (address2,))\n+        txid = txouts[0][\"txid\"]\n+        assert_is_hash_string(txid)\n+        assert_equal(txid, txid2)\n+\n+        # start node 2\n+        self.nodes.append(start_node(2, self.options.tmpdir, self.args))\n+\n+        # mine 10 blocks alone to have the longest chain\n+        self.nodes[2].generate(10)\n+        connect_nodes(self.nodes[0], 2)\n+        connect_nodes(self.nodes[1], 2)\n+        self.nodes[2].generate(1)\n+        sync_blocks(self.nodes)\n+\n+        # TX2 must be reverted\n+        # - check if txout from tx1 is there again\n+        # - check if txout from tx2 is gone\n+        assert_equal(self.nodes[0].getbalance(), 5640)\n+        txouts = self.nodes[0].gettxoutsbyaddress(1, (address,))\n+        txid = txouts[0][\"txid\"]\n+        assert_is_hash_string(txid)\n+        assert_equal(txid, txid1)\n+        txouts = self.nodes[0].gettxoutsbyaddress(1, (address2,))\n+        assert_equal(txouts, [])\n+\n+if __name__ == '__main__':\n+    TxOutsByAddressTest().main()\n+"
      },
      {
        "sha": "40c21f77413b72d239ccfb481004e9a30aa09274",
        "filename": "qa/rpc-tests/txoutsbyaddress.sh",
        "status": "removed",
        "additions": 0,
        "deletions": 163,
        "changes": 163,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/227cfe95ba1d7a675946e7f8d8523b384a1b5a96/qa/rpc-tests/txoutsbyaddress.sh",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/227cfe95ba1d7a675946e7f8d8523b384a1b5a96/qa/rpc-tests/txoutsbyaddress.sh",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/txoutsbyaddress.sh?ref=227cfe95ba1d7a675946e7f8d8523b384a1b5a96",
        "patch": "@@ -1,163 +0,0 @@\n-#!/usr/bin/env bash\n-# Copyright (c) 2013-2014 The Bitcoin Core developers\n-# Distributed under the MIT software license, see the accompanying\n-# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n-\n-# Test -txoutsbyaddressindex\n-\n-if [ $# -lt 1 ]; then\n-        echo \"Usage: $0 path_to_binaries\"\n-        echo \"e.g. $0 ../../src\"\n-        exit 1\n-fi\n-\n-set -f\n-\n-BITCOIND=${1}/bitcoind\n-CLI=${1}/bitcoin-cli\n-\n-DIR=\"${BASH_SOURCE%/*}\"\n-SENDANDWAIT=\"${DIR}/send.sh\"\n-if [[ ! -d \"$DIR\" ]]; then DIR=\"$PWD\"; fi\n-. \"$DIR/util.sh\"\n-\n-D=$(mktemp -d test.XXXXX)\n-\n-D1=${D}/node1\n-CreateDataDir \"$D1\" port=11000 rpcport=11001\n-B1ARGS=\"-datadir=$D1\"\n-$BITCOIND $B1ARGS -txoutsbyaddressindex -sendfreetransactions=1 &\n-B1PID=$!\n-\n-D2=${D}/node2\n-CreateDataDir \"$D2\" port=11010 rpcport=11011\n-B2ARGS=\"-datadir=$D2\"\n-$BITCOIND $B2ARGS -sendfreetransactions=1 &\n-B2PID=$!\n-\n-D3=${D}/node3\n-CreateDataDir \"$D3\" port=11020 rpcport=11021\n-B3ARGS=\"-datadir=$D3\"\n-$BITCOIND $B3ARGS -sendfreetransactions=1 &\n-B3PID=$!\n-\n-# Wait until all three nodes are at the same block number\n-function WaitBlocks {\n-    while :\n-    do\n-        sleep 1\n-        declare -i BLOCKS1=$( GetBlocks $B1ARGS )\n-        declare -i BLOCKS2=$( GetBlocks $B2ARGS )\n-        declare -i BLOCKS3=$( GetBlocks $B3ARGS )\n-        if (( BLOCKS1 == BLOCKS2 && BLOCKS2 == BLOCKS3 ))\n-        then\n-            break\n-        fi\n-    done\n-}\n-\n-function WaitBlocks2 {\n-    while :\n-    do\n-        sleep 1\n-        declare -i BLOCKS1=$( GetBlocks $B1ARGS )\n-        declare -i BLOCKS2=$( GetBlocks $B2ARGS )\n-        if (( BLOCKS1 == BLOCKS2 ))\n-        then\n-            break\n-        fi\n-    done\n-}\n-\n-function CleanUp {\n-$CLI $B3ARGS stop > /dev/null 2>&1\n-wait $B3PID\n-$CLI $B2ARGS stop > /dev/null 2>&1\n-wait $B2PID\n-$CLI $B1ARGS stop > /dev/null 2>&1\n-wait $B1PID\n-\n-rm -rf $D\n-}\n-\n-function ErrorAndExit {\n-echo \"$@\" 1>&2;\n-CleanUp\n-exit 1\n-}\n-\n-echo \"Generating test blockchain...\"\n-\n-# mining\n-$CLI $B2ARGS addnode \"127.0.0.1:11000\" \"onetry\"\n-$CLI $B3ARGS addnode \"127.0.0.1:11000\" \"onetry\"\n-$CLI $B1ARGS generate 101\n-WaitBlocks\n-CheckBalance \"$B1ARGS\" 50\n-\n-# TX1: send from node1 to node2\n-# - check if txout from tx1 is there\n-address=$($CLI $B2ARGS getnewaddress)\n-txid1=$($CLI $B1ARGS sendtoaddress $address 10)\n-$CLI $B1ARGS generate 1\n-WaitBlocks\n-CheckBalance \"$B1ARGS\" 90\n-CheckBalance \"$B2ARGS\" 10\n-txouts=$($CLI $B1ARGS gettxoutsbyaddress 1 \"[\\\"\"\"$address\"\"\\\"]\")\n-txid=$(ExtractKey \"txid\" \"$txouts\")\n-if [ -z \"$txid\" ] || [ $txid != $txid1 ] ; then\n-   ErrorAndExit \"wrong txid1: $txid != $txid1\"\n-fi\n-\n-# stop node 3\n-$CLI $B3ARGS stop > /dev/null 2>&1\n-wait $B3PID\n-\n-# TX2: send from node2 to node1\n-# - check if txout from tx1 is gone\n-# - check if txout from tx2 is there\n-address2=$($CLI $B1ARGS getnewaddress)\n-txid2=$($CLI $B2ARGS sendtoaddress $address2 5)\n-$CLI $B2ARGS generate 1\n-WaitBlocks2\n-CheckBalance \"$B1ARGS\" 145\n-txouts=$($CLI $B1ARGS gettxoutsbyaddress 1 \"[\\\"\"\"$address\"\"\\\"]\")\n-txid=$(ExtractKey \"txid\" \"$txouts\")\n-if [ ! -z \"$txid\" ] ; then\n-   ErrorAndExit \"txid not empty: $txid\"\n-fi\n-txouts=$($CLI $B1ARGS gettxoutsbyaddress 1 \"[\\\"\"\"$address2\"\"\\\"]\")\n-txid=$(ExtractKey \"txid\" \"$txouts\")\n-if [ -z \"$txid\" ] || [ $txid != $txid2 ] ; then\n-   ErrorAndExit \"wrong txid2: $txid != $txid2\"\n-fi\n-\n-# start node 3\n-$BITCOIND $B3ARGS &\n-B3PID=$!\n-\n-# mine 10 blocks alone to have the longest chain\n-$CLI $B3ARGS generate 10\n-$CLI $B1ARGS addnode \"127.0.0.1:11020\" \"onetry\"\n-$CLI $B2ARGS addnode \"127.0.0.1:11020\" \"onetry\"\n-$CLI $B3ARGS generate 1\n-WaitBlocks\n-\n-# TX2 must be reverted\n-# - check if txout from tx1 is there again\n-# - check if txout from tx2 is gone\n-CheckBalance \"$B1ARGS\" 640\n-txouts=$($CLI $B1ARGS gettxoutsbyaddress 1 \"[\\\"\"\"$address\"\"\\\"]\")\n-txid=$(ExtractKey \"txid\" \"$txouts\")\n-if [ -z \"$txid\" ] || [ $txid != $txid1 ] ; then\n-   ErrorAndExit \"wrong txid1 : $txid != $txid1\"\n-fi\n-txouts=$($CLI $B1ARGS gettxoutsbyaddress 1 \"[\\\"\"\"$address2\"\"\\\"]\")\n-txid=$(ExtractKey \"txid\" \"$txouts\")\n-if [ ! -z \"$txid\" ] ; then\n-   ErrorAndExit \"txid is not empty: $txid\"\n-fi\n-\n-echo \"Tests successful, cleaning up\"\n-CleanUp\n-exit 0"
      },
      {
        "sha": "21c533da14b166f81851709b0808145032e2758f",
        "filename": "src/coinstats.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 1,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ad28b1b170956603ce63cfd7fe82d8cf0722cb25/src/coinstats.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ad28b1b170956603ce63cfd7fe82d8cf0722cb25/src/coinstats.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinstats.cpp?ref=ad28b1b170956603ce63cfd7fe82d8cf0722cb25",
        "patch": "@@ -20,8 +20,13 @@ bool GetUTXOStats(CCoinsView *view, CCoinsViewByScriptDB *viewbyscriptdb, CCoins\n     stats.hashBlock = pcursor->GetBestBlock();\n     {\n         LOCK(cs_main);\n-        stats.nHeight = mapBlockIndex.find(stats.hashBlock)->second->nHeight;\n+        BlockMap::const_iterator iter = mapBlockIndex.find(stats.hashBlock);\n+        if (iter == mapBlockIndex.end())\n+            stats.nHeight = 0;\n+        else\n+            stats.nHeight = iter->second->nHeight;\n     }\n+\n     ss << stats.hashBlock;\n     CAmount nTotalAmount = 0;\n     while (pcursor->Valid()) {"
      },
      {
        "sha": "90bad17493ca6098454ab374c9841b8d3bc48f0a",
        "filename": "src/txdb.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ad28b1b170956603ce63cfd7fe82d8cf0722cb25/src/txdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ad28b1b170956603ce63cfd7fe82d8cf0722cb25/src/txdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txdb.cpp?ref=ad28b1b170956603ce63cfd7fe82d8cf0722cb25",
        "patch": "@@ -101,7 +101,8 @@ CCoinsViewCursor *CCoinsViewDB::Cursor() const\n        that restriction.  */\n     i->pcursor->Seek(DB_COINS);\n     // Cache key of first record\n-    i->pcursor->GetKey(i->keyTmp);\n+    if (!i->pcursor->Valid() || !i->pcursor->GetKey(i->keyTmp))\n+        i->keyTmp.first = 0; \n     return i;\n }\n "
      }
    ]
  },
  {
    "sha": "8e6154a0ec6e7036160c035756773542294dd9e0",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4ZTYxNTRhMGVjNmU3MDM2MTYwYzAzNTc1Njc3MzU0MjI5NGRkOWUw",
    "commit": {
      "author": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2016-09-15T10:40:16Z"
      },
      "committer": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2017-01-04T00:50:58Z"
      },
      "message": "- add txoutsbyaddress REST interface tests\n - remove skeleton HEX/BIN format support from REST interface for gettxoutsbyaddress endpoint",
      "tree": {
        "sha": "4840e5dd6a0230eda24207aefdceca62dc650ba4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4840e5dd6a0230eda24207aefdceca62dc650ba4"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8e6154a0ec6e7036160c035756773542294dd9e0",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8e6154a0ec6e7036160c035756773542294dd9e0",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/8e6154a0ec6e7036160c035756773542294dd9e0",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8e6154a0ec6e7036160c035756773542294dd9e0/comments",
    "author": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ad28b1b170956603ce63cfd7fe82d8cf0722cb25",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ad28b1b170956603ce63cfd7fe82d8cf0722cb25",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ad28b1b170956603ce63cfd7fe82d8cf0722cb25"
      }
    ],
    "stats": {
      "total": 135,
      "additions": 93,
      "deletions": 42
    },
    "files": [
      {
        "sha": "325a2e1b0e3e3f0c0a415fe663af70ad2b803f75",
        "filename": "qa/rpc-tests/rest.py",
        "status": "modified",
        "additions": 90,
        "deletions": 10,
        "changes": 100,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8e6154a0ec6e7036160c035756773542294dd9e0/qa/rpc-tests/rest.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8e6154a0ec6e7036160c035756773542294dd9e0/qa/rpc-tests/rest.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/rest.py?ref=8e6154a0ec6e7036160c035756773542294dd9e0",
        "patch": "@@ -53,7 +53,8 @@ def __init__(self):\n         self.num_nodes = 3\n \n     def setup_network(self, split=False):\n-        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir)\n+        args = [\"-txoutsbyaddressindex\"]\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, [args, args, args])\n         connect_nodes_bi(self.nodes,0,1)\n         connect_nodes_bi(self.nodes,1,2)\n         connect_nodes_bi(self.nodes,0,2)\n@@ -71,7 +72,8 @@ def run_test(self):\n \n         assert_equal(self.nodes[0].getbalance(), 50)\n \n-        txid = self.nodes[0].sendtoaddress(self.nodes[1].getnewaddress(), 0.1)\n+        address = self.nodes[1].getnewaddress()\n+        txid = self.nodes[0].sendtoaddress(address, 0.1)\n         self.sync_all()\n         self.nodes[2].generate(1)\n         self.sync_all()\n@@ -132,8 +134,6 @@ def run_test(self):\n         assert_equal(json_obj['bitmap'], \"10\")\n \n         #test binary response\n-        bb_hash = self.nodes[0].getbestblockhash()\n-\n         binaryRequest = b'\\x01\\x02'\n         binaryRequest += hex_str_to_bytes(txid)\n         binaryRequest += pack(\"i\", n)\n@@ -156,8 +156,9 @@ def run_test(self):\n         ############################\n \n         # do a tx and don't sync\n-        txid = self.nodes[0].sendtoaddress(self.nodes[1].getnewaddress(), 0.1)\n-        json_string = http_get_call(url.hostname, url.port, '/rest/tx/'+txid+self.FORMAT_SEPARATOR+\"json\")\n+        address2 = self.nodes[1].getnewaddress()\n+        txid2 = self.nodes[0].sendtoaddress(address2, 0.1)\n+        json_string = http_get_call(url.hostname, url.port, '/rest/tx/'+txid2+self.FORMAT_SEPARATOR+\"json\")\n         json_obj = json.loads(json_string)\n         vintx = json_obj['vin'][0]['txid'] # get the vin to later check for utxo (should be spent by then)\n         # get n of 0.1 outpoint\n@@ -166,12 +167,12 @@ def run_test(self):\n             if vout['value'] == 0.1:\n                 n = vout['n']\n \n-        json_request = '/'+txid+'-'+str(n)\n+        json_request = '/'+txid2+'-'+str(n)\n         json_string = http_get_call(url.hostname, url.port, '/rest/getutxos'+json_request+self.FORMAT_SEPARATOR+'json')\n         json_obj = json.loads(json_string)\n         assert_equal(len(json_obj['utxos']), 0) #there should be a outpoint because it has just added to the mempool\n \n-        json_request = '/checkmempool/'+txid+'-'+str(n)\n+        json_request = '/checkmempool/'+txid2+'-'+str(n)\n         json_string = http_get_call(url.hostname, url.port, '/rest/getutxos'+json_request+self.FORMAT_SEPARATOR+'json')\n         json_obj = json.loads(json_string)\n         assert_equal(len(json_obj['utxos']), 1) #there should be a outpoint because it has just added to the mempool\n@@ -191,21 +192,100 @@ def run_test(self):\n         #test limits\n         json_request = '/checkmempool/'\n         for x in range(0, 20):\n-            json_request += txid+'-'+str(n)+'/'\n+            json_request += txid2+'-'+str(n)+'/'\n         json_request = json_request.rstrip(\"/\")\n         response = http_post_call(url.hostname, url.port, '/rest/getutxos'+json_request+self.FORMAT_SEPARATOR+'json', '', True)\n         assert_equal(response.status, 400) #must be a 400 because we exceeding the limits\n \n         json_request = '/checkmempool/'\n         for x in range(0, 15):\n-            json_request += txid+'-'+str(n)+'/'\n+            json_request += txid2+'-'+str(n)+'/'\n         json_request = json_request.rstrip(\"/\")\n         response = http_post_call(url.hostname, url.port, '/rest/getutxos'+json_request+self.FORMAT_SEPARATOR+'json', '', True)\n         assert_equal(response.status, 200) #must be a 200 because we are within the limits\n \n         self.nodes[0].generate(1) #generate block to not affect upcoming tests\n         self.sync_all()\n \n+\n+        ##############################################\n+        # GETTXOUTSBYADDRESS: query an unspent txout #\n+        ##############################################\n+        json_request = '/checkmempool/'+address\n+        json_string = http_get_call(url.hostname, url.port, '/rest/gettxoutsbyaddress'+json_request+self.FORMAT_SEPARATOR+'json')\n+        json_obj = json.loads(json_string)\n+\n+        #make sure there is just one txout\n+        assert_equal(len(json_obj), 1)\n+        txout = json_obj[0]\n+\n+        #check details\n+        assert_equal(txout['blockhash'], bb_hash)\n+        assert_equal(txout['txid'], txid)\n+        assert_equal(txout['value'], 0.1)\n+\n+\n+        #####################################################\n+        # GETTXOUTSBYADDRESS: query multiple unspent txouts #\n+        #####################################################\n+        json_request = '/checkmempool/'+address+'/'+address2\n+        json_string = http_get_call(url.hostname, url.port, '/rest/gettxoutsbyaddress'+json_request+self.FORMAT_SEPARATOR+'json')\n+        json_obj = json.loads(json_string)\n+\n+        #make sure there are two txouts\n+        assert_equal(len(json_obj), 2)\n+        txout1 = json_obj[0]\n+        txout2 = json_obj[1]\n+\n+        #check details\n+        assert_equal(txout1['txid'], txid)\n+        assert_equal(txout1['value'], 0.1)\n+        assert_equal(txout2['txid'], txid2)\n+        assert_equal(txout2['value'], 0.1)\n+\n+\n+        ############################################\n+        # GETTXOUTSBYADDRESS: query unseen address #\n+        ############################################\n+\n+        json_request = '/checkmempool/'+self.nodes[0].getnewaddress()\n+        json_string = http_get_call(url.hostname, url.port, '/rest/gettxoutsbyaddress'+json_request+self.FORMAT_SEPARATOR+'json')\n+        json_obj = json.loads(json_string)\n+\n+        #make sure there are no txouts (brand new address)\n+        assert_equal(len(json_obj), 0) \n+\n+\n+        ########################################\n+        # GETTXOUTSBYADDRESS: invalid requests #\n+        ########################################\n+\n+\n+        #do some invalid requests\n+        json_request = '{\"checkmempool'\n+        response = http_post_call(url.hostname, url.port, '/rest/gettxoutsbyaddress'+self.FORMAT_SEPARATOR+'json', json_request, True)\n+        assert_equal(response.status, 400) #must be a 400 because we send a invalid json request\n+\n+        json_request = '/checkmempool/xxxx'\n+        response = http_post_call(url.hostname, url.port, '/rest/gettxoutsbyaddress'+self.FORMAT_SEPARATOR+'json', json_request, True)\n+        assert_equal(response.status, 400) #must be a 400 because we send a invalid json request\n+\n+        #test limits\n+        json_request = '/checkmempool/'\n+        for x in range(0, 20):\n+            json_request += address+'/'\n+        json_request = json_request.rstrip(\"/\")\n+        response = http_post_call(url.hostname, url.port, '/rest/gettxoutsbyaddress'+json_request+self.FORMAT_SEPARATOR+'json', '', True)\n+        assert_equal(response.status, 400) #must be a 400 because we exceeding the limits\n+\n+        json_request = '/checkmempool/'\n+        for x in range(0, 15):\n+            json_request += address+'/'\n+        json_request = json_request.rstrip(\"/\")\n+        response = http_post_call(url.hostname, url.port, '/rest/gettxoutsbyaddress'+json_request+self.FORMAT_SEPARATOR+'json', '', True)\n+        assert_equal(response.status, 200) #must be a 200 because we are within the limits\n+\n+\n         ################\n         # /rest/block/ #\n         ################"
      },
      {
        "sha": "8b8c713aee0e34cc8fd85a9744d4104834452c13",
        "filename": "src/rest.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 32,
        "changes": 35,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8e6154a0ec6e7036160c035756773542294dd9e0/src/rest.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8e6154a0ec6e7036160c035756773542294dd9e0/src/rest.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rest.cpp?ref=8e6154a0ec6e7036160c035756773542294dd9e0",
        "patch": "@@ -630,7 +630,7 @@ static bool rest_gettxoutsbyaddress(HTTPRequest* req, const std::string& strURIP\n     vector<CScript> vScripts;\n \n     // parse/deserialize input\n-    // input-format = output-format, rest/gettxoutsbyaddress/bin requires binary input, gives binary output, ...\n+    // only json format supported\n \n     if (uriParts.size() > 0)\n     {\n@@ -662,44 +662,17 @@ static bool rest_gettxoutsbyaddress(HTTPRequest* req, const std::string& strURIP\n     }\n \n     switch (rf) {\n-    case RF_HEX: {\n-        // convert hex to bin, continue then with bin part\n-        std::vector<unsigned char> strRequestV = ParseHex(strRequestMutable);\n-        strRequestMutable.assign(strRequestV.begin(), strRequestV.end());\n-    }\n-\n-    case RF_BINARY: {\n-        try {\n-            //deserialize only if user sent a request\n-            if (strRequestMutable.size() > 0)\n-            {\n-                if (fInputParsed) //don't allow sending input over URI and HTTP RAW DATA\n-                    return RESTERR(req, HTTP_BAD_REQUEST, \"Combination of URI scheme inputs and raw post data is not allowed\");\n-\n-                CDataStream oss(SER_NETWORK, PROTOCOL_VERSION);\n-                oss << strRequestMutable;\n-                oss >> fCheckMemPool;\n-                //DN: TODO: fix serialization\n-                //oss >> vScripts;\n-            }\n-        } catch (const std::ios_base::failure& e) {\n-            // abort in case of unreadable binary data\n-            return RESTERR(req, HTTP_BAD_REQUEST, \"Parse error\");\n-        }\n-        break;\n-    }\n-\n     case RF_JSON: {\n         if (!fInputParsed)\n             return RESTERR(req, HTTP_BAD_REQUEST, \"Error: empty request\");\n         break;\n     }\n     default: {\n-        return RESTERR(req, HTTP_NOT_FOUND, \"output format not found (available: \" + AvailableDataFormatsString() + \")\");\n+        return RESTERR(req, HTTP_NOT_FOUND, \"output format not found (available: json)\");\n     }\n     }\n \n-    // limit max scriptis\n+    // limit max scripts\n     if (vScripts.size() > MAX_GETTXOUTSBYADDRESS_SCRIPTS)\n         return RESTERR(req, HTTP_BAD_REQUEST, strprintf(\"Error: max scripts exceeded (max: %d, tried: %d)\", MAX_GETTXOUTSBYADDRESS_SCRIPTS, vScripts.size()));\n \n@@ -718,8 +691,6 @@ static bool rest_gettxoutsbyaddress(HTTPRequest* req, const std::string& strURIP\n         CoinsByScriptToJSON(coinsByScript, nMinDepth, vObjects, vSort, true); \n     }\n \n-    //DN: TODO: BIN and HEX\n-\n     UniValue results(UniValue::VARR);\n     sort(vSort.begin(), vSort.end());\n     for (unsigned int i = 0; i < vSort.size(); i++)"
      }
    ]
  },
  {
    "sha": "83277c8e8e393e902a61a0a115b8ebf84aad993a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4MzI3N2M4ZThlMzkzZTkwMmE2MWEwYTExNWI4ZWJmODRhYWQ5OTNh",
    "commit": {
      "author": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2016-09-17T04:55:52Z"
      },
      "committer": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2017-01-04T00:50:58Z"
      },
      "message": "address test review nits",
      "tree": {
        "sha": "58082462edf1984ecbd9d75bf297d07313ccc2a2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/58082462edf1984ecbd9d75bf297d07313ccc2a2"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/83277c8e8e393e902a61a0a115b8ebf84aad993a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/83277c8e8e393e902a61a0a115b8ebf84aad993a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/83277c8e8e393e902a61a0a115b8ebf84aad993a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/83277c8e8e393e902a61a0a115b8ebf84aad993a/comments",
    "author": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "8e6154a0ec6e7036160c035756773542294dd9e0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8e6154a0ec6e7036160c035756773542294dd9e0",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/8e6154a0ec6e7036160c035756773542294dd9e0"
      }
    ],
    "stats": {
      "total": 18,
      "additions": 7,
      "deletions": 11
    },
    "files": [
      {
        "sha": "a8722a4a0c22644654f3b1204719d0c68e4223e7",
        "filename": "qa/rpc-tests/rest.py",
        "status": "modified",
        "additions": 2,
        "deletions": 3,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/83277c8e8e393e902a61a0a115b8ebf84aad993a/qa/rpc-tests/rest.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/83277c8e8e393e902a61a0a115b8ebf84aad993a/qa/rpc-tests/rest.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/rest.py?ref=83277c8e8e393e902a61a0a115b8ebf84aad993a",
        "patch": "@@ -51,15 +51,14 @@ def __init__(self):\n         super().__init__()\n         self.setup_clean_chain = True\n         self.num_nodes = 3\n+        self.extra_args = [[\"-txoutsbyaddressindex\"]] * 3\n \n     def setup_network(self, split=False):\n-        args = [\"-txoutsbyaddressindex\"]\n-        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, [args, args, args])\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, self.extra_args)\n         connect_nodes_bi(self.nodes,0,1)\n         connect_nodes_bi(self.nodes,1,2)\n         connect_nodes_bi(self.nodes,0,2)\n         self.is_network_split=False\n-        self.sync_all()\n \n     def run_test(self):\n         url = urllib.parse.urlparse(self.nodes[0].url)"
      },
      {
        "sha": "a84224e2c51e5533438f60fcc0db75fb0a1e584e",
        "filename": "qa/rpc-tests/txoutsbyaddress.py",
        "status": "modified",
        "additions": 5,
        "deletions": 8,
        "changes": 13,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/83277c8e8e393e902a61a0a115b8ebf84aad993a/qa/rpc-tests/txoutsbyaddress.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/83277c8e8e393e902a61a0a115b8ebf84aad993a/qa/rpc-tests/txoutsbyaddress.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/txoutsbyaddress.py?ref=83277c8e8e393e902a61a0a115b8ebf84aad993a",
        "patch": "@@ -14,15 +14,14 @@ def __init__(self):\n         super().__init__()\n         self.setup_clean_chain = True\n         self.num_nodes = 3\n+        self.extra_args = [[\"-txoutsbyaddressindex\"], [], []]\n \n     def setup_network(self, split=False):\n         print(\"Setup network...\")\n-        self.nodes = []\n-        self.nodes.append(start_node(0, self.options.tmpdir, [\"-txoutsbyaddressindex\"]))\n-        self.nodes.append(start_node(1, self.options.tmpdir))\n-        self.nodes.append(start_node(2, self.options.tmpdir))\n+        self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, self.extra_args)\n+        connect_nodes(self.nodes[1], 0)\n+        connect_nodes(self.nodes[2], 0)\n         self.is_network_split = False\n-        self.sync_all()\n \n     def run_test(self):\n         print(\"Generating test blockchain...\")\n@@ -32,8 +31,6 @@ def run_test(self):\n             assert_equal(len(node.listunspent()), 0)\n \n         # mining\n-        connect_nodes(self.nodes[1], 0)\n-        connect_nodes(self.nodes[2], 0)\n         self.nodes[0].generate(101)\n         self.sync_all()\n         assert_equal(self.nodes[0].getbalance(), 50)\n@@ -71,7 +68,7 @@ def run_test(self):\n         assert_equal(txid, txid2)\n \n         # start node 2\n-        self.nodes.append(start_node(2, self.options.tmpdir, self.args))\n+        self.nodes.append(start_node(2, self.options.tmpdir, self.extra_args[2]))\n \n         # mine 10 blocks alone to have the longest chain\n         self.nodes[2].generate(10)"
      }
    ]
  },
  {
    "sha": "dd18e448acf4491e693d862484d2e5802b0d41e3",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkZDE4ZTQ0OGFjZjQ0OTFlNjkzZDg2MjQ4NGQyZTU4MDJiMGQ0MWUz",
    "commit": {
      "author": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2016-10-01T00:10:46Z"
      },
      "committer": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2017-01-04T01:04:40Z"
      },
      "message": "rename -txoutsbyaddress to -txoutindex",
      "tree": {
        "sha": "3b0a062b4b9d1dd89595480df03f174cce9abf0a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3b0a062b4b9d1dd89595480df03f174cce9abf0a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/dd18e448acf4491e693d862484d2e5802b0d41e3",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dd18e448acf4491e693d862484d2e5802b0d41e3",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/dd18e448acf4491e693d862484d2e5802b0d41e3",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dd18e448acf4491e693d862484d2e5802b0d41e3/comments",
    "author": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "83277c8e8e393e902a61a0a115b8ebf84aad993a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/83277c8e8e393e902a61a0a115b8ebf84aad993a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/83277c8e8e393e902a61a0a115b8ebf84aad993a"
      }
    ],
    "stats": {
      "total": 98,
      "additions": 49,
      "deletions": 49
    },
    "files": [
      {
        "sha": "4bb5a79d3e7e76f526d0d0af3ceea65628c984f3",
        "filename": "qa/rpc-tests/rest.py",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd18e448acf4491e693d862484d2e5802b0d41e3/qa/rpc-tests/rest.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd18e448acf4491e693d862484d2e5802b0d41e3/qa/rpc-tests/rest.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/rest.py?ref=dd18e448acf4491e693d862484d2e5802b0d41e3",
        "patch": "@@ -51,7 +51,7 @@ def __init__(self):\n         super().__init__()\n         self.setup_clean_chain = True\n         self.num_nodes = 3\n-        self.extra_args = [[\"-txoutsbyaddressindex\"]] * 3\n+        self.extra_args = [[\"-txoutindex\"]] * 3\n \n     def setup_network(self, split=False):\n         self.nodes = start_nodes(self.num_nodes, self.options.tmpdir, self.extra_args)"
      },
      {
        "sha": "44969a812965ac11edf0da8f5659f57b594544a5",
        "filename": "qa/rpc-tests/txoutsbyaddress.py",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd18e448acf4491e693d862484d2e5802b0d41e3/qa/rpc-tests/txoutsbyaddress.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd18e448acf4491e693d862484d2e5802b0d41e3/qa/rpc-tests/txoutsbyaddress.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/txoutsbyaddress.py?ref=dd18e448acf4491e693d862484d2e5802b0d41e3",
        "patch": "@@ -8,13 +8,13 @@\n \n \n class TxOutsByAddressTest(BitcoinTestFramework):\n-    \"\"\"Tests -txoutsbyaddressindex\"\"\"\n+    \"\"\"Tests -txoutindex\"\"\"\n \n     def __init__(self):\n         super().__init__()\n         self.setup_clean_chain = True\n         self.num_nodes = 3\n-        self.extra_args = [[\"-txoutsbyaddressindex\"], [], []]\n+        self.extra_args = [[\"-txoutindex\"], [], []]\n \n     def setup_network(self, split=False):\n         print(\"Setup network...\")"
      },
      {
        "sha": "8645a65364a135c8c0fc7ef605e650f5d69c0e42",
        "filename": "src/coinsbyscript.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd18e448acf4491e693d862484d2e5802b0d41e3/src/coinsbyscript.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd18e448acf4491e693d862484d2e5802b0d41e3/src/coinsbyscript.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinsbyscript.cpp?ref=dd18e448acf4491e693d862484d2e5802b0d41e3",
        "patch": "@@ -204,7 +204,7 @@ bool CCoinsViewByScriptDB::DeleteAllCoinsByScript()\n \n bool CCoinsViewByScriptDB::GenerateAllCoinsByScript(CCoinsViewDB* coinsIn)\n {\n-    LogPrintf(\"Building address index for -txoutsbyaddressindex. Be patient...\\n\");\n+    LogPrintf(\"Building address index for -txoutindex. Be patient...\\n\");\n     int64_t nTxCount = coinsIn->CountCoins();\n \n     std::unique_ptr<CCoinsViewCursor> pcursor(coinsIn->Cursor());"
      },
      {
        "sha": "236edb418952dc1deb5723c8e817a5170492fe38",
        "filename": "src/coinsbyscript.h",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd18e448acf4491e693d862484d2e5802b0d41e3/src/coinsbyscript.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd18e448acf4491e693d862484d2e5802b0d41e3/src/coinsbyscript.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/coinsbyscript.h?ref=dd18e448acf4491e693d862484d2e5802b0d41e3",
        "patch": "@@ -109,8 +109,8 @@ class CCoinsViewByScriptDB\n     bool BatchWrite(CCoinsViewByScript* pcoinsViewByScriptIn, const uint256 &hashBlock);\n     bool WriteFlag(const std::string &name, bool fValue);\n     bool ReadFlag(const std::string &name, bool &fValue);\n-    bool DeleteAllCoinsByScript();   // removes txoutsbyaddressindex\n-    bool GenerateAllCoinsByScript(CCoinsViewDB* coinsIn); // creates txoutsbyaddressindex\n+    bool DeleteAllCoinsByScript();   // removes txoutindex\n+    bool GenerateAllCoinsByScript(CCoinsViewDB* coinsIn); // creates txoutindex\n     CCoinsViewByScriptDBCursor *Cursor() const;\n };\n "
      },
      {
        "sha": "3fdfabd3df73d8ae45a9432fc3cfc03cd27ec0c4",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 19,
        "deletions": 19,
        "changes": 38,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd18e448acf4491e693d862484d2e5802b0d41e3/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd18e448acf4491e693d862484d2e5802b0d41e3/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=dd18e448acf4491e693d862484d2e5802b0d41e3",
        "patch": "@@ -361,7 +361,7 @@ std::string HelpMessage(HelpMessageMode mode)\n     strUsage += HelpMessageOpt(\"-sysperms\", _(\"Create new files with system default permissions, instead of umask 077 (only effective with disabled wallet functionality)\"));\n #endif\n     strUsage += HelpMessageOpt(\"-txindex\", strprintf(_(\"Maintain a full transaction index, used by the getrawtransaction rpc call (default: %u)\"), DEFAULT_TXINDEX));\n-    strUsage += HelpMessageOpt(\"-txoutsbyaddressindex\", strprintf(_(\"Maintain an address to unspent outputs index (rpc: gettxoutsbyaddress). The index is built on first use. (default: %u)\"), 0));\n+    strUsage += HelpMessageOpt(\"-txoutindex\", strprintf(_(\"Maintain an address to unspent outputs index (rpc: gettxoutsbyaddress). The index is built on first use. (default: %u)\"), 0));\n \n     strUsage += HelpMessageGroup(_(\"Connection options:\"));\n     strUsage += HelpMessageOpt(\"-addnode=<ip>\", _(\"Add a node to connect to and attempt to keep the connection open\"));\n@@ -1415,56 +1415,56 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n                     }\n                 }\n \n-                // Check -txoutsbyaddressindex\n-                pcoinsByScriptDB->ReadFlag(\"txoutsbyaddressindex\", fTxOutsByAddressIndex);\n-                if (IsArgSet(\"-txoutsbyaddressindex\"))\n+                // Check -txoutindex\n+                pcoinsByScriptDB->ReadFlag(\"txoutindex\", fTxOutIndex);\n+                if (IsArgSet(\"-txoutindex\"))\n                 {\n-                    if (GetBoolArg(\"-txoutsbyaddressindex\", false))\n+                    if (GetBoolArg(\"-txoutindex\", false))\n                     {\n                         // build index\n-                        if (!fTxOutsByAddressIndex)\n+                        if (!fTxOutIndex)\n                         {\n                             if (!pcoinsByScriptDB->DeleteAllCoinsByScript())\n                             {\n-                                strLoadError = _(\"Error deleting txoutsbyaddressindex\");\n+                                strLoadError = _(\"Error deleting txoutindex\");\n                                 break;\n                             }\n                             if (!pcoinsByScriptDB->GenerateAllCoinsByScript(pcoinsdbview))\n                             {\n-                                strLoadError = _(\"Error building txoutsbyaddressindex\");\n+                                strLoadError = _(\"Error building txoutindex\");\n                                 break;\n                             }\n                             CCoinsStats stats;\n                             if (!GetUTXOStats(pcoinsTip, pcoinsByScriptDB, stats))\n                             {\n-                                strLoadError = _(\"Error GetUTXOStats for txoutsbyaddressindex\");\n+                                strLoadError = _(\"Error GetUTXOStats for txoutindex\");\n                                 break;\n                             }\n                             if (stats.nTransactionOutputs != stats.nAddressesOutputs)\n                             {\n-                                strLoadError = _(\"Error compare stats for txoutsbyaddressindex\");\n+                                strLoadError = _(\"Error compare stats for txoutindex\");\n                                 break;\n                             }\n-                            pcoinsByScriptDB->WriteFlag(\"txoutsbyaddressindex\", true);\n-                            fTxOutsByAddressIndex = true;\n+                            pcoinsByScriptDB->WriteFlag(\"txoutindex\", true);\n+                            fTxOutIndex = true;\n                         }\n                     }\n                     else\n                     {\n-                        if (fTxOutsByAddressIndex)\n+                        if (fTxOutIndex)\n                         {\n                             // remove index\n                             pcoinsByScriptDB->DeleteAllCoinsByScript();\n-                            pcoinsByScriptDB->WriteFlag(\"txoutsbyaddressindex\", false);\n-                            fTxOutsByAddressIndex = false;\n+                            pcoinsByScriptDB->WriteFlag(\"txoutindex\", false);\n+                            fTxOutIndex = false;\n                         }\n                     }\n                 }\n-                else if (fTxOutsByAddressIndex)\n-                    return InitError(_(\"You need to provide -txoutsbyaddressindex. Do -txoutsbyaddressindex=0 to delete the index.\"));\n+                else if (fTxOutIndex)\n+                    return InitError(_(\"You need to provide -txoutindex. Do -txoutindex=0 to delete the index.\"));\n \n-                // Init -txoutsbyaddressindex\n-                if (fTxOutsByAddressIndex)\n+                // Init -txoutindex\n+                if (fTxOutIndex)\n                     pcoinsByScript = new CCoinsViewByScript(pcoinsByScriptDB);\n \n                 uiInterface.InitMessage(_(\"Verifying blocks...\"));"
      },
      {
        "sha": "efd76f1ecb98bcaf6f4c5a73d76df6cb4a6a68b2",
        "filename": "src/rest.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd18e448acf4491e693d862484d2e5802b0d41e3/src/rest.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd18e448acf4491e693d862484d2e5802b0d41e3/src/rest.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rest.cpp?ref=dd18e448acf4491e693d862484d2e5802b0d41e3",
        "patch": "@@ -607,8 +607,8 @@ static bool rest_gettxoutsbyaddress(HTTPRequest* req, const std::string& strURIP\n {\n     if (!CheckWarmup(req))\n         return false;\n-    if (!fTxOutsByAddressIndex)\n-        return RESTERR(req, HTTP_BAD_REQUEST, \"To use this function, you must start bitcoin with the -txoutsbyaddressindex parameter.\");\n+    if (!fTxOutIndex)\n+        return RESTERR(req, HTTP_BAD_REQUEST, \"To use this function, you must start bitcoin with the -txoutindex parameter.\");\n \n     std::string param;\n     const RetFormat rf = ParseDataFormat(param, strURIPart);"
      },
      {
        "sha": "29dc7d920ae4419cbec0fec9762a7ac017ec5c07",
        "filename": "src/rpc/blockchain.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 5,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd18e448acf4491e693d862484d2e5802b0d41e3/src/rpc/blockchain.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd18e448acf4491e693d862484d2e5802b0d41e3/src/rpc/blockchain.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/blockchain.cpp?ref=dd18e448acf4491e693d862484d2e5802b0d41e3",
        "patch": "@@ -835,8 +835,8 @@ UniValue gettxoutsetinfo(const JSONRPCRequest& request)\n             \"  \\\"bestblock\\\": \\\"hex\\\",   (string) the best block hash hex\\n\"\n             \"  \\\"transactions\\\": n,      (numeric) The number of transactions\\n\"\n             \"  \\\"txouts\\\": n,            (numeric) The number of output transactions\\n\"\n-            \"  \\\"addresses\\\": n,         (numeric) The number of addresses and scripts. Only if -txoutsbyaddressindex=1\\n\"\n-            \"  \\\"txoutsbyaddress\\\": n,   (numeric) The number of output transactions. Only if -txoutsbyaddressindex=1\\n\"\n+            \"  \\\"addresses\\\": n,         (numeric) The number of addresses and scripts. Only if -txoutindex=1\\n\"\n+            \"  \\\"txoutsbyaddress\\\": n,   (numeric) The number of output transactions. Only if -txoutindex=1\\n\"\n             \"  \\\"bytes_serialized\\\": n,  (numeric) The serialized size\\n\"\n             \"  \\\"hash_serialized\\\": \\\"hash\\\",   (string) The serialized hash\\n\"\n             \"  \\\"total_amount\\\": x.xxx          (numeric) The total amount\\n\"\n@@ -954,7 +954,7 @@ UniValue gettxoutsbyaddress(const JSONRPCRequest& request)\n             \"\\nReturns a list of unspent transaction outputs by address (or script).\\n\"\n             \"The list is ordered by confirmations in descending order.\\n\"\n             \"Note that passing minconf=0 will include the mempool.\\n\"\n-            \"\\nTo use this function, you must start bitcoin with the -txoutsbyaddressindex parameter.\\n\"\n+            \"\\nTo use this function, you must start bitcoin with the -txoutindex parameter.\\n\"\n             \"\\nArguments:\\n\"\n             \"1. minconf          (numeric) Minimum confirmations\\n\"\n             \"2. \\\"addresses\\\"    (string) A json array of bitcoin addresses (or scripts)\\n\"\n@@ -998,8 +998,8 @@ UniValue gettxoutsbyaddress(const JSONRPCRequest& request)\n             + HelpExampleRpc(\"gettxoutsbyaddress\", \"6, \\\"[\\\\\\\"1PGFqEzfmQch1gKD3ra4k18PNj3tTUUSqg\\\\\\\",\\\\\\\"1LtvqCaApEdUGFkpKMM4MstjcaL4dKg8SP\\\\\\\"]\\\"\")\n         );\n \n-    if (!fTxOutsByAddressIndex)\n-        throw JSONRPCError(RPC_METHOD_NOT_FOUND, \"To use this function, you must start bitcoin with the -txoutsbyaddressindex parameter.\");\n+    if (!fTxOutIndex)\n+        throw JSONRPCError(RPC_METHOD_NOT_FOUND, \"To use this function, you must start bitcoin with the -txoutindex parameter.\");\n \n     RPCTypeCheck(request.params, boost::assign::list_of(UniValue::VNUM)(UniValue::VARR)(UniValue::VNUM)(UniValue::VNUM));\n "
      },
      {
        "sha": "64ee0cb0c02e17f1dea252c709d3f9c28fbc8df7",
        "filename": "src/test/mempool_tests.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd18e448acf4491e693d862484d2e5802b0d41e3/src/test/mempool_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd18e448acf4491e693d862484d2e5802b0d41e3/src/test/mempool_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/mempool_tests.cpp?ref=dd18e448acf4491e693d862484d2e5802b0d41e3",
        "patch": "@@ -53,8 +53,8 @@ BOOST_AUTO_TEST_CASE(MempoolRemoveTest)\n         txGrandChild[i].vout[0].nValue = 11000LL;\n     }\n \n-    bool fTxOutsByAddressIndex = false;\n-    CTxMemPool testPool(CFeeRate(0), fTxOutsByAddressIndex);\n+    bool fTxOutIndex = false;\n+    CTxMemPool testPool(CFeeRate(0), fTxOutIndex);\n \n     // Nothing in pool, remove should do nothing:\n     unsigned int poolSize = testPool.size();"
      },
      {
        "sha": "f75435b32f0743272d13d5f2b116d59f1b7cc395",
        "filename": "src/test/policyestimator_tests.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd18e448acf4491e693d862484d2e5802b0d41e3/src/test/policyestimator_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd18e448acf4491e693d862484d2e5802b0d41e3/src/test/policyestimator_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/policyestimator_tests.cpp?ref=dd18e448acf4491e693d862484d2e5802b0d41e3",
        "patch": "@@ -16,8 +16,8 @@ BOOST_FIXTURE_TEST_SUITE(policyestimator_tests, BasicTestingSetup)\n \n BOOST_AUTO_TEST_CASE(BlockPolicyEstimates)\n {\n-    bool fTxOutsByAddressIndex = false;\n-    CTxMemPool mpool(CFeeRate(1000), fTxOutsByAddressIndex);\n+    bool fTxOutIndex = false;\n+    CTxMemPool mpool(CFeeRate(1000), fTxOutIndex);\n     TestMemPoolEntryHelper entry;\n     CAmount basefee(2000);\n     CAmount deltaFee(100);"
      },
      {
        "sha": "bcf9d641a1170a8687107fca1e7b0d1dc45907ba",
        "filename": "src/txmempool.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 4,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd18e448acf4491e693d862484d2e5802b0d41e3/src/txmempool.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd18e448acf4491e693d862484d2e5802b0d41e3/src/txmempool.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txmempool.cpp?ref=dd18e448acf4491e693d862484d2e5802b0d41e3",
        "patch": "@@ -348,9 +348,9 @@ void CTxMemPoolEntry::UpdateAncestorState(int64_t modifySize, CAmount modifyFee,\n     assert(int(nSigOpCostWithAncestors) >= 0);\n }\n \n-CTxMemPool::CTxMemPool(const CFeeRate& _minReasonableRelayFee, const bool& _fTxOutsByAddressIndex) :\n+CTxMemPool::CTxMemPool(const CFeeRate& _minReasonableRelayFee, const bool& _fTxOutIndex) :\n     nTransactionsUpdated(0),\n-    fTxOutsByAddressIndex(_fTxOutsByAddressIndex)\n+    fTxOutIndex(_fTxOutIndex)\n {\n     _clear(); //lock free clear\n \n@@ -459,7 +459,7 @@ bool CTxMemPool::addUnchecked(const uint256& hash, const CTxMemPoolEntry &entry,\n     vTxHashes.emplace_back(tx.GetWitnessHash(), newit);\n     newit->vTxHashesIdx = vTxHashes.size() - 1;\n \n-    if (fTxOutsByAddressIndex)\n+    if (fTxOutIndex)\n         for (unsigned int i = 0; i < tx.vout.size(); i++)\n             if (!tx.vout[i].IsNull() && !tx.vout[i].scriptPubKey.IsUnspendable())\n                 mapCoinsByScript[CCoinsViewByScript::getKey(tx.vout[i].scriptPubKey)].setCoins.insert(COutPoint(hash, (uint32_t)i));\n@@ -526,7 +526,7 @@ void CTxMemPool::removeRecursive(const CTransaction &origTx)\n     {\n         LOCK(cs);\n \n-        if (fTxOutsByAddressIndex)\n+        if (fTxOutIndex)\n         {\n             for (unsigned int i = 0; i < origTx.vout.size(); i++)\n             {"
      },
      {
        "sha": "b2b4d836084666084a056b3505853592b87b670d",
        "filename": "src/txmempool.h",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd18e448acf4491e693d862484d2e5802b0d41e3/src/txmempool.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd18e448acf4491e693d862484d2e5802b0d41e3/src/txmempool.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/txmempool.h?ref=dd18e448acf4491e693d862484d2e5802b0d41e3",
        "patch": "@@ -423,8 +423,8 @@ class CTxMemPool\n     CBlockPolicyEstimator* minerPolicyEstimator;\n \n     uint64_t totalTxSize;      //!< sum of all mempool tx' byte sizes\n-    const bool& fTxOutsByAddressIndex;\n-    CCoinsMapByScript mapCoinsByScript; // only used if -txoutsbyaddressindex\n+    const bool& fTxOutIndex;\n+    CCoinsMapByScript mapCoinsByScript; // only used if -txoutindex\n     uint64_t cachedInnerUsage; //!< sum of dynamic memory usage of all the map elements (NOT the maps themselves)\n \n     CFeeRate minReasonableRelayFee;\n@@ -511,7 +511,7 @@ class CTxMemPool\n      *  around what it \"costs\" to relay a transaction around the network and\n      *  below which we would reasonably say a transaction has 0-effective-fee.\n      */\n-    CTxMemPool(const CFeeRate& _minReasonableRelayFee, const bool& _fTxOutsByAddressIndex);\n+    CTxMemPool(const CFeeRate& _minReasonableRelayFee, const bool& _fTxOutIndex);\n     ~CTxMemPool();\n \n     /**"
      },
      {
        "sha": "e8e9e09024e4b58d8ec8145dcf2e21e4dafa3292",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 4,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd18e448acf4491e693d862484d2e5802b0d41e3/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd18e448acf4491e693d862484d2e5802b0d41e3/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=dd18e448acf4491e693d862484d2e5802b0d41e3",
        "patch": "@@ -67,7 +67,7 @@ int nScriptCheckThreads = 0;\n std::atomic_bool fImporting(false);\n bool fReindex = false;\n bool fTxIndex = false;\n-bool fTxOutsByAddressIndex = false;\n+bool fTxOutIndex = false;\n bool fHavePruned = false;\n bool fPruneMode = false;\n bool fIsBareMultisigStd = DEFAULT_PERMIT_BAREMULTISIG;\n@@ -83,7 +83,7 @@ bool fEnableReplacement = DEFAULT_ENABLE_REPLACEMENT;\n CFeeRate minRelayTxFee = CFeeRate(DEFAULT_MIN_RELAY_TX_FEE);\n CAmount maxTxFee = DEFAULT_TRANSACTION_MAXFEE;\n \n-CTxMemPool mempool(::minRelayTxFee, fTxOutsByAddressIndex);\n+CTxMemPool mempool(::minRelayTxFee, fTxOutIndex);\n \n static void CheckBlockIndex(const Consensus::Params& consensusParams);\n \n@@ -1999,7 +1999,7 @@ bool static FlushStateToDisk(CValidationState &state, FlushStateMode mode) {\n         // Flush the chainstate (which may refer to block index entries).\n         if (!pcoinsTip->Flush())\n             return AbortNode(state, \"Failed to write to coin database\");\n-        if (fTxOutsByAddressIndex) {\n+        if (fTxOutIndex) {\n             if (!pcoinsByScript->Flush())\n                 return AbortNode(state, \"Failed to write to coin database\");\n         }\n@@ -2041,7 +2041,7 @@ void static UpdateAddressIndex(const CTxOut& txout, const COutPoint& outpoint, b\n \n void static UpdateAddressIndex(const CBlock& block, CBlockUndo& blockundo, bool fConnect)\n {\n-    if (!fTxOutsByAddressIndex)\n+    if (!fTxOutIndex)\n         return;\n \n     assert(block.vtx.size() > 0);"
      },
      {
        "sha": "ee863a2390551aee61653889e6aa326c9d123a9c",
        "filename": "src/validation.h",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/dd18e448acf4491e693d862484d2e5802b0d41e3/src/validation.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/dd18e448acf4491e693d862484d2e5802b0d41e3/src/validation.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.h?ref=dd18e448acf4491e693d862484d2e5802b0d41e3",
        "patch": "@@ -172,7 +172,7 @@ extern std::atomic_bool fImporting;\n extern bool fReindex;\n extern int nScriptCheckThreads;\n extern bool fTxIndex;\n-extern bool fTxOutsByAddressIndex;\n+extern bool fTxOutIndex;\n extern bool fIsBareMultisigStd;\n extern bool fRequireStandard;\n extern bool fCheckBlockIndex;\n@@ -536,7 +536,7 @@ extern CChain chainActive;\n /** Global variable that points to the active CCoinsView (protected by cs_main) */\n extern CCoinsViewCache *pcoinsTip;\n \n-/** Only used if -txoutsbyaddressindex */\n+/** Only used if -txoutindex */\n extern CCoinsViewByScriptDB *pcoinsByScriptDB;\n extern CCoinsViewByScript *pcoinsByScript;\n "
      }
    ]
  },
  {
    "sha": "eed6139bbdcce82d731cf20d4136bd28368441ec",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplZWQ2MTM5YmJkY2NlODJkNzMxY2YyMGQ0MTM2YmQyODM2ODQ0MWVj",
    "commit": {
      "author": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2016-10-01T00:26:57Z"
      },
      "committer": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2017-01-04T01:04:40Z"
      },
      "message": "set executable bit",
      "tree": {
        "sha": "85f5cb8000cb04d23bbe367ea0c1341262d6d6b7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/85f5cb8000cb04d23bbe367ea0c1341262d6d6b7"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/eed6139bbdcce82d731cf20d4136bd28368441ec",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/eed6139bbdcce82d731cf20d4136bd28368441ec",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/eed6139bbdcce82d731cf20d4136bd28368441ec",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/eed6139bbdcce82d731cf20d4136bd28368441ec/comments",
    "author": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "dd18e448acf4491e693d862484d2e5802b0d41e3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/dd18e448acf4491e693d862484d2e5802b0d41e3",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/dd18e448acf4491e693d862484d2e5802b0d41e3"
      }
    ],
    "stats": {
      "total": 0,
      "additions": 0,
      "deletions": 0
    },
    "files": [
      {
        "sha": null,
        "filename": "qa/rpc-tests/txoutsbyaddress.py",
        "status": "modified",
        "additions": 0,
        "deletions": 0,
        "changes": 0,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/eed6139bbdcce82d731cf20d4136bd28368441ec/qa/rpc-tests/txoutsbyaddress.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/eed6139bbdcce82d731cf20d4136bd28368441ec/qa/rpc-tests/txoutsbyaddress.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/txoutsbyaddress.py?ref=eed6139bbdcce82d731cf20d4136bd28368441ec"
      }
    ]
  },
  {
    "sha": "5c2fb0d7b0fb1a229a4ec402a7259cd235724880",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1YzJmYjBkN2IwZmIxYTIyOWE0ZWM0MDJhNzI1OWNkMjM1NzI0ODgw",
    "commit": {
      "author": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2016-10-01T06:14:03Z"
      },
      "committer": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2017-01-04T01:04:40Z"
      },
      "message": "add doc for gettxoutsbyaddress REST endpoint",
      "tree": {
        "sha": "ef31d6badf765773f7cc6c218671ce967be6b7de",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ef31d6badf765773f7cc6c218671ce967be6b7de"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5c2fb0d7b0fb1a229a4ec402a7259cd235724880",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5c2fb0d7b0fb1a229a4ec402a7259cd235724880",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/5c2fb0d7b0fb1a229a4ec402a7259cd235724880",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5c2fb0d7b0fb1a229a4ec402a7259cd235724880/comments",
    "author": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "eed6139bbdcce82d731cf20d4136bd28368441ec",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/eed6139bbdcce82d731cf20d4136bd28368441ec",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/eed6139bbdcce82d731cf20d4136bd28368441ec"
      }
    ],
    "stats": {
      "total": 68,
      "additions": 68,
      "deletions": 0
    },
    "files": [
      {
        "sha": "714151718770ba02e9041be1913a46d9cfa1f4c3",
        "filename": "doc/REST-interface.md",
        "status": "modified",
        "additions": 68,
        "deletions": 0,
        "changes": 68,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5c2fb0d7b0fb1a229a4ec402a7259cd235724880/doc/REST-interface.md",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5c2fb0d7b0fb1a229a4ec402a7259cd235724880/doc/REST-interface.md",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/doc/REST-interface.md?ref=5c2fb0d7b0fb1a229a4ec402a7259cd235724880",
        "patch": "@@ -79,6 +79,74 @@ $ curl localhost:18332/rest/getutxos/checkmempool/b2cdfd7b89def827ff8af7cd9bff76\n }\n ```\n \n+####Query UTXO set (by address/script)\n+`GET /rest/gettxoutsbyaddress/<checkmempool>/<address>/<address>/.../<address>.json`\n+\n+The gettxoutsbyaddress command allows querying of the UTXO set given a set of addresses (or script).\n+\n+To use this function, you must start bitcoin with the -txoutindex parameter.\n+\n+Output:\n+```\n+[                                 (array of json object)\n+  {\n+    \\\"confirmations\\\" : n,        (numeric) The number of confirmations\n+    \\\"txid\\\" : \\\"txid\\\",          (string)  The transaction id \n+    \\\"vout\\\" : n,                 (numeric) The vout value\n+    \\\"value\\\" : x.xxx,            (numeric) The transaction value in btc\n+    \\\"scriptPubKey\\\" : {          (json object)\n+       \\\"asm\\\" : \\\"code\\\",        (string) \n+       \\\"hex\\\" : \\\"hex\\\",         (string) \n+       \\\"reqSigs\\\" : n,           (numeric) Number of required signatures\n+       \\\"type\\\" : \\\"pubkeyhash\\\", (string) The type, eg pubkeyhash\n+       \\\"addresses\\\" : [          (array of string) array of bitcoin addresses\n+          \\\"bitcoinaddress\\\"      (string) bitcoin address\n+          ,...\n+       ]\n+    },\n+    \\\"version\\\" : n,              (numeric) The transaction version\n+    \\\"coinbase\\\" : true|false     (boolean) Coinbase or not\n+    \\\"bestblockhash\\\" : \\\"hash\\\", (string)  The block hash of the best block\n+    \\\"bestblockheight\\\" : n,      (numeric) The block height of the best block\n+    \\\"bestblocktime\\\" : n,        (numeric) The block time of the best block\n+    \\\"blockhash\\\" : \\\"hash\\\",     (string)  The block hash of the block the tx is in (only if confirmations > 0)\n+    \\\"blockheight\\\" : n,          (numeric) The block height of the block the tx is in (only if confirmations > 0)\n+    \\\"blocktime\\\" : ttt,          (numeric) The block time in seconds since 1.1.1970 GMT (only if confirmations > 0)\n+  }\n+  ,...\n+]\n+```\n+\n+Example:\n+```\n+$ curl localhost:18332/rest/gettxoutsbyaddress/checkmempool/mvkA8gYrKUmXFiuFpoxNGjMjYcV9oCkwGV.json 2>/dev/null | json_pp\n+[\n+   {\n+      \"confirmations\" : 721918,\n+      \"txid\" : \"75bc54c673ed535db361a6e89c08bf7256d1378e2c645229d469d41042356e54\",\n+      \"vout\" : 0,\n+      \"value\" : 0.001,\n+      \"scriptPubKey\" : {\n+         \"asm\" : \"OP_DUP OP_HASH160 a7092d2dc8778b56d4c352697081c687b451ab6d OP_EQUALVERIFY OP_CHECKSIG\",\n+         \"hex\" : \"76a914a7092d2dc8778b56d4c352697081c687b451ab6d88ac\",\n+         \"reqSigs\" : 1,\n+         \"type\" : \"pubkeyhash\",\n+         \"addresses\" : [\n+            \"mvkA8gYrKUmXFiuFpoxNGjMjYcV9oCkwGV\"\n+         ]\n+      },\n+      \"version\" : 1,\n+      \"coinbase\" : false,\n+      \"bestblockhash\" : \"00000000007872ee19923a5604d86a6c9bfa3041c417a7ecf60dc034387b173f\",\n+      \"blockheight\" : 244755,\n+      \"bestblocktime\" : 1475309084,\n+      \"blockhash\" : \"000000000001c163caa76dbc16c7b383fb10257829b3617c5a1ffb91ea3824db\",\n+      \"bestblockheight\" : 966672,\n+      \"blocktime\" : 1400786412,\n+   }\n+]\n+```\n+\n ####Memory pool\n `GET /rest/mempool/info.json`\n "
      }
    ]
  },
  {
    "sha": "8804522e20e09a32181733a4d5b3cd9582fe2283",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4ODA0NTIyZTIwZTA5YTMyMTgxNzMzYTRkNWIzY2Q5NTgyZmUyMjgz",
    "commit": {
      "author": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2017-01-05T22:31:02Z"
      },
      "committer": {
        "name": "Daniel Newton",
        "email": "djpnewton@gmail.com",
        "date": "2017-01-05T22:31:02Z"
      },
      "message": "fix up a change missed by the rebase",
      "tree": {
        "sha": "d8ec7d18cd2f11db8fcf9eeb0de6967bdb6b768d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d8ec7d18cd2f11db8fcf9eeb0de6967bdb6b768d"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8804522e20e09a32181733a4d5b3cd9582fe2283",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8804522e20e09a32181733a4d5b3cd9582fe2283",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/8804522e20e09a32181733a4d5b3cd9582fe2283",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8804522e20e09a32181733a4d5b3cd9582fe2283/comments",
    "author": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "djpnewton",
      "id": 42459,
      "node_id": "MDQ6VXNlcjQyNDU5",
      "avatar_url": "https://avatars.githubusercontent.com/u/42459?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/djpnewton",
      "html_url": "https://github.com/djpnewton",
      "followers_url": "https://api.github.com/users/djpnewton/followers",
      "following_url": "https://api.github.com/users/djpnewton/following{/other_user}",
      "gists_url": "https://api.github.com/users/djpnewton/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/djpnewton/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/djpnewton/subscriptions",
      "organizations_url": "https://api.github.com/users/djpnewton/orgs",
      "repos_url": "https://api.github.com/users/djpnewton/repos",
      "events_url": "https://api.github.com/users/djpnewton/events{/privacy}",
      "received_events_url": "https://api.github.com/users/djpnewton/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "5c2fb0d7b0fb1a229a4ec402a7259cd235724880",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5c2fb0d7b0fb1a229a4ec402a7259cd235724880",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/5c2fb0d7b0fb1a229a4ec402a7259cd235724880"
      }
    ],
    "stats": {
      "total": 4,
      "additions": 3,
      "deletions": 1
    },
    "files": [
      {
        "sha": "8a6d4c3b7475fbe62af5bfb89edc56f09edc92ca",
        "filename": "src/init.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8804522e20e09a32181733a4d5b3cd9582fe2283/src/init.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8804522e20e09a32181733a4d5b3cd9582fe2283/src/init.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/init.cpp?ref=8804522e20e09a32181733a4d5b3cd9582fe2283",
        "patch": "@@ -1362,6 +1362,7 @@ bool AppInitMain(boost::thread_group& threadGroup, CScheduler& scheduler)\n                 UnloadBlockIndex();\n                 delete pcoinsTip;\n                 delete pcoinsdbview;\n+                delete pcoinsByScriptDB;\n                 delete pcoinscatcher;\n                 delete pblocktree;\n "
      },
      {
        "sha": "1693379d251a4026233c2313d14a48fdbc71b2fd",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8804522e20e09a32181733a4d5b3cd9582fe2283/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8804522e20e09a32181733a4d5b3cd9582fe2283/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=8804522e20e09a32181733a4d5b3cd9582fe2283",
        "patch": "@@ -2044,6 +2044,7 @@ void static UpdateAddressIndex(const CBlock& block, CBlockUndo& blockundo, bool\n     if (!fTxOutIndex)\n         return;\n \n+    assert(&block != nullptr);\n     assert(block.vtx.size() > 0);\n     unsigned int i = 0;\n     if (!fConnect)\n@@ -2256,7 +2257,7 @@ bool static ConnectTip(CValidationState& state, const CChainParams& chainparams,\n         LogPrint(\"bench\", \"  - Connect total: %.2fms [%.2fs]\\n\", (nTime3 - nTime2) * 0.001, nTimeConnectTotal * 0.000001);\n         bool flushed = view.Flush();\n         assert(flushed);\n-        UpdateAddressIndex(*pblock, blockundo, true);\n+        UpdateAddressIndex(blockConnecting, blockundo, true);\n     }\n     int64_t nTime4 = GetTimeMicros(); nTimeFlush += nTime4 - nTime3;\n     LogPrint(\"bench\", \"  - Flush: %.2fms [%.2fs]\\n\", (nTime4 - nTime3) * 0.001, nTimeFlush * 0.000001);"
      }
    ]
  }
]