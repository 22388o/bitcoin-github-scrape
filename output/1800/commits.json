[
  {
    "sha": "da7b8c1260d91e3306eb18dd65633567cb31332f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkYTdiOGMxMjYwZDkxZTMzMDZlYjE4ZGQ2NTYzMzU2N2NiMzEzMzJm",
    "commit": {
      "author": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2012-09-08T04:55:36Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2012-09-08T04:55:36Z"
      },
      "message": "Bugfix: Initialize CWallet::nOrderPosNext on an empty wallet, and save it in db",
      "tree": {
        "sha": "1fad88d0c8f5bb0953887c268e9a5a55910931d8",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1fad88d0c8f5bb0953887c268e9a5a55910931d8"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/da7b8c1260d91e3306eb18dd65633567cb31332f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/da7b8c1260d91e3306eb18dd65633567cb31332f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/da7b8c1260d91e3306eb18dd65633567cb31332f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/da7b8c1260d91e3306eb18dd65633567cb31332f/comments",
    "author": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ddb709e9de1490afcfa1af045517d2228d5b864c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ddb709e9de1490afcfa1af045517d2228d5b864c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ddb709e9de1490afcfa1af045517d2228d5b864c"
      }
    ],
    "stats": {
      "total": 32,
      "additions": 28,
      "deletions": 4
    },
    "files": [
      {
        "sha": "475fe1baf90b8bf31b4c3f2707bbcc7137092478",
        "filename": "src/rpcwallet.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/da7b8c1260d91e3306eb18dd65633567cb31332f/src/rpcwallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/da7b8c1260d91e3306eb18dd65633567cb31332f/src/rpcwallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpcwallet.cpp?ref=da7b8c1260d91e3306eb18dd65633567cb31332f",
        "patch": "@@ -544,7 +544,7 @@ Value movecmd(const Array& params, bool fHelp)\n \n     // Debit\n     CAccountingEntry debit;\n-    debit.nOrderPos = pwalletMain->nOrderPosNext++;\n+    debit.nOrderPos = pwalletMain->IncOrderPosNext();\n     debit.strAccount = strFrom;\n     debit.nCreditDebit = -nAmount;\n     debit.nTime = nNow;\n@@ -554,7 +554,7 @@ Value movecmd(const Array& params, bool fHelp)\n \n     // Credit\n     CAccountingEntry credit;\n-    credit.nOrderPos = pwalletMain->nOrderPosNext++;\n+    credit.nOrderPos = pwalletMain->IncOrderPosNext();\n     credit.strAccount = strTo;\n     credit.nCreditDebit = nAmount;\n     credit.nTime = nNow;"
      },
      {
        "sha": "8ac657288b687ee034a543112092f96bc5c29b97",
        "filename": "src/test/accounting_tests.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/da7b8c1260d91e3306eb18dd65633567cb31332f/src/test/accounting_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/da7b8c1260d91e3306eb18dd65633567cb31332f/src/test/accounting_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/accounting_tests.cpp?ref=da7b8c1260d91e3306eb18dd65633567cb31332f",
        "patch": "@@ -60,7 +60,7 @@ BOOST_AUTO_TEST_CASE(acc_orderupgrade)\n \n     ae.nTime = 1333333330;\n     ae.strOtherAccount = \"d\";\n-    ae.nOrderPos = pwalletMain->nOrderPosNext++;\n+    ae.nOrderPos = pwalletMain->IncOrderPosNext();\n     walletdb.WriteAccountingEntry(ae);\n \n     GetResults(walletdb, results);"
      },
      {
        "sha": "74c1112d60f6ed37020961c7c00bc6c54508c4ee",
        "filename": "src/wallet.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 1,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/da7b8c1260d91e3306eb18dd65633567cb31332f/src/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/da7b8c1260d91e3306eb18dd65633567cb31332f/src/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet.cpp?ref=da7b8c1260d91e3306eb18dd65633567cb31332f",
        "patch": "@@ -291,6 +291,13 @@ bool CWallet::EncryptWallet(const SecureString& strWalletPassphrase)\n     return true;\n }\n \n+int64 CWallet::IncOrderPosNext()\n+{\n+    int64 nRet = nOrderPosNext;\n+    CWalletDB(strWalletFile).WriteOrderPosNext(++nOrderPosNext);\n+    return nRet;\n+}\n+\n CWallet::TxItems CWallet::OrderedTxItems(std::list<CAccountingEntry>& acentries, std::string strAccount)\n {\n     CWalletDB walletdb(strWalletFile);\n@@ -362,7 +369,7 @@ bool CWallet::AddToWallet(const CWalletTx& wtxIn)\n         if (fInsertedNew)\n         {\n             wtx.nTimeReceived = GetAdjustedTime();\n-            wtx.nOrderPos = nOrderPosNext++;\n+            wtx.nOrderPos = IncOrderPosNext();\n \n             wtx.nTimeSmart = wtx.nTimeReceived;\n             if (wtxIn.hashBlock != 0)"
      },
      {
        "sha": "d3e9fd4ba4669daf093337855e02b524cfced25e",
        "filename": "src/wallet.h",
        "status": "modified",
        "additions": 7,
        "deletions": 0,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/da7b8c1260d91e3306eb18dd65633567cb31332f/src/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/da7b8c1260d91e3306eb18dd65633567cb31332f/src/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet.h?ref=da7b8c1260d91e3306eb18dd65633567cb31332f",
        "patch": "@@ -98,6 +98,7 @@ class CWallet : public CCryptoKeyStore\n         fFileBacked = false;\n         nMasterKeyMaxID = 0;\n         pwalletdbEncryption = NULL;\n+        nOrderPosNext = 0;\n     }\n     CWallet(std::string strWalletFileIn)\n     {\n@@ -107,6 +108,7 @@ class CWallet : public CCryptoKeyStore\n         fFileBacked = true;\n         nMasterKeyMaxID = 0;\n         pwalletdbEncryption = NULL;\n+        nOrderPosNext = 0;\n     }\n \n     std::map<uint256, CWalletTx> mapWallet;\n@@ -144,6 +146,11 @@ class CWallet : public CCryptoKeyStore\n     bool ChangeWalletPassphrase(const SecureString& strOldWalletPassphrase, const SecureString& strNewWalletPassphrase);\n     bool EncryptWallet(const SecureString& strWalletPassphrase);\n \n+    /** Increment the next transaction order id\n+        @return next transaction order id\n+     */\n+    int64 IncOrderPosNext();\n+\n     typedef std::pair<CWalletTx*, CAccountingEntry*> TxPair;\n     typedef std::multimap<int64, TxPair > TxItems;\n "
      },
      {
        "sha": "0fac0109c86bdc6e9c9e4dd6b9fe88a2e119254c",
        "filename": "src/walletdb.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/da7b8c1260d91e3306eb18dd65633567cb31332f/src/walletdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/da7b8c1260d91e3306eb18dd65633567cb31332f/src/walletdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/walletdb.cpp?ref=da7b8c1260d91e3306eb18dd65633567cb31332f",
        "patch": "@@ -392,6 +392,10 @@ int CWalletDB::LoadWallet(CWallet* pwallet)\n                     return DB_CORRUPT;\n                 }\n             }\n+            else if (strType == \"orderposnext\")\n+            {\n+                ssValue >> pwallet->nOrderPosNext;\n+            }\n         }\n         pcursor->close();\n     }"
      },
      {
        "sha": "d339d4c3f13227419ffcbb9a945bd7f0547232bf",
        "filename": "src/walletdb.h",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/da7b8c1260d91e3306eb18dd65633567cb31332f/src/walletdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/da7b8c1260d91e3306eb18dd65633567cb31332f/src/walletdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/walletdb.h?ref=da7b8c1260d91e3306eb18dd65633567cb31332f",
        "patch": "@@ -115,6 +115,12 @@ class CWalletDB : public CDB\n         return Read(std::string(\"bestblock\"), locator);\n     }\n \n+    bool WriteOrderPosNext(int64 nOrderPosNext)\n+    {\n+        nWalletDBUpdated++;\n+        return Write(std::string(\"orderposnext\"), nOrderPosNext);\n+    }\n+\n     bool ReadDefaultKey(std::vector<unsigned char>& vchPubKey)\n     {\n         vchPubKey.clear();"
      }
    ]
  }
]