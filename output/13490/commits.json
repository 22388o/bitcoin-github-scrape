[
  {
    "sha": "58c583da3a1db0dff9f5c68c206cbc0fac943dc5",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1OGM1ODNkYTNhMWRiMGRmZjlmNWM2OGMyMDZjYmMwZmFjOTQzZGM1",
    "commit": {
      "author": {
        "name": "qmma",
        "email": "qmma70@gmail.com",
        "date": "2018-06-18T00:32:30Z"
      },
      "committer": {
        "name": "qmma",
        "email": "qmma70@gmail.com",
        "date": "2018-06-18T00:32:30Z"
      },
      "message": "rewind when active block tip is higher than stopatheight",
      "tree": {
        "sha": "091f4dd5665fcc37aa0a2b932a35dc6170525778",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/091f4dd5665fcc37aa0a2b932a35dc6170525778"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/58c583da3a1db0dff9f5c68c206cbc0fac943dc5",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/58c583da3a1db0dff9f5c68c206cbc0fac943dc5",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/58c583da3a1db0dff9f5c68c206cbc0fac943dc5",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/58c583da3a1db0dff9f5c68c206cbc0fac943dc5/comments",
    "author": {
      "login": "qmma70",
      "id": 5808517,
      "node_id": "MDQ6VXNlcjU4MDg1MTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5808517?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/qmma70",
      "html_url": "https://github.com/qmma70",
      "followers_url": "https://api.github.com/users/qmma70/followers",
      "following_url": "https://api.github.com/users/qmma70/following{/other_user}",
      "gists_url": "https://api.github.com/users/qmma70/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/qmma70/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qmma70/subscriptions",
      "organizations_url": "https://api.github.com/users/qmma70/orgs",
      "repos_url": "https://api.github.com/users/qmma70/repos",
      "events_url": "https://api.github.com/users/qmma70/events{/privacy}",
      "received_events_url": "https://api.github.com/users/qmma70/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "qmma70",
      "id": 5808517,
      "node_id": "MDQ6VXNlcjU4MDg1MTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5808517?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/qmma70",
      "html_url": "https://github.com/qmma70",
      "followers_url": "https://api.github.com/users/qmma70/followers",
      "following_url": "https://api.github.com/users/qmma70/following{/other_user}",
      "gists_url": "https://api.github.com/users/qmma70/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/qmma70/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qmma70/subscriptions",
      "organizations_url": "https://api.github.com/users/qmma70/orgs",
      "repos_url": "https://api.github.com/users/qmma70/repos",
      "events_url": "https://api.github.com/users/qmma70/events{/privacy}",
      "received_events_url": "https://api.github.com/users/qmma70/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "d6cf4bd7eb3b675cdffec9884a6033f41033ad82",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d6cf4bd7eb3b675cdffec9884a6033f41033ad82",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/d6cf4bd7eb3b675cdffec9884a6033f41033ad82"
      }
    ],
    "stats": {
      "total": 16,
      "additions": 16,
      "deletions": 0
    },
    "files": [
      {
        "sha": "fd04666e3fc719755614fff7c029b4a7a6e2c057",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 16,
        "deletions": 0,
        "changes": 16,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/58c583da3a1db0dff9f5c68c206cbc0fac943dc5/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/58c583da3a1db0dff9f5c68c206cbc0fac943dc5/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=58c583da3a1db0dff9f5c68c206cbc0fac943dc5",
        "patch": "@@ -2765,6 +2765,22 @@ bool CChainState::ActivateBestChain(CValidationState &state, const CChainParams&\n         if (ShutdownRequested())\n             break;\n     } while (pindexNewTip != pindexMostWork);\n+\n+    // Rewind chain if the active chain's height is greater than nStopAtHeight.\n+    if (nStopAtHeight != DEFAULT_STOPATHEIGHT && pindexNewTip->nHeight > nStopAtHeight) {\n+        DisconnectedBlockTransactions disconnectpool;\n+        while (chainActive.Tip()->nHeight > nStopAtHeight) {\n+            LogPrintf(\"Rolling back to the exact nStopAtHeight: target=%d, current=%d\\n\",\n+                nStopAtHeight,\n+                chainActive.Tip()->nHeight);\n+            if (!DisconnectTip(state, chainparams, &disconnectpool)) {\n+                UpdateMempoolForReorg(disconnectpool, false);\n+                return false;\n+            }\n+        }\n+        UpdateMempoolForReorg(disconnectpool, true);\n+    }\n+\n     CheckBlockIndex(chainparams.GetConsensus());\n \n     // Write changes periodically to disk, after relay."
      }
    ]
  },
  {
    "sha": "6a6a80c75367e8ee1925b6e7c2842ec6e9cb485b",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2YTZhODBjNzUzNjdlOGVlMTkyNWI2ZTdjMjg0MmVjNmU5Y2I0ODVi",
    "commit": {
      "author": {
        "name": "qmma",
        "email": "qmma70@gmail.com",
        "date": "2018-06-18T01:37:38Z"
      },
      "committer": {
        "name": "qmma",
        "email": "qmma70@gmail.com",
        "date": "2018-06-18T01:37:38Z"
      },
      "message": "break inner loop if height exceeds nStopAtHeight",
      "tree": {
        "sha": "2cfff611acceb31aa47e7726d06943963d437042",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2cfff611acceb31aa47e7726d06943963d437042"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6a6a80c75367e8ee1925b6e7c2842ec6e9cb485b",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6a6a80c75367e8ee1925b6e7c2842ec6e9cb485b",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/6a6a80c75367e8ee1925b6e7c2842ec6e9cb485b",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6a6a80c75367e8ee1925b6e7c2842ec6e9cb485b/comments",
    "author": {
      "login": "qmma70",
      "id": 5808517,
      "node_id": "MDQ6VXNlcjU4MDg1MTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5808517?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/qmma70",
      "html_url": "https://github.com/qmma70",
      "followers_url": "https://api.github.com/users/qmma70/followers",
      "following_url": "https://api.github.com/users/qmma70/following{/other_user}",
      "gists_url": "https://api.github.com/users/qmma70/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/qmma70/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qmma70/subscriptions",
      "organizations_url": "https://api.github.com/users/qmma70/orgs",
      "repos_url": "https://api.github.com/users/qmma70/repos",
      "events_url": "https://api.github.com/users/qmma70/events{/privacy}",
      "received_events_url": "https://api.github.com/users/qmma70/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "qmma70",
      "id": 5808517,
      "node_id": "MDQ6VXNlcjU4MDg1MTc=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5808517?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/qmma70",
      "html_url": "https://github.com/qmma70",
      "followers_url": "https://api.github.com/users/qmma70/followers",
      "following_url": "https://api.github.com/users/qmma70/following{/other_user}",
      "gists_url": "https://api.github.com/users/qmma70/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/qmma70/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qmma70/subscriptions",
      "organizations_url": "https://api.github.com/users/qmma70/orgs",
      "repos_url": "https://api.github.com/users/qmma70/repos",
      "events_url": "https://api.github.com/users/qmma70/events{/privacy}",
      "received_events_url": "https://api.github.com/users/qmma70/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "58c583da3a1db0dff9f5c68c206cbc0fac943dc5",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/58c583da3a1db0dff9f5c68c206cbc0fac943dc5",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/58c583da3a1db0dff9f5c68c206cbc0fac943dc5"
      }
    ],
    "stats": {
      "total": 21,
      "additions": 6,
      "deletions": 15
    },
    "files": [
      {
        "sha": "1216ebb58e2438b60df1fcc3f3328945e9a9cbde",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 15,
        "changes": 21,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6a6a80c75367e8ee1925b6e7c2842ec6e9cb485b/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6a6a80c75367e8ee1925b6e7c2842ec6e9cb485b/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=6a6a80c75367e8ee1925b6e7c2842ec6e9cb485b",
        "patch": "@@ -2709,6 +2709,12 @@ bool CChainState::ActivateBestChain(CValidationState &state, const CChainParams&\n             CBlockIndex* starting_tip = chainActive.Tip();\n             bool blocks_connected = false;\n             do {\n+                if (nStopAtHeight != DEFAULT_STOPATHEIGHT\n+                        && chainActive.Tip()\n+                        && chainActive.Tip()->nHeight >= nStopAtHeight) {\n+                    break;\n+                }\n+\n                 // We absolutely may not unlock cs_main until we've made forward progress\n                 // (with the exception of shutdown due to hardware issues, low disk space, etc).\n                 ConnectTrace connectTrace(mempool); // Destructed before cs_main is unlocked\n@@ -2766,21 +2772,6 @@ bool CChainState::ActivateBestChain(CValidationState &state, const CChainParams&\n             break;\n     } while (pindexNewTip != pindexMostWork);\n \n-    // Rewind chain if the active chain's height is greater than nStopAtHeight.\n-    if (nStopAtHeight != DEFAULT_STOPATHEIGHT && pindexNewTip->nHeight > nStopAtHeight) {\n-        DisconnectedBlockTransactions disconnectpool;\n-        while (chainActive.Tip()->nHeight > nStopAtHeight) {\n-            LogPrintf(\"Rolling back to the exact nStopAtHeight: target=%d, current=%d\\n\",\n-                nStopAtHeight,\n-                chainActive.Tip()->nHeight);\n-            if (!DisconnectTip(state, chainparams, &disconnectpool)) {\n-                UpdateMempoolForReorg(disconnectpool, false);\n-                return false;\n-            }\n-        }\n-        UpdateMempoolForReorg(disconnectpool, true);\n-    }\n-\n     CheckBlockIndex(chainparams.GetConsensus());\n \n     // Write changes periodically to disk, after relay."
      }
    ]
  }
]