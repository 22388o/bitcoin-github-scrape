gmaxwell,2015-11-24T22:05:18Z,"For some time there has been some party connecting to every node on the network (sometimes multiple times) and fetching the mempool over and over again at high speed.  This wastes a ton of node's bandwidth. These fetches are also an information leak, as the frequent polling bypasses the trickle logic (and I believe that is their actual motivation, based on other behavior by the same IP).\n\nJgarzi",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-159419652,159419652,
gmaxwell,2015-11-25T05:17:07Z,"Pulltester fails because of known inadvisable stuff it does with the mempool command. I'm not sure what to do about that.\n\nI updated the patch so that the filter commands would reset the starting time to zero, allowing re-filtering of already filtered stuff.  I did this after observing breadwallet making multiple mempool requests (after keys were added). The downside of this is that no leaves op",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-159494355,159494355,
laanwj,2015-11-25T09:19:04Z,"> Pulltester fails because of known inadvisable stuff it does with the mempool command. I'm not sure what to do about that.\n\nWell, the proper fix would be that tests that want to probe the mempool should use the privileged RPC commands instead of the P2P message. Not sure how much work that would be in practice.\n",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-159545133,159545133,
laanwj,2015-11-25T11:33:30Z,Concept ACK\n,https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-159579078,159579078,
gmaxwell,2015-11-25T11:36:02Z,"So I think I have two mutually exclusive approaches to suggest: one is the current PR code that has a start and quantized end time.   The purpose of the start is to limit how much subsequent requests return.\n\nThe alternative is the quantized end time and a max depth, where it returns the top X of the feerate sorted mempool (but only txn which are before the end time).  This one might even worth ",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-159579496,159579496,
gmaxwell,2015-11-25T21:26:22Z,"A third option, would be to maintain a limited size set of responses sent already, and do the only top N of the mempool trick. That would combine both benefits (cpu benefit from considering only the top of the mempool, bandwidth benefit from not being willing to just send the same data multiple times). \n",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-159734884,159734884,
gmaxwell,2015-11-25T22:01:34Z,"Switched to that third option, using setInventoryKnown and only considering the top 8192 entries in the mempool.\n",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-159741376,159741376,
dgenr8,2015-11-26T01:29:49Z,TIL the default size of setInventoryKnown is only 1000.  It was 10000 before the default send buffer size was reduced.\n,https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-159774336,159774336,
gmaxwell,2015-11-26T02:36:09Z,"@dgenr8 ouch. I don't think it makes sense to link it to max_sendbuffer at all. I've unlinked it and set it to 50,000; so that we can at least take a whole inv on it. \n\n(I created another PR that changes it to a rolling bloomfilter; if that goes forward I'll rebase this on that.)\n",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-159785877,159785877,
laanwj,2015-11-26T09:50:22Z,"> @dgenr8 ouch. I don't think it makes sense to link it to max_sendbuffer at all. I've unlinked it and set it to 50,000; so that we can at least take a whole inv on it.\n\nFrom 1000 to 50,000 is quite an increase. How does that (approximately) affect worst-case memory usage per connected node?\n",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-159861521,159861521,
gmaxwell,2015-11-26T10:11:08Z,"@laanwj  See #7100 for my preferred solution (which I think adds about 400k per peer, though I've not measured yet)-- I just didn't want the 1000 messing up any testing here. \n",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-159867138,159867138,
DeftNerd,2015-11-30T20:25:35Z,"Wouldn't this pull (designed to make access to mempool information more difficult) damage future fee markets?\n\nI thought one of the points of RBF was to make it so we could keep small blocks and just pay higher necessary fees to have a transaction included in a block. \n\nIf there are tens of thousands of transactions clamoring to get included in blocks, then those wallets could alter their tran",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-160751523,160751523,
laanwj,2015-12-04T08:46:42Z,"Needs rebase, and to pass travis\n",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-161910094,161910094,
gmaxwell,2015-12-04T09:08:16Z,"@DeftNerd  mempool message are not suitable for that and you'll hear them via you'll hear the transactions through the normal transfer mechanism. If anything this pull makes it more suitable since its not sending you megabytes of IDs a dozen blocks deep in the history that you've already received from it.  The delay from it is only a few seconds, which isn't that large compared to the operation of",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-161914201,161914201,
laanwj,2015-12-04T09:17:52Z,Oh the blocktester... bleh I can't help you with that.\n@theuni Do you still remember how to change that beast?\n,https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-161916714,161916714,
laanwj,2015-12-04T09:32:29Z,"We could also deprecate the blocktester if we feel that its task has been sufficiently surpassed by the new test framework. But I'm not sure of this (in most part because I've never had a good grasp on what it actually does, being external software and in Java for that matter).\n",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-161919475,161919475,
sipa,2015-12-05T07:45:26Z,"@BugTheBlueMatt Would it be possible to reduce the blocktester to only do consensus checks, and not mempool checks?\n",https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-162159026,162159026,
laanwj,2016-04-11T12:08:01Z,To be clear: this is blocked by #4545\n,https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-208310888,208310888,
sipa,2016-04-11T12:19:38Z,Related (but not a replacement): #7840\n,https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-208313405,208313405,
gmaxwell,2016-05-20T07:58:52Z,#7840 moved forward enough that I'll close this for now.\n,https://github.com/bitcoin/bitcoin/pull/7093#issuecomment-220540191,220540191,
pstratem,2015-11-25T00:14:31Z,We've been using std::numeric_limits<int64_t>::max() elsewhere (also INT64_MAX seems to fail on arm?)\n,https://github.com/bitcoin/bitcoin/pull/7093#discussion_r45814457,45814457,src/rpcblockchain.cpp
pstratem,2015-11-25T00:33:53Z,"I can see this confusing someone in the future (I had to stop and think about it).\n\nNeeds a comment like ""equivalent to int64_t rounded_time = (GetTime() - 16); rounded_time = rounded_time - (rounded_time  % 16) but faster""\n",https://github.com/bitcoin/bitcoin/pull/7093#discussion_r45815956,45815956,src/main.cpp
laanwj,2015-11-25T09:28:10Z,"I'm not sure I understand the rationale behind not using the index because it would leak information. We're still querying on mi->GetTime() so 'leaking' the same information?\n\nIf the order of the result is the problem, we could just sort the result by hash before returning.\n",https://github.com/bitcoin/bitcoin/pull/7093#discussion_r45844725,45844725,src/txmempool.cpp
gmaxwell,2015-11-25T11:16:57Z,"Right the order is the problem. It's true that it could sort, but thats another expensive operation, and the result being in fee sorted order is quite useful... e.g. if the peer wanted to grab just the top of the mempool.\n",https://github.com/bitcoin/bitcoin/pull/7093#discussion_r45855189,45855189,src/txmempool.cpp
laanwj,2015-11-25T11:29:35Z,I'm not sure how a post-sort of the result would stack up against bypassing a linear scan when an index exists anyway. It depends on the input and output sizes.\nIn the least this compromise is more subtle than the comment makes it look.\n,https://github.com/bitcoin/bitcoin/pull/7093#discussion_r45856118,45856118,src/txmempool.cpp
sipa,2015-11-25T11:32:26Z,"We can also use any of the other indexes we have, like the feerate one?\n",https://github.com/bitcoin/bitcoin/pull/7093#discussion_r45856324,45856324,src/txmempool.cpp
laanwj,2015-11-25T11:33:15Z,But the query is by time range - so wouldn't the time be the only index that helps speed this up?\n,https://github.com/bitcoin/bitcoin/pull/7093#discussion_r45856378,45856378,src/txmempool.cpp
morcos,2015-12-11T16:41:03Z,"If your intention is to add the top sorted txs by fee rate then you need to iterate over index 3.\n\nWe should keep in mind other uses (like this) that that index takes on (utxo cache priming, fee estimation) because the intention had been to change that index to be a sort of ancestor fee rate packages, which isn't necessarily what's wanted for the other use cases.\n",https://github.com/bitcoin/bitcoin/pull/7093#discussion_r47375484,47375484,src/txmempool.cpp
