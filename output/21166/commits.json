[
  {
    "sha": "6965456c10c9c4025c71c5e24fa5b27b15e5933a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2OTY1NDU2YzEwYzljNDAyNWM3MWM1ZTI0ZmE1YjI3YjE1ZTU5MzNh",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-02-12T19:18:50Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-03-05T02:54:32Z"
      },
      "message": "Introduce DeferringSignatureChecker and inherit with SignatureExtractor\n\nIntroduces a DeferringSignatureChecker which simply takes a\nBaseSignatureChecker and passes through everything.\nSignatureExtractorChecker now subclasses DeferringSignatureChecker. This\nallows for all BaseSignatureChecker functions to be implemented for\nSignatureExtractorChecker, while allowing for future signature checkers\nwhich opreate similarly to SignatureExtractorChecker.",
      "tree": {
        "sha": "3b047d2fa2e9fa98a3998ff64622e5e880942f49",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/3b047d2fa2e9fa98a3998ff64622e5e880942f49"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6965456c10c9c4025c71c5e24fa5b27b15e5933a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6965456c10c9c4025c71c5e24fa5b27b15e5933a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/6965456c10c9c4025c71c5e24fa5b27b15e5933a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6965456c10c9c4025c71c5e24fa5b27b15e5933a/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e9c037ba64dd5b073fccf059ef75db1c97abd0bd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e9c037ba64dd5b073fccf059ef75db1c97abd0bd",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e9c037ba64dd5b073fccf059ef75db1c97abd0bd"
      }
    ],
    "stats": {
      "total": 36,
      "additions": 32,
      "deletions": 4
    },
    "files": [
      {
        "sha": "effbc055d4f65e032a52cba2468efa55b8911b9f",
        "filename": "src/script/interpreter.h",
        "status": "modified",
        "additions": 28,
        "deletions": 0,
        "changes": 28,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6965456c10c9c4025c71c5e24fa5b27b15e5933a/src/script/interpreter.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6965456c10c9c4025c71c5e24fa5b27b15e5933a/src/script/interpreter.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/interpreter.h?ref=6965456c10c9c4025c71c5e24fa5b27b15e5933a",
        "patch": "@@ -272,6 +272,34 @@ class GenericTransactionSignatureChecker : public BaseSignatureChecker\n using TransactionSignatureChecker = GenericTransactionSignatureChecker<CTransaction>;\n using MutableTransactionSignatureChecker = GenericTransactionSignatureChecker<CMutableTransaction>;\n \n+class DeferringSignatureChecker : public BaseSignatureChecker\n+{\n+protected:\n+    BaseSignatureChecker& m_checker;\n+\n+public:\n+    DeferringSignatureChecker(BaseSignatureChecker& checker) : m_checker(checker) {}\n+\n+    bool CheckECDSASignature(const std::vector<unsigned char>& scriptSig, const std::vector<unsigned char>& vchPubKey, const CScript& scriptCode, SigVersion sigversion) const override\n+    {\n+        return m_checker.CheckECDSASignature(scriptSig, vchPubKey, scriptCode, sigversion);\n+    }\n+\n+    bool CheckSchnorrSignature(Span<const unsigned char> sig, Span<const unsigned char> pubkey, SigVersion sigversion, const ScriptExecutionData& execdata, ScriptError* serror = nullptr) const override\n+    {\n+        return m_checker.CheckSchnorrSignature(sig, pubkey, sigversion, execdata, serror);\n+    }\n+\n+    bool CheckLockTime(const CScriptNum& nLockTime) const override\n+    {\n+        return m_checker.CheckLockTime(nLockTime);\n+    }\n+    bool CheckSequence(const CScriptNum& nSequence) const override\n+    {\n+        return m_checker.CheckSequence(nSequence);\n+    }\n+};\n+\n bool EvalScript(std::vector<std::vector<unsigned char> >& stack, const CScript& script, unsigned int flags, const BaseSignatureChecker& checker, SigVersion sigversion, ScriptExecutionData& execdata, ScriptError* error = nullptr);\n bool EvalScript(std::vector<std::vector<unsigned char> >& stack, const CScript& script, unsigned int flags, const BaseSignatureChecker& checker, SigVersion sigversion, ScriptError* error = nullptr);\n bool VerifyScript(const CScript& scriptSig, const CScript& scriptPubKey, const CScriptWitness* witness, unsigned int flags, const BaseSignatureChecker& checker, ScriptError* serror = nullptr);"
      },
      {
        "sha": "3c8f6d22ead56011e6a27d98fc2d9c3e29bfb759",
        "filename": "src/script/sign.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 4,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6965456c10c9c4025c71c5e24fa5b27b15e5933a/src/script/sign.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6965456c10c9c4025c71c5e24fa5b27b15e5933a/src/script/sign.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/sign.cpp?ref=6965456c10c9c4025c71c5e24fa5b27b15e5933a",
        "patch": "@@ -250,17 +250,17 @@ bool ProduceSignature(const SigningProvider& provider, const BaseSignatureCreato\n }\n \n namespace {\n-class SignatureExtractorChecker final : public BaseSignatureChecker\n+class SignatureExtractorChecker final : public DeferringSignatureChecker\n {\n private:\n     SignatureData& sigdata;\n-    BaseSignatureChecker& checker;\n \n public:\n-    SignatureExtractorChecker(SignatureData& sigdata, BaseSignatureChecker& checker) : sigdata(sigdata), checker(checker) {}\n+    SignatureExtractorChecker(SignatureData& sigdata, BaseSignatureChecker& checker) : DeferringSignatureChecker(checker), sigdata(sigdata) {}\n+\n     bool CheckECDSASignature(const std::vector<unsigned char>& scriptSig, const std::vector<unsigned char>& vchPubKey, const CScript& scriptCode, SigVersion sigversion) const override\n     {\n-        if (checker.CheckECDSASignature(scriptSig, vchPubKey, scriptCode, sigversion)) {\n+        if (m_checker.CheckECDSASignature(scriptSig, vchPubKey, scriptCode, sigversion)) {\n             CPubKey pubkey(vchPubKey);\n             sigdata.signatures.emplace(pubkey.GetID(), SigPair(pubkey, scriptSig));\n             return true;"
      }
    ]
  },
  {
    "sha": "a97a9298cea085858e1a65a5e9b20d7a9e0f7303",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphOTdhOTI5OGNlYTA4NTg1OGUxYTY1YTVlOWIyMGQ3YTllMGY3MzAz",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-02-12T20:38:46Z"
      },
      "committer": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2021-03-05T02:54:34Z"
      },
      "message": "Test that signrawtx works when a signed CSV and CLTV inputs are present",
      "tree": {
        "sha": "37f985646bf279e3e0dc4fd37c7d2448c3da2b7a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/37f985646bf279e3e0dc4fd37c7d2448c3da2b7a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a97a9298cea085858e1a65a5e9b20d7a9e0f7303",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a97a9298cea085858e1a65a5e9b20d7a9e0f7303",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a97a9298cea085858e1a65a5e9b20d7a9e0f7303",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a97a9298cea085858e1a65a5e9b20d7a9e0f7303/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6965456c10c9c4025c71c5e24fa5b27b15e5933a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6965456c10c9c4025c71c5e24fa5b27b15e5933a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6965456c10c9c4025c71c5e24fa5b27b15e5933a"
      }
    ],
    "stats": {
      "total": 83,
      "additions": 79,
      "deletions": 4
    },
    "files": [
      {
        "sha": "60b4d1c7447c9fbb707be62b588c6f7dcc6884a1",
        "filename": "test/functional/rpc_signrawtransaction.py",
        "status": "modified",
        "additions": 79,
        "deletions": 4,
        "changes": 83,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a97a9298cea085858e1a65a5e9b20d7a9e0f7303/test/functional/rpc_signrawtransaction.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a97a9298cea085858e1a65a5e9b20d7a9e0f7303/test/functional/rpc_signrawtransaction.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_signrawtransaction.py?ref=a97a9298cea085858e1a65a5e9b20d7a9e0f7303",
        "patch": "@@ -4,16 +4,17 @@\n # file COPYING or http://www.opensource.org/licenses/mit-license.php.\n \"\"\"Test transaction signing using the signrawtransaction* RPCs.\"\"\"\n \n-from test_framework.address import check_script, script_to_p2sh\n+from test_framework.address import check_script, script_to_p2sh, script_to_p2wsh\n from test_framework.key import ECKey\n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.util import assert_equal, assert_raises_rpc_error, find_vout_for_address, hex_str_to_bytes\n-from test_framework.messages import sha256\n-from test_framework.script import CScript, OP_0, OP_CHECKSIG\n+from test_framework.messages import sha256, CTransaction, CTxInWitness\n+from test_framework.script import CScript, OP_0, OP_CHECKSIG, OP_CHECKSEQUENCEVERIFY, OP_CHECKLOCKTIMEVERIFY, OP_DROP, OP_TRUE\n from test_framework.script_util import key_to_p2pkh_script, script_to_p2sh_p2wsh_script, script_to_p2wsh_script\n from test_framework.wallet_util import bytes_to_wif\n \n-from decimal import Decimal\n+from decimal import Decimal, getcontext\n+from io import BytesIO\n \n class SignRawTransactionsTest(BitcoinTestFramework):\n     def set_test_params(self):\n@@ -238,13 +239,87 @@ def OP_1NEGATE_test(self):\n         txn = self.nodes[0].signrawtransactionwithwallet(hex_str, prev_txs)\n         assert txn[\"complete\"]\n \n+    def test_signing_with_csv(self):\n+        self.log.info(\"Test signing a transaction containing a fully signed CSV input\")\n+        self.nodes[0].walletpassphrase(\"password\", 9999)\n+        getcontext().prec = 8\n+\n+        # Make sure CSV is active\n+        self.nodes[0].generate(500)\n+\n+        # Create a P2WSH script with CSV\n+        script = CScript([1, OP_CHECKSEQUENCEVERIFY, OP_DROP])\n+        address = script_to_p2wsh(script)\n+\n+        # Fund that address and make the spend\n+        txid = self.nodes[0].sendtoaddress(address, 1)\n+        vout = find_vout_for_address(self.nodes[0], txid, address)\n+        self.nodes[0].generate(1)\n+        utxo = self.nodes[0].listunspent()[0]\n+        amt = Decimal(1) + utxo[\"amount\"] - Decimal(0.00001)\n+        tx = self.nodes[0].createrawtransaction(\n+            [{\"txid\": txid, \"vout\": vout, \"sequence\": 1},{\"txid\": utxo[\"txid\"], \"vout\": utxo[\"vout\"]}],\n+            [{self.nodes[0].getnewaddress(): amt}],\n+            self.nodes[0].getblockcount()\n+        )\n+\n+        # Set the witness script\n+        ctx = CTransaction()\n+        ctx.deserialize(BytesIO(hex_str_to_bytes(tx)))\n+        ctx.wit.vtxinwit.append(CTxInWitness())\n+        ctx.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE]), script]\n+        tx = ctx.serialize_with_witness().hex()\n+\n+        # Sign and send the transaction\n+        signed = self.nodes[0].signrawtransactionwithwallet(tx)\n+        assert_equal(signed[\"complete\"], True)\n+        self.nodes[0].sendrawtransaction(signed[\"hex\"])\n+\n+    def test_signing_with_cltv(self):\n+        self.log.info(\"Test signing a transaction containing a fully signed CLTV input\")\n+        self.nodes[0].walletpassphrase(\"password\", 9999)\n+        getcontext().prec = 8\n+\n+        # Make sure CSV is active\n+        self.nodes[0].generate(1500)\n+\n+        # Create a P2WSH script with CLTV\n+        script = CScript([1000, OP_CHECKLOCKTIMEVERIFY, OP_DROP])\n+        address = script_to_p2wsh(script)\n+\n+        # Fund that address and make the spend\n+        txid = self.nodes[0].sendtoaddress(address, 1)\n+        vout = find_vout_for_address(self.nodes[0], txid, address)\n+        self.nodes[0].generate(1)\n+        utxo = self.nodes[0].listunspent()[0]\n+        amt = Decimal(1) + utxo[\"amount\"] - Decimal(0.00001)\n+        tx = self.nodes[0].createrawtransaction(\n+            [{\"txid\": txid, \"vout\": vout},{\"txid\": utxo[\"txid\"], \"vout\": utxo[\"vout\"]}],\n+            [{self.nodes[0].getnewaddress(): amt}],\n+            self.nodes[0].getblockcount()\n+        )\n+\n+        # Set the witness script\n+        ctx = CTransaction()\n+        ctx.deserialize(BytesIO(hex_str_to_bytes(tx)))\n+        ctx.wit.vtxinwit.append(CTxInWitness())\n+        ctx.wit.vtxinwit[0].scriptWitness.stack = [CScript([OP_TRUE]), script]\n+        tx = ctx.serialize_with_witness().hex()\n+\n+        # Sign and send the transaction\n+        signed = self.nodes[0].signrawtransactionwithwallet(tx)\n+        assert_equal(signed[\"complete\"], True)\n+        self.nodes[0].sendrawtransaction(signed[\"hex\"])\n+\n     def run_test(self):\n         self.successful_signing_test()\n         self.script_verification_error_test()\n         self.witness_script_test()\n         self.OP_1NEGATE_test()\n         self.test_with_lock_outputs()\n         self.test_fully_signed_tx()\n+        self.test_signing_with_csv()\n+        self.test_signing_with_cltv()\n \n \n if __name__ == '__main__':"
      }
    ]
  }
]