[
  {
    "sha": "8602a1e6aeca65911e4d4c821d3575147ba32a7e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4NjAyYTFlNmFlY2E2NTkxMWU0ZDRjODIxZDM1NzUxNDdiYTMyYTdl",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-01-31T00:04:51Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-02-04T12:22:55Z"
      },
      "message": "wallet: Close dbenv error file db.log\n\nThe error file db.log is opened by BerkeleyEnvironment instance and\nshould be closed after dbenv is closed.",
      "tree": {
        "sha": "677d586a761a8c1e7ba982e870e52f97044567fa",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/677d586a761a8c1e7ba982e870e52f97044567fa"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8602a1e6aeca65911e4d4c821d3575147ba32a7e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8602a1e6aeca65911e4d4c821d3575147ba32a7e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/8602a1e6aeca65911e4d4c821d3575147ba32a7e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8602a1e6aeca65911e4d4c821d3575147ba32a7e/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "64127b3098a1aab70200b6d07194dce072ad5cf2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/64127b3098a1aab70200b6d07194dce072ad5cf2",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/64127b3098a1aab70200b6d07194dce072ad5cf2"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 5,
      "deletions": 0
    },
    "files": [
      {
        "sha": "24911846ed7d83e9cf1200e2c531195442c34ad6",
        "filename": "src/wallet/db.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8602a1e6aeca65911e4d4c821d3575147ba32a7e/src/wallet/db.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8602a1e6aeca65911e4d4c821d3575147ba32a7e/src/wallet/db.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/db.cpp?ref=8602a1e6aeca65911e4d4c821d3575147ba32a7e",
        "patch": "@@ -126,11 +126,16 @@ void BerkeleyEnvironment::Close()\n         }\n     }\n \n+    FILE* error_file = nullptr;\n+    dbenv->get_errfile(&error_file);\n+\n     int ret = dbenv->close(0);\n     if (ret != 0)\n         LogPrintf(\"BerkeleyEnvironment::Close: Error %d closing database environment: %s\\n\", ret, DbEnv::strerror(ret));\n     if (!fMockDb)\n         DbEnv((u_int32_t)0).remove(strPath.c_str(), 0);\n+\n+    if (error_file) fclose(error_file);\n }\n \n void BerkeleyEnvironment::Reset()"
      }
    ]
  },
  {
    "sha": "2f8b8f479bb43729ca2ff40929e8463347b0b7b4",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyZjhiOGY0NzliYjQzNzI5Y2EyZmY0MDkyOWU4NDYzMzQ3YjBiN2I0",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-01-31T00:05:18Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-02-04T12:22:55Z"
      },
      "message": "wallet: Close wallet env lock file\n\nClose .walletlock file when a BerkeleyEnvironment is deleted.",
      "tree": {
        "sha": "d8ac8861dc68f4cfad476acd43d64e612c81792a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/d8ac8861dc68f4cfad476acd43d64e612c81792a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/2f8b8f479bb43729ca2ff40929e8463347b0b7b4",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2f8b8f479bb43729ca2ff40929e8463347b0b7b4",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/2f8b8f479bb43729ca2ff40929e8463347b0b7b4",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2f8b8f479bb43729ca2ff40929e8463347b0b7b4/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "8602a1e6aeca65911e4d4c821d3575147ba32a7e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8602a1e6aeca65911e4d4c821d3575147ba32a7e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/8602a1e6aeca65911e4d4c821d3575147ba32a7e"
      }
    ],
    "stats": {
      "total": 9,
      "additions": 9,
      "deletions": 0
    },
    "files": [
      {
        "sha": "d8b70ee52ca3792a8300893eb3f869bf980173c0",
        "filename": "src/util/system.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2f8b8f479bb43729ca2ff40929e8463347b0b7b4/src/util/system.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2f8b8f479bb43729ca2ff40929e8463347b0b7b4/src/util/system.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/system.cpp?ref=2f8b8f479bb43729ca2ff40929e8463347b0b7b4",
        "patch": "@@ -116,6 +116,12 @@ bool LockDirectory(const fs::path& directory, const std::string lockfile_name, b\n     return true;\n }\n \n+void UnlockDirectory(const fs::path& directory, const std::string& lockfile_name)\n+{\n+    std::lock_guard<std::mutex> lock(cs_dir_locks);\n+    dir_locks.erase((directory / lockfile_name).string());\n+}\n+\n void ReleaseDirectoryLocks()\n {\n     std::lock_guard<std::mutex> ulock(cs_dir_locks);"
      },
      {
        "sha": "17723d427dadeed2a0a23e31a40afcc718aaeabd",
        "filename": "src/util/system.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2f8b8f479bb43729ca2ff40929e8463347b0b7b4/src/util/system.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2f8b8f479bb43729ca2ff40929e8463347b0b7b4/src/util/system.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util/system.h?ref=2f8b8f479bb43729ca2ff40929e8463347b0b7b4",
        "patch": "@@ -70,6 +70,7 @@ int RaiseFileDescriptorLimit(int nMinFD);\n void AllocateFileRange(FILE *file, unsigned int offset, unsigned int length);\n bool RenameOver(fs::path src, fs::path dest);\n bool LockDirectory(const fs::path& directory, const std::string lockfile_name, bool probe_only=false);\n+void UnlockDirectory(const fs::path& directory, const std::string& lockfile_name);\n bool DirIsWritable(const fs::path& directory);\n \n /** Release all directory locks. This is used for unit testing only, at runtime"
      },
      {
        "sha": "463f8e1f41a05fd8ed9d0eed80ee348eed37b7d2",
        "filename": "src/wallet/db.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 0,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/2f8b8f479bb43729ca2ff40929e8463347b0b7b4/src/wallet/db.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/2f8b8f479bb43729ca2ff40929e8463347b0b7b4/src/wallet/db.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/db.cpp?ref=2f8b8f479bb43729ca2ff40929e8463347b0b7b4",
        "patch": "@@ -136,6 +136,8 @@ void BerkeleyEnvironment::Close()\n         DbEnv((u_int32_t)0).remove(strPath.c_str(), 0);\n \n     if (error_file) fclose(error_file);\n+\n+    UnlockDirectory(strPath, \".walletlock\");\n }\n \n void BerkeleyEnvironment::Reset()"
      }
    ]
  },
  {
    "sha": "d3bf3b930d34da7d121ae35b4fb75865ed73208c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkM2JmM2I5MzBkMzRkYTdkMTIxYWUzNWI0ZmI3NTg2NWVkNzMyMDhj",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-02-04T18:50:21Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-02-04T18:50:21Z"
      },
      "message": "qa: Test .walletlock file is closed",
      "tree": {
        "sha": "dbabb4d5cf1a884ecf13fadd7dcdea93b203335c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/dbabb4d5cf1a884ecf13fadd7dcdea93b203335c"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d3bf3b930d34da7d121ae35b4fb75865ed73208c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d3bf3b930d34da7d121ae35b4fb75865ed73208c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/d3bf3b930d34da7d121ae35b4fb75865ed73208c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d3bf3b930d34da7d121ae35b4fb75865ed73208c/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "2f8b8f479bb43729ca2ff40929e8463347b0b7b4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/2f8b8f479bb43729ca2ff40929e8463347b0b7b4",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/2f8b8f479bb43729ca2ff40929e8463347b0b7b4"
      }
    ],
    "stats": {
      "total": 8,
      "additions": 8,
      "deletions": 0
    },
    "files": [
      {
        "sha": "df778f57df79b1f31f3cab623db2f9882c91d406",
        "filename": "test/functional/wallet_multiwallet.py",
        "status": "modified",
        "additions": 8,
        "deletions": 0,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d3bf3b930d34da7d121ae35b4fb75865ed73208c/test/functional/wallet_multiwallet.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d3bf3b930d34da7d121ae35b4fb75865ed73208c/test/functional/wallet_multiwallet.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/wallet_multiwallet.py?ref=d3bf3b930d34da7d121ae35b4fb75865ed73208c",
        "patch": "@@ -315,6 +315,14 @@ def wallet_file(name):\n             self.nodes[0].loadwallet(wallet_name)\n             assert_equal(rpc.getaddressinfo(addr)['ismine'], True)\n \n+        # Test .walletlock file is closed\n+        self.start_node(1)\n+        wallet = os.path.join(self.options.tmpdir, 'my_wallet')\n+        self.nodes[0].createwallet(wallet)\n+        assert_raises_rpc_error(-4, \"Error initializing wallet database environment\", self.nodes[1].loadwallet, wallet)\n+        self.nodes[0].unloadwallet(wallet)\n+        self.nodes[1].loadwallet(wallet)\n+\n \n if __name__ == '__main__':\n     MultiWalletTest().main()"
      }
    ]
  }
]