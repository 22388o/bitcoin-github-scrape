[
  {
    "sha": "88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4OGJjNWY5NDg1MmEwYjI4MzlhM2VmNGUxYTZhNTE2OGQwMmY2YjU1",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2012-02-11T19:02:55Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2012-02-11T20:59:33Z"
      },
      "message": "Macros for manual critical sections",
      "tree": {
        "sha": "af95db0a5e8bfc151165a0958956710e5b3c8e5d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/af95db0a5e8bfc151165a0958956710e5b3c8e5d"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b25474d1bea42ab6e20fb2b86714db0ece8f1c74",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b25474d1bea42ab6e20fb2b86714db0ece8f1c74",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b25474d1bea42ab6e20fb2b86714db0ece8f1c74"
      }
    ],
    "stats": {
      "total": 12,
      "additions": 9,
      "deletions": 3
    },
    "files": [
      {
        "sha": "a66bc15438b88f6983d4ecb79aad8cbeb0445c96",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55",
        "patch": "@@ -279,7 +279,7 @@ class CNode\n \n     void BeginMessage(const char* pszCommand)\n     {\n-        cs_vSend.Enter(\"cs_vSend\", __FILE__, __LINE__);\n+        ENTER_CRITICAL_SECTION(cs_vSend);\n         if (nHeaderStart != -1)\n             AbortMessage();\n         nHeaderStart = vSend.size();\n@@ -298,7 +298,7 @@ class CNode\n         vSend.resize(nHeaderStart);\n         nHeaderStart = -1;\n         nMessageStart = -1;\n-        cs_vSend.Leave();\n+        LEAVE_CRITICAL_SECTION(cs_vSend);\n \n         if (fDebug)\n             printf(\"(aborted)\\n\");\n@@ -336,7 +336,7 @@ class CNode\n \n         nHeaderStart = -1;\n         nMessageStart = -1;\n-        cs_vSend.Leave();\n+        LEAVE_CRITICAL_SECTION(cs_vSend);\n     }\n \n     void EndMessageAbortIfEmpty()"
      },
      {
        "sha": "ddc8791b385deb57dee47b1d7304e0a9dada75b7",
        "filename": "src/util.h",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55/src/util.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55/src/util.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/util.h?ref=88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55",
        "patch": "@@ -218,6 +218,12 @@ class CCriticalBlock\n #define CRITICAL_BLOCK(cs)     \\\n     if (CCriticalBlock criticalblock = CCriticalBlock(cs, #cs, __FILE__, __LINE__))\n \n+#define ENTER_CRITICAL_SECTION(cs) \\\n+    (cs).Enter(#cs, __FILE__, __LINE__)\n+\n+#define LEAVE_CRITICAL_SECTION(cs) \\\n+    (cs).Leave()\n+\n class CTryCriticalBlock\n {\n protected:"
      }
    ]
  },
  {
    "sha": "b0529ffd951fdaa7ecc823381a6a7b0c88b5b2b0",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiMDUyOWZmZDk1MWZkYWE3ZWNjODIzMzgxYTZhN2IwYzg4YjViMmIw",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2012-02-11T15:35:40Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2012-02-11T20:59:39Z"
      },
      "message": "Fix wallet locking locking",
      "tree": {
        "sha": "1b57faafefae397a8c35ce816cba186f06832f03",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/1b57faafefae397a8c35ce816cba186f06832f03"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b0529ffd951fdaa7ecc823381a6a7b0c88b5b2b0",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b0529ffd951fdaa7ecc823381a6a7b0c88b5b2b0",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b0529ffd951fdaa7ecc823381a6a7b0c88b5b2b0",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b0529ffd951fdaa7ecc823381a6a7b0c88b5b2b0/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/88bc5f94852a0b2839a3ef4e1a6a5168d02f6b55"
      }
    ],
    "stats": {
      "total": 30,
      "additions": 14,
      "deletions": 16
    },
    "files": [
      {
        "sha": "8f981356172a9943096f4f41dae722a1ccb35cb4",
        "filename": "src/bitcoinrpc.cpp",
        "status": "modified",
        "additions": 14,
        "deletions": 16,
        "changes": 30,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b0529ffd951fdaa7ecc823381a6a7b0c88b5b2b0/src/bitcoinrpc.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b0529ffd951fdaa7ecc823381a6a7b0c88b5b2b0/src/bitcoinrpc.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bitcoinrpc.cpp?ref=b0529ffd951fdaa7ecc823381a6a7b0c88b5b2b0",
        "patch": "@@ -1539,33 +1539,31 @@ void ThreadCleanWalletPassphrase(void* parg)\n {\n     int64 nMyWakeTime = GetTime() + *((int*)parg);\n \n+    ENTER_CRITICAL_SECTION(cs_nWalletUnlockTime);\n+\n     if (nWalletUnlockTime == 0)\n     {\n-        CRITICAL_BLOCK(cs_nWalletUnlockTime)\n-        {\n-            nWalletUnlockTime = nMyWakeTime;\n-        }\n+        nWalletUnlockTime = nMyWakeTime;\n \n         while (GetTime() < nWalletUnlockTime)\n-            Sleep(GetTime() - nWalletUnlockTime);\n-\n-        CRITICAL_BLOCK(cs_nWalletUnlockTime)\n         {\n-            nWalletUnlockTime = 0;\n+            int64 nToSleep = GetTime() - nWalletUnlockTime;\n+\n+            LEAVE_CRITICAL_SECTION(cs_nWalletUnlockTime);\n+            Sleep(nToSleep);\n+            ENTER_CRITICAL_SECTION(cs_nWalletUnlockTime);\n         }\n+\n+        nWalletUnlockTime = 0;\n+        pwalletMain->Lock();\n     }\n     else\n     {\n-        CRITICAL_BLOCK(cs_nWalletUnlockTime)\n-        {\n-            if (nWalletUnlockTime < nMyWakeTime)\n-                nWalletUnlockTime = nMyWakeTime;\n-        }\n-        delete (int*)parg;\n-        return;\n+        if (nWalletUnlockTime < nMyWakeTime)\n+            nWalletUnlockTime = nMyWakeTime;\n     }\n \n-    pwalletMain->Lock();\n+    LEAVE_CRITICAL_SECTION(cs_nWalletUnlockTime);\n \n     delete (int*)parg;\n }"
      }
    ]
  },
  {
    "sha": "aa625ed6ed0ec7060859225cf9d43799eed5a799",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphYTYyNWVkNmVkMGVjNzA2MDg1OTIyNWNmOWQ0Mzc5OWVlZDVhNzk5",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2012-02-11T17:01:24Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2012-02-11T20:59:39Z"
      },
      "message": "Extra wallet locking fixes\n\n* Fix sign error in calculation of seconds to sleep\n* Do not mix GetTime() (seconds) and Sleep() (milliseconds)\n* Do not sleep forever if walletlock() is called\n* Do locking within critical section",
      "tree": {
        "sha": "854df8f389ae02d33ad806fea22e9d0d067af7f9",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/854df8f389ae02d33ad806fea22e9d0d067af7f9"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/aa625ed6ed0ec7060859225cf9d43799eed5a799",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/aa625ed6ed0ec7060859225cf9d43799eed5a799",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/aa625ed6ed0ec7060859225cf9d43799eed5a799",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/aa625ed6ed0ec7060859225cf9d43799eed5a799/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "b0529ffd951fdaa7ecc823381a6a7b0c88b5b2b0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b0529ffd951fdaa7ecc823381a6a7b0c88b5b2b0",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/b0529ffd951fdaa7ecc823381a6a7b0c88b5b2b0"
      }
    ],
    "stats": {
      "total": 24,
      "additions": 16,
      "deletions": 8
    },
    "files": [
      {
        "sha": "cf5bc64bb91bc8f910458119e2bb7024f22278e0",
        "filename": "src/bitcoinrpc.cpp",
        "status": "modified",
        "additions": 16,
        "deletions": 8,
        "changes": 24,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/aa625ed6ed0ec7060859225cf9d43799eed5a799/src/bitcoinrpc.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/aa625ed6ed0ec7060859225cf9d43799eed5a799/src/bitcoinrpc.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bitcoinrpc.cpp?ref=aa625ed6ed0ec7060859225cf9d43799eed5a799",
        "patch": "@@ -353,7 +353,7 @@ Value getinfo(const Array& params, bool fHelp)\n     obj.push_back(Pair(\"keypoolsize\",   pwalletMain->GetKeyPoolSize()));\n     obj.push_back(Pair(\"paytxfee\",      ValueFromAmount(nTransactionFee)));\n     if (pwalletMain->IsCrypted())\n-        obj.push_back(Pair(\"unlocked_until\", (boost::int64_t)nWalletUnlockTime));\n+        obj.push_back(Pair(\"unlocked_until\", (boost::int64_t)nWalletUnlockTime / 1000));\n     obj.push_back(Pair(\"errors\",        GetWarnings(\"statusbar\")));\n     return obj;\n }\n@@ -1537,25 +1537,33 @@ void ThreadTopUpKeyPool(void* parg)\n \n void ThreadCleanWalletPassphrase(void* parg)\n {\n-    int64 nMyWakeTime = GetTime() + *((int*)parg);\n+    int64 nMyWakeTime = GetTimeMillis() + *((int*)parg) * 1000;\n \n     ENTER_CRITICAL_SECTION(cs_nWalletUnlockTime);\n \n     if (nWalletUnlockTime == 0)\n     {\n         nWalletUnlockTime = nMyWakeTime;\n \n-        while (GetTime() < nWalletUnlockTime)\n+        do\n         {\n-            int64 nToSleep = GetTime() - nWalletUnlockTime;\n+            if (nWalletUnlockTime==0)\n+                break;\n+            int64 nToSleep = nWalletUnlockTime - GetTimeMillis();\n+            if (nToSleep <= 0)\n+                break;\n \n             LEAVE_CRITICAL_SECTION(cs_nWalletUnlockTime);\n             Sleep(nToSleep);\n             ENTER_CRITICAL_SECTION(cs_nWalletUnlockTime);\n-        }\n \n-        nWalletUnlockTime = 0;\n-        pwalletMain->Lock();\n+        } while(1);\n+\n+        if (nWalletUnlockTime)\n+        {\n+            nWalletUnlockTime = 0;\n+            pwalletMain->Lock();\n+        }\n     }\n     else\n     {\n@@ -1653,9 +1661,9 @@ Value walletlock(const Array& params, bool fHelp)\n     if (!pwalletMain->IsCrypted())\n         throw JSONRPCError(-15, \"Error: running with an unencrypted wallet, but walletlock was called.\");\n \n-    pwalletMain->Lock();\n     CRITICAL_BLOCK(cs_nWalletUnlockTime)\n     {\n+        pwalletMain->Lock();\n         nWalletUnlockTime = 0;\n     }\n "
      }
    ]
  }
]