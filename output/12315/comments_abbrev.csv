fivepiece,2018-01-31T17:22:23Z,"`p2sh-p2wpkh` addresses along with the `p2wpkh` raw script are still visible in the scripts area in dumpwallet.\n`importwallet` behaves the same (will import **all** scriptpubkey types)\nI've set the address to be written in the dump to be `[unknown address type]` if neither legacy, p2sh-segwit or bech32 are set in the client, but I'm not sure if it could ever happen.\nIn any case, it doesn't a",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-362005742,362005742,
fivepiece,2018-01-31T17:52:30Z,"Actually, this is not good enough.  If an uncompressed privkey is being dumped, the address should be a p2pkh one regardless of the global setting.",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-362015034,362015034,
fivepiece,2018-01-31T18:07:41Z,"Moved the decision as to which address we should output to after `CKey key` is set so we can check if it's compressed or not.\nA mixed output looks like :\n\n```\n# extended private masterkey: tprv8ZgxMBicQKsPe1mq9Pnix5Ui8nJAFhT4CTcMSK881Nyg1H6AF4zyASDK55NtwbG7mW811RXsLZpJCzN1wLDF8CN2urZprbTUL5inwqKNMFG\n\n93VarZKnS5AGpxz86jLJ3amfXyVqY5eAjQ93noAshDYCbj55RW8 1970-01-01T00:00:01Z label= # addr",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-362019598,362019598,
devrandom,2018-02-01T01:15:28Z,"I tested this by:\n\n- creating a wallet using v0.14.2, and generating one address\n- re-opening the wallet using bitcoind from this PR and dumping\n\nThe resulting dump has bech32 output for the old generated address.  I assume this wasn't the intention?\n\nHere are the dumps.  With 0.14.2:\n\n    cNfTtkT9q15ozS2ESSVcTEXaZorQwrDkwioFZgniwrqVJzs6DFAJ 2018-02-01T00:08:58Z label= # addr=mv7",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-362125939,362125939,
fivepiece,2018-02-01T01:39:28Z,"Right, I haven't identified a way of telling whether keys were added before or after the wallet upgrade for bech32.\nIn this PR the output address type is only decided by what's set in the global setting.  The only way to get the base58 addresses back is by changing the setting to addresstype=legacy.  Maybe I missed some marker in the wallet that suggests the point of upgrade?",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-362130129,362130129,
sipa,2018-02-01T01:44:22Z,"You can check which of the corresponding addresses has a label set. Typically this will only be one of the P2PKH, P2SH-P2WPKH, or P2WPKH ones. If so, you could just output that exact one. Unfortunately this won't work for imported keys, as they get the label assigned to all 3.",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-362131002,362131002,
fivepiece,2018-02-01T02:42:50Z,Thanks!  I'll see what I can do.,https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-362140721,362140721,
devrandom,2018-02-01T03:05:08Z,"So perhaps the thing to do is to output any of the address types that have a label, and if none have a label output the global type.  So up to three addresses per line.\n",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-362144245,362144245,
fivepiece,2018-02-01T03:32:54Z,"@devrandom sorry the page didn't auto update with your comment.  So you're saying that multiple addresses per entry is better?\nWith this push, the first hit is used.  I guess I see your point now though.",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-362148114,362148114,
devrandom,2018-02-01T06:44:37Z,"Given Sipa's point, with imported keys you'd outputting the first address type in the `if` statement, not necessarily the type that the user is actually using or expecting.\n",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-362173894,362173894,
fivepiece,2018-02-01T16:26:21Z,"(sorry for mass pushing, I'll push to a side branch for now)",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-362320220,362320220,
fivepiece,2018-02-01T17:49:21Z,"I believe this push does things more along the lines that you guys suggested.  A couple things :\n\n1. If you set a label on an imported privkey, then try to set different labels to either its p2pkh or p2wpkh addresses, they will not show up in dumpwallet.  The label set to the privkey will show up instead.\n2. If you set a label on an imported privkey, then try to set a different label on its ",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-362347225,362347225,
fivepiece,2018-02-02T20:30:14Z,"~I think that I'm getting the wrong addresses for p2wpkh and probably p2sh-p2wpkh too.  Looking into it.~\nNope, false alarm.",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-362698322,362698322,
laanwj,2018-02-06T12:38:40Z,Concept ACK,https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-363409840,363409840,
fivepiece,2018-02-06T19:33:54Z,"Moved things to a function per @laanwj review, I'm not sure if any locks or further wallet availability checks are needed though.",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-363538843,363538843,
fivepiece,2018-02-06T22:27:22Z,"Actually, per @sipa's suggestion to use `GetAllDestinationsForKey()` for the labeled addresses, we can use `GetDestinationForKey()`, requesting a `g_address_type` for the unlabeled ones and remove the switch-case stuff altogether.",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-363586578,363586578,
fivepiece,2018-02-06T23:04:55Z,One commit now,https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-363596021,363596021,
sipa,2018-02-07T02:02:46Z,Lightly tested ACK 45eea40aa88f047111a9b1151fe4d1bad5c560e2,https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-363631009,363631009,
meshcollider,2018-02-07T21:50:16Z,"LGTM, thanks for doing this :) \nutACK https://github.com/bitcoin/bitcoin/pull/12315/commits/45eea40aa88f047111a9b1151fe4d1bad5c560e2",https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-363922542,363922542,
laanwj,2018-02-08T08:55:52Z,utACK 45eea40,https://github.com/bitcoin/bitcoin/pull/12315#issuecomment-364044235,364044235,
devrandom,2018-02-02T01:46:47Z,Can `fLabelFound` declaration be moved inside the if statement?,https://github.com/bitcoin/bitcoin/pull/12315#discussion_r165540242,165540242,src/wallet/rpcdump.cpp
devrandom,2018-02-02T01:48:59Z,Should this be set true only if it's found in address book?,https://github.com/bitcoin/bitcoin/pull/12315#discussion_r165540491,165540491,src/wallet/rpcdump.cpp
devrandom,2018-02-02T02:33:52Z,this line seems to be unreached when this test is actually run,https://github.com/bitcoin/bitcoin/pull/12315#discussion_r165545808,165545808,test/functional/wallet_dump.py
fivepiece,2018-02-02T14:07:07Z,"Yep, will do.",https://github.com/bitcoin/bitcoin/pull/12315#discussion_r165652850,165652850,src/wallet/rpcdump.cpp
fivepiece,2018-02-02T14:07:17Z,Ah good call.  The uncompressed key might belong to an internal entry like change.,https://github.com/bitcoin/bitcoin/pull/12315#discussion_r165652882,165652882,src/wallet/rpcdump.cpp
fivepiece,2018-02-02T14:09:13Z,Good catch :) the test was passing for because I broke it.  I'll set the test to check for the p2sh-p2wpkh address specifically for the key it was added to.,https://github.com/bitcoin/bitcoin/pull/12315#discussion_r165653340,165653340,test/functional/wallet_dump.py
laanwj,2018-02-06T12:31:32Z,"Would make sense to encapsulate this (go from key/keyid to label,addr) out to a function.",https://github.com/bitcoin/bitcoin/pull/12315#discussion_r166280928,166280928,src/wallet/rpcdump.cpp
fivepiece,2018-02-06T17:10:26Z,"Thanks for having a look.  I'm not sure what I should be passing to that function though, seems that I would have to pass a pointer to the wallet itself along with the keyid in order to know whether a label exists for an address type for that keyid.\nI might be missing something obvious though.",https://github.com/bitcoin/bitcoin/pull/12315#discussion_r166375118,166375118,src/wallet/rpcdump.cpp
sipa,2018-02-06T19:36:58Z,You should iterate the result of `GetAllDestinationsForKey(key)` here instead of replicating the logic to compute the destinations.,https://github.com/bitcoin/bitcoin/pull/12315#discussion_r166419267,166419267,src/wallet/rpcdump.cpp
fivepiece,2018-02-06T20:25:59Z,That... makes a lot more sense :),https://github.com/bitcoin/bitcoin/pull/12315#discussion_r166432235,166432235,src/wallet/rpcdump.cpp
sipa,2018-02-06T22:39:17Z,Style nit: braces when indenting.,https://github.com/bitcoin/bitcoin/pull/12315#discussion_r166465524,166465524,src/wallet/rpcdump.cpp
fivepiece,2018-02-06T23:03:39Z,Fixed,https://github.com/bitcoin/bitcoin/pull/12315#discussion_r166471091,166471091,src/wallet/rpcdump.cpp
