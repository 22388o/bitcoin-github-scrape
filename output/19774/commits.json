[
  {
    "sha": "4deb2ef0e0c0571a15a8be44bd43fa42f99c089d",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo0ZGViMmVmMGUwYzA1NzFhMTVhOGJlNDRiZDQzZmE0MmY5OWMwODlk",
    "commit": {
      "author": {
        "name": "Ivan Metlushko",
        "email": "metlushko@gmail.com",
        "date": "2020-08-21T10:43:49Z"
      },
      "committer": {
        "name": "Ivan Metlushko",
        "email": "metlushko@gmail.com",
        "date": "2020-08-21T10:49:54Z"
      },
      "message": "wallet: deactivate descriptor",
      "tree": {
        "sha": "7069ce05472e8e017f7c4faf003cbe791962c2d1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7069ce05472e8e017f7c4faf003cbe791962c2d1"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d/comments",
    "author": {
      "login": "S3RK",
      "id": 1466284,
      "node_id": "MDQ6VXNlcjE0NjYyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1466284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/S3RK",
      "html_url": "https://github.com/S3RK",
      "followers_url": "https://api.github.com/users/S3RK/followers",
      "following_url": "https://api.github.com/users/S3RK/following{/other_user}",
      "gists_url": "https://api.github.com/users/S3RK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/S3RK/subscriptions",
      "organizations_url": "https://api.github.com/users/S3RK/orgs",
      "repos_url": "https://api.github.com/users/S3RK/repos",
      "events_url": "https://api.github.com/users/S3RK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/S3RK/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "S3RK",
      "id": 1466284,
      "node_id": "MDQ6VXNlcjE0NjYyODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1466284?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/S3RK",
      "html_url": "https://github.com/S3RK",
      "followers_url": "https://api.github.com/users/S3RK/followers",
      "following_url": "https://api.github.com/users/S3RK/following{/other_user}",
      "gists_url": "https://api.github.com/users/S3RK/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/S3RK/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/S3RK/subscriptions",
      "organizations_url": "https://api.github.com/users/S3RK/orgs",
      "repos_url": "https://api.github.com/users/S3RK/repos",
      "events_url": "https://api.github.com/users/S3RK/events{/privacy}",
      "received_events_url": "https://api.github.com/users/S3RK/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "0d9e14a6466cd1644cb659b7b79d40d8761034c0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0d9e14a6466cd1644cb659b7b79d40d8761034c0",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/0d9e14a6466cd1644cb659b7b79d40d8761034c0"
      }
    ],
    "stats": {
      "total": 58,
      "additions": 58,
      "deletions": 0
    },
    "files": [
      {
        "sha": "ba8a7aa6fd552d326ebbed4ad55ab0235707a96b",
        "filename": "src/wallet/rpcdump.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 0,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d/src/wallet/rpcdump.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d/src/wallet/rpcdump.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/rpcdump.cpp?ref=4deb2ef0e0c0571a15a8be44bd43fa42f99c089d",
        "patch": "@@ -1549,6 +1549,10 @@ static UniValue ProcessDescriptorImport(CWallet * const pwallet, const UniValue&\n             } else {\n                 pwallet->AddActiveScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n             }\n+        } else {\n+            if (w_desc.descriptor->GetOutputType()) {\n+                pwallet->DeactivateScriptPubKeyMan(spk_manager->GetID(), *w_desc.descriptor->GetOutputType(), internal);\n+            }\n         }\n \n         result.pushKV(\"success\", UniValue(true));"
      },
      {
        "sha": "32913fae29d52c5ec9b707f215dc7c434a758577",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 15,
        "deletions": 0,
        "changes": 15,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=4deb2ef0e0c0571a15a8be44bd43fa42f99c089d",
        "patch": "@@ -4485,6 +4485,21 @@ void CWallet::LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool intern\n     NotifyCanGetAddressesChanged();\n }\n \n+void CWallet::DeactivateScriptPubKeyMan(uint256 id, OutputType type, bool internal)\n+{\n+    WalletLogPrintf(\"Deactivate spkMan: id = %s, type = %d, internal = %d\\n\", id.ToString(), static_cast<int>(type), static_cast<int>(internal));\n+    WalletBatch batch(*database);\n+    if (!batch.EraseActiveScriptPubKeyMan(static_cast<uint8_t>(type), internal)) {\n+        throw std::runtime_error(std::string(__func__) + \": erasing active ScriptPubKeyMan id failed\");\n+    }\n+    auto& spk_mans = internal ? m_internal_spk_managers : m_external_spk_managers;\n+    if (spk_mans[type] && spk_mans[type]->GetID() == id) {\n+        spk_mans[type] = nullptr;\n+    }\n+\n+    NotifyCanGetAddressesChanged();\n+}\n+\n bool CWallet::IsLegacy() const\n {\n     if (m_internal_spk_managers.count(OutputType::LEGACY) == 0) {"
      },
      {
        "sha": "1600fc888a17fb86dca8d7f5582e4a562fc44fff",
        "filename": "src/wallet/wallet.h",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d/src/wallet/wallet.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d/src/wallet/wallet.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.h?ref=4deb2ef0e0c0571a15a8be44bd43fa42f99c089d",
        "patch": "@@ -1284,6 +1284,12 @@ class CWallet final : public WalletStorage, public interfaces::Chain::Notificati\n     //! @param[in] internal Whether this ScriptPubKeyMan provides change addresses\n     void LoadActiveScriptPubKeyMan(uint256 id, OutputType type, bool internal);\n \n+    //! Remove specified ScriptPubKeyMan from set of active SPK managers. Writes the change to the wallet file.\n+    //! @param[in] id The unique id for the ScriptPubKeyMan\n+    //! @param[in] type The OutputType this ScriptPubKeyMan provides addresses for\n+    //! @param[in] internal Whether this ScriptPubKeyMan provides change addresses\n+    void DeactivateScriptPubKeyMan(uint256 id, OutputType type, bool internal);\n+\n     //! Create new DescriptorScriptPubKeyMans and add them to the wallet\n     void SetupDescriptorScriptPubKeyMans();\n "
      },
      {
        "sha": "65a8f0dbe3a7b9d0d407e9da2cac10a02c876121",
        "filename": "src/wallet/walletdb.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d/src/wallet/walletdb.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d/src/wallet/walletdb.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.cpp?ref=4deb2ef0e0c0571a15a8be44bd43fa42f99c089d",
        "patch": "@@ -201,6 +201,12 @@ bool WalletBatch::WriteActiveScriptPubKeyMan(uint8_t type, const uint256& id, bo\n     return WriteIC(make_pair(key, type), id);\n }\n \n+bool WalletBatch::EraseActiveScriptPubKeyMan(uint8_t type, bool internal)\n+{\n+    std::string key = internal ? DBKeys::ACTIVEINTERNALSPK : DBKeys::ACTIVEEXTERNALSPK;\n+    return EraseIC(make_pair(key, type));\n+}\n+\n bool WalletBatch::WriteDescriptorKey(const uint256& desc_id, const CPubKey& pubkey, const CPrivKey& privkey)\n {\n     // hash pubkey/privkey to accelerate wallet load"
      },
      {
        "sha": "e9e1e088932e9b8562e2f21d5efc7fcf315357dc",
        "filename": "src/wallet/walletdb.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d/src/wallet/walletdb.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d/src/wallet/walletdb.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/walletdb.h?ref=4deb2ef0e0c0571a15a8be44bd43fa42f99c089d",
        "patch": "@@ -254,6 +254,7 @@ class WalletBatch\n     bool EraseDestData(const std::string &address, const std::string &key);\n \n     bool WriteActiveScriptPubKeyMan(uint8_t type, const uint256& id, bool internal);\n+    bool EraseActiveScriptPubKeyMan(uint8_t type, bool internal);\n \n     DBErrors LoadWallet(CWallet* pwallet);\n     DBErrors FindWalletTx(std::vector<uint256>& vTxHash, std::list<CWalletTx>& vWtx);"
      },
      {
        "sha": "ed5691e8e8cfe99960da8078838bb9655729166d",
        "filename": "test/functional/wallet_importdescriptors.py",
        "status": "modified",
        "additions": 26,
        "deletions": 0,
        "changes": 26,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d/test/functional/wallet_importdescriptors.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4deb2ef0e0c0571a15a8be44bd43fa42f99c089d/test/functional/wallet_importdescriptors.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/wallet_importdescriptors.py?ref=4deb2ef0e0c0571a15a8be44bd43fa42f99c089d",
        "patch": "@@ -289,6 +289,32 @@ def run_test(self):\n                              success=True)\n         assert_raises_rpc_error(-4, 'This wallet has no available keys', w1.getrawchangeaddress, 'legacy')\n \n+        self.log.info('Check can activate inactive descriptor')\n+        self.test_importdesc({'desc': descsum_create('pkh([12345678]' + xpub + '/*)'),\n+                              'range': [0, 5],\n+                              'active': True,\n+                              'timestamp': 'now',\n+                              'internal': True\n+                              },\n+                             success=True)\n+        address = w1.getrawchangeaddress('legacy')\n+        assert_equal(address, \"mpA2Wh9dvZT7yfELq1UnrUmAoc5qCkMetg\")\n+\n+        self.log.info('Check can deactivate active descriptor')\n+        self.test_importdesc({'desc': descsum_create('pkh([12345678]' + xpub + '/*)'),\n+                              'range': [0, 5],\n+                              'active': False,\n+                              'timestamp': 'now',\n+                              'internal': True\n+                              },\n+                             success=True)\n+        assert_raises_rpc_error(-4, 'This wallet has no available keys', w1.getrawchangeaddress, 'legacy')\n+\n+        self.log.info('Verify activation state is persistent')\n+        w1.unloadwallet()\n+        self.nodes[1].loadwallet('w1')\n+        assert_raises_rpc_error(-4, 'This wallet has no available keys', w1.getrawchangeaddress, 'legacy')\n+\n         # # Test importing a descriptor containing a WIF private key\n         wif_priv = \"cTe1f5rdT8A8DFgVWTjyPwACsDPJM9ff4QngFxUixCSvvbg1x6sh\"\n         address = \"2MuhcG52uHPknxDgmGPsV18jSHFBnnRgjPg\""
      }
    ]
  }
]