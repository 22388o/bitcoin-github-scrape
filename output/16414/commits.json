[
  {
    "sha": "8f354ced6e34247477c1b1a56d34e613f6104f0e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4ZjM1NGNlZDZlMzQyNDc0NzdjMWIxYTU2ZDM0ZTYxM2Y2MTA0ZjBl",
    "commit": {
      "author": {
        "name": "Sjors Provoost",
        "email": "sjors@sprovoost.nl",
        "date": "2019-06-29T02:44:38Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-08-25T01:48:30Z"
      },
      "message": "0.18: [wallet] abort when attempting to fund a transaction above maxtxfee\n\nFundTransaction calls GetMinimumFee which, when the fee rate is absurdly high, quietly reduced the fee to -maxtxfee. Becaue an absurdly high fee rate is usually the result of a fat finger, aborting seems safer behavior.\n\nGithub-Pull: #16257\nRebased-From: 806b0052c3b45415862f74f20ba5f389e5b673de",
      "tree": {
        "sha": "ac7b1288d2d74e1d19e48c09fc3a9825c62d6939",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ac7b1288d2d74e1d19e48c09fc3a9825c62d6939"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/8f354ced6e34247477c1b1a56d34e613f6104f0e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8f354ced6e34247477c1b1a56d34e613f6104f0e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/8f354ced6e34247477c1b1a56d34e613f6104f0e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8f354ced6e34247477c1b1a56d34e613f6104f0e/comments",
    "author": {
      "login": "Sjors",
      "id": 10217,
      "node_id": "MDQ6VXNlcjEwMjE3",
      "avatar_url": "https://avatars.githubusercontent.com/u/10217?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Sjors",
      "html_url": "https://github.com/Sjors",
      "followers_url": "https://api.github.com/users/Sjors/followers",
      "following_url": "https://api.github.com/users/Sjors/following{/other_user}",
      "gists_url": "https://api.github.com/users/Sjors/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Sjors/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Sjors/subscriptions",
      "organizations_url": "https://api.github.com/users/Sjors/orgs",
      "repos_url": "https://api.github.com/users/Sjors/repos",
      "events_url": "https://api.github.com/users/Sjors/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Sjors/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "00ffe5aca134f424351b05a85da4eef9c3e4553a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/00ffe5aca134f424351b05a85da4eef9c3e4553a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/00ffe5aca134f424351b05a85da4eef9c3e4553a"
      }
    ],
    "stats": {
      "total": 31,
      "additions": 22,
      "deletions": 9
    },
    "files": [
      {
        "sha": "21867b7fb2f5245abe3c9748c0619358082cf7c8",
        "filename": "doc/release-notes-0.18.1-16257.md",
        "status": "added",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8f354ced6e34247477c1b1a56d34e613f6104f0e/doc/release-notes-0.18.1-16257.md",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8f354ced6e34247477c1b1a56d34e613f6104f0e/doc/release-notes-0.18.1-16257.md",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/doc/release-notes-0.18.1-16257.md?ref=8f354ced6e34247477c1b1a56d34e613f6104f0e",
        "patch": "@@ -0,0 +1,6 @@\n+Wallet changes\n+--------------\n+When creating a transaction with a fee above `-maxtxfee` (default 0.1 BTC),\n+the RPC commands `walletcreatefundedpsbt` and  `fundrawtransaction` will now fail\n+instead of rounding down the fee. Beware that the `feeRate` argument is specified\n+in BTC per kilobyte, not satoshi per byte."
      },
      {
        "sha": "d5f00f6542de87aff63f5ed864c70cf295e4b5ac",
        "filename": "src/policy/fees.cpp",
        "status": "modified",
        "additions": 0,
        "deletions": 1,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8f354ced6e34247477c1b1a56d34e613f6104f0e/src/policy/fees.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8f354ced6e34247477c1b1a56d34e613f6104f0e/src/policy/fees.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/policy/fees.cpp?ref=8f354ced6e34247477c1b1a56d34e613f6104f0e",
        "patch": "@@ -38,7 +38,6 @@ std::string StringForFeeReason(FeeReason reason) {\n         {FeeReason::PAYTXFEE, \"PayTxFee set\"},\n         {FeeReason::FALLBACK, \"Fallback fee\"},\n         {FeeReason::REQUIRED, \"Minimum Required Fee\"},\n-        {FeeReason::MAXTXFEE, \"MaxTxFee limit\"}\n     };\n     auto reason_string = fee_reason_strings.find(reason);\n "
      },
      {
        "sha": "1d5c15c5619d54158179062c25815920b3d77fea",
        "filename": "src/policy/fees.h",
        "status": "modified",
        "additions": 0,
        "deletions": 1,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8f354ced6e34247477c1b1a56d34e613f6104f0e/src/policy/fees.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8f354ced6e34247477c1b1a56d34e613f6104f0e/src/policy/fees.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/policy/fees.h?ref=8f354ced6e34247477c1b1a56d34e613f6104f0e",
        "patch": "@@ -43,7 +43,6 @@ enum class FeeReason {\n     PAYTXFEE,\n     FALLBACK,\n     REQUIRED,\n-    MAXTXFEE,\n };\n \n std::string StringForFeeReason(FeeReason reason);"
      },
      {
        "sha": "74dd35ff63081177866e862e52f76f6f8ca0c1cf",
        "filename": "src/wallet/fees.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 7,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8f354ced6e34247477c1b1a56d34e613f6104f0e/src/wallet/fees.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8f354ced6e34247477c1b1a56d34e613f6104f0e/src/wallet/fees.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/fees.cpp?ref=8f354ced6e34247477c1b1a56d34e613f6104f0e",
        "patch": "@@ -21,13 +21,7 @@ CAmount GetRequiredFee(const CWallet& wallet, unsigned int nTxBytes)\n \n CAmount GetMinimumFee(const CWallet& wallet, unsigned int nTxBytes, const CCoinControl& coin_control, const CTxMemPool& pool, const CBlockPolicyEstimator& estimator, FeeCalculation* feeCalc)\n {\n-    CAmount fee_needed = GetMinimumFeeRate(wallet, coin_control, pool, estimator, feeCalc).GetFee(nTxBytes);\n-    // Always obey the maximum\n-    if (fee_needed > maxTxFee) {\n-        fee_needed = maxTxFee;\n-        if (feeCalc) feeCalc->reason = FeeReason::MAXTXFEE;\n-    }\n-    return fee_needed;\n+    return GetMinimumFeeRate(wallet, coin_control, pool, estimator, feeCalc).GetFee(nTxBytes);\n }\n \n CFeeRate GetRequiredFeeRate(const CWallet& wallet)"
      },
      {
        "sha": "7a1a3cd41d9b214b773b35d79bfded0fa61eb706",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8f354ced6e34247477c1b1a56d34e613f6104f0e/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8f354ced6e34247477c1b1a56d34e613f6104f0e/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=8f354ced6e34247477c1b1a56d34e613f6104f0e",
        "patch": "@@ -2690,6 +2690,11 @@ bool CWallet::FundTransaction(CMutableTransaction& tx, CAmount& nFeeRet, int& nC\n         }\n     }\n \n+    if (nFeeRet > maxTxFee) {\n+        strFailReason = _(\"Fee exceeds maximum configured by -maxtxfee\");\n+        return false;\n+    }\n+\n     return true;\n }\n "
      },
      {
        "sha": "8aae249362f84f94585fa788dc2f3ec9138faa4e",
        "filename": "test/functional/rpc_fundrawtransaction.py",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8f354ced6e34247477c1b1a56d34e613f6104f0e/test/functional/rpc_fundrawtransaction.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8f354ced6e34247477c1b1a56d34e613f6104f0e/test/functional/rpc_fundrawtransaction.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_fundrawtransaction.py?ref=8f354ced6e34247477c1b1a56d34e613f6104f0e",
        "patch": "@@ -662,6 +662,7 @@ def run_test(self):\n         result = self.nodes[3].fundrawtransaction(rawtx) # uses min_relay_tx_fee (set by settxfee)\n         result2 = self.nodes[3].fundrawtransaction(rawtx, {\"feeRate\": 2*min_relay_tx_fee})\n         result3 = self.nodes[3].fundrawtransaction(rawtx, {\"feeRate\": 10*min_relay_tx_fee})\n+        assert_raises_rpc_error(-4, \"Fee exceeds maximum configured by -maxtxfee\", self.nodes[3].fundrawtransaction, rawtx, {\"feeRate\": 1})\n         result_fee_rate = result['fee'] * 1000 / count_bytes(result['hex'])\n         assert_fee_amount(result2['fee'], count_bytes(result2['hex']), 2 * result_fee_rate)\n         assert_fee_amount(result3['fee'], count_bytes(result3['hex']), 10 * result_fee_rate)"
      },
      {
        "sha": "259d643e1a6b24a4a335ca5d8ed9500794bdfdb4",
        "filename": "test/functional/rpc_psbt.py",
        "status": "modified",
        "additions": 9,
        "deletions": 0,
        "changes": 9,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/8f354ced6e34247477c1b1a56d34e613f6104f0e/test/functional/rpc_psbt.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/8f354ced6e34247477c1b1a56d34e613f6104f0e/test/functional/rpc_psbt.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_psbt.py?ref=8f354ced6e34247477c1b1a56d34e613f6104f0e",
        "patch": "@@ -128,6 +128,15 @@ def run_test(self):\n         assert_equal(walletprocesspsbt_out['complete'], True)\n         self.nodes[1].sendrawtransaction(self.nodes[1].finalizepsbt(walletprocesspsbt_out['psbt'])['hex'])\n \n+        # feeRate of 0.1 BTC / KB produces a total fee slightly below -maxtxfee (~0.05280000):\n+        res = self.nodes[1].walletcreatefundedpsbt([{\"txid\":txid,\"vout\":p2wpkh_pos},{\"txid\":txid,\"vout\":p2sh_p2wpkh_pos},{\"txid\":txid,\"vout\":p2pkh_pos}], {self.nodes[1].getnewaddress():29.99}, 0, {\"feeRate\": 0.1})\n+        assert_greater_than(res[\"fee\"], 0.05)\n+        assert_greater_than(0.06, res[\"fee\"])\n+\n+        # feeRate of 10 BTC / KB produces a total fee well above -maxtxfee\n+        # previously this was silenty capped at -maxtxfee\n+        assert_raises_rpc_error(-4, \"Fee exceeds maximum configured by -maxtxfee\", self.nodes[1].walletcreatefundedpsbt, [{\"txid\":txid,\"vout\":p2wpkh_pos},{\"txid\":txid,\"vout\":p2sh_p2wpkh_pos},{\"txid\":txid,\"vout\":p2pkh_pos}], {self.nodes[1].getnewaddress():29.99}, 0, {\"feeRate\": 10})\n+\n         # partially sign multisig things with node 1\n         psbtx = self.nodes[1].walletcreatefundedpsbt([{\"txid\":txid,\"vout\":p2wsh_pos},{\"txid\":txid,\"vout\":p2sh_pos},{\"txid\":txid,\"vout\":p2sh_p2wsh_pos}], {self.nodes[1].getnewaddress():29.99})['psbt']\n         walletprocesspsbt_out = self.nodes[1].walletprocesspsbt(psbtx)"
      }
    ]
  },
  {
    "sha": "a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzphMTFkYmFhNTQ3ZWMwMWU3ZTExY2E0ZGJlMjQzM2U3ZDk4N2M4MmJi",
    "commit": {
      "author": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-07-02T14:16:36Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-08-25T01:51:07Z"
      },
      "message": "0.18: wallet: Fix -maxtxfee check by moving it to CWallet::CreateTransaction\n\nGithub-Pull: #16322\nRebased-From: 5c1b9714cb0a13be28324f91f4ec9ca66a1de8c7",
      "tree": {
        "sha": "c00d28c6ebf7bd8a9636e5ae154af96fd501dcb4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/c00d28c6ebf7bd8a9636e5ae154af96fd501dcb4"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb/comments",
    "author": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "8f354ced6e34247477c1b1a56d34e613f6104f0e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8f354ced6e34247477c1b1a56d34e613f6104f0e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/8f354ced6e34247477c1b1a56d34e613f6104f0e"
      }
    ],
    "stats": {
      "total": 22,
      "additions": 16,
      "deletions": 6
    },
    "files": [
      {
        "sha": "1c387594a1815eb8a18bff5b9e600cea040712b0",
        "filename": "src/wallet/wallet.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 5,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb/src/wallet/wallet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb/src/wallet/wallet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/wallet/wallet.cpp?ref=a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb",
        "patch": "@@ -2690,11 +2690,6 @@ bool CWallet::FundTransaction(CMutableTransaction& tx, CAmount& nFeeRet, int& nC\n         }\n     }\n \n-    if (nFeeRet > maxTxFee) {\n-        strFailReason = _(\"Fee exceeds maximum configured by -maxtxfee\");\n-        return false;\n-    }\n-\n     return true;\n }\n \n@@ -3131,6 +3126,11 @@ bool CWallet::CreateTransaction(interfaces::Chain::Lock& locked_chain, const std\n         }\n     }\n \n+    if (nFeeRet > maxTxFee) {\n+        strFailReason = _(\"Fee exceeds maximum configured by -maxtxfee\");\n+        return false;\n+    }\n+\n     if (gArgs.GetBoolArg(\"-walletrejectlongchains\", DEFAULT_WALLET_REJECT_LONG_CHAINS)) {\n         // Lastly, ensure this tx will pass the mempool's chain limits\n         LockPoints lp;"
      },
      {
        "sha": "f4152503e30a1cc2566096dd691259c6439e0cbb",
        "filename": "test/functional/rpc_psbt.py",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb/test/functional/rpc_psbt.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb/test/functional/rpc_psbt.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_psbt.py?ref=a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb",
        "patch": "@@ -134,7 +134,7 @@ def run_test(self):\n         assert_greater_than(0.06, res[\"fee\"])\n \n         # feeRate of 10 BTC / KB produces a total fee well above -maxtxfee\n-        # previously this was silenty capped at -maxtxfee\n+        # previously this was silently capped at -maxtxfee\n         assert_raises_rpc_error(-4, \"Fee exceeds maximum configured by -maxtxfee\", self.nodes[1].walletcreatefundedpsbt, [{\"txid\":txid,\"vout\":p2wpkh_pos},{\"txid\":txid,\"vout\":p2sh_p2wpkh_pos},{\"txid\":txid,\"vout\":p2pkh_pos}], {self.nodes[1].getnewaddress():29.99}, 0, {\"feeRate\": 10})\n \n         # partially sign multisig things with node 1"
      },
      {
        "sha": "cd93b2599694ab3461b62940f94f3465d5fba54f",
        "filename": "test/functional/wallet_bumpfee.py",
        "status": "modified",
        "additions": 10,
        "deletions": 0,
        "changes": 10,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb/test/functional/wallet_bumpfee.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb/test/functional/wallet_bumpfee.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/wallet_bumpfee.py?ref=a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb",
        "patch": "@@ -73,6 +73,7 @@ def run_test(self):\n         test_unconfirmed_not_spendable(rbf_node, rbf_node_address)\n         test_bumpfee_metadata(rbf_node, dest_address)\n         test_locked_wallet_fails(rbf_node, dest_address)\n+        test_maxtxfee_fails(self, rbf_node, dest_address)\n         self.log.info(\"Success\")\n \n \n@@ -204,6 +205,15 @@ def test_settxfee(rbf_node, dest_address):\n     rbf_node.settxfee(Decimal(\"0.00000000\"))  # unset paytxfee\n \n \n+def test_maxtxfee_fails(test, rbf_node, dest_address):\n+    test.restart_node(1, ['-maxtxfee=0.00003'] + test.extra_args[1])\n+    rbf_node.walletpassphrase(WALLET_PASSPHRASE, WALLET_PASSPHRASE_TIMEOUT)\n+    rbfid = spend_one_input(rbf_node, dest_address)\n+    assert_raises_rpc_error(-4, \"Specified or calculated fee 0.0000332 is too high (cannot be higher than maxTxFee 0.00003)\", rbf_node.bumpfee, rbfid)\n+    test.restart_node(1, test.extra_args[1])\n+    rbf_node.walletpassphrase(WALLET_PASSPHRASE, WALLET_PASSPHRASE_TIMEOUT)\n+\n+\n def test_rebumping(rbf_node, dest_address):\n     # check that re-bumping the original tx fails, but bumping the bumper succeeds\n     rbfid = spend_one_input(rbf_node, dest_address)"
      }
    ]
  },
  {
    "sha": "d3b3bb8c9fb3a2ff1cd3a8776552c649aaf19dc2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkM2IzYmI4YzlmYjNhMmZmMWNkM2E4Nzc2NTUyYzY0OWFhZjE5ZGMy",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2019-07-02T15:50:44Z"
      },
      "committer": {
        "name": "Jo\u00e3o Barbosa",
        "email": "joao.paulo.barbosa@gmail.com",
        "date": "2019-08-25T01:51:50Z"
      },
      "message": "0.18: test: Add test for maxtxfee option\n\nGithub-Pull: #16322\nRebased-From: 0d101a340c44841cbbc5982d55354b1787bc39e2",
      "tree": {
        "sha": "6da4ad0852697efc1cad16e2d64b5485cfa7e87d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6da4ad0852697efc1cad16e2d64b5485cfa7e87d"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d3b3bb8c9fb3a2ff1cd3a8776552c649aaf19dc2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d3b3bb8c9fb3a2ff1cd3a8776552c649aaf19dc2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/d3b3bb8c9fb3a2ff1cd3a8776552c649aaf19dc2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d3b3bb8c9fb3a2ff1cd3a8776552c649aaf19dc2/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "promag",
      "id": 3534524,
      "node_id": "MDQ6VXNlcjM1MzQ1MjQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3534524?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/promag",
      "html_url": "https://github.com/promag",
      "followers_url": "https://api.github.com/users/promag/followers",
      "following_url": "https://api.github.com/users/promag/following{/other_user}",
      "gists_url": "https://api.github.com/users/promag/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/promag/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/promag/subscriptions",
      "organizations_url": "https://api.github.com/users/promag/orgs",
      "repos_url": "https://api.github.com/users/promag/repos",
      "events_url": "https://api.github.com/users/promag/events{/privacy}",
      "received_events_url": "https://api.github.com/users/promag/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/a11dbaa547ec01e7e11ca4dbe2433e7d987c82bb"
      }
    ],
    "stats": {
      "total": 39,
      "additions": 39,
      "deletions": 0
    },
    "files": [
      {
        "sha": "7222fb9f91df423124b07bae9fe252092875a9e0",
        "filename": "test/functional/wallet_create_tx.py",
        "status": "modified",
        "additions": 39,
        "deletions": 0,
        "changes": 39,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d3b3bb8c9fb3a2ff1cd3a8776552c649aaf19dc2/test/functional/wallet_create_tx.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d3b3bb8c9fb3a2ff1cd3a8776552c649aaf19dc2/test/functional/wallet_create_tx.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/wallet_create_tx.py?ref=d3b3bb8c9fb3a2ff1cd3a8776552c649aaf19dc2",
        "patch": "@@ -6,6 +6,7 @@\n from test_framework.test_framework import BitcoinTestFramework\n from test_framework.util import (\n     assert_equal,\n+    assert_raises_rpc_error,\n )\n from test_framework.blocktools import (\n     TIME_GENESIS_BLOCK,\n@@ -26,6 +27,10 @@ def run_test(self):\n         self.nodes[0].generate(200)\n         self.nodes[0].setmocktime(0)\n \n+        self.test_anti_fee_sniping()\n+        self.test_tx_size_too_large()\n+\n+    def test_anti_fee_sniping(self):\n         self.log.info('Check that we have some (old) blocks and that anti-fee-sniping is disabled')\n         assert_equal(self.nodes[0].getblockchaininfo()['blocks'], 200)\n         txid = self.nodes[0].sendtoaddress(self.nodes[0].getnewaddress(), 1)\n@@ -38,6 +43,40 @@ def run_test(self):\n         tx = self.nodes[0].decoderawtransaction(self.nodes[0].gettransaction(txid)['hex'])\n         assert 0 < tx['locktime'] <= 201\n \n+    def test_tx_size_too_large(self):\n+        # More than 10kB of outputs, so that we hit -maxtxfee with a high feerate\n+        outputs = {self.nodes[0].getnewaddress(address_type='bech32'): 0.000025 for i in range(400)}\n+        raw_tx = self.nodes[0].createrawtransaction(inputs=[], outputs=outputs)\n+\n+        for fee_setting in ['-minrelaytxfee=0.01', '-mintxfee=0.01', '-paytxfee=0.01']:\n+            self.log.info('Check maxtxfee in combination with {}'.format(fee_setting))\n+            self.restart_node(0, extra_args=[fee_setting])\n+            assert_raises_rpc_error(\n+                -6,\n+                \"Fee exceeds maximum configured by -maxtxfee\",\n+                lambda: self.nodes[0].sendmany(dummy=\"\", amounts=outputs),\n+            )\n+            assert_raises_rpc_error(\n+                -4,\n+                \"Fee exceeds maximum configured by -maxtxfee\",\n+                lambda: self.nodes[0].fundrawtransaction(hexstring=raw_tx),\n+            )\n+\n+        self.log.info('Check maxtxfee in combination with settxfee')\n+        self.restart_node(0)\n+        self.nodes[0].settxfee(0.01)\n+        assert_raises_rpc_error(\n+            -6,\n+            \"Fee exceeds maximum configured by -maxtxfee\",\n+            lambda: self.nodes[0].sendmany(dummy=\"\", amounts=outputs),\n+        )\n+        assert_raises_rpc_error(\n+            -4,\n+            \"Fee exceeds maximum configured by -maxtxfee\",\n+            lambda: self.nodes[0].fundrawtransaction(hexstring=raw_tx),\n+        )\n+        self.nodes[0].settxfee(0)\n+\n \n if __name__ == '__main__':\n     CreateTxWalletTest().main()"
      }
    ]
  }
]