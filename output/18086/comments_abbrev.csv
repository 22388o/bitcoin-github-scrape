sipa,2020-02-07 02:23:43,@sdaftuar You may be interested in this for #18044 - it should be easy to use this to determine how much an extra index adds.,https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-583204148,583204148,
DrahtBot,2020-02-07 03:07:56,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #19478 (Remove CTxMempool::mapLinks data structure member by JeremyRubin)\n* #19306 (refactor: Replace RecursiveMutex with",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-583213275,583213275,
JeremyRubin,2020-02-07 03:26:27,"@sipa can you take a look at https://github.com/JeremyRubin/bitcoin/pull/7?\n\nIt looks like when we get rid of mapTxLinks we'd then want to use an accounting allocator on the new child sets and get some DynamicMemoryUsage added to the cached inner usage?\n\nAt some point I also want to better break down the cachedInnerUsage tracking into buckets as it makes it easier to trace bugs.",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-583217146,583217146,
sipa,2020-02-07 03:45:14,"I'm happy to rebase this on top of a removal of mapLinks, if that'd go in first. It looks pretty like I'd just need to remove mapLinks from this as well.\n\nI don't know if breaking down cachedInnerUsage is all that meaningful, as the Check() function can verify its correctness in aggregate.\n\nThere are plenty more options of shuffling things with AccountingAllocators... I don't have any part",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-583220934,583220934,
JeremyRubin,2020-02-07 03:53:01,Don't you need to make TxLinks sets use accounting allocators in this patch too?,https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-583222441,583222441,
sipa,2020-02-07 04:04:40,"@JeremyRubin Ah, that seems reasonable. My priority was the things that use a boost multiindex as guessing memory usage there is very hard, but no reason why it can't be extended to also the sets there.",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-583224572,583224572,
JeremyRubin,2020-02-07 04:45:05,Do you know if we were over or underestimating before?,https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-583231821,583231821,
sipa,2020-02-07 04:47:46,"In mapTx we were overestimating slightly for realistic mempool size, but underestimating for near-empty ones.",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-583232326,583232326,
JeremyRubin,2020-02-07 05:16:09,"Ok the near empty case doesn't really matter... w.r.t. the realistic size one, here's a question just to be detailed/pedantic with what this change does:\n\nGiven that we were previously overestimating, if I set my mempool to 100MB then I actually was getting (let's say) 99 MB, if the ""slightly"" was by 1%. If *after* this change, I am now actually using a little bit more memory is this enough to",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-583238193,583238193,
sipa,2020-02-07 05:33:13,"Our memory accounting has never been more accurate than in the orders of 10s of MBs. A tiny change like this shouldn't matter.\n\nAnd probably on the long term, it helps: it's likely the case that in some scenarios we were off more than others (e.g. many tiny transactions vs a few big ones) - better estimations means that experimentally-determined max memory limits need less margin.",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-583241485,583241485,
JeremyRubin,2020-02-07 05:57:34,"The mempool tests happen to be very fragile -- I've noticed that sometimes when I made the mempool more memory efficient (e.g., in removing mapLinks) there are a bunch of failures because the tests depend on evictions happening because it's out of space.\n\nI'm not positive that's why your tests are failing, but it could be related.",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-583246497,583246497,
sipa,2020-02-07 06:02:29,"Yes, they're failing because the mempool limits now work slightly differently. The test makes rather silly assumptions on the menory usage of transaction entries.",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-583247641,583247641,
laanwj,2020-03-27 15:33:42,"Concept ACK, I think this is an elegant way to track accurate usage.",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-605065055,605065055,
hebasto,2020-05-03 05:40:22,Concept ACK.,https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-623057883,623057883,
hebasto,2020-05-14 17:46:11,"> In mapTx we were overestimating slightly for realistic mempool size, but underestimating for near-empty ones.\n\nAs unit tests are based on ""near-empty"" containers the difference of estimations seems broke them.\n\nTesting ed1c5b1b98a19b6751d739f86cdc305bb3cff283 with `mempool_tests/MempoolSizeLimitTest`: the difference in `CTxMemPool::DynamicMemoryUsage()` is ~700 bytes.",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-628788590,628788590,
hebasto,2020-05-15 14:59:02,"Mind looking into https://github.com/hebasto/bitcoin/commits/test18086 ?\nIn that branch the first two commits eliminate the influence of memory allocated amount for the empty memory pool in unit tests.\nThen all the unit and functional tests passed.",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-629281995,629281995,
sipa,2020-07-08 23:08:07,"@hebasto That looks great. I've included your test/annotation improvements.\n\nI also added some comments, and made a change so that when a copy of a container is made, that copy is unaccounted. I think this makes sense conceptually (copies tend to be short-lived and not account for permanent storage), as well as reduce locking issues (otherwise you'd always need a lock on the original accountin",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-655803148,655803148,
hebasto,2020-07-10 05:32:38,"From the [IRC discussion](http://www.erisian.com.au/bitcoin-core-dev/log-2020-07-09.html):\n> \<cfields\> sipa: I suppose the old gcc issue is that the propagate_on_container_* aren't respected ?\n> \<sipa\> cfields: possibly\n> \<sipa\> but it looks like that\n> \<cfields\> sipa: from libstdc++ 4.8 release docs ""23.2.1	General container requirements	Partial	Only vector and forward_list meet t",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-656491893,656491893,
hebasto,2020-07-10 05:41:46,[Bug 96074 - Associative containers never propagate allocator on copy assignment](https://gcc.gnu.org/bugzilla/show_bug.cgi?id=96074),https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-656494251,656494251,
DrahtBot,2020-07-22 20:16:29,<!--cf906140f33d8803c4a75a2196329ecb-->\nüêô This pull request conflicts with the target branch and [needs rebase](https://github.com/bitcoin/bitcoin/blob/master/CONTRIBUTING.md#rebasing-changes).,https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-662673758,662673758,
adamjonas,2020-08-14 13:31:26,"It looks like this will need a rebase anyway, but I'm having issues compiling eace374a0, which looks consistent with the CI.\n\n<details><summary>Error</summary>\n\n```\n./memusage.h:92:64: error: cannot initialize a parameter of type 'std::__1::allocator<std::__1::__hash_node<int, void *> >::pointer' (aka 'std::__1::__hash_node<int, void *> *') with an lvalue of type 'int *'\n    template<t",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-674076114,674076114,
hebasto,2020-10-13 18:20:33,"@sipa @adamjonas \nMind looking into https://github.com/hebasto/bitcoin/commits/201013-build18086 ?\n\nThat branch is rebased and:\n- dropped ""Make AccountingAllocator not inherent from std::allocator"" commit\n- integrated [my suggestion](https://github.com/bitcoin/bitcoin/pull/18086#discussion_r452654297)\n- improved tests: s/`BOOST_CHECK`/`BOOST_CHECK_EQUAL`/ (was very useful for me during",https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-707924249,707924249,
sipa,2020-10-13 19:30:08,I'll get back to this after the 0.21 branching.,https://github.com/bitcoin/bitcoin/pull/18086#issuecomment-707960448,707960448,
hebasto,2020-05-14 16:34:15,Shouldn't be documented here that the accounting variable must be atomic or protected by mutex?,https://github.com/bitcoin/bitcoin/pull/18086#discussion_r425275498,425275498,src/memusage.h
sipa,2020-07-08 23:04:30,I've added a bunch of comments.,https://github.com/bitcoin/bitcoin/pull/18086#discussion_r451872142,451872142,src/memusage.h
hebasto,2020-07-09 08:41:32,"65fc229fabbc7889baca9c50ee35507543a6682e\n```suggestion\n     * In a multithreaded environment, the accounting variable needs to be protected by the same\n```",https://github.com/bitcoin/bitcoin/pull/18086#discussion_r452058748,452058748,src/memusage.h
hebasto,2020-07-09 08:45:08,"65fc229fabbc7889baca9c50ee35507543a6682e\nnit:\n```suggestion\n * Any containers using such an allocator, and containers move constructed or\n * move assigned from such containers will then increment/decrement size_t when\n```",https://github.com/bitcoin/bitcoin/pull/18086#discussion_r452060890,452060890,src/memusage.h
hebasto,2020-07-09 12:44:14,"65fc229fabbc7889baca9c50ee35507543a6682e\n```suggestion\n            BOOST_CHECK(total == old);\n```",https://github.com/bitcoin/bitcoin/pull/18086#discussion_r452189214,452189214,src/test/allocator_tests.cpp
hebasto,2020-07-09 12:46:51,"65fc229fabbc7889baca9c50ee35507543a6682e\n~nit - dedicated constructors could be used:~",https://github.com/bitcoin/bitcoin/pull/18086#discussion_r452190692,452190692,src/test/allocator_tests.cpp
hebasto,2020-07-10 06:50:24,"fc0ba65125ccc0fe8bf7e897c6f928ae5ae565e7\nFrom the [docs](https://en.cppreference.com/w/cpp/named_req/Allocator) it follows that:\n```suggestion\n    AccountingAllocator select_on_container_copy_construction() const { return AccountingAllocator(); }\n```",https://github.com/bitcoin/bitcoin/pull/18086#discussion_r452654297,452654297,src/memusage.h
