[
  {
    "sha": "c060ff6f8ca6f0a7be9da18eb55fa51245556340",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjMDYwZmY2ZjhjYTZmMGE3YmU5ZGExOGViNTVmYTUxMjQ1NTU2MzQw",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2016-08-28T07:17:41Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2016-08-28T07:27:33Z"
      },
      "message": "Display version message before disconnection criteria",
      "tree": {
        "sha": "2a9c23ebd5b5f5b9b213e8d99a28c37e0d189e36",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2a9c23ebd5b5f5b9b213e8d99a28c37e0d189e36"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c060ff6f8ca6f0a7be9da18eb55fa51245556340",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c060ff6f8ca6f0a7be9da18eb55fa51245556340",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c060ff6f8ca6f0a7be9da18eb55fa51245556340",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c060ff6f8ca6f0a7be9da18eb55fa51245556340/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c072b8fd95cd4fa84f08189a0cd8b173ea2dbb8e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c072b8fd95cd4fa84f08189a0cd8b173ea2dbb8e",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c072b8fd95cd4fa84f08189a0cd8b173ea2dbb8e"
      }
    ],
    "stats": {
      "total": 56,
      "additions": 28,
      "deletions": 28
    },
    "files": [
      {
        "sha": "514e832c9b774c1cc1321a5673f193b71da9ed17",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 28,
        "deletions": 28,
        "changes": 56,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c060ff6f8ca6f0a7be9da18eb55fa51245556340/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c060ff6f8ca6f0a7be9da18eb55fa51245556340/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=c060ff6f8ca6f0a7be9da18eb55fa51245556340",
        "patch": "@@ -4931,25 +4931,6 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         {\n             addrman.SetServices(pfrom->addr, pfrom->nServices);\n         }\n-        if (pfrom->nServicesExpected & ~pfrom->nServices)\n-        {\n-            LogPrint(\"net\", \"peer=%d does not offer the expected services (%08x offered, %08x expected); disconnecting\\n\", pfrom->id, pfrom->nServices, pfrom->nServicesExpected);\n-            pfrom->PushMessage(NetMsgType::REJECT, strCommand, REJECT_NONSTANDARD,\n-                               strprintf(\"Expected to offer services %08x\", pfrom->nServicesExpected));\n-            pfrom->fDisconnect = true;\n-            return false;\n-        }\n-\n-        if (pfrom->nVersion < MIN_PEER_PROTO_VERSION)\n-        {\n-            // disconnect from peers older than this proto version\n-            LogPrintf(\"peer=%d using obsolete version %i; disconnecting\\n\", pfrom->id, pfrom->nVersion);\n-            pfrom->PushMessage(NetMsgType::REJECT, strCommand, REJECT_OBSOLETE,\n-                               strprintf(\"Version must be %d or greater\", MIN_PEER_PROTO_VERSION));\n-            pfrom->fDisconnect = true;\n-            return false;\n-        }\n-\n         if (pfrom->nVersion == 10300)\n             pfrom->nVersion = 300;\n         if (!vRecv.empty())\n@@ -4977,6 +4958,34 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n             return true;\n         }\n \n+        string remoteAddr;\n+        if (fLogIPs)\n+            remoteAddr = \", peeraddr=\" + pfrom->addr.ToString();\n+\n+        LogPrintf(\"receive version message: %s: version %d, blocks=%d, us=%s, peer=%d%s\\n\",\n+                  pfrom->cleanSubVer, pfrom->nVersion,\n+                  pfrom->nStartingHeight, addrMe.ToString(), pfrom->id,\n+                  remoteAddr);\n+\n+        if (pfrom->nServicesExpected & ~pfrom->nServices)\n+        {\n+            LogPrint(\"net\", \"peer=%d does not offer the expected services (%08x offered, %08x expected); disconnecting\\n\", pfrom->id, pfrom->nServices, pfrom->nServicesExpected);\n+            pfrom->PushMessage(NetMsgType::REJECT, strCommand, REJECT_NONSTANDARD,\n+                               strprintf(\"Expected to offer services %08x\", pfrom->nServicesExpected));\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+\n+        if (pfrom->nVersion < MIN_PEER_PROTO_VERSION)\n+        {\n+            // disconnect from peers older than this proto version\n+            LogPrintf(\"peer=%d using obsolete version %i; disconnecting\\n\", pfrom->id, pfrom->nVersion);\n+            pfrom->PushMessage(NetMsgType::REJECT, strCommand, REJECT_OBSOLETE,\n+                               strprintf(\"Version must be %d or greater\", MIN_PEER_PROTO_VERSION));\n+            pfrom->fDisconnect = true;\n+            return false;\n+        }\n+\n         pfrom->addrLocal = addrMe;\n         if (pfrom->fInbound && addrMe.IsRoutable())\n         {\n@@ -5039,15 +5048,6 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n \n         pfrom->fSuccessfullyConnected = true;\n \n-        string remoteAddr;\n-        if (fLogIPs)\n-            remoteAddr = \", peeraddr=\" + pfrom->addr.ToString();\n-\n-        LogPrintf(\"receive version message: %s: version %d, blocks=%d, us=%s, peer=%d%s\\n\",\n-                  pfrom->cleanSubVer, pfrom->nVersion,\n-                  pfrom->nStartingHeight, addrMe.ToString(), pfrom->id,\n-                  remoteAddr);\n-\n         int64_t nTimeOffset = nTime - GetTime();\n         pfrom->nTimeOffset = nTimeOffset;\n         AddTimeData(pfrom->addr, nTimeOffset);"
      }
    ]
  },
  {
    "sha": "edbe03104afb1b5829340b11f9fb8689b1ca2a50",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplZGJlMDMxMDRhZmIxYjU4MjkzNDBiMTFmOWZiODY4OWIxY2EyYTUw",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2016-08-28T07:33:57Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2016-08-28T07:36:42Z"
      },
      "message": "Disconnect when irreevant services provided NOT unexpected services.",
      "tree": {
        "sha": "778e6883abcded214904e612c41e11e995f8ee85",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/778e6883abcded214904e612c41e11e995f8ee85"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/edbe03104afb1b5829340b11f9fb8689b1ca2a50",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/edbe03104afb1b5829340b11f9fb8689b1ca2a50",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/edbe03104afb1b5829340b11f9fb8689b1ca2a50",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/edbe03104afb1b5829340b11f9fb8689b1ca2a50/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c060ff6f8ca6f0a7be9da18eb55fa51245556340",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c060ff6f8ca6f0a7be9da18eb55fa51245556340",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c060ff6f8ca6f0a7be9da18eb55fa51245556340"
      }
    ],
    "stats": {
      "total": 19,
      "additions": 10,
      "deletions": 9
    },
    "files": [
      {
        "sha": "4453fff58640b6fb73ad5327538e400f3c892988",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 9,
        "changes": 19,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/edbe03104afb1b5829340b11f9fb8689b1ca2a50/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/edbe03104afb1b5829340b11f9fb8689b1ca2a50/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=edbe03104afb1b5829340b11f9fb8689b1ca2a50",
        "patch": "@@ -4927,10 +4927,6 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n         uint64_t nServiceInt;\n         vRecv >> pfrom->nVersion >> nServiceInt >> nTime >> addrMe;\n         pfrom->nServices = ServiceFlags(nServiceInt);\n-        if (!pfrom->fInbound)\n-        {\n-            addrman.SetServices(pfrom->addr, pfrom->nServices);\n-        }\n         if (pfrom->nVersion == 10300)\n             pfrom->nVersion = 300;\n         if (!vRecv.empty())\n@@ -4967,14 +4963,19 @@ bool static ProcessMessage(CNode* pfrom, string strCommand, CDataStream& vRecv,\n                   pfrom->nStartingHeight, addrMe.ToString(), pfrom->id,\n                   remoteAddr);\n \n-        if (pfrom->nServicesExpected & ~pfrom->nServices)\n+        if (!pfrom->fInbound)\n         {\n-            LogPrint(\"net\", \"peer=%d does not offer the expected services (%08x offered, %08x expected); disconnecting\\n\", pfrom->id, pfrom->nServices, pfrom->nServicesExpected);\n-            pfrom->PushMessage(NetMsgType::REJECT, strCommand, REJECT_NONSTANDARD,\n+            addrman.SetServices(pfrom->addr, pfrom->nServices);\n+            if (nRelevantServices & ~pfrom->nServices) {\n+                LogPrint(\"net\", \"peer=%d does not offer the relevant services (%08x offered, %08x expected, %08x relevant); disconnecting\\n\", pfrom->id, pfrom->nServices, pfrom->nServicesExpected, nRelevantServices);\n+                pfrom->PushMessage(NetMsgType::REJECT, strCommand, REJECT_NONSTANDARD,\n                                strprintf(\"Expected to offer services %08x\", pfrom->nServicesExpected));\n-            pfrom->fDisconnect = true;\n-            return false;\n+                pfrom->fDisconnect = true;\n+                return false;\n+            }\n         }\n+        if (pfrom->nServicesExpected & ~pfrom->nServices)\n+            LogPrint(\"net\", \"peer=%d does not offer the expected services (%08x offered, %08x expected)\\n\", pfrom->id, pfrom->nServices, pfrom->nServicesExpected);\n \n         if (pfrom->nVersion < MIN_PEER_PROTO_VERSION)\n         {"
      }
    ]
  },
  {
    "sha": "67ea5e03a823fd9951128815b3ef9f5a504bf46f",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2N2VhNWUwM2E4MjNmZDk5NTExMjg4MTViM2VmOWY1YTUwNGJmNDZm",
    "commit": {
      "author": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2016-08-28T08:02:03Z"
      },
      "committer": {
        "name": "R E Broadley",
        "email": "rebroad+github@gmail.com",
        "date": "2016-08-28T08:02:03Z"
      },
      "message": "nServicesExpected now represents Services Expected rather than a subset.",
      "tree": {
        "sha": "5678f297a23e5c4be049e89bc7dc739316b92e9a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/5678f297a23e5c4be049e89bc7dc739316b92e9a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/67ea5e03a823fd9951128815b3ef9f5a504bf46f",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/67ea5e03a823fd9951128815b3ef9f5a504bf46f",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/67ea5e03a823fd9951128815b3ef9f5a504bf46f",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/67ea5e03a823fd9951128815b3ef9f5a504bf46f/comments",
    "author": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "rebroad",
      "id": 1530283,
      "node_id": "MDQ6VXNlcjE1MzAyODM=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1530283?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/rebroad",
      "html_url": "https://github.com/rebroad",
      "followers_url": "https://api.github.com/users/rebroad/followers",
      "following_url": "https://api.github.com/users/rebroad/following{/other_user}",
      "gists_url": "https://api.github.com/users/rebroad/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/rebroad/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/rebroad/subscriptions",
      "organizations_url": "https://api.github.com/users/rebroad/orgs",
      "repos_url": "https://api.github.com/users/rebroad/repos",
      "events_url": "https://api.github.com/users/rebroad/events{/privacy}",
      "received_events_url": "https://api.github.com/users/rebroad/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "edbe03104afb1b5829340b11f9fb8689b1ca2a50",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/edbe03104afb1b5829340b11f9fb8689b1ca2a50",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/edbe03104afb1b5829340b11f9fb8689b1ca2a50"
      }
    ],
    "stats": {
      "total": 2,
      "additions": 1,
      "deletions": 1
    },
    "files": [
      {
        "sha": "8b48f9d32bd26e9b186580fbbe9221f480aac4e3",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/67ea5e03a823fd9951128815b3ef9f5a504bf46f/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/67ea5e03a823fd9951128815b3ef9f5a504bf46f/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=67ea5e03a823fd9951128815b3ef9f5a504bf46f",
        "patch": "@@ -446,7 +446,7 @@ CNode* ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure\n             vNodes.push_back(pnode);\n         }\n \n-        pnode->nServicesExpected = ServiceFlags(addrConnect.nServices & nRelevantServices);\n+        pnode->nServicesExpected = ServiceFlags(addrConnect.nServices);\n         pnode->nTimeConnected = GetTime();\n \n         return pnode;"
      }
    ]
  }
]