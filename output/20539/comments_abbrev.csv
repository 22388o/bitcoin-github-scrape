naumenkogs,2020-12-01 08:23:38,"The bug was found by @jnewbery [here](https://github.com/bitcoin/bitcoin/pull/16702#discussion_r515608294).\n\nThis probably should be backported to 0.20 and 0.21.\n\ncc @vasild ",https://github.com/bitcoin/bitcoin/pull/20539#issuecomment-736306028,736306028,
naumenkogs,2020-12-01 08:26:58,"To be clear, the issue we're solving here happens only *once* when a node updates from <0.20 to 0.20+.\nAfter that, even if asmap was not supplied, peers.dat will be stored on disk in Format::V2_ASMAP,\nand next time a node restarted, the check won't be triggered. (even before this PR)",https://github.com/bitcoin/bitcoin/pull/20539#issuecomment-736307658,736307658,
DrahtBot,2020-12-01 09:36:42,<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.,https://github.com/bitcoin/bitcoin/pull/20539#issuecomment-736348790,736348790,
jnewbery,2020-12-03 11:40:23,#20557 fixes this issue and a couple of other bugs in addrman unserialization. I suggest we close this PR in favour of that one.,https://github.com/bitcoin/bitcoin/pull/20539#issuecomment-737888850,737888850,
vasild,2020-12-01 14:04:23,"I think this would be more readable as:\n```cpp\nif (asmap_is_same && constants_are_same && assignment_is_same) {\n```\n(and of course variables renamed and re-assigned)",https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533430513,533430513,src/addrman.h
vasild,2020-12-01 14:24:58,"```\nI think the second commit is not an equivalent change (it is behavioral change):\n\nasmap_was_supported == format >= Format::V2_ASMAP;\nasmap_changed ==\n    (!asmap_was_supported && m_asmap.size() != 0) ||\n    (asmap_was_supported && serialized_asmap_version != supplied_asmap_version);\n\nis equivalent to\n\nasmap_changed ==\n    (!(format >= Format::V2_ASMAP) && m_asmap.size() !",https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533445562,533445562,src/addrman.h
vasild,2020-12-01 14:29:08,"This is introduced in the first commit:\n\n```\n(format >= Format::V2_ASMAP && serialized_asmap_version == supplied_asmap_version) ||\n(format < Format::V2_ASMAP && m_asmap.size() == 0)\n```\n\nIs it not equivalent to just `serialized_asmap_version == supplied_asmap_version`? After all, if the hash of the supplied and the serialized version is the same, then asmap did not change.",https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533448739,533448739,src/addrman.h
naumenkogs,2020-12-01 16:31:53,"""Same"" is not quite true... For example, if ""ADDRMAN_NEW_BUCKETS_PER_ADDRESS"" was increased, we should ignore it here, although technically it changed :)",https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533551450,533551450,src/addrman.h
naumenkogs,2020-12-02 08:22:39,"Well, I think they are actually equal, assuming that both can be simplified to `serialized_asmap_version == supplied_asmap_version` in our case :)",https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533975122,533975122,src/addrman.h
naumenkogs,2020-12-02 08:22:59,"Anyway, this part will be no relevant when I simplify the first commit.",https://github.com/bitcoin/bitcoin/pull/20539#discussion_r533975311,533975311,src/addrman.h
jnewbery,2020-12-02 09:23:15,"I still think these assignments should happen outside the loop, since they're constant and don't depend on the loop variable. See https://github.com/bitcoin/bitcoin/pull/16702#discussion_r515608294.",https://github.com/bitcoin/bitcoin/pull/20539#discussion_r534013241,534013241,src/addrman.h
naumenkogs,2020-12-02 09:25:09,"Yeah, some of them. I'll move them out.",https://github.com/bitcoin/bitcoin/pull/20539#discussion_r534014630,534014630,src/addrman.h
