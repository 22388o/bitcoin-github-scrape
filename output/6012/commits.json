[
  {
    "sha": "0421c18f3a261f04e83a03f59884e5798af74fd9",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowNDIxYzE4ZjNhMjYxZjA0ZTgzYTAzZjU5ODg0ZTU3OThhZjc0ZmQ5",
    "commit": {
      "author": {
        "name": "mrbandrews",
        "email": "bandrewsny@gmail.com",
        "date": "2015-04-09T15:08:39Z"
      },
      "committer": {
        "name": "mrbandrews",
        "email": "bandrewsny@gmail.com",
        "date": "2015-04-14T18:10:19Z"
      },
      "message": "Fix CheckBlockIndex for reindex.\n\nSome tests in CheckBlockIndex require chainActive.Tip(), but when reindexing, chainActive has not been set on the first call to CheckBlockIndex.\n\nreindex.py starts a node, mines 3 blocks, stops, and reindexes with CheckBlockIndex enabled.",
      "tree": {
        "sha": "7832041ab8119c93b5d19ca00460dc5c7d18511a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7832041ab8119c93b5d19ca00460dc5c7d18511a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/0421c18f3a261f04e83a03f59884e5798af74fd9",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0421c18f3a261f04e83a03f59884e5798af74fd9",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/0421c18f3a261f04e83a03f59884e5798af74fd9",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0421c18f3a261f04e83a03f59884e5798af74fd9/comments",
    "author": {
      "login": "mrbandrews",
      "id": 7504522,
      "node_id": "MDQ6VXNlcjc1MDQ1MjI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7504522?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mrbandrews",
      "html_url": "https://github.com/mrbandrews",
      "followers_url": "https://api.github.com/users/mrbandrews/followers",
      "following_url": "https://api.github.com/users/mrbandrews/following{/other_user}",
      "gists_url": "https://api.github.com/users/mrbandrews/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mrbandrews/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mrbandrews/subscriptions",
      "organizations_url": "https://api.github.com/users/mrbandrews/orgs",
      "repos_url": "https://api.github.com/users/mrbandrews/repos",
      "events_url": "https://api.github.com/users/mrbandrews/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mrbandrews/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "mrbandrews",
      "id": 7504522,
      "node_id": "MDQ6VXNlcjc1MDQ1MjI=",
      "avatar_url": "https://avatars.githubusercontent.com/u/7504522?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/mrbandrews",
      "html_url": "https://github.com/mrbandrews",
      "followers_url": "https://api.github.com/users/mrbandrews/followers",
      "following_url": "https://api.github.com/users/mrbandrews/following{/other_user}",
      "gists_url": "https://api.github.com/users/mrbandrews/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/mrbandrews/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/mrbandrews/subscriptions",
      "organizations_url": "https://api.github.com/users/mrbandrews/orgs",
      "repos_url": "https://api.github.com/users/mrbandrews/repos",
      "events_url": "https://api.github.com/users/mrbandrews/events{/privacy}",
      "received_events_url": "https://api.github.com/users/mrbandrews/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "d3eb5ae46a4cc05a0b1dfdba66e704cb5e7886f1",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d3eb5ae46a4cc05a0b1dfdba66e704cb5e7886f1",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/d3eb5ae46a4cc05a0b1dfdba66e704cb5e7886f1"
      }
    ],
    "stats": {
      "total": 42,
      "additions": 42,
      "deletions": 0
    },
    "files": [
      {
        "sha": "fe767586bb751069195860eab525350a3aca6b61",
        "filename": "qa/rpc-tests/reindex.py",
        "status": "added",
        "additions": 34,
        "deletions": 0,
        "changes": 34,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0421c18f3a261f04e83a03f59884e5798af74fd9/qa/rpc-tests/reindex.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0421c18f3a261f04e83a03f59884e5798af74fd9/qa/rpc-tests/reindex.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/qa/rpc-tests/reindex.py?ref=0421c18f3a261f04e83a03f59884e5798af74fd9",
        "patch": "@@ -0,0 +1,34 @@\n+#!/usr/bin/env python2\n+# Copyright (c) 2014 The Bitcoin Core developers\n+# Distributed under the MIT software license, see the accompanying\n+# file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#\n+# Test -reindex with CheckBlockIndex\n+#\n+from test_framework import BitcoinTestFramework\n+from bitcoinrpc.authproxy import AuthServiceProxy, JSONRPCException\n+from util import *\n+import os.path\n+\n+class ReindexTest(BitcoinTestFramework):\n+\n+    def setup_chain(self):\n+        print(\"Initializing test directory \"+self.options.tmpdir)\n+        initialize_chain_clean(self.options.tmpdir, 1)\n+\n+    def setup_network(self):\n+        self.nodes = []\n+        self.is_network_split = False\n+        self.nodes.append(start_node(0, self.options.tmpdir))\n+\n+    def run_test(self):\n+        self.nodes[0].generate(3)\n+        stop_node(self.nodes[0], 0)\n+        wait_bitcoinds()\n+        self.nodes[0]=start_node(0, self.options.tmpdir, [\"-debug\", \"-reindex\", \"-checkblockindex=1\"])\n+        assert_equal(self.nodes[0].getblockcount(), 3)\n+        print \"Success\"\n+\n+if __name__ == '__main__':\n+    ReindexTest().main()"
      },
      {
        "sha": "a9051118a899d9c12cc0c0be8bbaab64440321b9",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 8,
        "deletions": 0,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/0421c18f3a261f04e83a03f59884e5798af74fd9/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/0421c18f3a261f04e83a03f59884e5798af74fd9/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=0421c18f3a261f04e83a03f59884e5798af74fd9",
        "patch": "@@ -3227,6 +3227,14 @@ void static CheckBlockIndex()\n \n     LOCK(cs_main);\n \n+    // During a reindex, we read the genesis block and call CheckBlockIndex before ActivateBestChain,\n+    // so we have the genesis block in mapBlockIndex but no active chain.  (A few of the tests when\n+    // iterating the block tree require that chainActive has been initialized.)\n+    if (chainActive.Height() < 0) {\n+        assert(mapBlockIndex.size() <= 1);\n+        return;\n+    }\n+\n     // Build forward-pointing map of the entire block tree.\n     std::multimap<CBlockIndex*,CBlockIndex*> forward;\n     for (BlockMap::iterator it = mapBlockIndex.begin(); it != mapBlockIndex.end(); it++) {"
      }
    ]
  }
]