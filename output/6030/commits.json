[
  {
    "sha": "d40154bf1ca7b13da88c705435602a86f3f659a6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkNDAxNTRiZjFjYTdiMTNkYTg4YzcwNTQzNTYwMmE4NmYzZjY1OWE2",
    "commit": {
      "author": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2015-04-19T19:34:43Z"
      },
      "committer": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2015-11-22T23:59:50Z"
      },
      "message": "Avoid counting failed connect attempts when probably offline.\n\nIf a node is offline failed outbound connection attempts will crank up\n the addrman counter and effectively blow away our state.\n\nThis change reduces the problem by only counting attempts made while\n the node believes it has outbound connections to at least two\n netgroups.\n\nConnect and addnode connections are also not counted, as there is no\n reason to unequally penalize them for their more frequent\n connections -- though there should be no real effect from this\n unless their addnode configureation is later removed.\n\nWasteful repeated connection attempts while only a few connections are\n up are avoided via nLastTry.\n\nThis is still somewhat incomplete protection because our outbound\n peers could be down but not timed out or might all be on 'local'\n networks (although the requirement for multiple netgroups helps).",
      "tree": {
        "sha": "a15cb29712bbcaf11a32f7bcbd63e071dfac4d41",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a15cb29712bbcaf11a32f7bcbd63e071dfac4d41"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d40154bf1ca7b13da88c705435602a86f3f659a6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d40154bf1ca7b13da88c705435602a86f3f659a6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/d40154bf1ca7b13da88c705435602a86f3f659a6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d40154bf1ca7b13da88c705435602a86f3f659a6/comments",
    "author": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "0b0fc179ab8795463e0a0f07e989ec6f592a1f90",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/0b0fc179ab8795463e0a0f07e989ec6f592a1f90",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/0b0fc179ab8795463e0a0f07e989ec6f592a1f90"
      }
    ],
    "stats": {
      "total": 36,
      "additions": 18,
      "deletions": 18
    },
    "files": [
      {
        "sha": "a1dcbedc02d6f26f29013c7bdadc4badfa47fd3b",
        "filename": "src/addrman.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d40154bf1ca7b13da88c705435602a86f3f659a6/src/addrman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d40154bf1ca7b13da88c705435602a86f3f659a6/src/addrman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/addrman.cpp?ref=d40154bf1ca7b13da88c705435602a86f3f659a6",
        "patch": "@@ -310,7 +310,7 @@ bool CAddrMan::Add_(const CAddress& addr, const CNetAddr& source, int64_t nTimeP\n     return fNew;\n }\n \n-void CAddrMan::Attempt_(const CService& addr, int64_t nTime)\n+void CAddrMan::Attempt_(const CService& addr, bool fCountFailure, int64_t nTime)\n {\n     CAddrInfo* pinfo = Find(addr);\n \n@@ -326,7 +326,7 @@ void CAddrMan::Attempt_(const CService& addr, int64_t nTime)\n \n     // update info\n     info.nLastTry = nTime;\n-    info.nAttempts++;\n+    if (fCountFailure) info.nAttempts++;\n }\n \n CAddrInfo CAddrMan::Select_(bool newOnly)"
      },
      {
        "sha": "5d8d5a72ee29e2f56b630e79f37a847c87ecc0f5",
        "filename": "src/addrman.h",
        "status": "modified",
        "additions": 3,
        "deletions": 3,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d40154bf1ca7b13da88c705435602a86f3f659a6/src/addrman.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d40154bf1ca7b13da88c705435602a86f3f659a6/src/addrman.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/addrman.h?ref=d40154bf1ca7b13da88c705435602a86f3f659a6",
        "patch": "@@ -230,7 +230,7 @@ class CAddrMan\n     bool Add_(const CAddress &addr, const CNetAddr& source, int64_t nTimePenalty);\n \n     //! Mark an entry as attempted to connect.\n-    void Attempt_(const CService &addr, int64_t nTime);\n+    void Attempt_(const CService &addr, bool fCountFailure, int64_t nTime);\n \n     //! Select an address to connect to, if newOnly is set to true, only the new table is selected from.\n     CAddrInfo Select_(bool newOnly);\n@@ -521,12 +521,12 @@ class CAddrMan\n     }\n \n     //! Mark an entry as connection attempted to.\n-    void Attempt(const CService &addr, int64_t nTime = GetAdjustedTime())\n+    void Attempt(const CService &addr, bool fCountFailure, int64_t nTime = GetAdjustedTime())\n     {\n         {\n             LOCK(cs);\n             Check();\n-            Attempt_(addr, nTime);\n+            Attempt_(addr, fCountFailure, nTime);\n             Check();\n         }\n     }"
      },
      {
        "sha": "e9f8a728663919cfd3c1b6f28ab7184e095eeccd",
        "filename": "src/net.cpp",
        "status": "modified",
        "additions": 10,
        "deletions": 10,
        "changes": 20,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d40154bf1ca7b13da88c705435602a86f3f659a6/src/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d40154bf1ca7b13da88c705435602a86f3f659a6/src/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.cpp?ref=d40154bf1ca7b13da88c705435602a86f3f659a6",
        "patch": "@@ -377,7 +377,7 @@ CNode* FindNode(const CService& addr)\n     return NULL;\n }\n \n-CNode* ConnectNode(CAddress addrConnect, const char *pszDest)\n+CNode* ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure)\n {\n     if (pszDest == NULL) {\n         if (IsLocal(addrConnect))\n@@ -409,7 +409,7 @@ CNode* ConnectNode(CAddress addrConnect, const char *pszDest)\n             return NULL;\n         }\n \n-        addrman.Attempt(addrConnect);\n+        addrman.Attempt(addrConnect, fCountFailure);\n \n         // Add node\n         CNode* pnode = new CNode(hSocket, addrConnect, pszDest ? pszDest : \"\", false);\n@@ -426,7 +426,7 @@ CNode* ConnectNode(CAddress addrConnect, const char *pszDest)\n     } else if (!proxyConnectionFailed) {\n         // If connecting to the node failed, and failure is not caused by a problem connecting to\n         // the proxy, mark this as an attempt.\n-        addrman.Attempt(addrConnect);\n+        addrman.Attempt(addrConnect, fCountFailure);\n     }\n \n     return NULL;\n@@ -1499,7 +1499,7 @@ void static ProcessOneShot()\n     CAddress addr;\n     CSemaphoreGrant grant(*semOutbound, true);\n     if (grant) {\n-        if (!OpenNetworkConnection(addr, &grant, strDest.c_str(), true))\n+        if (!OpenNetworkConnection(addr, false, &grant, strDest.c_str(), true))\n             AddOneShot(strDest);\n     }\n }\n@@ -1515,7 +1515,7 @@ void ThreadOpenConnections()\n             BOOST_FOREACH(const std::string& strAddr, mapMultiArgs[\"-connect\"])\n             {\n                 CAddress addr;\n-                OpenNetworkConnection(addr, NULL, strAddr.c_str());\n+                OpenNetworkConnection(addr, false, NULL, strAddr.c_str());\n                 for (int i = 0; i < 10 && i < nLoop; i++)\n                 {\n                     MilliSleep(500);\n@@ -1599,7 +1599,7 @@ void ThreadOpenConnections()\n         }\n \n         if (addrConnect.IsValid())\n-            OpenNetworkConnection(addrConnect, &grant);\n+            OpenNetworkConnection(addrConnect, (int)setConnected.size() >= min(nMaxConnections - 1, 2), &grant);\n     }\n }\n \n@@ -1621,7 +1621,7 @@ void ThreadOpenAddedConnections()\n             BOOST_FOREACH(const std::string& strAddNode, lAddresses) {\n                 CAddress addr;\n                 CSemaphoreGrant grant(*semOutbound);\n-                OpenNetworkConnection(addr, &grant, strAddNode.c_str());\n+                OpenNetworkConnection(addr, false, &grant, strAddNode.c_str());\n                 MilliSleep(500);\n             }\n             MilliSleep(120000); // Retry every 2 minutes\n@@ -1667,15 +1667,15 @@ void ThreadOpenAddedConnections()\n         BOOST_FOREACH(vector<CService>& vserv, lservAddressesToAdd)\n         {\n             CSemaphoreGrant grant(*semOutbound);\n-            OpenNetworkConnection(CAddress(vserv[i % vserv.size()]), &grant);\n+            OpenNetworkConnection(CAddress(vserv[i % vserv.size()]), false, &grant);\n             MilliSleep(500);\n         }\n         MilliSleep(120000); // Retry every 2 minutes\n     }\n }\n \n // if successful, this moves the passed grant to the constructed node\n-bool OpenNetworkConnection(const CAddress& addrConnect, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot)\n+bool OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound, const char *pszDest, bool fOneShot)\n {\n     //\n     // Initiate outbound network connection\n@@ -1689,7 +1689,7 @@ bool OpenNetworkConnection(const CAddress& addrConnect, CSemaphoreGrant *grantOu\n     } else if (FindNode(std::string(pszDest)))\n         return false;\n \n-    CNode* pnode = ConnectNode(addrConnect, pszDest);\n+    CNode* pnode = ConnectNode(addrConnect, pszDest, fCountFailure);\n     boost::this_thread::interruption_point();\n \n     if (!pnode)"
      },
      {
        "sha": "e0db41ee7666e2dfec23bf5a5bc892ed5fe01c2a",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 2,
        "deletions": 2,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d40154bf1ca7b13da88c705435602a86f3f659a6/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d40154bf1ca7b13da88c705435602a86f3f659a6/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=d40154bf1ca7b13da88c705435602a86f3f659a6",
        "patch": "@@ -74,8 +74,8 @@ CNode* FindNode(const CNetAddr& ip);\n CNode* FindNode(const CSubNet& subNet);\n CNode* FindNode(const std::string& addrName);\n CNode* FindNode(const CService& ip);\n-CNode* ConnectNode(CAddress addrConnect, const char *pszDest = NULL);\n-bool OpenNetworkConnection(const CAddress& addrConnect, CSemaphoreGrant *grantOutbound = NULL, const char *strDest = NULL, bool fOneShot = false);\n+CNode* ConnectNode(CAddress addrConnect, const char *pszDest, bool fCountFailure);\n+bool OpenNetworkConnection(const CAddress& addrConnect, bool fCountFailure, CSemaphoreGrant *grantOutbound = NULL, const char *strDest = NULL, bool fOneShot = false);\n void MapPort(bool fUseUPnP);\n unsigned short GetListenPort();\n bool BindListenPort(const CService &bindAddr, std::string& strError, bool fWhitelisted = false);"
      },
      {
        "sha": "886be92bfa113b16c53dc7b1c7b45754351c134e",
        "filename": "src/rpcnet.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d40154bf1ca7b13da88c705435602a86f3f659a6/src/rpcnet.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d40154bf1ca7b13da88c705435602a86f3f659a6/src/rpcnet.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpcnet.cpp?ref=d40154bf1ca7b13da88c705435602a86f3f659a6",
        "patch": "@@ -195,7 +195,7 @@ UniValue addnode(const UniValue& params, bool fHelp)\n     if (strCommand == \"onetry\")\n     {\n         CAddress addr;\n-        OpenNetworkConnection(addr, NULL, strNode.c_str());\n+        OpenNetworkConnection(addr, false, NULL, strNode.c_str());\n         return NullUniValue;\n     }\n "
      }
    ]
  },
  {
    "sha": "801ffd89f45c6a3ed01496aebfef8959b6feb79e",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4MDFmZmQ4OWY0NWM2YTNlZDAxNDk2YWViZmVmODk1OWI2ZmViNzll",
    "commit": {
      "author": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2015-04-19T20:39:38Z"
      },
      "committer": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2015-11-23T00:04:13Z"
      },
      "message": "Do not increment nAttempts by more than one for every Good connection.\n\nThis slows the increase of the nAttempts in addrman while partitioned,\n even if the node hasn't yet noticed the partitioning.",
      "tree": {
        "sha": "6b00e93a8cb2b91cc0d5554bc2ac45cb7918860d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/6b00e93a8cb2b91cc0d5554bc2ac45cb7918860d"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/801ffd89f45c6a3ed01496aebfef8959b6feb79e",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/801ffd89f45c6a3ed01496aebfef8959b6feb79e",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/801ffd89f45c6a3ed01496aebfef8959b6feb79e",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/801ffd89f45c6a3ed01496aebfef8959b6feb79e/comments",
    "author": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "d40154bf1ca7b13da88c705435602a86f3f659a6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d40154bf1ca7b13da88c705435602a86f3f659a6",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/d40154bf1ca7b13da88c705435602a86f3f659a6"
      }
    ],
    "stats": {
      "total": 16,
      "additions": 15,
      "deletions": 1
    },
    "files": [
      {
        "sha": "ef8a93f68916185c3c18b667207133f7033e6330",
        "filename": "src/addrman.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 1,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/801ffd89f45c6a3ed01496aebfef8959b6feb79e/src/addrman.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/801ffd89f45c6a3ed01496aebfef8959b6feb79e/src/addrman.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/addrman.cpp?ref=801ffd89f45c6a3ed01496aebfef8959b6feb79e",
        "patch": "@@ -196,6 +196,9 @@ void CAddrMan::MakeTried(CAddrInfo& info, int nId)\n void CAddrMan::Good_(const CService& addr, int64_t nTime)\n {\n     int nId;\n+\n+    nLastGood = nTime;\n+\n     CAddrInfo* pinfo = Find(addr, &nId);\n \n     // if not found, bail out\n@@ -326,7 +329,10 @@ void CAddrMan::Attempt_(const CService& addr, bool fCountFailure, int64_t nTime)\n \n     // update info\n     info.nLastTry = nTime;\n-    if (fCountFailure) info.nAttempts++;\n+    if (fCountFailure && info.nLastCountAttempt < nLastGood) {\n+        info.nLastCountAttempt = nTime;\n+        info.nAttempts++;\n+    }\n }\n \n CAddrInfo CAddrMan::Select_(bool newOnly)"
      },
      {
        "sha": "35c3697e49613f5aaf8e20c4f576c6ff8cf8d66b",
        "filename": "src/addrman.h",
        "status": "modified",
        "additions": 8,
        "deletions": 0,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/801ffd89f45c6a3ed01496aebfef8959b6feb79e/src/addrman.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/801ffd89f45c6a3ed01496aebfef8959b6feb79e/src/addrman.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/addrman.h?ref=801ffd89f45c6a3ed01496aebfef8959b6feb79e",
        "patch": "@@ -28,6 +28,9 @@ class CAddrInfo : public CAddress\n     //! last try whatsoever by us (memory only)\n     int64_t nLastTry;\n \n+    //! last counted attempt (memory only)\n+    int64_t nLastCountAttempt;\n+\n private:\n     //! where knowledge about this address first came from\n     CNetAddr source;\n@@ -65,6 +68,7 @@ class CAddrInfo : public CAddress\n     {\n         nLastSuccess = 0;\n         nLastTry = 0;\n+        nLastCountAttempt = 0;\n         nAttempts = 0;\n         nRefCount = 0;\n         fInTried = false;\n@@ -202,6 +206,9 @@ class CAddrMan\n     //! list of \"new\" buckets\n     int vvNew[ADDRMAN_NEW_BUCKET_COUNT][ADDRMAN_BUCKET_SIZE];\n \n+    //! last time Good was called (memory only)\n+    int64_t nLastGood;\n+\n protected:\n \n     //! Find an entry.\n@@ -447,6 +454,7 @@ class CAddrMan\n         nIdCount = 0;\n         nTried = 0;\n         nNew = 0;\n+        nLastGood = 1; //Initially at 1 so that \"never\" is strictly worse.\n     }\n \n     CAddrMan()"
      }
    ]
  }
]