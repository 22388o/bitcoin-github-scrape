[
  {
    "sha": "fa8fffebe8ac126f31143619843dd6578a2f4e3c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmYThmZmZlYmU4YWMxMjZmMzExNDM2MTk4NDNkZDY1NzhhMmY0ZTNj",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2021-04-04T05:47:14Z"
      },
      "committer": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2021-04-04T05:37:43Z"
      },
      "message": "refactor: Prefer clean assert over UB in coinstats",
      "tree": {
        "sha": "b205e55ba5c41d391567305d6a61cd6e94db060a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b205e55ba5c41d391567305d6a61cd6e94db060a"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fa8fffebe8ac126f31143619843dd6578a2f4e3c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unknown_key",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\npUgB3Av9E7tiM5UiXbEkp84VQf4UZNcK6bhLGv24lOhvmWbyDvj8mvYc/6W6pI3j\nr1xB1Ue+MspjDut1AtamzGPVkLsjcdla1bTnYXFz/cC3dcfolnf9xOJXRMDRZ2mj\n8U6j8qwIIQDcScLAKUswG0xWbWNUDSzF27hlJVhn8ZRUrrlhh2mJ7pM1TSaFgkVu\nH8bJ1FwYXls8aDF0iV6adtPj5kFglL9TCAsPFDPEAunvqry8F9wZ1BNoN1BkzMKL\n416vSQrdtI1+i7EjNVMYqdW+Hx9OLT9fI9AmtUswhV2XhLAkmSs7m4SLR3osV17q\nGsf+xHmKDfuy069nj6CY/2lF7F97zYfYmWDJuyx+qEQJe1+KZAnDJy9tPAo76eIF\nATBZmwDB5AElUunQv6E4BU1iBx21TO/U/3tnctL7BjSE8JOAdmSLYapyOq8rti40\nfzNs/vV9IR9UPAEDDnOBjkq88AJh3T6kPol8Hx+RKEEZLHaZWQiRSUjBklUqTJhW\nLkZUeSxB\n=6oB9\n-----END PGP SIGNATURE-----",
        "payload": "tree b205e55ba5c41d391567305d6a61cd6e94db060a\nparent ad4bf8a94594e7fe424e409ba9474d91584bb78c\nauthor MarcoFalke <falke.marco@gmail.com> 1617515234 +0200\ncommitter MarcoFalke <falke.marco@gmail.com> 1617514663 +0200\n\nrefactor: Prefer clean assert over UB in coinstats\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fa8fffebe8ac126f31143619843dd6578a2f4e3c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/fa8fffebe8ac126f31143619843dd6578a2f4e3c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fa8fffebe8ac126f31143619843dd6578a2f4e3c/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "ad4bf8a94594e7fe424e409ba9474d91584bb78c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ad4bf8a94594e7fe424e409ba9474d91584bb78c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/ad4bf8a94594e7fe424e409ba9474d91584bb78c"
      }
    ],
    "stats": {
      "total": 3,
      "additions": 2,
      "deletions": 1
    },
    "files": [
      {
        "sha": "f8f0fff43f5b09af83bdcec5e21a5484e3252e19",
        "filename": "src/node/coinstats.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fa8fffebe8ac126f31143619843dd6578a2f4e3c/src/node/coinstats.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fa8fffebe8ac126f31143619843dd6578a2f4e3c/src/node/coinstats.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/node/coinstats.cpp?ref=fa8fffebe8ac126f31143619843dd6578a2f4e3c",
        "patch": "@@ -94,7 +94,8 @@ static bool GetUTXOStats(CCoinsView* view, BlockManager& blockman, CCoinsStats&\n     {\n         LOCK(cs_main);\n         assert(std::addressof(g_chainman.m_blockman) == std::addressof(blockman));\n-        stats.nHeight = blockman.LookupBlockIndex(stats.hashBlock)->nHeight;\n+        const CBlockIndex* block = blockman.LookupBlockIndex(stats.hashBlock);\n+        stats.nHeight = Assert(block)->nHeight;\n     }\n \n     PrepareHash(hash_obj, stats);"
      }
    ]
  },
  {
    "sha": "fa9b74f5ea89624e052934c48391b5076a87ffef",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpmYTliNzRmNWVhODk2MjRlMDUyOTM0YzQ4MzkxYjUwNzZhODdmZmVm",
    "commit": {
      "author": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2021-04-03T13:30:04Z"
      },
      "committer": {
        "name": "MarcoFalke",
        "email": "falke.marco@gmail.com",
        "date": "2021-04-04T05:38:02Z"
      },
      "message": "Fix assumeutxo crash due to missing base_blockhash",
      "tree": {
        "sha": "75a78b8535b82129fd3105b6c3c50f06ea3db14b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/75a78b8535b82129fd3105b6c3c50f06ea3db14b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/fa9b74f5ea89624e052934c48391b5076a87ffef",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unknown_key",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQGzBAABCgAdFiEE+rVPoUahrI9sLGYTzit1aX5ppUgFAlwqrYAACgkQzit1aX5p\npUi93Qv/elHMozjfb3LM4kGEPPl6hkgNKH9jwZSwMtdCvO+5utlZ5GVlBDl1zV/x\ncvTYmGX5fvlCywwMPlbwRB0WHj0U5vu1UM83nVY/0s8ldZPqLoyZ4e8M8fy0E1ex\nKXcc1k5ThTJ+801fcG5LkeWkR+81UVIW1bcX3jDfarAnjl6JFTOdi0u1mY9d4rM6\nLQ0RrzNQUijF8npXGPPZ49XVEwaGDhvnvHguVkRKa5uJWX17lH3EBwreKDTlOee1\nTWVHZZ1v8smpqocu+qmKSn6fdIIYMyesphdMNoPJdez2joLP6+mbn52h7dRhAoA0\neJSMyKSmMyP79PjvWSa3N8aV0CZKWS9jxt1/NyZtHEJFndFUFn/c1Z9AisfhSwi/\nahHTxxkWGt67ANgG6kHCQUZ8zCwSTxZcIjK6b/iSCxxpK1IaV2Mh/s8obSkFD9Lm\nB0p4MhBlwbQ5jWozNjnVj43sj7FkxNuWKQHmrDyuR8d8gr/U56FSNjuTWSMcBlMh\nwg/YOBuB\n=U5WK\n-----END PGP SIGNATURE-----",
        "payload": "tree 75a78b8535b82129fd3105b6c3c50f06ea3db14b\nparent fa8fffebe8ac126f31143619843dd6578a2f4e3c\nauthor MarcoFalke <falke.marco@gmail.com> 1617456604 +0200\ncommitter MarcoFalke <falke.marco@gmail.com> 1617514682 +0200\n\nFix assumeutxo crash due to missing base_blockhash\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fa9b74f5ea89624e052934c48391b5076a87ffef",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/fa9b74f5ea89624e052934c48391b5076a87ffef",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fa9b74f5ea89624e052934c48391b5076a87ffef/comments",
    "author": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "MarcoFalke",
      "id": 6399679,
      "node_id": "MDQ6VXNlcjYzOTk2Nzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/6399679?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/MarcoFalke",
      "html_url": "https://github.com/MarcoFalke",
      "followers_url": "https://api.github.com/users/MarcoFalke/followers",
      "following_url": "https://api.github.com/users/MarcoFalke/following{/other_user}",
      "gists_url": "https://api.github.com/users/MarcoFalke/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/MarcoFalke/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/MarcoFalke/subscriptions",
      "organizations_url": "https://api.github.com/users/MarcoFalke/orgs",
      "repos_url": "https://api.github.com/users/MarcoFalke/repos",
      "events_url": "https://api.github.com/users/MarcoFalke/events{/privacy}",
      "received_events_url": "https://api.github.com/users/MarcoFalke/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "fa8fffebe8ac126f31143619843dd6578a2f4e3c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/fa8fffebe8ac126f31143619843dd6578a2f4e3c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/fa8fffebe8ac126f31143619843dd6578a2f4e3c"
      }
    ],
    "stats": {
      "total": 39,
      "additions": 14,
      "deletions": 25
    },
    "files": [
      {
        "sha": "35e087c899af5dc4619c39e724c371ab09b3c2c5",
        "filename": "src/test/validation_chainstatemanager_tests.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fa9b74f5ea89624e052934c48391b5076a87ffef/src/test/validation_chainstatemanager_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fa9b74f5ea89624e052934c48391b5076a87ffef/src/test/validation_chainstatemanager_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/validation_chainstatemanager_tests.cpp?ref=fa9b74f5ea89624e052934c48391b5076a87ffef",
        "patch": "@@ -259,6 +259,11 @@ BOOST_FIXTURE_TEST_CASE(chainstatemanager_activate_snapshot, TestChain100Determi\n             // Coins count is smaller than coins in file\n             metadata.m_coins_count -= 1;\n     }));\n+    BOOST_REQUIRE(!CreateAndActivateUTXOSnapshot(\n+        m_node, m_path_root, [](CAutoFile& auto_infile, SnapshotMetadata& metadata) {\n+            // Wrong hash\n+            metadata.m_base_blockhash = uint256::ONE;\n+    }));\n \n     BOOST_REQUIRE(CreateAndActivateUTXOSnapshot(m_node, m_path_root));\n "
      },
      {
        "sha": "619d3cea98ba7827c3a39f303a3f0c90b3d100b2",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 9,
        "deletions": 25,
        "changes": 34,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/fa9b74f5ea89624e052934c48391b5076a87ffef/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/fa9b74f5ea89624e052934c48391b5076a87ffef/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=fa9b74f5ea89624e052934c48391b5076a87ffef",
        "patch": "@@ -5423,6 +5423,15 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n \n     assert(coins_cache.GetBestBlock() == base_blockhash);\n \n+    CBlockIndex* snapshot_start_block = WITH_LOCK(::cs_main, return m_blockman.LookupBlockIndex(base_blockhash));\n+\n+    if (!snapshot_start_block) {\n+        // Needed for GetUTXOStats to determine the height\n+        LogPrintf(\"[snapshot] Did not find snapshot start blockheader %s\\n\",\n+                  base_blockhash.ToString());\n+        return false;\n+    }\n+\n     CCoinsStats stats;\n     auto breakpoint_fnc = [] { /* TODO insert breakpoint here? */ };\n \n@@ -5435,31 +5444,6 @@ bool ChainstateManager::PopulateAndValidateSnapshot(\n         return false;\n     }\n \n-    // Ensure that the base blockhash appears in the known chain of valid headers. We're willing to\n-    // wait a bit here because the snapshot may have been loaded on startup, before we've\n-    // received headers from the network.\n-\n-    int max_secs_to_wait_for_headers = 60 * 10;\n-    CBlockIndex* snapshot_start_block = nullptr;\n-\n-    while (max_secs_to_wait_for_headers > 0) {\n-        snapshot_start_block = WITH_LOCK(::cs_main,\n-            return m_blockman.LookupBlockIndex(base_blockhash));\n-        --max_secs_to_wait_for_headers;\n-\n-        if (!snapshot_start_block) {\n-            std::this_thread::sleep_for(std::chrono::seconds(1));\n-        } else {\n-            break;\n-        }\n-    }\n-\n-    if (snapshot_start_block == nullptr) {\n-        LogPrintf(\"[snapshot] timed out waiting for snapshot start blockheader %s\\n\",\n-            base_blockhash.ToString());\n-        return false;\n-    }\n-\n     // Assert that the deserialized chainstate contents match the expected assumeutxo value.\n \n     int base_height = snapshot_start_block->nHeight;"
      }
    ]
  }
]