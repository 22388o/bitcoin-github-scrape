[
  {
    "sha": "7eedeb75a27dbd606fcf4d8cebaec2899cd447a6",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo3ZWVkZWI3NWEyN2RiZDYwNmZjZjRkOGNlYmFlYzI4OTljZDQ0N2E2",
    "commit": {
      "author": {
        "name": "gzhao408",
        "email": "gzhao408@berkeley.edu",
        "date": "2020-08-10T18:28:28Z"
      },
      "committer": {
        "name": "Larry Ruane",
        "email": "larryruane@gmail.com",
        "date": "2021-06-08T15:40:29Z"
      },
      "message": "[bench] add streams findbyte",
      "tree": {
        "sha": "b03a850d3b095f45b7ec2eb06837b9adfcb9f81b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/b03a850d3b095f45b7ec2eb06837b9adfcb9f81b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/7eedeb75a27dbd606fcf4d8cebaec2899cd447a6",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7eedeb75a27dbd606fcf4d8cebaec2899cd447a6",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/7eedeb75a27dbd606fcf4d8cebaec2899cd447a6",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7eedeb75a27dbd606fcf4d8cebaec2899cd447a6/comments",
    "author": {
      "login": "glozow",
      "id": 25183001,
      "node_id": "MDQ6VXNlcjI1MTgzMDAx",
      "avatar_url": "https://avatars.githubusercontent.com/u/25183001?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/glozow",
      "html_url": "https://github.com/glozow",
      "followers_url": "https://api.github.com/users/glozow/followers",
      "following_url": "https://api.github.com/users/glozow/following{/other_user}",
      "gists_url": "https://api.github.com/users/glozow/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/glozow/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/glozow/subscriptions",
      "organizations_url": "https://api.github.com/users/glozow/orgs",
      "repos_url": "https://api.github.com/users/glozow/repos",
      "events_url": "https://api.github.com/users/glozow/events{/privacy}",
      "received_events_url": "https://api.github.com/users/glozow/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "82bc7faec8079b50f248655a97950087948f065d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/82bc7faec8079b50f248655a97950087948f065d",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/82bc7faec8079b50f248655a97950087948f065d"
      }
    ],
    "stats": {
      "total": 37,
      "additions": 36,
      "deletions": 1
    },
    "files": [
      {
        "sha": "265a7ea96e4abedd5af9bb84a82fb3a2e2bb0e17",
        "filename": "src/Makefile.bench.include",
        "status": "modified",
        "additions": 2,
        "deletions": 1,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7eedeb75a27dbd606fcf4d8cebaec2899cd447a6/src/Makefile.bench.include",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7eedeb75a27dbd606fcf4d8cebaec2899cd447a6/src/Makefile.bench.include",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/Makefile.bench.include?ref=7eedeb75a27dbd606fcf4d8cebaec2899cd447a6",
        "patch": "@@ -43,7 +43,8 @@ bench_bench_bitcoin_SOURCES = \\\n   bench/bech32.cpp \\\n   bench/lockedpool.cpp \\\n   bench/poly1305.cpp \\\n-  bench/prevector.cpp\n+  bench/prevector.cpp \\\n+  bench/streams_findbyte.cpp\n \n nodist_bench_bench_bitcoin_SOURCES = $(GENERATED_BENCH_FILES)\n "
      },
      {
        "sha": "029c3bca886533a2ad3f92392f55b1584a7c6d7d",
        "filename": "src/bench/streams_findbyte.cpp",
        "status": "added",
        "additions": 34,
        "deletions": 0,
        "changes": 34,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/7eedeb75a27dbd606fcf4d8cebaec2899cd447a6/src/bench/streams_findbyte.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/7eedeb75a27dbd606fcf4d8cebaec2899cd447a6/src/bench/streams_findbyte.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/bench/streams_findbyte.cpp?ref=7eedeb75a27dbd606fcf4d8cebaec2899cd447a6",
        "patch": "@@ -0,0 +1,34 @@\n+// Copyright (c) 2020 The Bitcoin Core developers\n+// Distributed under the MIT software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+\n+#include <bench/bench.h>\n+\n+#include <fs.h>\n+#include <streams.h>\n+\n+static void FindByte(benchmark::Bench& bench)\n+{\n+    // Setup\n+    FILE* file = fsbridge::fopen(\"streams_tmp\", \"w+b\");\n+    const size_t file_size = 200;\n+    uint8_t b = 0;\n+    for (size_t i = 0; i < file_size; ++i) {\n+        fwrite(&b, 1, 1, file);\n+    }\n+    b = 1;\n+    fwrite(&b, 1, 1, file);\n+    rewind(file);\n+    CBufferedFile bf(file, file_size * 2, file_size, 0, 0);\n+\n+    bench.minEpochIterations(1e7).run([&] {\n+        bf.SetPos(0);\n+        bf.FindByte(1);\n+    });\n+\n+    // Cleanup\n+    bf.fclose();\n+    fs::remove(\"streams_tmp\");\n+}\n+\n+BENCHMARK(FindByte);"
      }
    ]
  },
  {
    "sha": "eac3bb96b555d9955dfdccaf1cbd67806b9c81be",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplYWMzYmI5NmI1NTVkOTk1NWRmZGNjYWYxY2JkNjc4MDZiOWM4MWJl",
    "commit": {
      "author": {
        "name": "Larry Ruane",
        "email": "larryruane@gmail.com",
        "date": "2020-08-10T21:23:03Z"
      },
      "committer": {
        "name": "Larry Ruane",
        "email": "larryruane@gmail.com",
        "date": "2021-06-08T15:40:29Z"
      },
      "message": "util: improve FindByte() performance\n\nCo-authored-by: Hennadii Stepanov <32963518+hebasto@users.noreply.github.com>",
      "tree": {
        "sha": "ffa734f0adf413d9209e6e4502755b42e59e710d",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/ffa734f0adf413d9209e6e4502755b42e59e710d"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/eac3bb96b555d9955dfdccaf1cbd67806b9c81be",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/eac3bb96b555d9955dfdccaf1cbd67806b9c81be",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/eac3bb96b555d9955dfdccaf1cbd67806b9c81be",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/eac3bb96b555d9955dfdccaf1cbd67806b9c81be/comments",
    "author": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "LarryRuane",
      "id": 8321330,
      "node_id": "MDQ6VXNlcjgzMjEzMzA=",
      "avatar_url": "https://avatars.githubusercontent.com/u/8321330?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/LarryRuane",
      "html_url": "https://github.com/LarryRuane",
      "followers_url": "https://api.github.com/users/LarryRuane/followers",
      "following_url": "https://api.github.com/users/LarryRuane/following{/other_user}",
      "gists_url": "https://api.github.com/users/LarryRuane/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/LarryRuane/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/LarryRuane/subscriptions",
      "organizations_url": "https://api.github.com/users/LarryRuane/orgs",
      "repos_url": "https://api.github.com/users/LarryRuane/repos",
      "events_url": "https://api.github.com/users/LarryRuane/events{/privacy}",
      "received_events_url": "https://api.github.com/users/LarryRuane/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "7eedeb75a27dbd606fcf4d8cebaec2899cd447a6",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/7eedeb75a27dbd606fcf4d8cebaec2899cd447a6",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/7eedeb75a27dbd606fcf4d8cebaec2899cd447a6"
      }
    ],
    "stats": {
      "total": 15,
      "additions": 10,
      "deletions": 5
    },
    "files": [
      {
        "sha": "0b098eceae0de986ccf9da1d3f7e730320991e67",
        "filename": "src/streams.h",
        "status": "modified",
        "additions": 10,
        "deletions": 5,
        "changes": 15,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/eac3bb96b555d9955dfdccaf1cbd67806b9c81be/src/streams.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/eac3bb96b555d9955dfdccaf1cbd67806b9c81be/src/streams.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/streams.h?ref=eac3bb96b555d9955dfdccaf1cbd67806b9c81be",
        "patch": "@@ -795,12 +795,17 @@ class CBufferedFile\n \n     //! search for a given byte in the stream, and remain positioned on it\n     void FindByte(char ch) {\n+        size_t buf_offset = nReadPos % vchBuf.size();\n         while (true) {\n-            if (nReadPos == nSrcPos)\n-                Fill();\n-            if (vchBuf[nReadPos % vchBuf.size()] == ch)\n-                break;\n-            nReadPos++;\n+            if (nReadPos == nSrcPos) Fill();\n+            const size_t len = std::min<size_t>(vchBuf.size() - buf_offset, nSrcPos - nReadPos);\n+            const auto it_start = vchBuf.begin() + buf_offset;\n+            const auto it_find = std::find(it_start, it_start + len, ch);\n+            const size_t inc = it_find - it_start;\n+            nReadPos += inc;\n+            if (inc < len) break;\n+            buf_offset += inc;\n+            if (buf_offset >= vchBuf.size()) buf_offset = 0;\n         }\n     }\n };"
      }
    ]
  }
]