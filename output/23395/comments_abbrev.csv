prayank23,2021-10-31 19:08:35,"I understand the motivation however this option can be misused IMO so not sure about adding it\n\nI was reading the comments in https://github.com/bitcoin/bitcoin/pull/15367 and I think we should even remove `-startupnotify` because it provides an inbuilt [binder](https://en.wikipedia.org/wiki/File_binder) which can be used to run malware in the background when Bitcoin Core starts.\n\nObservat",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-955775728,955775728,
klementtan,2021-11-01 12:07:31,"Thanks, @prayank23 and @shaavan for the review and pointing out the edge case where a user might supply `""bitcoind""` as a shutdown notify bash command. \n\nA solution for that would be to call `.join()` instead `.detach()` in [here](https://github.com/bitcoin/bitcoin/pull/23395/files#diff-b1e19192258d83199d8adaa5ac31f067af98f63554bfdd679bd8e8073815e69dR183). This will result in bitcoind completi",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-956178462,956178462,
prayank23,2021-11-01 14:08:28,"> Open to feedback on how we should handle the scenario when a user supplies ""bitcoind"" as a shutdown notify bash command.\n\nI think we can avoid this case. It was just an observation which looked interesting initially. If a user wants to experiment and provides such argument he should be able to kill process or reboot system.\n\nI have issues with an option in Bitcoin Core that triggers any ",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-956265352,956265352,
sipa,2021-11-01 15:25:56,"@prayank23 If an attacker manages to make you invoke `bitcoind` with chosen configuration, you have bigger problems (it means they have filesystem access, can see your wallet files, can give themselves RPC access, ...).",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-956330559,956330559,
sipa,2021-11-01 15:26:45,Concept ACK,https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-956331293,956331293,
prayank23,2021-11-01 15:53:32,"> @prayank23 If an attacker manages to make you invoke bitcoind with chosen configuration, you have bigger problems (it means they have filesystem access, can see your wallet files, can give themselves RPC access, ...).\n\n@sipa Yes victim will have bigger problems depending on the case. Are we helping attackers with this feature? \n\nExample:\n\nAttacker: We have a new airdrop where you don",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-956353035,956353035,
MarcoFalke,2021-11-01 15:58:02,"@prayank23 This is a known and obvious issue with all `-*notify` options, unrelated to this pull request. It might be best to discuss this in another thread.",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-956356904,956356904,
MarcoFalke,2021-11-01 16:13:23,"> Motivation: This will allow users to notify themselves when bitcoind unexpectedly shuts down.\n\nCan you explain this a bit more? The current code will notify users after Bitcoin Core *expectedly* shuts down, that is, after telling it to shutdown.\n\nIf users want to find out if it *unexpectedly* shut down, they will need to check for the absence of the notification and verify that the proce",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-956371525,956371525,
sipa,2021-11-01 16:15:25,"There is probably a difference still between *unexpected* shutdowns and *unclean* shutdowns. E.g. when disk is full, Bitcoin Core will (possibly) shut down cleanly, but it's not explicitly requested by the user.",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-956373412,956373412,
klementtan,2021-11-01 19:03:37,"> Can you explain this a bit more?\n\n@MarcoFalke yup similar to what @sipa pointed out, this would be useful for users who wish to be notified when Bitcoin Core cleanly shuts down without being explicitly requested by the user. Updated the PR description to clearly describe what does *unexpected* means. ",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-956506097,956506097,
luke-jr,2021-11-02 17:07:28,"Concept ACK\n\nI think it is important to get #22417 merged first, though - otherwise `shutdownnotify` commands might all too easily keep files open that we expect to be closed.",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-957953168,957953168,
klementtan,2021-11-03 13:33:37," a13e4cf to  812910e  changes:\n* Run commands synchronously\n* Run commands before shutdown sequence begins\n* Support multiple `-shutdownnotify`\n",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-959088546,959088546,
theStack,2021-11-07 02:59:36,Concept ACK,https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-962543678,962543678,
laanwj,2021-11-08 12:23:51,"Not opposed to this but please don't mis-advertise it;\n\n> If users want to find out if it unexpectedly shut down, they will need to check for the absence of the notification and verify that the process is not running (e.g. writing state (utxo, wallet, ...) to the disk on shutdown).\n\nYes, there is no way to monitor for unexpected shutdowns from within bitcoind itself. This is theoretically ",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-963100179,963100179,
klementtan,2021-11-08 16:49:44,"> Yes, there is no way to monitor for unexpected shutdowns from within bitcoind itself.\n\n@laanwj thanks for the feedback and I totally agree with you. Updated the PR description to add a disclaimer that the command will not be executed if bitcoind unexpectedly shuts down. ",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-963357070,963357070,
klementtan,2021-11-10 20:09:53,"@theStack thanks a lot for helping with testing and spotting this issue!\n\nThe reason why it returns `503` is because we call [`Interrupt(...)`](https://github.com/bitcoin/bitcoin/blob/master/src/init.cpp#L159) before [`Shutdown`](https://github.com/bitcoin/bitcoin/blob/master/src/init.cpp#L178) causing all RPC calls in `shutdownnotify` to fail.\nhttps://github.com/bitcoin/bitcoin/blob/f63bf05",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-965705141,965705141,
klementtan,2021-11-16 14:27:16,"@prayank23 Thanks a lot for the feedback!\n\nWhile I agree that adding this option will give attackers an additional avenue to exploit newbies but IMO it does not make Bitcoin Core any less secure. \n\nAttackers can already utilize any existing `-*notify` option to perform the same attack thus adding this option does not make it less secure. Additionally, this PR simply adds an additional call",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-970326807,970326807,
prayank23,2021-11-16 17:09:31,"> Attackers can already utilize any existing -*notify option to perform the same attack thus adding this option does not make it less secure. \n\nIt provides more options. I have shared few in  https://github.com/bitcoin/bitcoin/issues/23412#issuecomment-970480769 under the section `Other ways to use these config params effectively`\n\n> Additionally, this PR simply adds an additional call to ",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-970481934,970481934,
sipa,2021-11-16 17:11:35,"@prayank23 The whole point of notifications is not needing polling. If polling is acceptable, the user can also just use RPCs to figure out if Bitcoin Core is or isn't running, so I don't see what a ""notifications.dat"" adds.",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-970483856,970483856,
prayank23,2021-11-16 17:31:39,I think it's possible to check a file for changes without polling: https://github.com/bitcoin/bitcoin/issues/23412#issuecomment-957502474,https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-970501847,970501847,
MarcoFalke,2021-11-16 17:43:58,"> I think it's possible to check a file for changes without polling: #23412 (comment)\n\nSo users that want to use notifications need to install a potentially backdoored third-party tool? Seems backward when the goal is to increase security.\n\nNow for the third time, I urge you to keep the *general* discussion about `runCommand` to #23412 and not this pull request.\n\n> Provides more option",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-970512238,970512238,
prayank23,2021-11-16 18:06:35,"> Now for the third time, I urge you to keep the general discussion about runCommand to #23412 and not this pull request.\n\nPlease check the above comment for context as it was a response. All things which aren't related to PR or can be kept separate are in issue https://github.com/bitcoin/bitcoin/issues/23412\n\n> The issue isn't ignored, it is well known that those local configuration optio",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-970530105,970530105,
michaelfolkson,2021-11-16 18:18:46,@prayank23: Your Approach NACK with your rationale has been registered. If you have further questions or discussion points please take them elsewhere (IRC etc). You have to let other reviewers review the PR and make their own mind up.,https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-970539711,970539711,
prayank23,2021-11-16 18:26:07,"@michaelfolkson I wasn't aware we can't respond to comments like https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-970326807 in the same PR\n\nOr https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-970483856\n\nNone of these comments were an attempt to stop others from reviewing this PR. \n\nI won't comment further on this PR and will discuss elsewhere.",https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-970549874,970549874,
luke-jr,2021-11-02 17:08:55,Suggest using a loop over potentially multiple options as in #22372,https://github.com/bitcoin/bitcoin/pull/23395#discussion_r741301961,741301961,src/init.cpp
klementtan,2021-11-03 13:22:25,Done üëçüèª ,https://github.com/bitcoin/bitcoin/pull/23395#discussion_r741930540,741930540,src/init.cpp
luke-jr,2021-11-03 18:16:13,Needs updating,https://github.com/bitcoin/bitcoin/pull/23395#discussion_r742214334,742214334,doc/release-notes.md
luke-jr,2021-11-03 18:17:15,"Probably should start all the commands, *then* wait on them. (If a user wants a sequence of commands to run synchronously, he can just specify them as a single `-shutdownnotify` or use a shell script.)",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r742215098,742215098,src/init.cpp
luke-jr,2021-11-03 18:18:46,"```suggestion\n    argsman.AddArg(""-shutdownnotify=<cmd>"", ""Execute command immediately before beginning shutdown. The need for shutdown may be urgent, so be careful not to delay it long (if the command doesn't require interaction with the server, consider having it fork into the background)."", ArgsManager::ALLOW_ANY, OptionsCategory::OPTIONS);\n```\n\nOr maybe something shorter?",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r742216204,742216204,src/init.cpp
klementtan,2021-11-06 10:21:34,Done üëçüèª ,https://github.com/bitcoin/bitcoin/pull/23395#discussion_r744108916,744108916,doc/release-notes.md
klementtan,2021-11-06 10:23:56,"Agreed, updated to start all commands then join on all of them afterward",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r744109218,744109218,src/init.cpp
klementtan,2021-11-06 10:26:39,Thanks! Updated to use your wording instead üëçüèª ,https://github.com/bitcoin/bitcoin/pull/23395#discussion_r744109434,744109434,src/init.cpp
theStack,2021-11-07 17:55:08,"nit: put in braces to match our coding guidelines (or alternatively, all on a single line)\n```suggestion\n    for (auto& t : threads) {\n        t.join();\n    }\n```",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r744293568,744293568,src/init.cpp
theStack,2021-11-07 18:11:10,"```suggestion\n- The `shutdownnotify` option is used to specify a command to execute synchronously\n  before Bitcoin Core begins its shutdown sequence. (#23395)\n```",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r744295494,744295494,doc/release-notes.md
klementtan,2021-11-08 00:03:51,Done üëçüèª ,https://github.com/bitcoin/bitcoin/pull/23395#discussion_r744338502,744338502,src/init.cpp
klementtan,2021-11-08 00:04:03,Done üëçüèª ,https://github.com/bitcoin/bitcoin/pull/23395#discussion_r744338532,744338532,doc/release-notes.md
prayank23,2021-11-11 09:04:10,"```suggestion\n\nNote: Restrict scripts and commands in the shell/system used for bitcoind to avoid running potentially unsafe scripts using `shutdownnotify`\n\n```\n\nContext: https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-956356904\nMore info: https://github.com/bitcoin/bitcoin/issues/23412",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r747319588,747319588,doc/release-notes.md
prayank23,2021-11-11 09:07:14,Is it possible to Restrict `runCommand` so that it will use only local resources and network?,https://github.com/bitcoin/bitcoin/pull/23395#discussion_r747321697,747321697,src/init.cpp
klementtan,2021-11-11 12:39:49,Would it be better to add this to the end of all `-*notify`'s help option since this *note* applies to all of them?,https://github.com/bitcoin/bitcoin/pull/23395#discussion_r747465714,747465714,doc/release-notes.md
klementtan,2021-11-11 13:00:50,"Do you mean we should restrict all shell commands to only interact with localhost (ie do not allow curl calls to any external hosts)? Apart from performing some sort of validation on the string provided for the option, I am unaware of any technique to enforce this. Do you have any suggestions? ",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r747479599,747479599,src/init.cpp
MarcoFalke,2021-11-11 13:19:57,"As I mentioned earlier, this is unrelated to this pull and might be best discussed in another issue/pull for *all* notify commands. https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-956356904",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r747492659,747492659,src/init.cpp
prayank23,2021-11-11 13:20:12,"Maybe. Not sure. Or we can add in both places. I tried to share few alternatives but if none of them look good, we should at least document related security recommendations.",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r747492863,747492863,doc/release-notes.md
prayank23,2021-11-11 13:22:14,Yes because attackers can't do much if requests only work for localhost. I will ask in few subreddits and see if there are any ways to achieve this.,https://github.com/bitcoin/bitcoin/pull/23395#discussion_r747494328,747494328,src/init.cpp
MarcoFalke,2021-11-11 13:23:06,"The release notes are not the right place to put extended documentation in any case. The RPC docs, the manpage, or the docs folder are more appropriate. Also: https://github.com/bitcoin/bitcoin/pull/23395#issuecomment-956356904",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r747494960,747494960,doc/release-notes.md
prayank23,2021-11-11 13:26:03,"It is related because if something was missed in other options previously we can try to make this secure and follow the same for others.\n\nAnd I have created an issue with all details.",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r747497080,747497080,src/init.cpp
klementtan,2021-11-11 13:26:16,"@MarcoFalke agreed, will move the conversation to #23412 ",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r747497238,747497238,src/init.cpp
prayank23,2021-11-11 13:29:39,"I don't mind documenting it in other places. I don't think sharing a security recommendation related to new config parameter will affect anything. It can only be helpful.\n\nI have created an issue for other details and alternatives to solve this problem. I think I can suggest changes in release notes which are part of this pull request.",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r747499702,747499702,doc/release-notes.md
MarcoFalke,2021-11-11 13:34:43,"> It can only be helpful.\n\nA new user downloading 29.0 won't read the release notes of 23.0 (a long EOL release at that time), so putting security documentation there won't be helpful. Also, it will bloat the release notes, making it distracting to read for users that are interested in changes. So I think wrong documentation or even right documentation in the wrong place *can* be harmful.",https://github.com/bitcoin/bitcoin/pull/23395#discussion_r747503374,747503374,doc/release-notes.md
