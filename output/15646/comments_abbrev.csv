DrahtBot,2019-03-22T20:15:25Z,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* [#15632](https://drahtbot.github.io/bitcoin_core_issue_redirect/r/15632.html) (Remove ResendWalletTransactions from the Va",https://github.com/bitcoin/bitcoin/pull/15646#issuecomment-475765956,475765956,
jonatack,2019-03-23T11:45:17Z,"I'm seeing this locally on x86_64 Linux Debian 4.19.16-1 (2019-01-17):\n\n```\n$ test/functional/test_runner.py wallet_resendwallettransactions.py\nTemporary test directory at /tmp/test_runner_₿_🏃_20190323_124023\nRemaining jobs: [wallet_resendwallettransactions.py]\n..........................................................................................................                    ",https://github.com/bitcoin/bitcoin/pull/15646#issuecomment-475862992,475862992,
jonatack,2019-03-23T13:53:03Z,"If helpful, this version of the test passes for me locally: https://github.com/jonatack/bitcoin/commit/0608a16. Main change is the last `setmocktime` value. I'm unsure if more time invalidates the test but it appears to become unreliable with lower values:\n\n```python\n    # Transaction should be broadcast after 30 minutes. Give it ~60 (31 + 29) to be sure.\n    node.setmocktime(time_now + 60",https://github.com/bitcoin/bitcoin/pull/15646#issuecomment-475871535,475871535,
jnewbery,2019-03-26T15:20:09Z,"Thanks for the review @jonatack and @promag . I've pushed a fixup commit that:\n\n- fixes a bug in the way we were storing txids in `P2PStoreTxInvs` (it was previously storing as hex and would drop leading zeros, which meant it wouldn't match with the txid in the case where the txid had a leading zero.\n- changes the mocktimes slightly\n- adds logging\n- a few other small changes.\n\nIt sho",https://github.com/bitcoin/bitcoin/pull/15646#issuecomment-476698728,476698728,
practicalswift,2019-03-26T15:58:23Z,Concept ACK,https://github.com/bitcoin/bitcoin/pull/15646#issuecomment-476718009,476718009,
MarcoFalke,2019-03-26T18:05:02Z,"@practicalswift No need to ""Concept ACK"" someone adding tests. This is already encouraged by the contribution guidelines and adding a comment adds no value. It would help if you ran the test or gave feedback about the code, however.",https://github.com/bitcoin/bitcoin/pull/15646#issuecomment-476777342,476777342,
MarcoFalke,2019-03-26T18:12:18Z,"Should be squashed to make ready for review. Also, would be good to explain why `resendwalletransactions` is no longer (smoke) tested. E.g: ""It is called in other tests already""",https://github.com/bitcoin/bitcoin/pull/15646#issuecomment-476780410,476780410,
jnewbery,2019-03-26T19:31:55Z,"Commits squashed. I've also made a small update to the commit log to make it clearer that this commit fixes the deficiencies with the previous test. \n\n> would be good to explain why resendwalletransactions is no longer (smoke) tested\n\nI intend to remove the `resendwallettransactions` RPC method in a follow-up PR. It was added as a hidden, test-only RPC to test wallet transaction rebroadcas",https://github.com/bitcoin/bitcoin/pull/15646#issuecomment-476812835,476812835,
MarcoFalke,2019-03-27T13:45:35Z,utACK c1a96f0f339987d48cdaba75e628030cbf6391b8,https://github.com/bitcoin/bitcoin/pull/15646#issuecomment-477161584,477161584,
jnewbery,2019-03-27T15:24:08Z,"Thanks for the review/test @jonatack . I've changed the log messages, but kept the time variables as they were.",https://github.com/bitcoin/bitcoin/pull/15646#issuecomment-477207357,477207357,
MarcoFalke,2019-03-27T18:31:04Z,"re-utACK 529c1ae4a0\n\nOnly change is punctuation ",https://github.com/bitcoin/bitcoin/pull/15646#issuecomment-477294532,477294532,
MarcoFalke,2019-04-01T19:47:33Z,This will be backported to 0.18.0rc3,https://github.com/bitcoin/bitcoin/pull/15646#issuecomment-478719861,478719861,
laanwj,2019-04-02T12:01:20Z,"> I intend to remove the resendwallettransactions RPC method in a follow-up PR. \n\nConcept ACK on this, I think it can be useful to send individual transactions, but this can be done by getting the transaction hex from `getwallettransaction` then `sendrawtransaction`, this RPC seems to be redundant.",https://github.com/bitcoin/bitcoin/pull/15646#issuecomment-478964816,478964816,
jonatack,2019-03-23T12:35:25Z,"Suggestion: `self.nodes[0]` could be assigned at the start of the test to a local variable like `node` for readability, since it is called 14 times in `run_test`.",https://github.com/bitcoin/bitcoin/pull/15646#discussion_r268393179,268393179,test/functional/wallet_resendwallettransactions.py
promag,2019-03-24T02:56:36Z,FWIW I prefer `self.nodes[0]` 14 times or move the new test to a function with the `node` arg.,https://github.com/bitcoin/bitcoin/pull/15646#discussion_r268416581,268416581,test/functional/wallet_resendwallettransactions.py
jnewbery,2019-03-26T15:18:00Z,Seems reasonable. Using `node` as a local alias for `self.nodes[0]` in tests where there's only one node is a common technique in our tests. I'll add this.,https://github.com/bitcoin/bitcoin/pull/15646#discussion_r269159137,269159137,test/functional/wallet_resendwallettransactions.py
ryanofsky,2019-03-26T18:33:34Z,"In commit ""[tests] Add test for wallet rebroadcasts"" (f2faae27895927bb8fefca3d066bf8972e3bdaa7)\n\nIt would be nice to move some of the comments from your commit message into the test itself to convey what the test currently covers and how it can be improved in the future (""It does not test whether transactions are actually rebroadcast, or whether the rebroadcast logic is called on a timer"").",https://github.com/bitcoin/bitcoin/pull/15646#discussion_r269257327,269257327,test/functional/wallet_resendwallettransactions.py
jnewbery,2019-03-26T18:44:33Z,I think you've misunderstood the commit message. I'm saying the test _before_ this commit doesn't test whether txs are actually rebroadcast or whether rebroadcast logic is called on a timer. The commit in this PR fixes that.,https://github.com/bitcoin/bitcoin/pull/15646#discussion_r269261687,269261687,test/functional/wallet_resendwallettransactions.py
ryanofsky,2019-03-26T19:06:29Z,"> I think you've misunderstood the commit message\n\nOh, yes I did misunderstand. I thought it was saying the test didn't check whether transactions were rebroadcast on an ongoing basis. Anyway, no need to change anything.",https://github.com/bitcoin/bitcoin/pull/15646#discussion_r269270202,269270202,test/functional/wallet_resendwallettransactions.py
jonatack,2019-03-26T21:07:28Z,Was using the same value for `node.setmocktime` and the block time in `create_block` a key fix? Good catch.,https://github.com/bitcoin/bitcoin/pull/15646#discussion_r269315872,269315872,test/functional/wallet_resendwallettransactions.py
jonatack,2019-03-26T21:17:09Z,"Just an idea: It might be nice to hoist all the local variables for the test setup together at the top, or in a setup function, to see the setup as a whole. Doing this also made it more apparent that we can potentially reduce the number of system time calls.\n```python\n        node = self.nodes[0]  # alias\n        block_time = int(time.time()) + 6 * 60\n        rebroadcast_time = block_time ",https://github.com/bitcoin/bitcoin/pull/15646#discussion_r269319333,269319333,test/functional/wallet_resendwallettransactions.py
jonatack,2019-03-26T21:20:19Z,"The logs are a great enhancement:\n```\n$ test/functional/wallet_resendwallettransactions.py \n2019-03-26T21:05:37.079000Z TestFramework (INFO): Initializing test directory /tmp/bitcoin_func_test_eb5_rvg_\n2019-03-26T21:05:37.874000Z TestFramework (INFO): Create a new transaction and wait until it's broadcast.\n2019-03-26T21:05:38.807000Z TestFramework (INFO): Create a block.\n2019-03-26T21:",https://github.com/bitcoin/bitcoin/pull/15646#discussion_r269320447,269320447,test/functional/wallet_resendwallettransactions.py
jonatack,2019-03-26T21:29:17Z,"I tried this locally as above, simplified to one single call to `int(time.time())` and 31 minutes for rebroadcast instead of 35, and the test appears equally robust this way since an extra minute is given for the block.\n\nEdit: I initially thought that defining `rebroadcast_time` relative to `block_time`, rather than the current time, might be a more rigorous test of CWallet::ResendWalletTransa",https://github.com/bitcoin/bitcoin/pull/15646#discussion_r269323539,269323539,test/functional/wallet_resendwallettransactions.py
jnewbery,2019-03-27T15:02:50Z,"Yes, sometimes the block was being rejected because of the bad timestamp. The node logs were pretty helpful in identifying the problem.",https://github.com/bitcoin/bitcoin/pull/15646#discussion_r269609728,269609728,test/functional/wallet_resendwallettransactions.py
jnewbery,2019-03-27T15:15:56Z,"> It might be nice to hoist all the local variables for the test setup together at the top\n\nGenerally we declare variables at the point of first use (both in the C++ and Python code). You could argue that these are more like constants so declaring them at the top makes sense. I don't have a strong feeling either way, so I'll leave it as is.",https://github.com/bitcoin/bitcoin/pull/15646#discussion_r269616866,269616866,test/functional/wallet_resendwallettransactions.py
jnewbery,2019-03-27T15:19:14Z,fixed!,https://github.com/bitcoin/bitcoin/pull/15646#discussion_r269618586,269618586,test/functional/wallet_resendwallettransactions.py
