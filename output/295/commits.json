[
  {
    "sha": "5d0ef156f132753a6977255eb78811ec36fb23a8",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1ZDBlZjE1NmYxMzI3NTNhNjk3NzI1NWViNzg4MTFlYzM2ZmIyM2E4",
    "commit": {
      "author": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2011-06-04T01:18:29Z"
      },
      "committer": {
        "name": "Pieter Wuille",
        "email": "pieter.wuille@gmail.com",
        "date": "2011-06-04T01:18:29Z"
      },
      "message": "Allow generations to be assigned to accounts",
      "tree": {
        "sha": "40682aff77fba019f1c5b153593cdd134ac3985b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/40682aff77fba019f1c5b153593cdd134ac3985b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/5d0ef156f132753a6977255eb78811ec36fb23a8",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5d0ef156f132753a6977255eb78811ec36fb23a8",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/5d0ef156f132753a6977255eb78811ec36fb23a8",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/5d0ef156f132753a6977255eb78811ec36fb23a8/comments",
    "author": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "sipa",
      "id": 548488,
      "node_id": "MDQ6VXNlcjU0ODQ4OA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/sipa",
      "html_url": "https://github.com/sipa",
      "followers_url": "https://api.github.com/users/sipa/followers",
      "following_url": "https://api.github.com/users/sipa/following{/other_user}",
      "gists_url": "https://api.github.com/users/sipa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/sipa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
      "organizations_url": "https://api.github.com/users/sipa/orgs",
      "repos_url": "https://api.github.com/users/sipa/repos",
      "events_url": "https://api.github.com/users/sipa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/sipa/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e104c7937455bf2c9b535ec14ea710a97b66750b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e104c7937455bf2c9b535ec14ea710a97b66750b",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e104c7937455bf2c9b535ec14ea710a97b66750b"
      }
    ],
    "stats": {
      "total": 56,
      "additions": 41,
      "deletions": 15
    },
    "files": [
      {
        "sha": "f4485f72e9eeef731af8c00d0ef5988f40d63c97",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 22,
        "deletions": 5,
        "changes": 27,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5d0ef156f132753a6977255eb78811ec36fb23a8/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5d0ef156f132753a6977255eb78811ec36fb23a8/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=5d0ef156f132753a6977255eb78811ec36fb23a8",
        "patch": "@@ -397,7 +397,7 @@ int CWalletTx::GetRequestCount() const\n     return nRequests;\n }\n \n-void CWalletTx::GetAmounts(int64& nGeneratedImmature, int64& nGeneratedMature, list<pair<string, int64> >& listReceived,\n+void CWalletTx::GetAmounts(int64& nGeneratedImmature, int64& nGeneratedMature, string& strGenerateAddress, list<pair<string, int64> >& listReceived,\n                            list<pair<string, int64> >& listSent, int64& nFee, string& strSentAccount) const\n {\n     nGeneratedImmature = nGeneratedMature = nFee = 0;\n@@ -407,6 +407,20 @@ void CWalletTx::GetAmounts(int64& nGeneratedImmature, int64& nGeneratedMature, l\n \n     if (IsCoinBase())\n     {\n+        string address;\n+        uint160 hash160;\n+        vector<unsigned char> vchPubKey;\n+        if (ExtractHash160(vout[0].scriptPubKey, hash160))\n+            address = Hash160ToAddress(hash160);\n+        else if (ExtractPubKey(vout[0].scriptPubKey, false, vchPubKey))\n+            address = PubKeyToAddress(vchPubKey);\n+        else\n+        {\n+            printf(\"CWalletTx::GetAmounts: Unknown generating transaction type found, txid %s\\n\",\n+                   this->GetHash().ToString().c_str());\n+            address = \" unknown \";\n+        }\n+        strGenerateAddress = address;\n         if (GetBlocksToMaturity() > 0)\n             nGeneratedImmature = CTransaction::GetCredit();\n         else\n@@ -460,13 +474,12 @@ void CWalletTx::GetAccountAmounts(const string& strAccount, int64& nGenerated, i\n \n     int64 allGeneratedImmature, allGeneratedMature, allFee;\n     allGeneratedImmature = allGeneratedMature = allFee = 0;\n-    string strSentAccount;\n+    string strSentAccount, strGenerateAddress;\n     list<pair<string, int64> > listReceived;\n     list<pair<string, int64> > listSent;\n-    GetAmounts(allGeneratedImmature, allGeneratedMature, listReceived, listSent, allFee, strSentAccount);\n+    GetAmounts(allGeneratedImmature, allGeneratedMature, strGenerateAddress, listReceived, listSent, allFee, strSentAccount);\n+    string strGenerateAccount;\n \n-    if (strAccount == \"\")\n-        nGenerated = allGeneratedMature;\n     if (strAccount == strSentAccount)\n     {\n         BOOST_FOREACH(const PAIRTYPE(string,int64)& s, listSent)\n@@ -489,7 +502,11 @@ void CWalletTx::GetAccountAmounts(const string& strAccount, int64& nGenerated, i\n                 nReceived += r.second;\n             }\n         }\n+        if (mapAddressBook.count(strGenerateAddress))\n+            strGenerateAccount = mapAddressBook[strGenerateAddress];\n     }\n+    if (strAccount == strGenerateAccount)\n+        nGenerated = allGeneratedMature;\n }\n \n "
      },
      {
        "sha": "879ae9696fb3c8572c546cc173c86325aa514b0e",
        "filename": "src/main.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5d0ef156f132753a6977255eb78811ec36fb23a8/src/main.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5d0ef156f132753a6977255eb78811ec36fb23a8/src/main.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.h?ref=5d0ef156f132753a6977255eb78811ec36fb23a8",
        "patch": "@@ -1008,7 +1008,7 @@ class CWalletTx : public CMerkleTx\n         return nChangeCached;\n     }\n \n-    void GetAmounts(int64& nGeneratedImmature, int64& nGeneratedMature, std::list<std::pair<std::string /* address */, int64> >& listReceived,\n+    void GetAmounts(int64& nGeneratedImmature, int64& nGeneratedMature, std::string& strGenerateAddress, std::list<std::pair<std::string /* address */, int64> >& listReceived,\n                     std::list<std::pair<std::string /* address */, int64> >& listSent, int64& nFee, std::string& strSentAccount) const;\n \n     void GetAccountAmounts(const std::string& strAccount, int64& nGenerated, int64& nReceived,"
      },
      {
        "sha": "c91aa66d9566ca195983a48e1ef0081532497b8c",
        "filename": "src/rpc.cpp",
        "status": "modified",
        "additions": 18,
        "deletions": 9,
        "changes": 27,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/5d0ef156f132753a6977255eb78811ec36fb23a8/src/rpc.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/5d0ef156f132753a6977255eb78811ec36fb23a8/src/rpc.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc.cpp?ref=5d0ef156f132753a6977255eb78811ec36fb23a8",
        "patch": "@@ -689,10 +689,10 @@ Value getbalance(const Array& params, bool fHelp)\n \n             int64 allGeneratedImmature, allGeneratedMature, allFee;\n             allGeneratedImmature = allGeneratedMature = allFee = 0;\n-            string strSentAccount;\n+            string strSentAccount, strGenerateAddress;\n             list<pair<string, int64> > listReceived;\n             list<pair<string, int64> > listSent;\n-            wtx.GetAmounts(allGeneratedImmature, allGeneratedMature, listReceived, listSent, allFee, strSentAccount);\n+            wtx.GetAmounts(allGeneratedImmature, allGeneratedMature, strGenerateAddress, listReceived, listSent, allFee, strSentAccount);\n             if (wtx.GetDepthInMainChain() >= nMinDepth)\n                 BOOST_FOREACH(const PAIRTYPE(string,int64)& r, listReceived)\n                     nBalance += r.second;\n@@ -1010,18 +1010,24 @@ Value listreceivedbyaccount(const Array& params, bool fHelp)\n void ListTransactions(const CWalletTx& wtx, const string& strAccount, int nMinDepth, bool fLong, Array& ret)\n {\n     int64 nGeneratedImmature, nGeneratedMature, nFee;\n-    string strSentAccount;\n+    string strSentAccount, strGenerateAddress;\n     list<pair<string, int64> > listReceived;\n     list<pair<string, int64> > listSent;\n-    wtx.GetAmounts(nGeneratedImmature, nGeneratedMature, listReceived, listSent, nFee, strSentAccount);\n+    wtx.GetAmounts(nGeneratedImmature, nGeneratedMature, strGenerateAddress, listReceived, listSent, nFee, strSentAccount);\n+    string strGenerateAccount;\n+    CRITICAL_BLOCK(cs_mapAddressBook)\n+    {\n+        if (mapAddressBook.count(strGenerateAddress))\n+            strGenerateAccount = mapAddressBook[strGenerateAddress];\n+    }\n \n     bool fAllAccounts = (strAccount == string(\"*\"));\n \n     // Generated blocks assigned to account \"\"\n-    if ((nGeneratedMature+nGeneratedImmature) != 0 && (fAllAccounts || strAccount == \"\"))\n+    if ((nGeneratedMature+nGeneratedImmature) != 0 && (fAllAccounts || strAccount == strGenerateAccount))\n     {\n         Object entry;\n-        entry.push_back(Pair(\"account\", string(\"\")));\n+        entry.push_back(Pair(\"account\", strGenerateAccount));\n         if (nGeneratedImmature)\n         {\n             entry.push_back(Pair(\"category\", wtx.GetDepthInMainChain() ? \"immature\" : \"orphan\"));\n@@ -1188,16 +1194,19 @@ Value listaccounts(const Array& params, bool fHelp)\n         {\n             const CWalletTx& wtx = (*it).second;\n             int64 nGeneratedImmature, nGeneratedMature, nFee;\n-            string strSentAccount;\n+            string strSentAccount, strGenerateAddress;\n             list<pair<string, int64> > listReceived;\n             list<pair<string, int64> > listSent;\n-            wtx.GetAmounts(nGeneratedImmature, nGeneratedMature, listReceived, listSent, nFee, strSentAccount);\n+            wtx.GetAmounts(nGeneratedImmature, nGeneratedMature, strGenerateAddress, listReceived, listSent, nFee, strSentAccount);\n+            string strGenerateAccount;\n+            if (mapAddressBook.count(strGenerateAddress))\n+                strGenerateAccount = mapAddressBook[strGenerateAddress];\n             mapAccountBalances[strSentAccount] -= nFee;\n             BOOST_FOREACH(const PAIRTYPE(string, int64)& s, listSent)\n                 mapAccountBalances[strSentAccount] -= s.second;\n             if (wtx.GetDepthInMainChain() >= nMinDepth)\n             {\n-                mapAccountBalances[\"\"] += nGeneratedMature;\n+                mapAccountBalances[strGenerateAccount] += nGeneratedMature;\n                 BOOST_FOREACH(const PAIRTYPE(string, int64)& r, listReceived)\n                     if (mapAddressBook.count(r.first))\n                         mapAccountBalances[mapAddressBook[r.first]] += r.second;"
      }
    ]
  }
]