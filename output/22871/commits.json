[
  {
    "sha": "1bd2b15d82ebc80b3c30ab247287717a893cb37a",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxYmQyYjE1ZDgyZWJjODBiM2MzMGFiMjQ3Mjg3NzE3YTg5M2NiMzdh",
    "commit": {
      "author": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-09-03T00:17:57Z"
      },
      "committer": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-09-04T22:18:49Z"
      },
      "message": "Discourage CSV as NOP when locktime disable is set",
      "tree": {
        "sha": "62781739875d1db4388c37e79cf5ed771ef15249",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/62781739875d1db4388c37e79cf5ed771ef15249"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/1bd2b15d82ebc80b3c30ab247287717a893cb37a",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1bd2b15d82ebc80b3c30ab247287717a893cb37a",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/1bd2b15d82ebc80b3c30ab247287717a893cb37a",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1bd2b15d82ebc80b3c30ab247287717a893cb37a/comments",
    "author": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "77e77e8544c7df5981da9795cda5f1aaa99f73af",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/77e77e8544c7df5981da9795cda5f1aaa99f73af",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/77e77e8544c7df5981da9795cda5f1aaa99f73af"
      }
    ],
    "stats": {
      "total": 21,
      "additions": 20,
      "deletions": 1
    },
    "files": [
      {
        "sha": "3872c9d5916d26b0956d0ed483bf5377dfdd07e6",
        "filename": "src/script/interpreter.cpp",
        "status": "modified",
        "additions": 20,
        "deletions": 1,
        "changes": 21,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/1bd2b15d82ebc80b3c30ab247287717a893cb37a/src/script/interpreter.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/1bd2b15d82ebc80b3c30ab247287717a893cb37a/src/script/interpreter.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/script/interpreter.cpp?ref=1bd2b15d82ebc80b3c30ab247287717a893cb37a",
        "patch": "@@ -606,10 +606,29 @@ bool EvalScript(std::vector<std::vector<unsigned char> >& stack, const CScript&\n                     // To provide for future soft-fork extensibility, if the\n                     // operand has the disabled lock-time flag set,\n                     // CHECKSEQUENCEVERIFY behaves as a NOP.\n-                    if ((nSequence & CTxIn::SEQUENCE_LOCKTIME_DISABLE_FLAG) != 0)\n+                    // This also covers CTxIn::SEQUENCE_FINAL since all bits are\n+                    // set in that case.\n+                    if ((nSequence & CTxIn::SEQUENCE_LOCKTIME_DISABLE_FLAG) != 0) {\n+                        // CHECKSEQUENCEVERIFY behaving as NOP, set error appropriately\n+                        if (flags & SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_NOPS)\n+                            return set_error(serror, SCRIPT_ERR_DISCOURAGE_UPGRADABLE_NOPS);\n                         break;\n+                    }\n+\n+                    // Only when discouraging un-upgraded semantics,\n+                    // If uninterpreted fields are set, treat and reject as a NOP.\n+                    if (flags & SCRIPT_VERIFY_DISCOURAGE_UPGRADABLE_NOPS &&\n+                        (nSequence & ~(CTxIn::SEQUENCE_LOCKTIME_TYPE_FLAG | CTxIn::SEQUENCE_LOCKTIME_MASK)) != 0) {\n+                        // CHECKSEQUENCEVERIFY behaving as NOP, set error appropriately\n+                        return set_error(serror, SCRIPT_ERR_DISCOURAGE_UPGRADABLE_NOPS);\n+                    }\n \n                     // Compare the specified sequence number with the input.\n+                    // nSequence here will be masked to the lower 16 bits and\n+                    // type flag, but may have bits set in range 1<<16 to 1<<21\n+                    // and 1<<23 to 1<<30 inclusive that will be ignored for\n+                    // consensus but may be rejected by the standardness rule\n+                    // above.  bit 31 is expected to not be set.\n                     if (!checker.CheckSequence(nSequence))\n                         return set_error(serror, SCRIPT_ERR_UNSATISFIED_LOCKTIME);\n "
      }
    ]
  },
  {
    "sha": "825fa06812d9627fb4e39f561a3fdb2ddb22b4a3",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo4MjVmYTA2ODEyZDk2MjdmYjRlMzlmNTYxYTNmZGIyZGRiMjJiNGEz",
    "commit": {
      "author": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-09-04T15:58:35Z"
      },
      "committer": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-09-05T02:24:16Z"
      },
      "message": "Add a policy to reject unknown sequences.",
      "tree": {
        "sha": "f211a984f18e97985c995456e08a75d67954579e",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f211a984f18e97985c995456e08a75d67954579e"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/825fa06812d9627fb4e39f561a3fdb2ddb22b4a3",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/825fa06812d9627fb4e39f561a3fdb2ddb22b4a3",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/825fa06812d9627fb4e39f561a3fdb2ddb22b4a3",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/825fa06812d9627fb4e39f561a3fdb2ddb22b4a3/comments",
    "author": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "1bd2b15d82ebc80b3c30ab247287717a893cb37a",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/1bd2b15d82ebc80b3c30ab247287717a893cb37a",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/1bd2b15d82ebc80b3c30ab247287717a893cb37a"
      }
    ],
    "stats": {
      "total": 17,
      "additions": 17,
      "deletions": 0
    },
    "files": [
      {
        "sha": "4e9f14310bb98d87203cf6ab168949b6f389a02a",
        "filename": "src/policy/policy.cpp",
        "status": "modified",
        "additions": 17,
        "deletions": 0,
        "changes": 17,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/825fa06812d9627fb4e39f561a3fdb2ddb22b4a3/src/policy/policy.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/825fa06812d9627fb4e39f561a3fdb2ddb22b4a3/src/policy/policy.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/policy/policy.cpp?ref=825fa06812d9627fb4e39f561a3fdb2ddb22b4a3",
        "patch": "@@ -108,6 +108,23 @@ bool IsStandardTx(const CTransaction& tx, bool permit_bare_multisig, const CFeeR\n             reason = \"scriptsig-not-pushonly\";\n             return false;\n         }\n+\n+        // Check that if we are setting an uninterpreted sequence value\n+        // that we do not treat it as standard as new rules may apply\n+        // in the future due to an upgrade, so we prefer not to treat\n+        // such inputs as standard.\n+        const bool seq_is_reserved = (txin.nSequence < CTxIn::SEQUENCE_FINAL-2) && (\n+        // when sequence is set to disabled, it is reserved for future use\n+        ((txin.nSequence & CTxIn::SEQUENCE_LOCKTIME_DISABLE_FLAG) != 0) ||\n+        // when sequence has bits set outside of the type flag and locktime mask,\n+        // it is reserved for future use.\n+        ((~(CTxIn::SEQUENCE_LOCKTIME_TYPE_FLAG | CTxIn::SEQUENCE_LOCKTIME_MASK) &\n+                txin.nSequence) != 0)\n+        );\n+        if (seq_is_reserved) {\n+            reason = \"sequence-flags-reserved\";\n+            return false;\n+        }\n     }\n \n     unsigned int nDataOut = 0;"
      }
    ]
  },
  {
    "sha": "e5b2a824147c342bfbf2c8b1696afc686c2bfda7",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplNWIyYTgyNDE0N2MzNDJiZmJmMmM4YjE2OTZhZmM2ODZjMmJmZGE3",
    "commit": {
      "author": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-09-05T00:05:49Z"
      },
      "committer": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-09-05T02:24:17Z"
      },
      "message": "[Tests] Fix tx_valid.json to properly account for discourage rules",
      "tree": {
        "sha": "16ed8aac4e9b86ab9877fae0fa2f93658277a029",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/16ed8aac4e9b86ab9877fae0fa2f93658277a029"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e5b2a824147c342bfbf2c8b1696afc686c2bfda7",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e5b2a824147c342bfbf2c8b1696afc686c2bfda7",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e5b2a824147c342bfbf2c8b1696afc686c2bfda7",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e5b2a824147c342bfbf2c8b1696afc686c2bfda7/comments",
    "author": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "825fa06812d9627fb4e39f561a3fdb2ddb22b4a3",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/825fa06812d9627fb4e39f561a3fdb2ddb22b4a3",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/825fa06812d9627fb4e39f561a3fdb2ddb22b4a3"
      }
    ],
    "stats": {
      "total": 36,
      "additions": 18,
      "deletions": 18
    },
    "files": [
      {
        "sha": "79a560ac07391411aaf35c39b70235bc44efa8a2",
        "filename": "src/test/data/tx_valid.json",
        "status": "modified",
        "additions": 18,
        "deletions": 18,
        "changes": 36,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e5b2a824147c342bfbf2c8b1696afc686c2bfda7/src/test/data/tx_valid.json",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e5b2a824147c342bfbf2c8b1696afc686c2bfda7/src/test/data/tx_valid.json",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/data/tx_valid.json?ref=e5b2a824147c342bfbf2c8b1696afc686c2bfda7",
        "patch": "@@ -259,41 +259,41 @@\n \n [\"Upper sequence with upper sequence is fine\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"2147483648 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000000000800100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000000000800100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"4294967295 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000000000800100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000000000800100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"2147483648 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000feffffff0100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000feffffff0100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"4294967295 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000feffffff0100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000feffffff0100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"2147483648 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffffff0100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffffff0100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"4294967295 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffffff0100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffffff0100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n \n [\"Argument 2^31 with various nSequence\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"2147483648 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffbf7f0100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffbf7f0100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"2147483648 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffff7f0100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffff7f0100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"2147483648 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffffff0100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffffff0100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n \n [\"Argument 2^32-1 with various nSequence\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"4294967295 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffbf7f0100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffbf7f0100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"4294967295 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffff7f0100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffff7f0100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"4294967295 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffffff0100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffffff0100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n \n [\"Argument 3<<31 with various nSequence\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"0x050000008001 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffbf7f0100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffbf7f0100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"0x050000008001 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffff7f0100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffff7f0100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"0x050000008001 CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffffff0100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffffffff0100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n \n [\"5 byte non-minimally-encoded operandss are valid\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"0x05 0x0000000000 CHECKSEQUENCEVERIFY 1\"]],\n@@ -303,13 +303,13 @@\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"4194303 1ADD CHECKSEQUENCEVERIFY\"]],\n \"020000000100010000000000000000000000000000000000000000000000000000000000000000000000000040000100000000000000000000000000\", \"NONE\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"4194304 1SUB CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffff00000100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000ffff00000100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n \n [\"An ADD producing a 5-byte result that sets CTxIn::SEQUENCE_LOCKTIME_DISABLE_FLAG\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"2147483647 65536 ADD CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"2147483647 4259840 ADD CHECKSEQUENCEVERIFY\"]],\n-\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000000040000100000000000000000000000000\", \"NONE\"],\n+\"020000000100010000000000000000000000000000000000000000000000000000000000000000000000000040000100000000000000000000000000\", \"DISCOURAGE_UPGRADABLE_NOPS\"],\n \n [\"Valid CHECKSEQUENCEVERIFY in scriptSig\"],\n [[[\"0000000000000000000000000000000000000000000000000000000000000100\", 0, \"1\"]],"
      }
    ]
  },
  {
    "sha": "19557ee684a20281c68cc3b5a65a1b21b5c77f0c",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoxOTU1N2VlNjg0YTIwMjgxYzY4Y2MzYjVhNjVhMWIyMWI1Yzc3ZjBj",
    "commit": {
      "author": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-09-05T03:28:45Z"
      },
      "committer": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-09-05T06:26:58Z"
      },
      "message": "[TESTS] Patch Taproot test to use only standard sequences",
      "tree": {
        "sha": "272f465caa4aa7740e2eb6379532feaf0e72859b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/272f465caa4aa7740e2eb6379532feaf0e72859b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/19557ee684a20281c68cc3b5a65a1b21b5c77f0c",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/19557ee684a20281c68cc3b5a65a1b21b5c77f0c",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/19557ee684a20281c68cc3b5a65a1b21b5c77f0c",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/19557ee684a20281c68cc3b5a65a1b21b5c77f0c/comments",
    "author": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e5b2a824147c342bfbf2c8b1696afc686c2bfda7",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e5b2a824147c342bfbf2c8b1696afc686c2bfda7",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e5b2a824147c342bfbf2c8b1696afc686c2bfda7"
      }
    ],
    "stats": {
      "total": 3,
      "additions": 1,
      "deletions": 2
    },
    "files": [
      {
        "sha": "6137686440dd04a339d3772a4c2b24459801d1fb",
        "filename": "test/functional/feature_taproot.py",
        "status": "modified",
        "additions": 1,
        "deletions": 2,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/19557ee684a20281c68cc3b5a65a1b21b5c77f0c/test/functional/feature_taproot.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/19557ee684a20281c68cc3b5a65a1b21b5c77f0c/test/functional/feature_taproot.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/feature_taproot.py?ref=19557ee684a20281c68cc3b5a65a1b21b5c77f0c",
        "patch": "@@ -1351,7 +1351,6 @@ def test_spenders(self, node, spenders, input_counts):\n             # Construct CTransaction with random nVersion, nLocktime\n             tx = CTransaction()\n             tx.nVersion = random.choice([1, 2, random.randint(-0x80000000, 0x7fffffff)])\n-            min_sequence = (tx.nVersion != 1 and tx.nVersion != 0) * 0x80000000  # The minimum sequence number to disable relative locktime\n             if random.choice([True, False]):\n                 tx.nLockTime = random.randrange(LOCKTIME_THRESHOLD, self.lastblocktime - 7200)  # all absolute locktimes in the past\n             else:\n@@ -1389,7 +1388,7 @@ def test_spenders(self, node, spenders, input_counts):\n             amount = sum(utxo.output.nValue for utxo in input_utxos)\n             fee = min(random.randrange(MIN_FEE * 2, MIN_FEE * 4), amount - DUST_LIMIT)  # 10000-20000 sat fee\n             in_value = amount - fee\n-            tx.vin = [CTxIn(outpoint=utxo.outpoint, nSequence=random.randint(min_sequence, 0xffffffff)) for utxo in input_utxos]\n+            tx.vin = [CTxIn(outpoint=utxo.outpoint, nSequence=random.randint(0xffffffff-2, 0xffffffff)) for utxo in input_utxos]\n             tx.wit.vtxinwit = [CTxInWitness() for _ in range(len(input_utxos))]\n             sigops_weight = sum(utxo.spender.sigops_weight for utxo in input_utxos)\n             self.log.debug(\"Test: %s\" % (\", \".join(utxo.spender.comment for utxo in input_utxos)))"
      }
    ]
  },
  {
    "sha": "e8eab747192bd330e67bff1222bb851bc515b134",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplOGVhYjc0NzE5MmJkMzMwZTY3YmZmMTIyMmJiODUxYmM1MTViMTM0",
    "commit": {
      "author": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-09-06T10:25:35Z"
      },
      "committer": {
        "name": "Jeremy Rubin",
        "email": "j@rubin.io",
        "date": "2021-09-06T10:25:35Z"
      },
      "message": "Clean up handling of known txin.nSeqeunce types; add type for UNCHECKED_METADATA for Lightning BOLT-3 compatability",
      "tree": {
        "sha": "a84dc477f8c53f4328a9b5691695ceb3d5ca50eb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a84dc477f8c53f4328a9b5691695ceb3d5ca50eb"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e8eab747192bd330e67bff1222bb851bc515b134",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e8eab747192bd330e67bff1222bb851bc515b134",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e8eab747192bd330e67bff1222bb851bc515b134",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e8eab747192bd330e67bff1222bb851bc515b134/comments",
    "author": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "JeremyRubin",
      "id": 886523,
      "node_id": "MDQ6VXNlcjg4NjUyMw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/886523?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/JeremyRubin",
      "html_url": "https://github.com/JeremyRubin",
      "followers_url": "https://api.github.com/users/JeremyRubin/followers",
      "following_url": "https://api.github.com/users/JeremyRubin/following{/other_user}",
      "gists_url": "https://api.github.com/users/JeremyRubin/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/JeremyRubin/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/JeremyRubin/subscriptions",
      "organizations_url": "https://api.github.com/users/JeremyRubin/orgs",
      "repos_url": "https://api.github.com/users/JeremyRubin/repos",
      "events_url": "https://api.github.com/users/JeremyRubin/events{/privacy}",
      "received_events_url": "https://api.github.com/users/JeremyRubin/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "19557ee684a20281c68cc3b5a65a1b21b5c77f0c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/19557ee684a20281c68cc3b5a65a1b21b5c77f0c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/19557ee684a20281c68cc3b5a65a1b21b5c77f0c"
      }
    ],
    "stats": {
      "total": 71,
      "additions": 62,
      "deletions": 9
    },
    "files": [
      {
        "sha": "fa99d7859bf4ad5d76dd5918d1bd3b06efef8a0d",
        "filename": "src/policy/policy.cpp",
        "status": "modified",
        "additions": 37,
        "deletions": 9,
        "changes": 46,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e8eab747192bd330e67bff1222bb851bc515b134/src/policy/policy.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e8eab747192bd330e67bff1222bb851bc515b134/src/policy/policy.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/policy/policy.cpp?ref=e8eab747192bd330e67bff1222bb851bc515b134",
        "patch": "@@ -113,15 +113,43 @@ bool IsStandardTx(const CTransaction& tx, bool permit_bare_multisig, const CFeeR\n         // that we do not treat it as standard as new rules may apply\n         // in the future due to an upgrade, so we prefer not to treat\n         // such inputs as standard.\n-        const bool seq_is_reserved = (txin.nSequence < CTxIn::SEQUENCE_FINAL-2) && (\n-        // when sequence is set to disabled, it is reserved for future use\n-        ((txin.nSequence & CTxIn::SEQUENCE_LOCKTIME_DISABLE_FLAG) != 0) ||\n-        // when sequence has bits set outside of the type flag and locktime mask,\n-        // it is reserved for future use.\n-        ((~(CTxIn::SEQUENCE_LOCKTIME_TYPE_FLAG | CTxIn::SEQUENCE_LOCKTIME_MASK) &\n-                txin.nSequence) != 0)\n-        );\n-        if (seq_is_reserved) {\n+        bool seq_is_reserved_for_upgrade;\n+        switch (static_cast<CTxIn::SEQUENCE_ROOT_TYPE>(txin.nSequence >> CTxIn::SEQUENCE_ROOT_TYPE_SHIFT)) {\n+        case CTxIn::SEQUENCE_ROOT_TYPE::NORMAL: {\n+            // when sequence has bits set outside of the type flag and locktime mask,\n+            // it is reserved for future use.\n+            // (locktime disable flag is implicitly 0 in SEQUENCE_ROOT_TYPE::NORMAL)\n+            const uint32_t mask = ~(CTxIn::SEQUENCE_LOCKTIME_TYPE_FLAG | CTxIn::SEQUENCE_LOCKTIME_MASK);\n+            seq_is_reserved_for_upgrade = (mask & txin.nSequence) != 0;\n+            break;\n+        }\n+        case CTxIn::SEQUENCE_ROOT_TYPE::UNCHECKED_METADATA: {\n+            seq_is_reserved_for_upgrade = false;\n+            break;\n+        }\n+        case CTxIn::SEQUENCE_ROOT_TYPE::SPECIAL: {\n+            switch (txin.nSequence) {\n+            case CTxIn::SEQUENCE_FINAL:\n+            case CTxIn::SEQUENCE_VALUE_RESERVED_NO_RBF_YES_CLTV:\n+            case CTxIn::SEQUENCE_VALUE_RESERVED_YES_RBF_NO_CSV: {\n+                seq_is_reserved_for_upgrade = false;\n+                break;\n+            }\n+            default: {\n+                // was not a special reserved value, keep reserved for upgrade.\n+                seq_is_reserved_for_upgrade = true;\n+                break;\n+            }\n+            }\n+            break;\n+        }\n+        default: {\n+            // unknown root type, keep reserved for upgrade.\n+            seq_is_reserved_for_upgrade = true;\n+            break;\n+        }\n+        }\n+        if (seq_is_reserved_for_upgrade) {\n             reason = \"sequence-flags-reserved\";\n             return false;\n         }"
      },
      {
        "sha": "79fae358893161f7b877de1e71a47bb6989f8e8c",
        "filename": "src/primitives/transaction.h",
        "status": "modified",
        "additions": 25,
        "deletions": 0,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e8eab747192bd330e67bff1222bb851bc515b134/src/primitives/transaction.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e8eab747192bd330e67bff1222bb851bc515b134/src/primitives/transaction.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/primitives/transaction.h?ref=e8eab747192bd330e67bff1222bb851bc515b134",
        "patch": "@@ -79,6 +79,31 @@ class CTxIn\n      * relative lock-time. */\n     static const uint32_t SEQUENCE_LOCKTIME_DISABLE_FLAG = (1U << 31);\n \n+    /* The top 8 bits may be used as a type flag for marking specific\n+     * use cases. New uses cases should define their semantics via a\n+     * BIP before use, typically. This code was introducded in particular\n+     * for compatibility with the lightning network which uses UNCHECKED_METADATA\n+     * application. See Bolt-3:\n+     * https://github.com/lightningnetwork/lightning-rfc/blob/master/03-transactions.md#commitment-transaction\n+     */\n+    static const uint32_t SEQUENCE_ROOT_TYPE_SHIFT = 24;\n+\n+    /* enum of all root sequence types */\n+    enum class SEQUENCE_ROOT_TYPE : uint8_t {\n+        NORMAL = 0x00,\n+        UNCHECKED_METADATA = 0x80,\n+        // Used for Special Values\n+        SPECIAL = 0xff,\n+    };\n+\n+    /* Reserved Values: */\n+    /* Sequence number that is rbf-opt-out (BIP 125); relative-timelock-opt-out\n+     * (BIP 68); and absolute-timelock-opt-in. */\n+    static const uint32_t SEQUENCE_VALUE_RESERVED_NO_RBF_YES_CLTV = 0xfffffffe;\n+    /* Sequence number that is rbf-opt-in (BIP 125); and relative-timelock-opt-out\n+     * (BIP 68); and absolute-timelock-opt-in. */\n+    static const uint32_t SEQUENCE_VALUE_RESERVED_YES_RBF_NO_CSV = 0xfffffffd;\n+\n     /* If CTxIn::nSequence encodes a relative lock-time and this flag\n      * is set, the relative lock-time has units of 512 seconds,\n      * otherwise it specifies blocks with a granularity of 1. */"
      }
    ]
  }
]