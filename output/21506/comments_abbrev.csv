DrahtBot,2021-03-22 22:57:22,"<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nReviewers, this pull request conflicts with the following ones:\n\n* #21992 (Feefilter cleanups by amadeuszpawlik)\n* #21879 (Wrap accept() and extend usage of Sock by vasild)\n* #21878 (Make",https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-804449681,804449681,
practicalswift,2021-03-23 16:03:44,"Strong Concept ACK\n\n[`enum class` is strictly better :)](https://github.com/bitcoin/bitcoin/pull/19771#issuecomment-678733782)",https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-805026604,805026604,
kiminuo,2021-03-24 21:05:00,"Concept ACK, nice change",https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-806185541,806185541,
jonatack,2021-03-25 15:22:44,"> Could you please explain what was the motivation to add HasAnyFlag?\n\nThanks for the review @kiminuo! I extracted the `NetPermissions::HasAnyFlag()` addition to a separate commit with a detailed explanation in the commit message and updated with your other feedback.",https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-806941459,806941459,
jonatack,2021-03-29 10:24:45,rebased,https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-809265876,809265876,
jonatack,2021-03-30 18:33:50,rebased,https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-810485558,810485558,
jonatack,2021-04-02 13:57:33,"> The first commit ""p2p, refactor: add NetPermissionFlags scopes where not already present"" could be a scripted-diff:\n> \n> ```shell\n> s() { git grep -l ""$1"" -- 'src' ':!src/net_permissions.h' | xargs sed -i -E ""s/([^:])$1/\1NetPermissionFlags::$1/""; }\n\nThanks! That's a co-credit :) Done in 043a4c5163909d0.\n",https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-812542044,812542044,
jonatack,2021-04-10 11:35:46,"Simplified, dropped the `HasAnyFlag()` and test commits that are replaced by the bugfix in #21644 on which this patch is now based, and updated the PR description. ",https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-817122255,817122255,
vasild,2021-04-14 08:42:17,"There is still the following ""strange"" behavior:\n\n```cpp\n// expected to have ""noban"" and ""download"" in flags, true\nflags = TryParse(""noban,download"");\n\n// expected to have just ""noban"" in flags, given that ""download"" has been removed, not true :(\nClearFlag(flags, PF_DOWNLOAD);\n\n// what happens actually is that now flags is in a ""bricked"" state\n// where it does not equal any of ",https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-819344916,819344916,
jonatack,2021-04-14 08:54:24,"I don't disagree, though it might be out of scope for this change (which has indeed exposed some issues!)\n\n`ClearFlag` is currently only used in `src/net.cpp::CConnman::CreateNodeFromAcceptedSocket()` to clear the NetPermissionFlags implicit flag.\n\nEdit: addressed for now in #21644.",https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-819352958,819352958,
DrahtBot,2021-05-03 09:33:02,<!--4a62be1de6b64f3ed646cdc7932c8cf5-->\nüïµÔ∏è @sipa has been requested to review this pull request as specified in the REVIEWERS file.,https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-831142194,831142194,
jonatack,2021-05-11 10:18:10,Thanks everyone for the ACKs but this isn't being merged and I am tying up loose ends before being less present here for some seminars.,https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-838218040,838218040,
Rspigler,2021-05-11 22:57:57,Mark up for grabs?,https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-839259402,839259402,
jonatack,2021-05-12 09:12:11,"Re-opening and rebased now that #21644, that this is based on, was merged.",https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-839607575,839607575,
MarcoFalke,2021-05-12 13:13:37,cr ACK d53c70e775e56c4e4c30728262121c9f7e4bcc23,https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-839762436,839762436,
jonatack,2021-05-12 14:16:45,"Dropped unneeded parentheses, only change is `git diff d53c70e 7075f60`\n```diff\ndiff --git a/src/net_permissions.h b/src/net_permissions.h\nindex 9cb59bd85f..7a158aa6c5 100644\n--- a/src/net_permissions.h\n+++ b/src/net_permissions.h\n@@ -56,7 +56,7 @@ public:\n     }\n     static inline void AddFlag(NetPermissionFlags& flags, NetPermissionFlags f)\n     {\n-        flags = (flags | f)",https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-839809407,839809407,
laanwj,2021-05-19 09:51:10,Code review ACK 7075f604e8d0b21b2255fa57e20cd365dc10a288,https://github.com/bitcoin/bitcoin/pull/21506#issuecomment-843940327,843940327,
MarcoFalke,2021-03-23 17:01:19,meta: Could the rename be a scripted-diff?,https://github.com/bitcoin/bitcoin/pull/21506#discussion_r599761948,599761948,src/net.cpp
jonatack,2021-03-24 12:51:13,done,https://github.com/bitcoin/bitcoin/pull/21506#discussion_r600447225,600447225,src/net.cpp
kiminuo,2021-03-24 20:52:16,"```suggestion\n    BOOST_CHECK(!NetPermissions::HasAnyFlag(whitebindPermissions.m_flags, NetPermissionFlags::Implicit));\n```\n?",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r600865647,600865647,src/test/netbase_tests.cpp
kiminuo,2021-03-24 21:38:21,Maybe move this line one line below? So that it is clear how `HasFlag` and `HasAnyFlag` differ. ,https://github.com/bitcoin/bitcoin/pull/21506#discussion_r600891562,600891562,src/test/netbase_tests.cpp
jonatack,2021-03-25 14:47:18,"good eye, thanks! the compiler didn't mind but we do. fixed.",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r601556107,601556107,src/test/netbase_tests.cpp
jonatack,2021-03-25 14:47:33,"sure, done",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r601556341,601556341,src/test/netbase_tests.cpp
hebasto,2021-04-01 21:03:52,Why not `NetPermissions::HasFlag` ?,https://github.com/bitcoin/bitcoin/pull/21506#discussion_r605945239,605945239,src/net.cpp
jonatack,2021-04-02 13:55:31,"Hm, the tests pass with `HasFlag()` but ISTM that would represent a potential change in behavior in a refactoring pull, as `HasFlag()` returns `(flags & f) == f` instead of `flags & f` and `NetPermissionFlags::NoBan` is a multi-flag (`NoBan = (1U << 4) | Download`). LMK if I'm confused here though.\n\nAside, this line was last changed in commit bb145c90502:\n```diff\n-    if (addr.IsRoutable()",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r606248080,606248080,src/net.cpp
hebasto,2021-04-05 01:17:41,"You are right. Your change is equivalent to the current code. But this raises additional questions:\n\n1. current tests are not reliable if they\n> pass with `HasFlag()`\n\n2. `HasAnyFlag(permissions, flag_a | flag_b)` is much easier to read and reason about than `HasAnyFlag(permissions, fancy_multiflag)`\n\n3. in general, with named multiflags, negation of `HasFlag` could have ambiguous me",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r606878743,606878743,src/net.cpp
jonatack,2021-04-08 13:36:13,"After looking at #16248 and #19191, the current code seems correct.\n\nThis line was changed in e5b26deaaa6, which pre-dates the download permission being extracted from noban in #19191: \n```diff \n-    if (addrBind.IsRoutable() && fDiscover && !fWhitelisted)\n+    if (addrBind.IsRoutable() && fDiscover && (permissions & PF_NOBAN) == 0)\n```\nThe intent of adding the Download flag in #1919",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r609708573,609708573,src/net.cpp
MarcoFalke,2021-04-08 14:21:54,"Ugh, looks like this is a bug that I introduced in #19191\n\n(The `download` permission set shouldn't affect places where `noban` is checked for)",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r609755453,609755453,src/net.cpp
jonatack,2021-04-08 14:32:11,"I first thought that too, but here in Bind() I'm not sure. Confirm that HasFlag(NoBan) is fine here?",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r609766590,609766590,src/net.cpp
MarcoFalke,2021-04-08 14:45:55,"Well, fixing a bug should indeed be done in a separate pull from one that is tagged with [refactoring]",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r609780989,609780989,src/net.cpp
jonatack,2021-04-08 16:49:40,Ok will open a separate patch for that.,https://github.com/bitcoin/bitcoin/pull/21506#discussion_r609899271,609899271,src/net.cpp
jonatack,2021-04-09 19:50:58,"Done in #21644. Resolving here and will simplify this PR, dropping the `HasAnyFlags()` and unit test commits.",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r610871119,610871119,src/net.cpp
vasild,2021-04-14 11:21:19,nit: the opening `{` should be on a new line,https://github.com/bitcoin/bitcoin/pull/21506#discussion_r613160043,613160043,src/net_permissions.h
vasild,2021-04-14 11:22:02,nit: the opening `{` should be on a new line,https://github.com/bitcoin/bitcoin/pull/21506#discussion_r613160393,613160393,src/net_permissions.h
jonatack,2021-05-12 09:10:16,done,https://github.com/bitcoin/bitcoin/pull/21506#discussion_r630866146,630866146,src/net_permissions.h
jonatack,2021-05-12 09:10:30,"done, thanks!",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r630866290,630866290,src/net_permissions.h
laanwj,2021-05-12 13:05:35,"Nice! Why not do this for `&` as well?\n(More generally, I wonder if there is a nice way in C++ to define a reusable metatype that is 'enum with bitfield properties'‚Äîit seems that this is more generally useful. Not necessarily in this PR though.)",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r631022134,631022134,src/net_permissions.h
laanwj,2021-05-12 13:06:14,nit: unnecessary parenthesis,https://github.com/bitcoin/bitcoin/pull/21506#discussion_r631022611,631022611,src/net_permissions.h
MarcoFalke,2021-05-12 13:10:22,"I think the goal of this pull is to forbid the `&` operator, because it won't do what you think it does. (See the preceding bugfix)",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r631025917,631025917,src/net_permissions.h
MarcoFalke,2021-05-12 13:11:30,"That is, callers should use `HasFlag` instead of `&`.",https://github.com/bitcoin/bitcoin/pull/21506#discussion_r631026830,631026830,src/net_permissions.h
jonatack,2021-05-12 14:14:57,fixed,https://github.com/bitcoin/bitcoin/pull/21506#discussion_r631081923,631081923,src/net_permissions.h
