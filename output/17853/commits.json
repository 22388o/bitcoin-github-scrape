[
  {
    "sha": "551583398ba4fdae973c047bc60556ffa17c6431",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo1NTE1ODMzOThiYTRmZGFlOTczYzA0N2JjNjA1NTZmZmExN2M2NDMx",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2019-11-19T19:35:14Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-01-03T04:04:38Z"
      },
      "message": "Have a PSBTAnalysis state that indicates invalid PSBT\n\nInvalid PSBTs need to be re-created, so the next role is the\nCreator (new PSBTRole). Additionally, we need to know what went\nwrong so an error field was added to PSBTAnalysis.\n\nA PSBTAnalysis indicating invalid will have empty everything,\nnext will be set to PSBTRole::CREATOR, and an error message.\n\nGithub-Pull: #17524\nRebased-From: 638e40cb6080800c7b0a7f4028f63326acbe4700",
      "tree": {
        "sha": "bf2d25b820d1118e230997109834f78c1d26ddbd",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/bf2d25b820d1118e230997109834f78c1d26ddbd"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/551583398ba4fdae973c047bc60556ffa17c6431",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/551583398ba4fdae973c047bc60556ffa17c6431",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/551583398ba4fdae973c047bc60556ffa17c6431",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/551583398ba4fdae973c047bc60556ffa17c6431/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "8afa602f308ef003bb6893718eae1fe5a830690c",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/8afa602f308ef003bb6893718eae1fe5a830690c",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/8afa602f308ef003bb6893718eae1fe5a830690c"
      }
    ],
    "stats": {
      "total": 19,
      "additions": 18,
      "deletions": 1
    },
    "files": [
      {
        "sha": "7384dc415cca8734ebfba64f91bddffb59f1ab74",
        "filename": "src/node/psbt.h",
        "status": "modified",
        "additions": 11,
        "deletions": 0,
        "changes": 11,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/551583398ba4fdae973c047bc60556ffa17c6431/src/node/psbt.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/551583398ba4fdae973c047bc60556ffa17c6431/src/node/psbt.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/node/psbt.h?ref=551583398ba4fdae973c047bc60556ffa17c6431",
        "patch": "@@ -30,6 +30,17 @@ struct PSBTAnalysis {\n     Optional<CAmount> fee;                 //!< Amount of fee being paid by the transaction\n     std::vector<PSBTInputAnalysis> inputs; //!< More information about the individual inputs of the transaction\n     PSBTRole next;                         //!< Which of the BIP 174 roles needs to handle the transaction next\n+    std::string error;                     //!< Error message\n+\n+    void SetInvalid(std::string err_msg)\n+    {\n+        estimated_vsize = nullopt;\n+        estimated_feerate = nullopt;\n+        fee = nullopt;\n+        inputs.clear();\n+        next = PSBTRole::CREATOR;\n+        error = err_msg;\n+    }\n };\n \n /**"
      },
      {
        "sha": "20473429a463562c983f52f11ceb9b9ade7b31fd",
        "filename": "src/psbt.cpp",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/551583398ba4fdae973c047bc60556ffa17c6431/src/psbt.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/551583398ba4fdae973c047bc60556ffa17c6431/src/psbt.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/psbt.cpp?ref=551583398ba4fdae973c047bc60556ffa17c6431",
        "patch": "@@ -349,6 +349,7 @@ TransactionError CombinePSBTs(PartiallySignedTransaction& out, const std::vector\n \n std::string PSBTRoleName(PSBTRole role) {\n     switch (role) {\n+    case PSBTRole::CREATOR: return \"creator\";\n     case PSBTRole::UPDATER: return \"updater\";\n     case PSBTRole::SIGNER: return \"signer\";\n     case PSBTRole::FINALIZER: return \"finalizer\";"
      },
      {
        "sha": "437b75d7cfce8d2c88d1e8dad0eb351a5ebdbdb3",
        "filename": "src/psbt.h",
        "status": "modified",
        "additions": 1,
        "deletions": 0,
        "changes": 1,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/551583398ba4fdae973c047bc60556ffa17c6431/src/psbt.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/551583398ba4fdae973c047bc60556ffa17c6431/src/psbt.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/psbt.h?ref=551583398ba4fdae973c047bc60556ffa17c6431",
        "patch": "@@ -552,6 +552,7 @@ struct PartiallySignedTransaction\n };\n \n enum class PSBTRole {\n+    CREATOR,\n     UPDATER,\n     SIGNER,\n     FINALIZER,"
      },
      {
        "sha": "2fd6b9709fba5b6985c041a8c2084fc10515ffb2",
        "filename": "src/rpc/rawtransaction.cpp",
        "status": "modified",
        "additions": 5,
        "deletions": 1,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/551583398ba4fdae973c047bc60556ffa17c6431/src/rpc/rawtransaction.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/551583398ba4fdae973c047bc60556ffa17c6431/src/rpc/rawtransaction.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/rawtransaction.cpp?ref=551583398ba4fdae973c047bc60556ffa17c6431",
        "patch": "@@ -1671,6 +1671,7 @@ UniValue analyzepsbt(const JSONRPCRequest& request)\n                 \"  \\\"estimated_feerate\\\" : feerate   (numeric, optional) Estimated feerate of the final signed transaction in \" + CURRENCY_UNIT + \"/kB. Shown only if all UTXO slots in the PSBT have been filled.\\n\"\n                 \"  \\\"fee\\\" : fee                     (numeric, optional) The transaction fee paid. Shown only if all UTXO slots in the PSBT have been filled.\\n\"\n                 \"  \\\"next\\\" : \\\"role\\\"                 (string) Role of the next person that this psbt needs to go to\\n\"\n+                \"  \\\"error\\\" : \\\"error\\\"               (string) Error message if there is one\"\n                 \"}\\n\"\n             },\n             RPCExamples {\n@@ -1723,7 +1724,7 @@ UniValue analyzepsbt(const JSONRPCRequest& request)\n         }\n         inputs_result.push_back(input_univ);\n     }\n-    result.pushKV(\"inputs\", inputs_result);\n+    if (!inputs_result.empty()) result.pushKV(\"inputs\", inputs_result);\n \n     if (psbta.estimated_vsize != nullopt) {\n         result.pushKV(\"estimated_vsize\", (int)*psbta.estimated_vsize);\n@@ -1735,6 +1736,9 @@ UniValue analyzepsbt(const JSONRPCRequest& request)\n         result.pushKV(\"fee\", ValueFromAmount(*psbta.fee));\n     }\n     result.pushKV(\"next\", PSBTRoleName(psbta.next));\n+    if (!psbta.error.empty()) {\n+        result.pushKV(\"error\", psbta.error);\n+    }\n \n     return result;\n }"
      }
    ]
  },
  {
    "sha": "ca5f8deefd778195cb10a3419d3b5c0693abb958",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjYTVmOGRlZWZkNzc4MTk1Y2IxMGEzNDE5ZDNiNWMwNjkzYWJiOTU4",
    "commit": {
      "author": {
        "name": "Andrew Chow",
        "email": "achow101-github@achow101.com",
        "date": "2019-11-19T19:54:13Z"
      },
      "committer": {
        "name": "Luke Dashjr",
        "email": "luke-jr+git@utopios.org",
        "date": "2020-01-03T04:04:38Z"
      },
      "message": "Mark PSBTs spending unspendable outputs as invalid in analysis\n\nGithub-Pull: #17524\nRebased-From: 773d4572a4864ab7b6380858d07d9579ff6dd9a2",
      "tree": {
        "sha": "f0bbe24a5aa46fc5684451b5f2d6f1436d0fb377",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/f0bbe24a5aa46fc5684451b5f2d6f1436d0fb377"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/ca5f8deefd778195cb10a3419d3b5c0693abb958",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ca5f8deefd778195cb10a3419d3b5c0693abb958",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/ca5f8deefd778195cb10a3419d3b5c0693abb958",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/ca5f8deefd778195cb10a3419d3b5c0693abb958/comments",
    "author": {
      "login": "achow101",
      "id": 3782274,
      "node_id": "MDQ6VXNlcjM3ODIyNzQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/3782274?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/achow101",
      "html_url": "https://github.com/achow101",
      "followers_url": "https://api.github.com/users/achow101/followers",
      "following_url": "https://api.github.com/users/achow101/following{/other_user}",
      "gists_url": "https://api.github.com/users/achow101/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/achow101/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/achow101/subscriptions",
      "organizations_url": "https://api.github.com/users/achow101/orgs",
      "repos_url": "https://api.github.com/users/achow101/repos",
      "events_url": "https://api.github.com/users/achow101/events{/privacy}",
      "received_events_url": "https://api.github.com/users/achow101/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "luke-jr",
      "id": 1095675,
      "node_id": "MDQ6VXNlcjEwOTU2NzU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1095675?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/luke-jr",
      "html_url": "https://github.com/luke-jr",
      "followers_url": "https://api.github.com/users/luke-jr/followers",
      "following_url": "https://api.github.com/users/luke-jr/following{/other_user}",
      "gists_url": "https://api.github.com/users/luke-jr/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/luke-jr/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/luke-jr/subscriptions",
      "organizations_url": "https://api.github.com/users/luke-jr/orgs",
      "repos_url": "https://api.github.com/users/luke-jr/repos",
      "events_url": "https://api.github.com/users/luke-jr/events{/privacy}",
      "received_events_url": "https://api.github.com/users/luke-jr/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "551583398ba4fdae973c047bc60556ffa17c6431",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/551583398ba4fdae973c047bc60556ffa17c6431",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/551583398ba4fdae973c047bc60556ffa17c6431"
      }
    ],
    "stats": {
      "total": 11,
      "additions": 11,
      "deletions": 0
    },
    "files": [
      {
        "sha": "9a30c3f08303ef05927f5bff365a5f8eac2f7f6b",
        "filename": "src/node/psbt.cpp",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ca5f8deefd778195cb10a3419d3b5c0693abb958/src/node/psbt.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ca5f8deefd778195cb10a3419d3b5c0693abb958/src/node/psbt.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/node/psbt.cpp?ref=ca5f8deefd778195cb10a3419d3b5c0693abb958",
        "patch": "@@ -7,6 +7,7 @@\n #include <node/psbt.h>\n #include <policy/policy.h>\n #include <policy/settings.h>\n+#include <tinyformat.h>\n \n #include <numeric>\n \n@@ -39,6 +40,11 @@ PSBTAnalysis AnalyzePSBT(PartiallySignedTransaction psbtx)\n             calc_fee = false;\n         }\n \n+        if (!utxo.IsNull() && utxo.scriptPubKey.IsUnspendable()) {\n+            result.SetInvalid(strprintf(\"PSBT is not valid. Input %u spends unspendable output\", i));\n+            return result;\n+        }\n+\n         // Check if it is final\n         if (!utxo.IsNull() && !PSBTInputSigned(input)) {\n             input_analysis.is_final = false;"
      },
      {
        "sha": "57333955b263e7dfc7c10ce03463fd74cb0bfd82",
        "filename": "test/functional/rpc_psbt.py",
        "status": "modified",
        "additions": 5,
        "deletions": 0,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/ca5f8deefd778195cb10a3419d3b5c0693abb958/test/functional/rpc_psbt.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/ca5f8deefd778195cb10a3419d3b5c0693abb958/test/functional/rpc_psbt.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_psbt.py?ref=ca5f8deefd778195cb10a3419d3b5c0693abb958",
        "patch": "@@ -416,5 +416,10 @@ def test_psbt_input_keys(psbt_input, keys):\n         analyzed = self.nodes[0].analyzepsbt(signed)\n         assert analyzed['inputs'][0]['has_utxo'] and analyzed['inputs'][0]['is_final'] and analyzed['next'] == 'extractor'\n \n+        self.log.info(\"PSBT spending unspendable outputs should have error message and Creator as next\")\n+        analysis = self.nodes[0].analyzepsbt('cHNidP8BAJoCAAAAAljoeiG1ba8MI76OcHBFbDNvfLqlyHV5JPVFiHuyq911AAAAAAD/////g40EJ9DsZQpoqka7CwmK6kQiwHGyyng1Kgd5WdB86h0BAAAAAP////8CcKrwCAAAAAAWAEHYXCtx0AYLCcmIauuBXlCZHdoSTQDh9QUAAAAAFv8/wADXYP/7//////8JxOh0LR2HAI8AAAAAAAEBIADC6wsAAAAAF2oUt/X69ELjeX2nTof+fZ10l+OyAokDAQcJAwEHEAABAACAAAEBIADC6wsAAAAAF2oUt/X69ELjeX2nTof+fZ10l+OyAokDAQcJAwEHENkMak8AAAAA')\n+        assert_equal(analysis['next'], 'creator')\n+        assert_equal(analysis['error'], 'PSBT is not valid. Input 0 spends unspendable output')\n+\n if __name__ == '__main__':\n     PSBTTest().main()"
      }
    ]
  }
]