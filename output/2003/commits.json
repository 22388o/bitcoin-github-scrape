[
  {
    "sha": "c043ff79e38bbc02e1eee8e9aca6e86986096276",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpjMDQzZmY3OWUzOGJiYzAyZTFlZWU4ZTlhY2E2ZTg2OTg2MDk2Mjc2",
    "commit": {
      "author": {
        "name": "Alexander Kjeldaas",
        "email": "alexander.kjeldaas@gmail.com",
        "date": "2012-11-11T01:21:07Z"
      },
      "committer": {
        "name": "Alexander Kjeldaas",
        "email": "alexander.kjeldaas@gmail.com",
        "date": "2012-11-11T03:53:00Z"
      },
      "message": "o Added threadsafety.h - a set of macros using the -Wthread-safety\n  feature in clang.  These macros should primarily be used to\n  document which locks protect a given piece of data.  Secondary it\n  can be used to document the set of held and excluded locks when\n  entering a function.",
      "tree": {
        "sha": "17825c150715659a812119816a86053f6c4e24ed",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/17825c150715659a812119816a86053f6c4e24ed"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/c043ff79e38bbc02e1eee8e9aca6e86986096276",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c043ff79e38bbc02e1eee8e9aca6e86986096276",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/c043ff79e38bbc02e1eee8e9aca6e86986096276",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c043ff79e38bbc02e1eee8e9aca6e86986096276/comments",
    "author": {
      "login": "alexanderkjeldaas",
      "id": 339369,
      "node_id": "MDQ6VXNlcjMzOTM2OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/339369?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexanderkjeldaas",
      "html_url": "https://github.com/alexanderkjeldaas",
      "followers_url": "https://api.github.com/users/alexanderkjeldaas/followers",
      "following_url": "https://api.github.com/users/alexanderkjeldaas/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexanderkjeldaas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexanderkjeldaas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexanderkjeldaas/subscriptions",
      "organizations_url": "https://api.github.com/users/alexanderkjeldaas/orgs",
      "repos_url": "https://api.github.com/users/alexanderkjeldaas/repos",
      "events_url": "https://api.github.com/users/alexanderkjeldaas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexanderkjeldaas/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "alexanderkjeldaas",
      "id": 339369,
      "node_id": "MDQ6VXNlcjMzOTM2OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/339369?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexanderkjeldaas",
      "html_url": "https://github.com/alexanderkjeldaas",
      "followers_url": "https://api.github.com/users/alexanderkjeldaas/followers",
      "following_url": "https://api.github.com/users/alexanderkjeldaas/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexanderkjeldaas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexanderkjeldaas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexanderkjeldaas/subscriptions",
      "organizations_url": "https://api.github.com/users/alexanderkjeldaas/orgs",
      "repos_url": "https://api.github.com/users/alexanderkjeldaas/repos",
      "events_url": "https://api.github.com/users/alexanderkjeldaas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexanderkjeldaas/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6ca2ea2fa2465c80f60830241d53cbd278870288",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6ca2ea2fa2465c80f60830241d53cbd278870288",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6ca2ea2fa2465c80f60830241d53cbd278870288"
      }
    ],
    "stats": {
      "total": 53,
      "additions": 53,
      "deletions": 0
    },
    "files": [
      {
        "sha": "3d3d526fd66611ccdd3350d10b2557cb46579c1f",
        "filename": "src/threadsafety.h",
        "status": "added",
        "additions": 53,
        "deletions": 0,
        "changes": 53,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/c043ff79e38bbc02e1eee8e9aca6e86986096276/src/threadsafety.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/c043ff79e38bbc02e1eee8e9aca6e86986096276/src/threadsafety.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/threadsafety.h?ref=c043ff79e38bbc02e1eee8e9aca6e86986096276",
        "patch": "@@ -0,0 +1,53 @@\n+// Copyright (c) 2009-2010 Satoshi Nakamoto\n+// Copyright (c) 2009-2012 The Bitcoin developers\n+// Distributed under the MIT/X11 software license, see the accompanying\n+// file COPYING or http://www.opensource.org/licenses/mit-license.php.\n+#ifndef BITCOIN_THREADSAFETY_H\n+#define BITCOIN_THREADSAFETY_H\n+\n+#ifdef __clang__\n+// TL;DR Add GUARDED_BY(mutex) to member variables. The others are\n+// rarely necessary. Ex: int nFoo GUARDED_BY(cs_foo);\n+//\n+// See http://clang.llvm.org/docs/LanguageExtensions.html#threadsafety\n+// for documentation.  The clang compiler can do advanced static analysis\n+// of locking when given the -Wthread-safety option.\n+#define LOCKABLE                        __attribute__ ((lockable))\n+#define SCOPED_LOCKABLE                 __attribute__ ((scoped_lockable))\n+#define GUARDED_BY(x)                   __attribute__ ((guarded_by(x)))\n+#define GUARDED_VAR                     __attribute__ ((guarded_var))\n+#define PT_GUARDED_BY(x)                __attribute__ ((pt_guarded_by(x)))\n+#define PT_GUARDED_VAR                  __attribute__ ((pt_guarded_var))\n+#define ACQUIRED_AFTER(...)             __attribute__ ((acquired_after(__VA_ARGS__)))\n+#define ACQUIRED_BEFORE(...)            __attribute__ ((acquired_before(__VA_ARGS__)))\n+#define EXCLUSIVE_LOCK_FUNCTION(...)    __attribute__ ((exclusive_lock_function(__VA_ARGS__)))\n+#define SHARED_LOCK_FUNCTION(...)       __attribute__ ((shared_lock_function(__VA_ARGS__)))\n+#define EXCLUSIVE_TRYLOCK_FUNCTION(...) __attribute__ ((exclusive_trylock_function(__VA_ARGS__)))\n+#define SHARED_TRYLOCK_FUNCTION(...)    __attribute__ ((shared_trylock_function(__VA_ARGS__)))\n+#define UNLOCK_FUNCTION(...)            __attribute__ ((unlock_function(__VA_ARGS__)))\n+#define LOCK_RETURNED(x)                __attribute__ ((lock_returned(x)))\n+#define LOCKS_EXCLUDED(...)             __attribute__ ((locks_excluded(__VA_ARGS__)))\n+#define EXCLUSIVE_LOCKS_REQUIRED(...)   __attribute__ ((exclusive_locks_required(__VA_ARGS__)))\n+#define SHARED_LOCKS_REQUIRED(...)      __attribute__ ((shared_locks_required(__VA_ARGS__)))\n+#define NO_THREAD_SAFETY_ANALYSIS       __attribute__ ((no_thread_safety_analysis))\n+#else\n+#define LOCKABLE\n+#define SCOPED_LOCKABLE\n+#define GUARDED_BY(x)\n+#define GUARDED_VAR\n+#define PT_GUARDED_BY(x)\n+#define PT_GUARDED_VAR\n+#define ACQUIRED_AFTER(...)\n+#define ACQUIRED_BEFORE(...)\n+#define EXCLUSIVE_LOCK_FUNCTION(...)\n+#define SHARED_LOCK_FUNCTION(...)\n+#define EXCLUSIVE_TRYLOCK_FUNCTION(...)\n+#define SHARED_TRYLOCK_FUNCTION(...)\n+#define UNLOCK_FUNCTION(...)\n+#define LOCK_RETURNED(x)\n+#define LOCKS_EXCLUDED(...)\n+#define EXCLUSIVE_LOCKS_REQUIRED(...)\n+#define SHARED_LOCKS_REQUIRED(...)\n+#define NO_THREAD_SAFETY_ANALYSIS\n+#endif  // __GNUC__\n+#endif  // BITCOIN_THREADSAFETY_H"
      }
    ]
  },
  {
    "sha": "05f97d1263540b5f9faae971374a25ddc3f6dadb",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzowNWY5N2QxMjYzNTQwYjVmOWZhYWU5NzEzNzRhMjVkZGMzZjZkYWRi",
    "commit": {
      "author": {
        "name": "Alexander Kjeldaas",
        "email": "alexander.kjeldaas@gmail.com",
        "date": "2012-11-11T02:50:26Z"
      },
      "committer": {
        "name": "Alexander Kjeldaas",
        "email": "alexander.kjeldaas@gmail.com",
        "date": "2012-11-11T03:55:48Z"
      },
      "message": "o Added AnnotatedMixin which adds locking annotations to the mutex\n  API, compatible with clang's -Wthread-safety",
      "tree": {
        "sha": "4d17601b5192ab15a51eaf5506a4c730fdb53704",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/4d17601b5192ab15a51eaf5506a4c730fdb53704"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/05f97d1263540b5f9faae971374a25ddc3f6dadb",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/05f97d1263540b5f9faae971374a25ddc3f6dadb",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/05f97d1263540b5f9faae971374a25ddc3f6dadb",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/05f97d1263540b5f9faae971374a25ddc3f6dadb/comments",
    "author": {
      "login": "alexanderkjeldaas",
      "id": 339369,
      "node_id": "MDQ6VXNlcjMzOTM2OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/339369?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexanderkjeldaas",
      "html_url": "https://github.com/alexanderkjeldaas",
      "followers_url": "https://api.github.com/users/alexanderkjeldaas/followers",
      "following_url": "https://api.github.com/users/alexanderkjeldaas/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexanderkjeldaas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexanderkjeldaas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexanderkjeldaas/subscriptions",
      "organizations_url": "https://api.github.com/users/alexanderkjeldaas/orgs",
      "repos_url": "https://api.github.com/users/alexanderkjeldaas/repos",
      "events_url": "https://api.github.com/users/alexanderkjeldaas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexanderkjeldaas/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "alexanderkjeldaas",
      "id": 339369,
      "node_id": "MDQ6VXNlcjMzOTM2OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/339369?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexanderkjeldaas",
      "html_url": "https://github.com/alexanderkjeldaas",
      "followers_url": "https://api.github.com/users/alexanderkjeldaas/followers",
      "following_url": "https://api.github.com/users/alexanderkjeldaas/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexanderkjeldaas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexanderkjeldaas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexanderkjeldaas/subscriptions",
      "organizations_url": "https://api.github.com/users/alexanderkjeldaas/orgs",
      "repos_url": "https://api.github.com/users/alexanderkjeldaas/repos",
      "events_url": "https://api.github.com/users/alexanderkjeldaas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexanderkjeldaas/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "c043ff79e38bbc02e1eee8e9aca6e86986096276",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/c043ff79e38bbc02e1eee8e9aca6e86986096276",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/c043ff79e38bbc02e1eee8e9aca6e86986096276"
      }
    ],
    "stats": {
      "total": 25,
      "additions": 23,
      "deletions": 2
    },
    "files": [
      {
        "sha": "b9c89027bb1f530bf9cea470310bf22f39ff3673",
        "filename": "src/sync.h",
        "status": "modified",
        "additions": 23,
        "deletions": 2,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/05f97d1263540b5f9faae971374a25ddc3f6dadb/src/sync.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/05f97d1263540b5f9faae971374a25ddc3f6dadb/src/sync.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/sync.h?ref=05f97d1263540b5f9faae971374a25ddc3f6dadb",
        "patch": "@@ -9,15 +9,36 @@\n #include <boost/thread/recursive_mutex.hpp>\n #include <boost/thread/locks.hpp>\n #include <boost/thread/condition_variable.hpp>\n+#include \"threadsafety.h\"\n \n+// Template mixin that adds -Wthread-safety locking annotations to a\n+// subset of the mutex API.\n+template <typename PARENT>\n+class LOCKABLE AnnotatedMixin : public PARENT\n+{\n+public:\n+    void lock() EXCLUSIVE_LOCK_FUNCTION()\n+    {\n+      PARENT::lock();\n+    }\n \n+    void unlock() UNLOCK_FUNCTION()\n+    {\n+      PARENT::unlock();\n+    }\n \n+    bool try_lock() EXCLUSIVE_TRYLOCK_FUNCTION(true)\n+    {\n+      return PARENT::try_lock();\n+    }\n+};\n \n /** Wrapped boost mutex: supports recursive locking, but no waiting  */\n-typedef boost::recursive_mutex CCriticalSection;\n+// TODO: We should move away from using the recursive lock by default.\n+typedef AnnotatedMixin<boost::recursive_mutex> CCriticalSection;\n \n /** Wrapped boost mutex: supports waiting but not recursive locking */\n-typedef boost::mutex CWaitableCriticalSection;\n+typedef AnnotatedMixin<boost::mutex> CWaitableCriticalSection;\n \n #ifdef DEBUG_LOCKORDER\n void EnterCritical(const char* pszName, const char* pszFile, int nLine, void* cs, bool fTry = false);"
      }
    ]
  },
  {
    "sha": "25511af4a57816c4f9bb960527f090a9719c9010",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzoyNTUxMWFmNGE1NzgxNmM0ZjliYjk2MDUyN2YwOTBhOTcxOWM5MDEw",
    "commit": {
      "author": {
        "name": "Alexander Kjeldaas",
        "email": "alexander.kjeldaas@gmail.com",
        "date": "2012-11-11T02:51:50Z"
      },
      "committer": {
        "name": "Alexander Kjeldaas",
        "email": "alexander.kjeldaas@gmail.com",
        "date": "2012-11-11T03:55:48Z"
      },
      "message": "o Annotated lock-like functions in net.h.\no Removed unused function EndMessageAbortIfEmpty",
      "tree": {
        "sha": "7f712aada0275de141f38ae8579e179dd2db5088",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/7f712aada0275de141f38ae8579e179dd2db5088"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/25511af4a57816c4f9bb960527f090a9719c9010",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/25511af4a57816c4f9bb960527f090a9719c9010",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/25511af4a57816c4f9bb960527f090a9719c9010",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/25511af4a57816c4f9bb960527f090a9719c9010/comments",
    "author": {
      "login": "alexanderkjeldaas",
      "id": 339369,
      "node_id": "MDQ6VXNlcjMzOTM2OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/339369?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexanderkjeldaas",
      "html_url": "https://github.com/alexanderkjeldaas",
      "followers_url": "https://api.github.com/users/alexanderkjeldaas/followers",
      "following_url": "https://api.github.com/users/alexanderkjeldaas/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexanderkjeldaas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexanderkjeldaas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexanderkjeldaas/subscriptions",
      "organizations_url": "https://api.github.com/users/alexanderkjeldaas/orgs",
      "repos_url": "https://api.github.com/users/alexanderkjeldaas/repos",
      "events_url": "https://api.github.com/users/alexanderkjeldaas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexanderkjeldaas/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "alexanderkjeldaas",
      "id": 339369,
      "node_id": "MDQ6VXNlcjMzOTM2OQ==",
      "avatar_url": "https://avatars.githubusercontent.com/u/339369?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/alexanderkjeldaas",
      "html_url": "https://github.com/alexanderkjeldaas",
      "followers_url": "https://api.github.com/users/alexanderkjeldaas/followers",
      "following_url": "https://api.github.com/users/alexanderkjeldaas/following{/other_user}",
      "gists_url": "https://api.github.com/users/alexanderkjeldaas/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/alexanderkjeldaas/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/alexanderkjeldaas/subscriptions",
      "organizations_url": "https://api.github.com/users/alexanderkjeldaas/orgs",
      "repos_url": "https://api.github.com/users/alexanderkjeldaas/repos",
      "events_url": "https://api.github.com/users/alexanderkjeldaas/events{/privacy}",
      "received_events_url": "https://api.github.com/users/alexanderkjeldaas/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "05f97d1263540b5f9faae971374a25ddc3f6dadb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/05f97d1263540b5f9faae971374a25ddc3f6dadb",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/05f97d1263540b5f9faae971374a25ddc3f6dadb"
      }
    ],
    "stats": {
      "total": 22,
      "additions": 6,
      "deletions": 16
    },
    "files": [
      {
        "sha": "07da6edebc85bf6506fac6ec4a2b0f0a2751e8fb",
        "filename": "src/net.h",
        "status": "modified",
        "additions": 6,
        "deletions": 16,
        "changes": 22,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/25511af4a57816c4f9bb960527f090a9719c9010/src/net.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/25511af4a57816c4f9bb960527f090a9719c9010/src/net.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/net.h?ref=25511af4a57816c4f9bb960527f090a9719c9010",
        "patch": "@@ -311,7 +311,8 @@ class CNode\n \n \n \n-    void BeginMessage(const char* pszCommand)\n+    // TODO: Document the postcondition of this function.  Is cs_vSend locked?\n+    void BeginMessage(const char* pszCommand) EXCLUSIVE_LOCK_FUNCTION(cs_vSend)\n     {\n         ENTER_CRITICAL_SECTION(cs_vSend);\n         if (nHeaderStart != -1)\n@@ -323,7 +324,8 @@ class CNode\n             printf(\"sending: %s \", pszCommand);\n     }\n \n-    void AbortMessage()\n+    // TODO: Document the precondition of this function.  Is cs_vSend locked?\n+    void AbortMessage() UNLOCK_FUNCTION(cs_vSend)\n     {\n         if (nHeaderStart < 0)\n             return;\n@@ -336,7 +338,8 @@ class CNode\n             printf(\"(aborted)\\n\");\n     }\n \n-    void EndMessage()\n+    // TODO: Document the precondition of this function.  Is cs_vSend locked?\n+    void EndMessage() UNLOCK_FUNCTION(cs_vSend)\n     {\n         if (mapArgs.count(\"-dropmessagestest\") && GetRand(atoi(mapArgs[\"-dropmessagestest\"])) == 0)\n         {\n@@ -368,19 +371,6 @@ class CNode\n         LEAVE_CRITICAL_SECTION(cs_vSend);\n     }\n \n-    void EndMessageAbortIfEmpty()\n-    {\n-        if (nHeaderStart < 0)\n-            return;\n-        int nSize = vSend.size() - nMessageStart;\n-        if (nSize > 0)\n-            EndMessage();\n-        else\n-            AbortMessage();\n-    }\n-\n-\n-\n     void PushVersion();\n \n "
      }
    ]
  }
]