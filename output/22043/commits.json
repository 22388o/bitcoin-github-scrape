[
  {
    "sha": "6b1926cf1eac1ad1850599d2753dd22bc21fd327",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzo2YjE5MjZjZjFlYWMxYWQxODUwNTk5ZDI3NTNkZDIyYmMyMWZkMzI3",
    "commit": {
      "author": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2021-05-22T20:09:28Z"
      },
      "committer": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2021-05-23T08:39:08Z"
      },
      "message": "test: addpeeraddress functional test coverage",
      "tree": {
        "sha": "90f1510d75a32837d7e99d830d8a26d69b4906e2",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/90f1510d75a32837d7e99d830d8a26d69b4906e2"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/6b1926cf1eac1ad1850599d2753dd22bc21fd327",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEd6u7+MhX7zEv6RP5T1chs9Djkh0FAmCqFKwACgkQT1chs9Dj\nkh39ig/+P0IgNxbMDo426DX8f/pf6yqu44ftlVOhIOnWG3lRcfFmcjkNf6x/UTS2\nZgKjzS35qmEFOG66azI2HTS2gjzTNBLodrrG0t2OWjtvHT4mgWdiLNwFECjRL4oW\nvmjqKOa+qTKIl5kqWcNSSQd0JcoVPFoXFdxnMx8NM2XPCNN0Zc9UCC+n1GQ0LExo\nCtkHBtOwUql20J6CrmGVbo8wcgD1675z4Neglt0shj+irhDCvchtOO/iWNeKFTau\nXtqPlJ6FhZKlLaSbvZpYcrx1pfKUpCkvq8Lq3TYyATe/Y8b0DN05zjiMo3S7hXL7\n3Timxy79Gw6rz1iTNZjn4abSL+DKQWW63mkX4uc1SvkxOwuUkmuU0FGVHGrxi+RX\nY30N5Fd4P8WBvrlYDJ/tn0AohUJHcOn35gjBFnTceFptcni4m4u/x3wgQPvsjUAI\nKZsYuAD6UIlBvC3pbQ7BP5vqN9fv8BZqAuCTPYfK4k81HmMTHyyQFp9Ccke+6M+C\nT6WY8y/ZvOIoq0fHf6Srl2N+RnFJQcwMo2OPhJ9xiFGoDV3XM+WRc3CrJ84VkxOt\nXYZOL5ickcHb55nbRCi/Tbudv5QEIyO/jU5U+SQF4QMKtRP1XEHGRSmNm6PA2kc7\ndVMNF75pVvcvF/gfF1GKBSCLwyyv7BA+8luv+mT1DkYtaLG5TyI=\n=dQJC\n-----END PGP SIGNATURE-----\n-----BEGIN OPENTIMESTAMPS GIT TIMESTAMP-----\n\nAQHwIPn5FQhTni3Yu9lVam1N8rIj4Rmo6Bwh/flAVwpg0lj5CP/wEEtpwHCwd8zV\nBwORd7yJzJQI8QRgqhSt8Aj3du20rfaT7wCD3+MNLvkMji4taHR0cHM6Ly9hbGlj\nZS5idGMuY2FsZW5kYXIub3BlbnRpbWVzdGFtcHMub3Jn8BBVabU5mYRN2hL7a1da\nxaKACPEEYKoUrfAI77/46flyGb0Ag9/jDS75DI4sK2h0dHBzOi8vYm9iLmJ0Yy5j\nYWxlbmRhci5vcGVudGltZXN0YW1wcy5vcmc=\n-----END OPENTIMESTAMPS GIT TIMESTAMP-----",
        "payload": "tree 90f1510d75a32837d7e99d830d8a26d69b4906e2\nparent be4171679b8eab8205e04ff86140329bd67878a0\nauthor Jon Atack <jon@atack.com> 1621714168 +0200\ncommitter Jon Atack <jon@atack.com> 1621759148 +0200\n\ntest: addpeeraddress functional test coverage\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6b1926cf1eac1ad1850599d2753dd22bc21fd327",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/6b1926cf1eac1ad1850599d2753dd22bc21fd327",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6b1926cf1eac1ad1850599d2753dd22bc21fd327/comments",
    "author": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "be4171679b8eab8205e04ff86140329bd67878a0",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/be4171679b8eab8205e04ff86140329bd67878a0",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/be4171679b8eab8205e04ff86140329bd67878a0"
      }
    ],
    "stats": {
      "total": 25,
      "additions": 25,
      "deletions": 0
    },
    "files": [
      {
        "sha": "9a2817a6ee632c0462fe988fc8717aa046946a90",
        "filename": "test/functional/rpc_net.py",
        "status": "modified",
        "additions": 25,
        "deletions": 0,
        "changes": 25,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/6b1926cf1eac1ad1850599d2753dd22bc21fd327/test/functional/rpc_net.py",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/6b1926cf1eac1ad1850599d2753dd22bc21fd327/test/functional/rpc_net.py",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/test/functional/rpc_net.py?ref=6b1926cf1eac1ad1850599d2753dd22bc21fd327",
        "patch": "@@ -69,6 +69,7 @@ def run_test(self):\n         self.test_getaddednodeinfo()\n         self.test_service_flags()\n         self.test_getnodeaddresses()\n+        self.test_addpeeraddress()\n \n     def test_connection_count(self):\n         self.log.info(\"Test getconnectioncount\")\n@@ -236,6 +237,30 @@ def test_getnodeaddresses(self):\n         assert_raises_rpc_error(-8, \"Address count out of range\", self.nodes[0].getnodeaddresses, -1)\n         assert_raises_rpc_error(-8, \"Network not recognized: Foo\", self.nodes[0].getnodeaddresses, 1, \"Foo\")\n \n+    def test_addpeeraddress(self):\n+        self.log.info(\"Test addpeeraddress\")\n+        node = self.nodes[1]\n+\n+        self.log.debug(\"Test that addpeerinfo is a hidden RPC\")\n+        # It is hidden from general help, but its detailed help may be called directly.\n+        assert \"addpeerinfo\" not in node.help()\n+        assert \"addpeerinfo\" in node.help(\"addpeerinfo\")\n+\n+        self.log.debug(\"Test that adding an empty address fails\")\n+        assert_equal(node.addpeeraddress(address=\"\", port=8333), {\"success\": False})\n+        assert_equal(node.getnodeaddresses(count=0), [])\n+\n+        self.log.debug(\"Test that adding a valid address succeeds\")\n+        assert_equal(node.addpeeraddress(address=\"1.2.3.4\", port=8333), {\"success\": True})\n+        addrs = node.getnodeaddresses(count=0)\n+        assert_equal(len(addrs), 1)\n+        assert_equal(addrs[0][\"address\"], \"1.2.3.4\")\n+        assert_equal(addrs[0][\"port\"], 8333)\n+\n+        self.log.debug(\"Test that adding the same address again when already present fails\")\n+        assert_equal(node.addpeeraddress(address=\"1.2.3.4\", port=8333), {\"success\": False})\n+        assert_equal(len(node.getnodeaddresses(count=0)), 1)\n+\n \n if __name__ == '__main__':\n     NetTest().main()"
      }
    ]
  },
  {
    "sha": "b36e0cd1b9d361ac6f9777c09328a13e9ee923be",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpiMzZlMGNkMWI5ZDM2MWFjNmY5Nzc3YzA5MzI4YTEzZTllZTkyM2Jl",
    "commit": {
      "author": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2021-05-22T20:08:46Z"
      },
      "committer": {
        "name": "Jon Atack",
        "email": "jon@atack.com",
        "date": "2021-05-24T12:10:23Z"
      },
      "message": "rpc: simplify addpeeraddress and improve code constness",
      "tree": {
        "sha": "421fa73b705137f6eea102af4876f7c0f4999c80",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/421fa73b705137f6eea102af4876f7c0f4999c80"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/b36e0cd1b9d361ac6f9777c09328a13e9ee923be",
      "comment_count": 0,
      "verification": {
        "verified": true,
        "reason": "valid",
        "signature": "-----BEGIN PGP SIGNATURE-----\n\niQIzBAABCAAdFiEEd6u7+MhX7zEv6RP5T1chs9Djkh0FAmCrl7kACgkQT1chs9Dj\nkh3wsA/+KF2iRuN2nyawZNRb0EuUWfT4J9TVRXmg9GA6Xeb1cn6LkMQNPThgS1jL\nqipMfbE7h77661TVAVGhttT6MpGgLHbOtrn4Ize7v0zbndXYOxmr1vxCSnoajHK7\ndJCjv4YMNZFiUPIun4edubgdi/PjYhfGrR8e/+UrhcDd/K5lH2f7P0pMq9uW37j/\ndJz0DpNCzRrruw4WBCmReXdtEQbNp8Lty6bwd+DviMuLBomW0TtGj3GP4r6iWo06\n5gUGW0J1EwiuZUJTXp3bKM93PWxiB+SozNbiV6n5YLOoudPz9amnowHEn47vGNH0\n4nk1JthyRyP9kiLj8KQaf3nVulso4dOyKXZUcEBacTTM8DDj/yZJnYZty8rmehtd\nv4NPs8toH4xh9QHxy5VteITeilWjtI5Fk7/vy9jcjPd/azy2926jVl0kShsymJVC\nx71BLOPYDdn4LQkK5UcEfzV2Holu1PC/Kre9wo7NbPJTQljUXwM8t3E5umI1+gZv\nbvO5So0OSjUg/6W0kaUXGIy6sr900YuuIuGHCGeBdhi8gMVsaj8hfZ5qsU7B/y0S\ngrzBmd/VmoiilyUd0LDhoQLAB9xDCElfRcPW0nFpxw3Hx3UpbV8JlIbgsXIhQ8JC\nO04PVup7tiQt4k0GhA+wXCAjCPRLSBklMclpq9xGg3YagAIeSuA=\n=Qhes\n-----END PGP SIGNATURE-----\n-----BEGIN OPENTIMESTAMPS GIT TIMESTAMP-----\n\nAQHwIIHf2XOx8dh3ageCznImvGLerN1Q0xtKc+A2SLiNApNfCP/wEBhCHvj8fPA0\nDhbULTXCR6AI8CDnhVxaNIrrCSkwdd86dT33SA1sX1wsw6m2MofkBO3vzQjwIAgb\nbvQyO+q9lbyPCk7XhFE9SsbUtFE9RKGi8FA12w5vCPEgl7q6gmj5LrrxHGMUCiAb\njRoJrK7OzA2iZK3rCHg49UgI8CBx5FkdtLjZFYBaQE43ez4b7zWGYcGxcQjCi7Lk\ncTpfMAjxBGCrl7rwCFPM5B9ZXs7KAIPf4w0u+QyOLi1odHRwczovL2FsaWNlLmJ0\nYy5jYWxlbmRhci5vcGVudGltZXN0YW1wcy5vcmf/8BBYy75P5aoLT4uWpuMqpBgm\nCPEgoMYO3qIA+N31sRYNw3On6yr+nyIrpKMJnuRwmmiZEk4I8QRgq5e68AiqLY4A\nX1UmkwCD3+MNLvkMjiwraHR0cHM6Ly9ib2IuYnRjLmNhbGVuZGFyLm9wZW50aW1l\nc3RhbXBzLm9yZ/AQxwCum7QSc+5yLXzSTk106wjwIEv8ch5i00/08aejALovjFaX\nRueBM4VqJgovaEP52JfTCPEEYKuXuvAI1dq5FDocXhIAg9/jDS75DI4jImh0dHBz\nOi8vYnRjLmNhbGVuZGFyLmNhdGFsbGF4eS5jb20=\n-----END OPENTIMESTAMPS GIT TIMESTAMP-----",
        "payload": "tree 421fa73b705137f6eea102af4876f7c0f4999c80\nparent 6b1926cf1eac1ad1850599d2753dd22bc21fd327\nauthor Jon Atack <jon@atack.com> 1621714126 +0200\ncommitter Jon Atack <jon@atack.com> 1621858223 +0200\n\nrpc: simplify addpeeraddress and improve code constness\n"
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b36e0cd1b9d361ac6f9777c09328a13e9ee923be",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/b36e0cd1b9d361ac6f9777c09328a13e9ee923be",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/b36e0cd1b9d361ac6f9777c09328a13e9ee923be/comments",
    "author": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "jonatack",
      "id": 2415484,
      "node_id": "MDQ6VXNlcjI0MTU0ODQ=",
      "avatar_url": "https://avatars.githubusercontent.com/u/2415484?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jonatack",
      "html_url": "https://github.com/jonatack",
      "followers_url": "https://api.github.com/users/jonatack/followers",
      "following_url": "https://api.github.com/users/jonatack/following{/other_user}",
      "gists_url": "https://api.github.com/users/jonatack/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jonatack/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jonatack/subscriptions",
      "organizations_url": "https://api.github.com/users/jonatack/orgs",
      "repos_url": "https://api.github.com/users/jonatack/repos",
      "events_url": "https://api.github.com/users/jonatack/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jonatack/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "6b1926cf1eac1ad1850599d2753dd22bc21fd327",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/6b1926cf1eac1ad1850599d2753dd22bc21fd327",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/6b1926cf1eac1ad1850599d2753dd22bc21fd327"
      }
    ],
    "stats": {
      "total": 28,
      "additions": 12,
      "deletions": 16
    },
    "files": [
      {
        "sha": "c4d6e3d546c78e6fb2ccb9b97a179755fe3c7098",
        "filename": "src/rpc/net.cpp",
        "status": "modified",
        "additions": 12,
        "deletions": 16,
        "changes": 28,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/b36e0cd1b9d361ac6f9777c09328a13e9ee923be/src/rpc/net.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/b36e0cd1b9d361ac6f9777c09328a13e9ee923be/src/rpc/net.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/rpc/net.cpp?ref=b36e0cd1b9d361ac6f9777c09328a13e9ee923be",
        "patch": "@@ -931,26 +931,22 @@ static RPCHelpMan addpeeraddress()\n         throw JSONRPCError(RPC_CLIENT_P2P_DISABLED, \"Error: Address manager functionality missing or disabled\");\n     }\n \n-    UniValue obj(UniValue::VOBJ);\n-\n-    std::string addr_string = request.params[0].get_str();\n-    uint16_t port{static_cast<uint16_t>(request.params[1].get_int())};\n+    const std::string& addr_string{request.params[0].get_str()};\n+    const uint16_t port{static_cast<uint16_t>(request.params[1].get_int())};\n \n+    UniValue obj(UniValue::VOBJ);\n     CNetAddr net_addr;\n-    if (!LookupHost(addr_string, net_addr, false)) {\n-        obj.pushKV(\"success\", false);\n-        return obj;\n-    }\n-    CAddress address = CAddress({net_addr, port}, ServiceFlags(NODE_NETWORK|NODE_WITNESS));\n-    address.nTime = GetAdjustedTime();\n-    // The source address is set equal to the address. This is equivalent to the peer\n-    // announcing itself.\n-    if (!node.addrman->Add(address, address)) {\n-        obj.pushKV(\"success\", false);\n-        return obj;\n+    bool success{false};\n+\n+    if (LookupHost(addr_string, net_addr, false)) {\n+        CAddress address{CAddress({net_addr, port}, ServiceFlags(NODE_NETWORK | NODE_WITNESS))};\n+        address.nTime = GetAdjustedTime();\n+        // The source address is set equal to the address. This is equivalent to the peer\n+        // announcing itself.\n+        if (node.addrman->Add(address, address)) success = true;\n     }\n \n-    obj.pushKV(\"success\", true);\n+    obj.pushKV(\"success\", success);\n     return obj;\n },\n     };"
      }
    ]
  }
]