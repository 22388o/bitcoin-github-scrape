vasild,2021-05-31 16:34:32,"TODO: see if something has to be done about this assert:\n\nhttps://github.com/bitcoin/bitcoin/blob/8462cd56010a8beadf95d4f3cb1357ca9d88493b/src/bench/addrman.cpp#L91",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-851589805,851589805,
sipa,2021-05-31 16:36:36,I think that's just a way to test that the returned address object isn't empty. Should probably replace it with another test.,https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-851590531,851590531,
laanwj,2021-06-02 15:51:40,"Concept ACK, earlier I was convinced it would be better to get rid of ports completely for I2P, but at the time I thought it didn't exist as a concept there. I was unaware that the concept *does* exists for newer versions of the protocol.\n\nThis is more forward compatible with future versions of `i2pd` and new SAM protocol, so seems better to me.",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-853143208,853143208,
vasild,2021-06-03 10:58:03,"> ... I was convinced it would be better to get rid of ports completely for I2P, but at the time I thought it didn't exist as a concept there. I was unaware that the concept does exists for newer versions of the protocol.\n\nMe too!",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-853781755,853781755,
vasild,2021-06-03 12:00:32,"> TODO: see if something has to be done about this assert:\n> \n> https://github.com/bitcoin/bitcoin/blob/8462cd56010a8beadf95d4f3cb1357ca9d88493b/src/bench/addrman.cpp#L91\n\nThat seems to be ok as it is - addresses being used in the bench are generated, not taken from real-world addrman. The code that generates them takes care to avoid port 0:\n\nhttps://github.com/bitcoin/bitcoin/blob/a94",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-853815021,853815021,
vasild,2021-06-23 09:22:41,"`4401bb56cf...a9cacd29a1`: add a test and a comment\n\n> outbound connections are no longer made to any of the 13 I2P addresses in my addrman (all with port 8333), which is a bit of collateral annoyance for these nodes\n\nYes, that's really unfortunate and annoying. I wonder if it can be avoided...",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-866677772,866677772,
jonatack,2021-06-23 09:23:01,ISTM with this change we would need a way to manually or automatically convert the existing I2P entries in the addrman from port 8333 to 0. ,https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-866677980,866677980,
jonatack,2021-06-23 09:35:03,"> `4401bb56cf...a9cacd29a1`: add a test and a comment\n\nAdd the test to the test runner?  ",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-866686056,866686056,
vasild,2021-06-23 09:48:06,"`a9cacd29a1...d6255891da`: add the newly added test to `test_runner.py` (forgotten in the previous push)\n\n> Add the test to the test runner?\n\nYes :hear_no_evil: ",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-866694441,866694441,
vasild,2021-06-23 10:29:03,`d6255891da...28f98950ee`: rename the functional test to match the naming convention,https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-866721847,866721847,
jonatack,2021-06-23 10:29:09,"`test_runner.py#check_script_prefixes()` is unhappy about the name of the test file\n\nedit: snap!",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-866721927,866721927,
jonatack,2021-06-23 10:32:54,ACK 28f98950ee89dafcb75b131b810f5a933c2977b3 modulo https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-866677980,https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-866724349,866724349,
jonatack,2021-06-23 14:46:12,"IRC discussion with @vasild and I regarding whether the remedies here and in #21514 are less desirable than leaving the ""double connections"" issue unresolved: https://www.erisian.com.au/bitcoin-core-dev/log-2021-06-23.html#l-167",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-866902236,866902236,
vasild,2021-06-29 10:20:00,`28f98950ee..0c6db5b87f`: append a new commit that changes the ports of existent I2P addrman entries to 0.,https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-870469254,870469254,
vasild,2021-06-29 11:48:30,"`0c6db5b87f...b336f12eda`: no need to lock `CAddrMan::cs` in the `ResetI2PPorts()` method, it is already locked by the caller and in `master` the mutex is not recursive anymore.",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-870525146,870525146,
vasild,2021-06-29 13:09:26,"[Coverage report](https://people.freebsd.org/~vd/pr22112_b336f12ed_coverage/modified_and_not_covered.html) for modified lines by this PR and not covered by tests. There is just one line which was also not covered before this PR (this PR changed `Params().GetDefaultPort()` to `PORT_SAM31` in that line).\n\nThe new method added in the last commit is [fully covered](https://people.freebsd.org/~vd/p",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-870585034,870585034,
DrahtBot,2021-06-30 16:11:17,<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.,https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-871537613,871537613,
jonatack,2021-06-30 19:58:52,"Tested this rebased to master, then restarted the node after backing up `peers.dat`:\n\n- `Loaded 65986 addresses from peers.dat`\n- The number of I2P addresses reported by `-addrinfo` and `getnodeaddresses 0 i2p` dropped from 15 to 5 (all have port 0 as expected)\n- `I2P: SAM session created: my address=zsxwyo6qcn3chqzwxnseusqgsnuw3maqnztkiypyfxtya4snkoka.b32.i2p:0`\n- No outbound I2P connec",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-871687616,871687616,
jonatack,2021-07-01 12:56:23,"```\n$ test/lint/lint-circular-dependencies.sh\nA new circular dependency in the form of ""chainparams -> i2p -> chainparams"" appears to have been introduced.\n```\n",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-872223073,872223073,
vasild,2021-07-01 12:58:58,"`b336f12eda...e4684144e9`:\n\n* If a collision occurs due to re-bucketing of the I2P address with the changed port to 0, then remove the other entry, not the I2P one. Looks like I2P addresses are more precious than a random one from an addrman filled mostly with IPv4 addresses.\n\n* If `addnode=foo.b32.i2p` is specified (without port) then we would do something like `Lookup(str, GetDefaultPort",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-872224803,872224803,
vasild,2021-07-01 13:25:46,"`e4684144e9...36cf2ca392`: define the default SAM 3.1 port in `netaddress.h`, which is included in both `i2p.h` and `chainparams.h` to avoid circular dependency `i2p.h` -> `chainparams.h` -> `i2p.h`",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-872246188,872246188,
laanwj,2021-07-01 14:26:26,"Added 22.0 milestone (@jonatack mentioned that one of the solutions to the [I2P port problem](https://github.com/bitcoin/bitcoin/issues/21389#issuecomment-866925116) needs to make it in, and I think that makes sense. From what I understand this PR is preferred.)",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-872293292,872293292,
vasild,2021-07-02 10:41:18,`36cf2ca392...ba6d18861b`: rebase in order to pull `doc/i2p.md` and add a note to it for I2P ports being forced to 0.,https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-872902257,872902257,
jonatack,2021-07-05 10:28:09,Re-reviewing and testing.,https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-874001279,874001279,
vasild,2021-07-05 11:46:22,`ba6d18861b...14db11782c`: minor rewording in `doc/i2p.md`,https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-874049237,874049237,
vasild,2021-07-05 16:30:46,"> ... noodling around adding things like, say, `++nTried` at the bottom of the last loop in `CAddrMan::ResetI2PPorts()`, didn't break anything either.\n\nThis should be detected by `CAddrMan::Check()` (only enabled if `DEBUG_ADDRMAN` is defined):\n\nhttps://github.com/bitcoin/bitcoin/blob/271155984574a5bba9619d8f6da9bb0606d93f8c/src/addrman.cpp#L438\n\n> Questions, should any of these be upd",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-874227307,874227307,
jonatack,2021-07-05 17:08:27,"> > ... noodling around adding things like, say, `++nTried` at the bottom of the last loop in `CAddrMan::ResetI2PPorts()`, didn't break anything either.\n> \n> This should be detected by `CAddrMan::Check()` (only enabled if `DEBUG_ADDRMAN` is defined):\n> \n> https://github.com/bitcoin/bitcoin/blob/271155984574a5bba9619d8f6da9bb0606d93f8c/src/addrman.cpp#L438\n\nYes, I'll reverify if `CAddrM",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-874242604,874242604,
jonatack,2021-07-06 10:09:44,"re-ACK 0b0ee030ea6f2b6508e8660dffc40b40c6aa2644 per `git diff 14db117 0b0ee03`\n\n\n> * the `-port` config help in `src/init.cpp`\n> \n> Add something like ""not relevant for I2P""?\n\nsgtm",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-874634410,874634410,
vasild,2021-07-09 09:21:25,"`0b0ee030ea...4101ec9d2e`: rebase due to conflicts, clarify `-port=` help wrt I2P.",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-877046082,877046082,
jonatack,2021-07-09 15:46:52,"Shut down the node, deleted the new peers.dat, recopied my backed-up peers.dat (`cp ~/.bitcoin/peers-bak.dat ~/.bitcoin/peers.dat`) and restarted.  Unlike bootstrapping with no peers.dat and addnode peers, all of the I2P addresses in `getnodeaddresses 0 i2p` have port 0 (and as above, `getaddednodeinfo` as well).\n\n```\n2021-07-09T15:39:34Z Loaded 68521 addresses from peers.dat  2688ms\n2021-",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-877280880,877280880,
jonatack,2021-07-10 08:53:52,"Repeated the bootstrapping steps in https://github.com/bitcoin/bitcoin/pull/22112#pullrequestreview-703116399 but with no `addnode` peers and with `-dnsseed=0`.\n\n```\n2021-07-10T08:44:03Z Missing or invalid file ~/.bitcoin/peers.dat\n2021-07-10T08:44:04Z DNS seeding disabled\n2021-07-10T08:44:05Z Adding fixed seeds as -dnsseed=0, -addnode is not provided and all -seednode(s) attempted\n```",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-877599986,877599986,
jonatack,2021-07-10 09:11:20,"After a few minutes, one new `getnodeaddresses 0 i2p` entry from an inbound peer had port 8333. Restarted the node and that address now has port 0. Edit: a day later, `getnodeaddresses 0 i2p` returns two more (inbound) I2P peers with port 8333. Of course, these inbound peers aren't running this branch.\n\nStill seeing the double connection issue (all report port 0); and in some cases it is fairl",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-877602702,877602702,
vasild,2021-07-12 10:27:35,It is expected to have I2P addresses with port 8333 appearing in addrman - if some of our peers relays such one to us. After a restart the port will be changed to 0. It is important to remove this behavior (last commit from this PR) before real nodes appear that advertise themselves with port 8333 and only accept connections to that port (must be using SAM>=3.2 and deliberately close the connectio,https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-878162733,878162733,
jonatack,2021-07-12 11:01:11,"Yes, I came to the same conclusions.\n\nFWIW tested the previous push and this one for 3 days each.",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-878182734,878182734,
laanwj,2021-07-13 12:19:48,"> It is important to remove this behavior (last commit from this PR) before real nodes appear that advertise themselves with port 8333 and only accept connections to that port (must be using SAM>=3.2 and deliberately close the connection if TO_PORT is not 8333).\n\nThat's pretty easy to forget. Let's open an issue for this once this is merged.",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-879039395,879039395,
vasild,2021-07-13 12:34:18,"> That's pretty easy to forget. Let's open an issue for this once this is merged.\n\nI will take care about it. Maybe even a draft-PR that lingers for e.g. 6 months.",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-879048417,879048417,
jonatack,2021-07-13 12:39:42,"Yeah, I'd remind you ;)\n\nMight be good to have this in rc1 to sanity test it with some other nodes running it.",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-879051907,879051907,
laanwj,2021-07-13 12:52:03,"Code review ACK 4101ec9d2e05a35c35f587a28f1feee6cebcc61b\nHave also loosely tested it by running different versions of this on a node for the last weeks, during which I have noticed no problem with I2P connectivity.",https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-879060270,879060270,
sipa,2021-06-02 18:22:23,"I don't think this is exactly what we want. As (with SAM 3.1) we're unable to connect to anything except port 0 (from the perspective of later versions), shouldn't this equally bias away from port 0, as we bias away from the default port for other networks?\n\nIn other words: maybe this can be done a bit cleaner by having a network-dependent default port, which is 0 for I2P and the normal port f",https://github.com/bitcoin/bitcoin/pull/22112#discussion_r644216009,644216009,src/net.cpp
vasild,2021-06-03 10:56:51,I think the limitation of only being able to connect to ports that equal 0 is purely internal to the I2P code - it depends on the SAM version being used and higher level code shouldn't care about that or be aware of it. So I planted the refuse-to-connect-to-non-zero-ports [check in i2p.cpp](https://github.com/bitcoin/bitcoin/pull/22112/commits/4401bb56cf3822950b221c3fa47fb0b65312d12f#diff-8945a035,https://github.com/bitcoin/bitcoin/pull/22112#discussion_r644694720,644694720,src/net.cpp
jonatack,2021-06-22 15:12:10,It may be good to update the comment preceding this line to explain the exception for I2P.,https://github.com/bitcoin/bitcoin/pull/22112#discussion_r656320196,656320196,src/net.cpp
vasild,2021-06-23 09:23:06,Added a comment.,https://github.com/bitcoin/bitcoin/pull/22112#discussion_r656918013,656918013,src/net.cpp
jonatack,2021-06-30 15:44:41,"b336f12 it looks like this line can be pulled out of the conditional\n```diff\n             // Reposition from (bucket, i) to (bucket_target, i_target) or delete if the target\n             // position is occupied.\n+            vvTried[bucket][i] = -1;\n \n             if (vvTried[bucket_target][i_target] == -1) {\n                 vvTried[bucket_target][i_target] = id;\n-                ",https://github.com/bitcoin/bitcoin/pull/22112#discussion_r661599653,661599653,src/addrman.cpp
jonatack,2021-06-30 15:49:37,"b336f12 would asserts like those seen in `CAddrMan::Delete()` be a good idea?\n```diff\n@@ -675,6 +675,7 @@ void CAddrMan::ResetI2PPorts()\n             if (id == -1) {\n                 continue;\n             }\n+            assert(mapInfo.count(id) != 0);\n             auto& addr_info = mapInfo[id];\n@@ -716,6 +717,7 @@ void CAddrMan::ResetI2PPorts()\n             if (id == -1) {\n   ",https://github.com/bitcoin/bitcoin/pull/22112#discussion_r661604130,661604130,src/addrman.cpp
jonatack,2021-07-01 10:01:50,"From testing and offline discussion with @vasild, it seems a network-dependent `GetDefaultPort()` is indeed needed.",https://github.com/bitcoin/bitcoin/pull/22112#discussion_r662156772,662156772,src/net.cpp
vasild,2021-07-01 12:27:06,"Did that, but after that changed the code to remove the existent entry (if any), so the above is not relevant any more.",https://github.com/bitcoin/bitcoin/pull/22112#discussion_r662243726,662243726,src/addrman.cpp
vasild,2021-07-01 12:29:23,I think asserts are too excessive - if something goes wrong with this code I don't think it is critical enough to stop the node (that's during startup). Instead of the first two asserts I added a check & early quit. The 3rd suggested assert is not relevant now because I changed those lines to remove the existent entry (not the I2P one).,https://github.com/bitcoin/bitcoin/pull/22112#discussion_r662245348,662245348,src/addrman.cpp
vasild,2021-07-01 13:23:24,"So, network-dependent default port seems to be the most elegant solution to [resolve addresses without ports](https://github.com/bitcoin/bitcoin/pull/22112#issuecomment-872224803) properly - e.g. `1.2.3.4` should be treated as `1.2.3.4:8333` and `foo.b32.i2p` as `foo.b32.i2p:0`.\n\nNow this line looks better?\n\n\n```cpp\nif (addr.GetPort() != Params().GetDefaultPort(addr.GetNetwork()) && nT",https://github.com/bitcoin/bitcoin/pull/22112#discussion_r662285093,662285093,src/net.cpp
jonatack,2021-07-01 14:53:36,FWIW the asserts passed for me in mainnet testing.,https://github.com/bitcoin/bitcoin/pull/22112#discussion_r662362227,662362227,src/addrman.cpp
jonatack,2021-07-05 10:38:01,25fda81f include `netaddress.h` and `string` in cpp file too?,https://github.com/bitcoin/bitcoin/pull/22112#discussion_r663828318,663828318,src/chainparams.h
jonatack,2021-07-05 10:42:28,25fda81f9a22dd8ed97a64081175c24c88abaad2 maybe just inline this one as it is only one line,https://github.com/bitcoin/bitcoin/pull/22112#discussion_r663830918,663830918,src/chainparams.h
jonatack,2021-07-05 10:46:24,"25fda81f9a22dd8ed97a64081175c24c88abaad2 one return might be simpler/clearer\n```cpp\nreturn a.SetSpecial(addr) ? GetDefaultPort(a.GetNetwork() : GetDefaultPort();\n```\n",https://github.com/bitcoin/bitcoin/pull/22112#discussion_r663833215,663833215,src/chainparams.cpp
jonatack,2021-07-05 14:19:18,"44889de Here and line 754 below, I'm not sure whether it's better to assert or silently return.",https://github.com/bitcoin/bitcoin/pull/22112#discussion_r663966996,663966996,src/addrman.cpp
jonatack,2021-07-05 15:48:21,(Asserts run fine for me in my testing so far).,https://github.com/bitcoin/bitcoin/pull/22112#discussion_r664022031,664022031,src/addrman.cpp
vasild,2021-07-05 16:40:10,Asserts look [scary](https://github.com/bitcoin/bitcoin/pull/22112#discussion_r662245348) to me. If those have to be asserts then I would deem this too risky for 22.0. Maybe I am pessimistic but I imagine 22.0 nodes not being able to start because I overlooked something in the I2P ports fiddling which is definitely not critical for node operation :bomb: :skull_and_crossbones: ,https://github.com/bitcoin/bitcoin/pull/22112#discussion_r664046092,664046092,src/addrman.cpp
vasild,2021-07-05 16:53:52,Removed the changes to `chainparams.cpp`.,https://github.com/bitcoin/bitcoin/pull/22112#discussion_r664051457,664051457,src/chainparams.h
vasild,2021-07-05 16:54:11,Done.,https://github.com/bitcoin/bitcoin/pull/22112#discussion_r664051590,664051590,src/chainparams.h
vasild,2021-07-05 16:54:33,"Done, and moved to `.h`",https://github.com/bitcoin/bitcoin/pull/22112#discussion_r664051693,664051693,src/chainparams.cpp
jonatack,2021-07-06 10:29:57,"f108193c6381b4d It looks like the loops can be accelerated with a faster iterator comparison and by avoiding integer conversions. \n\n<details><summary>suggestion</summary><p>\n\n```diff\ndiff --git a/src/addrman.cpp b/src/addrman.cpp\nindex f2d54c0adb..41375e8320 100644\n--- a/src/addrman.cpp\n+++ b/src/addrman.cpp\n@@ -703,8 +703,8 @@ std::vector<bool> CAddrMan::DecodeAsmap(fs::path pat",https://github.com/bitcoin/bitcoin/pull/22112#discussion_r664434544,664434544,src/addrman.cpp
jonatack,2021-07-06 10:37:15,(This isn't a hotspot but is something that could also be considered in places that are.),https://github.com/bitcoin/bitcoin/pull/22112#discussion_r664439172,664439172,src/addrman.cpp
laanwj,2021-07-08 15:24:01,"Will leave it up to @vasild but it seems to me that integer and iterator conversions seem an unlikely source of performance problems.\n\n> (This isn't a hotspot but is something that could also be considered in places that are.)\n\nSure, it might have impact on tight loops that loop over large memory areas.",https://github.com/bitcoin/bitcoin/pull/22112#discussion_r666296359,666296359,src/addrman.cpp
vasild,2021-07-09 09:50:41,"1.\n`ADDRMAN_NEW_BUCKET_COUNT` is of type `int`.\n\n```cpp\nfor (int bucket = 0; bucket < ADDRMAN_NEW_BUCKET_COUNT; ++bucket) {\n```\n\nhow is changing `bucket` to `size_t` going to make it faster? (otoh, it could produce some warning about comparing `size_t` to `int`)\n\n2.\nCurrent code:\n```cpp\nint GetFoo();\nauto x = GetFoo();\n```\nSo `x` will be defined as type `int`. How wil",https://github.com/bitcoin/bitcoin/pull/22112#discussion_r666825283,666825283,src/addrman.cpp
jonatack,2021-07-09 14:36:10,"```\n$ ./src/bitcoind -h | grep -A4 ""\-port=""\n  -port=<port>\n       Listen for connections on <port>. Nodes not using the default ports\n       (default: 8333, testnet: 18333, signet: 38333, regtest: 18444)\n       are unlikely to get incoming connections. Not relevant for I2P\n       (see doc/i2p.md).\n```\nmaybe s/I2P/I2P connections/ and s/Not/This option is not/\n```suggestion\n   ",https://github.com/bitcoin/bitcoin/pull/22112#discussion_r666997801,666997801,src/init.cpp
