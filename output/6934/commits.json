[
  {
    "sha": "e4e5334ef8d923993ef9cf704ea8f3d0b5801350",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzplNGU1MzM0ZWY4ZDkyMzk5M2VmOWNmNzA0ZWE4ZjNkMGI1ODAxMzUw",
    "commit": {
      "author": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2015-11-03T17:12:36Z"
      },
      "committer": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2015-11-03T17:12:36Z"
      },
      "message": "Restore MedianTimePast for locktime.\n\nRevert \"Revert \"Add rules--presently disabled--for using GetMedianTimePast as endpoint for lock-time calculations\"\"\nThis reverts commit 40cd32e835092c3158175511da5193193ec54939.\n\nAfter careful analysis it was determined that the change was, in fact, safe and several people were suffering\nmomentary confusion about locktime semantics.",
      "tree": {
        "sha": "a8298dd0e362e318eaa075c468a5e1b556d7d47b",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a8298dd0e362e318eaa075c468a5e1b556d7d47b"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/e4e5334ef8d923993ef9cf704ea8f3d0b5801350",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e4e5334ef8d923993ef9cf704ea8f3d0b5801350",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/e4e5334ef8d923993ef9cf704ea8f3d0b5801350",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e4e5334ef8d923993ef9cf704ea8f3d0b5801350/comments",
    "author": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "42f339ef780bff268369e3a7399c8b8f2ef3e8b4",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/42f339ef780bff268369e3a7399c8b8f2ef3e8b4",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/42f339ef780bff268369e3a7399c8b8f2ef3e8b4"
      }
    ],
    "stats": {
      "total": 61,
      "additions": 54,
      "deletions": 7
    },
    "files": [
      {
        "sha": "6d6ce7e0998e9248b65f4ee7fb47bb36216ed76a",
        "filename": "src/consensus/consensus.h",
        "status": "modified",
        "additions": 6,
        "deletions": 0,
        "changes": 6,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e4e5334ef8d923993ef9cf704ea8f3d0b5801350/src/consensus/consensus.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e4e5334ef8d923993ef9cf704ea8f3d0b5801350/src/consensus/consensus.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/consensus/consensus.h?ref=e4e5334ef8d923993ef9cf704ea8f3d0b5801350",
        "patch": "@@ -13,4 +13,10 @@ static const unsigned int MAX_BLOCK_SIGOPS = MAX_BLOCK_SIZE/50;\n /** Coinbase transaction outputs can only be spent after this number of new blocks (network rule) */\n static const int COINBASE_MATURITY = 100;\n \n+/** Flags for LockTime() */\n+enum {\n+    /* Use GetMedianTimePast() instead of nTime for end point timestamp. */\n+    LOCKTIME_MEDIAN_TIME_PAST = (1 << 1),\n+};\n+\n #endif // BITCOIN_CONSENSUS_CONSENSUS_H"
      },
      {
        "sha": "e038fe3663f1a0d2673dee4f9991e3f268eb42ec",
        "filename": "src/main.cpp",
        "status": "modified",
        "additions": 35,
        "deletions": 5,
        "changes": 40,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e4e5334ef8d923993ef9cf704ea8f3d0b5801350/src/main.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e4e5334ef8d923993ef9cf704ea8f3d0b5801350/src/main.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.cpp?ref=e4e5334ef8d923993ef9cf704ea8f3d0b5801350",
        "patch": "@@ -650,10 +650,35 @@ bool IsFinalTx(const CTransaction &tx, int nBlockHeight, int64_t nBlockTime)\n     return true;\n }\n \n-bool CheckFinalTx(const CTransaction &tx)\n+bool CheckFinalTx(const CTransaction &tx, int flags)\n {\n     AssertLockHeld(cs_main);\n-    return IsFinalTx(tx, chainActive.Height() + 1, GetAdjustedTime());\n+\n+    // By convention a negative value for flags indicates that the\n+    // current network-enforced consensus rules should be used. In\n+    // a future soft-fork scenario that would mean checking which\n+    // rules would be enforced for the next block and setting the\n+    // appropriate flags. At the present time no soft-forks are\n+    // scheduled, so no flags are set.\n+    flags = std::max(flags, 0);\n+\n+    // CheckFinalTx() uses chainActive.Height()+1 to evaluate\n+    // nLockTime because when IsFinalTx() is called within\n+    // CBlock::AcceptBlock(), the height of the block *being*\n+    // evaluated is what is used. Thus if we want to know if a\n+    // transaction can be part of the *next* block, we need to call\n+    // IsFinalTx() with one more than chainActive.Height().\n+    const int nBlockHeight = chainActive.Height() + 1;\n+\n+    // Timestamps on the other hand don't get any special treatment,\n+    // because we can't know what timestamp the next block will have,\n+    // and there aren't timestamp applications where it matters.\n+    // However this changes once median past time-locks are enforced:\n+    const int64_t nBlockTime = (flags & LOCKTIME_MEDIAN_TIME_PAST)\n+                             ? chainActive.Tip()->GetMedianTimePast()\n+                             : GetAdjustedTime();\n+\n+    return IsFinalTx(tx, nBlockHeight, nBlockTime);\n }\n \n unsigned int GetLegacySigOpCount(const CTransaction& tx)\n@@ -797,7 +822,7 @@ bool AcceptToMemoryPool(CTxMemPool& pool, CValidationState &state, const CTransa\n     // Only accept nLockTime-using transactions that can be mined in the next\n     // block; we don't want our mempool filled up with transactions that can't\n     // be mined yet.\n-    if (!CheckFinalTx(tx))\n+    if (!CheckFinalTx(tx, STANDARD_LOCKTIME_VERIFY_FLAGS))\n         return state.DoS(0, false, REJECT_NONSTANDARD, \"non-final\");\n \n     // is it already in the memory pool?\n@@ -2723,10 +2748,15 @@ bool ContextualCheckBlock(const CBlock& block, CValidationState& state, CBlockIn\n     const Consensus::Params& consensusParams = Params().GetConsensus();\n \n     // Check that all transactions are finalized\n-    BOOST_FOREACH(const CTransaction& tx, block.vtx)\n-        if (!IsFinalTx(tx, nHeight, block.GetBlockTime())) {\n+    BOOST_FOREACH(const CTransaction& tx, block.vtx) {\n+        int nLockTimeFlags = 0;\n+        int64_t nLockTimeCutoff = (nLockTimeFlags & LOCKTIME_MEDIAN_TIME_PAST)\n+                                ? pindexPrev->GetMedianTimePast()\n+                                : block.GetBlockTime();\n+        if (!IsFinalTx(tx, nHeight, nLockTimeCutoff)) {\n             return state.DoS(10, error(\"%s: contains a non-final transaction\", __func__), REJECT_INVALID, \"bad-txns-nonfinal\");\n         }\n+    }\n \n     // Enforce block.nVersion=2 rule that the coinbase starts with serialized block height\n     // if 750 of the last 1,000 blocks are version 2 or greater (51/100 if testnet):"
      },
      {
        "sha": "65732d770f8811d9143764f9bf39f319002e3ab3",
        "filename": "src/main.h",
        "status": "modified",
        "additions": 3,
        "deletions": 1,
        "changes": 4,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e4e5334ef8d923993ef9cf704ea8f3d0b5801350/src/main.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e4e5334ef8d923993ef9cf704ea8f3d0b5801350/src/main.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/main.h?ref=e4e5334ef8d923993ef9cf704ea8f3d0b5801350",
        "patch": "@@ -308,8 +308,10 @@ bool IsFinalTx(const CTransaction &tx, int nBlockHeight, int64_t nBlockTime);\n  * Check if transaction will be final in the next block to be created.\n  *\n  * Calls IsFinalTx() with current block height and appropriate block time.\n+ *\n+ * See consensus/consensus.h for flag definitions.\n  */\n-bool CheckFinalTx(const CTransaction &tx);\n+bool CheckFinalTx(const CTransaction &tx, int flags = -1);\n \n /** \n  * Closure representing one script verification"
      },
      {
        "sha": "053d9cdbc4ecca4fb22f747fb3d2551206f64d3b",
        "filename": "src/miner.cpp",
        "status": "modified",
        "additions": 7,
        "deletions": 1,
        "changes": 8,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e4e5334ef8d923993ef9cf704ea8f3d0b5801350/src/miner.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e4e5334ef8d923993ef9cf704ea8f3d0b5801350/src/miner.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/miner.cpp?ref=e4e5334ef8d923993ef9cf704ea8f3d0b5801350",
        "patch": "@@ -148,6 +148,7 @@ CBlockTemplate* CreateNewBlock(const CScript& scriptPubKeyIn)\n         CBlockIndex* pindexPrev = chainActive.Tip();\n         const int nHeight = pindexPrev->nHeight + 1;\n         pblock->nTime = GetAdjustedTime();\n+        const int64_t nMedianTimePast = pindexPrev->GetMedianTimePast();\n         CCoinsViewCache view(pcoinsTip);\n \n         // Priority order to process transactions\n@@ -162,7 +163,12 @@ CBlockTemplate* CreateNewBlock(const CScript& scriptPubKeyIn)\n              mi != mempool.mapTx.end(); ++mi)\n         {\n             const CTransaction& tx = mi->GetTx();\n-            if (tx.IsCoinBase() || !IsFinalTx(tx, nHeight, pblock->nTime))\n+\n+            int64_t nLockTimeCutoff = (STANDARD_LOCKTIME_VERIFY_FLAGS & LOCKTIME_MEDIAN_TIME_PAST)\n+                                    ? nMedianTimePast\n+                                    : pblock->GetBlockTime();\n+\n+            if (tx.IsCoinBase() || !IsFinalTx(tx, nHeight, nLockTimeCutoff))\n                 continue;\n \n             COrphan* porphan = NULL;"
      },
      {
        "sha": "fdc54a70a1bcd3730038fbc6fb1346ebee3ae419",
        "filename": "src/policy/policy.h",
        "status": "modified",
        "additions": 3,
        "deletions": 0,
        "changes": 3,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/e4e5334ef8d923993ef9cf704ea8f3d0b5801350/src/policy/policy.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/e4e5334ef8d923993ef9cf704ea8f3d0b5801350/src/policy/policy.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/policy/policy.h?ref=e4e5334ef8d923993ef9cf704ea8f3d0b5801350",
        "patch": "@@ -43,6 +43,9 @@ static const unsigned int STANDARD_SCRIPT_VERIFY_FLAGS = MANDATORY_SCRIPT_VERIFY\n /** For convenience, standard but not mandatory verify flags. */\n static const unsigned int STANDARD_NOT_MANDATORY_VERIFY_FLAGS = STANDARD_SCRIPT_VERIFY_FLAGS & ~MANDATORY_SCRIPT_VERIFY_FLAGS;\n \n+/** Used as the flags parameter to CheckFinalTx() in non-consensus code */\n+static const unsigned int STANDARD_LOCKTIME_VERIFY_FLAGS = 0;\n+\n bool IsStandard(const CScript& scriptPubKey, txnouttype& whichType);\n     /**\n      * Check for standard transaction types"
      }
    ]
  },
  {
    "sha": "d1c3762ae8c8c73ddd47766041507a6c131afaf2",
    "node_id": "MDY6Q29tbWl0MTE4MTkyNzpkMWMzNzYyYWU4YzhjNzNkZGQ0Nzc2NjA0MTUwN2E2YzEzMWFmYWYy",
    "commit": {
      "author": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2015-11-03T17:14:09Z"
      },
      "committer": {
        "name": "Gregory Maxwell",
        "email": "greg@xiph.org",
        "date": "2015-11-03T17:14:09Z"
      },
      "message": "Revert \"Revert \"Enable policy enforcing GetMedianTimePast as the end point of lock-time constraints\"\"\n\nThis reverts commit 8537ecdfc40181249ec37556015a99cfae4b21fd.",
      "tree": {
        "sha": "25a57c056159681fb7277b582c5daec83afc2b62",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/25a57c056159681fb7277b582c5daec83afc2b62"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/d1c3762ae8c8c73ddd47766041507a6c131afaf2",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d1c3762ae8c8c73ddd47766041507a6c131afaf2",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/d1c3762ae8c8c73ddd47766041507a6c131afaf2",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/d1c3762ae8c8c73ddd47766041507a6c131afaf2/comments",
    "author": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "gmaxwell",
      "id": 858454,
      "node_id": "MDQ6VXNlcjg1ODQ1NA==",
      "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/gmaxwell",
      "html_url": "https://github.com/gmaxwell",
      "followers_url": "https://api.github.com/users/gmaxwell/followers",
      "following_url": "https://api.github.com/users/gmaxwell/following{/other_user}",
      "gists_url": "https://api.github.com/users/gmaxwell/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/gmaxwell/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
      "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
      "repos_url": "https://api.github.com/users/gmaxwell/repos",
      "events_url": "https://api.github.com/users/gmaxwell/events{/privacy}",
      "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "e4e5334ef8d923993ef9cf704ea8f3d0b5801350",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/e4e5334ef8d923993ef9cf704ea8f3d0b5801350",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/e4e5334ef8d923993ef9cf704ea8f3d0b5801350"
      }
    ],
    "stats": {
      "total": 9,
      "additions": 5,
      "deletions": 4
    },
    "files": [
      {
        "sha": "f269e8d4762e441f5c73134ddfee6b044070f307",
        "filename": "src/policy/policy.h",
        "status": "modified",
        "additions": 1,
        "deletions": 1,
        "changes": 2,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d1c3762ae8c8c73ddd47766041507a6c131afaf2/src/policy/policy.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d1c3762ae8c8c73ddd47766041507a6c131afaf2/src/policy/policy.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/policy/policy.h?ref=d1c3762ae8c8c73ddd47766041507a6c131afaf2",
        "patch": "@@ -44,7 +44,7 @@ static const unsigned int STANDARD_SCRIPT_VERIFY_FLAGS = MANDATORY_SCRIPT_VERIFY\n static const unsigned int STANDARD_NOT_MANDATORY_VERIFY_FLAGS = STANDARD_SCRIPT_VERIFY_FLAGS & ~MANDATORY_SCRIPT_VERIFY_FLAGS;\n \n /** Used as the flags parameter to CheckFinalTx() in non-consensus code */\n-static const unsigned int STANDARD_LOCKTIME_VERIFY_FLAGS = 0;\n+static const unsigned int STANDARD_LOCKTIME_VERIFY_FLAGS = LOCKTIME_MEDIAN_TIME_PAST;\n \n bool IsStandard(const CScript& scriptPubKey, txnouttype& whichType);\n     /**"
      },
      {
        "sha": "827525783a36913a3d241804d4f746243032f84c",
        "filename": "src/test/miner_tests.cpp",
        "status": "modified",
        "additions": 4,
        "deletions": 3,
        "changes": 7,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/d1c3762ae8c8c73ddd47766041507a6c131afaf2/src/test/miner_tests.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/d1c3762ae8c8c73ddd47766041507a6c131afaf2/src/test/miner_tests.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/miner_tests.cpp?ref=d1c3762ae8c8c73ddd47766041507a6c131afaf2",
        "patch": "@@ -4,6 +4,7 @@\n \n #include \"chainparams.h\"\n #include \"coins.h\"\n+#include \"consensus/consensus.h\"\n #include \"consensus/validation.h\"\n #include \"main.h\"\n #include \"miner.h\"\n@@ -229,7 +230,7 @@ BOOST_AUTO_TEST_CASE(CreateNewBlock_validity)\n     tx.nLockTime = chainActive.Tip()->nHeight+1;\n     hash = tx.GetHash();\n     mempool.addUnchecked(hash, CTxMemPoolEntry(tx, 11, GetTime(), 111.0, 11));\n-    BOOST_CHECK(!CheckFinalTx(tx));\n+    BOOST_CHECK(!CheckFinalTx(tx, LOCKTIME_MEDIAN_TIME_PAST));\n \n     // time locked\n     tx2.vin.resize(1);\n@@ -243,7 +244,7 @@ BOOST_AUTO_TEST_CASE(CreateNewBlock_validity)\n     tx2.nLockTime = chainActive.Tip()->GetMedianTimePast()+1;\n     hash = tx2.GetHash();\n     mempool.addUnchecked(hash, CTxMemPoolEntry(tx2, 11, GetTime(), 111.0, 11));\n-    BOOST_CHECK(!CheckFinalTx(tx2));\n+    BOOST_CHECK(!CheckFinalTx(tx2, LOCKTIME_MEDIAN_TIME_PAST));\n \n     BOOST_CHECK(pblocktemplate = CreateNewBlock(scriptPubKey));\n \n@@ -261,7 +262,7 @@ BOOST_AUTO_TEST_CASE(CreateNewBlock_validity)\n     //BOOST_CHECK(CheckFinalTx(tx2));\n \n     BOOST_CHECK(pblocktemplate = CreateNewBlock(scriptPubKey));\n-    BOOST_CHECK_EQUAL(pblocktemplate->block.vtx.size(), 3);\n+    BOOST_CHECK_EQUAL(pblocktemplate->block.vtx.size(), 2);\n     delete pblocktemplate;\n \n     chainActive.Tip()->nHeight--;"
      }
    ]
  }
]