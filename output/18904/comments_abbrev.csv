bvbfan,2020-05-07 06:51:18,lsn_reset on big wallet (actually wallet can became bigger) takes a minutes on GB file. It shuffles the priv key location but it does not make sense to be so frequently.,https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-625065380,625065380,
laanwj,2020-05-07 17:35:27,"Shuffling private key location is not the point here.\nDoes it still concatenate the bdb logs after this, so that everything becomes one file? That's the point of the periodic flush. \n",https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-625396536,625396536,
bvbfan,2020-05-08 05:08:14,"> Does it still concatenate the bdb logs after this, so that everything becomes one file?\n\nhttps://docs.oracle.com/cd/E17276_01/html/api_reference/C/txncheckpoint.html\n\n> If there has been database environment activity since the last checkpoint, the DB_ENV->txn_checkpoint method flushes the underlying memory pool, writes a checkpoint record to the log, and then flushes the log.\n\nhttps:",https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-625633092,625633092,
achow101,2020-05-08 06:16:43,"I don't think this is safe without #18907. Otherwise there could be a condition where the log files are removed and the database opened again which could cause corruption. As I understand it, `lsn_reset` is required if we're going to do any log file removals.",https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-625653503,625653503,
bvbfan,2020-05-08 09:34:49,"@achow101 you should be more verbose on that, i don't see anything related. On periodic flush there is no db moving or changing, lsn_reset still present on backup and app close.",https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-625731092,625731092,
achow101,2020-05-08 16:20:21,"During `BerkeleyEnvironment::Open`, if `dbenv->open` fails, it will move the transaction logs to a backup directory and retry `dbenv->open`. If the LSNs in the wallet file were not reset when this occurs, then there could be corruption issues due to mismatched LSNs. This situation could occur if Core has an unclean exit and if there is something that causes the environment to fail to open (e.g. a ",https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-625894756,625894756,
bvbfan,2020-05-09 08:44:44,"When batch is using db is open without retry or i miss something\nhttps://github.com/bitcoin/bitcoin/blob/master/src/wallet/db.cpp#L533",https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-626130576,626130576,
DrahtBot,2020-05-14 03:50:38,<!--e57a25ab6845829454e8d69fc972939a-->\n\nThe following sections might be updated with supplementary metadata relevant to reviewers and maintainers.\n\n<!--174a7506f384e20aa4161008e828411d-->\n### Conflicts\nNo conflicts as of last run.,https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-628370122,628370122,
bvbfan,2020-07-09 16:40:32,"@achow101 i do some code refactor as well. In periodic flush it isn't needed lsn_reset to be called, to close the db as well. It just needs to trigger writing of log checkpoints. Looking at docs\nhttps://docs.oracle.com/cd/E17276_01/html/api_reference/C/txncheckpoint.html\nhttps://docs.oracle.com/cd/E17275_01/html/api_reference/C/envlsn_reset.html\nlsn_reset is needed when we want to move db fr",https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-656232482,656232482,
ryanofsky,2020-07-09 20:40:34,"> In periodic flush it isn't needed lsn_reset to be called, to close the db as well. It just needs to trigger writing of log checkpoints.\n\nIf the point is to avoid data loss it makes sense to only require writing a new log checkpoint. If the point is to allow deleting the logs entirely (#2558)\n\nhttps://github.com/bitcoin/bitcoin/blob/2aaff4813cc340764c99846513d58fc3553fcb6a/src/wallet/bdb.",https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-656340470,656340470,
bvbfan,2020-07-10 04:35:31,"> If the point is to avoid data loss it makes sense to only require writing a new log checkpoint. If the point is to allow deleting the logs entirely (#2558)\n> \n> https://github.com/bitcoin/bitcoin/blob/2aaff4813cc340764c99846513d58fc3553fcb6a/src/wallet/bdb.cpp#L609\n> \n> maybe it does make sense to call lsn_reset.\n> \nSure, here it's needed, as well in backup and rewrite. The problem i",https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-656477178,656477178,
achow101,2020-08-13 21:25:43,"I'm still not convinced that this is safe to do. I think it would be better to ensure that after each write, the database is portable. That would remove the need for `PeriodicFlush` in general which would resolve this issue. But at the same time, doing that is probably not performant.\n\nAt this point, it may be better to just leave this as is and merge sqlite wallets which don't have this issue",https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-673718476,673718476,
bvbfan,2020-08-25 05:38:32,"Hi, @achow101 i don't think it's needed to remove `PeriodicFlush` at all, because it prevents data loss by writing txs to backup db.\n\nhttps://www.mit.edu/afs.new/sipb/project/subversion/docs/ref/transapp/checkpoint.html",https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-679738038,679738038,
MarcoFalke,2021-10-22 12:03:55,Needs rebase if still relevant,https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-949566725,949566725,
bvbfan,2021-10-22 12:16:02,"Hi @MarcoFalke, it speed-up periodic flush since lsn_reset rewrites entire file, high unlikely to periodic action. I've using across other forks without issue, but i've not follow will bdb backend entire replaced via sqlite one or they will keep operate in cooperation? If bdb is still well used backend, so the changes is good to be pushed. Thanks.",https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-949576048,949576048,
MarcoFalke,2021-10-22 12:25:51,See https://github.com/bitcoin/bitcoin/issues/20160,https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-949583387,949583387,
bvbfan,2021-10-28 12:39:18,Rebased,https://github.com/bitcoin/bitcoin/pull/18904#issuecomment-953804928,953804928,
