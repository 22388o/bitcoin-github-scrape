[
  {
    "sha": "61e20cc2a3275972e131492ceead6c02512dffeb",
    "node_id": "C_kwDOABII59oAKDYxZTIwY2MyYTMyNzU5NzJlMTMxNDkyY2VlYWQ2YzAyNTEyZGZmZWI",
    "commit": {
      "author": {
        "name": "lsilva01",
        "email": "lsilva01@protonmail.com",
        "date": "2021-11-04T01:23:38Z"
      },
      "committer": {
        "name": "lsilva01",
        "email": "lsilva01@protonmail.com",
        "date": "2021-11-22T18:12:44Z"
      },
      "message": "Remove AcceptToMemoryPoolWithTime",
      "tree": {
        "sha": "a527f2b88e371cdb2d113b0116355fbc53e60129",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/a527f2b88e371cdb2d113b0116355fbc53e60129"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/61e20cc2a3275972e131492ceead6c02512dffeb",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/61e20cc2a3275972e131492ceead6c02512dffeb",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/61e20cc2a3275972e131492ceead6c02512dffeb",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/61e20cc2a3275972e131492ceead6c02512dffeb/comments",
    "author": {
      "login": "lsilva01",
      "id": 84432093,
      "node_id": "MDQ6VXNlcjg0NDMyMDkz",
      "avatar_url": "https://avatars.githubusercontent.com/u/84432093?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lsilva01",
      "html_url": "https://github.com/lsilva01",
      "followers_url": "https://api.github.com/users/lsilva01/followers",
      "following_url": "https://api.github.com/users/lsilva01/following{/other_user}",
      "gists_url": "https://api.github.com/users/lsilva01/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lsilva01/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lsilva01/subscriptions",
      "organizations_url": "https://api.github.com/users/lsilva01/orgs",
      "repos_url": "https://api.github.com/users/lsilva01/repos",
      "events_url": "https://api.github.com/users/lsilva01/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lsilva01/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "lsilva01",
      "id": 84432093,
      "node_id": "MDQ6VXNlcjg0NDMyMDkz",
      "avatar_url": "https://avatars.githubusercontent.com/u/84432093?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lsilva01",
      "html_url": "https://github.com/lsilva01",
      "followers_url": "https://api.github.com/users/lsilva01/followers",
      "following_url": "https://api.github.com/users/lsilva01/following{/other_user}",
      "gists_url": "https://api.github.com/users/lsilva01/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lsilva01/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lsilva01/subscriptions",
      "organizations_url": "https://api.github.com/users/lsilva01/orgs",
      "repos_url": "https://api.github.com/users/lsilva01/repos",
      "events_url": "https://api.github.com/users/lsilva01/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lsilva01/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "f63bf05e73ea96e5c2c72cc455d05ad382883c27",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/f63bf05e73ea96e5c2c72cc455d05ad382883c27",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/f63bf05e73ea96e5c2c72cc455d05ad382883c27"
      }
    ],
    "stats": {
      "total": 55,
      "additions": 26,
      "deletions": 29
    },
    "files": [
      {
        "sha": "bf957b8520d7803c6a5213c93006e272399bfd32",
        "filename": "src/test/fuzz/tx_pool.cpp",
        "status": "modified",
        "additions": 3,
        "deletions": 2,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/61e20cc2a3275972e131492ceead6c02512dffeb/src/test/fuzz/tx_pool.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/61e20cc2a3275972e131492ceead6c02512dffeb/src/test/fuzz/tx_pool.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/fuzz/tx_pool.cpp?ref=61e20cc2a3275972e131492ceead6c02512dffeb",
        "patch": "@@ -230,7 +230,8 @@ FUZZ_TARGET_INIT(tx_pool_standard, initialize_tx_pool)\n         Assert(it->second.m_result_type == MempoolAcceptResult::ResultType::VALID ||\n                it->second.m_result_type == MempoolAcceptResult::ResultType::INVALID);\n \n-        const auto res = WITH_LOCK(::cs_main, return AcceptToMemoryPool(chainstate, tx_pool, tx, bypass_limits));\n+        CChainState& chainstate{node.chainman->ActiveChainstate()};\n+        const auto res = WITH_LOCK(::cs_main, return AcceptToMemoryPool(tx_pool, chainstate, tx, GetTime(), bypass_limits, /* test_accept= */ false));\n         const bool accepted = res.m_result_type == MempoolAcceptResult::ResultType::VALID;\n         SyncWithValidationInterfaceQueue();\n         UnregisterSharedValidationInterface(txr);\n@@ -330,7 +331,7 @@ FUZZ_TARGET_INIT(tx_pool, initialize_tx_pool)\n         const auto tx = MakeTransactionRef(mut_tx);\n         const bool bypass_limits = fuzzed_data_provider.ConsumeBool();\n         ::fRequireStandard = fuzzed_data_provider.ConsumeBool();\n-        const auto res = WITH_LOCK(::cs_main, return AcceptToMemoryPool(node.chainman->ActiveChainstate(), tx_pool, tx, bypass_limits));\n+        const auto res = WITH_LOCK(::cs_main, return AcceptToMemoryPool(tx_pool, chainstate, tx, GetTime(), bypass_limits, /* test_accept= */ false));\n         const bool accepted = res.m_result_type == MempoolAcceptResult::ResultType::VALID;\n         if (accepted) {\n             txids.push_back(tx->GetHash());"
      },
      {
        "sha": "f544b316aeff1de5423fc3363341a3e551a41799",
        "filename": "src/validation.cpp",
        "status": "modified",
        "additions": 11,
        "deletions": 20,
        "changes": 31,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/61e20cc2a3275972e131492ceead6c02512dffeb/src/validation.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/61e20cc2a3275972e131492ceead6c02512dffeb/src/validation.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.cpp?ref=61e20cc2a3275972e131492ceead6c02512dffeb",
        "patch": "@@ -349,8 +349,8 @@ void CChainState::MaybeUpdateMempoolForReorg(\n     while (it != disconnectpool.queuedTx.get<insertion_order>().rend()) {\n         // ignore validation errors in resurrected transactions\n         if (!fAddToMempool || (*it)->IsCoinBase() ||\n-            AcceptToMemoryPool(\n-                *this, *m_mempool, *it, true /* bypass_limits */).m_result_type !=\n+            AcceptToMemoryPool(*m_mempool, *this, *it, GetTime(),\n+                /* bypass_limits= */true, /* test_accept= */ false).m_result_type !=\n                     MempoolAcceptResult::ResultType::VALID) {\n             // If the transaction doesn't make it in to the mempool, remove any\n             // transactions that depend on it (which would now be orphans).\n@@ -1079,15 +1079,13 @@ PackageMempoolAcceptResult MemPoolAccept::AcceptMultipleTransactions(const std::\n \n } // anon namespace\n \n-/** (try to) add transaction to memory pool with a specified acceptance time **/\n-static MempoolAcceptResult AcceptToMemoryPoolWithTime(const CChainParams& chainparams, CTxMemPool& pool,\n-                                                      CChainState& active_chainstate,\n-                                                      const CTransactionRef &tx, int64_t nAcceptTime,\n-                                                      bool bypass_limits, bool test_accept)\n-                                                      EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n+MempoolAcceptResult AcceptToMemoryPool(CTxMemPool& pool, CChainState& active_chainstate, const CTransactionRef& tx,\n+                                       int64_t accept_time, bool bypass_limits, bool test_accept)\n+    EXCLUSIVE_LOCKS_REQUIRED(cs_main)\n {\n+    const CChainParams& chainparams{active_chainstate.m_params};\n     std::vector<COutPoint> coins_to_uncache;\n-    auto args = MemPoolAccept::ATMPArgs::SingleAccept(chainparams, nAcceptTime, bypass_limits, coins_to_uncache, test_accept);\n+    auto args = MemPoolAccept::ATMPArgs::SingleAccept(chainparams, accept_time, bypass_limits, coins_to_uncache, test_accept);\n     const MempoolAcceptResult result = MemPoolAccept(pool, active_chainstate).AcceptSingleTransaction(tx, args);\n     if (result.m_result_type != MempoolAcceptResult::ResultType::VALID) {\n         // Remove coins that were not present in the coins cache before calling\n@@ -1104,12 +1102,6 @@ static MempoolAcceptResult AcceptToMemoryPoolWithTime(const CChainParams& chainp\n     return result;\n }\n \n-MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPool& pool, const CTransactionRef& tx,\n-                                       bool bypass_limits, bool test_accept)\n-{\n-    return AcceptToMemoryPoolWithTime(Params(), pool, active_chainstate, tx, GetTime(), bypass_limits, test_accept);\n-}\n-\n PackageMempoolAcceptResult ProcessNewPackage(CChainState& active_chainstate, CTxMemPool& pool,\n                                                    const Package& package, bool test_accept)\n {\n@@ -1162,8 +1154,8 @@ CChainState::CChainState(\n     ChainstateManager& chainman,\n     std::optional<uint256> from_snapshot_blockhash)\n     : m_mempool(mempool),\n-      m_params(::Params()),\n       m_blockman(blockman),\n+      m_params(::Params()),\n       m_chainman(chainman),\n       m_from_snapshot_blockhash(from_snapshot_blockhash) {}\n \n@@ -3494,7 +3486,7 @@ MempoolAcceptResult ChainstateManager::ProcessTransaction(const CTransactionRef&\n         state.Invalid(TxValidationResult::TX_NO_MEMPOOL, \"no-mempool\");\n         return MempoolAcceptResult::Failure(state);\n     }\n-    auto result = AcceptToMemoryPool(active_chainstate, *active_chainstate.m_mempool, tx, /*bypass_limits=*/ false, test_accept);\n+    auto result = AcceptToMemoryPool(*active_chainstate.m_mempool, active_chainstate, tx, GetTime(), /* bypass_limits= */ false, test_accept);\n     active_chainstate.m_mempool->check(active_chainstate.CoinsTip(), active_chainstate.m_chain.Height() + 1);\n     return result;\n }\n@@ -4524,7 +4516,6 @@ static const uint64_t MEMPOOL_DUMP_VERSION = 1;\n \n bool LoadMempool(CTxMemPool& pool, CChainState& active_chainstate, FopenFn mockable_fopen_function)\n {\n-    const CChainParams& chainparams = Params();\n     int64_t nExpiryTimeout = gArgs.GetIntArg(\"-mempoolexpiry\", DEFAULT_MEMPOOL_EXPIRY) * 60 * 60;\n     FILE* filestr{mockable_fopen_function(gArgs.GetDataDirNet() / \"mempool.dat\", \"rb\")};\n     CAutoFile file(filestr, SER_DISK, CLIENT_VERSION);\n@@ -4562,8 +4553,8 @@ bool LoadMempool(CTxMemPool& pool, CChainState& active_chainstate, FopenFn mocka\n             }\n             if (nTime > nNow - nExpiryTimeout) {\n                 LOCK(cs_main);\n-                if (AcceptToMemoryPoolWithTime(chainparams, pool, active_chainstate, tx, nTime, false /* bypass_limits */,\n-                                               false /* test_accept */).m_result_type == MempoolAcceptResult::ResultType::VALID) {\n+                if (AcceptToMemoryPool(pool, active_chainstate, tx, nTime, /* bypass_limits= */ false,\n+                                               /* test_accept= */ false).m_result_type == MempoolAcceptResult::ResultType::VALID) {\n                     ++count;\n                 } else {\n                     // mempool may contain the transaction already, e.g. from"
      },
      {
        "sha": "a57045ad0f4a4fe1999ecfadea4b40780f26102e",
        "filename": "src/validation.h",
        "status": "modified",
        "additions": 12,
        "deletions": 7,
        "changes": 19,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/61e20cc2a3275972e131492ceead6c02512dffeb/src/validation.h",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/61e20cc2a3275972e131492ceead6c02512dffeb/src/validation.h",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/validation.h?ref=61e20cc2a3275972e131492ceead6c02512dffeb",
        "patch": "@@ -208,19 +208,23 @@ struct PackageMempoolAcceptResult\n };\n \n /**\n- * Try to add a transaction to the mempool. This is an internal function and is\n- * exposed only for testing. Client code should use ChainstateManager::ProcessTransaction()\n+ * Try to add a transaction to the mempool. This is an internal function and is exposed only for testing.\n+ * Client code should use ChainstateManager::ProcessTransaction()\n  *\n- * @param[in]  active_chainstate  Reference to the active chainstate.\n  * @param[in]  pool               Reference to the node's mempool.\n+ * @param[in]  active_chainstate  Reference to the active chainstate.\n  * @param[in]  tx                 The transaction to submit for mempool acceptance.\n+ * @param[in]  accept_time        The timestamp for adding the transaction to the mempool. Usually\n+ *                                the current system time, but may be different.\n+ *                                It is also used to determine when the entry expires.\n  * @param[in]  bypass_limits      When true, don't enforce mempool fee and capacity limits.\n  * @param[in]  test_accept        When true, run validation checks but don't submit to mempool.\n  *\n  * @returns a MempoolAcceptResult indicating whether the transaction was accepted/rejected with reason.\n  */\n-MempoolAcceptResult AcceptToMemoryPool(CChainState& active_chainstate, CTxMemPool& pool, const CTransactionRef& tx,\n-                                       bool bypass_limits, bool test_accept=false) EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n+MempoolAcceptResult AcceptToMemoryPool(CTxMemPool& pool, CChainState& active_chainstate, const CTransactionRef& tx,\n+                                       int64_t accept_time, bool bypass_limits, bool test_accept)\n+    EXCLUSIVE_LOCKS_REQUIRED(cs_main);\n \n /**\n * Atomically test acceptance of a package. If the package only contains one tx, package rules still\n@@ -581,8 +585,6 @@ class CChainState\n     //! Only the active chainstate has a mempool.\n     CTxMemPool* m_mempool;\n \n-    const CChainParams& m_params;\n-\n     //! Manages the UTXO set, which is a reflection of the contents of `m_chain`.\n     std::unique_ptr<CoinsViews> m_coins_views;\n \n@@ -591,6 +593,9 @@ class CChainState\n     //! CChainState instances.\n     BlockManager& m_blockman;\n \n+    /** Chain parameters for this chainstate */\n+    const CChainParams& m_params;\n+\n     //! The chainstate manager that owns this chainstate. The reference is\n     //! necessary so that this instance can check whether it is the active\n     //! chainstate within deeply nested method calls."
      }
    ]
  },
  {
    "sha": "4ec8b96e077a359c7ba877fc4f78d55ac7d5fb22",
    "node_id": "C_kwDOABII59oAKDRlYzhiOTZlMDc3YTM1OWM3YmE4NzdmYzRmNzhkNTVhYzdkNWZiMjI",
    "commit": {
      "author": {
        "name": "lsilva01",
        "email": "lsilva01@protonmail.com",
        "date": "2021-11-11T19:36:44Z"
      },
      "committer": {
        "name": "lsilva01",
        "email": "lsilva01@protonmail.com",
        "date": "2021-11-24T02:37:23Z"
      },
      "message": "Remove calls to global Params() in tx_pool test",
      "tree": {
        "sha": "2d52a0a1414b65b546c5a8b33171b82483dbbbac",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/git/trees/2d52a0a1414b65b546c5a8b33171b82483dbbbac"
      },
      "url": "https://api.github.com/repos/bitcoin/bitcoin/git/commits/4ec8b96e077a359c7ba877fc4f78d55ac7d5fb22",
      "comment_count": 0,
      "verification": {
        "verified": false,
        "reason": "unsigned",
        "signature": null,
        "payload": null
      }
    },
    "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4ec8b96e077a359c7ba877fc4f78d55ac7d5fb22",
    "html_url": "https://github.com/bitcoin/bitcoin/commit/4ec8b96e077a359c7ba877fc4f78d55ac7d5fb22",
    "comments_url": "https://api.github.com/repos/bitcoin/bitcoin/commits/4ec8b96e077a359c7ba877fc4f78d55ac7d5fb22/comments",
    "author": {
      "login": "lsilva01",
      "id": 84432093,
      "node_id": "MDQ6VXNlcjg0NDMyMDkz",
      "avatar_url": "https://avatars.githubusercontent.com/u/84432093?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lsilva01",
      "html_url": "https://github.com/lsilva01",
      "followers_url": "https://api.github.com/users/lsilva01/followers",
      "following_url": "https://api.github.com/users/lsilva01/following{/other_user}",
      "gists_url": "https://api.github.com/users/lsilva01/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lsilva01/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lsilva01/subscriptions",
      "organizations_url": "https://api.github.com/users/lsilva01/orgs",
      "repos_url": "https://api.github.com/users/lsilva01/repos",
      "events_url": "https://api.github.com/users/lsilva01/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lsilva01/received_events",
      "type": "User",
      "site_admin": false
    },
    "committer": {
      "login": "lsilva01",
      "id": 84432093,
      "node_id": "MDQ6VXNlcjg0NDMyMDkz",
      "avatar_url": "https://avatars.githubusercontent.com/u/84432093?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/lsilva01",
      "html_url": "https://github.com/lsilva01",
      "followers_url": "https://api.github.com/users/lsilva01/followers",
      "following_url": "https://api.github.com/users/lsilva01/following{/other_user}",
      "gists_url": "https://api.github.com/users/lsilva01/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/lsilva01/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/lsilva01/subscriptions",
      "organizations_url": "https://api.github.com/users/lsilva01/orgs",
      "repos_url": "https://api.github.com/users/lsilva01/repos",
      "events_url": "https://api.github.com/users/lsilva01/events{/privacy}",
      "received_events_url": "https://api.github.com/users/lsilva01/received_events",
      "type": "User",
      "site_admin": false
    },
    "parents": [
      {
        "sha": "61e20cc2a3275972e131492ceead6c02512dffeb",
        "url": "https://api.github.com/repos/bitcoin/bitcoin/commits/61e20cc2a3275972e131492ceead6c02512dffeb",
        "html_url": "https://github.com/bitcoin/bitcoin/commit/61e20cc2a3275972e131492ceead6c02512dffeb"
      }
    ],
    "stats": {
      "total": 5,
      "additions": 2,
      "deletions": 3
    },
    "files": [
      {
        "sha": "de8b09c329895810620d698de402b29abbef9f8c",
        "filename": "src/test/fuzz/tx_pool.cpp",
        "status": "modified",
        "additions": 2,
        "deletions": 3,
        "changes": 5,
        "blob_url": "https://github.com/bitcoin/bitcoin/blob/4ec8b96e077a359c7ba877fc4f78d55ac7d5fb22/src/test/fuzz/tx_pool.cpp",
        "raw_url": "https://github.com/bitcoin/bitcoin/raw/4ec8b96e077a359c7ba877fc4f78d55ac7d5fb22/src/test/fuzz/tx_pool.cpp",
        "contents_url": "https://api.github.com/repos/bitcoin/bitcoin/contents/src/test/fuzz/tx_pool.cpp?ref=4ec8b96e077a359c7ba877fc4f78d55ac7d5fb22",
        "patch": "@@ -86,7 +86,7 @@ void Finish(FuzzedDataProvider& fuzzed_data_provider, MockedTxPool& tx_pool, CCh\n         BlockAssembler::Options options;\n         options.nBlockMaxWeight = fuzzed_data_provider.ConsumeIntegralInRange(0U, MAX_BLOCK_WEIGHT);\n         options.blockMinFeeRate = CFeeRate{ConsumeMoney(fuzzed_data_provider, /* max */ COIN)};\n-        auto assembler = BlockAssembler{chainstate, *static_cast<CTxMemPool*>(&tx_pool), ::Params(), options};\n+        auto assembler = BlockAssembler{chainstate, *static_cast<CTxMemPool*>(&tx_pool), chainstate.m_params, options};\n         auto block_template = assembler.CreateNewBlock(CScript{} << OP_TRUE);\n         Assert(block_template->block.vtx.size() >= 1);\n     }\n@@ -224,13 +224,12 @@ FUZZ_TARGET_INIT(tx_pool_standard, initialize_tx_pool)\n         // Make sure ProcessNewPackage on one transaction works and always fully validates the transaction.\n         // The result is not guaranteed to be the same as what is returned by ATMP.\n         const auto result_package = WITH_LOCK(::cs_main,\n-                                    return ProcessNewPackage(node.chainman->ActiveChainstate(), tx_pool, {tx}, true));\n+                                    return ProcessNewPackage(chainstate, tx_pool, {tx}, true));\n         auto it = result_package.m_tx_results.find(tx->GetWitnessHash());\n         Assert(it != result_package.m_tx_results.end());\n         Assert(it->second.m_result_type == MempoolAcceptResult::ResultType::VALID ||\n                it->second.m_result_type == MempoolAcceptResult::ResultType::INVALID);\n \n-        CChainState& chainstate{node.chainman->ActiveChainstate()};\n         const auto res = WITH_LOCK(::cs_main, return AcceptToMemoryPool(tx_pool, chainstate, tx, GetTime(), bypass_limits, /* test_accept= */ false));\n         const bool accepted = res.m_result_type == MempoolAcceptResult::ResultType::VALID;\n         SyncWithValidationInterfaceQueue();"
      }
    ]
  }
]